@inherits LayoutComponentBase
@using SGRRHH.Web.Client
@using SGRRHH.Core.Enums
@using SGRRHH.Core.Interfaces
@inject AppStateService AppState
@inject NavigationManager Navigation
@inject IFirebaseAuthService AuthService
@implements IDisposable

<div class="app-container">
    <!-- Borde exterior (Raised) -->
    <div class="legacy-outset" style="display: flex; flex-direction: column; height: 100vh;">
        
        @if (AppState.IsAuthenticated)
        {
            <!-- 1. Barra de Menú (solo cuando autenticado) -->
            <div class="legacy-menu">
                <!-- INICIO -->
                <span class="legacy-menu-separator">| INICIO:</span>
                <button class="legacy-menu-item @(IsActive("/dashboard"))" @onclick='() => NavigateTo("/dashboard", "Dashboard")'>[Dashboard]</button>
                
                <!-- CATÁLOGOS -->
                <span class="legacy-menu-separator">| CATÁLOGOS:</span>
                @if (CanView("Catalogos"))
                {
                    <button class="legacy-menu-item @(IsActive("/departamentos"))" @onclick='() => NavigateTo("/departamentos", "Departamentos")'>[Departamentos]</button>
                    <button class="legacy-menu-item @(IsActive("/cargos"))" @onclick='() => NavigateTo("/cargos", "Cargos")'>[Cargos]</button>
                    @if (IsAdmin)
                    {
                        <button class="legacy-menu-item @(IsActive("/tipos-permiso"))" @onclick='() => NavigateTo("/tipos-permiso", "Tipos de Permiso")'>[Tipos de Permiso]</button>
                    }
                    @if (IsAdmin || IsAprobador)
                    {
                        <button class="legacy-menu-item @(IsActive("/proyectos"))" @onclick='() => NavigateTo("/proyectos", "Proyectos")'>[Proyectos]</button>
                    }
                    @if (IsAdmin)
                    {
                        <button class="legacy-menu-item @(IsActive("/actividades"))" @onclick='() => NavigateTo("/actividades", "Actividades")'>[Actividades]</button>
                        <button class="legacy-menu-item @(IsActive("/usuarios"))" @onclick='() => NavigateTo("/usuarios", "Usuarios")'>[Usuarios]</button>
                    }
                    @if (IsAdmin || IsAprobador)
                    {
                        <button class="legacy-menu-item @(IsActive("/reportes"))" @onclick='() => NavigateTo("/reportes", "Reportes")'>[Reportes]</button>
                    }
                }
                
                <!-- PERSONAL -->
                <span class="legacy-menu-separator">| PERSONAL:</span>
                <button class="legacy-menu-item @(IsActive("/empleados"))" @onclick='() => NavigateTo("/empleados", "Empleados")'>[Empleados]</button>
                <button class="legacy-menu-item @(IsActive("/contratos"))" @onclick='() => NavigateTo("/contratos", "Contratos")'>[Contratos]</button>
                <button class="legacy-menu-item @(IsActive("/documentos"))" @onclick='() => NavigateTo("/documentos", "Documentos")'>[Documentos]</button>
                
                <!-- OPERACIONES -->
                <span class="legacy-menu-separator">| OPERACIONES:</span>
                <button class="legacy-menu-item @(IsActive("/control-diario"))" @onclick='() => NavigateTo("/control-diario", "Control Diario")'>[Control Diario]</button>
                <button class="legacy-menu-item @(IsActive("/permisos"))" @onclick='() => NavigateTo("/permisos", "Permisos")'>[Permisos]</button>
                <button class="legacy-menu-item @(IsActive("/vacaciones"))" @onclick='() => NavigateTo("/vacaciones", "Vacaciones")'>[Vacaciones]</button>
                
                <!-- Opciones de Usuario -->
                <span class="legacy-menu-separator">|</span>
                <button class="legacy-menu-item" style="color: var(--win-gray);">[Cambiar Clave]</button>
                <button class="legacy-menu-item" style="color: var(--win-danger);" @onclick="HandleLogout">[Salir]</button>
            </div>

            <!-- 2. Barra de Ruta / Breadcrumb -->
            <div class="legacy-breadcrumb">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        RUTA: Inicio > <strong class="text-navy">@AppState.CurrentViewTitle</strong>
                    </div>
                    <div>
                        USUARIO: <strong class="text-navy">@AppState.CurrentUserName</strong> 
                        (@AppState.CurrentUserRole)
                    </div>
                </div>
            </div>
        }

        <!-- 3. Área de Contenido Principal -->
        <div class="app-main">
            <div class="legacy-content legacy-inset" style="height: 100%; display: flex; flex-direction: column;">
                @if (AppState.IsAuthenticated)
                {
                    <!-- Header de la sección -->
                    <div class="legacy-content-header">
                        == @AppState.CurrentViewTitle ==
                    </div>
                }
                
                <!-- Contenedor dinámico -->
                <div class="app-content-body" style="flex: 1; padding: 15px; overflow: auto; background: white;">
                    @Body
                </div>
            </div>
        </div>

        @if (AppState.IsAuthenticated)
        {
            <!-- 4. Barra de Estado -->
            <div class="legacy-statusbar">
                <div class="legacy-statusbar-panel" style="flex: 1;">
                    Sistema listo. Conexión establecida.
                </div>
                <div class="legacy-statusbar-panel" style="width: 120px;">
                    Alertas: <strong>@AppState.PendingAlerts</strong>
                </div>
                <div class="legacy-statusbar-panel" style="width: 250px;">
                    @DateTime.Now.ToString("dddd, dd de MMMM de yyyy | HH:mm")
                </div>
                <div class="legacy-statusbar-panel" style="width: 80px; text-align: center;">
                    <strong class="text-navy">@AppState.AppVersion</strong>
                </div>
            </div>
        }
        
    </div>
</div>

@code {
    private bool IsAdmin => AppState.CurrentUser?.Rol == RolUsuario.Administrador;
    private bool IsAprobador => AppState.CurrentUser?.Rol == RolUsuario.Aprobador;
    private bool IsOperador => AppState.CurrentUser?.Rol == RolUsuario.Operador;
    
    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
        
        // Verificar autenticación - redirigir a login si no está autenticado
        var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri).ToLower();
        if (!AppState.IsAuthenticated && !currentPath.StartsWith("login"))
        {
            Navigation.NavigateTo("/login");
        }
    }

    private bool CanView(string category)
    {
        // Todos los roles pueden ver todas las categorías por defecto
        // Los items individuales tienen su propia lógica de visibilidad
        return AppState.IsAuthenticated;
    }

    private string IsActive(string href)
    {
        var relativePath = Navigation.ToBaseRelativePath(Navigation.Uri);
        if (string.IsNullOrEmpty(relativePath) && href == "/dashboard") return "active";
        return relativePath.Contains(href.TrimStart('/'), StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    private void NavigateTo(string href, string title)
    {
        AppState.SetViewTitle(title);
        Navigation.NavigateTo(href);
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.SignOutAsync();
        }
        catch
        {
            // Ignorar errores al cerrar sesión en Firebase
        }
        AppState.Logout();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
