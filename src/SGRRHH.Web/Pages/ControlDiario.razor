@page "/control-diario"
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Interfaces
@using SGRRHH.Web.Components.Shared
@using SGRRHH.Web.Components.Forms
@inject IControlDiarioService ControlDiarioService
@inject IRegistroDiarioRepository RegistroRepo
@inject IEmpleadoRepository EmpleadoRepo
@inject IRepository<Actividad> ActividadRepo
@inject IRepository<Proyecto> ProyectoRepo
@inject AppStateService AppState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="module-container @(isWizardMode ? "module-container-wizard-fixed" : "")">
    @if (!isWizardMode)
    {
        @* ===== VISTA LISTA ===== *@
        @* Toolbar con Filtros *@
        <div class="module-toolbar">
            <div class="filter-group">
                <label>Empleado:</label>
                <select class="legacy-input" @bind="selectedEmpleadoFilter" style="width: 180px;">
                    <option value="0">-- Todos --</option>
                    @foreach (var emp in allEmpleados)
                    {
                        <option value="@emp.Id">@emp.NombreCompleto</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label>Mes:</label>
                <select class="legacy-input" @bind="selectedMes" style="width: 120px;">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label>Anio:</label>
                <select class="legacy-input" @bind="selectedAnio" style="width: 80px;">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 2; y--)
                    {
                        <option value="@y">@y</option>
                    }
                </select>
            </div>
            <button class="legacy-button" @onclick="LoadDataWithFilters" disabled="@isLoading">
                @(isLoading ? "..." : "Buscar")
            </button>

            <div style="flex: 1;"></div>

            <button class="legacy-button" @onclick="ShowNewModal">+ Nuevo</button>
            <button class="legacy-button legacy-button-primary" @onclick="OpenWizardWindow">Wizard</button>
        </div>

    @* Mensaje de exito *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="legacy-alert legacy-alert-success">
            @successMessage
        </div>
    }

    @* Contenido principal *@
    @if (isLoading)
    {
        <div class="loading-indicator">Cargando registros...</div>
    }
    else if (registros == null || !registros.Any())
    {
        <div class="empty-state">No hay registros para @GetFilterDescription().</div>
    }
    else
    {
        <div class="table-container">
            <table class="legacy-table">
                <thead>
                    <tr>
                        <th>Empleado</th>
                        <th style="width: 80px;">Entrada</th>
                        <th style="width: 80px;">Salida</th>
                        <th style="width: 80px;">Horas</th>
                        <th style="width: 100px;">Estado</th>
                        <th style="width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reg in registros)
                    {
                        <tr class="@(reg.Estado == EstadoRegistroDiario.Aprobado ? "approved-row" : "")">
                            <td><strong>@(reg.Empleado?.NombreCompleto ?? $"Empleado #{reg.EmpleadoId}")</strong></td>
                            <td style="text-align: center;">@reg.HoraEntrada?.ToString(@"hh\:mm")</td>
                            <td style="text-align: center;">@reg.HoraSalida?.ToString(@"hh\:mm")</td>
                            <td style="text-align: center; font-weight: bold;">@reg.TotalHoras.ToString("F1")</td>
                            <td style="text-align: center;">
                                <span class="status-badge @GetStatusClass(reg.Estado)">
                                    @GetEstadoLabel(reg.Estado)
                                </span>
                            </td>
                            <td>
                                <button class="legacy-button-small" @onclick="() => ShowEditModal(reg)">Editar</button>
                                @if (reg.Estado == EstadoRegistroDiario.Completado && AppState.CanApprove)
                                {
                                    <button class="legacy-button-small legacy-button-success" @onclick="() => ApproveRecord(reg)">Aprobar</button>
                                }
                                @if (reg.Estado == EstadoRegistroDiario.Borrador)
                                {
                                    <button class="legacy-button-small legacy-button-primary" @onclick="() => CompleteRecord(reg)">Cerrar</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="module-footer">
            Total: <strong>@registros.Count()</strong> registros |
            Total horas: <strong>@registros.Sum(r => r.TotalHoras).ToString("F1")</strong>
        </div>
    } @* End of table else *@
    }
    else @* isWizardMode = true *@
    {
        @* ===== WIZARD VIEW ===== *@
        <fieldset class="legacy-fieldset wizard-container wizard-container-fixed" role="form">
            <legend>Registro Batch - Control Diario</legend>

            <div class="wizard-header">
                <h2>Formulario control diario</h2>
                <button class="legacy-button-small" @onclick="CancelWizard" disabled="@isWizardSaving">Cancelar</button>
            </div>

            <div class="wizard-content wizard-content-single">
                <h3>1) Seleccionar Empleados</h3>
                <p>Seleccione los empleados para los que desea registrar actividades:</p>
                <div class="employee-list">
                    @foreach (var emp in allEmpleados)
                    {
                        <label class="employee-checkbox">
                            <input type="checkbox" checked="@selectedEmpleadoIds.Contains(emp.Id)"
                                   @onchange="() => ToggleEmpleado(emp.Id)" />
                            <span>@emp.Codigo - @emp.NombreCompleto</span>
                            <small>(@emp.Departamento?.Nombre)</small>
                        </label>
                    }
                </div>
                <div class="selection-summary">@selectedEmpleadoIds.Count empleado(s) seleccionado(s)</div>

                <h3>2) Fecha</h3>
                <p>Seleccione la fecha del registro:</p>
                <input type="date" class="legacy-input wizard-date-input" @bind="wizardDate" />

                <h3>3) Horarios y Horas</h3>
                <p>Ingrese la hora de entrada y salida:</p>
                <div class="time-inputs">
                    <div class="time-group">
                        <label>Hora Entrada:</label>
                        <input type="time" class="legacy-input"
                               value="@FormatWizardTime(wizardHoraEntrada)"
                               @onchange="@(e => { wizardHoraEntrada = ParseWizardTime(e.Value?.ToString()); UpdateHorasFromTimes(); })" />
                    </div>
                    <div class="time-group">
                        <label>Hora Salida:</label>
                        <input type="time" class="legacy-input"
                               value="@FormatWizardTime(wizardHoraSalida)"
                               @onchange="@(e => { wizardHoraSalida = ParseWizardTime(e.Value?.ToString()); UpdateHorasFromTimes(); })" />
                    </div>
                </div>
                @if (wizardHoraEntrada.HasValue && wizardHoraSalida.HasValue)
                {
                    <div class="legacy-form-group" style="margin-top: 10px;">
                        <label>Total Horas:</label>
                        <span style="margin-left: 5px;"><strong>@GetWizardDurationLabel()</strong> (@wizardHorasManual.ToString("F2") horas)</span>
                    </div>
                    <div class="legacy-form-group">
                        <label>Ajuste manual:</label>
                        <input type="number" class="legacy-input" style="width: 80px; margin-left: 5px;"
                               min="0.01" max="24" step="0.01"
                               @bind="wizardHorasManual" />
                        <span style="margin-left: 5px; font-size: 11px;">horas</span>
                    </div>
                }

                <h3>4) Actividad y Proyecto</h3>
                <div class="form-group">
                    <label>Actividad:</label>
                    <select class="legacy-input" @bind="wizardActividadId">
                        <option value="0">-- Seleccione --</option>
                        @foreach (var act in allActividades)
                        {
                            <option value="@act.Id">@act.Nombre</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Proyecto (opcional):</label>
                    <select class="legacy-input" @bind="wizardProyectoId">
                        <option value="">-- Ninguno --</option>
                        @foreach (var proy in allProyectos)
                        {
                            <option value="@proy.Id">@proy.Nombre</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripcion:</label>
                    <input type="text" class="legacy-input" @bind="wizardDescripcion" placeholder="Descripcion de la actividad" />
                </div>

                <h3>5) Revisar</h3>
                <table class="legacy-table" style="margin: 10px 0;">
                    <tr>
                        <td style="width: 120px;"><strong>Fecha:</strong></td>
                        <td>@wizardDate.ToString("dd/MM/yyyy")</td>
                    </tr>
                    <tr>
                        <td><strong>Horario:</strong></td>
                        <td>@wizardHoraEntrada?.ToString(@"hh\:mm") - @wizardHoraSalida?.ToString(@"hh\:mm") (@GetWizardDurationLabel(), @wizardHorasManual.ToString("F2") horas)</td>
                    </tr>
                    <tr>
                        <td><strong>Empleados:</strong></td>
                        <td>
                            @selectedEmpleadoIds.Count empleado(s):
                            @foreach (var empId in selectedEmpleadoIds.Take(5))
                            {
                                var emp = allEmpleados.FirstOrDefault(e => e.Id == empId);
                                if (emp != null)
                                {
                                    <span>@emp.NombreCompleto, </span>
                                }
                            }
                            @if (selectedEmpleadoIds.Count > 5)
                            {
                                <span>... y @(selectedEmpleadoIds.Count - 5) mas</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Actividad:</strong></td>
                        <td>@(allActividades.FirstOrDefault(a => a.Id == wizardActividadId)?.Nombre ?? "-")</td>
                    </tr>
                    @if (wizardProyectoId.HasValue)
                    {
                        <tr>
                            <td><strong>Proyecto:</strong></td>
                            <td>@(allProyectos.FirstOrDefault(p => p.Id == wizardProyectoId)?.Nombre ?? "-")</td>
                        </tr>
                    }
                    <tr>
                        <td><strong>Descripcion:</strong></td>
                        <td>@(string.IsNullOrEmpty(wizardDescripcion) ? "(Sin descripcion)" : wizardDescripcion)</td>
                    </tr>
                </table>

                @if (!string.IsNullOrEmpty(wizardError))
                {
                    <div class="legacy-alert legacy-alert-error">@wizardError</div>
                }
            </div>

            <div class="wizard-footer">
                <button class="legacy-button" @onclick="CancelWizard" disabled="@isWizardSaving">Cancelar</button>
                <button class="legacy-button legacy-button-success" @onclick="WizardSave" disabled="@(!CanSaveWizard() || isWizardSaving)">
                    @(isWizardSaving ? "Guardando..." : "Guardar Todo")
                </button>
            </div>
        </fieldset>
    }
</div>

@* Modal de Crear/Editar *@
<LegacyModal Title="@modalTitle"
             IsVisible="@showFormModal"
             OnClose="CloseFormModal"
             Width="550px">
    <ChildContent>
        <RegistroDiarioForm @ref="formComponent"
                            RegistroEdit="@selectedRegistro"
                            DefaultDate="@selectedDate"
                            OnSave="HandleSave"
                            OnCancel="CloseFormModal" />
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseFormModal" disabled="@isSaving">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="SaveForm" disabled="@isSaving">
            @(isSaving ? "Guardando..." : "Guardar")
        </button>
    </FooterContent>
</LegacyModal>

@code {
    private IEnumerable<RegistroDiario>? registros;
    private DateTime selectedDate = DateTime.Today;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;

    // Estadisticas
    private int totalRegistrosMes = 0;
    private decimal totalHorasMes = 0;

    // Filtros combinados
    private int selectedEmpleadoFilter = 0;
    private int selectedMes = DateTime.Now.Month;
    private int selectedAnio = DateTime.Now.Year;

    private bool showFormModal = false;
    private RegistroDiario? selectedRegistro;
    private string modalTitle = "";
    private RegistroDiarioForm? formComponent;

    // Wizard State
    private bool isWizardMode = false;
    private int wizardStep = 0;
    private bool isWizardSaving = false;
    private string? wizardError;

    // Wizard Data
    private List<Empleado> allEmpleados = new();
    private List<Actividad> allActividades = new();
    private List<Proyecto> allProyectos = new();
    private HashSet<int> selectedEmpleadoIds = new();
    private DateTime wizardDate = DateTime.Today;
    private TimeSpan? wizardHoraEntrada = new TimeSpan(8, 0, 0);
    private TimeSpan? wizardHoraSalida = new TimeSpan(17, 0, 0);
    private decimal wizardHorasManual = 9; // Default: 8am-5pm = 9 horas
    private int wizardActividadId = 0;
    private int? wizardProyectoId;
    private string wizardDescripcion = "";

    protected override async Task OnInitializedAsync()
    {
        AppState.SetViewTitle("Control Diario");
        await LoadEmpleados();
        await LoadDataWithFilters();
        await LoadStats();
    }

    private async Task LoadEmpleados()
    {
        try
        {
            allEmpleados = (await EmpleadoRepo.GetAllActiveAsync()).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando empleados: {ex.Message}");
        }
    }

    private async Task LoadStats()
    {
        try
        {
            var primerDiaMes = new DateTime(selectedAnio, selectedMes, 1);
            var ultimoDiaMes = primerDiaMes.AddMonths(1).AddDays(-1);

            var registrosMes = await RegistroRepo.GetAllAsync();
            var filtrados = registrosMes.Where(r => r.Fecha >= primerDiaMes && r.Fecha <= ultimoDiaMes);

            totalRegistrosMes = filtrados.Count();
            totalHorasMes = filtrados.Sum(r => r.TotalHoras);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando stats: {ex.Message}");
            totalRegistrosMes = 0;
            totalHorasMes = 0;
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        successMessage = null;
        try
        {
            registros = await RegistroRepo.GetByFechaAsync(selectedDate);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando registros: {ex.Message}");
            var all = await RegistroRepo.GetAllAsync();
            registros = all.Where(r => r.Fecha.Date == selectedDate.Date);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDataWithFilters()
    {
        isLoading = true;
        successMessage = null;
        try
        {
            var primerDiaMes = new DateTime(selectedAnio, selectedMes, 1);
            var ultimoDiaMes = primerDiaMes.AddMonths(1).AddDays(-1);

            var todos = await RegistroRepo.GetAllAsync();
            var filtrados = todos.Where(r => r.Fecha >= primerDiaMes && r.Fecha <= ultimoDiaMes);

            if (selectedEmpleadoFilter > 0)
            {
                filtrados = filtrados.Where(r => r.EmpleadoId == selectedEmpleadoFilter);
            }

            registros = filtrados.OrderByDescending(r => r.Fecha).ThenBy(r => r.Empleado?.NombreCompleto);

            // Actualizar stats tambien
            totalRegistrosMes = registros.Count();
            totalHorasMes = registros.Sum(r => r.TotalHoras);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando registros: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetFilterDescription()
    {
        var mesNombre = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(selectedMes);
        var empNombre = selectedEmpleadoFilter > 0
            ? allEmpleados.FirstOrDefault(e => e.Id == selectedEmpleadoFilter)?.NombreCompleto ?? "Empleado"
            : "todos los empleados";
        return $"{mesNombre} {selectedAnio} ({empNombre})";
    }

    private string GetEstadoLabel(EstadoRegistroDiario estado) => estado switch
    {
        EstadoRegistroDiario.Borrador => "Borrador",
        EstadoRegistroDiario.Completado => "Completado",
        EstadoRegistroDiario.Aprobado => "Aprobado",
        _ => "Desconocido"
    };

    private string GetStatusClass(EstadoRegistroDiario estado) => estado switch
    {
        EstadoRegistroDiario.Borrador => "status-draft",
        EstadoRegistroDiario.Completado => "status-pending",
        EstadoRegistroDiario.Aprobado => "status-active",
        _ => ""
    };

    private void ShowNewModal()
    {
        selectedRegistro = null;
        modalTitle = $"Nuevo Registro - {selectedDate:dd/MM/yyyy}";
        showFormModal = true;
    }

    private void ShowEditModal(RegistroDiario registro)
    {
        selectedRegistro = registro;
        modalTitle = $"Editar Registro - {registro.Fecha:dd/MM/yyyy}";
        showFormModal = true;
    }

    private void CloseFormModal()
    {
        showFormModal = false;
        selectedRegistro = null;
    }

    private async Task SaveForm()
    {
        if (formComponent == null) return;
        isSaving = true;
        try { await formComponent.ValidateAndSaveAsync(); }
        finally { isSaving = false; }
    }

    private async Task HandleSave(RegistroDiario registro)
    {
        showFormModal = false;
        successMessage = "Registro guardado exitosamente";
        selectedRegistro = null;
        await LoadData();
        _ = ClearSuccessMessage();
    }

    private async Task CompleteRecord(RegistroDiario reg)
    {
        try
        {
            // Use service to complete with validation
            var result = await ControlDiarioService.CompletarRegistroAsync(reg.Id);
            if (result.Success)
            {
                successMessage = "Registro cerrado";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error: {result.Message}");
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private async Task ApproveRecord(RegistroDiario reg)
    {
        try
        {
            // Use service to approve with validation
            var result = await ControlDiarioService.AprobarRegistroAsync(reg.Id);
            if (result.Success)
            {
                successMessage = "Registro aprobado";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error: {result.Message}");
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private async Task ClearSuccessMessage()
    {
        await Task.Delay(4000);
        successMessage = null;
        StateHasChanged();
    }

    // ===== WIZARD METHODS =====

    private string FormatWizardTime(TimeSpan? time) => time?.ToString(@"hh\:mm") ?? "";

    private TimeSpan? ParseWizardTime(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return TimeSpan.TryParse(value, out var time) ? time : null;
    }

    private void UpdateHorasFromTimes()
    {
        var duration = GetWizardDuration();
        if (duration.HasValue)
        {
            // Keep minute precision so UI doesn't round 11h59m up to 12.0
            wizardHorasManual = Math.Round((decimal)duration.Value.TotalMinutes / 60m, 4, MidpointRounding.AwayFromZero);
        }
    }

    private TimeSpan? GetWizardDuration()
    {
        if (!wizardHoraEntrada.HasValue || !wizardHoraSalida.HasValue) return null;
        if (wizardHoraSalida <= wizardHoraEntrada) return null;
        return wizardHoraSalida.Value - wizardHoraEntrada.Value;
    }

    private string GetWizardDurationLabel()
    {
        var duration = GetWizardDuration();
        if (!duration.HasValue) return "-";

        var totalMinutes = (int)Math.Round(duration.Value.TotalMinutes);
        var hours = totalMinutes / 60;
        var minutes = totalMinutes % 60;

        return $"{hours} horas y {minutes:00} minutos";
    }

    private async Task InitializeWizardAsync()
    {
        wizardStep = 0;
        wizardError = null;
        selectedEmpleadoIds.Clear();
        wizardDate = DateTime.Today;
        wizardHoraEntrada = new TimeSpan(8, 0, 0);
        wizardHoraSalida = new TimeSpan(17, 0, 0);
        wizardHorasManual = 9; // Reset a 9 horas (8am-5pm)
        wizardActividadId = 0;
        wizardProyectoId = null;
        wizardDescripcion = "";

        // Load data for wizard
        try
        {
            allEmpleados = (await EmpleadoRepo.GetAllActiveAsync()).ToList();
            allActividades = (await ActividadRepo.GetAllAsync()).Where(a => a.Activo).ToList();
            allProyectos = (await ProyectoRepo.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading wizard data: {ex.Message}");
        }
    }

    private async Task OpenWizardWindow()
    {
        var url = Nav.ToAbsoluteUri("/control-diario/wizard").ToString();
        await JS.InvokeVoidAsync("formHelpers.openCenteredWindow", url, "ControlDiarioWizard", 1980, 1080);
    }

    private void CancelWizard()
    {
        isWizardMode = false;
        wizardStep = 0;
    }

    private void ToggleEmpleado(int empleadoId)
    {
        if (selectedEmpleadoIds.Contains(empleadoId))
            selectedEmpleadoIds.Remove(empleadoId);
        else
            selectedEmpleadoIds.Add(empleadoId);
    }

    private bool CanAdvanceWizard()
    {
        return wizardStep switch
        {
            0 => selectedEmpleadoIds.Count > 0,
            1 => true,
            2 => wizardHoraEntrada.HasValue && wizardHoraSalida.HasValue && wizardHoraSalida > wizardHoraEntrada,
            3 => wizardActividadId > 0,
            4 => true,
            _ => true
        };
    }

    private bool CanSaveWizard()
    {
        return selectedEmpleadoIds.Count > 0
            && wizardHoraEntrada.HasValue
            && wizardHoraSalida.HasValue
            && wizardHoraSalida > wizardHoraEntrada
            && wizardActividadId > 0;
    }

    private void WizardNext()
    {
        if (CanAdvanceWizard() && wizardStep < 4)
        {
            wizardStep++;
        }
    }

    private void WizardBack()
    {
        if (wizardStep > 0)
            wizardStep--;
    }

    private async Task WizardSave()
    {
        if (selectedEmpleadoIds.Count == 0)
        {
            wizardError = "No hay empleados seleccionados";
            return;
        }

        isWizardSaving = true;
        wizardError = null;
        int successCount = 0;
        int errorCount = 0;

        try
        {
            foreach (var empleadoId in selectedEmpleadoIds)
            {
                try
                {
                    // Create new registro diario for this employee
                    var registro = new RegistroDiario
                    {
                        Fecha = wizardDate,
                        EmpleadoId = empleadoId,
                        HoraEntrada = wizardHoraEntrada,
                        HoraSalida = wizardHoraSalida,
                        Estado = EstadoRegistroDiario.Borrador,
                        Activo = true,
                        FechaCreacion = DateTime.Now,
                        DetallesActividades = new List<DetalleActividad>()
                    };

                    // Add activity detail
                    if (wizardActividadId > 0)
                    {
                        registro.DetallesActividades.Add(new DetalleActividad
                        {
                            ActividadId = wizardActividadId,
                            ProyectoId = wizardProyectoId,
                            Horas = wizardHorasManual, // Usar horas manuales del slider
                            Descripcion = wizardDescripcion,
                            Activo = true,
                            FechaCreacion = DateTime.Now
                        });
                    }

                    // Save using service
                    var result = await ControlDiarioService.SaveRegistroAsync(registro);
                    if (result.Success)
                        successCount++;
                    else
                        errorCount++;
                }
                catch
                {
                    errorCount++;
                }
            }

            if (errorCount == 0)
            {
                successMessage = $"{successCount} registros creados exitosamente";
                await ShowSuccessAndGoHome();
            }
            else
            {
                wizardError = $"Se crearon {successCount} registros, pero hubo {errorCount} errores";
            }
        }
        finally
        {
            isWizardSaving = false;
        }
    }

    private async Task ShowSuccessAndGoHome()
    {
        // Simply go back to list view and show a success message
        isWizardMode = false;
        await LoadDataWithFilters();
        StateHasChanged();
    }
}
