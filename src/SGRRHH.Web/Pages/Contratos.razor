@page "/contratos"
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Enums
@using SGRRHH.Core.Interfaces
@using SGRRHH.Web.Components.Shared
@using SGRRHH.Web.Components.Forms
@using SGRRHH.Web.Client
@inject IContratoRepository ContratoRepo
@inject IContratoService ContratoService
@inject ICargoRepository CargoRepo
@inject IEmpleadoRepository EmpleadoRepo
@inject FirebaseJsInterop Firebase
@inject AppStateService AppState
@inject IJSRuntime JSRuntime

<div class="module-container">
    @* Toolbar *@
    <div class="module-toolbar">
        <button class="legacy-button" @onclick="LoadData" disabled="@isLoading">
            @(isLoading ? "Cargando..." : "Actualizar")
        </button>
        @if (CanManage)
        {
            <button class="legacy-button" @onclick="ShowNewModal">+ Nuevo Contrato</button>
        }

        <div style="flex: 1;"></div>

        @* Selector de empleado *@
        <label style="font-size: 11px; margin-right: 5px;">Empleado:</label>
        <select class="legacy-input" style="width: 250px;" @bind="selectedEmpleadoId" @bind:after="OnEmpleadoChanged">
            <option value="0">-- Todos los empleados --</option>
            @foreach (var emp in empleados ?? Enumerable.Empty<Empleado>())
            {
                <option value="@emp.Id">@emp.Codigo - @emp.NombreCompleto</option>
            }
        </select>
    </div>

    @* Mensaje de exito *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="legacy-alert legacy-alert-success">
            @successMessage
        </div>
    }

    @* Alerta de contratos proximos a vencer *@
    @if (contratosProximosAVencer != null && contratosProximosAVencer.Any())
    {
        <div class="alert-box alert-warning">
            <div class="alert-header">
                <strong>Contratos proximos a vencer (30 dias)</strong>
            </div>
            <div class="alert-content">
                @foreach (var c in contratosProximosAVencer)
                {
                    <div class="alert-item">
                        <span class="alert-name">@(c.Empleado?.NombreCompleto ?? "N/A")</span>
                        <span class="alert-detail">Vence: @(c.FechaFin?.ToString("dd/MM/yyyy") ?? "-") (@c.TipoContrato)</span>
                    </div>
                }
            </div>
        </div>
    }

    @* Panel de contrato activo (cuando hay empleado seleccionado) *@
    @if (selectedEmpleadoId > 0 && contratoActivo != null)
    {
        <div class="active-contract-panel">
            <div class="panel-header">Contrato Activo</div>
            <div class="panel-content">
                <div class="contract-info">
                    <div class="info-row">
                        <span class="info-label">Tipo:</span>
                        <span class="info-value"><strong>@GetTipoContratoLabel(contratoActivo.TipoContrato)</strong></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cargo:</span>
                        <span class="info-value">@(contratoActivo.Cargo?.Nombre ?? "-")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Inicio:</span>
                        <span class="info-value">@contratoActivo.FechaInicio.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fin:</span>
                        <span class="info-value">@(contratoActivo.FechaFin?.ToString("dd/MM/yyyy") ?? "Indefinido")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Salario:</span>
                        <span class="info-value salary">@contratoActivo.Salario.ToString("C0")</span>
                    </div>
                </div>
                <div class="days-remaining">
                    <span class="days-label">Dias restantes:</span>
                    <span class="days-value">@GetDiasRestantes()</span>
                </div>
                <div class="contract-actions">
                    @if (!string.IsNullOrEmpty(contratoActivo.ArchivoAdjuntoPath))
                    {
                        <button class="legacy-button-small" @onclick="() => VerArchivo(contratoActivo)">Ver Contrato</button>
                    }
                    @if (CanManage)
                    {
                        <button class="legacy-button-small" @onclick="ShowRenovarModal">Renovar</button>
                    }
                    @if (CanFinalize)
                    {
                        <button class="legacy-button-small legacy-button-danger" @onclick="ShowFinalizarModal">Finalizar</button>
                    }
                </div>
            </div>
        </div>
    }
    @if (selectedEmpleadoId > 0 && contratoActivo == null && !isLoading)
    {
        <div class="no-contract-panel">
            <span>Este empleado no tiene contrato activo.</span>
            @if (CanManage)
            {
                <button class="legacy-button-small" @onclick="ShowNewModal">Crear Contrato</button>
            }
        </div>
    }

    @* Contenido principal - Tabla de contratos *@
    @if (isLoading)
    {
        <div class="loading-indicator">Cargando datos...</div>
    }
    else if (contratosFiltrados == null || !contratosFiltrados.Any())
    {
        <div class="empty-state">
            @if (selectedEmpleadoId > 0)
            {
                <span>No hay contratos registrados para este empleado.</span>
            }
            else
            {
                <span>No hay contratos registrados.</span>
            }
        </div>
    }
    else
    {
        <div class="table-container">
            <table class="legacy-table">
                <thead>
                    <tr>
                        @if (selectedEmpleadoId == 0)
                        {
                            <th>Empleado</th>
                        }
                        <th style="width: 100px;">Tipo</th>
                        <th>Cargo</th>
                        <th style="width: 100px;">Fecha Inicio</th>
                        <th style="width: 100px;">Fecha Fin</th>
                        <th style="width: 110px;">Salario</th>
                        <th style="width: 90px;">Estado</th>
                        <th style="width: 40px;">Adj</th>
                        <th style="width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var contrato in contratosFiltrados)
                    {
                        <tr class="@GetRowClass(contrato)">
                            @if (selectedEmpleadoId == 0)
                            {
                                <td><strong>@(contrato.Empleado?.NombreCompleto ?? $"#{contrato.EmpleadoId}")</strong></td>
                            }
                            <td>@GetTipoContratoLabel(contrato.TipoContrato)</td>
                            <td>@(contrato.Cargo?.Nombre ?? "-")</td>
                            <td>@contrato.FechaInicio.ToString("dd/MM/yyyy")</td>
                            <td>@(contrato.FechaFin?.ToString("dd/MM/yyyy") ?? "Indefinido")</td>
                            <td style="text-align: right;">@contrato.Salario.ToString("C0")</td>
                            <td style="text-align: center;">
                                <span class="status-badge @GetStatusClass(contrato.Estado)">
                                    @GetEstadoLabel(contrato.Estado)
                                </span>
                            </td>
                            <td style="text-align: center;">
                                @if (!string.IsNullOrEmpty(contrato.ArchivoAdjuntoPath))
                                {
                                    <button class="legacy-button-tiny" @onclick="() => VerArchivo(contrato)" title="Ver archivo adjunto">*</button>
                                }
                            </td>
                            <td>
                                @if (contrato.Estado == EstadoContrato.Activo && CanManage)
                                {
                                    <button class="legacy-button-small" @onclick="() => ShowEditModal(contrato)">Editar</button>
                                }
                                @if (CanDelete && contrato.Estado != EstadoContrato.Finalizado)
                                {
                                    <button class="legacy-button-small legacy-button-danger" @onclick="() => ShowDeleteModal(contrato)">Eliminar</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="module-footer">
            Total: <strong>@contratosFiltrados.Count()</strong> contratos
            @if (selectedEmpleadoId > 0)
            {
                <span> | Historial de @(empleados?.FirstOrDefault(e => e.Id == selectedEmpleadoId)?.NombreCompleto ?? "empleado")</span>
            }
        </div>
    }
</div>

@* Modal de Crear/Editar Contrato *@
<LegacyModal Title="@modalTitle"
             IsVisible="@showFormModal"
             OnClose="CloseFormModal"             OnEnter="SaveForm"             Width="650px">
    <ChildContent>
        <ContratoForm @ref="formComponent"
                      ContratoEdit="@selectedContrato"
                      OnSave="HandleSave"
                      OnCancel="CloseFormModal" />
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseFormModal" disabled="@isSaving">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="SaveForm" disabled="@isSaving">
            @(isSaving ? "Guardando..." : "Guardar")
        </button>
    </FooterContent>
</LegacyModal>

@* Modal de Renovar Contrato *@
<LegacyModal Title="Renovar Contrato"
             IsVisible="@showRenovarModal"
             OnClose="CloseRenovarModal"
             Width="650px">
    <ChildContent>
        @if (contratoRenovacion != null)
        {
            <div class="renovation-info">
                <p>Se creara un nuevo contrato basado en el actual. El contrato anterior se marcara como <strong>Renovado</strong>.</p>
            </div>
            <ContratoForm @ref="renovarFormComponent"
                          ContratoEdit="@contratoRenovacion"
                          SkipSave="true"
                          OnSave="HandleRenovacion"
                          OnCancel="CloseRenovarModal" />
        }
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseRenovarModal" disabled="@isSaving">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="SaveRenovacion" disabled="@isSaving">
            @(isSaving ? "Renovando..." : "Renovar Contrato")
        </button>
    </FooterContent>
</LegacyModal>

@* Modal de Finalizar Contrato *@
<LegacyModal Title="Finalizar Contrato"
             IsVisible="@showFinalizarModal"
             OnClose="CloseFinalizarModal"
             Width="400px">
    <ChildContent>
        <div style="padding: 15px; text-align: center;">
            <p>Esta seguro de <strong>finalizar</strong> el contrato de:</p>
            <p><strong>@(empleados?.FirstOrDefault(e => e.Id == selectedEmpleadoId)?.NombreCompleto ?? "")</strong></p>
            <p style="margin-top: 15px;">
                <label style="font-size: 11px;">Fecha de finalizacion:</label><br/>
                <input type="date" class="legacy-input" style="width: 150px;"
                       value="@fechaFinalizacion.ToString("yyyy-MM-dd")"
                       @onchange="e => fechaFinalizacion = DateTime.Parse(e.Value?.ToString() ?? DateTime.Today.ToString())" />
            </p>
            <p style="color: #c62828; font-size: 11px; margin-top: 10px;">Esta accion no se puede deshacer.</p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseFinalizarModal">Cancelar</button>
        <button class="legacy-button legacy-button-danger" @onclick="ConfirmFinalizar">Finalizar</button>
    </FooterContent>
</LegacyModal>

@* Modal de Eliminar Contrato *@
<LegacyModal Title="Eliminar Contrato"
             IsVisible="@showDeleteModal"
             OnClose="CloseDeleteModal"
             Width="400px">
    <ChildContent>
        <div style="padding: 15px; text-align: center;">
            <p>Esta seguro de <strong>eliminar</strong> este contrato?</p>
            @if (contratoToDelete != null)
            {
                <p>Tipo: <strong>@GetTipoContratoLabel(contratoToDelete.TipoContrato)</strong></p>
                <p>Inicio: @contratoToDelete.FechaInicio.ToString("dd/MM/yyyy")</p>
            }
            <p style="color: #c62828; font-size: 11px; margin-top: 10px;">Esta accion no se puede deshacer.</p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseDeleteModal">Cancelar</button>
        <button class="legacy-button legacy-button-danger" @onclick="ConfirmDelete">Eliminar</button>
    </FooterContent>
</LegacyModal>

@code {
    // Data
    private IEnumerable<Contrato>? allContratos;
    private IEnumerable<Contrato>? contratosFiltrados;
    private IEnumerable<Contrato>? contratosProximosAVencer;
    private IEnumerable<Empleado>? empleados;
    private Contrato? contratoActivo;

    // State
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private int selectedEmpleadoId = 0;

    // Modals
    private bool showFormModal = false;
    private bool showRenovarModal = false;
    private bool showFinalizarModal = false;
    private bool showDeleteModal = false;
    private string modalTitle = "";
    private Contrato? selectedContrato;
    private Contrato? contratoRenovacion;
    private Contrato? contratoToDelete;
    private DateTime fechaFinalizacion = DateTime.Today;

    // Form components
    private ContratoForm? formComponent;
    private ContratoForm? renovarFormComponent;

    // Permissions
    private bool CanManage => AppState.CurrentUser?.Rol == RolUsuario.Administrador ||
                              AppState.CurrentUser?.Rol == RolUsuario.Operador;
    private bool CanFinalize => AppState.CurrentUser?.Rol == RolUsuario.Administrador;
    private bool CanDelete => AppState.CurrentUser?.Rol == RolUsuario.Administrador;

    protected override async Task OnInitializedAsync()
    {
        AppState.SetViewTitle("Contratos");
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        successMessage = null;
        try
        {
            // Cargar empleados activos
            empleados = await EmpleadoRepo.GetAllActiveAsync();

            // Cargar todos los contratos
            allContratos = await ContratoRepo.GetAllAsync();

            // Cargar contratos proximos a vencer
            var proximosResult = await ContratoService.GetContratosProximosAVencerAsync(30);
            if (proximosResult.Success && proximosResult.Data != null)
            {
                contratosProximosAVencer = proximosResult.Data;
            }

            // Filtrar segun empleado seleccionado
            FilterContratos();

            // Cargar contrato activo si hay empleado seleccionado
            if (selectedEmpleadoId > 0)
            {
                await LoadContratoActivo();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnEmpleadoChanged()
    {
        FilterContratos();
        contratoActivo = null;

        if (selectedEmpleadoId > 0)
        {
            await LoadContratoActivo();
        }
    }

    private void FilterContratos()
    {
        if (allContratos == null)
        {
            contratosFiltrados = null;
            return;
        }

        if (selectedEmpleadoId > 0)
        {
            contratosFiltrados = allContratos
                .Where(c => c.EmpleadoId == selectedEmpleadoId)
                .OrderByDescending(c => c.FechaInicio);
        }
        else
        {
            contratosFiltrados = allContratos
                .OrderByDescending(c => c.FechaInicio);
        }
    }

    private async Task LoadContratoActivo()
    {
        if (selectedEmpleadoId <= 0) return;

        try
        {
            var result = await ContratoService.GetContratoActivoAsync(selectedEmpleadoId);
            contratoActivo = result.Data;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando contrato activo: {ex.Message}");
        }
    }

    private string GetDiasRestantes()
    {
        if (contratoActivo == null) return "-";
        if (!contratoActivo.FechaFin.HasValue) return "Indefinido";

        var dias = (contratoActivo.FechaFin.Value - DateTime.Today).Days;
        return dias >= 0 ? dias.ToString() : "Vencido";
    }

    // Labels
    private string GetTipoContratoLabel(TipoContrato tipo) => tipo switch
    {
        TipoContrato.Indefinido => "Indefinido",
        TipoContrato.Fijo => "Termino Fijo",
        TipoContrato.ObraLabor => "Obra o Labor",
        TipoContrato.PrestacionServicios => "Prest. Servicios",
        TipoContrato.Aprendizaje => "Aprendizaje",
        _ => "Desconocido"
    };

    private string GetEstadoLabel(EstadoContrato estado) => estado switch
    {
        EstadoContrato.Activo => "Activo",
        EstadoContrato.Finalizado => "Finalizado",
        EstadoContrato.Renovado => "Renovado",
        EstadoContrato.Cancelado => "Cancelado",
        _ => "Desconocido"
    };

    private string GetStatusClass(EstadoContrato estado) => estado switch
    {
        EstadoContrato.Activo => "status-active",
        EstadoContrato.Finalizado => "status-danger",
        EstadoContrato.Renovado => "status-info",
        EstadoContrato.Cancelado => "status-danger",
        _ => ""
    };

    private string GetRowClass(Contrato c) => c.Estado switch
    {
        EstadoContrato.Finalizado or EstadoContrato.Renovado or EstadoContrato.Cancelado => "inactive-row",
        _ => ""
    };

    // Modal handlers - New
    private void ShowNewModal()
    {
        if (selectedEmpleadoId <= 0)
        {
            // Abrir modal sin empleado preseleccionado
            selectedContrato = null;
        }
        else if (contratoActivo != null)
        {
            // Ya tiene contrato activo
            successMessage = "El empleado ya tiene un contrato activo. Use Renovar para crear uno nuevo.";
            _ = ClearSuccessMessage();
            return;
        }
        else
        {
            // Crear contrato para empleado seleccionado - el form lo manejara
            selectedContrato = null;
        }

        modalTitle = "Nuevo Contrato";
        showFormModal = true;
    }

    // Modal handlers - Edit
    private void ShowEditModal(Contrato contrato)
    {
        selectedContrato = contrato;
        modalTitle = "Editar Contrato";
        showFormModal = true;
    }

    private void CloseFormModal()
    {
        showFormModal = false;
        selectedContrato = null;
    }

    private async Task SaveForm()
    {
        if (formComponent == null) return;

        isSaving = true;
        try
        {
            var success = await formComponent.ValidateAndSaveAsync();
            // HandleSave sera llamado si es exitoso
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleSave(Contrato contrato)
    {
        showFormModal = false;
        successMessage = selectedContrato == null
            ? "Contrato creado exitosamente"
            : "Contrato actualizado exitosamente";
        selectedContrato = null;
        await LoadData();
        _ = ClearSuccessMessage();
    }

    // Modal handlers - Renovar
    private void ShowRenovarModal()
    {
        if (contratoActivo == null) return;

        // Crear un contrato base para la renovacion
        contratoRenovacion = new Contrato
        {
            EmpleadoId = contratoActivo.EmpleadoId,
            TipoContrato = contratoActivo.TipoContrato,
            FechaInicio = contratoActivo.FechaFin?.AddDays(1) ?? DateTime.Today,
            FechaFin = (contratoActivo.FechaFin?.AddDays(1) ?? DateTime.Today).AddYears(1),
            Salario = contratoActivo.Salario,
            CargoId = contratoActivo.CargoId,
            Estado = EstadoContrato.Activo,
            Observaciones = "Renovacion de contrato",
            Activo = true
        };

        showRenovarModal = true;
    }

    private void CloseRenovarModal()
    {
        showRenovarModal = false;
        contratoRenovacion = null;
    }

    private async Task SaveRenovacion()
    {
        if (renovarFormComponent == null || contratoActivo == null) return;

        isSaving = true;
        try
        {
            var success = await renovarFormComponent.ValidateAndSaveAsync();
            // HandleRenovacion sera llamado si es exitoso
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleRenovacion(Contrato nuevoContrato)
    {
        if (contratoActivo == null) return;

        try
        {
            // Usar el servicio de renovacion que marca el anterior como Renovado
            var result = await ContratoService.RenovarContratoAsync(contratoActivo.Id, nuevoContrato);

            if (result.Success)
            {
                showRenovarModal = false;
                contratoRenovacion = null;
                successMessage = "Contrato renovado exitosamente";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error renovando: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    // Modal handlers - Finalizar
    private void ShowFinalizarModal()
    {
        if (contratoActivo == null) return;
        fechaFinalizacion = DateTime.Today;
        showFinalizarModal = true;
    }

    private void CloseFinalizarModal()
    {
        showFinalizarModal = false;
    }

    private async Task ConfirmFinalizar()
    {
        if (contratoActivo == null) return;

        try
        {
            var result = await ContratoService.FinalizarContratoAsync(contratoActivo.Id, fechaFinalizacion);

            if (result.Success)
            {
                showFinalizarModal = false;
                successMessage = "Contrato finalizado exitosamente";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error finalizando: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    // Modal handlers - Delete
    private void ShowDeleteModal(Contrato contrato)
    {
        contratoToDelete = contrato;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        contratoToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (contratoToDelete == null) return;

        try
        {
            var result = await ContratoService.DeleteAsync(contratoToDelete.Id);

            if (result.Success)
            {
                showDeleteModal = false;
                contratoToDelete = null;
                successMessage = "Contrato eliminado";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error eliminando: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    // Ver archivo adjunto
    private async Task VerArchivo(Contrato contrato)
    {
        if (string.IsNullOrEmpty(contrato.ArchivoAdjuntoPath)) return;

        try
        {
            var url = await Firebase.GetStorageUrlAsync(contrato.ArchivoAdjuntoPath);
            if (!string.IsNullOrEmpty(url))
            {
                await JSRuntime.InvokeVoidAsync("open", url, "_blank");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error abriendo archivo: {ex.Message}");
        }
    }

    private async Task ClearSuccessMessage()
    {
        await Task.Delay(4000);
        successMessage = null;
        StateHasChanged();
    }
}
