@page "/vacaciones"
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Enums
@using SGRRHH.Core.Interfaces
@using SGRRHH.Core.Models
@using SGRRHH.Web.Components.Shared
@using SGRRHH.Web.Components.Forms
@inject IVacacionService VacacionService
@inject IVacacionRepository VacacionRepo
@inject IEmpleadoRepository EmpleadoRepo
@inject AppStateService AppState

<div class="module-container">
    @* Toolbar *@
    <div class="module-toolbar">
        <button class="legacy-button" @onclick="LoadData" disabled="@isLoading">
            @(isLoading ? "Cargando..." : "Actualizar")
        </button>
        <button class="legacy-button" @onclick="ShowNewModal">+ Solicitar Vacaciones</button>

        <div style="flex: 1;"></div>

        @* Filtro por empleado *@
        <select class="legacy-input" @bind="filtroEmpleadoId" @bind:after="OnEmpleadoFilterChanged" style="width: 200px;">
            <option value="0">-- Todos los empleados --</option>
            @foreach (var emp in empleados ?? Enumerable.Empty<Empleado>())
            {
                <option value="@emp.Id">@emp.NombreCompleto</option>
            }
        </select>

        <select class="legacy-input" @bind="filtroEstado" @bind:after="FilterData" style="width: 150px;">
            <option value="">Todos los estados</option>
            <option value="@EstadoVacacion.Pendiente">Pendientes</option>
            <option value="@EstadoVacacion.Aprobada">Aprobadas</option>
            <option value="@EstadoVacacion.Programada">Programadas</option>
            <option value="@EstadoVacacion.Disfrutada">Disfrutadas</option>
            <option value="@EstadoVacacion.Rechazada">Rechazadas</option>
            <option value="@EstadoVacacion.Cancelada">Canceladas</option>
        </select>
    </div>

    @* Panel de Resumen de Vacaciones (cuando hay empleado seleccionado) *@
    @if (filtroEmpleadoId > 0 && resumenVacaciones != null)
    {
        <ResumenVacacionesPanel Resumen="@resumenVacaciones" />
    }

    @* Mensaje de exito *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="legacy-alert legacy-alert-success">
            @successMessage
        </div>
    }

    @* Contenido principal *@
    @if (isLoading)
    {
        <div class="loading-indicator">Cargando vacaciones...</div>
    }
    else if (filteredVacaciones == null || !filteredVacaciones.Any())
    {
        <div class="empty-state">No hay vacaciones registradas.</div>
    }
    else
    {
        <div class="table-container">
            <table class="legacy-table">
                <thead>
                    <tr>
                        <th>Empleado</th>
                        <th style="width: 100px;">F. Inicio</th>
                        <th style="width: 100px;">F. Fin</th>
                        <th style="width: 50px;">Dias</th>
                        <th style="width: 70px;">Periodo</th>
                        <th style="width: 100px;">Estado</th>
                        <th style="width: 180px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vac in filteredVacaciones)
                    {
                        <tr class="@GetRowClass(vac)">
                            <td><strong>@(vac.Empleado?.NombreCompleto ?? $"Empleado #{vac.EmpleadoId}")</strong></td>
                            <td>@vac.FechaInicio.ToString("dd/MM/yyyy")</td>
                            <td>@vac.FechaFin.ToString("dd/MM/yyyy")</td>
                            <td style="text-align: center; font-weight: bold;">@vac.DiasTomados</td>
                            <td style="text-align: center;">@vac.PeriodoCorrespondiente</td>
                            <td style="text-align: center;">
                                <span class="status-badge @GetStatusClass(vac.Estado)">
                                    @GetEstadoLabel(vac.Estado)
                                </span>
                            </td>
                            <td>
                                <button class="legacy-button-small" @onclick="() => ShowViewModal(vac)">Ver</button>
                                @if (CanEditVacacion(vac))
                                {
                                    <button class="legacy-button-small legacy-button-primary" @onclick="() => ShowEditModal(vac)">Editar</button>
                                }
                                @if (vac.Estado == EstadoVacacion.Pendiente && AppState.CanApprove)
                                {
                                    <button class="legacy-button-small legacy-button-success" @onclick="() => ShowApproveModal(vac)">Aprobar</button>
                                    <button class="legacy-button-small legacy-button-danger" @onclick="() => ShowRejectModal(vac)">Rechazar</button>
                                }
                                @if ((vac.Estado == EstadoVacacion.Programada || vac.Estado == EstadoVacacion.Aprobada) && vac.FechaFin < DateTime.Today)
                                {
                                    <button class="legacy-button-small legacy-button-primary" @onclick="() => ShowMarkDisfrutadaModal(vac)">Disfrutada</button>
                                }
                                @if (AppState.IsAdmin && vac.Estado != EstadoVacacion.Cancelada && vac.Estado != EstadoVacacion.Disfrutada)
                                {
                                    <button class="legacy-button-small legacy-button-danger" @onclick="() => ShowDeleteModal(vac)" title="Eliminar">X</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="module-footer">
            Total: <strong>@filteredVacaciones.Count()</strong> solicitudes
        </div>
    }
</div>

@* Modal de Crear *@
<LegacyModal Title="@modalTitle"
             IsVisible="@showFormModal"
             OnClose="CloseFormModal"
             Width="600px">
    <ChildContent>
        <VacacionForm @ref="formComponent"
                      VacacionEdit="@selectedVacacion"
                      OnSave="HandleSave"
                      OnCancel="CloseFormModal" />
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseFormModal" disabled="@isSaving">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="SaveForm" disabled="@isSaving">
            @(isSaving ? "Guardando..." : "Guardar")
        </button>
    </FooterContent>
</LegacyModal>

@* Modal de Ver Detalle *@
<LegacyModal Title="Detalle de Vacaciones"
             IsVisible="@showViewModal"
             OnClose="CloseViewModal"
             Width="500px">
    <ChildContent>
        @if (selectedVacacion != null)
        {
            <div class="detail-view">
                <div class="detail-row">
                    <span class="detail-label">Empleado:</span>
                    <span class="detail-value"><strong>@(selectedVacacion.Empleado?.NombreCompleto ?? "-")</strong></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Periodo:</span>
                    <span class="detail-value">@selectedVacacion.FechaInicio.ToString("dd/MM/yyyy") - @selectedVacacion.FechaFin.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total dias:</span>
                    <span class="detail-value"><strong>@selectedVacacion.DiasTomados dias</strong></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Periodo laboral:</span>
                    <span class="detail-value">@selectedVacacion.PeriodoCorrespondiente</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Estado:</span>
                    <span class="detail-value">
                        <span class="status-badge @GetStatusClass(selectedVacacion.Estado)">
                            @GetEstadoLabel(selectedVacacion.Estado)
                        </span>
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(selectedVacacion.Observaciones))
                {
                    <div class="detail-row">
                        <span class="detail-label">Observaciones:</span>
                        <span class="detail-value">@selectedVacacion.Observaciones</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(selectedVacacion.MotivoRechazo))
                {
                    <div class="detail-row">
                        <span class="detail-label">Motivo Rechazo:</span>
                        <span class="detail-value" style="color: #c62828;">@selectedVacacion.MotivoRechazo</span>
                    </div>
                }
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseViewModal">Cerrar</button>
    </FooterContent>
</LegacyModal>

@* Modal de Aprobar *@
<LegacyModal Title="Aprobar Vacaciones"
             IsVisible="@showApproveModal"
             OnClose="CloseApproveModal"
             Width="400px">
    <ChildContent>
        <div style="text-align: center; padding: 10px;">
            <p>Aprobar las vacaciones de?</p>
            <p><strong>@selectedVacacion?.Empleado?.NombreCompleto</strong></p>
            <p>@selectedVacacion?.FechaInicio.ToString("dd/MM/yyyy") - @selectedVacacion?.FechaFin.ToString("dd/MM/yyyy")</p>
            <p>(@selectedVacacion?.DiasTomados dias)</p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseApproveModal">Cancelar</button>
        <button class="legacy-button legacy-button-success" @onclick="ConfirmApprove">Aprobar</button>
    </FooterContent>
</LegacyModal>

@* Modal de Rechazar *@
<LegacyModal Title="Rechazar Vacaciones"
             IsVisible="@showRejectModal"
             OnClose="CloseRejectModal"
             Width="450px">
    <ChildContent>
        <div style="padding: 10px;">
            <p style="margin-bottom: 10px;">Rechazar las vacaciones de <strong>@selectedVacacion?.Empleado?.NombreCompleto</strong>?</p>
            <div class="legacy-form-group">
                <label class="legacy-form-label required">Motivo del Rechazo</label>
                <textarea class="legacy-form-textarea" @bind="motivoRechazo" rows="3" placeholder="Ingrese el motivo del rechazo"></textarea>
            </div>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseRejectModal">Cancelar</button>
        <button class="legacy-button legacy-button-danger" @onclick="ConfirmReject" disabled="@string.IsNullOrWhiteSpace(motivoRechazo)">Rechazar</button>
    </FooterContent>
</LegacyModal>

@* Modal de Eliminar *@
<LegacyModal Title="Eliminar Vacacion"
             IsVisible="@showDeleteModal"
             OnClose="CloseDeleteModal"
             Width="400px"
             CloseOnOverlayClick="false">
    <ChildContent>
        <div style="text-align: center; padding: 10px;">
            <p style="color: #c62828; font-weight: bold; margin-bottom: 10px;">Esta accion no se puede deshacer</p>
            <p>Eliminar las vacaciones de <strong>@selectedVacacion?.Empleado?.NombreCompleto</strong>?</p>
            <p style="font-size: 12px; color: #555;">@selectedVacacion?.FechaInicio.ToString("dd/MM/yyyy") - @selectedVacacion?.FechaFin.ToString("dd/MM/yyyy") (@selectedVacacion?.DiasTomados dias)</p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseDeleteModal" disabled="@isDeleting">Cancelar</button>
        <button class="legacy-button legacy-button-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
            @(isDeleting ? "Eliminando..." : "Eliminar")
        </button>
    </FooterContent>
</LegacyModal>

@* Modal de Marcar Disfrutada *@
<LegacyModal Title="Marcar como Disfrutada"
             IsVisible="@showMarkDisfrutadaModal"
             OnClose="CloseMarkDisfrutadaModal"
             Width="400px">
    <ChildContent>
        <div style="text-align: center; padding: 10px;">
            <p>Confirmar que las vacaciones fueron disfrutadas?</p>
            <p><strong>@selectedVacacion?.Empleado?.NombreCompleto</strong></p>
            <p style="font-size: 12px; color: #555;">@selectedVacacion?.FechaInicio.ToString("dd/MM/yyyy") - @selectedVacacion?.FechaFin.ToString("dd/MM/yyyy")</p>
            <p style="font-size: 12px; color: #555;">(@selectedVacacion?.DiasTomados dias)</p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseMarkDisfrutadaModal" disabled="@isMarkingDisfrutada">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="ConfirmMarkDisfrutada" disabled="@isMarkingDisfrutada">
            @(isMarkingDisfrutada ? "Procesando..." : "Confirmar")
        </button>
    </FooterContent>
</LegacyModal>

@code {
    private IEnumerable<Vacacion>? allVacaciones;
    private IEnumerable<Vacacion>? filteredVacaciones;
    private IEnumerable<Empleado>? empleados;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private EstadoVacacion? filtroEstado;
    private int filtroEmpleadoId = 0;
    private ResumenVacaciones? resumenVacaciones;

    private bool showFormModal = false;
    private bool showViewModal = false;
    private bool showApproveModal = false;
    private bool showRejectModal = false;
    private bool showDeleteModal = false;
    private bool showMarkDisfrutadaModal = false;
    private Vacacion? selectedVacacion;
    private string modalTitle = "";
    private VacacionForm? formComponent;
    private string motivoRechazo = "";
    private bool isDeleting = false;
    private bool isMarkingDisfrutada = false;
    private bool isEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        AppState.SetViewTitle("Vacaciones");
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        successMessage = null;
        try
        {
            // Cargar empleados para el filtro
            empleados = await EmpleadoRepo.GetAllActiveAsync();
            
            // Cargar vacaciones
            allVacaciones = await VacacionRepo.GetAllAsync();
            FilterData();
            
            // Cargar resumen si hay empleado seleccionado
            if (filtroEmpleadoId > 0)
            {
                await LoadResumenVacaciones();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando vacaciones: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterData()
    {
        if (allVacaciones == null) return;
        var query = allVacaciones.AsEnumerable();
        
        // Filtrar por empleado
        if (filtroEmpleadoId > 0)
        {
            query = query.Where(v => v.EmpleadoId == filtroEmpleadoId);
        }
        
        // Filtrar por estado
        if (filtroEstado.HasValue) 
        {
            query = query.Where(v => v.Estado == filtroEstado.Value);
        }
        
        filteredVacaciones = query.OrderByDescending(v => v.FechaSolicitud).ToList();
    }

    private async Task OnEmpleadoFilterChanged()
    {
        FilterData();
        if (filtroEmpleadoId > 0)
        {
            await LoadResumenVacaciones();
        }
        else
        {
            resumenVacaciones = null;
        }
    }

    private async Task LoadResumenVacaciones()
    {
        if (filtroEmpleadoId <= 0) return;
        try
        {
            var result = await VacacionService.GetResumenVacacionesAsync(filtroEmpleadoId);
            if (result.Success)
            {
                resumenVacaciones = result.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando resumen: {ex.Message}");
        }
    }

    // Determina si una vacación puede ser editada
    private bool CanEditVacacion(Vacacion vac)
    {
        // Solo admin/operador puede editar
        if (!AppState.IsAdmin && !AppState.CanEditVacaciones) return false;
        
        // No se pueden editar vacaciones ya disfrutadas o canceladas
        if (vac.Estado == EstadoVacacion.Disfrutada || vac.Estado == EstadoVacacion.Cancelada) return false;
        
        // Si ya pasó la fecha fin, no se puede editar (excepto admin)
        if (vac.FechaFin < DateTime.Today && !AppState.IsAdmin) return false;
        
        return true;
    }

    private string GetEstadoLabel(EstadoVacacion estado) => estado switch
    {
        EstadoVacacion.Pendiente => "Pendiente",
        EstadoVacacion.Aprobada => "Aprobada",
        EstadoVacacion.Rechazada => "Rechazada",
        EstadoVacacion.Programada => "Programada",
        EstadoVacacion.Disfrutada => "Disfrutada",
        EstadoVacacion.Cancelada => "Cancelada",
        _ => "Desconocido"
    };

    private string GetStatusClass(EstadoVacacion estado) => estado switch
    {
        EstadoVacacion.Pendiente => "status-pending",
        EstadoVacacion.Aprobada or EstadoVacacion.Programada => "status-active",
        EstadoVacacion.Disfrutada => "status-success",
        EstadoVacacion.Rechazada or EstadoVacacion.Cancelada => "status-danger",
        _ => ""
    };

    private string GetRowClass(Vacacion v) => v.Estado switch
    {
        EstadoVacacion.Cancelada or EstadoVacacion.Rechazada => "inactive-row",
        _ => ""
    };

    private void ShowNewModal() { selectedVacacion = null; isEditMode = false; modalTitle = "Solicitar Vacaciones"; showFormModal = true; }
    private void ShowEditModal(Vacacion v) { selectedVacacion = v; isEditMode = true; modalTitle = "Editar Vacaciones"; showFormModal = true; }
    private void ShowViewModal(Vacacion v) { selectedVacacion = v; showViewModal = true; }
    private void CloseFormModal() { showFormModal = false; selectedVacacion = null; isEditMode = false; }
    private void CloseViewModal() { showViewModal = false; }
    private void CloseApproveModal() { showApproveModal = false; selectedVacacion = null; }
    private void CloseRejectModal() { showRejectModal = false; selectedVacacion = null; motivoRechazo = ""; }

    private async Task SaveForm()
    {
        if (formComponent == null) return;
        isSaving = true;
        try { await formComponent.ValidateAndSaveAsync(); }
        finally { isSaving = false; }
    }

    private async Task HandleSave(Vacacion v)
    {
        showFormModal = false;
        successMessage = "Solicitud de vacaciones registrada";
        selectedVacacion = null;
        await LoadData();
        _ = ClearSuccessMessage();
    }

    private void ShowApproveModal(Vacacion v) { selectedVacacion = v; showApproveModal = true; }
    private void ShowRejectModal(Vacacion v) { selectedVacacion = v; motivoRechazo = ""; showRejectModal = true; }

    private async Task ConfirmApprove()
    {
        if (selectedVacacion == null) return;
        try
        {
            // Use service for approval with business logic
            var result = await VacacionService.AprobarVacacionAsync(selectedVacacion.Id, AppState.CurrentUser?.EmpleadoId ?? 0);
            if (result.Success)
            {
                successMessage = "Vacaciones aprobadas";
                showApproveModal = false;
                selectedVacacion = null;
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error aprobando: {result.Message}");
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error aprobando: {ex.Message}"); }
    }

    private async Task ConfirmReject()
    {
        if (selectedVacacion == null || string.IsNullOrWhiteSpace(motivoRechazo)) return;
        try
        {
            // Use service for rejection with business logic
            var result = await VacacionService.RechazarVacacionAsync(
                selectedVacacion.Id,
                AppState.CurrentUser?.EmpleadoId ?? 0,
                motivoRechazo);
            if (result.Success)
            {
                successMessage = "Vacaciones rechazadas";
                showRejectModal = false;
                selectedVacacion = null;
                motivoRechazo = "";
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else
            {
                Console.WriteLine($"Error rechazando: {result.Message}");
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error rechazando: {ex.Message}"); }
    }

    // === DELETE (Admin only) ===
    private void ShowDeleteModal(Vacacion v) { selectedVacacion = v; showDeleteModal = true; }
    private void CloseDeleteModal() { showDeleteModal = false; selectedVacacion = null; }

    private async Task ConfirmDelete()
    {
        if (selectedVacacion == null) return;
        isDeleting = true;
        try
        {
            var result = await VacacionService.DeleteAsync(selectedVacacion.Id);
            if (result.Success)
            {
                successMessage = "Vacacion eliminada";
                showDeleteModal = false;
                selectedVacacion = null;
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else { Console.WriteLine($"Error eliminando: {result.Message}"); }
        }
        catch (Exception ex) { Console.WriteLine($"Error eliminando: {ex.Message}"); }
        finally { isDeleting = false; }
    }

    // === MARCAR DISFRUTADA ===
    private void ShowMarkDisfrutadaModal(Vacacion v) { selectedVacacion = v; showMarkDisfrutadaModal = true; }
    private void CloseMarkDisfrutadaModal() { showMarkDisfrutadaModal = false; selectedVacacion = null; }

    private async Task ConfirmMarkDisfrutada()
    {
        if (selectedVacacion == null) return;
        isMarkingDisfrutada = true;
        try
        {
            var result = await VacacionService.MarcarComoDisfrutadaAsync(selectedVacacion.Id);
            if (result.Success)
            {
                successMessage = "Vacacion marcada como disfrutada";
                showMarkDisfrutadaModal = false;
                selectedVacacion = null;
                await LoadData();
                _ = ClearSuccessMessage();
            }
            else { Console.WriteLine($"Error marcando disfrutada: {result.Message}"); }
        }
        catch (Exception ex) { Console.WriteLine($"Error marcando disfrutada: {ex.Message}"); }
        finally { isMarkingDisfrutada = false; }
    }

    private async Task ClearSuccessMessage() { await Task.Delay(4000); successMessage = null; StateHasChanged(); }
}
