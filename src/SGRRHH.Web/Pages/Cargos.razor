@page "/cargos"
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Interfaces
@using SGRRHH.Web.Components.Shared
@using SGRRHH.Web.Components.Forms
@inject ICargoRepository CargoRepo
@inject IDepartamentoRepository DepartamentoRepo
@inject IEmpleadoRepository EmpleadoRepo
@inject AppStateService AppState

<div class="module-container">
    @* ========== TOOLBAR ========== *@
    <div class="module-toolbar">
        <button class="legacy-button" @onclick="LoadData" disabled="@isLoading">
            @(isLoading ? "Cargando..." : "Actualizar")
        </button>

        @if (AppState.CanCreateCargos)
        {
            <button class="legacy-button" @onclick="ShowNewModal">+ Nuevo Cargo</button>
        }

        <div style="flex: 1;"></div>

        @* Campo de busqueda *@
        <input type="text"
               class="legacy-input"
               placeholder="Buscar por nombre o codigo..."
               @bind="searchText"
               @bind:event="oninput"
               @bind:after="FilterData"
               style="width: 200px;" />

        @* Filtro por departamento *@
        <select class="legacy-input"
                @bind="filterDepartamentoId"
                @bind:after="FilterData"
                style="width: 180px; margin-left: 10px;">
            <option value="">-- Todos --</option>
            @foreach (var dept in departamentos ?? Enumerable.Empty<Departamento>())
            {
                <option value="@dept.Id">@dept.Nombre</option>
            }
        </select>

        <label class="legacy-form-checkbox" style="margin-left: 15px;">
            <input type="checkbox" @bind="showInactive" @bind:after="FilterData" />
            <span>Mostrar Inactivos</span>
        </label>
    </div>

    @* ========== MENSAJE DE EXITO ========== *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="legacy-alert legacy-alert-success">
            @successMessage
        </div>
    }

    @* ========== CONTENIDO PRINCIPAL ========== *@
    @if (isLoading)
    {
        <div class="loading-indicator">Cargando datos...</div>
    }
    else if (filteredCargos == null || !filteredCargos.Any())
    {
        <div class="empty-state">No hay cargos registrados.</div>
    }
    else
    {
        <div class="table-container">
            <table class="legacy-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Codigo</th>
                        <th>Nombre</th>
                        <th>Departamento</th>
                        <th style="width: 60px;">Nivel</th>
                        <th style="width: 90px;">Plazas</th>
                        <th>Reporta a</th>
                        <th style="width: 60px;">Activo</th>
                        <th style="width: 200px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cargo in filteredCargos)
                    {
                        var ocupadas = GetPlazasOcupadas(cargo.Id);
                        var total = cargo.NumeroPlazas;
                        var disponibles = total - ocupadas;

                        <tr class="@(cargo.Activo ? "" : "inactive-row")">
                            <td><code>@cargo.Codigo</code></td>
                            <td><strong>@cargo.Nombre</strong></td>
                            <td>@GetDepartamentoNombre(cargo.DepartamentoId)</td>
                            <td style="text-align: center;">@cargo.Nivel</td>
                            <td style="text-align: center;">
                                <span class="@(disponibles > 0 ? "plazas-disponibles" : "plazas-llenas")">
                                    @ocupadas / @total
                                </span>
                            </td>
                            <td>@GetCargoSuperiorNombre(cargo.CargoSuperiorId)</td>
                            <td style="text-align: center;">@(cargo.Activo ? "Si" : "No")</td>
                            <td>
                                <button class="legacy-button-small" @onclick="() => ShowViewModal(cargo)">Ver</button>
                                @if (AppState.CanEditCargos)
                                {
                                    <button class="legacy-button-small" @onclick="() => ShowEditModal(cargo)">Editar</button>
                                }
                                @if (cargo.Activo)
                                {
                                    @if (AppState.CanDeleteCargos)
                                    {
                                        <button class="legacy-button-small legacy-button-danger" @onclick="() => ShowDeleteConfirm(cargo)">Eliminar</button>
                                    }
                                }
                                else
                                {
                                    @if (AppState.CanEditCargos)
                                    {
                                        <button class="legacy-button-small legacy-button-primary" @onclick="() => Reactivate(cargo)">Reactivar</button>
                                    }
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="module-footer">
            Total: <strong>@filteredCargos.Count()</strong> cargos
            @if (filterDepartamentoId.HasValue)
            {
                <span> | Filtrado por: @GetDepartamentoNombre(filterDepartamentoId)</span>
            }
        </div>
    }
</div>

@* ========== MODAL CREAR/EDITAR ========== *@
<LegacyModal Title="@modalTitle"
             IsVisible="@showFormModal"
             OnClose="CloseFormModal"
             Width="600px">
    <ChildContent>
        <CargoForm @ref="formComponent"
                   CargoEdit="@selectedCargo"
                   OnSave="HandleSave"
                   OnCancel="CloseFormModal" />
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseFormModal" disabled="@isSaving">Cancelar</button>
        <button class="legacy-button legacy-button-primary" @onclick="SaveForm" disabled="@isSaving">
            @(isSaving ? "Guardando..." : "Guardar")
        </button>
    </FooterContent>
</LegacyModal>

@* ========== MODAL VER DETALLE ========== *@
<LegacyModal Title="@($"Cargo: {selectedCargo?.Nombre}")"
             IsVisible="@showViewModal"
             OnClose="CloseViewModal"
             Width="550px">
    <ChildContent>
        @if (selectedCargo != null)
        {
            <div class="detail-view">
                <div class="detail-section">
                    <h4>Informacion General</h4>
                    <div class="detail-row">
                        <span class="detail-label">Codigo:</span>
                        <span class="detail-value"><code>@selectedCargo.Codigo</code></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value"><strong>@selectedCargo.Nombre</strong></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Departamento:</span>
                        <span class="detail-value">@GetDepartamentoNombre(selectedCargo.DepartamentoId)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Nivel:</span>
                        <span class="detail-value">@selectedCargo.Nivel (1 = mas alto)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reporta a:</span>
                        <span class="detail-value">@(GetCargoSuperiorNombre(selectedCargo.CargoSuperiorId) ?? "Ninguno")</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>Plazas y Salario</h4>
                    <div class="detail-row">
                        <span class="detail-label">Plazas:</span>
                        <span class="detail-value">
                            @GetPlazasOcupadas(selectedCargo.Id) ocupadas de @selectedCargo.NumeroPlazas
                        </span>
                    </div>
                    @if (selectedCargo.SalarioBase.HasValue)
                    {
                        <div class="detail-row">
                            <span class="detail-label">Salario Base:</span>
                            <span class="detail-value">@selectedCargo.SalarioBase?.ToString("C0")</span>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(selectedCargo.Descripcion))
                {
                    <div class="detail-section">
                        <h4>Descripcion</h4>
                        <p>@selectedCargo.Descripcion</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedCargo.Requisitos))
                {
                    <div class="detail-section">
                        <h4>Requisitos</h4>
                        <p>@selectedCargo.Requisitos</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedCargo.Competencias))
                {
                    <div class="detail-section">
                        <h4>Competencias</h4>
                        <p>@selectedCargo.Competencias</p>
                    </div>
                }

                <div class="detail-section">
                    <h4>Estado</h4>
                    <div class="detail-row">
                        <span class="detail-label">Activo:</span>
                        <span class="detail-value @(selectedCargo.Activo ? "status-active" : "status-inactive")">
                            @(selectedCargo.Activo ? "Si" : "No")
                        </span>
                    </div>
                </div>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseViewModal">Cerrar</button>
        @if (AppState.CanEditCargos)
        {
            <button class="legacy-button legacy-button-primary" @onclick="EditFromView">Editar</button>
        }
    </FooterContent>
</LegacyModal>

@* ========== MODAL CONFIRMACION ELIMINACION ========== *@
<LegacyModal Title="Confirmar Eliminacion"
             IsVisible="@showDeleteModal"
             OnClose="CloseDeleteModal"
             Width="400px"
             CloseOnOverlayClick="false">
    <ChildContent>
        <div style="text-align: center; padding: 10px;">
            @if (cargoTieneEmpleados)
            {
                <div class="legacy-alert legacy-alert-error" style="margin-bottom: 15px;">
                    Este cargo tiene empleados asignados y no puede eliminarse.
                </div>
            }
            else
            {
                <p style="font-size: 14px; margin-bottom: 15px;">
                    Esta seguro que desea eliminar el cargo?
                </p>
            }
            <p style="font-weight: bold; color: var(--win-navy); font-size: 16px;">
                "@selectedCargo?.Nombre"
            </p>
            <p style="font-size: 11px; color: var(--win-gray); margin-top: 10px;">
                Esta accion marcara el cargo como inactivo.
            </p>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="legacy-button" @onclick="CloseDeleteModal">Cancelar</button>
        @if (!cargoTieneEmpleados)
        {
            <button class="legacy-button legacy-button-danger" @onclick="ConfirmDelete">Eliminar</button>
        }
    </FooterContent>
</LegacyModal>

@code {
    // === DATOS ===
    private IEnumerable<Cargo>? allCargos;
    private IEnumerable<Cargo>? filteredCargos;
    private IEnumerable<Departamento>? departamentos;
    private IEnumerable<Empleado>? empleados;
    private Dictionary<int, int> empleadosPorCargo = new();

    // === ESTADOS ===
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private bool showInactive = false;

    // === FILTROS ===
    private string searchText = "";
    private int? filterDepartamentoId;

    // === MODAL FORMULARIO ===
    private bool showFormModal = false;
    private Cargo? selectedCargo;
    private string modalTitle = "";
    private CargoForm? formComponent;

    // === MODAL VER ===
    private bool showViewModal = false;

    // === MODAL ELIMINACION ===
    private bool showDeleteModal = false;
    private bool cargoTieneEmpleados = false;

    protected override async Task OnInitializedAsync()
    {
        AppState.SetViewTitle("Cargos");
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        successMessage = null;
        try
        {
            // Cargar en paralelo
            var cargosTask = CargoRepo.GetAllAsync();
            var departamentosTask = DepartamentoRepo.GetAllActiveAsync();
            var empleadosTask = EmpleadoRepo.GetAllAsync();

            await Task.WhenAll(cargosTask, departamentosTask, empleadosTask);

            allCargos = await cargosTask;
            departamentos = await departamentosTask;
            empleados = await empleadosTask;

            // Calcular empleados por cargo
            empleadosPorCargo = empleados
                .Where(e => e.CargoId.HasValue)
                .GroupBy(e => e.CargoId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());

            FilterData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterData()
    {
        if (allCargos == null) return;

        var result = allCargos.AsEnumerable();

        // Filtrar por activo/inactivo
        if (!showInactive)
        {
            result = result.Where(c => c.Activo);
        }

        // Filtrar por departamento
        if (filterDepartamentoId.HasValue)
        {
            result = result.Where(c => c.DepartamentoId == filterDepartamentoId.Value);
        }

        // Filtrar por texto de busqueda
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.Trim().ToLower();
            result = result.Where(c =>
                (c.Nombre?.ToLower().Contains(search) ?? false) ||
                (c.Codigo?.ToLower().Contains(search) ?? false));
        }

        filteredCargos = result.OrderBy(c => c.Nivel).ThenBy(c => c.Nombre);
    }

    // === HELPERS ===

    private string GetDepartamentoNombre(int? departamentoId)
    {
        if (!departamentoId.HasValue) return "-";
        return departamentos?.FirstOrDefault(d => d.Id == departamentoId)?.Nombre ?? "-";
    }

    private string GetCargoSuperiorNombre(int? cargoSuperiorId)
    {
        if (!cargoSuperiorId.HasValue) return "-";
        return allCargos?.FirstOrDefault(c => c.Id == cargoSuperiorId)?.Nombre ?? "-";
    }

    private int GetPlazasOcupadas(int cargoId)
    {
        return empleadosPorCargo.TryGetValue(cargoId, out var count) ? count : 0;
    }

    // === CREAR ===

    private void ShowNewModal()
    {
        selectedCargo = null;
        modalTitle = "Nuevo Cargo";
        showFormModal = true;
    }

    // === EDITAR ===

    private void ShowEditModal(Cargo cargo)
    {
        selectedCargo = cargo;
        modalTitle = $"Editar: {cargo.Nombre}";
        showFormModal = true;
    }

    // === VER DETALLE ===

    private void ShowViewModal(Cargo cargo)
    {
        selectedCargo = cargo;
        showViewModal = true;
    }

    private void CloseViewModal()
    {
        showViewModal = false;
    }

    private void EditFromView()
    {
        CloseViewModal();
        if (selectedCargo != null)
        {
            ShowEditModal(selectedCargo);
        }
    }

    // === CERRAR FORMULARIO ===

    private void CloseFormModal()
    {
        showFormModal = false;
        selectedCargo = null;
    }

    private async Task SaveForm()
    {
        if (formComponent == null) return;

        isSaving = true;
        try
        {
            await formComponent.ValidateAndSaveAsync();
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleSave(Cargo cargo)
    {
        showFormModal = false;
        successMessage = selectedCargo == null
            ? $"Cargo '{cargo.Nombre}' creado exitosamente"
            : $"Cargo '{cargo.Nombre}' actualizado exitosamente";
        selectedCargo = null;
        await LoadData();
        _ = ClearSuccessMessage();
    }

    // === ELIMINAR ===

    private void ShowDeleteConfirm(Cargo cargo)
    {
        selectedCargo = cargo;

        // Verificar si tiene empleados
        cargoTieneEmpleados = GetPlazasOcupadas(cargo.Id) > 0;

        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        selectedCargo = null;
        cargoTieneEmpleados = false;
    }

    private async Task ConfirmDelete()
    {
        if (selectedCargo == null || cargoTieneEmpleados) return;

        try
        {
            await CargoRepo.DeleteAsync(selectedCargo.Id);
            successMessage = $"Cargo '{selectedCargo.Nombre}' eliminado (inactivado)";
            showDeleteModal = false;
            selectedCargo = null;
            await LoadData();
            _ = ClearSuccessMessage();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error eliminando cargo: {ex.Message}");
        }
    }

    // === REACTIVAR ===

    private async Task Reactivate(Cargo cargo)
    {
        try
        {
            cargo.Activo = true;
            await CargoRepo.UpdateAsync(cargo);
            successMessage = $"Cargo '{cargo.Nombre}' reactivado";
            await LoadData();
            _ = ClearSuccessMessage();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reactivando cargo: {ex.Message}");
        }
    }

    // === UTILIDADES ===

    private async Task ClearSuccessMessage()
    {
        await Task.Delay(4000);
        successMessage = null;
        StateHasChanged();
    }
}
