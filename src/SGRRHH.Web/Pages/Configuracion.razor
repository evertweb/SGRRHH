@page "/configuracion"
@using SGRRHH.Core.Models
@using SGRRHH.Core.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using SGRRHH.Web.Client
@inject AppStateService AppState
@inject FirebaseJsInterop Firebase
@inject IJSRuntime JSRuntime

<div class="page-content">
    <div class="page-header">
        <h3>Configuracion de Empresa</h3>
    </div>

    @if (!AppState.IsAdmin)
    {
        <div class="legacy-alert legacy-alert-error" style="margin: 20px;">
            Acceso denegado. Solo administradores pueden acceder a esta pagina.
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="legacy-alert legacy-alert-success">
                @successMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="legacy-alert legacy-alert-error">
                @errorMessage
            </div>
        }

        @if (isLoading)
        {
            <div class="loading-indicator">Cargando configuracion...</div>
        }
        else
        {
            <fieldset class="legacy-groupbox">
                <legend>Informacion de la Empresa</legend>

                <div class="form-container">
                    <div class="legacy-form-row">
                        <div class="legacy-form-group" style="flex: 2;">
                            <label class="legacy-form-label required">Nombre de la Empresa</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.Nombre" />
                        </div>
                        <div class="legacy-form-group" style="flex: 1;">
                            <label class="legacy-form-label required">NIT</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.Nit" />
                        </div>
                    </div>

                    <div class="legacy-form-row">
                        <div class="legacy-form-group" style="flex: 2;">
                            <label class="legacy-form-label">Direccion</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.Direccion" />
                        </div>
                        <div class="legacy-form-group" style="flex: 1;">
                            <label class="legacy-form-label">Ciudad</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.Ciudad" />
                        </div>
                    </div>

                    <div class="legacy-form-row">
                        <div class="legacy-form-group" style="flex: 1;">
                            <label class="legacy-form-label">Telefono</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.Telefono" />
                        </div>
                        <div class="legacy-form-group" style="flex: 1;">
                            <label class="legacy-form-label">Correo</label>
                            <input type="email" class="legacy-form-input" @bind="companyInfo.Correo" />
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="legacy-groupbox" style="margin-top: 15px;">
                <legend>Representante Legal</legend>

                <div class="form-container">
                    <div class="legacy-form-row">
                        <div class="legacy-form-group" style="flex: 2;">
                            <label class="legacy-form-label">Nombre del Representante</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.RepresentanteNombre" />
                        </div>
                        <div class="legacy-form-group" style="flex: 1;">
                            <label class="legacy-form-label">Cargo</label>
                            <input type="text" class="legacy-form-input" @bind="companyInfo.RepresentanteCargo" />
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="legacy-groupbox" style="margin-top: 15px;">
                <legend>Logo de la Empresa</legend>

                <div class="form-container">
                    @if (isUploadingLogo)
                    {
                        <div style="color: #555; font-style: italic;">Subiendo logo...</div>
                    }
                    else if (!string.IsNullOrEmpty(logoUrl))
                    {
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <img src="@logoUrl" alt="Logo" style="max-width: 150px; max-height: 80px; border: 1px solid #ccc;" />
                            <div>
                                <button type="button" class="legacy-button-small legacy-button-danger" @onclick="RemoverLogo">Quitar Logo</button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div>
                            <InputFile OnChange="HandleLogoSelected" accept="image/*" class="legacy-form-input" />
                            <div class="legacy-form-hint">Formatos: PNG, JPG. Maximo 2MB.</div>
                        </div>
                    }
                </div>
            </fieldset>

            <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-top: 1px solid #808080;">
                <button class="legacy-button legacy-button-primary" @onclick="GuardarConfiguracion" disabled="@isSaving">
                    @(isSaving ? "Guardando..." : "Guardar Configuracion")
                </button>
            </div>
        }
    }
</div>

@code {
    private CompanyInfo companyInfo = new();
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isUploadingLogo = false;
    private string? successMessage;
    private string? errorMessage;
    private string? logoUrl;
    private string? logoPath;
    private string? pendingLogoBase64;
    private string? pendingLogoContentType;

    private const string CONFIG_COLLECTION = "configuracion";
    private const string COMPANY_DOC = "empresa";

    protected override async Task OnInitializedAsync()
    {
        AppState.SetViewTitle("Configuracion");
        if (AppState.IsAdmin)
        {
            await LoadConfiguracion();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadConfiguracion()
    {
        isLoading = true;
        try
        {
            var data = await Firebase.GetDocumentAsync<CompanyInfoDto>(CONFIG_COLLECTION, COMPANY_DOC);
            if (data != null)
            {
                companyInfo = new CompanyInfo
                {
                    Nombre = data.Nombre ?? "Empresa SGRRHH",
                    Nit = data.Nit ?? "",
                    Direccion = data.Direccion ?? "",
                    Ciudad = data.Ciudad ?? "",
                    Telefono = data.Telefono ?? "",
                    Correo = data.Correo ?? "",
                    RepresentanteNombre = data.RepresentanteNombre ?? "",
                    RepresentanteCargo = data.RepresentanteCargo ?? "",
                    LogoPath = data.LogoPath
                };

                if (!string.IsNullOrEmpty(data.LogoPath))
                {
                    logoPath = data.LogoPath;
                    logoUrl = await Firebase.GetStorageUrlAsync(data.LogoPath);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando configuracion: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GuardarConfiguracion()
    {
        if (isSaving) return;

        isSaving = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            // Upload pending logo if any
            if (!string.IsNullOrEmpty(pendingLogoBase64))
            {
                var storagePath = $"config/logo_{DateTime.Now:yyyyMMddHHmmss}";
                var result = await Firebase.UploadFileBase64Async(storagePath, pendingLogoBase64, pendingLogoContentType ?? "image/png");
                if (result.Success)
                {
                    logoPath = storagePath;
                    companyInfo.LogoPath = storagePath;
                    pendingLogoBase64 = null;
                }
            }

            var dto = new CompanyInfoDto
            {
                Nombre = companyInfo.Nombre,
                Nit = companyInfo.Nit,
                Direccion = companyInfo.Direccion,
                Ciudad = companyInfo.Ciudad,
                Telefono = companyInfo.Telefono,
                Correo = companyInfo.Correo,
                RepresentanteNombre = companyInfo.RepresentanteNombre,
                RepresentanteCargo = companyInfo.RepresentanteCargo,
                LogoPath = logoPath
            };

            await Firebase.SetDocumentAsync(CONFIG_COLLECTION, COMPANY_DOC, dto);
            successMessage = "Configuracion guardada exitosamente";
            _ = ClearSuccessMessage();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error guardando: {ex.Message}";
            Console.WriteLine($"Error guardando configuracion: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleLogoSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            errorMessage = "Solo se permiten archivos de imagen";
            return;
        }

        if (file.Size > 2 * 1024 * 1024)
        {
            errorMessage = "El logo no puede superar 2MB";
            return;
        }

        isUploadingLogo = true;
        try
        {
            using var stream = file.OpenReadStream(2 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            pendingLogoBase64 = Convert.ToBase64String(ms.ToArray());
            pendingLogoContentType = file.ContentType;

            // Show preview
            logoUrl = $"data:{file.ContentType};base64,{pendingLogoBase64}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error leyendo imagen: {ex.Message}";
        }
        finally
        {
            isUploadingLogo = false;
        }
    }

    private void RemoverLogo()
    {
        logoUrl = null;
        logoPath = null;
        pendingLogoBase64 = null;
        companyInfo.LogoPath = null;
    }

    private async Task ClearSuccessMessage()
    {
        await Task.Delay(4000);
        successMessage = null;
        StateHasChanged();
    }

    // DTO for Firestore serialization
    private class CompanyInfoDto
    {
        [System.Text.Json.Serialization.JsonPropertyName("nombre")]
        public string? Nombre { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("nit")]
        public string? Nit { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("direccion")]
        public string? Direccion { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("ciudad")]
        public string? Ciudad { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("telefono")]
        public string? Telefono { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("correo")]
        public string? Correo { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("representanteNombre")]
        public string? RepresentanteNombre { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("representanteCargo")]
        public string? RepresentanteCargo { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("logoPath")]
        public string? LogoPath { get; set; }
    }
}
