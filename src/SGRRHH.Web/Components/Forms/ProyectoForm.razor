@* Formulario de Proyecto - Crear/Editar *@
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Interfaces

<div class="proyecto-form">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="legacy-alert legacy-alert-error">
            @errorMessage
        </div>
    }

    @* Fila 1: Código y Nombre *@
    <div class="legacy-form-row">
        <div class="legacy-form-group" style="width: 120px;">
            <label class="legacy-form-label">Código</label>
            <input type="text"
                   class="legacy-form-input"
                   value="@proyecto.Codigo"
                   readonly
                   disabled />
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label required">Nombre</label>
            <input type="text"
                   class="legacy-form-input"
                   @bind="proyecto.Nombre"
                   @bind:event="oninput"
                   maxlength="200"
                   placeholder="Nombre del proyecto" />
            @if (!string.IsNullOrEmpty(nombreError))
            {
                <div class="legacy-validation-error">@nombreError</div>
            }
        </div>
    </div>

    @* Fila 2: Cliente y Ubicación *@
    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Cliente</label>
            <input type="text"
                   class="legacy-form-input"
                   @bind="proyecto.Cliente"
                   @bind:event="oninput"
                   maxlength="200"
                   placeholder="Cliente o entidad del proyecto" />
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Ubicación</label>
            <input type="text"
                   class="legacy-form-input"
                   @bind="proyecto.Ubicacion"
                   @bind:event="oninput"
                   maxlength="200"
                   placeholder="Lugar donde se realiza el proyecto" />
        </div>
    </div>

    @* Fila 3: Descripción *@
    <div class="legacy-form-group">
        <label class="legacy-form-label">Descripción</label>
        <textarea class="legacy-form-textarea"
                  @bind="proyecto.Descripcion"
                  rows="3"
                  placeholder="Descripción detallada del proyecto"></textarea>
    </div>

    @* Fila 4: Fechas y Estado *@
    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Fecha Inicio</label>
            <input type="date"
                   class="legacy-form-input"
                   value="@FormatDate(proyecto.FechaInicio)"
                   @onchange="e => proyecto.FechaInicio = ParseDate(e.Value?.ToString())" />
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Fecha Fin</label>
            <input type="date"
                   class="legacy-form-input"
                   value="@FormatDate(proyecto.FechaFin)"
                   @onchange="e => proyecto.FechaFin = ParseDate(e.Value?.ToString())" />
            @if (!string.IsNullOrEmpty(fechaError))
            {
                <div class="legacy-validation-error">@fechaError</div>
            }
        </div>

        <div class="legacy-form-group" style="width: 140px;">
            <label class="legacy-form-label">Estado</label>
            <select class="legacy-form-input" @bind="proyecto.Estado">
                <option value="@EstadoProyecto.Activo">Activo</option>
                <option value="@EstadoProyecto.Suspendido">Suspendido</option>
                <option value="@EstadoProyecto.Finalizado">Finalizado</option>
                <option value="@EstadoProyecto.Cancelado">Cancelado</option>
            </select>
        </div>
    </div>

    @* Fila 5: Responsable, Presupuesto y Progreso *@
    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Responsable</label>
            <select class="legacy-form-input" @bind="proyecto.ResponsableId">
                <option value="">-- Sin asignar --</option>
                @foreach (var emp in empleados)
                {
                    <option value="@emp.Id">@emp.NombreCompleto</option>
                }
            </select>
        </div>

        <div class="legacy-form-group" style="width: 150px;">
            <label class="legacy-form-label">Presupuesto</label>
            <input type="number"
                   class="legacy-form-input"
                   step="0.01"
                   min="0"
                   @bind="proyecto.Presupuesto"
                   placeholder="0.00" />
        </div>

        <div class="legacy-form-group" style="width: 120px;">
            <label class="legacy-form-label">Progreso %</label>
            <input type="number"
                   class="legacy-form-input"
                   min="0"
                   max="100"
                   @bind="proyecto.Progreso" />
        </div>
    </div>

    @* Barra de progreso visual *@
    @if (proyecto.Progreso > 0)
    {
        <div class="progress-container">
            <div class="progress-bar" style="width: @(proyecto.Progreso)%"></div>
            <span class="progress-text">@proyecto.Progreso%</span>
        </div>
    }
</div>


@code {

    [Parameter]
    public Proyecto? ProyectoEdit { get; set; }

    [Parameter]
    public EventCallback<Proyecto> OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Inject]
    public IProyectoRepository ProyectoRepo { get; set; } = default!;

    [Inject]
    public IEmpleadoRepository EmpleadoRepo { get; set; } = default!;

    private Proyecto proyecto = new();
    private List<Empleado> empleados = new();
    private bool isEditing = false;
    private string? errorMessage;
    private string? nombreError;
    private string? fechaError;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        // Cargar lista de empleados activos para el selector de responsable
        try
        {
            var emps = await EmpleadoRepo.GetAllActiveAsync();
            empleados = emps.OrderBy(e => e.NombreCompleto).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar empleados: {ex.Message}");
        }

        if (ProyectoEdit != null)
        {
            isEditing = true;
            proyecto = new Proyecto
            {
                Id = ProyectoEdit.Id,
                Codigo = ProyectoEdit.Codigo,
                Nombre = ProyectoEdit.Nombre,
                Descripcion = ProyectoEdit.Descripcion,
                Cliente = ProyectoEdit.Cliente,
                Ubicacion = ProyectoEdit.Ubicacion,
                Presupuesto = ProyectoEdit.Presupuesto,
                Progreso = ProyectoEdit.Progreso,
                ResponsableId = ProyectoEdit.ResponsableId,
                FechaInicio = ProyectoEdit.FechaInicio,
                FechaFin = ProyectoEdit.FechaFin,
                Estado = ProyectoEdit.Estado,
                Activo = ProyectoEdit.Activo,
                FechaCreacion = ProyectoEdit.FechaCreacion
            };
            proyecto.SetFirestoreDocumentId(ProyectoEdit.GetFirestoreDocumentId() ?? "");
        }
        else
        {
            isEditing = false;
            proyecto = new Proyecto
            {
                Activo = true,
                Estado = EstadoProyecto.Activo,
                FechaInicio = DateTime.Today,
                Progreso = 0
            };
            try
            {
                proyecto.Codigo = await ProyectoRepo.GetNextCodigoAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al generar código: {ex.Message}");
                proyecto.Codigo = "PRY-????";
            }
        }
    }

    private string FormatDate(DateTime? date) => date?.ToString("yyyy-MM-dd") ?? "";

    private DateTime? ParseDate(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return DateTime.TryParse(value, out var date) ? date : null;
    }

    public async Task<bool> ValidateAndSaveAsync()
    {
        if (isSaving) return false;

        isSaving = true;
        errorMessage = null;
        nombreError = null;
        fechaError = null;

        try
        {
            if (string.IsNullOrWhiteSpace(proyecto.Nombre))
            {
                nombreError = "El nombre es requerido";
                return false;
            }

            // Validar fechas
            if (proyecto.FechaInicio.HasValue && proyecto.FechaFin.HasValue)
            {
                if (proyecto.FechaFin < proyecto.FechaInicio)
                {
                    fechaError = "La fecha fin no puede ser anterior a la fecha inicio";
                    return false;
                }
            }

            // Validar progreso
            if (proyecto.Progreso < 0) proyecto.Progreso = 0;
            if (proyecto.Progreso > 100) proyecto.Progreso = 100;

            // Si el progreso es 100% y está activo, sugerir finalizar
            if (proyecto.Progreso == 100 && proyecto.Estado == EstadoProyecto.Activo)
            {
                // No cambiamos automáticamente, solo es informativo
            }

            if (isEditing)
            {
                await ProyectoRepo.UpdateAsync(proyecto);
            }
            else
            {
                await ProyectoRepo.AddAsync(proyecto);
            }

            await OnSave.InvokeAsync(proyecto);
            return true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"Error guardando proyecto: {ex}");
            return false;
        }
        finally
        {
            isSaving = false;
        }
    }

    public bool IsSaving => isSaving;
}
