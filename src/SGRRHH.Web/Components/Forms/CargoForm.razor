@* Formulario de Cargo - Crear/Editar con todas las funcionalidades *@
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Interfaces

<div class="cargo-form">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="legacy-alert legacy-alert-error">
            @errorMessage
        </div>
    }

    <div class="legacy-form-row">
        <div class="legacy-form-group" style="width: 120px;">
            <label class="legacy-form-label">Codigo</label>
            <input type="text"
                   class="legacy-form-input"
                   value="@cargo.Codigo"
                   readonly
                   disabled />
            <div class="legacy-form-hint">Auto-generado</div>
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label required">Nombre</label>
            <input type="text"
                   class="legacy-form-input"
                   @bind="cargo.Nombre"
                   @bind:event="oninput"
                   maxlength="100"
                   placeholder="Nombre del cargo" />
            @if (!string.IsNullOrEmpty(nombreError))
            {
                <div class="legacy-validation-error">@nombreError</div>
            }
        </div>
    </div>

    <div class="legacy-form-group">
        <label class="legacy-form-label">Descripcion</label>
        <textarea class="legacy-form-textarea"
                  @bind="cargo.Descripcion"
                  rows="2"
                  placeholder="Funciones y responsabilidades del cargo"></textarea>
    </div>

    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Departamento</label>
            <select class="legacy-form-input" @bind="cargo.DepartamentoId">
                <option value="">-- Sin departamento --</option>
                @foreach (var dept in departamentos ?? Enumerable.Empty<Departamento>())
                {
                    <option value="@dept.Id">@dept.Nombre</option>
                }
            </select>
        </div>

        <div class="legacy-form-group" style="width: 100px;">
            <label class="legacy-form-label">Nivel</label>
            <input type="number"
                   class="legacy-form-input"
                   @bind="cargo.Nivel"
                   min="1"
                   max="10" />
            <div class="legacy-form-hint">1 = mas alto</div>
        </div>

        <div class="legacy-form-group" style="width: 100px;">
            <label class="legacy-form-label">Plazas</label>
            <input type="number"
                   class="legacy-form-input"
                   @bind="cargo.NumeroPlazas"
                   min="1"
                   max="999" />
            <div class="legacy-form-hint">Vacantes</div>
        </div>
    </div>

    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Cargo Superior</label>
            <select class="legacy-form-input" @bind="cargo.CargoSuperiorId">
                <option value="">-- Sin cargo superior --</option>
                @foreach (var c in cargosDisponibles ?? Enumerable.Empty<Cargo>())
                {
                    @if (c.Id != cargo.Id) // Excluir el cargo actual
                    {
                        <option value="@c.Id">@c.Nombre (@c.Codigo)</option>
                    }
                }
            </select>
            <div class="legacy-form-hint">Cargo al que reporta</div>
        </div>

        <div class="legacy-form-group" style="width: 180px;">
            <label class="legacy-form-label">Salario Base</label>
            <input type="number"
                   class="legacy-form-input"
                   @bind="cargo.SalarioBase"
                   step="0.01"
                   min="0"
                   placeholder="0.00" />
            <div class="legacy-form-hint">Opcional (COP)</div>
        </div>
    </div>

    <div class="legacy-form-group">
        <label class="legacy-form-label">Requisitos Minimos</label>
        <textarea class="legacy-form-textarea"
                  @bind="cargo.Requisitos"
                  rows="2"
                  placeholder="Educacion, experiencia, certificaciones..."></textarea>
    </div>

    <div class="legacy-form-group">
        <label class="legacy-form-label">Competencias / Habilidades</label>
        <textarea class="legacy-form-textarea"
                  @bind="cargo.Competencias"
                  rows="2"
                  placeholder="Liderazgo, trabajo en equipo, manejo de Excel..."></textarea>
    </div>

    <div class="legacy-form-group">
        <label class="legacy-form-checkbox">
            <input type="checkbox" @bind="cargo.Activo" />
            <span>Activo</span>
        </label>
    </div>
</div>


@code {

    /// <summary>
    /// Cargo a editar (null = nuevo)
    /// </summary>
    [Parameter]
    public Cargo? CargoEdit { get; set; }

    /// <summary>
    /// Callback cuando se guarda exitosamente
    /// </summary>
    [Parameter]
    public EventCallback<Cargo> OnSave { get; set; }

    /// <summary>
    /// Callback cuando se cancela
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Repositorio de cargos
    /// </summary>
    [Inject]
    public ICargoRepository CargoRepo { get; set; } = default!;

    /// <summary>
    /// Repositorio de departamentos para el dropdown
    /// </summary>
    [Inject]
    public IDepartamentoRepository DepartamentoRepo { get; set; } = default!;

    private Cargo cargo = new();
    private IEnumerable<Departamento>? departamentos;
    private IEnumerable<Cargo>? cargosDisponibles;
    private bool isEditing = false;
    private string? errorMessage;
    private string? nombreError;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        // Cargar departamentos y cargos para los dropdowns
        try
        {
            departamentos = await DepartamentoRepo.GetAllActiveAsync();
            cargosDisponibles = await CargoRepo.GetAllActiveAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
            departamentos = Enumerable.Empty<Departamento>();
            cargosDisponibles = Enumerable.Empty<Cargo>();
        }

        if (CargoEdit != null)
        {
            // Modo edicion - clonar para no modificar original
            isEditing = true;
            cargo = new Cargo
            {
                Id = CargoEdit.Id,
                Codigo = CargoEdit.Codigo,
                Nombre = CargoEdit.Nombre,
                Descripcion = CargoEdit.Descripcion,
                Nivel = CargoEdit.Nivel,
                DepartamentoId = CargoEdit.DepartamentoId,
                Activo = CargoEdit.Activo,
                FechaCreacion = CargoEdit.FechaCreacion,
                // Nuevos campos
                SalarioBase = CargoEdit.SalarioBase,
                Requisitos = CargoEdit.Requisitos,
                Competencias = CargoEdit.Competencias,
                CargoSuperiorId = CargoEdit.CargoSuperiorId,
                NumeroPlazas = CargoEdit.NumeroPlazas
            };
            cargo.SetFirestoreDocumentId(CargoEdit.GetFirestoreDocumentId() ?? "");
        }
        else
        {
            // Modo creacion - generar codigo
            isEditing = false;
            cargo = new Cargo { Activo = true, Nivel = 5, NumeroPlazas = 1 };
            try
            {
                cargo.Codigo = await CargoRepo.GetNextCodigoAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al generar codigo: {ex.Message}");
                cargo.Codigo = "CAR???";
            }
        }
    }

    /// <summary>
    /// Valida y guarda el cargo
    /// </summary>
    public async Task<bool> ValidateAndSaveAsync()
    {
        if (isSaving) return false;

        isSaving = true;
        errorMessage = null;
        nombreError = null;

        try
        {
            // Validar nombre requerido
            if (string.IsNullOrWhiteSpace(cargo.Nombre))
            {
                nombreError = "El nombre es requerido";
                return false;
            }

            // Validar longitud minima del nombre
            if (cargo.Nombre.Trim().Length < 3)
            {
                nombreError = "El nombre debe tener al menos 3 caracteres";
                return false;
            }

            // Validar nombre unico en el departamento
            var existeNombre = await CargoRepo.ExistsNombreInDepartamentoAsync(
                cargo.Nombre,
                cargo.DepartamentoId,
                isEditing ? cargo.Id : null);

            if (existeNombre)
            {
                nombreError = "Ya existe un cargo con este nombre en el departamento";
                return false;
            }

            // Validar nivel
            if (cargo.Nivel < 1 || cargo.Nivel > 10)
            {
                errorMessage = "El nivel debe estar entre 1 y 10";
                return false;
            }

            // Validar numero de plazas
            if (cargo.NumeroPlazas < 1)
            {
                errorMessage = "Debe haber al menos 1 plaza";
                cargo.NumeroPlazas = 1;
            }

            // Validar salario base positivo si se especifica
            if (cargo.SalarioBase.HasValue && cargo.SalarioBase.Value < 0)
            {
                errorMessage = "El salario base no puede ser negativo";
                return false;
            }

            // Validar que no se reporte a si mismo
            if (cargo.CargoSuperiorId.HasValue && cargo.CargoSuperiorId.Value == cargo.Id)
            {
                errorMessage = "Un cargo no puede reportar a si mismo";
                return false;
            }

            // Guardar
            if (isEditing)
            {
                await CargoRepo.UpdateAsync(cargo);
            }
            else
            {
                await CargoRepo.AddAsync(cargo);
            }

            await OnSave.InvokeAsync(cargo);
            return true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"Error guardando cargo: {ex}");
            return false;
        }
        finally
        {
            isSaving = false;
        }
    }

    /// <summary>
    /// Indica si el formulario esta en proceso de guardado
    /// </summary>
    public bool IsSaving => isSaving;
}
