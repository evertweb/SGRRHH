@* Formulario de Permiso - Crear/Editar *@
@* Versi칩n mejorada con paridad de funcionalidades con WPF *@
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Enums
@using SGRRHH.Core.Interfaces
@using Microsoft.AspNetCore.Components.Forms

<div class="permiso-form">
    @* Loading Overlay *@
    @if (isLoading || isSaving)
    {
        <div class="loading-overlay">
            <div class="loading-box">
                <div class="loading-spinner"></div>
                <span>@(isSaving ? "Guardando..." : "Cargando...")</span>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="legacy-alert legacy-alert-error">
            @errorMessage
        </div>
    }

    @* Empleado con b칰squeda *@
    <div class="legacy-form-group">
        <label class="legacy-form-label required">Empleado</label>
        <div class="search-select-container">
            <input id="permiso-empleado-search" type="text"
                   class="legacy-form-input"
                   placeholder="Buscar empleado..."
                   @bind="empleadoSearchText"
                   @bind:event="oninput"
                   @onfocus="() => showEmpleadoDropdown = true"
                   disabled="@isEditing" />
            @if (showEmpleadoDropdown && !isEditing && filteredEmpleados.Any())
            {
                <div class="search-dropdown">
                    @foreach (var emp in filteredEmpleados.Take(10))
                    {
                        <div class="search-dropdown-item" @onclick="() => SelectEmpleado(emp)">
                            <span class="emp-codigo">@emp.Codigo</span>
                            <span class="emp-nombre">@emp.NombreCompleto</span>
                        </div>
                    }
                </div>
            }
        </div>
        @if (selectedEmpleado != null)
        {
            <div class="selected-badge">
                <span>@selectedEmpleado.Codigo - @selectedEmpleado.NombreCompleto</span>
                @if (!isEditing)
                {
                    <button type="button" class="badge-remove" @onclick="ClearEmpleado">칑</button>
                }
            </div>
        }
        @if (!string.IsNullOrEmpty(empleadoError))
        {
            <div class="legacy-validation-error">@empleadoError</div>
        }
    </div>

    @* Tipo de Permiso *@
    <div class="legacy-form-group">
        <label class="legacy-form-label required">Tipo de Permiso</label>
        <select class="legacy-form-input" @bind="permiso.TipoPermisoId" @bind:after="OnTipoPermisoChanged">
            <option value="0">-- Seleccione tipo --</option>
            @foreach (var tipo in tiposPermiso ?? Enumerable.Empty<TipoPermiso>())
            {
                <option value="@tipo.Id">@tipo.Nombre</option>
            }
        </select>
        @if (!string.IsNullOrEmpty(tipoPermisoError))
        {
            <div class="legacy-validation-error">@tipoPermisoError</div>
        }
    </div>

    @* Panel de informaci칩n del tipo de permiso (mejorado) *@
    @if (selectedTipoPermiso != null)
    {
        <div class="tipo-info-panel" style="border-left: 4px solid @selectedTipoPermiso.Color;">
            <div class="tipo-info-header" style="background-color: @selectedTipoPermiso.Color;">
                @selectedTipoPermiso.Nombre
            </div>
            @if (!string.IsNullOrEmpty(selectedTipoPermiso.Descripcion))
            {
                <p class="tipo-descripcion">@selectedTipoPermiso.Descripcion</p>
            }
            <div class="tipo-info-badges">
                @if (selectedTipoPermiso.RequiereAprobacion)
                {
                    <span class="info-badge badge-warning">Requiere aprobaci칩n</span>
                }
                @if (selectedTipoPermiso.RequiereDocumento)
                {
                    <span class="info-badge badge-danger">Requiere documento</span>
                }
                @if (selectedTipoPermiso.EsCompensable)
                {
                    <span class="info-badge badge-info">Compensable</span>
                }
                @if (selectedTipoPermiso.DiasPorDefecto > 0)
                {
                    <span class="info-badge badge-neutral">@selectedTipoPermiso.DiasPorDefecto d칤as por defecto</span>
                }
            </div>
        </div>
    }

    @* Fechas *@
    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label required">Fecha Inicio</label>
            <input id="permiso-fechaInicio" type="date" class="legacy-form-input"
                   value="@FormatDate(permiso.FechaInicio)"
                   min="@(isEditing ? "" : FormatDate(DateTime.Today))"
                   @onchange="OnFechaInicioChanged" />
            @if (!string.IsNullOrEmpty(fechaInicioError))
            {
                <div class="legacy-validation-error">@fechaInicioError</div>
            }
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label required">Fecha Fin</label>
            <input id="permiso-fechaFin" type="date" class="legacy-form-input"
                   value="@FormatDate(permiso.FechaFin)"
                   min="@FormatDate(permiso.FechaInicio)"
                   @onchange="e => { OnFechaFinChanged(e); fechaFinTouched = true; }" />
            @if (!string.IsNullOrEmpty(fechaFinError))
            {
                <div class="legacy-validation-error">@fechaFinError</div>
            }
        </div>

        <div class="legacy-form-group" style="width: 100px;">
            <label class="legacy-form-label">Total D칤as</label>
            <div class="days-display-box @(permiso.TotalDias > 30 ? "days-warning" : "")">
                @permiso.TotalDias
            </div>
            @if (permiso.TotalDias > 30)
            {
                <div class="legacy-validation-error">M치x. 30 d칤as</div>
            }
            @if (suggestedFechaFin.HasValue && !fechaFinTouched)
            {
                <div style="margin-top:6px;">
                    <small class="legacy-form-hint">Sugerencia (seg칰n tipo): @suggestedFechaFin.Value.ToString("dd/MM/yyyy")</small>
                    <button type="button" class="legacy-button-small" style="margin-left:8px;" @onclick="() => { permiso.FechaFin = suggestedFechaFin.Value; fechaFinTouched = true; CalculateDays(); suggestedFechaFin = null; }">Aplicar</button>
                </div>
            }
        </div>
    </div>

    @* Motivo *@
    <div class="legacy-form-group">
        <label class="legacy-form-label required">Motivo / Justificaci칩n</label>
        <textarea id="permiso-motivo" class="legacy-form-textarea @(!string.IsNullOrEmpty(motivoError) ? "input-error" : "")"
                  @bind="permiso.Motivo"
                  rows="3"
                  placeholder="Describa el motivo del permiso (m칤nimo 10 caracteres)"
                  maxlength="500"></textarea>
        <div class="char-counter">@((permiso.Motivo?.Length ?? 0))/500</div>
        @if (!string.IsNullOrEmpty(motivoError))
        {
            <div class="legacy-validation-error">@motivoError</div>
        }
    </div>

    @* Observaciones *@
    <div class="legacy-form-group">
        <label class="legacy-form-label">Observaciones (opcional)</label>
        <textarea class="legacy-form-textarea"
                  @bind="permiso.Observaciones"
                  rows="2"
                  placeholder="Observaciones adicionales"
                  maxlength="500"></textarea>
        <div class="char-counter">@((permiso.Observaciones?.Length ?? 0))/500</div>
    </div>

    @* Documento Soporte *@
    <fieldset class="legacy-fieldset">
        <legend>
            Documento Soporte
            @if (selectedTipoPermiso?.RequiereDocumento == true)
            {
                <span class="required-indicator">*</span>
            }
        </legend>

        <div class="document-upload-area">
            @if (string.IsNullOrEmpty(documentoUrl) && string.IsNullOrEmpty(documentoFileName))
            {
                <InputFile OnChange="OnDocumentoSelected" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                <p class="upload-hint">Formatos: PDF, JPG, PNG, DOC, DOCX (m치x. 5MB)</p>
            }
            else
            {
                <div class="document-preview">
                    <span class="doc-icon">游늯</span>
                    <span class="doc-name">@documentoFileName</span>
                    @if (!string.IsNullOrEmpty(documentoUrl))
                    {
                        <a href="@documentoUrl" target="_blank" class="doc-link">Ver</a>
                    }
                    <button type="button" class="doc-remove" @onclick="RemoveDocumento">칑</button>
                </div>
            }
            @if (isUploadingDocument)
            {
                <div class="upload-progress">
                    <div class="progress-bar"></div>
                    <span>Subiendo documento...</span>
                </div>
            }
        </div>
        @if (!string.IsNullOrEmpty(documentoError))
        {
            <div class="legacy-validation-error">@documentoError</div>
        }
    </fieldset>

    @* Fecha de Compensaci칩n (condicional) *@
    @if (selectedTipoPermiso?.EsCompensable == true)
    {
        <fieldset class="legacy-fieldset fieldset-warning">
            <legend>Compensaci칩n</legend>
            <div class="compensacion-warning">
                <span class="warning-icon">丘멆잺</span>
                <span>Este tipo de permiso es compensable. El tiempo debe ser repuesto.</span>
            </div>
            <div class="legacy-form-group">
                <label class="legacy-form-label required">Fecha de Compensaci칩n</label>
                <input type="date" class="legacy-form-input"
                       value="@FormatDateNullable(permiso.FechaCompensacion)"
                       min="@FormatDate(DateTime.Today)"
                       @onchange="OnFechaCompensacionChanged" />
                @if (!string.IsNullOrEmpty(compensacionError))
                {
                    <div class="legacy-validation-error">@compensacionError</div>
                }
            </div>
        </fieldset>
    }

    @* Informaci칩n de Respuesta (solo en edici칩n cuando no est치 pendiente) *@
    @if (isEditing && permiso.Estado != EstadoPermiso.Pendiente)
    {
        <fieldset class="legacy-fieldset">
            <legend>Informaci칩n de Respuesta</legend>
            <div class="legacy-form-row">
                <div class="legacy-form-group" style="flex: 1;">
                    <label class="legacy-form-label">Estado</label>
                    <span class="status-badge @GetStatusClass(permiso.Estado)">
                        @GetEstadoLabel(permiso.Estado)
                    </span>
                </div>
                @if (permiso.FechaAprobacion.HasValue)
                {
                    <div class="legacy-form-group" style="flex: 1;">
                        <label class="legacy-form-label">Fecha Respuesta</label>
                        <span>@permiso.FechaAprobacion?.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                }
            </div>
            @if (!string.IsNullOrEmpty(permiso.MotivoRechazo))
            {
                <div class="legacy-form-group">
                    <label class="legacy-form-label">Motivo Rechazo</label>
                    <span class="rechazo-text">@permiso.MotivoRechazo</span>
                </div>
            }
        </fieldset>
    }
</div>

@code {
    [Parameter]
    public Permiso? PermisoEdit { get; set; }

    [Parameter]
    public EventCallback<Permiso> OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Inject]
    public IPermisoService PermisoService { get; set; } = default!;

    [Inject]
    public IEmpleadoRepository EmpleadoRepo { get; set; } = default!;

    [Inject]
    public ITipoPermisoRepository TipoPermisoRepo { get; set; } = default!;

    [Inject]
    public IDateCalculationService DateCalculationService { get; set; } = default!;

    [Inject]
    public AppStateService AppState { get; set; } = default!;

    [Inject]
    public SGRRHH.Web.Client.FirebaseJsInterop FirebaseJs { get; set; } = default!;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    // Data
    private Permiso permiso = new();
    private IEnumerable<Empleado>? empleados;
    private IEnumerable<TipoPermiso>? tiposPermiso;
    private TipoPermiso? selectedTipoPermiso;
    private Empleado? selectedEmpleado;

    // Estado
    private bool isEditing = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isUploadingDocument = false;

    // Suggested date (do not override user input silently)
    private DateTime? suggestedFechaFin;
    private bool fechaFinTouched = false;

    // B칰squeda de empleado
    private string empleadoSearchText = "";
    private bool showEmpleadoDropdown = false;
    private IEnumerable<Empleado> filteredEmpleados =>
        (empleados ?? Enumerable.Empty<Empleado>())
        .Where(e => string.IsNullOrEmpty(empleadoSearchText) ||
                    e.NombreCompleto.Contains(empleadoSearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Codigo?.Contains(empleadoSearchText, StringComparison.OrdinalIgnoreCase) ?? false));

    // Documento
    private string? documentoUrl;
    private string? documentoFileName;
    private string? documentoStoragePath;
    private byte[]? pendingDocumentBytes;
    private string? pendingDocumentContentType;

    // Errores de validaci칩n
    private string? errorMessage;
    private string? empleadoError;
    private string? tipoPermisoError;
    private string? fechaInicioError;
    private string? fechaFinError;
    private string? motivoError;
    private string? documentoError;
    private string? compensacionError;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            empleados = await EmpleadoRepo.GetAllActiveAsync();
            tiposPermiso = await TipoPermisoRepo.GetActivosAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error cargando datos: {ex.Message}";
            Console.WriteLine($"Error cargando cat치logos: {ex.Message}");
        }

        if (PermisoEdit != null)
        {
            isEditing = true;
            permiso = new Permiso
            {
                Id = PermisoEdit.Id,
                NumeroActa = PermisoEdit.NumeroActa,
                EmpleadoId = PermisoEdit.EmpleadoId,
                TipoPermisoId = PermisoEdit.TipoPermisoId,
                FechaInicio = PermisoEdit.FechaInicio,
                FechaFin = PermisoEdit.FechaFin,
                TotalDias = PermisoEdit.TotalDias,
                Motivo = PermisoEdit.Motivo,
                Observaciones = PermisoEdit.Observaciones,
                Estado = PermisoEdit.Estado,
                FechaSolicitud = PermisoEdit.FechaSolicitud,
                FechaAprobacion = PermisoEdit.FechaAprobacion,
                AprobadoPorId = PermisoEdit.AprobadoPorId,
                MotivoRechazo = PermisoEdit.MotivoRechazo,
                DocumentoSoportePath = PermisoEdit.DocumentoSoportePath,
                FechaCompensacion = PermisoEdit.FechaCompensacion,
                DiasPendientesCompensacion = PermisoEdit.DiasPendientesCompensacion,
                Activo = PermisoEdit.Activo,
                FechaCreacion = PermisoEdit.FechaCreacion
            };
            permiso.SetFirestoreDocumentId(PermisoEdit.GetFirestoreDocumentId() ?? "");

            // Set selected tipo y empleado
            selectedTipoPermiso = tiposPermiso?.FirstOrDefault(t => t.Id == permiso.TipoPermisoId);
            selectedEmpleado = empleados?.FirstOrDefault(e => e.Id == permiso.EmpleadoId);
            if (selectedEmpleado != null)
            {
                empleadoSearchText = selectedEmpleado.NombreCompleto;
            }

            // Cargar documento existente
            if (!string.IsNullOrEmpty(permiso.DocumentoSoportePath))
            {
                documentoStoragePath = permiso.DocumentoSoportePath;
                documentoFileName = System.IO.Path.GetFileName(permiso.DocumentoSoportePath);
                // Intentar obtener la URL
                try
                {
                    documentoUrl = await FirebaseJs.GetStorageUrlAsync(permiso.DocumentoSoportePath);
                }
                catch { /* Ignorar si no se puede obtener */ }
            }
        }
        else
        {
            isEditing = false;
            permiso = new Permiso
            {
                Activo = true,
                Estado = EstadoPermiso.Pendiente,
                FechaInicio = DateTime.Today,
                FechaFin = DateTime.Today,
                FechaSolicitud = DateTime.Now,
                TotalDias = 1
            };
        }

        isLoading = false;
    }

    private void SelectEmpleado(Empleado emp)
    {
        selectedEmpleado = emp;
        permiso.EmpleadoId = emp.Id;
        empleadoSearchText = emp.NombreCompleto;
        showEmpleadoDropdown = false;
        empleadoError = null;
    }

    private void ClearEmpleado()
    {
        selectedEmpleado = null;
        permiso.EmpleadoId = 0;
        empleadoSearchText = "";
    }

    private void OnTipoPermisoChanged()
    {
        selectedTipoPermiso = tiposPermiso?.FirstOrDefault(t => t.Id == permiso.TipoPermisoId);
        tipoPermisoError = null;

        // Compute suggestion for FechaFin if default days apply (do not overwrite user's value)
        if (selectedTipoPermiso != null && selectedTipoPermiso.DiasPorDefecto > 0 && !isEditing)
        {
            suggestedFechaFin = permiso.FechaInicio.AddDays(selectedTipoPermiso.DiasPorDefecto - 1);
            CalculateDays();
        }
        else
        {
            suggestedFechaFin = null;
        }

        // Limpiar fecha de compensaci칩n si no es compensable
        if (selectedTipoPermiso?.EsCompensable != true)
        {
            permiso.FechaCompensacion = null;
            compensacionError = null;
        }
    }

    private void OnFechaInicioChanged(ChangeEventArgs e)
    {
        permiso.FechaInicio = ParseDate(e.Value?.ToString());
        fechaInicioError = null;

        // Compute suggestion for FechaFin if a default applies
        if (!isEditing && selectedTipoPermiso != null && selectedTipoPermiso.DiasPorDefecto > 0)
        {
            suggestedFechaFin = permiso.FechaInicio.AddDays(selectedTipoPermiso.DiasPorDefecto - 1);
            // do not overwrite user's FechaFin; show suggestion
        }
        else if (permiso.FechaFin < permiso.FechaInicio)
        {
            // if user's fechaFin is invalid, reset to start date
            permiso.FechaFin = permiso.FechaInicio;
        }

        CalculateDays();
    }

    private void OnFechaFinChanged(ChangeEventArgs e)
    {
        permiso.FechaFin = ParseDate(e.Value?.ToString());
        fechaFinError = null;
        CalculateDays();
    }

    private void OnFechaCompensacionChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        permiso.FechaCompensacion = string.IsNullOrEmpty(value) ? null : ParseDate(value);
        compensacionError = null;
    }

    private void CalculateDays()
    {
        if (permiso.FechaFin >= permiso.FechaInicio)
        {
            // Usar el servicio de c치lculo de d칤as h치biles
            permiso.TotalDias = DateCalculationService.CalcularDiasHabiles(permiso.FechaInicio, permiso.FechaFin);
        }
        else
        {
            permiso.TotalDias = 0;
        }
    }

    private async Task OnDocumentoSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        // Validar tama침o (m치x 5MB)
        if (file.Size > 5 * 1024 * 1024)
        {
            documentoError = "El archivo no puede superar 5MB";
            return;
        }

        // Validar tipo
        var allowedTypes = new[] { "application/pdf", "image/jpeg", "image/png",
                                   "application/msword",
                                   "application/vnd.openxmlformats-officedocument.wordprocessingml.document" };
        if (!allowedTypes.Contains(file.ContentType))
        {
            documentoError = "Tipo de archivo no permitido";
            return;
        }

        documentoError = null;
        documentoFileName = file.Name;

        // Leer los bytes para subir despu칠s
        try
        {
            using var stream = file.OpenReadStream(5 * 1024 * 1024);
            using var ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            pendingDocumentBytes = ms.ToArray();
            pendingDocumentContentType = file.ContentType;
        }
        catch (Exception ex)
        {
            documentoError = $"Error al leer archivo: {ex.Message}";
            documentoFileName = null;
        }
    }

    private void RemoveDocumento()
    {
        documentoUrl = null;
        documentoFileName = null;
        pendingDocumentBytes = null;
        pendingDocumentContentType = null;
        // Marcar para eliminar si era existente
        if (!string.IsNullOrEmpty(documentoStoragePath))
        {
            permiso.DocumentoSoportePath = null;
        }
        documentoStoragePath = null;
    }

    private string FormatDate(DateTime date) => date.ToString("yyyy-MM-dd");
    private string FormatDateNullable(DateTime? date) => date?.ToString("yyyy-MM-dd") ?? "";

    private DateTime ParseDate(string? value)
    {
        if (DateTime.TryParse(value, out var date)) return date;
        return DateTime.Today;
    }

    private string GetEstadoLabel(EstadoPermiso estado) => estado switch
    {
        EstadoPermiso.Pendiente => "Pendiente",
        EstadoPermiso.Aprobado => "Aprobado",
        EstadoPermiso.Rechazado => "Rechazado",
        EstadoPermiso.Cancelado => "Cancelado",
        _ => "Desconocido"
    };

    private string GetStatusClass(EstadoPermiso estado) => estado switch
    {
        EstadoPermiso.Pendiente => "status-pending",
        EstadoPermiso.Aprobado => "status-active",
        EstadoPermiso.Rechazado => "status-danger",
        EstadoPermiso.Cancelado => "status-neutral",
        _ => ""
    };

    /// <summary>
    /// Valida el formulario y devuelve lista de errores
    /// </summary>
    private List<string> ValidateForm()
    {
        var errors = new List<string>();

        // Reset errores individuales
        empleadoError = null;
        tipoPermisoError = null;
        fechaInicioError = null;
        fechaFinError = null;
        motivoError = null;
        documentoError = null;
        compensacionError = null;

        // Empleado
        if (permiso.EmpleadoId <= 0 || selectedEmpleado == null)
        {
            empleadoError = "Debe seleccionar un empleado";
            errors.Add(empleadoError);
        }

        // Tipo de permiso
        if (permiso.TipoPermisoId <= 0)
        {
            tipoPermisoError = "Debe seleccionar un tipo de permiso";
            errors.Add(tipoPermisoError);
        }

        // Fechas
        if (!isEditing && permiso.FechaInicio < DateTime.Today)
        {
            fechaInicioError = "La fecha de inicio no puede ser anterior a hoy";
            errors.Add(fechaInicioError);
        }

        if (permiso.FechaFin < permiso.FechaInicio)
        {
            fechaFinError = "La fecha fin no puede ser anterior a la fecha inicio";
            errors.Add(fechaFinError);
        }

        // M치ximo 30 d칤as
        if (permiso.TotalDias > 30)
        {
            fechaFinError = "El permiso no puede exceder 30 d칤as";
            errors.Add(fechaFinError);
        }

        // Motivo
        if (string.IsNullOrWhiteSpace(permiso.Motivo))
        {
            motivoError = "Debe ingresar el motivo del permiso";
            errors.Add(motivoError);
        }
        else if (permiso.Motivo.Trim().Length < 10)
        {
            motivoError = "El motivo debe tener al menos 10 caracteres";
            errors.Add(motivoError);
        }

        // Documento soporte
        if (selectedTipoPermiso?.RequiereDocumento == true &&
            string.IsNullOrEmpty(documentoStoragePath) &&
            pendingDocumentBytes == null)
        {
            documentoError = "Este tipo de permiso requiere adjuntar un documento";
            errors.Add(documentoError);
        }

        // Fecha de compensaci칩n
        if (selectedTipoPermiso?.EsCompensable == true)
        {
            if (!permiso.FechaCompensacion.HasValue)
            {
                compensacionError = "Debe indicar la fecha de compensaci칩n";
                errors.Add(compensacionError);
            }
            else if (permiso.FechaCompensacion.Value < DateTime.Today)
            {
                compensacionError = "La fecha de compensaci칩n debe ser igual o posterior a hoy";
                errors.Add(compensacionError);
            }
        }

        // Observaciones max 500
        if (!string.IsNullOrWhiteSpace(permiso.Observaciones) && permiso.Observaciones.Length > 500)
        {
            errors.Add("Las observaciones no pueden exceder 500 caracteres");
        }

        return errors;
    }

    public async Task<bool> ValidateAndSaveAsync()
    {
        if (isSaving) return false;

        isSaving = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Validar
            var validationErrors = ValidateForm();
            if (validationErrors.Any())
            {
                errorMessage = "Por favor corrija los errores marcados";
                await FocusFirstInvalid();
                return false;
            }

            // Confirmar antes de guardar
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", "쮻esea guardar el permiso?");
            if (!ok) return false;

            // Subir documento si hay uno pendiente
            if (pendingDocumentBytes != null && !string.IsNullOrEmpty(documentoFileName))
            {
                isUploadingDocument = true;
                StateHasChanged();

                try
                {
                    // Generar path 칰nico
                    var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
                    var safeFileName = System.IO.Path.GetFileName(documentoFileName);
                    var storagePath = $"documentos/permisos/temp_{timestamp}_{safeFileName}";

                    // Convertir a Base64 y subir
                    var base64Data = Convert.ToBase64String(pendingDocumentBytes);
                    var result = await FirebaseJs.UploadFileBase64Async(storagePath, base64Data, pendingDocumentContentType!);

                    if (result.Success)
                    {
                        permiso.DocumentoSoportePath = result.FullPath;
                        documentoUrl = result.DownloadUrl;
                        documentoStoragePath = result.FullPath;
                    }
                    else
                    {
                        documentoError = $"Error al subir documento: {result.ErrorMessage}";
                        return false;
                    }
                }
                finally
                {
                    isUploadingDocument = false;
                }
            }

            // Establecer d칤as pendientes de compensaci칩n si aplica
            if (selectedTipoPermiso?.EsCompensable == true)
            {
                permiso.DiasPendientesCompensacion = permiso.TotalDias;
            }

            // Guardar
            if (isEditing)
            {
                var result = await PermisoService.UpdateAsync(permiso);
                if (!result.Success)
                {
                    errorMessage = result.Message;
                    return false;
                }
            }
            else
            {
                var result = await PermisoService.SolicitarPermisoAsync(permiso, AppState.CurrentUser?.EmpleadoId ?? 0);
                if (!result.Success)
                {
                    errorMessage = result.Message;
                    return false;
                }
                permiso = result.Data!;

                // Actualizar el path del documento con el ID real del permiso
                if (!string.IsNullOrEmpty(documentoStoragePath) && documentoStoragePath.Contains("temp_"))
                {
                    // El documento ya est치 subido, solo actualizar la referencia si es necesario
                    // En un escenario real, podr칤amos mover el archivo a una ubicaci칩n con el ID del permiso
                }
            }

            await OnSave.InvokeAsync(permiso);
            return true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"Error guardando permiso: {ex}");
            return false;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    public bool IsSaving => isSaving;

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e?.Key == "Enter" && !isSaving)
        {
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", "쮻esea guardar el permiso?");
            if (ok)
            {
                await ValidateAndSaveAsync();
            }
        }
    }

    private async Task FocusFirstInvalid()
    {
        if (!string.IsNullOrEmpty(empleadoError))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "permiso-empleado-search");
            return;
        }
        if (!string.IsNullOrEmpty(tipoPermisoError))
        {
            // Focus the select by name (there's no id on the select, use types)
            // Try focusing the inicio date if relevant
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "permiso-fechaInicio");
            return;
        }
        if (!string.IsNullOrEmpty(fechaInicioError))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "permiso-fechaInicio");
            return;
        }
        if (!string.IsNullOrEmpty(fechaFinError))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "permiso-fechaFin");
            return;
        }
        if (!string.IsNullOrEmpty(motivoError))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "permiso-motivo");
            return;
        }
    }
}
