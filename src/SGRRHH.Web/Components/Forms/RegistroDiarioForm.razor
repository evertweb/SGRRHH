@* Formulario de Registro Diario - Crear/Editar *@
@using SGRRHH.Core.Entities
@using SGRRHH.Core.Interfaces

<div class="registro-form form-centered" @onkeydown="HandleKeyDown" style="position: relative;">
    @if (isSaving)
    {
        <div class="saving-overlay"><div class="saving-box">Guardando...</div></div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="legacy-alert legacy-alert-error">
            @errorMessage
        </div>
    }

    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 2;">
            <label class="legacy-form-label required">Empleado</label>
            <select id="registro-empleado" class="legacy-form-input" @bind="registro.EmpleadoId" disabled="@isEditing">
                <option value="0">-- Seleccione empleado --</option>
                @foreach (var emp in empleados ?? Enumerable.Empty<Empleado>())
                {
                    <option value="@emp.Id">@emp.Codigo - @emp.NombreCompleto</option>
                }
            </select>
            @if (!string.IsNullOrEmpty(empleadoError))
            {
                <div class="legacy-validation-error">@empleadoError</div>
            }
        </div>

        <div class="legacy-form-group" style="width: 140px;">
            <label class="legacy-form-label required">Fecha</label>
            <input id="registro-fecha" type="date" class="legacy-form-input" 
                   value="@FormatDate(registro.Fecha)"
                   @onchange="e => registro.Fecha = ParseDate(e.Value?.ToString())"
                   disabled="@isEditing" />
        </div>
    </div>

    <div class="legacy-form-row">
        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Hora Entrada</label>
            <input id="registro-horaEntrada" type="time" class="legacy-form-input" 
                   value="@FormatTime(registro.HoraEntrada)"
                   @onchange="e => registro.HoraEntrada = ParseTime(e.Value?.ToString())" />
        </div>

        <div class="legacy-form-group" style="flex: 1;">
            <label class="legacy-form-label">Hora Salida</label>
            <input id="registro-horaSalida" type="time" class="legacy-form-input" 
                   value="@FormatTime(registro.HoraSalida)"
                   @onchange="e => registro.HoraSalida = ParseTime(e.Value?.ToString())" />
        </div>

        @if (isEditing)
        {
            <div class="legacy-form-group" style="width: 120px;">
                <label class="legacy-form-label">Estado</label>
                <select class="legacy-form-input" @bind="registro.Estado">
                    <option value="@EstadoRegistroDiario.Borrador">Borrador</option>
                    <option value="@EstadoRegistroDiario.Completado">Completado</option>
                    <option value="@EstadoRegistroDiario.Aprobado">Aprobado</option>
                </select>
            </div>
        }
    </div>

    <div class="legacy-form-group">
        <label class="legacy-form-label">Observaciones</label>
        <textarea class="legacy-form-textarea" @bind="registro.Observaciones" rows="2" placeholder="Observaciones del día"></textarea>
    </div>

    @* Sección de Actividades *@
    <fieldset class="legacy-fieldset">
        <legend>Actividades del Día</legend>
        
        @if (detallesActividades.Any())
        {
            <div class="actividades-list">
                @foreach (var detalle in detallesActividades)
                {
                    <div class="actividad-item">
                        <div class="actividad-info">
                            <span class="actividad-nombre">@(actividades?.FirstOrDefault(a => a.Id == detalle.ActividadId)?.Nombre ?? "Actividad")</span>
                            @if (detalle.ProyectoId.HasValue)
                            {
                                <span class="actividad-proyecto">(@(proyectos?.FirstOrDefault(p => p.Id == detalle.ProyectoId)?.Nombre ?? "Proyecto"))</span>
                            }
                            <span class="actividad-horas">@detalle.Horas.ToString("F1")h</span>
                        </div>
                        <button type="button" class="legacy-button-small legacy-button-danger" @onclick="() => RemoveActividad(detalle)" title="Eliminar">✕</button>
                    </div>
                }
            </div>
            <div class="actividades-total">
                Total: <strong>@detallesActividades.Sum(d => d.Horas).ToString("F1") horas</strong>
            </div>
        }
        else
        {
            <div class="empty-actividades">No hay actividades registradas</div>
        }

        @* Formulario para agregar actividad *@
        <div class="nueva-actividad">
            <div class="legacy-form-row">
                <div class="legacy-form-group" style="flex: 2;">
                    <label class="legacy-form-label">Actividad</label>
                    <select class="legacy-form-input" @bind="nuevaActividad.ActividadId">
                        <option value="0">-- Seleccione --</option>
                        @foreach (var act in actividades ?? Enumerable.Empty<Actividad>())
                        {
                            <option value="@act.Id">@act.Nombre</option>
                        }
                    </select>
                </div>
                <div class="legacy-form-group" style="flex: 2;">
                    <label class="legacy-form-label">Proyecto (opcional)</label>
                    <select class="legacy-form-input" @bind="nuevaActividad.ProyectoId">
                        <option value="">-- Ninguno --</option>
                        @foreach (var proy in proyectos ?? Enumerable.Empty<Proyecto>())
                        {
                            <option value="@proy.Id">@proy.Nombre</option>
                        }
                    </select>
                </div>
                <div class="legacy-form-group" style="width: 80px;">
                    <label class="legacy-form-label">Horas</label>
                    <input type="number" class="legacy-form-input" @bind="nuevaActividad.Horas" min="0.5" max="24" step="0.5" />
                </div>
                <div class="legacy-form-group" style="width: 80px; display: flex; align-items: flex-end;">
                    <button type="button" class="legacy-button legacy-button-primary" @onclick="AddActividad" 
                            disabled="@(nuevaActividad.ActividadId <= 0 || nuevaActividad.Horas <= 0)">+ Agregar</button>
                </div>
            </div>
            <div class="legacy-form-group">
                <label class="legacy-form-label">Descripción (opcional)</label>
                <input type="text" class="legacy-form-input" @bind="nuevaActividad.Descripcion" placeholder="Descripción de la actividad" />
            </div>
        </div>
    </fieldset>

    @if (registro.TotalHoras > 0)
    {
        <div class="hours-summary">
            Total horas registradas: <strong>@registro.TotalHoras.ToString("F1") horas</strong>
        </div>
    }
</div>


@code {

    [Parameter]
    public RegistroDiario? RegistroEdit { get; set; }

    [Parameter]
    public DateTime? DefaultDate { get; set; }

    [Parameter]
    public EventCallback<RegistroDiario> OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Inject]
    public IRegistroDiarioRepository RegistroRepo { get; set; } = default!;

    [Inject]
    public IEmpleadoRepository EmpleadoRepo { get; set; } = default!;

    [Inject]
    public IRepository<Actividad> ActividadRepo { get; set; } = default!;

    [Inject]
    public IRepository<Proyecto> ProyectoRepo { get; set; } = default!;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    private RegistroDiario registro = new();
    private IEnumerable<Empleado>? empleados;
    private IEnumerable<Actividad>? actividades;
    private IEnumerable<Proyecto>? proyectos;
    private List<DetalleActividad> detallesActividades = new();
    private DetalleActividad nuevaActividad = new() { Horas = 1 };
    private bool isEditing = false;
    private string? errorMessage;
    private string? empleadoError;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            empleados = await EmpleadoRepo.GetAllActiveAsync();
            actividades = await ActividadRepo.GetAllAsync();
            proyectos = await ProyectoRepo.GetAllAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }

        if (RegistroEdit != null)
        {
            isEditing = true;
            registro = new RegistroDiario
            {
                Id = RegistroEdit.Id,
                EmpleadoId = RegistroEdit.EmpleadoId,
                Fecha = RegistroEdit.Fecha,
                HoraEntrada = RegistroEdit.HoraEntrada,
                HoraSalida = RegistroEdit.HoraSalida,
                Observaciones = RegistroEdit.Observaciones,
                Estado = RegistroEdit.Estado,
                DetallesActividades = RegistroEdit.DetallesActividades,
                Activo = RegistroEdit.Activo,
                FechaCreacion = RegistroEdit.FechaCreacion
            };
            registro.SetFirestoreDocumentId(RegistroEdit.GetFirestoreDocumentId() ?? "");
            // Copy existing activities to local list
            if (RegistroEdit.DetallesActividades != null)
            {
                detallesActividades = RegistroEdit.DetallesActividades.ToList();
            }
        }
        else
        {
            isEditing = false;
            registro = new RegistroDiario 
            { 
                Activo = true,
                Estado = EstadoRegistroDiario.Borrador,
                Fecha = DefaultDate ?? DateTime.Today,
                HoraEntrada = new TimeSpan(8, 0, 0),
                HoraSalida = new TimeSpan(17, 0, 0)
            };
        }
    }

    private string FormatDate(DateTime date) => date.ToString("yyyy-MM-dd");
    private string FormatTime(TimeSpan? time) => time?.ToString(@"hh\:mm") ?? "";
    
    private DateTime ParseDate(string? value)
    {
        if (DateTime.TryParse(value, out var date)) return date;
        return DateTime.Today;
    }

    private TimeSpan? ParseTime(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return TimeSpan.TryParse(value, out var time) ? time : null;
    }

    private void AddActividad()
    {
        if (nuevaActividad.ActividadId <= 0 || nuevaActividad.Horas <= 0) return;
        
        var detalle = new DetalleActividad
        {
            ActividadId = nuevaActividad.ActividadId,
            ProyectoId = nuevaActividad.ProyectoId,
            Horas = nuevaActividad.Horas,
            Descripcion = nuevaActividad.Descripcion,
            Orden = detallesActividades.Count + 1,
            Activo = true,
            FechaCreacion = DateTime.Now
        };
        
        detallesActividades.Add(detalle);
        
        // Reset form
        nuevaActividad = new DetalleActividad { Horas = 1 };
    }

    private void RemoveActividad(DetalleActividad detalle)
    {
        detallesActividades.Remove(detalle);
    }

    public async Task<bool> ValidateAndSaveAsync()
    {
        if (isSaving) return false;
        
        isSaving = true;
        errorMessage = null;
        empleadoError = null;

        try
        {
            if (registro.EmpleadoId <= 0)
            {
                empleadoError = "Debe seleccionar un empleado";
                await FocusFirstInvalid();
                return false;
            }

            // Validate time logic
            if (registro.HoraEntrada.HasValue && registro.HoraSalida.HasValue)
            {
                if (registro.HoraSalida < registro.HoraEntrada)
                {
                    errorMessage = "La hora de salida no puede ser anterior a la hora de entrada";
                    await FocusFirstInvalid();
                    return false;
                }
            }

            // Confirm before saving
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", "¿Desea guardar el registro diario?");
            if (!ok) return false;

            // Copy activities to registro before saving
            registro.DetallesActividades = detallesActividades;

            if (isEditing)
            {
                await RegistroRepo.UpdateAsync(registro);
            }
            else
            {
                await RegistroRepo.AddAsync(registro);
            }

            await OnSave.InvokeAsync(registro);
            return true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"Error guardando registro: {ex}");
            return false;
        }
        finally
        {
            isSaving = false;
        }
    }

    public bool IsSaving => isSaving;

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e?.Key == "Enter" && !isSaving)
        {
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", "¿Desea guardar el registro diario?");
            if (ok)
            {
                await ValidateAndSaveAsync();
            }
        }
    }

    private async Task FocusFirstInvalid()
    {
        if (!string.IsNullOrEmpty(empleadoError))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "registro-empleado");
            return;
        }
        if (!string.IsNullOrEmpty(errorMessage))
        {
            await JSRuntime.InvokeVoidAsync("formHelpers.focusElementById", "registro-fecha");
            return;
        }
    }
}
