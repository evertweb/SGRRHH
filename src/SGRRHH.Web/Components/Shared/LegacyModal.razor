@* Componente Modal Reutilizable - Estilo Windows Classic *@
@using Microsoft.AspNetCore.Components.Web

@if (IsVisible)
{
    <div class="legacy-modal-overlay" @onclick="HandleOverlayClick" @onkeydown="HandleKeyDown" tabindex="0" @ref="overlayRef">
        <div class="legacy-modal" style="@GetWidthStyle()" @onclick:stopPropagation="true">
            @* Barra de título *@
            <div class="legacy-modal-titlebar">
                <span>@Title</span>
                <button class="legacy-modal-close" @onclick="Close" title="Cerrar">✕</button>
            </div>
            
            @* Contenido *@
            <div class="legacy-modal-content">
                @ChildContent
            </div>
            
            @* Footer con botones (opcional) *@
            @if (FooterContent != null)
            {
                <div class="legacy-modal-footer">
                    @FooterContent
                </div>
            }
        </div>
    </div>
}

@code {
    /// <summary>
    /// Título que aparece en la barra del modal
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "Ventana";

    /// <summary>
    /// Controla si el modal está visible
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Callback cuando se cierra el modal
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }

    /// <summary>
    /// Evento cuando se presiona Enter en el modal (usado para guardar)
    /// </summary>
    [Parameter]
    public EventCallback OnEnter { get; set; }

    /// <summary>
    /// Ancho del modal (ej: "500px", "600px")
    /// </summary>
    [Parameter]
    public string Width { get; set; } = "450px";

    /// <summary>
    /// Contenido principal del modal
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Contenido del footer (botones de acción)
    /// </summary>
    [Parameter]
    public RenderFragment? FooterContent { get; set; }

    /// <summary>
    /// Si true, permite cerrar haciendo clic en el overlay
    /// </summary>
    [Parameter]
    public bool CloseOnOverlayClick { get; set; } = true;

    private ElementReference overlayRef;

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleOverlayClick()
    {
        if (CloseOnOverlayClick)
        {
            await Close();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e == null) return;
        if (e.Key == "Escape")
        {
            await Close();
            return;
        }

        if (e.Key == "Enter")
        {
            if (OnEnter.HasDelegate)
            {
                await OnEnter.InvokeAsync();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            try
            {
                await overlayRef.FocusAsync();
            }
            catch { /* ignore focus errors */ }
        }
    }

    private string GetWidthStyle()
    {
        return $"width: {Width};";
    }
}


