@using SGRRHH.Web.Client
@using SGRRHH.Core.Interfaces
@inject FirebaseJsInterop Firebase
@inject FirebaseWebConfig FirebaseConfig
@inject IFirebaseAuthService AuthService
@inject AppStateService AppState
@inject AuthJsBridge AuthJsBridgeInstance
@implements IAsyncDisposable

@if (_isInitialized)
{
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
            <FocusOnNavigate RouteData="@routeData" Selector="h1" />
        </Found>
        <NotFound>
            <PageTitle>Not found</PageTitle>
            <LayoutView Layout="@typeof(MainLayout)">
                <p role="alert">Sorry, there's nothing at this address.</p>
            </LayoutView>
        </NotFound>
    </Router>
}
else if (_hasError)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #C0C0C0; font-family: 'Courier New', monospace;">
        <div style="border: 2px outset white; padding: 20px; background: #C0C0C0; box-shadow: 2px 2px 0 black; max-width: 400px;">
            <div style="background: #800000; color: white; padding: 2px 5px; font-weight: bold; margin-bottom: 10px;">
                Error de Inicializacion
            </div>
            <div style="font-size: 13px; color: #800000;">
                @_errorMessage
            </div>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 5px 15px; cursor: pointer;">
                Reintentar
            </button>
        </div>
    </div>
}
else
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #C0C0C0; font-family: 'Courier New', monospace;">
        <div style="border: 2px outset white; padding: 20px; background: #C0C0C0; box-shadow: 2px 2px 0 black;">
            <div style="background: navy; color: white; padding: 2px 5px; font-weight: bold; margin-bottom: 10px;">
                SGRRHH - Iniciando...
            </div>
            <div style="font-size: 13px;">
                Conectando con Firebase...<br />
                Por favor espere.
            </div>
        </div>
    </div>
}

@code {
    private bool _isInitialized = false;
    private bool _hasError = false;
    private string _errorMessage = "";

    private DotNetObjectReference<object>? _authBridgeRef;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!Firebase.IsInitialized)
            {
                await Firebase.InitializeAsync(FirebaseConfig);
            }

            // Intentar restaurar sesión desde Firebase (si existe usuario autenticado)
            try
            {
                var current = await Firebase.GetCurrentUserAsync();
                if (current != null && current.Success)
                {
                    var usuario = await AuthService.GetUserByFirebaseUidAsync(current.Uid);
                    if (usuario != null)
                    {
                        var auth = new FirebaseAuthResult
                        {
                            Success = true,
                            Usuario = usuario,
                            FirebaseUid = current.Uid,
                            IdToken = current.IdToken
                        };
                        AppState.SetAuth(auth);
                    }
                }

                // Registrar callback JS->.NET para onAuthStateChanged (mantener AppState sincronizado entre pestañas)
                try
                {
                    var dotNetRef = DotNetObjectReference.Create((object)AuthJsBridgeInstance);
                    await Firebase.RegisterAuthStateCallbackAsync(dotNetRef);
                    _authBridgeRef = dotNetRef; // almacenar para disposicion
                }
                catch (Exception exReg)
                {
                    Console.WriteLine($"Error registrando callback de auth JS->.NET: {exReg}");
                }
            }
            catch (Exception ex2)
            {
                Console.WriteLine($"Error restaurando auth desde Firebase: {ex2}");
            }

            _isInitialized = true;
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = $"No se pudo conectar con Firebase: {ex.Message}";
            Console.WriteLine($"Firebase initialization error: {ex}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_authBridgeRef != null)
            {
                await Firebase.UnregisterAuthStateCallbackAsync();
                _authBridgeRef.Dispose();
                _authBridgeRef = null;
            }
        }
        catch { }
    }
}
