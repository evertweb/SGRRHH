@inherits LayoutComponentBase
@using SGRRHH.Local.Domain.Enums
@inject IAuthService AuthService
@inject ISessionService SessionService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

@if (!AuthService.IsAuthenticated)
{
    <RedirectToLogin />
}
else
{
    <!-- Toast Messages Component -->
    <MessageToast @ref="messageToast" />
    
    <!-- Session Expiring Warning -->
    @if (showSessionWarning)
    {
        <div class="session-warning-bar">
            <span>⚠ Su sesión expirará en @sessionRemainingMinutes minuto(s). </span>
            <button @onclick="ExtendSession">EXTENDER SESIÓN</button>
        </div>
    }

    <!-- MARCA DE AGUA -->
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                width: 400px; height: 400px; 
                background-image: url('/images/logo-watermark.svg'); 
                background-size: contain; background-repeat: no-repeat; 
                background-position: center; opacity: 0.08; 
                z-index: 9999; pointer-events: none;"></div>

    <div class="main-container">
        <!-- Header del Sistema -->
        <header class="system-header">
            <span class="title">SGRRHH LOCAL v1.0</span>
            <span class="info" style="display: flex; align-items: center; gap: 12px;">
                @if (AuthService.IsAprobador)
                {
                    <NotificationBell />
                }
                <span>
                    Usuario: @AuthService.CurrentUser?.NombreCompleto 
                    (@GetRolDisplay()) | 
                    @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                </span>
            </span>
        </header>

        <!-- Menú de Navegación Textual -->
        <nav class="nav-menu">
            <!-- PERSONAL -->
            <span class="nav-group">
                <span class="nav-group-label">PERSONAL</span>
                <NavLink href="/empleados">EMPLEADOS</NavLink>
                <NavLink href="/contratos">CONTRATOS</NavLink>
                <NavLink href="/documentos">DOCUMENTOS</NavLink>
            </span>
            
            <span class="nav-separator"></span>
            
            <!-- SOLICITUDES -->
            <span class="nav-group">
                <span class="nav-group-label">SOLICITUDES</span>
                <NavLink href="/permisos">PERMISOS</NavLink>
                <NavLink href="/vacaciones">VACACIONES</NavLink>
            </span>
            
            <span class="nav-separator"></span>
            
            <!-- CONTROL DIARIO -->
            <span class="nav-group">
                <span class="nav-group-label">ASISTENCIA</span>
                <NavLink href="/control-diario">CONTROL</NavLink>
                <NavLink href="/control-diario-wizard">WIZARD</NavLink>
            </span>
            
            <span class="nav-separator"></span>
            
            <!-- REPORTES (visible para todos) -->
            <span class="nav-group">
                <span class="nav-group-label">INFORMES</span>
                <NavLink href="/reportes">REPORTES</NavLink>
            </span>
            
            @if (AuthService.IsAdmin || AuthService.IsAprobador)
            {
                <span class="nav-separator"></span>
                <span class="nav-group">
                    <span class="nav-group-label">SUPERVISIÓN</span>
                    <NavLink href="/auditoria">AUDITORÍA</NavLink>
                </span>
            }
            
            @if (AuthService.IsAdmin)
            {
                <span class="nav-separator admin-separator"></span>
                
                <!-- ADMINISTRACIÓN -->
                <span class="nav-group admin-group">
                    <span class="nav-group-label">ADMIN</span>
                    <NavLink href="/catalogos">CATÁLOGOS</NavLink>
                    <NavLink href="/usuarios">USUARIOS</NavLink>
                    <NavLink href="/configuracion">CONFIG</NavLink>
                </span>
            }
            
            <span class="nav-spacer"></span>
            <button class="btn btn-logout" @onclick="Logout">
                SALIR
            </button>
        </nav>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            Ruta: @GetBreadcrumb()
        </div>

        <!-- Área de Trabajo -->
        <main class="work-area">
            @Body
        </main>
    </div>

    <!-- Espacio para la barra de atajos (fija abajo) -->
    <div style="height: 50px;"></div>
}

<div id="blazor-error-ui">
    Error no controlado.
    <a href="" class="reload">Recargar</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private MessageToast? messageToast;
    private bool showSessionWarning = false;
    private int sessionRemainingMinutes = 5;
    private DotNetObjectReference<MainLayout>? _dotNetRef;
    private Timer? _notificationTimer;
    
    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthStateChanged += OnAuthChanged;
        SessionService.OnSessionExpiring += OnSessionExpiring;
        SessionService.OnSessionExpired += OnSessionExpired;
        
        // Iniciar verificación de notificaciones cada 2 minutos
        _notificationTimer = new Timer(async _ =>
        {
            await NotificationService.CheckForNewNotificationsAsync();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromMinutes(2));
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AuthService.IsAuthenticated)
        {
            // Configurar registro de actividad de sesión
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupSessionActivity", _dotNetRef);
        }
    }

    private void OnAuthChanged(object? sender, Usuario? user)
    {
        if (user == null)
        {
            Navigation.NavigateTo("/login");
        }
        InvokeAsync(StateHasChanged);
    }
    
    private void OnSessionExpiring(object? sender, EventArgs e)
    {
        showSessionWarning = true;
        sessionRemainingMinutes = SessionService.SessionTimeRemainingSeconds / 60;
        InvokeAsync(StateHasChanged);
    }
    
    private void OnSessionExpired(object? sender, EventArgs e)
    {
        InvokeAsync(async () =>
        {
            messageToast?.ShowWarning("Su sesión ha expirado por inactividad");
            await Task.Delay(2000);
            await AuthService.LogoutAsync();
            Navigation.NavigateTo("/login");
        });
    }
    
    private async Task ExtendSession()
    {
        await SessionService.ExtendSessionAsync();
        showSessionWarning = false;
        messageToast?.ShowSuccess("Sesión extendida");
        StateHasChanged();
    }
    
    [JSInvokable]
    public void RegisterActivity()
    {
        SessionService.RegisterActivity();
    }

    private string GetRolDisplay()
    {
        if (AuthService.CurrentUser == null) return "";
        
        return AuthService.CurrentUser.Rol switch
        {
            RolUsuario.Administrador => "Admin",
            RolUsuario.Aprobador => "Aprobador",
            RolUsuario.Operador => "Operador",
            _ => "Usuario"
        };
    }

    private string GetBreadcrumb()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath.Trim('/');

        if (string.IsNullOrEmpty(path)) 
            return GetDefaultPageName();

        var segments = path.Split('/');
        var breadcrumb = GetDefaultPageName() + " > " + string.Join(" > ", segments.Select(s => s.ToUpper()));
        
        return breadcrumb;
    }
    
    private string GetDefaultPageName()
    {
        if (AuthService.CurrentUser == null) return "INICIO";
        
        return AuthService.CurrentUser.Rol switch
        {
            RolUsuario.Administrador => "USUARIOS",
            RolUsuario.Aprobador => "EMPLEADOS",
            RolUsuario.Operador => "CONTROL DIARIO",
            _ => "EMPLEADOS"
        };
    }

    private async Task Logout()
    {
        await SessionService.EndSessionAsync();
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= OnAuthChanged;
        SessionService.OnSessionExpiring -= OnSessionExpiring;
        SessionService.OnSessionExpired -= OnSessionExpired;
        _notificationTimer?.Dispose();
        
        if (_dotNetRef != null)
        {
            _ = JSRuntime.InvokeVoidAsync("removeSessionActivity");
            _dotNetRef.Dispose();
        }
    }
}

<style>
    .session-warning-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #FFC107;
        color: #000;
        padding: 8px 16px;
        text-align: center;
        z-index: 10000;
        font-weight: bold;
        font-size: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }
    
    .session-warning-bar button {
        padding: 4px 12px;
        font-size: 11px;
        font-weight: bold;
    }
</style>

