@page "/catalogos"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IDepartamentoRepository DepartamentoRepository
@inject ICargoRepository CargoRepository
@inject ITipoPermisoRepository TipoPermisoRepository
@inject IProyectoRepository ProyectoRepository
@inject IActividadRepository ActividadRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Catalogos> Logger
@implements IDisposable

<PageTitle>Catálogos - SGRRHH</PageTitle>

<div class="hospital-page-header">
    <div class="hospital-page-title">GESTIÓN DE CATÁLOGOS</div>
</div>

@if (errorMessage != null)
{
    <div class="hospital-error-block">
        <div class="hospital-error-header">ERROR</div>
        <div class="hospital-error-body">@errorMessage</div>
        <div class="hospital-error-footer">
            <button class="hospital-btn" @onclick="() => errorMessage = null">ACEPTAR</button>
        </div>
    </div>
}

@if (successMessage != null)
{
    <div class="hospital-success-block">
        @successMessage
    </div>
}

<!-- Tabs -->
<div class="hospital-tabs-container">
    <div class="hospital-tabs-header">
        <button class="hospital-tab-button @(activeTab == "departamentos" ? "hospital-tab-active" : "")" 
                @onclick='() => ChangeTab("departamentos")'>
            DEPARTAMENTOS
        </button>
        <button class="hospital-tab-button @(activeTab == "cargos" ? "hospital-tab-active" : "")" 
                @onclick='() => ChangeTab("cargos")'>
            CARGOS
        </button>
        <button class="hospital-tab-button @(activeTab == "tiposPermiso" ? "hospital-tab-active" : "")" 
                @onclick='() => ChangeTab("tiposPermiso")'>
            TIPOS DE PERMISO
        </button>
        <button class="hospital-tab-button @(activeTab == "proyectos" ? "hospital-tab-active" : "")" 
                @onclick='() => ChangeTab("proyectos")'>
            PROYECTOS
        </button>
        <button class="hospital-tab-button @(activeTab == "actividades" ? "hospital-tab-active" : "")" 
                @onclick='() => ChangeTab("actividades")'>
            ACTIVIDADES
        </button>
    </div>
    
    <div class="hospital-tabs-content">
        @if (activeTab == "departamentos")
        {
            <DepartamentosTab @bind-ErrorMessage="errorMessage" 
                             @bind-SuccessMessage="successMessage" />
        }
        else if (activeTab == "cargos")
        {
            <CargosTab @bind-ErrorMessage="errorMessage" 
                      @bind-SuccessMessage="successMessage" />
        }
        else if (activeTab == "tiposPermiso")
        {
            <TiposPermisoTab @bind-ErrorMessage="errorMessage" 
                            @bind-SuccessMessage="successMessage" />
        }
        else if (activeTab == "proyectos")
        {
            <ProyectosTab @bind-ErrorMessage="errorMessage" 
                         @bind-SuccessMessage="successMessage" />
        }
        else if (activeTab == "actividades")
        {
            <ActividadesTab @bind-ErrorMessage="errorMessage" 
                           @bind-SuccessMessage="successMessage" />
        }
    </div>
</div>

@code {
    private const string PageId = "catalogos";
    
    private string activeTab = "departamentos";
    private string? errorMessage;
    private string? successMessage;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Solo administradores y supervisores pueden acceder a catálogos
        if (!AuthService.IsAdmin && !AuthService.IsSupervisor)
        {
            errorMessage = "No tiene permisos para acceder a esta sección";
            return;
        }
        
        // Registrar atajos de teclado para esta página
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = NuevoItem, ShowInBar = true, Priority = 10 },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = ActualizarTab, ShowInBar = true, Priority = 10 },
            new() { Key = "1", KeyDisplay = "1", Description = "Departamentos", Action = async () => ChangeTab("departamentos"), ShowInBar = false, Priority = 50 },
            new() { Key = "2", KeyDisplay = "2", Description = "Cargos", Action = async () => ChangeTab("cargos"), ShowInBar = false, Priority = 50 },
            new() { Key = "3", KeyDisplay = "3", Description = "Tipos Permiso", Action = async () => ChangeTab("tiposPermiso"), ShowInBar = false, Priority = 50 },
            new() { Key = "4", KeyDisplay = "4", Description = "Proyectos", Action = async () => ChangeTab("proyectos"), ShowInBar = false, Priority = 50 },
            new() { Key = "5", KeyDisplay = "5", Description = "Actividades", Action = async () => ChangeTab("actividades"), ShowInBar = false, Priority = 50 }
        });
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private void ChangeTab(string tab)
    {
        activeTab = tab;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();
    }
    
    private Task NuevoItem()
    {
        // Esta acción será manejada por el tab activo
        Logger.LogInformation($"Nuevo item solicitado en tab: {activeTab}");
        return Task.CompletedTask;
    }
    
    private Task ActualizarTab()
    {
        // Esta acción será manejada por el tab activo
        Logger.LogInformation($"Actualizar solicitado en tab: {activeTab}");
        StateHasChanged();
        return Task.CompletedTask;
    }
}
