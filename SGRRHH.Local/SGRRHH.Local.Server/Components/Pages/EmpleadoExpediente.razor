@page "/empleados/{EmpleadoId:int}/expediente"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Domain.Services
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Shared.Helpers
@using SGRRHH.Local.Infrastructure.Services
@using SGRRHH.Local.Server.Components.Expediente
@using SGRRHH.Local.Server.Components.Tabs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject IContratoRepository ContratoRepo
@inject ICuentaBancariaRepository CuentaBancariaRepo
@inject NavigationManager Navigation
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject IDocumentoStorageService DocumentoStorageService
@inject IJSRuntime JS
@inject ILogger<EmpleadoExpediente> Logger

<MessageToast @ref="messageToast" />

@if (isLoading)
{
    <div class="loading-message">CARGANDO EXPEDIENTE...</div>
}
else if (empleado == null)
{
    <div class="error-message">EMPLEADO NO ENCONTRADO</div>
    <button class="btn" @onclick="Volver">VOLVER A EMPLEADOS</button>
}
else
{
    <div class="expediente-container">
        <EmpleadoHeader Empleado="empleado"
                        TransicionesPermitidas="transicionesPermitidas"
                        @bind-NuevoEstadoSeleccionado="nuevoEstadoSeleccionado"
                        IsSavingEstado="isSavingEstado"
                        OnCambiarEstado="CambiarEstado"
                        OnCambiarFoto="AbrirCambiarFoto"
                        OnVolver="Volver"
                        OnEditarEmpleado="EditarEmpleado"
                        PuedeEliminar="AuthService.IsAdmin"
                        OnConfirmarEliminar="ConfirmarEliminar" />

        <TabsNavigation ActiveTab="activeTab"
                        Tabs="TabsDisponibles"
                        OnTabChanged="SetActiveTab" />

        <div class="tab-content">
            @if (activeTab == "datos")
            {
                <DatosGeneralesTab Empleado="empleado" />
            }
            else if (activeTab == "documentos")
            {
                <DocumentosTab Documentos="documentos"
                               OnPrevisualizarDocumento="PrevisualizarDocumento"
                               OnDescargarDocumento="DescargarDocumento"
                               OnImprimirDocumento="ImprimirDocumento"
                               OnAbrirScannerParaTipo="AbrirScannerParaTipo"
                               OnAbrirUploadModalParaTipo="AbrirUploadModalParaTipo"
                               OnConfirmarEliminarDocumento="ConfirmarEliminarDocumento" />
            }
            else if (activeTab == "contratos")
            {
                <ContratosTab EmpleadoId="EmpleadoId" Contratos="contratos" />
            }
            else if (activeTab == "seguridad")
            {
                <SeguridadSocialTab Empleado="empleado" />
            }
            else if (activeTab == "bancaria")
            {
                <InformacionBancariaTab @ref="informacionBancariaTab"
                                        EmpleadoId="EmpleadoId"
                                        Empleado="empleado"
                                        Documentos="documentos"
                                        MessageToast="messageToast"
                                        OnPreviewDocumento="PrevisualizarDocumento"
                                        OnDownloadDocumento="DescargarDocumento"
                                        OnSolicitarScannerCertificado="AbrirScannerParaCertificadoBancario" />
            }
            else if (activeTab == "dotacion")
            {
                <DotacionEppTab @ref="dotacionEppTab"
                                EmpleadoId="EmpleadoId"
                                Empleado="empleado"
                                Documentos="documentos"
                                messageToast="messageToast"
                                OnPrevisualizarDocumento="PrevisualizarDocumento"
                                OnDescargarDocumento="DescargarDocumento"
                                OnAbrirScannerActa="AbrirScannerParaActaEntrega" />
            }
        </div>
    </div>

    <div class="shortcuts-bar">
        <div class="shortcut-item">
            <span class="shortcut-key">ESC</span>
            <span>=VOLVER</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-key">F4</span>
            <span>=EDITAR</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-key">F5</span>
            <span>=ACTUALIZAR</span>
        </div>
    </div>
}

<FotoChangeModal Empleado="empleado"
                 @bind-IsVisible="showCambiarFotoModal"
                 OnAbrirScannerFoto="AbrirScannerParaFoto"
                 OnFotoActualizada="OnFotoActualizada"
                 MessageToast="messageToast" />

@if (showPreviewModal && previewDocumento != null)
{
    <div class="preview-modal-overlay" @onclick="CerrarPreview">
        <div class="preview-modal" @onclick:stopPropagation="true">
            <div class="preview-header">
                <span class="preview-title">@previewDocumento.Nombre</span>
                <button class="btn" @onclick="CerrarPreview">CERRAR (ESC)</button>
            </div>
            <div class="preview-body">
                @if (previewBytes != null)
                {
                    @if (DocumentHelper.IsImageMime(previewDocumento.TipoMime))
                    {
                        <img src="data:@previewDocumento.TipoMime;base64,@Convert.ToBase64String(previewBytes)"
                             alt="@previewDocumento.Nombre" />
                    }
                    else if (previewDocumento.TipoMime == "application/pdf")
                    {
                        <iframe src="data:application/pdf;base64,@Convert.ToBase64String(previewBytes)"></iframe>
                    }
                    else
                    {
                        <div class="no-preview">
                            <p>TIPO DE ARCHIVO: @previewDocumento.TipoMime</p>
                            <p>NO SE PUEDE PREVISUALIZAR ESTE TIPO DE ARCHIVO</p>
                            <button class="btn" @onclick="() => DescargarDocumento(previewDocumento)">DESCARGAR ARCHIVO</button>
                        </div>
                    }
                }
                else
                {
                    <div class="no-preview">CARGANDO ARCHIVO...</div>
                }
            </div>
            <div class="preview-footer">
                <button class="btn" @onclick="() => DescargarDocumento(previewDocumento)">DESCARGAR</button>
                <button class="btn" @onclick="CerrarPreview">CERRAR</button>
            </div>
        </div>
    </div>
}

@if (showConfirmDelete)
{
    <div class="confirm-overlay">
        <div class="confirm-dialog">
            <div class="confirm-header">CONFIRMAR ELIMINACIÓN</div>
            <div class="confirm-body">
                <p>¿Está seguro de eliminar al empleado <strong>@empleado?.Codigo - @empleado?.NombreCompleto</strong>?</p>
                <p style="color: #DC143C; margin-top: 10px;">Esta acción eliminará también todos sus documentos y no puede deshacerse.</p>
            </div>
            <div class="confirm-footer">
                <button class="btn" @onclick="() => showConfirmDelete = false">CANCELAR</button>
                <button class="btn btn-danger" @onclick="EliminarEmpleado">ELIMINAR</button>
            </div>
        </div>
    </div>
}

<ScannerModal @bind-IsVisible="mostrarScannerModal"
              AllowMultiplePages="true"
              OnScanComplete="OnScanComplete"
              OnPdfGenerated="OnPdfGenerated" />

<PrinterModal IsVisible="mostrarPrinterModal"
              PdfBytes="bytesParaImprimir"
              DocumentName="nombreDocumentoImprimir"
              OnClose="CerrarPrinterModal"
              OnPrintComplete="OnPrintComplete" />

@if (mostrarUploadModal)
{
    <div class="confirm-overlay">
        <div class="confirm-dialog" style="width: 500px;">
            <div class="confirm-header">SUBIR DOCUMENTO: @DocumentHelper.GetTipoDocumentoNombre(tipoDocumentoParaSubir)</div>
            <div class="confirm-body">
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 10px; font-weight: bold; margin-bottom: 3px;">NOMBRE:</label>
                    <input type="text" @bind="uploadNombre" style="width: 100%; padding: 6px; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #000;" />
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 10px; font-weight: bold; margin-bottom: 3px;">DESCRIPCIÓN (OPCIONAL):</label>
                    <input type="text" @bind="uploadDescripcion" style="width: 100%; padding: 6px; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #000;" />
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label style="display: block; font-size: 10px; font-weight: bold; margin-bottom: 3px;">FECHA EMISIÓN:</label>
                        <input type="date" @bind="uploadFechaEmision" style="width: 100%; padding: 6px; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #000;" />
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; font-size: 10px; font-weight: bold; margin-bottom: 3px;">FECHA VENCIMIENTO:</label>
                        <input type="date" @bind="uploadFechaVencimiento" style="width: 100%; padding: 6px; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #000;" />
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 10px; font-weight: bold; margin-bottom: 3px;">ARCHIVO (PDF, IMÁGENES - MÁX 10MB):</label>
                    <InputFile OnChange="OnUploadFileSelected" accept=".pdf,.jpg,.jpeg,.png"
                               style="width: 100%; padding: 6px; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #000; background: #fff;" />
                    @if (!string.IsNullOrEmpty(uploadFileName))
                    {
                        <div style="font-size: 10px; color: #006600; margin-top: 5px;">
                            ✓ @uploadFileName (@FormatHelper.FormatFileSize(uploadFileBytes?.Length ?? 0))
                        </div>
                    }
                </div>
            </div>
            <div class="confirm-footer">
                <button class="btn" @onclick="CerrarUploadModal">CANCELAR</button>
                <button class="btn" style="background: #E8FFE8;" @onclick="SubirDocumento" disabled="@(isUploading || uploadFileBytes == null)">
                    @(isUploading ? "SUBIENDO..." : "GUARDAR")
                </button>
            </div>
        </div>
    </div>
}

@if (showConfirmDeleteDoc && documentoAEliminar != null)
{
    <div class="confirm-overlay">
        <div class="confirm-dialog">
            <div class="confirm-header">CONFIRMAR ELIMINACIÓN</div>
            <div class="confirm-body">
                <p>¿Está seguro de eliminar el documento <strong>@DocumentHelper.GetTipoDocumentoNombre(documentoAEliminar.TipoDocumento)</strong>?</p>
                <p style="font-size: 11px; color: #666;">@documentoAEliminar.NombreArchivoOriginal</p>
                <p style="color: #DC143C; margin-top: 10px; font-size: 11px;">Esta acción no puede deshacerse.</p>
            </div>
            <div class="confirm-footer">
                <button class="btn" @onclick="CancelarEliminarDocumento">CANCELAR</button>
                <button class="btn btn-danger" @onclick="EliminarDocumento">ELIMINAR</button>
            </div>
        </div>
    </div>
}
