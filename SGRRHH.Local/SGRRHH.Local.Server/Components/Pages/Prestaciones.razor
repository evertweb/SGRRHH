@page "/prestaciones"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IPrestacionRepository PrestacionRepository
@inject ILiquidacionService LiquidacionService
@inject IEmpleadoRepository EmpleadoRepository
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Prestaciones> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Prestaciones Sociales - SGRRHH</PageTitle>

<MessageToast @ref="messageToast" />

<div class="prestaciones-page-container">
    <div class="prestaciones-page-header">
        <h1 class="prestaciones-page-title">PRESTACIONES SOCIALES - LEGISLACIÓN COLOMBIANA</h1>
    </div>

    @if (!AuthService.IsAuthenticated)
    {
        <div class="error-message">ACCESO DENEGADO - DEBE INICIAR SESIÓN</div>
        return;
    }

    <div class="prestaciones-action-bar">
        <div class="prestaciones-action-buttons">
            <button class="btn btn-success" @onclick="CalcularCesantias">CALCULAR CESANTÍAS</button>
            <button class="btn btn-success" @onclick="CalcularInteresesCesantias">CALCULAR INTERESES</button>
            <button class="btn btn-success" @onclick="CalcularPrimaServicios">CALCULAR PRIMA</button>
            <button class="btn" @onclick="CargarDatos">ACTUALIZAR (F5)</button>
        </div>
        
        <div class="prestaciones-filter-section">
            <div class="prestaciones-filter-group">
                <label class="prestaciones-filter-label">AÑO:</label>
                <select class="prestaciones-filter-select" @bind="añoSeleccionado" @bind:after="CargarDatos">
                    @for (int año = DateTime.Now.Year + 1; año >= 2020; año--)
                    {
                        <option value="@año">@año</option>
                    }
                </select>
            </div>
            
            <div class="prestaciones-filter-group">
                <label class="prestaciones-filter-label">TIPO:</label>
                <select class="prestaciones-filter-select" @bind="tipoFiltro" @bind:after="AplicarFiltros">
                    <option value="">TODOS</option>
                    <option value="@((int)TipoPrestacion.Cesantias)">CESANTÍAS</option>
                    <option value="@((int)TipoPrestacion.InteresesCesantias)">INTERESES CESANTÍAS</option>
                    <option value="@((int)TipoPrestacion.PrimaServicios)">PRIMA DE SERVICIOS</option>
                    <option value="@((int)TipoPrestacion.Dotacion)">DOTACIÓN</option>
                    <option value="@((int)TipoPrestacion.AuxilioTransporte)">AUXILIO TRANSPORTE</option>
                    <option value="@((int)TipoPrestacion.Bonificacion)">BONIFICACIÓN</option>
                </select>
            </div>
            
            <div class="prestaciones-filter-group">
                <label class="prestaciones-filter-label">ESTADO:</label>
                <select class="prestaciones-filter-select" @bind="estadoFiltro" @bind:after="AplicarFiltros">
                    <option value="">TODOS</option>
                    <option value="@((int)EstadoPrestacion.Calculada)">CALCULADA</option>
                    <option value="@((int)EstadoPrestacion.Aprobada)">APROBADA</option>
                    <option value="@((int)EstadoPrestacion.Pagada)">PAGADA</option>
                    <option value="@((int)EstadoPrestacion.Consignada)">CONSIGNADA</option>
                    <option value="@((int)EstadoPrestacion.Anulada)">ANULADA</option>
                </select>
            </div>
        </div>
    </div>

    <div class="prestaciones-info-box">
        <strong>PRESTACIONES SOCIALES:</strong><br/>
        • <strong>Cesantías:</strong> 1 mes de salario por año trabajado. Fórmula: (Salario × Días) / 360<br/>
        • <strong>Intereses Cesantías:</strong> 12% anual sobre cesantías. Pago: Enero 31<br/>
        • <strong>Prima de Servicios:</strong> 30 días de salario/año. Pagos: Junio 30 y Diciembre 20
    </div>

    <div class="prestaciones-results-info">
        Mostrando @prestacionesFiltradas.Count prestación(es) del año @añoSeleccionado
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>CÓDIGO</th>
                <th>EMPLEADO</th>
                <th>TIPO</th>
                <th>PERÍODO</th>
                <th>FECHA INICIO</th>
                <th>FECHA FIN</th>
                <th>SALARIO BASE</th>
                <th>DÍAS PROP.</th>
                <th>VALOR CALCULADO</th>
                <th>VALOR PAGADO</th>
                <th>FECHA PAGO</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="13" class="loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!prestacionesFiltradas.Any())
            {
                <tr><td colspan="13" class="empty-message">NO HAY PRESTACIONES PARA ESTE PERÍODO</td></tr>
            }
            else
            {
                @foreach (var prest in prestacionesFiltradas.OrderBy(p => p.Empleado?.Codigo ?? "").ThenBy(p => p.Tipo))
                {
                    <tr class="@(selectedPrestacion?.Id == prest.Id ? "selected" : "")"
                        @onclick="() => SelectPrestacion(prest)">
                        <td class="prestaciones-cell-code">@(prest.Empleado?.Codigo ?? "-")</td>
                        <td>@(prest.Empleado?.NombreCompleto ?? "-")</td>
                        <td class="prestaciones-cell-tipo prestaciones-tipo-@GetTipoClass(prest.Tipo)">@GetTipoNombre(prest.Tipo)</td>
                        <td>@prest.Periodo</td>
                        <td>@prest.FechaInicio.ToString("dd/MM/yyyy")</td>
                        <td>@prest.FechaFin.ToString("dd/MM/yyyy")</td>
                        <td class="prestaciones-cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(prest.SalarioBase)</td>
                        <td>@(prest.DiasProporcionales?.ToString() ?? "-")</td>
                        <td class="prestaciones-cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(prest.ValorCalculado)</td>
                        <td class="prestaciones-cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(prest.ValorPagado)</td>
                        <td>@(prest.FechaPago?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td class="prestaciones-cell-estado prestaciones-estado-@GetEstadoClass(prest.Estado)">@prest.Estado.ToString().ToUpper()</td>
                        <td class="prestaciones-cell-actions">
                            <button class="prestaciones-btn-table" @onclick="() => VerDetalle(prest)" @onclick:stopPropagation="true">VER</button>
                            @if (prest.Estado == EstadoPrestacion.Calculada)
                            {
                                <button class="prestaciones-btn-table" @onclick="() => AprobarPrestacion(prest)" @onclick:stopPropagation="true">APROBAR</button>
                            }
                            @if (prest.Estado == EstadoPrestacion.Aprobada)
                            {
                                <button class="prestaciones-btn-table" @onclick="() => MarcarPagada(prest)" @onclick:stopPropagation="true">PAGAR</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="shortcuts-bar">
    <div class="shortcut-item">
        <span class="shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

@if (showModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>DETALLE PRESTACIÓN - @(prestacionEdit?.Empleado?.NombreCompleto ?? "")</h3>
            
            @if (prestacionEdit != null)
            {
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">TIPO</label>
                        <input type="text" class="form-input" value="@GetTipoNombre(prestacionEdit.Tipo)" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">PERÍODO (AÑO)</label>
                        <input type="number" class="form-input" value="@prestacionEdit.Periodo" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FECHA INICIO</label>
                        <input type="date" class="form-input" value="@prestacionEdit.FechaInicio.ToString("yyyy-MM-dd")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FECHA FIN</label>
                        <input type="date" class="form-input" value="@prestacionEdit.FechaFin.ToString("yyyy-MM-dd")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">SALARIO BASE</label>
                        <input type="text" class="form-input" value="@NumberFormatHelper.FormatearMoneda(prestacionEdit.SalarioBase)" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DÍAS PROPORCIONALES</label>
                        <input type="text" class="form-input" value="@(prestacionEdit.DiasProporcionales?.ToString() ?? "-")" readonly />
                    </div>
                </div>

                <div class="prestaciones-section-title">VALORES</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">VALOR CALCULADO</label>
                        <input type="text" class="form-input prestaciones-valor-destacado" value="@NumberFormatHelper.FormatearMoneda(prestacionEdit.ValorCalculado)" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">VALOR PAGADO</label>
                        <input type="text" class="form-input" value="@NumberFormatHelper.FormatearMoneda(prestacionEdit.ValorPagado)" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ESTADO</label>
                        <input type="text" class="form-input" value="@prestacionEdit.Estado.ToString().ToUpper()" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FECHA PAGO</label>
                        <input type="text" class="form-input" value="@(prestacionEdit.FechaPago?.ToString("dd/MM/yyyy") ?? "NO PAGADO")" readonly />
                    </div>
                    
                    @if (prestacionEdit.ValorBase.HasValue)
                    {
                        <div class="form-group">
                            <label class="form-label">VALOR BASE (CESANTÍAS)</label>
                            <input type="text" class="form-input" value="@prestacionEdit.ValorBase?.ToString("C0")" readonly />
                        </div>
                    }
                    
                    @if (prestacionEdit.PorcentajeAplicado.HasValue)
                    {
                        <div class="form-group">
                            <label class="form-label">% APLICADO</label>
                            <input type="text" class="form-input" value="@prestacionEdit.PorcentajeAplicado?.ToString("N2")%" readonly />
                        </div>
                    }
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">MÉTODO PAGO</label>
                        <input type="text" class="form-input" value="@(prestacionEdit.MetodoPago ?? "-")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">COMPROBANTE</label>
                        <input type="text" class="form-input" value="@(prestacionEdit.ComprobanteReferencia ?? "-")" readonly />
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">OBSERVACIONES</label>
                        <textarea class="form-input" rows="2" readonly>@(prestacionEdit.Observaciones ?? "")</textarea>
                    </div>
                </div>
            }

            <div class="modal-actions">
                <button class="btn" @onclick="CerrarModal">CERRAR (ESC)</button>
            </div>
        </div>
    </div>
}

@if (showCalcModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>@calcModalTitle</h3>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">EMPLEADO *</label>
                    <select class="form-input" @bind="calcEmpleadoId">
                        <option value="0">-- SELECCIONE EMPLEADO --</option>
                        @foreach (var emp in empleadosActivos.OrderBy(e => e.NombreCompleto))
                        {
                            <option value="@emp.Id">@emp.Codigo - @emp.NombreCompleto</option>
                        }
                    </select>
                </div>
                
                @if (calcTipo == TipoPrestacion.PrimaServicios)
                {
                    <div class="form-group">
                        <label class="form-label">SEMESTRE</label>
                        <select class="form-input" @bind="calcSemestre">
                            <option value="1">PRIMER SEMESTRE (Ene-Jun)</option>
                            <option value="2">SEGUNDO SEMESTRE (Jul-Dic)</option>
                        </select>
                    </div>
                }
                
                @if (calcTipo == TipoPrestacion.Cesantias)
                {
                    <div class="form-group">
                        <label class="form-label">FECHA INICIO</label>
                        <input type="date" class="form-input" @bind="calcFechaInicio" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FECHA FIN</label>
                        <input type="date" class="form-input" @bind="calcFechaFin" />
                    </div>
                }
                
                <div class="form-group">
                    <label class="form-label">AÑO</label>
                    <input type="number" class="form-input" @bind="calcAño" min="2020" max="2050" />
                </div>
            </div>

            @if (calcResultado.HasValue)
            {
                <div class="prestaciones-calc-result">
                    <div>VALOR CALCULADO:</div>
                    <div class="valor">@calcResultado.Value.ToString("C0")</div>
                </div>
            }

            <div class="modal-actions">
                <button class="btn" @onclick="CerrarCalcModal">CANCELAR (ESC)</button>
                <button class="btn btn-primary" @onclick="EjecutarCalculo" disabled="@isCalculating">
                    @(isCalculating ? "CALCULANDO..." : "CALCULAR")
                </button>
                @if (calcResultado.HasValue)
                {
                    <button class="btn btn-success" @onclick="GuardarPrestacion" disabled="@isSaving">
                        @(isSaving ? "GUARDANDO..." : "GUARDAR PRESTACIÓN")
                    </button>
                }
            </div>
        </div>
    </div>
}

@if (showConfirmModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>CONFIRMAR ACCIÓN</h3>
            <p>@confirmMessage</p>
            <div class="modal-actions">
                <button class="btn" @onclick="() => showConfirmModal = false">CANCELAR</button>
                <button class="btn btn-primary" @onclick="ConfirmarAccion">CONFIRMAR</button>
            </div>
        </div>
    </div>
}

@code {
    private const string PageId = "Prestaciones";
    private MessageToast? messageToast;
    
    private List<Prestacion> prestaciones = new();
    private List<Prestacion> prestacionesFiltradas = new();
    private List<Empleado> empleadosActivos = new();
    private Prestacion? selectedPrestacion;
    private Prestacion? prestacionEdit;
    
    private int añoSeleccionado = DateTime.Now.Year;
    private string tipoFiltro = "";
    private string estadoFiltro = "";
    
    private bool isLoading;
    private bool showModal;
    private bool showCalcModal;
    private bool isSaving;
    private bool isCalculating;
    
    // Campos para cálculo
    private string calcModalTitle = "";
    private TipoPrestacion calcTipo;
    private int calcEmpleadoId;
    private int calcAño;
    private int calcSemestre = 1;
    private DateTime calcFechaInicio;
    private DateTime calcFechaFin;
    private decimal? calcResultado;
    
    private bool showConfirmModal;
    private string confirmMessage = "";
    private Func<Task>? confirmAction;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarDatos },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModalAsync }
        });
        
        await CargarEmpleados();
        await CargarDatos();
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task CargarEmpleados()
    {
        try
        {
            empleadosActivos = (await EmpleadoRepository.GetAllActiveWithRelationsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando empleados");
        }
    }
    
    private async Task CargarDatos()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            prestaciones = (await PrestacionRepository.GetByPeriodoAsync(añoSeleccionado)).ToList();
            
            // Cargar relación con empleados
            foreach (var prest in prestaciones)
            {
                if (prest.Empleado == null)
                {
                    prest.Empleado = empleadosActivos.FirstOrDefault(e => e.Id == prest.EmpleadoId);
                }
            }
            
            AplicarFiltros();
            
            Logger.LogInformation("Prestaciones cargadas para {Año}: {Count}", añoSeleccionado, prestaciones.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando prestaciones");
            messageToast?.ShowError("Error al cargar datos: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void AplicarFiltros()
    {
        prestacionesFiltradas = prestaciones
            .Where(p => string.IsNullOrEmpty(tipoFiltro) || (int)p.Tipo == int.Parse(tipoFiltro))
            .Where(p => string.IsNullOrEmpty(estadoFiltro) || (int)p.Estado == int.Parse(estadoFiltro))
            .ToList();
        StateHasChanged();
    }
    
    private void CalcularCesantias()
    {
        calcModalTitle = "CALCULAR CESANTÍAS";
        calcTipo = TipoPrestacion.Cesantias;
        calcEmpleadoId = 0;
        calcAño = añoSeleccionado;
        calcFechaInicio = new DateTime(añoSeleccionado, 1, 1);
        calcFechaFin = new DateTime(añoSeleccionado, 12, 31);
        calcResultado = null;
        showCalcModal = true;
        StateHasChanged();
    }
    
    private void CalcularInteresesCesantias()
    {
        calcModalTitle = "CALCULAR INTERESES SOBRE CESANTÍAS";
        calcTipo = TipoPrestacion.InteresesCesantias;
        calcEmpleadoId = 0;
        calcAño = añoSeleccionado;
        calcResultado = null;
        showCalcModal = true;
        StateHasChanged();
    }
    
    private void CalcularPrimaServicios()
    {
        calcModalTitle = "CALCULAR PRIMA DE SERVICIOS";
        calcTipo = TipoPrestacion.PrimaServicios;
        calcEmpleadoId = 0;
        calcAño = añoSeleccionado;
        calcSemestre = DateTime.Now.Month <= 6 ? 1 : 2;
        calcResultado = null;
        showCalcModal = true;
        StateHasChanged();
    }
    
    private async Task EjecutarCalculo()
    {
        if (calcEmpleadoId == 0)
        {
            messageToast?.ShowError("Debe seleccionar un empleado");
            return;
        }
        
        try
        {
            isCalculating = true;
            StateHasChanged();
            
            Result<decimal> resultado;
            
            switch (calcTipo)
            {
                case TipoPrestacion.Cesantias:
                    resultado = await LiquidacionService.CalcularCesantiasAsync(calcEmpleadoId, calcFechaInicio, calcFechaFin);
                    break;
                    
                case TipoPrestacion.InteresesCesantias:
                    resultado = await LiquidacionService.CalcularInteresesCesantiasAsync(calcEmpleadoId, calcAño);
                    break;
                    
                case TipoPrestacion.PrimaServicios:
                    DateTime fechaInicio, fechaFin;
                    if (calcSemestre == 1)
                    {
                        fechaInicio = new DateTime(calcAño, 1, 1);
                        fechaFin = new DateTime(calcAño, 6, 30);
                    }
                    else
                    {
                        fechaInicio = new DateTime(calcAño, 7, 1);
                        fechaFin = new DateTime(calcAño, 12, 31);
                    }
                    resultado = await LiquidacionService.CalcularPrimaServiciosAsync(calcEmpleadoId, fechaInicio, fechaFin);
                    break;
                    
                default:
                    messageToast?.ShowError("Tipo de prestación no soportado para cálculo automático");
                    return;
            }
            
            if (resultado.IsSuccess)
            {
                calcResultado = resultado.Value;
                messageToast?.ShowSuccess($"Cálculo realizado: {resultado.Value:C0}");
            }
            else
            {
                messageToast?.ShowError(resultado.Message ?? "Error en el cálculo");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculando prestación");
            messageToast?.ShowError("Error al calcular: " + ex.Message);
        }
        finally
        {
            isCalculating = false;
            StateHasChanged();
        }
    }
    
    private async Task GuardarPrestacion()
    {
        if (!calcResultado.HasValue || calcEmpleadoId == 0)
        {
            messageToast?.ShowError("Debe realizar el cálculo primero");
            return;
        }
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            var empleado = empleadosActivos.FirstOrDefault(e => e.Id == calcEmpleadoId);
            
            DateTime fechaInicio, fechaFin;
            
            if (calcTipo == TipoPrestacion.Cesantias)
            {
                fechaInicio = calcFechaInicio;
                fechaFin = calcFechaFin;
            }
            else if (calcTipo == TipoPrestacion.PrimaServicios)
            {
                if (calcSemestre == 1)
                {
                    fechaInicio = new DateTime(calcAño, 1, 1);
                    fechaFin = new DateTime(calcAño, 6, 30);
                }
                else
                {
                    fechaInicio = new DateTime(calcAño, 7, 1);
                    fechaFin = new DateTime(calcAño, 12, 31);
                }
            }
            else
            {
                fechaInicio = new DateTime(calcAño, 1, 1);
                fechaFin = new DateTime(calcAño, 12, 31);
            }
            
            var prestacion = new Prestacion
            {
                EmpleadoId = calcEmpleadoId,
                Periodo = calcAño,
                Tipo = calcTipo,
                FechaInicio = fechaInicio,
                FechaFin = fechaFin,
                SalarioBase = empleado?.SalarioBase ?? 0,
                ValorCalculado = calcResultado.Value,
                ValorPagado = 0,
                Estado = EstadoPrestacion.Calculada,
                DiasProporcionales = (int)(fechaFin - fechaInicio).TotalDays + 1
            };
            
            await PrestacionRepository.AddAsync(prestacion);
            messageToast?.ShowSuccess($"Prestación guardada correctamente: {calcResultado.Value:C0}");
            
            showCalcModal = false;
            calcResultado = null;
            añoSeleccionado = calcAño;
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando prestación");
            messageToast?.ShowError("Error al guardar: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void VerDetalle(Prestacion prestacion)
    {
        prestacionEdit = prestacion;
        showModal = true;
        StateHasChanged();
    }
    
    private void SelectPrestacion(Prestacion prestacion)
    {
        selectedPrestacion = selectedPrestacion?.Id == prestacion.Id ? null : prestacion;
        StateHasChanged();
    }
    
    private async Task AprobarPrestacion(Prestacion prestacion)
    {
        try
        {
            prestacion.Estado = EstadoPrestacion.Aprobada;
            await PrestacionRepository.UpdateAsync(prestacion);
            messageToast?.ShowSuccess($"Prestación de {prestacion.Empleado?.NombreCompleto} aprobada");
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error aprobando prestación");
            messageToast?.ShowError("Error al aprobar: " + ex.Message);
        }
    }
    
    private async Task MarcarPagada(Prestacion prestacion)
    {
        try
        {
            prestacion.Estado = EstadoPrestacion.Pagada;
            prestacion.FechaPago = DateTime.Now;
            prestacion.ValorPagado = prestacion.ValorCalculado;
            await PrestacionRepository.UpdateAsync(prestacion);
            messageToast?.ShowSuccess($"Prestación de {prestacion.Empleado?.NombreCompleto} marcada como pagada");
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error marcando prestación como pagada");
            messageToast?.ShowError("Error al marcar como pagada: " + ex.Message);
        }
    }
    
    private void CerrarModal()
    {
        showModal = false;
        prestacionEdit = null;
        StateHasChanged();
    }
    
    private void CerrarCalcModal()
    {
        showCalcModal = false;
        calcResultado = null;
        StateHasChanged();
    }
    
    private Task CerrarModalAsync()
    {
        if (showCalcModal)
        {
            CerrarCalcModal();
        }
        else
        {
            CerrarModal();
        }
        return Task.CompletedTask;
    }
    
    private async Task ConfirmarAccion()
    {
        showConfirmModal = false;
        if (confirmAction != null)
        {
            await confirmAction();
        }
        StateHasChanged();
    }
    
    private string GetTipoNombre(TipoPrestacion tipo)
    {
        return tipo switch
        {
            TipoPrestacion.Cesantias => "CESANTÍAS",
            TipoPrestacion.InteresesCesantias => "INT. CESANTÍAS",
            TipoPrestacion.PrimaServicios => "PRIMA SERVICIOS",
            TipoPrestacion.Dotacion => "DOTACIÓN",
            TipoPrestacion.AuxilioTransporte => "AUX. TRANSPORTE",
            TipoPrestacion.Bonificacion => "BONIFICACIÓN",
            _ => "-"
        };
    }
    
    private string GetTipoClass(TipoPrestacion tipo)
    {
        return tipo.ToString().ToLower();
    }
    
    private string GetEstadoClass(EstadoPrestacion estado)
    {
        return estado.ToString().ToLower();
    }
}
