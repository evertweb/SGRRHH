@page "/incapacidades"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Server.Components.Shared
@inject IIncapacidadRepository IncapacidadRepository
@inject ISeguimientoIncapacidadRepository SeguimientoRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IPermisoRepository PermisoRepository
@inject IReportService ReportService
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<Incapacidades> Logger

<PageTitle>Incapacidades - SGRRHH</PageTitle>

<div class="incapacidades-container">
    <!-- HEADER -->
    <div class="incapacidades-header">
        <h1 class="incapacidades-title">GESTI√ìN DE INCAPACIDADES M√âDICAS</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn-nuevo" style="background: #0066cc;" @onclick="GenerarReporteCobro">üìä REPORTE COBRO</button>
            <button class="btn-nuevo" @onclick="AbrirModalNueva">+ NUEVA INCAPACIDAD</button>
        </div>
    </div>
    
    <!-- DASHBOARD -->
    <div class="incapacidades-dashboard-grid">
        <div class="incapacidades-stat-card activa">
            <h3>üè• ACTIVAS</h3>
            <div class="incapacidades-stat-number">@estadisticas.TotalActivas</div>
        </div>
        
        <div class="incapacidades-stat-card warning">
            <h3>üìã PEND. TRANSCRIBIR</h3>
            <div class="incapacidades-stat-number">@estadisticas.TotalPendientesTranscribir</div>
        </div>
        
        <div class="incapacidades-stat-card info">
            <h3>üí∞ PEND. COBRO</h3>
            <div class="incapacidades-stat-number">@estadisticas.TotalPendientesCobro</div>
            <div class="incapacidades-stat-amount">$@estadisticas.TotalPorCobrar.ToString("N0")</div>
        </div>
        
        <div class="incapacidades-stat-card success">
            <h3>‚úÖ COBRADO MES</h3>
            <div class="incapacidades-stat-number">$@estadisticas.TotalCobradoMes.ToString("N0")</div>
            <div class="incapacidades-stat-amount">@estadisticas.TotalDiasIncapacidadMes d√≠as</div>
        </div>
    </div>
    
    <!-- TABS -->
    <div class="incapacidades-tabs">
        <button class="@(tabActivo == "activas" ? "active" : "")" @onclick='() => CambiarTab("activas")'>
            ACTIVAS (@estadisticas.TotalActivas)
        </button>
        <button class="@(tabActivo == "transcripcion" ? "active" : "")" @onclick='() => CambiarTab("transcripcion")'>
            PEND. TRANSCRIPCI√ìN (@estadisticas.TotalPendientesTranscribir)
        </button>
        <button class="@(tabActivo == "cobro" ? "active" : "")" @onclick='() => CambiarTab("cobro")'>
            PEND. COBRO (@estadisticas.TotalPendientesCobro)
        </button>
        <button class="@(tabActivo == "historial" ? "active" : "")" @onclick='() => CambiarTab("historial")'>
            HISTORIAL
        </button>
    </div>
    
    <!-- CONTENIDO -->
    <div class="incapacidades-content">
        @if (cargando)
        {
            <div class="incapacidades-loading">Cargando incapacidades...</div>
        }
        else if (!incapacidadesFiltradas.Any())
        {
            <div class="incapacidades-mensaje-vacio">No hay incapacidades en esta categor√≠a</div>
        }
        else
        {
            <table class="incapacidades-tabla">
                <thead>
                    <tr>
                        <th>N√öMERO</th>
                        <th>EMPLEADO</th>
                        <th>TIPO</th>
                        <th>FECHAS</th>
                        <th class="incapacidades-td-centro">D√çAS</th>
                        <th>DIAGN√ìSTICO</th>
                        <th>ESTADO</th>
                        <th class="incapacidades-td-centro">VALOR</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var inc in incapacidadesFiltradas)
                    {
                        <tr @onclick="() => VerDetalle(inc.Id)">
                            <td class="incapacidades-td-numero">
                                @inc.NumeroIncapacidad
                                @if (inc.EsProrroga)
                                {
                                    <span class="incapacidades-badge incapacidades-badge-prorroga">PR√ìRROGA</span>
                                }
                            </td>
                            <td class="incapacidades-td-empleado" title="@inc.EmpleadoNombre">@inc.EmpleadoNombre</td>
                            <td>
                                <span class="incapacidades-badge @GetBadgeTipo(inc.Tipo)">@inc.TipoNombre</span>
                            </td>
                            <td>
                                @inc.FechaInicio.ToString("dd/MM/yy") - @inc.FechaFin.ToString("dd/MM/yy")
                                @if (inc.EstaVencida)
                                {
                                    <span class="incapacidades-badge incapacidades-badge-vencida">VENCIDA</span>
                                }
                                else if (inc.VencePronto)
                                {
                                    <span class="incapacidades-badge incapacidades-badge-vence-pronto">@inc.DiasRestantes d</span>
                                }
                            </td>
                            <td class="incapacidades-td-centro">@inc.TotalDias</td>
                            <td class="incapacidades-td-diagnostico" title="@inc.DiagnosticoDescripcion">@inc.DiagnosticoDescripcion</td>
                            <td>
                                <span class="incapacidades-badge @GetBadgeEstado(inc.Estado)">@inc.EstadoNombre</span>
                                @if (inc.Transcrita && !inc.Cobrada)
                                {
                                    <span class="incapacidades-badge incapacidades-badge-estado-transcrita">TRANSCRITA</span>
                                }
                            </td>
                            <td class="incapacidades-td-monto">
                                @if (inc.ValorPorCobrar.HasValue)
                                {
                                    @:$@inc.ValorPorCobrar.Value.ToString("N0")
                                }
                            </td>
                            <td @onclick:stopPropagation="true">
                                @if (!inc.Transcrita && inc.Estado != EstadoIncapacidad.Cancelada)
                                {
                                    <button class="btn-accion primary" @onclick="() => AbrirModalTranscripcion(inc)">
                                        TRANSCRIBIR
                                    </button>
                                }
                                @if (inc.Transcrita && !inc.Cobrada && inc.Estado != EstadoIncapacidad.Cancelada)
                                {
                                    <button class="btn-accion success" @onclick="() => AbrirModalCobro(inc)">
                                        COBRO
                                    </button>
                                }
                                @if (inc.Estado == EstadoIncapacidad.Activa && !inc.EstaVencida)
                                {
                                    <button class="btn-accion" @onclick="() => AbrirModalProrroga(inc)">
                                        PR√ìRROGA
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- MODAL NUEVA INCAPACIDAD -->
@if (mostrarModalNueva)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span>REGISTRAR NUEVA INCAPACIDAD</span>
                <button @onclick="CerrarModales">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group @(errores.ContainsKey("EmpleadoId") ? "error" : "")">
                        <label>Empleado *</label>
                        <select @bind="nuevaIncapacidad.EmpleadoId">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var emp in empleados)
                            {
                                <option value="@emp.Id">@emp.NombreCompleto (@emp.Cedula)</option>
                            }
                        </select>
                        @if (errores.ContainsKey("EmpleadoId"))
                        {
                            <div class="error-message">@errores["EmpleadoId"]</div>
                        }
                    </div>
                    <div class="form-group @(errores.ContainsKey("TipoIncapacidad") ? "error" : "")">
                        <label>Tipo de Incapacidad *</label>
                        <select @bind="nuevaIncapacidad.TipoIncapacidad">
                            <option value="@TipoIncapacidad.EnfermedadGeneral">Enfermedad General</option>
                            <option value="@TipoIncapacidad.AccidenteTrabajo">Accidente de Trabajo</option>
                            <option value="@TipoIncapacidad.EnfermedadLaboral">Enfermedad Laboral</option>
                            <option value="@TipoIncapacidad.LicenciaMaternidad">Licencia Maternidad</option>
                            <option value="@TipoIncapacidad.LicenciaPaternidad">Licencia Paternidad</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group @(errores.ContainsKey("FechaInicio") ? "error" : "")">
                        <label>Fecha Inicio *</label>
                        <input type="date" @bind="nuevaIncapacidad.FechaInicio" />
                    </div>
                    <div class="form-group @(errores.ContainsKey("FechaFin") ? "error" : "")">
                        <label>Fecha Fin *</label>
                        <input type="date" @bind="nuevaIncapacidad.FechaFin" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Expedici√≥n *</label>
                        <input type="date" @bind="nuevaIncapacidad.FechaExpedicion" />
                    </div>
                    <div class="form-group">
                        <label>C√≥digo CIE-10</label>
                        <input type="text" @bind="nuevaIncapacidad.DiagnosticoCIE10" placeholder="Ej: J00" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Diagn√≥stico / Descripci√≥n *</label>
                    <textarea @bind="nuevaIncapacidad.DiagnosticoDescripcion" placeholder="Descripci√≥n del diagn√≥stico m√©dico..."></textarea>
                    @if (errores.ContainsKey("DiagnosticoDescripcion"))
                    {
                        <div class="error-message">@errores["DiagnosticoDescripcion"]</div>
                    }
                </div>
                
                <div class="form-row">
                    <div class="form-group @(errores.ContainsKey("EntidadEmisora") ? "error" : "")">
                        <label>Entidad Emisora (M√©dico/IPS) *</label>
                        <input type="text" @bind="nuevaIncapacidad.EntidadEmisora" placeholder="Nombre del m√©dico o IPS" />
                    </div>
                    <div class="form-group">
                        <label>Entidad Pagadora (EPS/ARL)</label>
                        <input type="text" @bind="nuevaIncapacidad.EntidadPagadora" placeholder="Nombre de la EPS o ARL" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea @bind="nuevaIncapacidad.Observaciones" placeholder="Observaciones adicionales..."></textarea>
                </div>
                
                <!-- DOCUMENTO ESCANEADO -->
                <div class="form-group">
                    <label>Documento de Incapacidad (Certificado M√©dico)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="btn-accion primary" @onclick="AbrirScannerIncapacidad">
                            üì† ESCANEAR CERTIFICADO
                        </button>
                        @if (documentoEscaneadoBytes != null && scannerContexto == "incapacidad")
                        {
                            <span style="font-size: 11px; color: green;">‚úì @documentoEscaneadoNombre (@FormatFileSize(documentoEscaneadoBytes.Length))</span>
                            <button type="button" class="btn-accion" @onclick="LimpiarDocumentoEscaneado" style="padding: 2px 6px;">√ó</button>
                        }
                        else
                        {
                            <span style="font-size: 10px; color: #666;">(Opcional - puede escanear el certificado f√≠sico)</span>
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn-submit" @onclick="GuardarNuevaIncapacidad">GUARDAR INCAPACIDAD</button>
            </div>
        </div>
    </div>
}

<!-- MODAL TRANSCRIPCI√ìN -->
@if (mostrarModalTranscripcion && incapacidadSeleccionada != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span>REGISTRAR TRANSCRIPCI√ìN - @incapacidadSeleccionada.NumeroIncapacidad</span>
                <button @onclick="CerrarModales">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Transcripci√≥n *</label>
                        <input type="date" @bind="transcripcionDto.FechaTranscripcion" />
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de Radicado</label>
                        <input type="text" @bind="transcripcionDto.NumeroRadicado" placeholder="N√∫mero de radicado EPS/ARL" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea @bind="transcripcionDto.Observaciones" placeholder="Observaciones de la transcripci√≥n..."></textarea>
                </div>
                
                <!-- DOCUMENTO ESCANEADO TRANSCRIPCI√ìN -->
                <div class="form-group">
                    <label>Documento de Radicaci√≥n</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="btn-accion primary" @onclick="AbrirScannerTranscripcion">
                            üì† ESCANEAR RADICADO
                        </button>
                        @if (documentoEscaneadoBytes != null && scannerContexto == "transcripcion")
                        {
                            <span style="font-size: 11px; color: green;">‚úì @documentoEscaneadoNombre (@FormatFileSize(documentoEscaneadoBytes.Length))</span>
                            <button type="button" class="btn-accion" @onclick="LimpiarDocumentoEscaneado" style="padding: 2px 6px;">√ó</button>
                        }
                        else
                        {
                            <span style="font-size: 10px; color: #666;">(Opcional)</span>
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn-submit" @onclick="GuardarTranscripcion">REGISTRAR TRANSCRIPCI√ìN</button>
            </div>
        </div>
    </div>
}

<!-- MODAL COBRO -->
@if (mostrarModalCobro && incapacidadSeleccionada != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span>REGISTRAR COBRO - @incapacidadSeleccionada.NumeroIncapacidad</span>
                <button @onclick="CerrarModales">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Cobro *</label>
                        <input type="date" @bind="cobroDto.FechaCobro" />
                    </div>
                    <div class="form-group">
                        <label>Valor Cobrado *</label>
                        <input type="number" @bind="cobroDto.ValorCobrado" step="1000" placeholder="0" />
                    </div>
                </div>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">
                    Valor esperado: $@((incapacidadSeleccionada.ValorPorCobrar ?? 0).ToString("N0"))
                </p>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea @bind="cobroDto.Observaciones" placeholder="Observaciones del cobro..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn-submit" @onclick="GuardarCobro">REGISTRAR COBRO</button>
            </div>
        </div>
    </div>
}

<!-- MODAL PR√ìRROGA -->
@if (mostrarModalProrroga && incapacidadSeleccionada != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span>REGISTRAR PR√ìRROGA - @incapacidadSeleccionada.NumeroIncapacidad</span>
                <button @onclick="CerrarModales">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size:11px; background:#f0f8ff; padding:10px; margin-bottom:15px; border:1px solid #0066cc;">
                    üìã Incapacidad original: @incapacidadSeleccionada.NumeroIncapacidad 
                    (@incapacidadSeleccionada.FechaInicio.ToString("dd/MM/yy") - @incapacidadSeleccionada.FechaFin.ToString("dd/MM/yy"))
                    - @incapacidadSeleccionada.TotalDias d√≠as
                </p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Inicio Pr√≥rroga *</label>
                        <input type="date" @bind="prorrogaDto.FechaInicio" />
                    </div>
                    <div class="form-group">
                        <label>Fecha Fin Pr√≥rroga *</label>
                        <input type="date" @bind="prorrogaDto.FechaFin" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Expedici√≥n *</label>
                        <input type="date" @bind="prorrogaDto.FechaExpedicion" />
                    </div>
                    <div class="form-group">
                        <label>C√≥digo CIE-10</label>
                        <input type="text" @bind="prorrogaDto.DiagnosticoCIE10" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Diagn√≥stico / Descripci√≥n *</label>
                    <textarea @bind="prorrogaDto.DiagnosticoDescripcion"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Entidad Emisora (M√©dico/IPS) *</label>
                    <input type="text" @bind="prorrogaDto.EntidadEmisora" />
                </div>
                
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea @bind="prorrogaDto.Observaciones"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn-submit" @onclick="GuardarProrroga">REGISTRAR PR√ìRROGA</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DETALLE -->
@if (mostrarModalDetalle && detalleIncapacidad != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-container" style="max-width:1000px;" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span>DETALLE INCAPACIDAD - @detalleIncapacidad.NumeroIncapacidad</span>
                <button @onclick="CerrarModales">√ó</button>
            </div>
            <div class="modal-body">
                <div class="incapacidades-detalle-grid">
                    <div class="incapacidades-detalle-section">
                        <h4>üìã INFORMACI√ìN GENERAL</h4>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Empleado:</span>
                            <span class="value">@detalleIncapacidad.EmpleadoNombre</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">C√©dula:</span>
                            <span class="value">@detalleIncapacidad.EmpleadoCedula</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Cargo:</span>
                            <span class="value">@detalleIncapacidad.EmpleadoCargo</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Tipo:</span>
                            <span class="value">@detalleIncapacidad.TipoNombre</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Estado:</span>
                            <span class="value">@detalleIncapacidad.EstadoNombre</span>
                        </div>
                    </div>
                    
                    <div class="incapacidades-detalle-section">
                        <h4>üìÖ FECHAS Y D√çAS</h4>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Fecha Inicio:</span>
                            <span class="value">@detalleIncapacidad.FechaInicio.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Fecha Fin:</span>
                            <span class="value">@detalleIncapacidad.FechaFin.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Total D√≠as:</span>
                            <span class="value">@detalleIncapacidad.TotalDias</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">D√≠as Empresa:</span>
                            <span class="value">@detalleIncapacidad.DiasEmpresa</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">D√≠as EPS/ARL:</span>
                            <span class="value">@detalleIncapacidad.DiasEpsArl</span>
                        </div>
                        @if (detalleIncapacidad.EsProrroga)
                        {
                            <div class="incapacidades-detalle-row">
                                <span class="label">D√≠as Acumulados:</span>
                                <span class="value"><strong>@detalleIncapacidad.TotalDiasAcumulados</strong></span>
                            </div>
                        }
                    </div>
                    
                    <div class="incapacidades-detalle-section">
                        <h4>üè• DIAGN√ìSTICO</h4>
                        <div class="incapacidades-detalle-row">
                            <span class="label">CIE-10:</span>
                            <span class="value">@(detalleIncapacidad.DiagnosticoCIE10 ?? "N/A")</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Descripci√≥n:</span>
                            <span class="value">@detalleIncapacidad.DiagnosticoDescripcion</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Emisor:</span>
                            <span class="value">@detalleIncapacidad.EntidadEmisora</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Pagador:</span>
                            <span class="value">@(detalleIncapacidad.EntidadPagadora ?? "N/A")</span>
                        </div>
                    </div>
                    
                    <div class="incapacidades-detalle-section">
                        <h4>üí∞ VALORES</h4>
                        <div class="incapacidades-detalle-row">
                            <span class="label">% Pago:</span>
                            <span class="value">@detalleIncapacidad.PorcentajePago%</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Valor D√≠a:</span>
                            <span class="value">$@((detalleIncapacidad.ValorDiaBase ?? 0).ToString("N0"))</span>
                        </div>
                        <div class="incapacidades-detalle-row">
                            <span class="label">Valor a Cobrar:</span>
                            <span class="value"><strong>$@((detalleIncapacidad.ValorTotalCobrar ?? 0).ToString("N0"))</strong></span>
                        </div>
                        @if (detalleIncapacidad.Cobrada)
                        {
                            <div class="incapacidades-detalle-row">
                                <span class="label">Valor Cobrado:</span>
                                <span class="value" style="color:green;"><strong>$@((detalleIncapacidad.ValorCobrado ?? 0).ToString("N0"))</strong></span>
                            </div>
                        }
                    </div>
                </div>
                
                @if (detalleIncapacidad.Seguimientos.Any())
                {
                    <div class="incapacidades-detalle-section" style="margin-top:20px;">
                        <h4>üìú HISTORIAL</h4>
                        <div class="incapacidades-timeline">
                            @foreach (var seg in detalleIncapacidad.Seguimientos)
                            {
                                <div class="incapacidades-timeline-item @seg.TipoAccionNombre.ToLower().Replace(" ", "")">
                                    <div class="incapacidades-timeline-fecha">@seg.FechaAccion.ToString("dd/MM/yyyy HH:mm")</div>
                                    <div class="incapacidades-timeline-accion">@seg.TipoAccionNombre</div>
                                    <div class="incapacidades-timeline-desc">@seg.Descripcion - @seg.RealizadoPorNombre</div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModales">CERRAR</button>
            </div>
        </div>
    </div>
}

<!-- SCANNER MODAL -->
<ScannerModal @bind-IsVisible="mostrarScannerModal"
              AllowMultiplePages="true"
              Titulo="ESCANEAR DOCUMENTO M√âDICO"
              OnScanComplete="OnScanComplete"
              OnPdfGenerated="OnPdfGenerated" />

@code {
    // ===== ESTADO =====
    [SupplyParameterFromQuery(Name = "tab")]
    public string? TabQuery { get; set; }
    
    private EstadisticasIncapacidades estadisticas = new();
    private List<IncapacidadResumen> incapacidadesFiltradas = new();
    private List<Empleado> empleados = new();
    private string tabActivo = "activas";
    private bool cargando = true;
    private int usuarioId = 1;
    private static readonly HashSet<string> _tabsValidos = new() { "activas", "transcripcion", "cobro", "historial" };
    
    // Modales
    private bool mostrarModalNueva;
    private bool mostrarModalTranscripcion;
    private bool mostrarModalCobro;
    private bool mostrarModalProrroga;
    private bool mostrarModalDetalle;
    
    // Scanner Modal
    private bool mostrarScannerModal;
    private string scannerContexto = "incapacidad"; // "incapacidad" o "transcripcion"
    private byte[]? documentoEscaneadoBytes;
    private string? documentoEscaneadoNombre;
    
    // DTOs
    private CrearIncapacidadDto nuevaIncapacidad = new();
    private RegistrarTranscripcionDto transcripcionDto = new();
    private RegistrarCobroDto cobroDto = new();
    private CrearProrrogaDto prorrogaDto = new();
    private IncapacidadResumen? incapacidadSeleccionada;
    private IncapacidadDetalleDto? detalleIncapacidad;
    
    // Errores
    private Dictionary<string, string> errores = new();
    
    // ===== LIFECYCLE =====
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!AuthService.IsAuthenticated || AuthService.CurrentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }
            usuarioId = AuthService.CurrentUserId ?? 1;
            
            // Leer tab desde URL
            if (!string.IsNullOrEmpty(TabQuery) && _tabsValidos.Contains(TabQuery))
            {
                tabActivo = TabQuery;
            }
            
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar p√°gina de incapacidades");
        }
    }
    
    private async Task CargarDatos()
    {
        cargando = true;
        try
        {
            estadisticas = await IncapacidadRepository.GetEstadisticasAsync();
            empleados = (await EmpleadoRepository.GetAllActiveAsync()).ToList();
            await FiltrarPorTab();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos de incapacidades");
        }
        finally
        {
            cargando = false;
        }
    }
    
    private async Task FiltrarPorTab()
    {
        incapacidadesFiltradas = tabActivo switch
        {
            "activas" => (await IncapacidadRepository.GetActivasAsync()).ToList(),
            "transcripcion" => (await IncapacidadRepository.GetPendientesTranscripcionAsync()).ToList(),
            "cobro" => (await IncapacidadRepository.GetPendientesCobroAsync()).ToList(),
            "historial" => (await IncapacidadRepository.GetAllWithFiltersAsync()).ToList(),
            _ => new List<IncapacidadResumen>()
        };
    }
    
    private async Task CambiarTab(string tab)
    {
        tabActivo = tab;
        var uri = Navigation.GetUriWithQueryParameter("tab", tab);
        Navigation.NavigateTo(uri, replace: true);
        await FiltrarPorTab();
    }
    
    // ===== HELPERS CSS =====
    
    private string GetBadgeTipo(TipoIncapacidad tipo) => tipo switch
    {
        TipoIncapacidad.EnfermedadGeneral => "incapacidades-badge-tipo-eg",
        TipoIncapacidad.AccidenteTrabajo => "incapacidades-badge-tipo-at",
        TipoIncapacidad.EnfermedadLaboral => "incapacidades-badge-tipo-el",
        TipoIncapacidad.LicenciaMaternidad => "incapacidades-badge-tipo-lm",
        TipoIncapacidad.LicenciaPaternidad => "incapacidades-badge-tipo-lp",
        _ => ""
    };
    
    private string GetBadgeEstado(EstadoIncapacidad estado) => estado switch
    {
        EstadoIncapacidad.Activa => "incapacidades-badge-estado-activa",
        EstadoIncapacidad.Finalizada => "incapacidades-badge-estado-finalizada",
        EstadoIncapacidad.Transcrita => "incapacidades-badge-estado-transcrita",
        EstadoIncapacidad.Cobrada => "incapacidades-badge-estado-cobrada",
        EstadoIncapacidad.Cancelada => "incapacidades-badge-estado-cancelada",
        _ => ""
    };
    
    // ===== MODALES =====
    
    private void AbrirModalNueva()
    {
        nuevaIncapacidad = new CrearIncapacidadDto
        {
            FechaInicio = DateTime.Today,
            FechaFin = DateTime.Today,
            FechaExpedicion = DateTime.Today,
            TipoIncapacidad = TipoIncapacidad.EnfermedadGeneral
        };
        errores.Clear();
        mostrarModalNueva = true;
    }
    
    private void AbrirModalTranscripcion(IncapacidadResumen inc)
    {
        incapacidadSeleccionada = inc;
        transcripcionDto = new RegistrarTranscripcionDto
        {
            IncapacidadId = inc.Id,
            FechaTranscripcion = DateTime.Today
        };
        mostrarModalTranscripcion = true;
    }
    
    private void AbrirModalCobro(IncapacidadResumen inc)
    {
        incapacidadSeleccionada = inc;
        cobroDto = new RegistrarCobroDto
        {
            IncapacidadId = inc.Id,
            FechaCobro = DateTime.Today,
            ValorCobrado = inc.ValorPorCobrar ?? 0
        };
        mostrarModalCobro = true;
    }
    
    private void AbrirModalProrroga(IncapacidadResumen inc)
    {
        incapacidadSeleccionada = inc;
        prorrogaDto = new CrearProrrogaDto
        {
            IncapacidadAnteriorId = inc.Id,
            FechaInicio = inc.FechaFin.AddDays(1),
            FechaFin = inc.FechaFin.AddDays(7),
            FechaExpedicion = DateTime.Today,
            DiagnosticoDescripcion = inc.DiagnosticoDescripcion ?? "",
            EntidadEmisora = inc.EntidadEmisora ?? ""
        };
        mostrarModalProrroga = true;
    }
    
    private async Task VerDetalle(int incapacidadId)
    {
        try
        {
            detalleIncapacidad = await IncapacidadRepository.GetDetalleAsync(incapacidadId);
            if (detalleIncapacidad != null)
            {
                mostrarModalDetalle = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar detalle de incapacidad {Id}", incapacidadId);
        }
    }
    
    private void CerrarModales()
    {
        mostrarModalNueva = false;
        mostrarModalTranscripcion = false;
        mostrarModalCobro = false;
        mostrarModalProrroga = false;
        mostrarModalDetalle = false;
        incapacidadSeleccionada = null;
        detalleIncapacidad = null;
        // Limpiar documento escaneado
        documentoEscaneadoBytes = null;
        documentoEscaneadoNombre = null;
    }
    
    // ===== GUARDAR =====
    
    private async Task GuardarNuevaIncapacidad()
    {
        errores.Clear();
        
        // Validaciones
        if (nuevaIncapacidad.EmpleadoId <= 0)
            errores["EmpleadoId"] = "Seleccione un empleado";
        if (string.IsNullOrWhiteSpace(nuevaIncapacidad.DiagnosticoDescripcion))
            errores["DiagnosticoDescripcion"] = "Ingrese el diagn√≥stico";
        if (string.IsNullOrWhiteSpace(nuevaIncapacidad.EntidadEmisora))
            errores["EntidadEmisora"] = "Ingrese la entidad emisora";
        if (nuevaIncapacidad.FechaFin < nuevaIncapacidad.FechaInicio)
            errores["FechaFin"] = "Fecha fin debe ser mayor o igual a fecha inicio";
        
        if (errores.Any()) return;
        
        try
        {
            var incapacidad = new Incapacidad
            {
                NumeroIncapacidad = await IncapacidadRepository.GenerarNumeroIncapacidadAsync(),
                EmpleadoId = nuevaIncapacidad.EmpleadoId,
                FechaInicio = nuevaIncapacidad.FechaInicio,
                FechaFin = nuevaIncapacidad.FechaFin,
                TotalDias = (int)(nuevaIncapacidad.FechaFin.Date - nuevaIncapacidad.FechaInicio.Date).TotalDays + 1,
                FechaExpedicion = nuevaIncapacidad.FechaExpedicion,
                DiagnosticoCIE10 = nuevaIncapacidad.DiagnosticoCIE10,
                DiagnosticoDescripcion = nuevaIncapacidad.DiagnosticoDescripcion,
                TipoIncapacidad = nuevaIncapacidad.TipoIncapacidad,
                EntidadEmisora = nuevaIncapacidad.EntidadEmisora,
                EntidadPagadora = nuevaIncapacidad.EntidadPagadora,
                Observaciones = nuevaIncapacidad.Observaciones,
                RegistradoPorId = usuarioId,
                Estado = EstadoIncapacidad.Activa
            };
            
            // Calcular distribuci√≥n de d√≠as
            incapacidad.CalcularDistribucionDias();
            
            // Guardar documento escaneado si existe
            if (documentoEscaneadoBytes != null && scannerContexto == "incapacidad")
            {
                try
                {
                    var fileName = documentoEscaneadoNombre ?? $"INC_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
                    var storageResult = await StorageService.SaveDocumentoEmpleadoAsync(
                        nuevaIncapacidad.EmpleadoId,
                        "Incapacidad",
                        documentoEscaneadoBytes,
                        fileName);
                    
                    if (storageResult.IsSuccess)
                    {
                        incapacidad.DocumentoIncapacidadPath = storageResult.Value;
                        Logger.LogInformation("Documento de incapacidad guardado: {Path}", storageResult.Value);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Error al guardar documento escaneado, continuando sin √©l");
                }
            }
            
            // Guardar
            await IncapacidadRepository.AddAsync(incapacidad);
            
            // Registrar seguimiento
            await SeguimientoRepository.RegistrarAccionAsync(
                incapacidad.Id,
                TipoAccionSeguimientoIncapacidad.Registro,
                $"Incapacidad registrada: {incapacidad.TotalDias} d√≠as",
                usuarioId);
            
            Logger.LogInformation("Incapacidad {Numero} creada", incapacidad.NumeroIncapacidad);
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar nueva incapacidad");
            errores["General"] = ErrorTranslationService.Translate(ex);
        }
    }
    
    private async Task GuardarTranscripcion()
    {
        try
        {
            await IncapacidadRepository.RegistrarTranscripcionAsync(transcripcionDto, usuarioId);
            Logger.LogInformation("Transcripci√≥n registrada para incapacidad {Id}", transcripcionDto.IncapacidadId);
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar transcripci√≥n");
        }
    }
    
    private async Task GuardarCobro()
    {
        try
        {
            await IncapacidadRepository.RegistrarCobroAsync(cobroDto, usuarioId);
            Logger.LogInformation("Cobro registrado para incapacidad {Id}", cobroDto.IncapacidadId);
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar cobro");
        }
    }
    
    private async Task GuardarProrroga()
    {
        try
        {
            await IncapacidadRepository.CrearProrrogaAsync(prorrogaDto.IncapacidadAnteriorId, prorrogaDto, usuarioId);
            Logger.LogInformation("Pr√≥rroga registrada para incapacidad {Id}", prorrogaDto.IncapacidadAnteriorId);
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar pr√≥rroga");
        }
    }
    
    // ===== REPORTES =====
    
    private async Task GenerarReporteCobro()
    {
        try
        {
            var a√±o = DateTime.Now.Year;
            var mes = DateTime.Now.Month;
            
            var result = await ReportService.GenerarReporteCobroIncapacidadesExcel(a√±o, mes);
            
            if (result.IsSuccess && result.Value != null)
            {
                var fileName = $"Reporte_Cobro_Incapacidades_{a√±o}_{mes:D2}.xlsx";
                var base64 = Convert.ToBase64String(result.Value);
                
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, 
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", base64);
                
                Logger.LogInformation("Reporte de cobro generado: {FileName}", fileName);
            }
            else
            {
                Logger.LogWarning("Error al generar reporte de cobro: {Message}", result.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de cobro");
        }
    }
    
    // ===== SCANNER =====
    
    private void AbrirScannerIncapacidad()
    {
        scannerContexto = "incapacidad";
        mostrarScannerModal = true;
    }
    
    private void AbrirScannerTranscripcion()
    {
        scannerContexto = "transcripcion";
        mostrarScannerModal = true;
    }
    
    private void LimpiarDocumentoEscaneado()
    {
        documentoEscaneadoBytes = null;
        documentoEscaneadoNombre = null;
    }
    
    private Task OnScanComplete(List<ScannedPageDto> pages)
    {
        // Si son im√°genes individuales, usar la primera
        if (pages.Count > 0)
        {
            documentoEscaneadoBytes = pages[0].ImageBytes;
            documentoEscaneadoNombre = $"Escaneado_{DateTime.Now:yyyyMMdd_HHmmss}.jpg";
            Logger.LogInformation("Documento escaneado: {Name} ({Size} bytes)", 
                documentoEscaneadoNombre, documentoEscaneadoBytes.Length);
        }
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private Task OnPdfGenerated(byte[] pdfBytes)
    {
        documentoEscaneadoBytes = pdfBytes;
        documentoEscaneadoNombre = $"Incapacidad_Escaneada_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
        Logger.LogInformation("PDF escaneado listo: {Name} ({Size} bytes)", 
            documentoEscaneadoNombre, documentoEscaneadoBytes.Length);
        
        // Mostrar confirmaci√≥n visual
        // TODO: Agregar MessageToast a esta p√°gina
        // messageToast?.ShowSuccess($"‚úì PDF escaneado listo ({FormatFileSize(pdfBytes.Length)})");
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }
}
