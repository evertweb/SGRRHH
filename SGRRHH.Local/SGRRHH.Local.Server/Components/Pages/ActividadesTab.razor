@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IActividadRepository ActividadRepository
@inject ICategoriaActividadRepository CategoriaActividadRepository
@inject ICatalogCacheService CatalogCache
@inject IDataSyncNotifier DataSync
@inject ILogger<ActividadesTab> Logger
@inject IJSRuntime JSRuntime

<!-- Toolbar -->
<div class="hospital-toolbar">
    <div class="hospital-toolbar-group">
        <button @onclick="Nuevo">NUEVO</button>
        <button @onclick="CargarDatos">ACTUALIZAR</button>
        @if (selectedItem != null)
        {
            <button @onclick="EditarSeleccionado">EDITAR</button>
            <button @onclick="() => ConfirmarEliminar(selectedItem)">ELIMINAR</button>
        }
    </div>
    <div class="hospital-toolbar-group">
        <input type="text" placeholder="BUSCAR..." 
               @bind="searchTerm" @bind:event="oninput" @bind:after="Filtrar" />
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <button @onclick="LimpiarBusqueda">LIMPIAR</button>
        }
        <select @bind="filtroCategoriaId" @bind:after="Filtrar">
            <option value="0">TODAS LAS CATEGORÍAS</option>
            @foreach (var cat in categoriasEntidad.OrderBy(c => c.Orden))
            {
                <option value="@cat.Id">@cat.Nombre</option>
            }
        </select>
        <label class="checkbox-inline">
            <input type="checkbox" @bind="mostrarSoloDestacadas" @bind:after="Filtrar" />
            SOLO DESTACADAS
        </label>
    </div>
</div>

<!-- Tabla -->
<table class="hospital-table">
    <thead>
        <tr>
            <th>CÓDIGO</th>
            <th>NOMBRE</th>
            <th>CATEGORÍA</th>
            <th>UNIDAD</th>
            <th>REND. ESPERADO</th>
            <th class="text-center">REQ. PROYECTO</th>
            <th class="text-center">REQ. CANTIDAD</th>
            <th>ACCIONES</th>
        </tr>
    </thead>
    <tbody>
        @if (isLoading)
        {
            <tr><td colspan="8" class="loading">CARGANDO ACTIVIDADES...</td></tr>
        }
        else if (!itemsFiltrados.Any())
        {
            <tr><td colspan="8" class="empty-state">NO HAY ACTIVIDADES PARA MOSTRAR</td></tr>
        }
        else
        {
            @foreach (var item in itemsFiltrados)
            {
                <tr class="@(selectedItem?.Id == item.Id ? "selected" : "")"
                    @onclick="() => SelectItem(item)">
                    <td><strong>@item.Codigo</strong></td>
                    <td>
                        @item.Nombre
                        @if (item.EsDestacada) { <span class="badge badge-destacado" title="DESTACADA">★</span> }
                    </td>
                    <td>
                        @if (item.Categoria != null)
                        {
                            <span style="color: @(item.Categoria.ColorHex ?? "#000"); font-weight: bold;">
                                @item.Categoria.Nombre
                            </span>
                        }
                        else
                        {
                            <span>@(item.CategoriaTexto ?? "-")</span>
                        }
                    </td>
                    <td>@(item.UnidadAbreviatura ?? "-")</td>
                    <td>
                        @if (item.RendimientoEsperado.HasValue)
                        {
                            <text>@item.RendimientoEsperado.Value.ToString("F2") @(item.UnidadAbreviatura ?? "")/h</text>
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </td>
                    <td class="text-center">
                        @if (item.RequiereProyecto)
                        {
                            <span class="badge badge-activo">SÍ</span>
                        }
                        else
                        {
                            <span class="badge badge-inactivo">NO</span>
                        }
                    </td>
                    <td class="text-center">
                        @if (item.RequiereCantidad)
                        {
                            <span class="badge badge-activo">SÍ</span>
                        }
                        else
                        {
                            <span class="badge badge-inactivo">NO</span>
                        }
                    </td>
                    <td class="table-actions">
                        <button @onclick="() => Editar(item)" @onclick:stopPropagation="true">
                            EDITAR
                        </button>
                        <button @onclick="() => ConfirmarEliminar(item)" @onclick:stopPropagation="true">
                            ELIMINAR
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Modal de edición -->
<FormModal @bind-IsVisible="showModal" 
           Title="@(isEditing ? $"EDITAR ACTIVIDAD - {editItem?.Codigo}" : "NUEVA ACTIVIDAD")"
           OnSaveClicked="Guardar"
           OnCancelClicked="CerrarModal"
           IsSaving="isSaving">
    
    @if (editItem != null)
    {
        <div class="grid-2">
            <div>
                <div class="hospital-form-group required">
                    <label>CÓDIGO</label>
                    <input type="text" id="codigoInput" @bind="editItem.Codigo" maxlength="20" 
                           readonly="@isEditing" disabled="@isSaving" />
                </div>
                
                <div class="hospital-form-group required">
                    <label>NOMBRE</label>
                    <input type="text" id="nombreInput" @bind="editItem.Nombre" maxlength="200" 
                           disabled="@isSaving" />
                </div>
                
                <div class="hospital-form-group">
                    <label>CATEGORÍA</label>
                    <select @bind="editItem.CategoriaId" disabled="@isSaving">
                        <option value="">-- SIN CATEGORÍA --</option>
                        @foreach (var cat in categoriasEntidad.OrderBy(c => c.Orden))
                        {
                            <option value="@cat.Id">@cat.Nombre</option>
                        }
                    </select>
                    <small>Agrupa actividades por tipo de trabajo</small>
                </div>
                
                <div class="hospital-form-group">
                    <label>UNIDAD DE MEDIDA</label>
                    <select @bind="editItem.UnidadMedida" @bind:after="OnUnidadMedidaChanged" disabled="@isSaving">
                        @foreach (var unidad in Enum.GetValues<UnidadMedidaActividad>())
                        {
                            <option value="@unidad">@GetUnidadNombre(unidad)</option>
                        }
                    </select>
                </div>
                
                <div class="hospital-form-group">
                    <label>ABREVIATURA UNIDAD</label>
                    <input type="text" @bind="editItem.UnidadAbreviatura" maxlength="10" 
                           disabled="@isSaving" 
                           placeholder="Ej: ha, árb, m³" />
                    <small>Abreviatura para mostrar en reportes</small>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label>RENDIMIENTO ESPERADO</label>
                    <input type="number" step="0.01" @bind="editItem.RendimientoEsperado" min="0" 
                           disabled="@isSaving" />
                    <small>Cantidad esperada por hora/hombre</small>
                </div>
                
                <div class="form-group">
                    <label>RENDIMIENTO MÍNIMO</label>
                    <input type="number" step="0.01" @bind="editItem.RendimientoMinimo" min="0" 
                           disabled="@isSaving" />
                    <small>Mínimo aceptable para productividad</small>
                </div>
                
                <div class="form-group">
                    <label>ORDEN</label>
                    <input type="number" @bind="editItem.Orden" min="0" 
                           disabled="@isSaving" />
                    <small>Para ordenar en listas</small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="reqProyecto" @bind="editItem.RequiereProyecto" 
                               disabled="@isSaving" />
                        <label for="reqProyecto">REQUIERE PROYECTO</label>
                    </div>
                    <small>Debe asignarse a un proyecto al registrar</small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="reqCantidad" @bind="editItem.RequiereCantidad" 
                               disabled="@isSaving" />
                        <label for="reqCantidad">REQUIERE CANTIDAD</label>
                    </div>
                    <small>Debe ingresar cantidad además de horas</small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="esDestacada" @bind="editItem.EsDestacada" 
                               disabled="@isSaving" />
                        <label for="esDestacada">ACTIVIDAD DESTACADA</label>
                    </div>
                    <small>Aparece primero en listas de selección</small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="activoAct" @bind="editItem.Activo" 
                               disabled="@isSaving" />
                        <label for="activoAct">ACTIVO</label>
                    </div>
                    <small>Solo las actividades activas pueden usarse</small>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>DESCRIPCIÓN</label>
            <textarea @bind="editItem.Descripcion" rows="3" 
                     disabled="@isSaving" 
                     maxlength="500"></textarea>
        </div>
    }
</FormModal>

<!-- Modal de confirmación de eliminación -->
<FormModal @bind-IsVisible="showConfirmModal"
           Title="CONFIRMAR ELIMINACIÓN"
           OnSaveClicked="EliminarConfirmado"
           OnCancelClicked="() => showConfirmModal = false"
           IsSaving="isSaving">
    <p>¿Está seguro que desea eliminar la actividad <strong>@itemToDelete?.Nombre</strong>?</p>
    <p class="text-danger">
        <strong>Advertencia:</strong> Esta acción no se puede deshacer.
    </p>
</FormModal>

@code {
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public EventCallback<string?> ErrorMessageChanged { get; set; }
    [Parameter] public string? SuccessMessage { get; set; }
    [Parameter] public EventCallback<string?> SuccessMessageChanged { get; set; }
    
    private List<Actividad> items = new();
    private List<Actividad> itemsFiltrados = new();
    private List<CategoriaActividad> categoriasEntidad = new();
    private Actividad? selectedItem;
    private Actividad? editItem;
    private Actividad? itemToDelete;
    
    private bool isLoading;
    private bool showModal;
    private bool showConfirmModal;
    private bool isSaving;
    private bool isEditing;
    private bool mostrarSoloDestacadas;
    private string searchTerm = "";
    private int filtroCategoriaId = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }
    
    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Cargar categorías
            var cats = await CategoriaActividadRepository.GetAllActiveAsync();
            categoriasEntidad = cats.ToList();
            
            // Cargar actividades con sus categorías
            var actividades = await ActividadRepository.GetAllWithCategoriaAsync();
            items = actividades.OrderBy(a => a.Categoria?.Orden ?? 999).ThenBy(a => a.Orden).ThenBy(a => a.Nombre).ToList();
            
            Filtrar();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar actividades");
            await SetError($"Error al cargar actividades: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void Filtrar()
    {
        itemsFiltrados = items;
        
        if (filtroCategoriaId > 0)
        {
            itemsFiltrados = itemsFiltrados.Where(a => a.CategoriaId == filtroCategoriaId).ToList();
        }
        
        if (mostrarSoloDestacadas)
        {
            itemsFiltrados = itemsFiltrados.Where(a => a.EsDestacada).ToList();
        }
        
        Buscar();
    }
    
    private void Buscar()
    {
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            itemsFiltrados = itemsFiltrados.Where(a => 
                a.Codigo.ToLower().Contains(term) ||
                a.Nombre.ToLower().Contains(term) ||
                (a.Descripcion ?? "").ToLower().Contains(term) ||
                (a.CategoriaTexto ?? "").ToLower().Contains(term) ||
                (a.Categoria?.Nombre ?? "").ToLower().Contains(term)
            ).ToList();
        }
        StateHasChanged();
    }
    
    private void LimpiarBusqueda()
    {
        searchTerm = "";
        Filtrar();
    }
    
    private void SelectItem(Actividad item)
    {
        selectedItem = item;
        StateHasChanged();
    }
    
    private void Nuevo()
    {
        // Calcular próximo orden
        int siguienteOrden = items.Any() ? items.Max(a => a.Orden) + 1 : 1;
        
        editItem = new Actividad
        {
            Activo = true,
            RequiereProyecto = true,
            RequiereCantidad = false,
            EsDestacada = false,
            UnidadMedida = UnidadMedidaActividad.SoloHoras,
            Orden = siguienteOrden,
            FechaCreacion = DateTime.Now
        };
        isEditing = false;
        showModal = true;
        StateHasChanged();
    }
    
    private void Editar(Actividad item)
    {
        editItem = new Actividad
        {
            Id = item.Id,
            Codigo = item.Codigo,
            Nombre = item.Nombre,
            Descripcion = item.Descripcion,
            CategoriaId = item.CategoriaId,
            CategoriaTexto = item.CategoriaTexto,
            UnidadMedida = item.UnidadMedida,
            UnidadAbreviatura = item.UnidadAbreviatura,
            RendimientoEsperado = item.RendimientoEsperado,
            RendimientoMinimo = item.RendimientoMinimo,
            CostoUnitario = item.CostoUnitario,
            RequiereProyecto = item.RequiereProyecto,
            RequiereCantidad = item.RequiereCantidad,
            TiposProyectoAplicables = item.TiposProyectoAplicables,
            EspeciesAplicables = item.EspeciesAplicables,
            Orden = item.Orden,
            EsDestacada = item.EsDestacada,
            Activo = item.Activo,
            FechaCreacion = item.FechaCreacion,
            FechaModificacion = DateTime.Now
        };
        isEditing = true;
        showModal = true;
        StateHasChanged();
    }
    
    private void EditarSeleccionado()
    {
        if (selectedItem != null)
        {
            Editar(selectedItem);
        }
    }
    
    private void OnUnidadMedidaChanged()
    {
        if (editItem == null) return;
        
        // Sugerir abreviatura basada en la unidad seleccionada
        editItem.UnidadAbreviatura = editItem.UnidadMedida switch
        {
            UnidadMedidaActividad.SoloHoras => "",
            UnidadMedidaActividad.Hectareas => "ha",
            UnidadMedidaActividad.Arboles => "árb",
            UnidadMedidaActividad.MetrosLineales => "ml",
            UnidadMedidaActividad.MetrosCubicos => "m³",
            UnidadMedidaActividad.Kilogramos => "kg",
            UnidadMedidaActividad.Litros => "L",
            UnidadMedidaActividad.Plantulas => "plán",
            UnidadMedidaActividad.Bolsas => "bolsas",
            UnidadMedidaActividad.Estacas => "est",
            UnidadMedidaActividad.Cargas => "cargas",
            UnidadMedidaActividad.Viajes => "viajes",
            UnidadMedidaActividad.Unidades => "und",
            _ => ""
        };
        
        // Si la unidad es SoloHoras, no requiere cantidad
        if (editItem.UnidadMedida == UnidadMedidaActividad.SoloHoras)
        {
            editItem.RequiereCantidad = false;
        }
        
        StateHasChanged();
    }
    
    private string GetUnidadNombre(UnidadMedidaActividad unidad)
    {
        return unidad switch
        {
            UnidadMedidaActividad.SoloHoras => "Solo Horas (sin cantidad)",
            UnidadMedidaActividad.Hectareas => "Hectáreas (ha)",
            UnidadMedidaActividad.Arboles => "Árboles (árb)",
            UnidadMedidaActividad.MetrosLineales => "Metros Lineales (ml)",
            UnidadMedidaActividad.MetrosCubicos => "Metros Cúbicos (m³)",
            UnidadMedidaActividad.Kilogramos => "Kilogramos (kg)",
            UnidadMedidaActividad.Litros => "Litros (L)",
            UnidadMedidaActividad.Plantulas => "Plántulas",
            UnidadMedidaActividad.Bolsas => "Bolsas",
            UnidadMedidaActividad.Estacas => "Estacas",
            UnidadMedidaActividad.Cargas => "Cargas",
            UnidadMedidaActividad.Viajes => "Viajes",
            UnidadMedidaActividad.Unidades => "Unidades",
            _ => unidad.ToString()
        };
    }
    
    private async Task Guardar()
    {
        if (editItem == null) return;
        
        // Limpiar errores previos
        await JSRuntime.InvokeVoidAsync("clearAllFieldErrors");
        
        // Validaciones
        if (string.IsNullOrWhiteSpace(editItem.Codigo))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", "EL CÓDIGO ES REQUERIDO");
            return;
        }
        
        if (string.IsNullOrWhiteSpace(editItem.Nombre))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "nombreInput", "EL NOMBRE ES REQUERIDO");
            return;
        }
        
        // Validar código duplicado
        if (await ActividadRepository.ExistsCodigoAsync(editItem.Codigo, isEditing ? editItem.Id : null))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", $"YA EXISTE UNA ACTIVIDAD CON EL CÓDIGO '{editItem.Codigo}'");
            return;
        }
        
        // Si tiene categoría, actualizar el texto de categoría
        if (editItem.CategoriaId.HasValue && editItem.CategoriaId > 0)
        {
            var cat = categoriasEntidad.FirstOrDefault(c => c.Id == editItem.CategoriaId);
            editItem.CategoriaTexto = cat?.Nombre;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            if (isEditing)
            {
                await ActividadRepository.UpdateAsync(editItem);
                
                var itemIndex = items.FindIndex(a => a.Id == editItem.Id);
                if (itemIndex >= 0)
                {
                    var reloaded = await ActividadRepository.GetByIdAsync(editItem.Id);
                    if (reloaded != null) items[itemIndex] = reloaded;
                }
                
                await SetSuccess($"Actividad '{editItem.Nombre}' actualizada correctamente");
                Logger.LogInformation($"Actividad actualizada: {editItem.Codigo}");
            }
            else
            {
                var newItem = await ActividadRepository.AddAsync(editItem);
                
                var reloaded = await ActividadRepository.GetByIdAsync(newItem.Id);
                if (reloaded != null)
                {
                    items.Add(reloaded);
                    items = items.OrderBy(a => a.Categoria?.Orden ?? 999).ThenBy(a => a.Orden).ThenBy(a => a.Nombre).ToList();
                }
                
                await SetSuccess($"Actividad '{editItem.Nombre}' creada correctamente");
                Logger.LogInformation($"Actividad creada: {editItem.Codigo}");
            }
            
            CatalogCache.InvalidateCache(CatalogType.Actividades);
            
            // Notificar cambio en tiempo real
            await DataSync.NotifyChangeAsync("Actividad", isEditing ? "Updated" : "Created", editItem.Id);
            
            Filtrar();
            CerrarModal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar actividad");
            await SetError($"Error al guardar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void ConfirmarEliminar(Actividad item)
    {
        itemToDelete = item;
        showConfirmModal = true;
        StateHasChanged();
    }
    
    private async Task EliminarConfirmado()
    {
        if (itemToDelete == null) return;
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            await ActividadRepository.DeleteAsync(itemToDelete.Id);
            
            items.RemoveAll(a => a.Id == itemToDelete.Id);
            CatalogCache.InvalidateCache(CatalogType.Actividades);
            
            // Notificar eliminación en tiempo real
            await DataSync.NotifyChangeAsync("Actividad", "Deleted", itemToDelete.Id);
            
            await SetSuccess($"Actividad '{itemToDelete.Nombre}' eliminada correctamente");
            Logger.LogInformation($"Actividad eliminada: {itemToDelete.Codigo}");
            
            await CargarDatos();
            showConfirmModal = false;
            itemToDelete = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar actividad");
            await SetError($"Error al eliminar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void CerrarModal()
    {
        showModal = false;
        editItem = null;
        StateHasChanged();
    }
    
    private async Task SetError(string message)
    {
        ErrorMessage = message;
        await ErrorMessageChanged.InvokeAsync(message);
    }
    
    private async Task SetSuccess(string message)
    {
        SuccessMessage = message;
        await SuccessMessageChanged.InvokeAsync(message);
        
        await Task.Delay(3000);
        SuccessMessage = null;
        await SuccessMessageChanged.InvokeAsync(null);
    }
}
