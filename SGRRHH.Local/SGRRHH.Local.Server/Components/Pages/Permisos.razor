@page "/permisos"
@page "/permisos/{PermisoIdParam:int?}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Server.Components.Permisos
@inject IAuthService AuthService
@inject IPermisoRepository PermisoRepository
@inject IReportService ReportService
@inject ICatalogCacheService CatalogCache
@inject NavigationManager Navigation
@inject ILogger<Permisos> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Permisos - SGRRHH</PageTitle>

<div class="permisos-container">
    <PermisosHeader UsuarioNombre="@(AuthService.CurrentUser?.NombreCompleto ?? "N/A")"
                    FechaActual="@DateTime.Now"
                    EsAprobador="@AuthService.IsAprobador"
                    TotalPermisos="@totalPermisos"
                    TotalFiltrados="@totalFiltrados"
                    PendientesAprobacion="@permisosPendientes"
                    TieneSeleccion="@(selectedPermiso != null)"
                    PuedeAprobar="@(selectedPermiso?.Estado == EstadoPermiso.Pendiente)"
                    PuedeGenerarPdf="@(selectedPermiso?.Estado == EstadoPermiso.Aprobado)"
                    OnNuevo="@NuevoPermiso"
                    OnActualizar="@CargarPermisos"
                    OnVerDetalle="@EditarSeleccionado"
                    OnAprobar="@AprobarSeleccionado"
                    OnRechazar="@RechazarSeleccionado"
                    OnGenerarPdf="@GenerarActaPDF" />

    @if (errorMessage != null)
    {
        <div class="error-box">
            <h3 class="error-title">ERROR DEL SISTEMA</h3>
            <p class="error-text">@errorMessage</p>
            <button class="btn" @onclick="() => errorMessage = null">ACEPTAR</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="success-box">
            @successMessage
        </div>
    }

    <PermisosFilters SearchTerm="@searchTerm"
                     SearchTermChanged="@(value => searchTerm = value)"
                     FiltroEstado="@filtroEstado"
                     FiltroEstadoChanged="@(value => filtroEstado = value)"
                     FiltroEmpleadoId="@filtroEmpleadoId"
                     FiltroEmpleadoIdChanged="@(value => filtroEmpleadoId = value)"
                     Empleados="@todosEmpleados"
                     OnBuscar="@Buscar"
                     OnLimpiar="@LimpiarBusqueda"
                     OnFiltrar="@Filtrar"
                     OnSearchKeyUp="@OnSearchKeyUp" />

    <PermisosTable Permisos="@permisos"
                   SelectedPermiso="@selectedPermiso"
                   IsLoading="@isLoading"
                   OnSelect="@SelectPermiso"
                   OnVerDetalle="@VerDetalle"
                   OnGenerarPdf="@GenerarActaDesdeTabla"
                   OnSeguimiento="@AbrirSeguimiento" />
</div>

<PermisoFormModal @ref="formModal"
                  EmpleadosActivos="@empleadosActivos"
                  TiposPermiso="@tiposPermiso"
                  EsAprobador="@AuthService.IsAprobador"
                  OnSolicitarAprobacion="@AbrirAprobacion"
                  OnSolicitarRechazo="@AbrirRechazo"
                  OnGuardado="@HandleGuardado"
                  OnError="@MostrarError"
                  OnSuccess="@MostrarExito" />

<PermisoAprobacionModal @ref="aprobacionModal"
                        OnError="@MostrarError"
                        OnSuccess="@MostrarExito"
                        OnCompleted="@HandleGuardado" />

<PermisoSeguimientoPanel @ref="seguimientoPanel"
                         OnError="@MostrarError" />

@code {
    [Parameter] public int? PermisoIdParam { get; set; }

    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;

    private List<Permiso> permisos = new();
    private List<Permiso> todosLosPermisos = new();
    private List<Empleado> todosEmpleados = new();
    private List<Empleado> empleadosActivos = new();
    private List<TipoPermiso> tiposPermiso = new();

    private string searchTerm = "";
    private string filtroEstado = "";
    private string filtroEmpleadoId = "";

    private int totalPermisos;
    private int totalFiltrados;
    private int permisosPendientes;

    private Permiso? selectedPermiso;

    private PermisoFormModal? formModal;
    private PermisoAprobacionModal? aprobacionModal;
    private PermisoSeguimientoPanel? seguimientoPanel;

    private static Permisos? currentInstance;

    protected override async Task OnInitializedAsync()
    {
        currentInstance = this;

        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await CargarDatosIniciales();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ConfigurarAtajosTeclado();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (PermisoIdParam.HasValue && PermisoIdParam.Value > 0)
        {
            await AbrirDetallePorParametro();
        }
    }

    [JSInvokable("InvokePermisoAction")]
    public static Task InvokePermisoAction(string accion)
    {
        return currentInstance?.HandlePermisoAction(accion) ?? Task.CompletedTask;
    }

    public void Dispose()
    {
        if (currentInstance == this)
        {
            currentInstance = null;
        }
    }

    private async Task HandlePermisoAction(string accion)
    {
        switch (accion)
        {
            case "nuevo":
                await NuevoPermiso();
                break;
            case "detalle":
                await EditarSeleccionado();
                break;
            case "actualizar":
                await CargarPermisos();
                break;
            case "aprobar":
                await AprobarSeleccionado();
                break;
            case "rechazar":
                await RechazarSeleccionado();
                break;
            case "pdf":
                await GenerarActaPDF();
                break;
            case "cerrar":
                Navigation.NavigateTo("/home");
                break;
        }
    }

    private async Task ConfigurarAtajosTeclado()
    {
        var jsCode = @"
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F2') {
                    e.preventDefault();
                    document.getElementById('searchInput')?.focus();
                } else if (e.key === 'F3') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'nuevo');
                } else if (e.key === 'F4') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'detalle');
                } else if (e.key === 'F5') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'actualizar');
                } else if (e.key === 'F6') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'aprobar');
                } else if (e.key === 'F7') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'rechazar');
                } else if (e.key === 'F12') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'pdf');
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    DotNet.invokeMethodAsync('SGRRHH.Local.Server', 'InvokePermisoAction', 'cerrar');
                }
            });
        ";

        try
        {
            await JSRuntime.InvokeVoidAsync("eval", jsCode);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error configurando atajos de teclado");
        }
    }

    private async Task CargarDatosIniciales()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            todosEmpleados = await CatalogCache.GetEmpleadosTodosAsync();
            empleadosActivos = await CatalogCache.GetEmpleadosActivosAsync();
            tiposPermiso = await CatalogCache.GetTiposPermisoAsync();

            await CargarPermisos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando datos iniciales");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CargarPermisos()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var permisosData = await PermisoRepository.GetAllAsync();
            todosLosPermisos = permisosData.OrderByDescending(p => p.FechaSolicitud).ToList();
            AplicarFiltros();

            permisosPendientes = todosLosPermisos.Count(p => p.Estado == EstadoPermiso.Pendiente);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando permisos");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AbrirDetallePorParametro()
    {
        try
        {
            var permiso = await PermisoRepository.GetByIdAsync(PermisoIdParam!.Value);
            if (permiso != null)
            {
                selectedPermiso = permiso;
                await VerDetalle(permiso);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando permiso {Id}", PermisoIdParam);
        }
    }

    private void AplicarFiltros()
    {
        permisos = todosLosPermisos;

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var termino = searchTerm.ToLower();
            permisos = permisos.Where(p =>
                p.NumeroActa.ToLower().Contains(termino) ||
                (p.Empleado?.NombreCompleto ?? "").ToLower().Contains(termino) ||
                (p.Empleado?.Cedula ?? "").ToLower().Contains(termino) ||
                (p.TipoPermiso?.Nombre ?? "").ToLower().Contains(termino) ||
                p.Motivo.ToLower().Contains(termino)
            ).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEstado) && int.TryParse(filtroEstado, out int estadoInt))
        {
            permisos = permisos.Where(p => (int)p.Estado == estadoInt).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEmpleadoId) && int.TryParse(filtroEmpleadoId, out int empId))
        {
            permisos = permisos.Where(p => p.EmpleadoId == empId).ToList();
        }

        totalPermisos = todosLosPermisos.Count;
        totalFiltrados = permisos.Count;
    }

    private Task Buscar()
    {
        AplicarFiltros();
        return Task.CompletedTask;
    }

    private Task Filtrar()
    {
        AplicarFiltros();
        return Task.CompletedTask;
    }

    private Task LimpiarBusqueda()
    {
        searchTerm = "";
        AplicarFiltros();
        return Task.CompletedTask;
    }

    private Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Buscar();
        }
        return Task.CompletedTask;
    }

    private void SelectPermiso(Permiso permiso)
    {
        selectedPermiso = permiso;
        StateHasChanged();
    }

    private async Task NuevoPermiso()
    {
        selectedPermiso = null;
        if (formModal != null)
        {
            await formModal.OpenNuevo();
        }
    }

    private async Task VerDetalle(Permiso permiso)
    {
        selectedPermiso = permiso;
        if (formModal != null)
        {
            await formModal.OpenDetalle(permiso.Id);
        }
    }

    private async Task EditarSeleccionado()
    {
        if (selectedPermiso != null)
        {
            await VerDetalle(selectedPermiso);
        }
    }

    private async Task AprobarSeleccionado()
    {
        if (selectedPermiso?.Estado == EstadoPermiso.Pendiente && AuthService.IsAprobador)
        {
            var permiso = await PermisoRepository.GetByIdAsync(selectedPermiso.Id);
            if (permiso != null)
            {
                AbrirAprobacion(permiso);
            }
        }
    }

    private async Task RechazarSeleccionado()
    {
        if (selectedPermiso?.Estado == EstadoPermiso.Pendiente && AuthService.IsAprobador)
        {
            var permiso = await PermisoRepository.GetByIdAsync(selectedPermiso.Id);
            if (permiso != null)
            {
                AbrirRechazo(permiso);
            }
        }
    }

    private void AbrirAprobacion(Permiso permiso)
    {
        aprobacionModal?.OpenAprobacion(permiso, tiposPermiso);
    }

    private void AbrirRechazo(Permiso permiso)
    {
        aprobacionModal?.OpenRechazo(permiso);
    }

    private async Task AbrirSeguimiento(Permiso permiso)
    {
        if (seguimientoPanel != null)
        {
            await seguimientoPanel.Open(permiso.Id);
        }
    }

    private async Task HandleGuardado()
    {
        await CargarPermisos();
    }

    private Task MostrarError(string mensaje)
    {
        errorMessage = mensaje;
        successMessage = null;
        return Task.CompletedTask;
    }

    private Task MostrarExito(string mensaje)
    {
        successMessage = mensaje;
        errorMessage = null;
        StateHasChanged();
        _ = Task.Delay(3000).ContinueWith(_ => { successMessage = null; StateHasChanged(); });
        return Task.CompletedTask;
    }

    private async Task GenerarActaPDF()
    {
        if (selectedPermiso?.Estado == EstadoPermiso.Aprobado)
        {
            await GenerarActa(selectedPermiso.Id);
        }
    }

    private async Task GenerarActaDesdeTabla(Permiso permiso)
    {
        if (permiso.Estado == EstadoPermiso.Aprobado)
        {
            await GenerarActa(permiso.Id);
        }
    }

    private async Task GenerarActa(int permisoId)
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var result = await ReportService.GenerarActaPermisoAsync(permisoId);

            if (result.IsSuccess && result.Value != null)
            {
                var permiso = await PermisoRepository.GetByIdAsync(permisoId);
                var fileName = $"Acta_Permiso_{permiso?.NumeroActa ?? permisoId.ToString()}_{DateTime.Now:yyyyMMdd}.pdf";
                var base64 = Convert.ToBase64String(result.Value);

                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64);

                await MostrarExito($"OPERACION EXITOSA: ACTA GENERADA - {fileName}");
                Logger.LogInformation("Acta de permiso generada: {PermisoId}", permisoId);
            }
            else
            {
                errorMessage = result.Message ?? "ERROR: NO SE PUDO GENERAR EL ACTA";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generando acta PDF");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
