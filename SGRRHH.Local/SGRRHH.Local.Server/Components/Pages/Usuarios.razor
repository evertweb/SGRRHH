@page "/usuarios"
@page "/usuarios/{UsuarioIdParam:int?}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IUsuarioRepository UsuarioRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Usuarios> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Usuarios - SGRRHH</PageTitle>

<div class="page-header">
    <div class="page-title">USUARIOS</div>
    <div class="page-info">
        <span>USUARIO: @(AuthService.CurrentUser?.NombreCompleto ?? "N/A")</span>
        <span>ROL: ADMINISTRADOR</span>
    </div>
</div>

@* Sistema de roles temporalmente deshabilitado - Todos tienen acceso *@

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="error-message">
        <div class="error-title">ERROR</div>
        <div class="error-content">@errorMessage</div>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="success-message">
        <div class="success-content">@successMessage</div>
    </div>
}

<div class="control-bar">
    <div class="control-group">
        <button @onclick="NuevoUsuario" class="btn-action">NUEVO</button>
        <button @onclick="CargarUsuarios" disabled="@isLoading" class="btn-action">
            @(isLoading ? "CARGANDO..." : "ACTUALIZAR")
        </button>
        @if (selectedUsuario != null)
        {
            <button @onclick="EditarSeleccionado" class="btn-action">EDITAR</button>
            <button @onclick="ResetPassword" class="btn-action">RESETEAR CONTRASEÑA</button>
            <button @onclick="VerDispositivos" class="btn-action">🔐 DISPOSITIVOS</button>
            @if (selectedUsuario.Activo)
            {
                <button @onclick="ToggleEstado" class="btn-action">DESHABILITAR</button>
            }
            else
            {
                <button @onclick="ToggleEstado" class="btn-action">HABILITAR</button>
            }
        }
    </div>
    
    <div class="control-group">
        <label class="control-label">BUSCAR:</label>
        <input type="text" id="searchInput" @bind="searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" class="control-input" />
        <button @onclick="Buscar" class="btn-action">BUSCAR</button>
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <button @onclick="LimpiarBusqueda" class="btn-action">LIMPIAR</button>
        }
    </div>
    
    <div class="control-group">
        @* Sistema de roles temporalmente deshabilitado
        <label class="control-label">ROL:</label>
        <select @bind="filtroRol" @bind:after="Filtrar" class="control-input">
            <option value="">TODOS</option>
            <option value="@((int)RolUsuario.Administrador)">ADMINISTRADOR</option>
            <option value="@((int)RolUsuario.Aprobador)">APROBADOR</option>
            <option value="@((int)RolUsuario.Operador)">OPERADOR</option>
        </select>
        *@
        
        <label class="control-label">ESTADO:</label>
        <select @bind="filtroEstado" @bind:after="Filtrar" class="control-input">
            <option value="">TODOS</option>
            <option value="activo">ACTIVO</option>
            <option value="inactivo">INACTIVO</option>
        </select>
    </div>
</div>

@if (isLoading)
{
    <div class="status-message">
        <div>CARGANDO REGISTROS...</div>
    </div>
}
else if (!usuarios.Any())
{
    <div class="status-message">
        <div>SIN REGISTROS</div>
        <div>No existen usuarios con los criterios especificados</div>
    </div>
}
else
{
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>USERNAME</th>
                <th>NOMBRE COMPLETO</th>
                <th>EMAIL</th>
                <th>TELEFONO</th>
                <th>ROL</th>
                <th>ULTIMO ACCESO</th>
                <th>EMPLEADO ASOCIADO</th>
                <th>ESTADO</th>
                <th>ACTIVO</th>
                <th>FECHA CREACION</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var usr in usuarios)
            {
                <tr class="@(selectedUsuario?.Id == usr.Id ? "row-selected" : "")"
                    @onclick="() => SelectUsuario(usr)">
                    <td>@usr.Id</td>
                    <td>@usr.Username</td>
                    <td>@usr.NombreCompleto</td>
                    <td>@(usr.Email ?? "-")</td>
                    <td>@(usr.PhoneNumber ?? "-")</td>
                    <td>@GetRolDisplay(usr.Rol)</td>
                    <td>@(usr.UltimoAcceso?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                    <td>@(usr.EmpleadoId.HasValue ? GetEmpleadoNombre(usr.EmpleadoId.Value) : "-")</td>
                    <td>@(usr.Activo ? "ACTIVO" : "INACTIVO")</td>
                    <td>@(usr.Activo ? "SI" : "NO")</td>
                    <td>@usr.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                    <td class="actions-cell">
                        <button @onclick="() => EditarUsuario(usr)" @onclick:stopPropagation="true" class="btn-small">EDITAR</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    
    <div class="table-footer">
        <div>TOTAL REGISTROS: @usuarios.Count() | MOSTRANDO: @usuarios.Count() DE @totalUsuarios</div>
        @if (selectedUsuario != null)
        {
            <div>SELECCIONADO: @selectedUsuario.Username (ID: @selectedUsuario.Id)</div>
        }
    </div>
}

@if (showModal)
{
    <div class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-title">@(isEditing ? "EDITAR USUARIO" : "NUEVO USUARIO")</div>
            
            <div class="form-container">
                <div class="form-field">
                    <label class="field-label">USERNAME:</label>
                    <input type="text" @bind="usuarioEdit.Username" disabled="@isEditing" class="field-input" />
                    @if (isEditing)
                    {
                        <div class="field-info">El username no puede modificarse</div>
                    }
                </div>
                
                @if (!isEditing)
                {
                    <div class="form-field">
                        <label class="field-label">CONTRASEÑA:</label>
                        <input type="password" @bind="newPassword" class="field-input" />
                    </div>
                    
                    <div class="form-field">
                        <label class="field-label">CONFIRMAR CONTRASEÑA:</label>
                        <input type="password" @bind="confirmPassword" class="field-input" />
                    </div>
                }
                
                <div class="form-field">
                    <label class="field-label">NOMBRE COMPLETO:</label>
                    <input type="text" @bind="usuarioEdit.NombreCompleto" class="field-input" />
                </div>
                
                <div class="form-field">
                    <label class="field-label">EMAIL:</label>
                    <input type="email" @bind="usuarioEdit.Email" class="field-input" />
                </div>
                
                <div class="form-field">
                    <label class="field-label">TELEFONO:</label>
                    <input type="tel" @bind="usuarioEdit.PhoneNumber" class="field-input" />
                </div>
                
                @* Sistema de roles temporalmente deshabilitado - Todos serán administradores
                <div class="form-field">
                    <label class="field-label">ROL:</label>
                    <select @bind="usuarioEdit.Rol" class="field-input">
                        @foreach (var rol in Enum.GetValues<RolUsuario>())
                        {
                            <option value="@rol">@GetRolDisplay(rol)</option>
                        }
                    </select>
                    <div class="field-info">@GetRolDescription(usuarioEdit.Rol)</div>
                </div>
                *@
                
                <div class="form-field">
                    <label class="field-label">ROL:</label>
                    <div class="field-input" style="background:#333;color:#0f0;">ADMINISTRADOR (Roles serán rediseñados)</div>
                </div>
                
                <div class="form-field">
                    <label class="field-label">EMPLEADO ASOCIADO:</label>
                    <select @bind="usuarioEdit.EmpleadoId" class="field-input">
                        <option value="">NINGUNO</option>
                        @foreach (var emp in empleados)
                        {
                            <option value="@emp.Id">@emp.Codigo - @emp.NombreCompleto</option>
                        }
                    </select>
                </div>
                
                <div class="form-field">
                    <label class="field-label">
                        <input type="checkbox" @bind="usuarioEdit.Activo" />
                        USUARIO ACTIVO
                    </label>
                </div>
                
                @if (isEditing)
                {
                    <div class="form-separator">CAMBIAR CONTRASEÑA</div>
                    
                    <div class="form-field">
                        <label class="field-label">NUEVA CONTRASEÑA:</label>
                        <input type="password" @bind="newPassword" class="field-input" />
                        <div class="field-info">Dejar vacio para no cambiar</div>
                    </div>
                    
                    <div class="form-field">
                        <label class="field-label">CONFIRMAR NUEVA CONTRASEÑA:</label>
                        <input type="password" @bind="confirmPassword" class="field-input" />
                    </div>
                }
            </div>

            <div class="modal-actions">
                <button @onclick="CerrarModal" class="btn-action">CANCELAR [ESC]</button>
                <button @onclick="Guardar" disabled="@isSaving" class="btn-action">
                    @(isSaving ? "GUARDANDO..." : "GUARDAR [F5]")
                </button>
            </div>
        </div>
    </div>
}

@if (showResetModal)
{
    <div class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-title">RESETEAR CONTRASEÑA</div>
            
            @if (selectedUsuario != null)
            {
                <div class="form-container">
                    <div class="confirm-content">
                        <div>Usuario seleccionado:</div>
                        <div class="confirm-detail">@selectedUsuario.Username - @selectedUsuario.NombreCompleto</div>
                        <div class="confirm-warning">El usuario debera usar la nueva contraseña para iniciar sesion.</div>
                    </div>
                    
                    <div class="form-field">
                        <label class="field-label">NUEVA CONTRASEÑA:</label>
                        <input type="password" @bind="newPassword" class="field-input" />
                    </div>
                    
                    <div class="form-field">
                        <label class="field-label">CONFIRMAR NUEVA CONTRASEÑA:</label>
                        <input type="password" @bind="confirmPassword" class="field-input" />
                    </div>
                </div>
            }

            <div class="modal-actions">
                <button @onclick="() => showResetModal = false" class="btn-action">CANCELAR</button>
                <button @onclick="ConfirmarResetPassword" disabled="@isSaving" class="btn-action">
                    @(isSaving ? "PROCESANDO..." : "RESETEAR")
                </button>
            </div>
        </div>
    </div>
}

@if (showConfirmModal)
{
    <div class="modal-backdrop">
        <div class="modal-container modal-confirm">
            <div class="modal-title">@confirmModalTitle</div>
            
            <div class="confirm-content">
                <div>@confirmModalMessage</div>
                @if (confirmModalType == "deshabilitar")
                {
                    <div class="confirm-warning">El usuario no podra iniciar sesion hasta ser habilitado nuevamente.</div>
                }
            </div>

            <div class="modal-actions">
                <button @onclick="() => showConfirmModal = false" class="btn-action">CANCELAR</button>
                <button @onclick="ConfirmarAccion" disabled="@isSaving" class="btn-action">
                    @(isSaving ? "PROCESANDO..." : confirmButtonText)
                </button>
            </div>
        </div>
    </div>
}

@* ========================================================================= *@
@* MODAL: DISPOSITIVOS AUTORIZADOS                                           *@
@* ========================================================================= *@
@if (showDispositivosModal && selectedUsuario != null)
{
    <div class="modal-backdrop">
        <div class="modal-container modal-wide">
            <div class="modal-title">🔐 DISPOSITIVOS AUTORIZADOS - @selectedUsuario.Username</div>
            
            <div class="modal-content-scroll">
                @if (isLoadingDispositivos)
                {
                    <div class="loading-message">Cargando dispositivos...</div>
                }
                else if (!dispositivosUsuario.Any())
                {
                    <div class="empty-message">
                        <div>Este usuario no tiene dispositivos autorizados.</div>
                        <div class="empty-hint">Los dispositivos se autorizan desde la pantalla de login.</div>
                    </div>
                }
                else
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NOMBRE</th>
                                <th>NAVEGADOR</th>
                                <th>IP AUTORIZACION</th>
                                <th>FECHA CREACION</th>
                                <th>ULTIMO USO</th>
                                <th>EXPIRA</th>
                                <th>ESTADO</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var disp in dispositivosUsuario)
                            {
                                <tr class="@(!disp.Activo ? "row-inactive" : "")">
                                    <td>@disp.Id</td>
                                    <td>@disp.NombreDispositivo</td>
                                    <td class="cell-truncate" title="@disp.HuellaNavegador">
                                        @TruncateUserAgent(disp.HuellaNavegador)
                                    </td>
                                    <td>@(disp.IpAutorizacion ?? "-")</td>
                                    <td>@disp.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@(disp.FechaUltimoUso?.ToString("dd/MM/yyyy HH:mm") ?? "Nunca")</td>
                                    <td>@(disp.FechaExpiracion?.ToString("dd/MM/yyyy") ?? "No expira")</td>
                                    <td>@(disp.Activo ? "ACTIVO" : "REVOCADO")</td>
                                    <td class="actions-cell">
                                        @if (disp.Activo)
                                        {
                                            <button @onclick="() => RevocarDispositivo(disp)" 
                                                    class="btn-small btn-danger">REVOCAR</button>
                                        }
                                        else
                                        {
                                            <span class="status-revoked">REVOCADO</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    <div class="panel-info">
                        <div>Total: @dispositivosUsuario.Count() dispositivos | 
                             Activos: @dispositivosUsuario.Count(d => d.Activo)</div>
                    </div>
                }
            </div>
            
            <div class="modal-actions">
                @if (dispositivosUsuario.Any(d => d.Activo))
                {
                    <button @onclick="RevocarTodosDispositivos" class="btn-action btn-warning">
                        REVOCAR TODOS
                    </button>
                }
                <button @onclick="() => showDispositivosModal = false" class="btn-action">CERRAR</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? UsuarioIdParam { get; set; }
    
    private const string PageId = "usuarios";
    
    private List<Usuario> usuarios = new();
    private List<Empleado> empleados = new();
    private Usuario? selectedUsuario;
    private Usuario usuarioEdit = new();
    
    private bool isLoading;
    private bool showModal;
    private bool showResetModal;
    private bool showConfirmModal;
    private bool isSaving;
    private bool isEditing;
    
    private string? errorMessage;
    private string? successMessage;
    private string searchTerm = string.Empty;
    private string filtroRol = string.Empty;
    private string filtroEstado = string.Empty;
    private int totalUsuarios;
    
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    
    private string confirmModalTitle = string.Empty;
    private string confirmModalMessage = string.Empty;
    private string confirmButtonText = "CONFIRMAR";
    private string confirmModalType = string.Empty;
    private Func<Task>? confirmAction;
    
    // Dispositivos autorizados
    private bool showDispositivosModal;
    private bool isLoadingDispositivos;
    private List<DispositivoAutorizado> dispositivosUsuario = new();
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        if (!AuthService.IsAdmin)
        {
            Logger.LogWarning("Usuario {User} intento acceder a /usuarios sin permisos", 
                AuthService.CurrentUser?.Username);
            return;
        }
        
        // Registrar atajos de teclado para esta página
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F2", KeyDisplay = "F2", Description = "Buscar", Action = FocusBusqueda, Priority = 10 },
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = NuevoUsuario, Priority = 10 },
            new() { Key = "F4", KeyDisplay = "F4", Description = "Editar", Action = EditarSeleccionado, Priority = 10 },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarUsuarios, Priority = 10 },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModal, Priority = 10 }
        });
        
        await CargarUsuarios();
        await CargarEmpleados();
        
        if (UsuarioIdParam.HasValue)
        {
            var usuario = usuarios.FirstOrDefault(u => u.Id == UsuarioIdParam.Value);
            if (usuario != null)
            {
                await EditarUsuario(usuario);
            }
        }
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task CargarUsuarios()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            usuarios = (await UsuarioRepository.GetAllAsync()).ToList();
            totalUsuarios = usuarios.Count;
            
            await Filtrar();
            
            Logger.LogInformation("Usuarios cargados: {Count}", usuarios.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar usuarios");
            errorMessage = $"ERROR CRITICO: Fallo al cargar usuarios - {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarEmpleados()
    {
        try
        {
            empleados = (await EmpleadoRepository.GetAllAsync())
                .Where(e => e.Estado == EstadoEmpleado.Activo)
                .OrderBy(e => e.NombreCompleto)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar empleados");
        }
    }
    
    private async Task Filtrar()
    {
        var filtered = usuarios.AsEnumerable();
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.ToLower();
            filtered = filtered.Where(u =>
                u.Username.ToLower().Contains(search) ||
                u.NombreCompleto.ToLower().Contains(search) ||
                (u.Email != null && u.Email.ToLower().Contains(search))
            );
        }
        
        if (!string.IsNullOrEmpty(filtroRol) && int.TryParse(filtroRol, out int rolId))
        {
            filtered = filtered.Where(u => (int)u.Rol == rolId);
        }
        
        if (!string.IsNullOrEmpty(filtroEstado))
        {
            bool activo = filtroEstado == "activo";
            filtered = filtered.Where(u => u.Activo == activo);
        }
        
        usuarios = filtered.ToList();
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private async Task Buscar()
    {
        await Filtrar();
    }
    
    private async Task LimpiarBusqueda()
    {
        searchTerm = string.Empty;
        await CargarUsuarios();
        await FocusBusqueda();
    }
    
    private async Task FocusBusqueda()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("focusElement", "searchInput");
        }
        catch { }
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Buscar();
        }
    }
    
    private void SelectUsuario(Usuario usuario)
    {
        selectedUsuario = usuario;
    }
    
    private Task NuevoUsuario()
    {
        usuarioEdit = new Usuario
        {
            Activo = true,
            Rol = RolUsuario.Administrador // Todos son admin mientras se rediseñan los roles
        };
        
        isEditing = false;
        showModal = true;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        errorMessage = null;
        
        Logger.LogInformation("Iniciando creacion de nuevo usuario");
        return Task.CompletedTask;
    }
    
    private async Task EditarUsuario(Usuario usuario)
    {
        try
        {
            // No copiar Id ni PasswordHash manualmente - el Id se asigna después
            // PasswordHash se mantiene solo si no se cambia la contraseña
            usuarioEdit = new Usuario
            {
                Username = usuario.Username,
                NombreCompleto = usuario.NombreCompleto,
                Email = usuario.Email,
                PhoneNumber = usuario.PhoneNumber,
                Rol = usuario.Rol,
                Activo = usuario.Activo,
                EmpleadoId = usuario.EmpleadoId
            };
            usuarioEdit.Id = usuario.Id;
            usuarioEdit.PasswordHash = usuario.PasswordHash; // Se mantiene el hash actual
            usuarioEdit.UltimoAcceso = usuario.UltimoAcceso;
            
            isEditing = true;
            showModal = true;
            newPassword = string.Empty;
            confirmPassword = string.Empty;
            errorMessage = null;
            
            Logger.LogInformation("Editando usuario: {Username}", usuario.Username);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al preparar edicion de usuario {Id}", usuario.Id);
            errorMessage = $"ERROR: Fallo al cargar datos del usuario - {ex.Message}";
        }
    }
    
    private async Task EditarSeleccionado()
    {
        if (selectedUsuario != null)
        {
            await EditarUsuario(selectedUsuario);
        }
    }
    
    private async Task Guardar()
    {
        if (usuarioEdit == null) return;
        
        try
        {
            isSaving = true;
            errorMessage = null;
            StateHasChanged();
            
            if (string.IsNullOrWhiteSpace(usuarioEdit.Username))
            {
                errorMessage = "ERROR: Campo USERNAME requerido";
                return;
            }
            
            if (string.IsNullOrWhiteSpace(usuarioEdit.NombreCompleto))
            {
                errorMessage = "ERROR: Campo NOMBRE COMPLETO requerido";
                return;
            }
            
            if (!isEditing)
            {
                if (await UsuarioRepository.ExistsUsernameAsync(usuarioEdit.Username))
                {
                    errorMessage = $"ERROR: El username '{usuarioEdit.Username}' ya existe";
                    return;
                }
                
                if (string.IsNullOrWhiteSpace(newPassword))
                {
                    errorMessage = "ERROR: Campo CONTRASEÑA requerido para usuarios nuevos";
                    return;
                }
                
                if (newPassword.Length < 6)
                {
                    errorMessage = "ERROR: La contraseña debe tener minimo 6 caracteres";
                    return;
                }
                
                if (newPassword != confirmPassword)
                {
                    errorMessage = "ERROR: Las contraseñas no coinciden";
                    return;
                }
                
                usuarioEdit.PasswordHash = AuthService.HashPassword(newPassword);
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(newPassword))
                {
                    if (newPassword.Length < 6)
                    {
                        errorMessage = "ERROR: La contraseña debe tener minimo 6 caracteres";
                        return;
                    }
                    
                    if (newPassword != confirmPassword)
                    {
                        errorMessage = "ERROR: Las contraseñas no coinciden";
                        return;
                    }
                    
                    usuarioEdit.PasswordHash = AuthService.HashPassword(newPassword);
                }
            }
            
            if (isEditing)
            {
                await UsuarioRepository.UpdateAsync(usuarioEdit);
                Logger.LogInformation("Usuario actualizado: {Username}", usuarioEdit.Username);
                successMessage = $"Usuario '{usuarioEdit.Username}' actualizado correctamente";
            }
            else
            {
                var id = await UsuarioRepository.AddAsync(usuarioEdit);
                Logger.LogInformation("Usuario creado: {Username} con ID {Id}", usuarioEdit.Username, id);
                successMessage = $"Usuario '{usuarioEdit.Username}' creado correctamente con ID {id}";
            }
            
            await CargarUsuarios();
            CerrarModal();
            
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                successMessage = null;
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar usuario");
            errorMessage = $"ERROR CRITICO: Fallo al guardar usuario - {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModal()
    {
        showModal = false;
        showResetModal = false;
        showConfirmModal = false;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        errorMessage = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void ResetPassword()
    {
        if (selectedUsuario == null) return;
        
        if (selectedUsuario.Id == AuthService.CurrentUser?.Id)
        {
            errorMessage = "ERROR: No puede resetear su propia contraseña desde aqui";
            return;
        }
        
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        errorMessage = null;
        showResetModal = true;
    }
    
    private async Task ConfirmarResetPassword()
    {
        if (selectedUsuario == null) return;
        
        try
        {
            isSaving = true;
            errorMessage = null;
            StateHasChanged();
            
            if (string.IsNullOrWhiteSpace(newPassword))
            {
                errorMessage = "ERROR: Campo NUEVA CONTRASEÑA requerido";
                return;
            }
            
            if (newPassword.Length < 6)
            {
                errorMessage = "ERROR: La contraseña debe tener minimo 6 caracteres";
                return;
            }
            
            if (newPassword != confirmPassword)
            {
                errorMessage = "ERROR: Las contraseñas no coinciden";
                return;
            }
            
            var result = await AuthService.ResetPasswordAsync(selectedUsuario.Id, newPassword);
            
            if (result.IsSuccess)
            {
                Logger.LogInformation("Contraseña reseteada para usuario: {Username} por {Admin}", 
                    selectedUsuario.Username, AuthService.CurrentUser?.Username);
                successMessage = $"Contraseña del usuario '{selectedUsuario.Username}' reseteada correctamente";
                
                showResetModal = false;
                newPassword = string.Empty;
                confirmPassword = string.Empty;
                
                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    successMessage = null;
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                errorMessage = $"ERROR: {result.ErrorMessage ?? "Fallo al resetear contraseña"}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al resetear contraseña de usuario {Id}", selectedUsuario.Id);
            errorMessage = $"ERROR CRITICO: Fallo al resetear contraseña - {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task ToggleEstado()
    {
        if (selectedUsuario == null) return;
        
        if (selectedUsuario.Activo)
        {
            await DeshabilitarUsuario(selectedUsuario);
        }
        else
        {
            await HabilitarUsuario(selectedUsuario);
        }
    }
    
    private async Task HabilitarUsuario(Usuario usuario)
    {
        confirmModalTitle = "HABILITAR USUARIO";
        confirmModalMessage = $"Se habilitara el usuario: {usuario.Username} - {usuario.NombreCompleto}";
        confirmButtonText = "HABILITAR";
        confirmModalType = "habilitar";
        confirmAction = async () => await EjecutarHabilitar(usuario);
        showConfirmModal = true;
        await Task.CompletedTask;
    }
    
    private async Task DeshabilitarUsuario(Usuario usuario)
    {
        if (usuario.Id == AuthService.CurrentUser?.Id)
        {
            errorMessage = "ERROR: No puede deshabilitar su propia cuenta";
            return;
        }
        
        confirmModalTitle = "DESHABILITAR USUARIO";
        confirmModalMessage = $"Se deshabilitara el usuario: {usuario.Username} - {usuario.NombreCompleto}";
        confirmButtonText = "DESHABILITAR";
        confirmModalType = "deshabilitar";
        confirmAction = async () => await EjecutarDeshabilitar(usuario);
        showConfirmModal = true;
        await Task.CompletedTask;
    }
    
    private async Task EjecutarHabilitar(Usuario usuario)
    {
        try
        {
            usuario.Activo = true;
            await UsuarioRepository.UpdateAsync(usuario);
            
            Logger.LogInformation("Usuario habilitado: {Username} por {Admin}", 
                usuario.Username, AuthService.CurrentUser?.Username);
            successMessage = $"Usuario '{usuario.Username}' habilitado correctamente";
            
            await CargarUsuarios();
            showConfirmModal = false;
            
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                successMessage = null;
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al habilitar usuario {Id}", usuario.Id);
            errorMessage = $"ERROR: Fallo al habilitar usuario - {ex.Message}";
        }
    }
    
    private async Task EjecutarDeshabilitar(Usuario usuario)
    {
        try
        {
            usuario.Activo = false;
            await UsuarioRepository.UpdateAsync(usuario);
            
            Logger.LogInformation("Usuario deshabilitado: {Username} por {Admin}", 
                usuario.Username, AuthService.CurrentUser?.Username);
            successMessage = $"Usuario '{usuario.Username}' deshabilitado correctamente";
            
            await CargarUsuarios();
            showConfirmModal = false;
            
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                successMessage = null;
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al deshabilitar usuario {Id}", usuario.Id);
            errorMessage = $"ERROR: Fallo al deshabilitar usuario - {ex.Message}";
        }
    }
    
    private async Task ConfirmarAccion()
    {
        if (confirmAction != null)
        {
            await confirmAction.Invoke();
        }
    }
    
    private string GetRolDisplay(RolUsuario rol) => rol switch
    {
        RolUsuario.Administrador => "ADMINISTRADOR",
        RolUsuario.Aprobador => "APROBADOR",
        RolUsuario.Operador => "OPERADOR",
        _ => rol.ToString().ToUpper()
    };
    
    private string GetRolClass(RolUsuario rol) => rol switch
    {
        RolUsuario.Administrador => "admin",
        RolUsuario.Aprobador => "aprobador",
        RolUsuario.Operador => "operador",
        _ => "default"
    };
    
    private string GetRolDescription(RolUsuario rol) => rol switch
    {
        RolUsuario.Administrador => "Acceso completo al sistema",
        RolUsuario.Aprobador => "Puede aprobar permisos y vacaciones",
        RolUsuario.Operador => "Acceso basico para operaciones diarias",
        _ => ""
    };
    
    private string GetEmpleadoNombre(int empleadoId)
    {
        var empleado = empleados.FirstOrDefault(e => e.Id == empleadoId);
        return empleado != null ? $"{empleado.Codigo} - {empleado.NombreCompleto}" : "-";
    }
    
    // =========================================================================
    // GESTIÓN DE DISPOSITIVOS AUTORIZADOS
    // =========================================================================
    
    private async Task VerDispositivos()
    {
        if (selectedUsuario == null) return;
        
        try
        {
            isLoadingDispositivos = true;
            showDispositivosModal = true;
            StateHasChanged();
            
            dispositivosUsuario = (await AuthService.ObtenerDispositivosDeUsuarioAsync(selectedUsuario.Id)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando dispositivos del usuario {Id}", selectedUsuario.Id);
            errorMessage = "ERROR: No se pudieron cargar los dispositivos";
        }
        finally
        {
            isLoadingDispositivos = false;
            StateHasChanged();
        }
    }
    
    private async Task RevocarDispositivo(DispositivoAutorizado dispositivo)
    {
        try
        {
            var result = await AuthService.RevocarDispositivoAsync(dispositivo.Id);
            
            if (result.IsSuccess)
            {
                Logger.LogInformation("Dispositivo {Id} revocado por {Admin}", 
                    dispositivo.Id, AuthService.CurrentUser?.Username);
                successMessage = $"Dispositivo '{dispositivo.NombreDispositivo}' revocado";
                
                // Recargar lista
                await VerDispositivos();
                
                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    successMessage = null;
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                errorMessage = $"ERROR: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error revocando dispositivo {Id}", dispositivo.Id);
            errorMessage = $"ERROR: Fallo al revocar dispositivo - {ex.Message}";
        }
    }
    
    private async Task RevocarTodosDispositivos()
    {
        if (selectedUsuario == null) return;
        
        try
        {
            var result = await AuthService.RevocarTodosDispositivosAsync(selectedUsuario.Id);
            
            if (result.IsSuccess)
            {
                Logger.LogInformation("Todos los dispositivos revocados para usuario {Username} por {Admin}", 
                    selectedUsuario.Username, AuthService.CurrentUser?.Username);
                successMessage = $"Todos los dispositivos de '{selectedUsuario.Username}' revocados";
                
                // Recargar lista
                await VerDispositivos();
                
                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    successMessage = null;
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                errorMessage = $"ERROR: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error revocando todos los dispositivos del usuario {Id}", selectedUsuario.Id);
            errorMessage = $"ERROR: Fallo al revocar dispositivos - {ex.Message}";
        }
    }
    
    private static string TruncateUserAgent(string? userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "-";
        
        // Extraer navegador principal
        if (userAgent.Contains("Chrome")) return "Chrome";
        if (userAgent.Contains("Firefox")) return "Firefox";
        if (userAgent.Contains("Safari") && !userAgent.Contains("Chrome")) return "Safari";
        if (userAgent.Contains("Edge")) return "Edge";
        if (userAgent.Contains("Opera") || userAgent.Contains("OPR")) return "Opera";
        
        return userAgent.Length > 30 ? userAgent[..30] + "..." : userAgent;
    }
}
