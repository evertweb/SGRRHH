@page "/control-diario"
@page "/control-diario/{FechaParam}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IRegistroDiarioRepository RegistroDiarioRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IDepartamentoRepository DepartamentoRepository
@inject IActividadRepository ActividadRepository
@inject ICategoriaActividadRepository CategoriaActividadRepository
@inject IProyectoRepository ProyectoRepository
@inject IDetalleActividadRepository DetalleActividadRepository
@inject NavigationManager Navigation
@inject ILogger<ControlDiario> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Control Diario - SGRRHH</PageTitle>

<div class="hospital-page">
    <!-- ENCABEZADO PRINCIPAL -->
    <div class="hospital-header">
        <h1>CONTROL DIARIO</h1>
        <div class="header-info">
            <span class="fecha-destacada">@fechaSeleccionada.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("es-CO")).ToUpper()</span>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="hospital-error">
            ERROR: @errorMessage
            <button @onclick="() => errorMessage = null">ACEPTAR</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="hospital-success">
            @successMessage
        </div>
    }

    <!-- BARRA PRINCIPAL DE CONTROLES -->
    <div class="control-bar-principal">
        <!-- NAVEGACIÓN DE FECHA - Lo más importante -->
        <div class="fecha-navegacion">
            <button @onclick="RetrocederDia" class="fecha-btn" title="Día anterior">◄</button>
            <input type="date" 
                   @bind="fechaSeleccionada" 
                   @bind:after="CambiarFecha"
                   class="fecha-input" />
            <button @onclick="AvanzarDia" class="fecha-btn" title="Día siguiente">►</button>
            <button @onclick="IrHoy" class="fecha-btn-hoy" title="Ir a hoy">HOY</button>
        </div>
        
        <!-- BÚSQUEDA -->
        <div class="busqueda-box">
            <input type="text" 
                   @bind="searchTerm" 
                   @bind:event="oninput"
                   @bind:after="FiltrarRegistros"
                   @ref="searchInputRef"
                   placeholder="Buscar empleado... (F2)"
                   class="busqueda-input" />
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button @onclick="LimpiarBusqueda" class="busqueda-clear">✕</button>
            }
        </div>
        
        <!-- ACCIONES PRINCIPALES -->
        <div class="acciones-principales">
            <button @onclick="CargarRegistros" class="accion-btn" title="Actualizar (F5)">↻</button>
            <button @onclick="CrearRegistrosParaTodos" 
                    class="accion-btn-crear" 
                    title="Crear registros para empleados sin registro (F3)"
                    disabled="@(!empleadosSinRegistro.Any())">
                + CREAR @(empleadosSinRegistro.Any() ? $"({empleadosSinRegistro.Count})" : "")
            </button>
        </div>
    </div>

    <!-- RESUMEN COMPACTO (solo números importantes) -->
    <div class="resumen-compacto">
        <span class="resumen-stat"><strong>@registrosFiltrados.Count()</strong> de @registrosDia.Count() registros</span>
        <span class="resumen-sep">|</span>
        <span class="resumen-stat completados">✓ @registrosDia.Count(r => r.Estado == EstadoRegistroDiario.Completado || r.Estado == EstadoRegistroDiario.Aprobado) completados</span>
        <span class="resumen-sep">|</span>
        <span class="resumen-stat pendientes">○ @registrosDia.Count(r => r.Estado == EstadoRegistroDiario.Borrador) pendientes</span>
        <span class="resumen-sep">|</span>
        <span class="resumen-stat horas">⏱ @registrosDia.Sum(r => r.TotalHoras).ToString("F1")h</span>
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <span class="resumen-sep">|</span>
            <span class="filtro-activo">Filtro: "@searchTerm"</span>
        }
    </div>

    <!-- Tabla principal -->
    <div class="hospital-table-container">
        <table class="hospital-table">
            <thead>
                <tr>
                    <th>CODIGO</th>
                    <th>NOMBRE COMPLETO</th>
                    <th>DEPARTAMENTO</th>
                    <th>FECHA</th>
                    <th>HORA ENTRADA</th>
                    <th>HORA SALIDA</th>
                    <th>TOTAL HORAS</th>
                    <th>NUM ACTIVIDADES</th>
                    <th>ESTADO</th>
                    <th>OBSERVACIONES</th>
                    <th>FECHA CREACION</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr><td colspan="12" class="hospital-loading">CARGANDO REGISTROS...</td></tr>
                }
                else if (!registrosFiltrados.Any())
                {
                    <tr><td colspan="12" class="hospital-empty">
                        SIN REGISTROS PARA LA FECHA SELECCIONADA
                        @if (empleadosSinRegistro.Any())
                        {
                            <br/>
                            <button @onclick="CrearRegistrosParaTodos" class="hospital-btn">
                                CREAR REGISTROS PARA @empleadosSinRegistro.Count EMPLEADOS
                            </button>
                        }
                    </td></tr>
                }
                else
                {
                    @foreach (var registro in registrosFiltrados)
                    {
                        var empleado = registro.Empleado;
                        var cantActividades = registro.DetallesActividades?.Count ?? 0;
                        var isSelected = registroSeleccionado?.Id == registro.Id;
                        
                        <tr class="@(isSelected ? "selected-row" : "")" @onclick="() => SeleccionarRegistro(registro)">
                            <td>@empleado?.Codigo</td>
                            <td>
                                <a href="javascript:void(0)" 
                                   @onclick="() => IrAExpediente(empleado?.Id ?? 0)" 
                                   @onclick:stopPropagation="true"
                                   class="empleado-link"
                                   title="Ver expediente de @empleado?.NombreCompleto">
                                    @empleado?.NombreCompleto
                                </a>
                            </td>
                            <td>@(empleado?.Departamento?.Nombre ?? "-")</td>
                            <td>@registro.Fecha.ToString("dd/MM/yyyy")</td>
                            <td>
                                @if (editandoEntrada == registro.Id)
                                {
                                    <input type="time" 
                                           value="@FormatTimeSpan(registro.HoraEntrada)"
                                           @onchange="@(e => { registro.HoraEntrada = ParseTimeSpan(e.Value?.ToString()); _ = GuardarHorario(registro); })"
                                           class="hospital-input-time"
                                           @onclick:stopPropagation="true" />
                                }
                                else
                                {
                                    <span @onclick="() => EditarEntrada(registro)" @onclick:stopPropagation="true" class="editable-field">
                                        @(registro.HoraEntrada?.ToString(@"hh\:mm") ?? "-")
                                    </span>
                                }
                            </td>
                            <td>
                                @if (editandoSalida == registro.Id)
                                {
                                    <input type="time" 
                                           value="@FormatTimeSpan(registro.HoraSalida)"
                                           @onchange="@(e => { registro.HoraSalida = ParseTimeSpan(e.Value?.ToString()); _ = GuardarHorario(registro); })"
                                           class="hospital-input-time"
                                           @onclick:stopPropagation="true" />
                                }
                                else
                                {
                                    <span @onclick="() => EditarSalida(registro)" @onclick:stopPropagation="true" class="editable-field">
                                        @(registro.HoraSalida?.ToString(@"hh\:mm") ?? "-")
                                    </span>
                                }
                            </td>
                            <td>@registro.TotalHoras.ToString("F1")</td>
                            <td>@cantActividades</td>
                            <td>
                                @if (registro.Estado == EstadoRegistroDiario.Borrador)
                                {
                                    <span class="estado-borrador">BORRADOR</span>
                                }
                                else if (registro.Estado == EstadoRegistroDiario.Completado)
                                {
                                    <span class="estado-completado">COMPLETADO</span>
                                }
                                else if (registro.Estado == EstadoRegistroDiario.Aprobado)
                                {
                                    <span class="estado-aprobado">APROBADO</span>
                                }
                            </td>
                            <td>@(string.IsNullOrEmpty(registro.Observaciones) ? "-" : (registro.Observaciones.Length > 30 ? registro.Observaciones.Substring(0, 30) + "..." : registro.Observaciones))</td>
                            <td>@registro.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="acciones-inline">
                                <button @onclick="() => RegistrarEntradaParaRegistro(registro)" 
                                        @onclick:stopPropagation="true" 
                                        class="btn-accion-inline btn-entrada"
                                        title="Registrar entrada (hora actual)"
                                        disabled="@(registro.HoraEntrada != null)">
                                    E
                                </button>
                                <button @onclick="() => RegistrarSalidaParaRegistro(registro)" 
                                        @onclick:stopPropagation="true" 
                                        class="btn-accion-inline btn-salida"
                                        title="Registrar salida (hora actual)"
                                        disabled="@(registro.HoraSalida != null)">
                                    S
                                </button>
                                <button @onclick="() => AgregarActividadParaRegistro(registro)" 
                                        @onclick:stopPropagation="true" 
                                        class="btn-accion-inline btn-actividad"
                                        title="Agregar actividad">
                                    +
                                </button>
                                <button @onclick="() => CompletarRegistro(registro)" 
                                        @onclick:stopPropagation="true" 
                                        class="btn-accion-inline btn-completar"
                                        title="Marcar como completado"
                                        disabled="@(!registro.EstaCompleto || registro.Estado == EstadoRegistroDiario.Completado)">
                                    ✓
                                </button>
                                <button @onclick="() => VerDetalleRegistro(registro)" 
                                        @onclick:stopPropagation="true" 
                                        class="btn-accion-inline btn-ver"
                                        title="Ver detalle completo">
                                    ⋯
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Leyenda de acciones inline -->
    <div class="leyenda-acciones">
        <span class="leyenda-titulo">ACCIONES:</span>
        <span class="leyenda-item"><span class="btn-mini btn-entrada">E</span> = Entrada</span>
        <span class="leyenda-item"><span class="btn-mini btn-salida">S</span> = Salida</span>
        <span class="leyenda-item"><span class="btn-mini btn-actividad">+</span> = Agregar Actividad</span>
        <span class="leyenda-item"><span class="btn-mini btn-completar">✓</span> = Completar</span>
        <span class="leyenda-item"><span class="btn-mini btn-ver">⋯</span> = Ver Detalle</span>
    </div>
    
    <!-- ENLACES SECUNDARIOS - Discretos al final -->
    <div class="enlaces-secundarios">
        <span class="enlaces-label">IR A:</span>
        <a href="javascript:void(0)" @onclick="IrAlWizard" class="enlace-secundario">Wizard Masivo</a>
        <span class="enlaces-sep">•</span>
        <a href="javascript:void(0)" @onclick="IrAReportes" class="enlace-secundario">Reportes</a>
        <span class="enlaces-sep">•</span>
        <a href="javascript:void(0)" @onclick="IrAProductividad" class="enlace-secundario">Dashboard Productividad</a>
        <span class="atajos-teclado">F2=Buscar • F3=Nuevo • F5=Guardar • ESC=Cerrar</span>
    </div>
</div>

<!-- Panel de detalle del registro seleccionado -->
@if (registroSeleccionado != null && mostrarDetalle)
{
    var empleado = registroSeleccionado.Empleado;
    var detalles = registroSeleccionado.DetallesActividades?.OrderBy(d => d.Orden).ToList() ?? new List<DetalleActividad>();
    
    <div class="hospital-modal-overlay">
        <div class="hospital-modal">
            <div class="hospital-modal-header">
                <h2>DETALLE DE REGISTRO</h2>
                <button @onclick="CerrarDetalle" class="hospital-btn">CERRAR (ESC)</button>
            </div>
            
            <div class="hospital-form">
                <div class="form-row">
                    <div class="form-field">
                        <label>CODIGO:</label>
                        <span>@empleado?.Codigo</span>
                    </div>
                    <div class="form-field">
                        <label>EMPLEADO:</label>
                        <span>@empleado?.NombreCompleto</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>DEPARTAMENTO:</label>
                        <span>@(empleado?.Departamento?.Nombre ?? "-")</span>
                    </div>
                    <div class="form-field">
                        <label>FECHA:</label>
                        <span>@registroSeleccionado.Fecha.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>HORA ENTRADA:</label>
                        <span>@(registroSeleccionado.HoraEntrada?.ToString(@"hh\:mm") ?? "-")</span>
                    </div>
                    <div class="form-field">
                        <label>HORA SALIDA:</label>
                        <span>@(registroSeleccionado.HoraSalida?.ToString(@"hh\:mm") ?? "-")</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>TOTAL HORAS:</label>
                        <span>@registroSeleccionado.TotalHoras.ToString("F1")</span>
                    </div>
                    <div class="form-field">
                        <label>ESTADO:</label>
                        <span>@registroSeleccionado.Estado</span>
                    </div>
                </div>
                <div class="form-row-full">
                    <div class="form-field">
                        <label>OBSERVACIONES:</label>
                        @if (editandoObservaciones)
                        {
                            <textarea @bind="registroSeleccionado.Observaciones" 
                                      rows="2" 
                                      class="hospital-textarea"></textarea>
                            <button @onclick="GuardarObservaciones" class="hospital-btn">GUARDAR</button>
                            <button @onclick="() => editandoObservaciones = false" class="hospital-btn">CANCELAR</button>
                        }
                        else
                        {
                            <div @onclick="() => editandoObservaciones = true" class="observaciones-display">
                                @if (!string.IsNullOrEmpty(registroSeleccionado.Observaciones))
                                {
                                    @registroSeleccionado.Observaciones
                                }
                                else
                                {
                                    <span class="placeholder-text">CLICK PARA AGREGAR</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="hospital-section">
                <h3>ACTIVIDADES DEL DIA</h3>
                <button @onclick="() => AgregarActividadParaRegistro(registroSeleccionado)" class="hospital-btn">
                    AGREGAR ACTIVIDAD (F3)
                </button>
            </div>

            @if (!detalles.Any())
            {
                <div class="hospital-empty">
                    SIN ACTIVIDADES REGISTRADAS
                </div>
            }
            else
            {
                <table class="hospital-table">
                    <thead>
                        <tr>
                            <th>ORDEN</th>
                            <th>ACTIVIDAD</th>
                            <th>PROYECTO</th>
                            <th>HORA INICIO</th>
                            <th>HORA FIN</th>
                            <th>HORAS</th>
                            <th>CANTIDAD</th>
                            <th>REND.</th>
                            <th>DESCRIPCION</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detalle in detalles)
                        {
                            <tr>
                                <td>@detalle.Orden</td>
                                <td>@detalle.Actividad?.Nombre</td>
                                <td>@(detalle.Proyecto?.Nombre ?? "-")</td>
                                <td>@(detalle.HoraInicio?.ToString(@"hh\:mm") ?? "-")</td>
                                <td>@(detalle.HoraFin?.ToString(@"hh\:mm") ?? "-")</td>
                                <td>@detalle.Horas.ToString("F1")</td>
                                <td>@(detalle.Cantidad.HasValue ? $"{detalle.Cantidad:F1} {detalle.UnidadMedida}" : "-")</td>
                                <td class="@GetClasificacionCss(detalle.ClasificacionProductividad)">
                                    @if (detalle.PorcentajeRendimiento.HasValue)
                                    {
                                        <span title="@GetClasificacionTexto(detalle.ClasificacionProductividad)">@detalle.PorcentajeRendimiento?.ToString("F0")%</span>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td>@(string.IsNullOrEmpty(detalle.Descripcion) ? "-" : (detalle.Descripcion.Length > 50 ? detalle.Descripcion.Substring(0, 50) + "..." : detalle.Descripcion))</td>
                                <td>
                                    <button @onclick="() => EditarActividad(detalle)" class="hospital-btn-small">EDITAR</button>
                                    <button @onclick="() => EliminarActividad(detalle)" class="hospital-btn-small">ELIMINAR</button>
                                </td>
                            </tr>
                        }
                        <tr class="total-row">
                            <td colspan="5">TOTAL:</td>
                            <td>@detalles.Sum(d => d.Horas).ToString("F1")</td>
                            <td colspan="4"></td>
                        </tr>
                    </tbody>
                </table>
            }
        </div>
    </div>
}

<!-- Modal para agregar/editar actividad -->
@if (showModalActividad && actividadEdit != null && registroSeleccionado != null)
{
    <div class="hospital-modal-overlay">
        <div class="hospital-modal">
            <div class="hospital-modal-header">
                <h2>@(isEditingActividad ? "EDITAR ACTIVIDAD" : "AGREGAR ACTIVIDAD")</h2>
                <button @onclick="CerrarModalActividad" class="hospital-btn">CANCELAR (ESC)</button>
            </div>

            <div class="hospital-form">
                <div class="form-row">
                    <div class="form-field">
                        <label>CATEGORÍA:</label>
                        <select @bind="categoriaFiltroId" @bind:after="FiltrarActividadesPorCategoria"
                                disabled="@isSaving"
                                class="hospital-select">
                            <option value="0">-- TODAS LAS CATEGORÍAS --</option>
                            @foreach (var cat in categoriasActividad.OrderBy(c => c.Orden))
                            {
                                <option value="@cat.Id" style="color: @cat.ColorHex">@cat.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-field required">
                        <label>ACTIVIDAD:</label>
                        <select @bind="actividadEdit.ActividadId" 
                                @bind:after="OnActividadChanged"
                                disabled="@isSaving"
                                class="hospital-select">
                            <option value="">-- SELECCIONE --</option>
                            @foreach (var act in actividadesFiltradas)
                            {
                                <option value="@act.Id">
                                    @act.Codigo - @act.Nombre @(act.EsDestacada ? "★" : "")
                                </option>
                            }
                        </select>
                    </div>
                    
                    @if (actividadSeleccionadaRequiereProyecto)
                    {
                        <div class="form-field required">
                            <label>PROYECTO:</label>
                            <select @bind="actividadEdit.ProyectoId" 
                                    disabled="@isSaving"
                                    class="hospital-select">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var proy in proyectos)
                                {
                                    <option value="@proy.Id">@proy.Nombre</option>
                                }
                            </select>
                        </div>
                    }
                </div>

                @if (actividadSeleccionadaObj?.RequiereCantidad == true)
                {
                    <div class="form-row">
                        <div class="form-field required">
                            <label>CANTIDAD (@(actividadSeleccionadaObj?.UnidadAbreviatura ?? "und")):</label>
                            <input type="number" 
                                   step="0.01"
                                   @bind="actividadEdit.Cantidad" 
                                   min="0.01"
                                   disabled="@isSaving"
                                   placeholder="Ej: 2.5"
                                   class="hospital-input" />
                            @if (actividadSeleccionadaObj?.RendimientoEsperado.HasValue == true)
                            {
                                <small class="help-text">
                                    Rendimiento esperado: @actividadSeleccionadaObj.RendimientoEsperado.Value.ToString("F2") @actividadSeleccionadaObj.UnidadAbreviatura/hora
                                </small>
                            }
                        </div>
                    </div>
                }

                <div class="form-row">
                    <div class="form-field required">
                        <label>HORAS:</label>
                        <input type="number" 
                               @bind="actividadEdit.Horas" 
                               min="0.25" 
                               max="24" 
                               step="0.25"
                               disabled="@isSaving"
                               class="hospital-input" />
                    </div>
                    <div class="form-field">
                        <label>ORDEN:</label>
                        <input type="number" 
                               @bind="actividadEdit.Orden" 
                               min="1"
                               disabled="@isSaving"
                               class="hospital-input" />
                    </div>
                </div>

                @* Preview de productividad *@
                @if (actividadEdit.Cantidad.HasValue && actividadEdit.Cantidad > 0 && actividadEdit.Horas > 0)
                {
                    var rendimientoLogrado = actividadEdit.Cantidad.Value / actividadEdit.Horas;
                    <div class="productividad-preview">
                        <strong>RENDIMIENTO LOGRADO:</strong> 
                        @rendimientoLogrado.ToString("F2") @(actividadSeleccionadaObj?.UnidadAbreviatura ?? "")/hora
                        
                        @if (actividadSeleccionadaObj?.RendimientoEsperado > 0)
                        {
                            var porcentaje = (rendimientoLogrado / actividadSeleccionadaObj.RendimientoEsperado.Value) * 100;
                            <span class="@GetClasificacionCss(porcentaje)">
                                (@porcentaje.ToString("F0")% del esperado - @GetClasificacionTexto(porcentaje))
                            </span>
                        }
                    </div>
                }

                <div class="form-row">
                    <div class="form-field">
                        <label>HORA INICIO:</label>
                        <input type="time" 
                               value="@FormatTimeSpan(actividadEdit?.HoraInicio)"
                               @onchange="@(e => { if (actividadEdit != null) actividadEdit.HoraInicio = ParseTimeSpan(e.Value?.ToString()); CalcularHorasFin(); })"
                               disabled="@isSaving"
                               class="hospital-input" />
                    </div>
                    <div class="form-field">
                        <label>HORA FIN:</label>
                        <input type="time" 
                               value="@FormatTimeSpan(actividadEdit?.HoraFin)"
                               @onchange="@(e => { if (actividadEdit != null) actividadEdit.HoraFin = ParseTimeSpan(e.Value?.ToString()); CalcularHorasDesdeRango(); })"
                               disabled="@isSaving"
                               class="hospital-input" />
                    </div>
                </div>

                @if (actividadSeleccionadaObj?.RequiereCantidad == true)
                {
                    <div class="form-row">
                        <div class="form-field">
                            <label>LOTE/SECTOR ESPECÍFICO:</label>
                            <input type="text" 
                                   @bind="actividadEdit.LoteEspecifico" 
                                   maxlength="50"
                                   disabled="@isSaving"
                                   placeholder="Ej: Lote 3, Sector Norte"
                                   class="hospital-input" />
                        </div>
                    </div>
                }

                <div class="form-row-full">
                    <div class="form-field">
                        <label>DESCRIPCION:</label>
                        <textarea @bind="actividadEdit.Descripcion" 
                                  rows="3" 
                                  maxlength="500"
                                  disabled="@isSaving"
                                  class="hospital-textarea"></textarea>
                    </div>
                </div>

                <div class="hospital-info">
                    EMPLEADO: @registroSeleccionado.Empleado?.NombreCompleto | 
                    FECHA: @fechaSeleccionada.ToString("dd/MM/yyyy") | 
                    HORAS ACTUALES: @registroSeleccionado.TotalHoras.ToString("F1")
                </div>
            </div>

            <div class="hospital-modal-actions">
                <button @onclick="GuardarActividad" class="hospital-btn" disabled="@isSaving">
                    @(isSaving ? "GUARDANDO..." : "GUARDAR (F5)")
                </button>
                <button @onclick="CerrarModalActividad" class="hospital-btn" disabled="@isSaving">
                    CANCELAR (F8)
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal de confirmación -->
@if (showConfirmModal)
{
    <div class="hospital-modal-overlay">
        <div class="hospital-modal-small">
            <div class="hospital-modal-header">
                <h2>CONFIRMACION REQUERIDA</h2>
            </div>
            
            <div class="hospital-form">
                <p>@confirmMessage</p>
                @if (actividadAEliminar != null)
                {
                    <div class="hospital-info">
                        ACTIVIDAD: @actividadAEliminar.Actividad?.Nombre<br/>
                        HORAS: @actividadAEliminar.Horas.ToString("F1")<br/>
                        @if (!string.IsNullOrEmpty(actividadAEliminar.Descripcion))
                        {
                            <text>DESCRIPCION: @actividadAEliminar.Descripcion</text>
                        }
                    </div>
                }
            </div>
            
            <div class="hospital-modal-actions">
                <button @onclick="ConfirmarAccion" class="hospital-btn-danger">CONFIRMAR</button>
                <button @onclick="() => showConfirmModal = false" class="hospital-btn">CANCELAR</button>
            </div>
        </div>
    </div>
}

@code {
    // PARAMETROS DE RUTA
    [Parameter] public string? FechaParam { get; set; }
    
    // COLECCIONES DE DATOS
    private List<RegistroDiario> registrosDia = new();
    private List<RegistroDiario> registrosFiltrados = new();
    private List<Empleado> todosEmpleados = new();
    private List<Empleado> empleadosSinRegistro = new();
    private List<Departamento> departamentos = new();
    private List<Actividad> actividades = new();
    private List<Actividad> actividadesFiltradas = new();
    private List<CategoriaActividad> categoriasActividad = new();
    private List<Proyecto> proyectos = new();
    
    // ESTADO DE LA PAGINA
    private DateTime fechaSeleccionada = DateTime.Today;
    private RegistroDiario? registroSeleccionado;
    private DetalleActividad? actividadEdit;
    private DetalleActividad? actividadAEliminar;
    private Actividad? actividadSeleccionadaObj;
    
    private bool isLoading = false;
    private bool isSaving = false;
    private bool showModalActividad = false;
    private bool showConfirmModal = false;
    private bool isEditingActividad = false;
    private bool mostrarDetalle = false;
    private bool editandoObservaciones = false;
    
    // EDICION DE HORARIOS
    private int? editandoEntrada = null;
    private int? editandoSalida = null;
    
    // FILTROS Y BUSQUEDA
    private string searchTerm = string.Empty;
    private string filtroEstado = string.Empty;
    private string filtroDepartamento = string.Empty;
    private bool mostrarSoloActivos = true;
    private int categoriaFiltroId = 0;
    
    // MENSAJES
    private string? errorMessage;
    private string? successMessage;
    private string? confirmMessage;
    private Func<Task>? confirmarAccionCallback;
    
    // PROPIEDADES CALCULADAS
    private bool actividadSeleccionadaRequiereProyecto => 
        actividadSeleccionadaObj?.RequiereProyecto ?? false;
    
    // REFERENCIA AL INPUT DE BÚSQUEDA
    private ElementReference searchInputRef;
    
    // CICLO DE VIDA DEL COMPONENTE
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Validar autenticacion
            if (!AuthService.IsAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }
            
            // Parsear fecha del parametro si existe
            if (!string.IsNullOrEmpty(FechaParam))
            {
                if (DateTime.TryParse(FechaParam, out var fecha))
                {
                    fechaSeleccionada = fecha;
                }
            }
            
            // Cargar datos iniciales
            await CargarDatosIniciales();
            
            Logger.LogInformation("ControlDiario inicializado para fecha {Fecha}", 
                fechaSeleccionada.ToString("yyyy-MM-dd"));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar ControlDiario");
            errorMessage = $"ERROR AL CARGAR LA PAGINA: {ex.Message}";
        }
    }
    
    // ATAJOS DE TECLADO
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.addEventListener('keydown', function(e) {" +
                "    if (e.key === 'F2') {" +
                "        e.preventDefault();" +
                "        var searchInput = document.querySelector('.search-input');" +
                "        if (searchInput) { searchInput.focus(); searchInput.select(); }" +
                "    }" +
                "    if (e.key === 'F3') {" +
                "        e.preventDefault();" +
                "        var btnNuevo = document.querySelector('.hospital-btn-primary');" +
                "        if (btnNuevo && !btnNuevo.disabled) { btnNuevo.click(); }" +
                "    }" +
                "    if (e.key === 'F5') {" +
                "        e.preventDefault();" +
                "        var btnGuardar = document.querySelector('.hospital-modal-actions .hospital-btn');" +
                "        if (btnGuardar && !btnGuardar.disabled) { btnGuardar.click(); }" +
                "        else { var btnActualizar = document.querySelector('button[title*=Actualizar]'); if (btnActualizar) btnActualizar.click(); }" +
                "    }" +
                "    if (e.key === 'F8') {" +
                "        e.preventDefault();" +
                "        var modales = document.querySelectorAll('.hospital-modal-actions');" +
                "        if (modales.length > 0) { var btns = modales[modales.length-1].querySelectorAll('.hospital-btn'); if (btns.length > 1) btns[btns.length-1].click(); }" +
                "    }" +
                "    if (e.key === 'Escape') {" +
                "        var modal = document.querySelector('.hospital-modal-overlay');" +
                "        if (modal) { var btnCerrar = modal.querySelector('.hospital-modal-header .hospital-btn'); if (btnCerrar) btnCerrar.click(); }" +
                "        else { var searchInput = document.querySelector('.search-input'); if (searchInput && searchInput.value) { searchInput.value = ''; searchInput.dispatchEvent(new Event('input', { bubbles: true })); } }" +
                "    }" +
                "});");
        }
    }
    
    // CARGA DE DATOS
    private async Task CargarDatosIniciales()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Cargar en paralelo los datos maestros
            var empleadosTask = EmpleadoRepository.GetAllActiveAsync();
            var departamentosTask = DepartamentoRepository.GetAllActiveAsync();
            var actividadesTask = ActividadRepository.GetAllActiveWithCategoriaAsync();
            var categoriasTask = CategoriaActividadRepository.GetAllActiveAsync();
            var proyectosTask = ProyectoRepository.GetByEstadoAsync(EstadoProyecto.Activo);
            
            await Task.WhenAll(empleadosTask, departamentosTask, actividadesTask, categoriasTask, proyectosTask);
            
            todosEmpleados = (await empleadosTask).ToList();
            departamentos = (await departamentosTask).ToList();
            actividades = (await actividadesTask).OrderBy(a => a.Categoria?.Orden ?? 999).ThenBy(a => a.Orden).ToList();
            categoriasActividad = (await categoriasTask).ToList();
            proyectos = (await proyectosTask).OrderBy(p => p.Nombre).ToList();
            
            // Inicializar actividades filtradas
            actividadesFiltradas = actividades.ToList();
            
            // Cargar registros del dia
            await CargarRegistros();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos iniciales");
            errorMessage = $"ERROR AL CARGAR DATOS: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarRegistros()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Cargar registros del dia con sus relaciones
            var registros = await RegistroDiarioRepository.GetByFechaAsync(fechaSeleccionada);
            registrosDia = registros.OrderBy(r => r.Empleado?.NombreCompleto).ToList();
            
            // Cargar detalles de actividades para cada registro
            foreach (var registro in registrosDia)
            {
                if (registro.Empleado == null && registro.EmpleadoId > 0)
                {
                    registro.Empleado = await EmpleadoRepository.GetByIdAsync(registro.EmpleadoId);
                }
                
                var detalles = await DetalleActividadRepository.GetByRegistroAsync(registro.Id);
                registro.DetallesActividades = detalles.ToList();
            }
            
            // Identificar empleados sin registro
            var empleadosConRegistro = registrosDia.Select(r => r.EmpleadoId).ToHashSet();
            empleadosSinRegistro = todosEmpleados
                .Where(e => e.Estado == EstadoEmpleado.Activo && !empleadosConRegistro.Contains(e.Id))
                .OrderBy(e => e.NombreCompleto)
                .ToList();
            
            // Aplicar filtros
            await FiltrarRegistros();
            
            Logger.LogInformation("Cargados {Count} registros para fecha {Fecha}", 
                registrosDia.Count, fechaSeleccionada.ToString("yyyy-MM-dd"));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar registros");
            errorMessage = $"ERROR AL CARGAR REGISTROS: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    // NAVEGACION DE FECHAS
    private async Task CambiarFecha()
    {
        await CargarRegistros();
        Navigation.NavigateTo($"/control-diario/{fechaSeleccionada:yyyy-MM-dd}");
    }
    
    private async Task RetrocederDia()
    {
        fechaSeleccionada = fechaSeleccionada.AddDays(-1);
        await CambiarFecha();
    }
    
    private async Task AvanzarDia()
    {
        fechaSeleccionada = fechaSeleccionada.AddDays(1);
        await CambiarFecha();
    }
    
    private async Task IrHoy()
    {
        fechaSeleccionada = DateTime.Today;
        await CambiarFecha();
    }
    
    // FILTROS
    private async Task FiltrarRegistros()
    {
        registrosFiltrados = registrosDia;
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var termino = searchTerm.ToLower();
            registrosFiltrados = registrosFiltrados.Where(r =>
                r.Empleado?.NombreCompleto.ToLower().Contains(termino) == true ||
                r.Empleado?.Codigo.ToLower().Contains(termino) == true ||
                r.Empleado?.Cedula.Contains(termino) == true
            ).ToList();
        }
        
        if (!string.IsNullOrEmpty(filtroEstado) && int.TryParse(filtroEstado, out var estadoInt))
        {
            var estado = (EstadoRegistroDiario)estadoInt;
            registrosFiltrados = registrosFiltrados.Where(r => r.Estado == estado).ToList();
        }
        
        if (!string.IsNullOrEmpty(filtroDepartamento) && int.TryParse(filtroDepartamento, out var deptId))
        {
            registrosFiltrados = registrosFiltrados.Where(r => r.Empleado?.DepartamentoId == deptId).ToList();
        }
        
        if (mostrarSoloActivos)
        {
            registrosFiltrados = registrosFiltrados
                .Where(r => r.Empleado?.Estado == EstadoEmpleado.Activo)
                .ToList();
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    // SELECCION DE REGISTROS
    private void SeleccionarRegistro(RegistroDiario registro)
    {
        registroSeleccionado = registro;
        StateHasChanged();
    }
    
    // CREACION DE REGISTROS
    private async Task CrearRegistrosParaTodos()
    {
        if (!empleadosSinRegistro.Any())
        {
            errorMessage = "NO HAY EMPLEADOS SIN REGISTRO";
            return;
        }
        
        isSaving = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            var registrosCreados = 0;
            
            foreach (var empleado in empleadosSinRegistro)
            {
                var nuevoRegistro = new RegistroDiario
                {
                    Fecha = fechaSeleccionada,
                    EmpleadoId = empleado.Id,
                    Estado = EstadoRegistroDiario.Borrador,
                    FechaCreacion = DateTime.Now,
                    CreadoPorId = AuthService.CurrentUserId
                };
                
                await RegistroDiarioRepository.AddAsync(nuevoRegistro);
                registrosCreados++;
            }
            
            successMessage = $"REGISTROS CREADOS: {registrosCreados}";
            Logger.LogInformation("Creados {Count} registros para fecha {Fecha}", 
                registrosCreados, fechaSeleccionada.ToString("yyyy-MM-dd"));
            
            await CargarRegistros();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear registros masivos");
            errorMessage = $"ERROR AL CREAR REGISTROS: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
            
            if (successMessage != null)
            {
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
        }
    }
    
    // EDICION DE HORARIOS
    private void EditarEntrada(RegistroDiario registro)
    {
        editandoEntrada = registro.Id;
        editandoSalida = null;
        StateHasChanged();
    }
    
    private void EditarSalida(RegistroDiario registro)
    {
        editandoSalida = registro.Id;
        editandoEntrada = null;
        StateHasChanged();
    }
    
    private async Task GuardarHorario(RegistroDiario registro)
    {
        try
        {
            await RegistroDiarioRepository.UpdateAsync(registro);
            editandoEntrada = null;
            editandoSalida = null;
            
            Logger.LogInformation("Actualizado horario del registro {Id}", registro.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al actualizar horario del registro {Id}", registro.Id);
            errorMessage = $"ERROR AL GUARDAR HORARIO: {ex.Message}";
            StateHasChanged();
        }
    }
    
    // REGISTRO RAPIDO - Por registro específico (botones inline)
    private async Task RegistrarEntradaParaRegistro(RegistroDiario registro)
    {
        if (registro.HoraEntrada != null) return; // Ya tiene entrada
        
        registro.HoraEntrada = DateTime.Now.TimeOfDay;
        await GuardarHorario(registro);
        successMessage = $"ENTRADA REGISTRADA: {registro.Empleado?.NombreCompleto}";
        StateHasChanged();
        await Task.Delay(2000);
        successMessage = null;
        StateHasChanged();
    }
    
    private async Task RegistrarSalidaParaRegistro(RegistroDiario registro)
    {
        if (registro.HoraSalida != null) return; // Ya tiene salida
        
        registro.HoraSalida = DateTime.Now.TimeOfDay;
        await GuardarHorario(registro);
        successMessage = $"SALIDA REGISTRADA: {registro.Empleado?.NombreCompleto}";
        StateHasChanged();
        await Task.Delay(2000);
        successMessage = null;
        StateHasChanged();
    }
    
    // Métodos legacy (mantener compatibilidad)
    private async Task RegistrarEntrada()
    {
        if (registroSeleccionado == null)
        {
            errorMessage = "DEBE SELECCIONAR UN REGISTRO";
            return;
        }
        await RegistrarEntradaParaRegistro(registroSeleccionado);
    }
    
    private async Task RegistrarSalida()
    {
        if (registroSeleccionado == null)
        {
            errorMessage = "DEBE SELECCIONAR UN REGISTRO";
            return;
        }
        await RegistrarSalidaParaRegistro(registroSeleccionado);
    }
    
    // OBSERVACIONES
    private async Task GuardarObservaciones()
    {
        if (registroSeleccionado == null) return;
        
        try
        {
            await RegistroDiarioRepository.UpdateAsync(registroSeleccionado);
            editandoObservaciones = false;
            
            Logger.LogInformation("Actualizadas observaciones del registro {Id}", registroSeleccionado.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al actualizar observaciones del registro {Id}", registroSeleccionado.Id);
            errorMessage = $"ERROR AL GUARDAR OBSERVACIONES: {ex.Message}";
            StateHasChanged();
        }
    }
    
    // GESTION DE ACTIVIDADES
    private async Task AgregarActividad()
    {
        if (registroSeleccionado == null)
        {
            errorMessage = "DEBE SELECCIONAR UN REGISTRO";
            return;
        }
        
        await AgregarActividadParaRegistro(registroSeleccionado);
    }
    
    private async Task AgregarActividadParaRegistro(RegistroDiario registro)
    {
        registroSeleccionado = registro;
        isEditingActividad = false;
        
        var maxOrden = registro.DetallesActividades?.Any() == true 
            ? registro.DetallesActividades.Max(d => d.Orden) 
            : 0;
        
        actividadEdit = new DetalleActividad
        {
            RegistroDiarioId = registro.Id,
            RegistroDiario = registro,
            Horas = 1.0m,
            Orden = maxOrden + 1,
            FechaCreacion = DateTime.Now
        };
        
        actividadSeleccionadaObj = null;
        categoriaFiltroId = 0;
        actividadesFiltradas = actividades.OrderByDescending(a => a.EsDestacada).ThenBy(a => a.Orden).ToList();
        showModalActividad = true;
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    private async Task EditarActividad(DetalleActividad detalle)
    {
        isEditingActividad = true;
        // No copiar Id manualmente - se asigna después para evitar antipatrón
        actividadEdit = new DetalleActividad
        {
            RegistroDiarioId = detalle.RegistroDiarioId,
            ActividadId = detalle.ActividadId,
            ProyectoId = detalle.ProyectoId,
            Horas = detalle.Horas,
            Descripcion = detalle.Descripcion,
            HoraInicio = detalle.HoraInicio,
            HoraFin = detalle.HoraFin,
            Orden = detalle.Orden,
            Cantidad = detalle.Cantidad,
            UnidadMedida = detalle.UnidadMedida,
            LoteEspecifico = detalle.LoteEspecifico
        };
        actividadEdit.Id = detalle.Id;
        
        actividadSeleccionadaObj = actividades.FirstOrDefault(a => a.Id == detalle.ActividadId);
        categoriaFiltroId = actividadSeleccionadaObj?.CategoriaId ?? 0;
        FiltrarActividadesPorCategoria();
        showModalActividad = true;
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    private async Task GuardarActividad()
    {
        if (actividadEdit == null || registroSeleccionado == null)
        {
            errorMessage = "DATOS INCOMPLETOS";
            return;
        }
        
        // Validaciones
        if (actividadEdit.ActividadId <= 0)
        {
            errorMessage = "DEBE SELECCIONAR UNA ACTIVIDAD";
            return;
        }
        
        if (actividadSeleccionadaRequiereProyecto && (actividadEdit.ProyectoId == null || actividadEdit.ProyectoId <= 0))
        {
            errorMessage = "ESTA ACTIVIDAD REQUIERE UN PROYECTO";
            return;
        }
        
        if (actividadEdit.Horas <= 0)
        {
            errorMessage = "LAS HORAS DEBEN SER MAYOR A 0";
            return;
        }
        
        // Validar cantidad si es requerida
        if (actividadSeleccionadaObj?.RequiereCantidad == true)
        {
            if (!actividadEdit.Cantidad.HasValue || actividadEdit.Cantidad <= 0)
            {
                errorMessage = "DEBE INGRESAR LA CANTIDAD REALIZADA";
                return;
            }
            
            // Copiar unidad de medida de la actividad
            actividadEdit.UnidadMedida = actividadSeleccionadaObj.UnidadAbreviatura;
        }
        
        isSaving = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            if (isEditingActividad)
            {
                await RegistroDiarioRepository.UpdateDetalleAsync(actividadEdit);
                Logger.LogInformation("Actualizada actividad {Id} del registro {RegistroId}", 
                    actividadEdit.Id, registroSeleccionado.Id);
                successMessage = "ACTIVIDAD ACTUALIZADA";
            }
            else
            {
                var nuevaActividad = await RegistroDiarioRepository.AddDetalleAsync(
                    registroSeleccionado.Id, 
                    actividadEdit);
                Logger.LogInformation("Creada actividad {Id} para registro {RegistroId}", 
                    nuevaActividad.Id, registroSeleccionado.Id);
                successMessage = "ACTIVIDAD AGREGADA";
            }
            
            // Recargar el registro con sus detalles actualizados
            var registroActualizado = await RegistroDiarioRepository.GetByIdWithDetallesAsync(registroSeleccionado.Id);
            if (registroActualizado != null)
            {
                var index = registrosDia.FindIndex(r => r.Id == registroActualizado.Id);
                if (index >= 0)
                {
                    registrosDia[index] = registroActualizado;
                }
                
                registroSeleccionado = registroActualizado;
            }
            
            await FiltrarRegistros();
            CerrarModalActividad();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar actividad");
            errorMessage = $"ERROR AL GUARDAR ACTIVIDAD: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
            
            if (successMessage != null)
            {
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
        }
    }
    
    private async Task EliminarActividad(DetalleActividad detalle)
    {
        actividadAEliminar = detalle;
        confirmMessage = "ESTA SEGURO QUE DESEA ELIMINAR ESTA ACTIVIDAD?";
        confirmarAccionCallback = async () => await ConfirmarEliminarActividad();
        showConfirmModal = true;
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    private async Task ConfirmarEliminarActividad()
    {
        if (actividadAEliminar == null || registroSeleccionado == null)
        {
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            await RegistroDiarioRepository.DeleteDetalleAsync(
                registroSeleccionado.Id, 
                actividadAEliminar.Id);
            
            Logger.LogInformation("Eliminada actividad {Id} del registro {RegistroId}", 
                actividadAEliminar.Id, registroSeleccionado.Id);
            
            // Recargar el registro
            var registroActualizado = await RegistroDiarioRepository.GetByIdWithDetallesAsync(registroSeleccionado.Id);
            if (registroActualizado != null)
            {
                var index = registrosDia.FindIndex(r => r.Id == registroActualizado.Id);
                if (index >= 0)
                {
                    registrosDia[index] = registroActualizado;
                }
                
                registroSeleccionado = registroActualizado;
            }
            
            await FiltrarRegistros();
            
            successMessage = "ACTIVIDAD ELIMINADA";
            showConfirmModal = false;
            actividadAEliminar = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar actividad");
            errorMessage = $"ERROR AL ELIMINAR ACTIVIDAD: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
            
            if (successMessage != null)
            {
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
        }
    }
    
    // CAMBIO DE ESTADO
    private async Task CompletarRegistroSeleccionado()
    {
        if (registroSeleccionado == null) return;
        await CompletarRegistro(registroSeleccionado);
    }
    
    private async Task CompletarRegistro(RegistroDiario registro)
    {
        if (!registro.EstaCompleto)
        {
            errorMessage = "EL REGISTRO DEBE TENER HORA DE ENTRADA, SALIDA Y AL MENOS UNA ACTIVIDAD";
            return;
        }
        
        try
        {
            registro.Estado = EstadoRegistroDiario.Completado;
            registro.FechaModificacion = DateTime.Now;
            
            await RegistroDiarioRepository.UpdateAsync(registro);
            
            Logger.LogInformation("Completado registro {Id}", registro.Id);
            
            successMessage = $"REGISTRO COMPLETADO: {registro.Empleado?.NombreCompleto}";
            await FiltrarRegistros();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al completar registro {Id}", registro.Id);
            errorMessage = $"ERROR AL COMPLETAR REGISTRO: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
            
            if (successMessage != null)
            {
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
        }
    }
    
    // EVENTOS DE FORMULARIO
    private async Task OnActividadChanged()
    {
        if (actividadEdit != null && actividadEdit.ActividadId > 0)
        {
            actividadSeleccionadaObj = actividades.FirstOrDefault(a => a.Id == actividadEdit.ActividadId);
            
            if (actividadSeleccionadaObj?.RequiereProyecto == false)
            {
                actividadEdit.ProyectoId = null;
            }
        }
        else
        {
            actividadSeleccionadaObj = null;
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private async Task CalcularHorasFin()
    {
        if (actividadEdit?.HoraInicio != null && actividadEdit.Horas > 0)
        {
            var horaInicio = actividadEdit.HoraInicio.Value;
            var horasTotales = actividadEdit.Horas;
            var horas = (int)horasTotales;
            var minutos = (int)((horasTotales - horas) * 60);
            
            actividadEdit.HoraFin = horaInicio.Add(new TimeSpan(horas, minutos, 0));
            StateHasChanged();
        }
        
        await Task.CompletedTask;
    }
    
    private async Task CalcularHorasDesdeRango()
    {
        if (actividadEdit?.HoraInicio != null && actividadEdit.HoraFin != null)
        {
            var diferencia = actividadEdit.HoraFin.Value - actividadEdit.HoraInicio.Value;
            if (diferencia.TotalHours > 0)
            {
                actividadEdit.Horas = (decimal)diferencia.TotalHours;
                StateHasChanged();
            }
        }
        
        await Task.CompletedTask;
    }
    
    // DETALLE Y MODALES
    private async Task VerDetalleRegistro(RegistroDiario registro)
    {
        registroSeleccionado = registro;
        mostrarDetalle = true;
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private async Task CerrarDetalle()
    {
        mostrarDetalle = false;
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private void CerrarModalActividad()
    {
        showModalActividad = false;
        actividadEdit = null;
        actividadSeleccionadaObj = null;
        isEditingActividad = false;
        StateHasChanged();
    }
    
    private async Task ConfirmarAccion()
    {
        if (confirmarAccionCallback != null)
        {
            await confirmarAccionCallback.Invoke();
        }
    }
    
    // NAVEGACIÓN CONTEXTUAL
    private void IrAlWizard()
    {
        Navigation.NavigateTo("/control-diario-wizard");
    }
    
    private void IrAReportes()
    {
        Navigation.NavigateTo("/reportes");
    }
    
    private void IrAProductividad()
    {
        Navigation.NavigateTo("/dashboard-productividad");
    }
    
    private void IrAExpediente(int empleadoId)
    {
        if (empleadoId > 0)
        {
            Navigation.NavigateTo($"/empleado-expediente/{empleadoId}");
        }
    }
    
    // BÚSQUEDA
    private async Task LimpiarBusqueda()
    {
        searchTerm = string.Empty;
        await FiltrarRegistros();
    }
    
    // METODOS AUXILIARES
    private string FormatTimeSpan(TimeSpan? time) => time?.ToString(@"hh\:mm") ?? "";
    
    private TimeSpan? ParseTimeSpan(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return TimeSpan.TryParse(value, out var time) ? time : null;
    }
    
    // Filtrar actividades por categoría
    private void FiltrarActividadesPorCategoria()
    {
        if (categoriaFiltroId > 0)
        {
            actividadesFiltradas = actividades.Where(a => a.CategoriaId == categoriaFiltroId).ToList();
        }
        else
        {
            actividadesFiltradas = actividades.ToList();
        }
        
        // Ordenar: destacadas primero, luego por orden
        actividadesFiltradas = actividadesFiltradas
            .OrderByDescending(a => a.EsDestacada)
            .ThenBy(a => a.Orden)
            .ThenBy(a => a.Nombre)
            .ToList();
        
        StateHasChanged();
    }
    
    // Obtener clasificación CSS según clasificación de productividad (string)
    private string GetClasificacionCss(string clasificacion)
    {
        return clasificacion switch
        {
            "EXCELENTE" => "productividad-excelente",
            "ÓPTIMO" => "productividad-optimo",
            "ACEPTABLE" => "productividad-aceptable",
            "BAJO" => "productividad-bajo",
            "CRÍTICO" => "productividad-critico",
            _ => ""
        };
    }
    
    // Obtener clasificación CSS según porcentaje de productividad (decimal)
    private string GetClasificacionCss(decimal porcentaje)
    {
        return porcentaje switch
        {
            >= 120 => "productividad-excelente",
            >= 100 => "productividad-optimo",
            >= 80 => "productividad-aceptable",
            >= 60 => "productividad-bajo",
            _ => "productividad-critico"
        };
    }
    
    // Obtener texto de clasificación según clasificación de productividad (string)
    private string GetClasificacionTexto(string clasificacion)
    {
        return clasificacion switch
        {
            "EXCELENTE" => "Supera el rendimiento esperado",
            "ÓPTIMO" => "Alcanza el rendimiento esperado",
            "ACEPTABLE" => "Rendimiento aceptable",
            "BAJO" => "Rendimiento por debajo de lo esperado",
            "CRÍTICO" => "Rendimiento muy bajo",
            _ => "Sin datos de rendimiento"
        };
    }
    
    // Obtener texto de clasificación según porcentaje de productividad (decimal)
    private string GetClasificacionTexto(decimal porcentaje)
    {
        return porcentaje switch
        {
            >= 120 => "EXCELENTE",
            >= 100 => "ÓPTIMO",
            >= 80 => "ACEPTABLE",
            >= 60 => "BAJO",
            _ => "CRÍTICO"
        };
    }
}
