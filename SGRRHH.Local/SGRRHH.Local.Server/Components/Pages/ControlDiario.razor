@page "/control-diario"
@page "/control-diario/{FechaParam}"
@using SGRRHH.Local.Domain.Enums

<PageTitle>Control Diario - SGRRHH</PageTitle>

<div class="hospital-page">
    <ControlDiarioHeader
        FechaSeleccionada="@fechaSeleccionada"
        ErrorMessage="@errorMessage"
        SuccessMessage="@successMessage"
        OnClearError="@LimpiarError" />

    <div class="control-bar-principal">
        <DateNavigator
            @bind-FechaSeleccionada="fechaSeleccionada"
            OnFechaChanged="@CambiarFecha" />

        <FiltrosDiarios
            @bind-SearchTerm="searchTerm"
            OnFilterChanged="@FiltrarRegistros" />

        <AccionesMasivasPanel
            EmpleadosSinRegistroCount="@empleadosSinRegistro.Count"
            OnCargarRegistros="@CargarRegistros"
            OnCrearRegistros="@CrearRegistrosParaTodos" />
    </div>

    <ResumenDiarioCard
        TotalRegistros="@registrosDia.Count"
        RegistrosFiltrados="@registrosFiltrados.Count"
        Completados="@registrosDia.Count(r => r.Estado == EstadoRegistroDiario.Completado || r.Estado == EstadoRegistroDiario.Aprobado)"
        Pendientes="@registrosDia.Count(r => r.Estado == EstadoRegistroDiario.Borrador)"
        TotalHoras="@registrosDia.Sum(r => r.TotalHoras)"
        SearchTerm="@searchTerm" />

    <div class="control-diario-tabs">
        <button class="tab-btn @(activeTab == 1 ? "active" : "")" @onclick="() => CambiarTab(1)">1. ASISTENCIA</button>
        <button class="tab-btn @(activeTab == 2 ? "active" : "")" @onclick="() => CambiarTab(2)">2. PRODUCCION</button>
        <button class="tab-btn @(activeTab == 3 ? "active" : "")" @onclick="() => CambiarTab(3)">3. CIERRE</button>
    </div>

    <div class="hospital-table-container">
        <table class="hospital-table">
            <thead>
                <tr>
                    <th>CODIGO</th>
                    <th>NOMBRE COMPLETO</th>
                    <th>DEPARTAMENTO</th>
                    @if (activeTab == 3) { <th>FECHA</th> }
                    @if (activeTab == 1 || activeTab == 3)
                    {
                        <th>HORA ENTRADA</th>
                        <th>HORA SALIDA</th>
                    }
                    @if (activeTab == 2 || activeTab == 3)
                    {
                        <th>TOTAL HORAS</th>
                        <th>NUM ACTIVIDADES</th>
                    }
                    @if (activeTab == 1 || activeTab == 3)
                    {
                        <th>ESTADO</th>
                    }
                    @if (activeTab == 2 || activeTab == 3)
                    {
                        <th>OBSERVACIONES</th>
                    }
                    @if (activeTab == 3) { <th>FECHA CREACION</th> }
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr><td colspan="12" class="hospital-loading">CARGANDO REGISTROS...</td></tr>
                }
                else if (!registrosFiltrados.Any())
                {
                    <tr><td colspan="12" class="hospital-empty">
                        SIN REGISTROS PARA LA FECHA SELECCIONADA
                        @if (empleadosSinRegistro.Any())
                        {
                            <br />
                            <button @onclick="CrearRegistrosParaTodos" class="hospital-btn">
                                CREAR REGISTROS PARA @empleadosSinRegistro.Count EMPLEADOS
                            </button>
                        }
                    </td></tr>
                }
                else
                {
                    @foreach (var registro in registrosFiltrados)
                    {
                        var isSelected = registroSeleccionado?.Id == registro.Id;
                        <EmpleadoRow
                            Registro="@registro"
                            ModoVisualizacion="@activeTab"
                            IsSelected="@isSelected"
                            EditandoEntradaId="@editandoEntrada"
                            EditandoSalidaId="@editandoSalida"
                            OnSeleccionar="@SeleccionarRegistro"
                            OnEditarEntrada="@EditarEntrada"
                            OnEditarSalida="@EditarSalida"
                            OnGuardarHorario="@GuardarHorario"
                            OnRegistrarEntrada="@RegistrarEntradaParaRegistro"
                            OnRegistrarSalida="@RegistrarSalidaParaRegistro"
                            OnAgregarActividad="@AgregarActividadParaRegistro"
                            OnCompletar="@CompletarRegistro"
                            OnVerDetalle="@VerDetalleRegistro"
                            OnIrAExpediente="@IrAExpediente" />
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="leyenda-acciones">
        <span class="leyenda-titulo">ACCIONES:</span>
        <span class="leyenda-item"><span class="btn-mini btn-entrada">E</span> = Entrada</span>
        <span class="leyenda-item"><span class="btn-mini btn-salida">S</span> = Salida</span>
        <span class="leyenda-item"><span class="btn-mini btn-actividad">+</span> = Agregar Actividad</span>
        <span class="leyenda-item"><span class="btn-mini btn-completar">✓</span> = Completar</span>
        <span class="leyenda-item"><span class="btn-mini btn-ver">⋯</span> = Ver Detalle</span>
    </div>

    <div class="enlaces-secundarios">
        <span class="enlaces-label">IR A:</span>
        <a href="javascript:void(0)" @onclick="IrAlWizard" class="enlace-secundario">Wizard Masivo</a>
        <span class="enlaces-sep">•</span>
        <a href="javascript:void(0)" @onclick="IrAReportes" class="enlace-secundario">Reportes</a>
        <span class="enlaces-sep">•</span>
        <a href="javascript:void(0)" @onclick="IrAProductividad" class="enlace-secundario">Dashboard Productividad</a>
        <span class="atajos-teclado">F2=Buscar • F3=Nuevo • F5=Guardar • ESC=Cerrar</span>
    </div>
</div>

<RegistroAsistenciaModal
    RegistroSeleccionado="@registroSeleccionado"
    MostrarDetalle="@mostrarDetalle"
    EditandoObservaciones="@editandoObservaciones"
    OnCerrar="@CerrarDetalle"
    OnGuardarObservaciones="@GuardarObservaciones"
    OnEditarObservaciones="@IniciarEdicionObservaciones"
    OnCancelarObservaciones="@CancelarEdicionObservaciones"
    OnAgregarActividad="@AgregarActividad"
    OnEditarActividad="@EditarActividad"
    OnEliminarActividad="@EliminarActividad" />

<ActividadSelector
    MostrarModal="@showModalActividad"
    IsEditingActividad="@isEditingActividad"
    IsSaving="@isSaving"
    ActividadEdit="@actividadEdit"
    RegistroSeleccionado="@registroSeleccionado"
    CategoriasActividad="@categoriasActividad"
    ActividadesFiltradas="@actividadesFiltradas"
    Proyectos="@proyectos"
    CategoriaFiltroId="@categoriaFiltroId"
    CategoriaFiltroIdChanged="@((int value) => categoriaFiltroId = value)"
    ActividadSeleccionadaObj="@actividadSeleccionadaObj"
    ActividadSeleccionadaRequiereProyecto="@actividadSeleccionadaRequiereProyecto"
    FechaSeleccionada="@fechaSeleccionada"
    OnActividadChanged="@OnActividadChanged"
    OnFiltrarCategoria="@FiltrarActividadesPorCategoria"
    OnGuardarActividad="@GuardarActividad"
    OnCerrarModal="@CerrarModalActividad"
    OnCalcularHorasFin="@CalcularHorasFin"
    OnCalcularHorasDesdeRango="@CalcularHorasDesdeRango" />

@if (showConfirmModal)
{
    <div class="hospital-modal-overlay">
        <div class="hospital-modal-small">
            <div class="hospital-modal-header">
                <h2>CONFIRMACION REQUERIDA</h2>
            </div>

            <div class="hospital-form">
                <p>@confirmMessage</p>
                @if (actividadAEliminar != null)
                {
                    <div class="hospital-info">
                        ACTIVIDAD: @actividadAEliminar.Actividad?.Nombre<br />
                        HORAS: @actividadAEliminar.Horas.ToString("F1")<br />
                        @if (!string.IsNullOrEmpty(actividadAEliminar.Descripcion))
                        {
                            <text>DESCRIPCION: @actividadAEliminar.Descripcion</text>
                        }
                    </div>
                }
            </div>

            <div class="hospital-modal-actions">
                <button @onclick="ConfirmarAccion" class="hospital-btn-danger">CONFIRMAR</button>
                <button @onclick="() => showConfirmModal = false" class="hospital-btn">CANCELAR</button>
            </div>
        </div>
    </div>
}
