@page "/empleados"
@page "/empleados/{EmpleadoIdParam:int?}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject IExportService ExportService
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Empleados> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Empleados - SGRRHH</PageTitle>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Courier New', monospace;
        background: #FFFFFF;
        color: #000000;
        min-width: 1024px;
    }

    .page-container {
        width: 100%;
        min-width: 1024px;
        padding: 20px;
    }

    .page-header {
        border-bottom: 2px solid #000000;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 18px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .action-bar {
        border: 1px solid #000000;
        padding: 10px;
        margin-bottom: 20px;
        background: #FFFFFF;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .btn {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 8px 16px;
        border: 2px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
    }

    .btn:hover:not(:disabled) {
        background: #F0F0F0;
    }

    .btn:disabled {
        border-color: #CCCCCC;
        color: #CCCCCC;
        cursor: not-allowed;
        background: #F9F9F9;
    }

    .filter-section {
        border-top: 1px solid #CCCCCC;
        padding-top: 10px;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-label {
        font-size: 11px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
    }

    .filter-input,
    .filter-select {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 6px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        min-width: 200px;
    }

    .filter-select {
        min-width: 150px;
    }

    .results-info {
        font-size: 12px;
        color: #000000;
        padding: 10px 0;
        border-bottom: 1px solid #CCCCCC;
        margin-bottom: 10px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid #000000;
        background: #FFFFFF;
        font-size: 11px;
    }

    .data-table thead {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
    }

    .data-table th {
        padding: 8px;
        text-align: left;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        border-right: 1px solid #CCCCCC;
        font-size: 10px;
        letter-spacing: 1px;
    }

    .data-table th:last-child {
        border-right: none;
    }

    .data-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #CCCCCC;
        border-right: 1px solid #CCCCCC;
        color: #000000;
    }

    .data-table td:last-child {
        border-right: none;
    }

    .data-table tbody tr:hover {
        background: #F9F9F9;
    }

    .data-table tbody tr.selected {
        background: #E8E8E8;
    }

    .loading-message,
    .empty-message {
        text-align: center;
        padding: 40px;
        color: #666666;
        font-size: 12px;
    }

    .cell-code {
        font-weight: bold;
    }

    .cell-estado {
        text-transform: uppercase;
        font-size: 10px;
    }

    .estado-activo {
        color: #006400;
    }

    .estado-retirado {
        color: #8B0000;
    }

    .estado-pendiente {
        color: #B8860B;
    }

    .estado-vacaciones {
        color: #4B0082;
    }

    .estado-suspendido {
        color: #DC143C;
    }

    .cell-actions {
        white-space: nowrap;
    }

    .btn-table {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 4px 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        margin-right: 4px;
        text-transform: uppercase;
    }

    .btn-table:hover {
        background: #F0F0F0;
    }

    .btn-table.btn-danger-small {
        color: #ff0000;
        border-color: #ff0000;
    }

    .btn-table.btn-danger-small:hover {
        background: #ff0000;
        color: #FFFFFF;
    }

    .pagination-bar {
        border-top: 2px solid #000000;
        padding-top: 15px;
        margin-top: 15px;
        text-align: center;
        font-size: 12px;
    }

    .shortcuts-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #000000;
        color: #FFFFFF;
        padding: 8px 20px;
        font-size: 11px;
        border-top: 2px solid #000000;
        display: flex;
        gap: 20px;
        z-index: 1000;
    }

    .shortcut-item {
        display: flex;
        gap: 5px;
    }

    .shortcut-key {
        font-weight: bold;
        color: #FFFF00;
    }

    .error-message {
        border: 2px solid #FF0000;
        background: #FFFFFF;
        color: #FF0000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .success-message {
        border: 2px solid #008000;
        background: #FFFFFF;
        color: #008000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .warning-message {
        border: 2px solid #FFA500;
        background: #FFFFFF;
        color: #B8860B;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }
</style>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<!-- Unsaved Changes Guard -->
<UnsavedChangesGuard @ref="unsavedChangesGuard" HasChanges="hasUnsavedChanges" />

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">GESTI�N DE EMPLEADOS</h1>
    </div>

    <div class="action-bar">
        <div class="action-buttons">
            <button class="btn" @onclick="NuevoEmpleadoOnboarding">NUEVO (F3)</button>
            <button class="btn" @onclick="CargarEmpleados">ACTUALIZAR (F5)</button>
            <button class="btn" @onclick="Buscar">BUSCAR (F2)</button>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">BUSCAR:</label>
                <input type="text" 
                       id="searchInput" 
                       class="filter-input"
                       @bind="searchTerm" 
                       @bind:event="oninput" 
                       @onkeyup="OnSearchKeyUp" />
            </div>
            
            <div class="filter-group">
                <label class="filter-label">ESTADO:</label>
                <select class="filter-select" @bind="filtroEstado" @bind:after="Filtrar">
                    <option value="">TODOS</option>
                    <option value="@((int)EstadoEmpleado.Activo)">ACTIVOS</option>
                    <option value="@((int)EstadoEmpleado.Retirado)">RETIRADOS</option>
                    <option value="@((int)EstadoEmpleado.PendienteAprobacion)">PENDIENTES</option>
                    <option value="@((int)EstadoEmpleado.EnVacaciones)">EN VACACIONES</option>
                    <option value="@((int)EstadoEmpleado.Suspendido)">SUSPENDIDOS</option>
                </select>
            </div>
            
            @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filtroEstado))
            {
                <button class="btn" @onclick="LimpiarFiltros">LIMPIAR FILTROS</button>
            }
        </div>
    </div>

    <div class="results-info">
        Mostrando @empleados.Count de @totalEmpleados registro(s)
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>C�DIGO</th>
                <th>C�DULA</th>
                <th>NOMBRES</th>
                <th>APELLIDOS</th>
                <th>FECHA NACIMIENTO</th>
                <th>G�NERO</th>
                <th>ESTADO CIVIL</th>
                <th>TEL�FONO</th>
                <th>EMAIL</th>
                <th>FECHA INGRESO</th>
                <th>FECHA RETIRO</th>
                <th>CARGO</th>
                <th>DEPARTAMENTO</th>
                <th>ESTADO</th>
                <th>TIPO CONTRATO</th>
                <th>SALARIO BASE</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="17" class="loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!empleados.Any())
            {
                <tr><td colspan="17" class="empty-message">NO HAY REGISTROS PARA MOSTRAR</td></tr>
            }
            else
            {
                @foreach (var emp in empleados)
                {
                    <tr class="@(selectedEmpleado?.Id == emp.Id ? "selected" : "")"
                        @onclick="() => SelectEmpleado(emp)">
                        <td class="cell-code">@emp.Codigo</td>
                        <td>@NumberFormatHelper.FormatearCedula(emp.Cedula)</td>
                        <td>@emp.Nombres</td>
                        <td>@emp.Apellidos</td>
                        <td>@(emp.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td>@(emp.Genero?.ToString() ?? "-")</td>
                        <td>@(emp.EstadoCivil?.ToString() ?? "-")</td>
                        <td>@(string.IsNullOrEmpty(emp.Telefono) ? "-" : NumberFormatHelper.FormatearTelefono(emp.Telefono))</td>
                        <td>@(emp.Email ?? "-")</td>
                        <td>@emp.FechaIngreso.ToString("dd/MM/yyyy")</td>
                        <td>@(emp.FechaRetiro?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td>@(emp.Cargo?.Nombre ?? "-")</td>
                        <td>@(emp.Departamento?.Nombre ?? "-")</td>
                        <td class="cell-estado estado-@GetEstadoClass(emp.Estado)">@emp.Estado.ToString().ToUpper()</td>
                        @* <td>@emp.TipoContrato.ToString()</td> *@ @* Campo eliminado - ver Contrato *@
                        <td>@NumberFormatHelper.FormatearMoneda(emp.SalarioBase)</td>
                        <td class="cell-actions">
                            <button class="btn-table" @onclick="() => EditarEmpleado(emp)" @onclick:stopPropagation="true">EDITAR</button>
                            @if (AuthService.IsAdmin)
                            {
                                <button class="btn-table btn-danger-small" @onclick="() => ConfirmarEliminarEmpleado(emp)" @onclick:stopPropagation="true">ELIMINAR</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    @if (totalEmpleados > pageSize)
    {
        <div class="pagination-bar">
            Mostrando @(((currentPage - 1) * pageSize) + 1) a @(Math.Min(currentPage * pageSize, totalEmpleados)) de @totalEmpleados registro(s) | P�gina @currentPage de @((int)Math.Ceiling((double)totalEmpleados / pageSize))
        </div>
    }
</div>

<div class="shortcuts-bar">
    <div class="shortcut-item">
        <span class="shortcut-key">F2</span>
        <span>=BUSCAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">F3</span>
        <span>=NUEVO</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">TAB</span>
        <span>=NAVEGAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

<!-- Modal de Confirmaci�n para Eliminar/Desactivar -->
@if (showConfirmModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>CONFIRMAR ACCI�N</h3>
            <div class="modal-content">
                <p>@confirmMessage</p>
            </div>
            <div class="modal-actions">
                <button @onclick="() => showConfirmModal = false">CANCELAR</button>
                <button class="btn-danger" @onclick="ConfirmarAccion">CONFIRMAR</button>
            </div>
        </div>
    </div>
}

<!-- Modal de Formulario de Empleado -->
<EmpleadoForm IsOpen="showModal"
              Empleado="empleadoEdit"
              IsEditing="isEditing"
              OnSave="Guardar"
              OnClose="CerrarModal" />

@code {
    [Parameter] public int? EmpleadoIdParam { get; set; }
    
    private const string PageId = "empleados";
    private MessageToast? messageToast;
    private UnsavedChangesGuard? unsavedChangesGuard;
    
    private List<Empleado> todosEmpleados = new();
    private List<Empleado> empleados = new();
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    private Empleado? selectedEmpleado;
    private Empleado? empleadoEdit;
    private Empleado? empleadoOriginal; // Para detectar cambios
    
    // Paginaci�n
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalEmpleados;
    
    private bool isLoading;
    private bool showModal;
    private bool isSaving;
    private bool isEditing;
    private bool isExporting;
    private bool hasUnsavedChanges;
    
    private string searchTerm = "";
    private string filtroEstado = "";
    
    private IBrowserFile? fotoFile;
    private string? fotoPreviewUrl;
    
    private bool showConfirmModal;
    private string confirmMessage = "";
    private Action? confirmAction;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Registrar atajos de teclado para esta página
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F2", KeyDisplay = "F2", Description = "Buscar", Action = FocusBusqueda, Priority = 10 },
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = () => { NuevoEmpleadoOnboarding(); return Task.CompletedTask; }, Priority = 10 },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarEmpleados, Priority = 10 },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModal, Priority = 10 }
        });
        
        await CargarCatalogos();
        await CargarEmpleados();
        
        // Si viene con parámetro, abrir ese empleado
        if (EmpleadoIdParam.HasValue && EmpleadoIdParam.Value > 0)
        {
            var empleado = await EmpleadoRepo.GetByIdWithRelationsAsync(EmpleadoIdParam.Value);
            if (empleado != null)
            {
                await EditarEmpleado(empleado);
            }
        }
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            // Usar cach� para cat�logos
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
            
            Logger.LogInformation("Cat�logos cargados desde cach�: {CargosCount} cargos, {DeptoCount} departamentos", 
                cargos.Count, departamentos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando cat�logos");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
    }
    
    private async Task CargarEmpleados()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            todosEmpleados = (await EmpleadoRepo.GetAllWithRelationsAsync()).ToList();
            
            // Aplicar filtros
            var filtrados = todosEmpleados
                .Where(e => string.IsNullOrEmpty(filtroEstado) || e.Estado == (EstadoEmpleado)int.Parse(filtroEstado))
                .Where(e => string.IsNullOrEmpty(searchTerm) || 
                    e.Codigo.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    e.Cedula.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    e.NombreCompleto.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (e.Cargo?.Nombre?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (e.Departamento?.Nombre?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                .OrderBy(e => e.Codigo)
                .ToList();
            
            totalEmpleados = filtrados.Count;
            
            // Aplicar paginaci�n
            empleados = filtrados
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
            
            Logger.LogInformation("Empleados cargados: {Count} de {Total} (P�gina {Page})", 
                empleados.Count, totalEmpleados, currentPage);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando empleados");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void NuevoEmpleadoOnboarding()
    {
        Navigation.NavigateTo("/empleados/onboarding");
    }
    
    private async Task EditarEmpleado(Empleado empleado)
    {
        Navigation.NavigateTo($"/empleados/{empleado.Id}/expediente");
    }
    
    private async Task EditarSeleccionado()
    {
        if (selectedEmpleado != null)
        {
            await EditarEmpleado(selectedEmpleado);
        }
    }

    private Empleado? empleadoAEliminar;

    private void ConfirmarEliminarEmpleado(Empleado empleado)
    {
        empleadoAEliminar = empleado;
        confirmMessage = $"�Est� seguro que desea ELIMINAR permanentemente al empleado {empleado.Codigo} - {empleado.NombreCompleto}? Esta acci�n NO puede deshacerse y eliminar� todos los documentos, contratos y registros asociados.";
        confirmAction = async () => await EliminarEmpleado();
        showConfirmModal = true;
    }

    private async Task EliminarEmpleado()
    {
        if (empleadoAEliminar == null) return;

        try
        {
            // Primero eliminar documentos asociados
            var documentos = await DocumentoRepo.GetByEmpleadoIdAsync(empleadoAEliminar.Id);
            foreach (var doc in documentos)
            {
                if (doc.Id > 0)
                {
                    await StorageService.DeleteDocumentoEmpleadoAsync(doc.Id);
                }
                await DocumentoRepo.DeleteAsync(doc.Id);
            }

            // Eliminar foto si existe
            await StorageService.DeleteEmpleadoFotoAsync(empleadoAEliminar.Id);

            // Eliminar el empleado
            await EmpleadoRepo.DeleteAsync(empleadoAEliminar.Id);

            messageToast?.ShowSuccess($"Empleado {empleadoAEliminar.Codigo} eliminado correctamente");
            Logger.LogInformation("Empleado eliminado: {Codigo} - {Nombre}", empleadoAEliminar.Codigo, empleadoAEliminar.NombreCompleto);

            empleadoAEliminar = null;
            await CargarEmpleados();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error eliminando empleado {Id}", empleadoAEliminar?.Id);
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
    }
    
    private async Task Guardar()
    {
        if (empleadoEdit == null) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            // Validaciones
            if (string.IsNullOrWhiteSpace(empleadoEdit.Codigo))
            {
                messageToast?.ShowError("El c�digo es requerido");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Cedula))
            {
                messageToast?.ShowError("La c�dula es requerida");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Nombres))
            {
                messageToast?.ShowError("Los nombres son requeridos");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Apellidos))
            {
                messageToast?.ShowError("Los apellidos son requeridos");
                return;
            }
            
            if (empleadoEdit.FechaIngreso == default)
            {
                messageToast?.ShowError("La fecha de ingreso es requerida");
                return;
            }
            
            // Validar c�digo �nico
            if (await EmpleadoRepo.ExistsCodigoAsync(empleadoEdit.Codigo, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el c�digo {empleadoEdit.Codigo}");
                return;
            }
            
            // Validar c�dula �nica
            if (await EmpleadoRepo.ExistsCedulaAsync(empleadoEdit.Cedula, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la c�dula {empleadoEdit.Cedula}");
                return;
            }
            
            // Validar email �nico (si se proporcion�)
            if (!string.IsNullOrWhiteSpace(empleadoEdit.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleadoEdit.Email, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleadoEdit.Email}");
                return;
            }
            
            // Procesar foto si se seleccion� una nueva
            if (fotoFile != null)
            {
                try
                {
                    var maxFileSize = 2 * 1024 * 1024; // 2MB
                    if (fotoFile.Size > maxFileSize)
                    {
                        messageToast?.ShowError("La foto no puede superar los 2MB");
                        return;
                    }
                    
                    var allowedExtensions = new[] { ".jpg", ".jpeg", ".png" };
                    var extension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
                    if (!allowedExtensions.Contains(extension))
                    {
                        messageToast?.ShowError("Solo se permiten archivos JPG, JPEG o PNG");
                        return;
                    }
                    
                    using var stream = fotoFile.OpenReadStream(maxFileSize);
                    using var memoryStream = new MemoryStream();
                    await stream.CopyToAsync(memoryStream);
                    var result = await StorageService.SaveEmpleadoFotoAsync(empleadoEdit.Id, memoryStream.ToArray(), extension);
                    
                    if (result.IsSuccess)
                    {
                        empleadoEdit.FotoPath = result.Value;
                        Logger.LogInformation("Foto guardada: {FilePath}", result.Value);
                    }
                    else
                    {
                        messageToast?.ShowError("Error al guardar la foto: " + (result.Error ?? result.Message));
                        return;
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error procesando foto");
                    messageToast?.ShowError(ErrorTranslationService.Translate(ex));
                    return;
                }
            }
            
            // Guardar empleado
            if (isEditing)
            {
                await EmpleadoRepo.UpdateAsync(empleadoEdit);
                messageToast?.ShowSuccess($"Empleado {empleadoEdit.Codigo} actualizado correctamente");
                Logger.LogInformation("Empleado actualizado: {Id} - {Codigo}", empleadoEdit.Id, empleadoEdit.Codigo);
            }
            else
            {
                var id = await EmpleadoRepo.AddAsync(empleadoEdit);
                messageToast?.ShowSuccess($"Empleado {empleadoEdit.Codigo} creado correctamente (ID: {id})");
                Logger.LogInformation("Empleado creado: {Id} - {Codigo}", id, empleadoEdit.Codigo);
            }
            
            // Cerrar modal y recargar
            showModal = false;
            hasUnsavedChanges = false;
            await CargarEmpleados();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando empleado");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModal()
    {
        if (!isSaving)
        {
            // Verificar si hay cambios sin guardar
            if (hasUnsavedChanges)
            {
                // El UnsavedChangesGuard manejar� la confirmaci�n
                return Task.CompletedTask;
            }
            
            showModal = false;
            empleadoEdit = null;
            empleadoOriginal = null;
            fotoFile = null;
            fotoPreviewUrl = null;
            hasUnsavedChanges = false;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }
    
    private async Task CambiarPagina(int nuevaPagina)
    {
        var totalPaginas = (int)Math.Ceiling((double)totalEmpleados / pageSize);
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            currentPage = nuevaPagina;
            await CargarEmpleados();
        }
    }
    
    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await CargarEmpleados();
    }
    
    private void SelectEmpleado(Empleado empleado)
    {
        selectedEmpleado = selectedEmpleado?.Id == empleado.Id ? null : empleado;
        StateHasChanged();
    }
    
    private async Task Buscar()
    {
        await FocusBusqueda();
    }
    
    private async Task LimpiarBusqueda()
    {
        searchTerm = "";
        await CargarEmpleados();
    }
    
    private async Task LimpiarFiltros()
    {
        searchTerm = "";
        filtroEstado = "";
        await CargarEmpleados();
    }
    
    private async Task Filtrar()
    {
        await CargarEmpleados();
    }
    
    private async Task FocusBusqueda()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("document.getElementById('searchInput')?.focus()");
        }
        catch { }
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await CargarEmpleados();
        }
    }
    
    private async Task OnFotoSelected(InputFileChangeEventArgs e)
    {
        fotoFile = e.File;
        hasUnsavedChanges = true;
        
        // Crear preview
        if (fotoFile != null)
        {
            try
            {
                var maxFileSize = 2 * 1024 * 1024; // 2MB
                using var stream = fotoFile.OpenReadStream(maxFileSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                fotoPreviewUrl = $"data:{fotoFile.ContentType};base64,{base64}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error creando preview de foto");
                messageToast?.ShowError(ErrorTranslationService.Translate(ex));
            }
        }
    }
    
    private void VerExpediente(Empleado empleado)
    {
        Navigation.NavigateTo($"/empleados/{empleado.Id}/expediente");
    }
    
    private string GetFotoUrl(Empleado empleado)
    {
        if (string.IsNullOrEmpty(empleado.FotoPath))
            return "/images/default-avatar.png";
        
        // Si ya es una URL completa, devolverla tal cual
        if (empleado.FotoPath.StartsWith("http://") || empleado.FotoPath.StartsWith("https://"))
            return empleado.FotoPath;
        
        // Si es una ruta local, construir la URL
        return $"/files/{empleado.FotoPath}";
    }
    
    private string GetInitials(string nombreCompleto)
    {
        if (string.IsNullOrWhiteSpace(nombreCompleto))
            return "??";
        
        var parts = nombreCompleto.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        else if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
        
        return "??";
    }
    
    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var hoy = DateTime.Today;
        var edad = hoy.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > hoy.AddYears(-edad))
            edad--;
        return edad;
    }
    
    private async Task ExportarExcel()
    {
        try
        {
            isExporting = true;
            StateHasChanged();
            
            // Obtener empleados actuales (con filtros aplicados)
            var empleadosExportar = empleados.ToList();
            
            if (!empleadosExportar.Any())
            {
                messageToast?.ShowWarning("No hay empleados para exportar");
                return;
            }
            
            // Construir opciones de exportaci�n basadas en filtros actuales
            var options = new SGRRHH.Local.Shared.Interfaces.ExportEmpleadosOptions
            {
                SoloActivos = !string.IsNullOrEmpty(filtroEstado) && filtroEstado == ((int)EstadoEmpleado.Activo).ToString()
            };
            
            var result = await ExportService.ExportEmpleadosToExcelAsync(options);
            
            if (result.IsSuccess && result.Value != null)
            {
                var fileName = $"Empleados_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
                var base64 = Convert.ToBase64String(result.Value);
                
                await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64);
                
                Logger.LogInformation("Empleados exportados a Excel: {Count} registros por {User}", 
                    empleadosExportar.Count, AuthService.CurrentUser?.Username);
                
                messageToast?.ShowSuccess($"Se exportaron {empleadosExportar.Count} empleado(s) a Excel correctamente");
            }
            else
            {
                messageToast?.ShowError(result.Message ?? "Error al exportar empleados");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exportando empleados a Excel");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }
    
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var años = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-años))
            años--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            años--;
            meses += 12;
        }
        
        if (años > 0 && meses > 0)
            return $"{años} año(s) {meses} mes(es)";
        else if (años > 0)
            return $"{años} año(s)";
        else
            return $"{meses} mes(es)";
    }
    
    private void ConfirmarAccion()
    {
        confirmAction?.Invoke();
        showConfirmModal = false;
    }
    
    private string GetEstadoClass(EstadoEmpleado estado)
    {
        return estado switch
        {
            EstadoEmpleado.Activo => "activo",
            EstadoEmpleado.Retirado => "retirado",
            EstadoEmpleado.PendienteAprobacion => "pendiente",
            EstadoEmpleado.EnVacaciones => "vacaciones",
            EstadoEmpleado.Suspendido => "suspendido",
            _ => "activo"
        };
    }
}
