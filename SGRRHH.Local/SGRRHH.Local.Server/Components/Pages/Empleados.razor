@page "/empleados"
@page "/empleados/{EmpleadoIdParam:int?}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.Services
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject IExportService ExportService
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Empleados> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Empleados - SGRRHH</PageTitle>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<!-- Unsaved Changes Guard -->
<UnsavedChangesGuard @ref="unsavedChangesGuard" HasChanges="hasUnsavedChanges" />

<div class="empleados-page-container">
    <div class="empleados-page-header">
        <h1 class="empleados-page-title">GESTIÓN DE EMPLEADOS</h1>
    </div>

    <div class="empleados-action-bar">
        <div class="empleados-action-buttons">
            @if (PuedeCrear)
            {
                <button class="empleados-btn" @onclick="NuevoEmpleadoOnboarding">NUEVO (F3)</button>
            }
            <button class="empleados-btn" @onclick="CargarEmpleados">ACTUALIZAR (F5)</button>
            <button class="empleados-btn" @onclick="Buscar">BUSCAR (F2)</button>
        </div>
        
        <div class="empleados-filter-section">
            <div class="empleados-filter-group">
                <label class="empleados-filter-label">BUSCAR:</label>
                <input type="text" 
                       id="searchInput" 
                       class="empleados-filter-input"
                       @bind="searchTerm" 
                       @bind:event="oninput" 
                       @onkeyup="OnSearchKeyUp" />
            </div>
            
            <div class="empleados-filter-group">
                <label class="empleados-filter-label">ESTADO:</label>
                <select class="empleados-filter-select" @bind="filtroEstado" @bind:after="Filtrar">
                    <option value="">TODOS</option>
                    <option value="@((int)EstadoEmpleado.Activo)">ACTIVOS</option>
                    <option value="@((int)EstadoEmpleado.PendienteAprobacion)">PENDIENTES</option>
                    <option value="@((int)EstadoEmpleado.EnVacaciones)">EN VACACIONES</option>
                    <option value="@((int)EstadoEmpleado.EnLicencia)">EN LICENCIA</option>
                    <option value="@((int)EstadoEmpleado.EnIncapacidad)">EN INCAPACIDAD</option>
                    <option value="@((int)EstadoEmpleado.Suspendido)">SUSPENDIDOS</option>
                    <option value="@((int)EstadoEmpleado.Retirado)">RETIRADOS</option>
                    <option value="@((int)EstadoEmpleado.Rechazado)">RECHAZADOS</option>
                </select>
            </div>
            
            @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filtroEstado))
            {
                <button class="empleados-btn" @onclick="LimpiarFiltros">LIMPIAR FILTROS</button>
            }
        </div>
    </div>

    <div class="empleados-results-info">
        Mostrando @empleados.Count de @totalEmpleados registro(s)
        @if (_datosDesactualizados)
        {
            <span style="margin-left: 20px; color: #FF9900; font-weight: bold;">
                ⚠ HAY CAMBIOS - 
                <button class="empleados-btn" style="display: inline-block; padding: 4px 8px; margin: 0;" @onclick="CargarEmpleados">REFRESCAR AHORA</button>
            </span>
        }
    </div>

    <table class="empleados-data-table">
        <thead>
            <tr>
                <th>CÓDIGO</th>
                <th>CÉDULA</th>
                <th>NOMBRES</th>
                <th>APELLIDOS</th>
                <th>TELÉFONO</th>
                <th>CARGO</th>
                <th>DEPARTAMENTO</th>
                <th>FECHA INGRESO</th>
                <th>ESTADO</th>
                <th>SALARIO BASE</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="11" class="empleados-loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!empleados.Any())
            {
                <tr><td colspan="11" class="empleados-empty-message">NO HAY REGISTROS PARA MOSTRAR</td></tr>
            }
            else
            {
                @foreach (var emp in empleados)
                {
                    <tr class="@(selectedEmpleado?.Id == emp.Id ? "selected" : "")"
                        @onclick="() => SelectEmpleado(emp)">
                        <td class="empleados-cell-code">@emp.Codigo</td>
                        <td>@NumberFormatHelper.FormatearCedula(emp.Cedula)</td>
                        <td>@emp.Nombres</td>
                        <td>@emp.Apellidos</td>
                        <td>@(string.IsNullOrEmpty(emp.TelefonoCelular) ? "-" : NumberFormatHelper.FormatearTelefono(emp.TelefonoCelular))</td>
                        <td>@(emp.Cargo?.Nombre ?? "-")</td>
                        <td>@(emp.Departamento?.Nombre ?? "-")</td>
                        <td>@emp.FechaIngreso.ToString("dd/MM/yyyy")</td>
                        <td class="empleados-cell-estado estado-@GetEstadoClass(emp.Estado)">@emp.Estado.ToString().ToUpper()</td>
                        <td>@NumberFormatHelper.FormatearMoneda(emp.SalarioBase)</td>
                        <td class="empleados-cell-actions">
                            <button class="empleados-btn-table" @onclick="() => VerExpediente(emp)" @onclick:stopPropagation="true">VER</button>
                            @if (PuedeEditar)
                            {
                                <button class="empleados-btn-table" @onclick="() => EditarEmpleado(emp)" @onclick:stopPropagation="true">EDITAR</button>
                            }
                            @if (PuedeAprobar && emp.Estado == EstadoEmpleado.PendienteAprobacion && 
                                EstadoEmpleadoService.TienePermisoParaTransicion(AuthService.CurrentUser?.Rol ?? RolUsuario.Operador, emp.Estado, EstadoEmpleado.Activo))
                            {
                                <button class="empleados-btn-table" style="color: #006600; border-color: #006600;" @onclick="() => AprobarEmpleado(emp)" @onclick:stopPropagation="true">APROBAR</button>
                            }
                            @if (PuedeEliminar)
                            {
                                <button class="empleados-btn-table btn-danger-small" @onclick="() => ConfirmarEliminarEmpleado(emp)" @onclick:stopPropagation="true">ELIMINAR</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    @if (totalEmpleados > pageSize)
    {
        <div class="empleados-pagination-bar">
            Mostrando @(((currentPage - 1) * pageSize) + 1) a @(Math.Min(currentPage * pageSize, totalEmpleados)) de @totalEmpleados registro(s) | P�gina @currentPage de @((int)Math.Ceiling((double)totalEmpleados / pageSize))
        </div>
    }
</div>

<div class="empleados-shortcuts-bar">
    <div class="empleados-shortcut-item">
        <span class="empleados-shortcut-key">F2</span>
        <span>=BUSCAR</span>
    </div>
    <div class="empleados-shortcut-item">
        <span class="empleados-shortcut-key">F3</span>
        <span>=NUEVO</span>
    </div>
    <div class="empleados-shortcut-item">
        <span class="empleados-shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="empleados-shortcut-item">
        <span class="empleados-shortcut-key">TAB</span>
        <span>=NAVEGAR</span>
    </div>
    <div class="empleados-shortcut-item">
        <span class="empleados-shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

<!-- Modal de Confirmaci�n para Eliminar/Desactivar -->
@if (showConfirmModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>CONFIRMAR ACCI�N</h3>
            <div class="modal-content">
                <p>@confirmMessage</p>
            </div>
            <div class="modal-actions">
                <button @onclick="() => showConfirmModal = false">CANCELAR</button>
                <button class="btn-danger" @onclick="ConfirmarAccion">CONFIRMAR</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? EmpleadoIdParam { get; set; }
    
    [SupplyParameterFromQuery(Name = "edit")]
    public int? EditEmpleadoId { get; set; }
    
    private const string PageId = "empleados";
    private MessageToast? messageToast;
    private UnsavedChangesGuard? unsavedChangesGuard;
    
    private List<Empleado> todosEmpleados = new();
    private List<Empleado> empleados = new();
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    private Empleado? selectedEmpleado;
    private Empleado? empleadoEdit;
    private Empleado? empleadoOriginal; // Para detectar cambios
    
    // Permisos del usuario actual para este módulo
    private PermisosModulo _permisos;
    private bool PuedeCrear => _permisos.HasFlag(PermisosModulo.Crear);
    private bool PuedeEditar => _permisos.HasFlag(PermisosModulo.Editar);
    private bool PuedeEliminar => _permisos.HasFlag(PermisosModulo.Eliminar);
    private bool PuedeAprobar => _permisos.HasFlag(PermisosModulo.Aprobar);
    private bool PuedeEditarCriticos => _permisos.HasFlag(PermisosModulo.EditarDatosCriticos);
    private bool PuedeRetirar => _permisos.HasFlag(PermisosModulo.Retirar);
    private bool PuedeExportar => _permisos.HasFlag(PermisosModulo.Exportar);
    
    // Paginación
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalEmpleados;
    
    private bool isLoading;
    private bool showModal;
    private bool isSaving;
    private bool isEditing;
    private bool isExporting;
    private bool hasUnsavedChanges;
    
    private string searchTerm = "";
    private string filtroEstado = "";
    
    private IBrowserFile? fotoFile;
    private string? fotoPreviewUrl;
    
    private bool showConfirmModal;
    private string confirmMessage = "";
    private Action? confirmAction;
    
    // Polling automático
    private System.Threading.Timer? _pollingTimer;
    private DateTime _ultimaCarga = DateTime.MinValue;
    private bool _datosDesactualizados = false;
    private const int PollingIntervalSeconds = 30;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Cargar permisos del usuario para este módulo
        _permisos = AuthService.ObtenerPermisosModulo("Empleados");
        
        // Registrar atajos de teclado para esta página
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F2", KeyDisplay = "F2", Description = "Buscar", Action = FocusBusqueda, Priority = 10 },
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = () => { NuevoEmpleadoOnboarding(); return Task.CompletedTask; }, Priority = 10 },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarEmpleados, Priority = 10 },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModal, Priority = 10 }
        });
        
        await CargarCatalogos();
        await CargarEmpleados();
        
        // Si viene con query param edit, redirigir a la página de edición
        if (EditEmpleadoId.HasValue && EditEmpleadoId.Value > 0)
        {
            Navigation.NavigateTo($"/empleados/{EditEmpleadoId.Value}/editar", replace: true);
            return;
        }
        
        // Si viene con parámetro de ruta, abrir el expediente
        if (EmpleadoIdParam.HasValue && EmpleadoIdParam.Value > 0)
        {
            Navigation.NavigateTo($"/empleados/{EmpleadoIdParam.Value}/expediente", replace: true);
            return;
        }
        
        // Iniciar polling automático
        IniciarPolling();
    }
    
    public void Dispose()
    {
        _pollingTimer?.Dispose();
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private void IniciarPolling()
    {
        // Polling cada 30 segundos
        _pollingTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                await VerificarCambios();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error en polling autom�tico");
            }
        }, null, TimeSpan.FromSeconds(PollingIntervalSeconds), TimeSpan.FromSeconds(PollingIntervalSeconds));
    }
    
    private async Task VerificarCambios()
    {
        try
        {
            // Solo verificar si han pasado m�s de 10 segundos desde la �ltima carga
            if ((DateTime.Now - _ultimaCarga).TotalSeconds < 10)
                return;
            
            var empleadosActuales = (await EmpleadoRepo.GetAllWithRelationsAsync()).ToList();
            
            // Verificar si hay diferencias en los timestamps
            var hayDiferencias = false;
            
            if (empleadosActuales.Count != todosEmpleados.Count)
            {
                hayDiferencias = true;
            }
            else
            {
                foreach (var empActual in empleadosActuales)
                {
                    var empLocal = todosEmpleados.FirstOrDefault(e => e.Id == empActual.Id);
                    if (empLocal == null || empLocal.UltimaActualizacion != empActual.UltimaActualizacion)
                    {
                        hayDiferencias = true;
                        break;
                    }
                }
            }
            
            if (hayDiferencias && !_datosDesactualizados)
            {
                _datosDesactualizados = true;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error verificando cambios");
        }
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            // Usar cach� para cat�logos
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
            
            Logger.LogInformation("Cat�logos cargados desde cach�: {CargosCount} cargos, {DeptoCount} departamentos", 
                cargos.Count, departamentos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando cat�logos");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
    }
    
    private async Task CargarEmpleados()
    {
        try
        {
            isLoading = true;
            _datosDesactualizados = false;
            StateHasChanged();
            
            todosEmpleados = (await EmpleadoRepo.GetAllWithRelationsAsync()).ToList();
            _ultimaCarga = DateTime.Now;
            
            // Aplicar filtros
            var filtrados = todosEmpleados
                .Where(e => string.IsNullOrEmpty(filtroEstado) || e.Estado == (EstadoEmpleado)int.Parse(filtroEstado))
                .Where(e => string.IsNullOrEmpty(searchTerm) || 
                    e.Codigo.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    e.Cedula.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    e.NombreCompleto.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (e.Cargo?.Nombre?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (e.Departamento?.Nombre?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                .OrderBy(e => e.Codigo)
                .ToList();
            
            totalEmpleados = filtrados.Count;
            
            // Aplicar paginaci�n
            empleados = filtrados
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
            
            Logger.LogInformation("Empleados cargados: {Count} de {Total} (P�gina {Page})", 
                empleados.Count, totalEmpleados, currentPage);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando empleados");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void NuevoEmpleadoOnboarding()
    {
        Navigation.NavigateTo("/empleados/onboarding");
    }
    
    private async Task EditarSeleccionado()
    {
        if (selectedEmpleado != null)
        {
            EditarEmpleado(selectedEmpleado);
        }
        await Task.CompletedTask;
    }

    private void EditarEmpleado(Empleado empleado)
    {
        Navigation.NavigateTo($"/empleados/{empleado.Id}/editar");
    }

    private async Task AprobarEmpleado(Empleado empleado)
    {
        try
        {
            // PASO 1: Recargar empleado desde BD para verificar estado actual
            var empleadoActual = await EmpleadoRepo.GetByIdWithRelationsAsync(empleado.Id);
            if (empleadoActual == null)
            {
                messageToast?.ShowError("El empleado no existe");
                await CargarEmpleados();
                return;
            }
            
            // PASO 2: Verificar que el estado sigue siendo PendienteAprobacion
            if (empleadoActual.Estado != EstadoEmpleado.PendienteAprobacion)
            {
                messageToast?.ShowError($"El empleado ya no está pendiente de aprobación. Estado actual: {EstadoEmpleadoService.ObtenerDescripcion(empleadoActual.Estado)}");
                await CargarEmpleados();
                return;
            }
            
            // PASO 3: Obtener rol del usuario actual
            var rolUsuario = AuthService.CurrentUser?.Rol ?? RolUsuario.Operador;
            
            // PASO 4: Validar que la transición sea permitida
            if (!EstadoEmpleadoService.TienePermisoParaTransicion(rolUsuario, empleadoActual.Estado, EstadoEmpleado.Activo))
            {
                messageToast?.ShowError("No tiene permisos para aprobar empleados");
                return;
            }
            
            // PASO 5: Validar que el estado actual sea PendienteAprobacion
            if (!EstadoEmpleadoService.EsTransicionValida(empleadoActual.Estado, EstadoEmpleado.Activo))
            {
                messageToast?.ShowError($"No se puede aprobar un empleado en estado {empleadoActual.Estado}");
                return;
            }
            
            // PASO 6: Actualizar estado y campos de auditoría
            empleadoActual.Estado = EstadoEmpleado.Activo;
            empleadoActual.AprobadoPorId = AuthService.CurrentUser?.Id;
            empleadoActual.FechaAprobacion = DateTime.Now;
            
            await EmpleadoRepo.UpdateAsync(empleadoActual);
            
            messageToast?.ShowSuccess($"Empleado {empleadoActual.Codigo} aprobado correctamente");
            Logger.LogInformation("Empleado aprobado: {Codigo} por {Usuario} (Id: {UserId})", 
                empleadoActual.Codigo, AuthService.CurrentUser?.Username, AuthService.CurrentUser?.Id);
            
            await CargarEmpleados();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error aprobando empleado {Id}", empleado.Id);
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
    }

    private Empleado? empleadoAEliminar;

    private void ConfirmarEliminarEmpleado(Empleado empleado)
    {
        empleadoAEliminar = empleado;
        confirmMessage = $"�Est� seguro que desea ELIMINAR permanentemente al empleado {empleado.Codigo} - {empleado.NombreCompleto}? Esta acci�n NO puede deshacerse y eliminar� todos los documentos, contratos y registros asociados.";
        confirmAction = async () => await EliminarEmpleado();
        showConfirmModal = true;
    }

    private async Task EliminarEmpleado()
    {
        if (empleadoAEliminar == null) return;

        try
        {
            // Primero eliminar documentos asociados
            var documentos = await DocumentoRepo.GetByEmpleadoIdAsync(empleadoAEliminar.Id);
            foreach (var doc in documentos)
            {
                if (doc.Id > 0)
                {
                    await StorageService.DeleteDocumentoEmpleadoAsync(doc.Id);
                }
                await DocumentoRepo.DeleteAsync(doc.Id);
            }

            // Eliminar foto si existe
            await StorageService.DeleteEmpleadoFotoAsync(empleadoAEliminar.Id);

            // Eliminar el empleado
            await EmpleadoRepo.DeleteAsync(empleadoAEliminar.Id);

            messageToast?.ShowSuccess($"Empleado {empleadoAEliminar.Codigo} eliminado correctamente");
            Logger.LogInformation("Empleado eliminado: {Codigo} - {Nombre}", empleadoAEliminar.Codigo, empleadoAEliminar.NombreCompleto);

            empleadoAEliminar = null;
            await CargarEmpleados();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error eliminando empleado {Id}", empleadoAEliminar?.Id);
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
    }
    
    private async Task Guardar()
    {
        if (empleadoEdit == null) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            // Validaciones
            if (string.IsNullOrWhiteSpace(empleadoEdit.Codigo))
            {
                messageToast?.ShowError("El c�digo es requerido");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Cedula))
            {
                messageToast?.ShowError("La c�dula es requerida");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Nombres))
            {
                messageToast?.ShowError("Los nombres son requeridos");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(empleadoEdit.Apellidos))
            {
                messageToast?.ShowError("Los apellidos son requeridos");
                return;
            }
            
            if (empleadoEdit.FechaIngreso == default)
            {
                messageToast?.ShowError("La fecha de ingreso es requerida");
                return;
            }
            
            // Validar c�digo �nico
            if (await EmpleadoRepo.ExistsCodigoAsync(empleadoEdit.Codigo, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el c�digo {empleadoEdit.Codigo}");
                return;
            }
            
            // Validar c�dula �nica
            if (await EmpleadoRepo.ExistsCedulaAsync(empleadoEdit.Cedula, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la c�dula {empleadoEdit.Cedula}");
                return;
            }
            
            // Validar email �nico (si se proporcion�)
            if (!string.IsNullOrWhiteSpace(empleadoEdit.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleadoEdit.Email, isEditing ? empleadoEdit.Id : null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleadoEdit.Email}");
                return;
            }
            
            // Procesar foto si se seleccion� una nueva
            if (fotoFile != null)
            {
                try
                {
                    var maxFileSize = 2 * 1024 * 1024; // 2MB
                    if (fotoFile.Size > maxFileSize)
                    {
                        messageToast?.ShowError("La foto no puede superar los 2MB");
                        return;
                    }
                    
                    var allowedExtensions = new[] { ".jpg", ".jpeg", ".png" };
                    var extension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
                    if (!allowedExtensions.Contains(extension))
                    {
                        messageToast?.ShowError("Solo se permiten archivos JPG, JPEG o PNG");
                        return;
                    }
                    
                    using var stream = fotoFile.OpenReadStream(maxFileSize);
                    using var memoryStream = new MemoryStream();
                    await stream.CopyToAsync(memoryStream);
                    var result = await StorageService.SaveEmpleadoFotoAsync(empleadoEdit.Id, memoryStream.ToArray(), extension);
                    
                    if (result.IsSuccess)
                    {
                        empleadoEdit.FotoPath = result.Value;
                        Logger.LogInformation("Foto guardada: {FilePath}", result.Value);
                    }
                    else
                    {
                        messageToast?.ShowError("Error al guardar la foto: " + (result.Error ?? result.Message));
                        return;
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error procesando foto");
                    messageToast?.ShowError(ErrorTranslationService.Translate(ex));
                    return;
                }
            }
            
            // Guardar empleado
            if (isEditing)
            {
                await EmpleadoRepo.UpdateAsync(empleadoEdit);
                messageToast?.ShowSuccess($"Empleado {empleadoEdit.Codigo} actualizado correctamente");
                Logger.LogInformation("Empleado actualizado: {Id} - {Codigo}", empleadoEdit.Id, empleadoEdit.Codigo);
            }
            else
            {
                var id = await EmpleadoRepo.AddAsync(empleadoEdit);
                messageToast?.ShowSuccess($"Empleado {empleadoEdit.Codigo} creado correctamente (ID: {id})");
                Logger.LogInformation("Empleado creado: {Id} - {Codigo}", id, empleadoEdit.Codigo);
            }
            
            // Cerrar modal y recargar
            showModal = false;
            hasUnsavedChanges = false;
            await CargarEmpleados();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando empleado");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModal()
    {
        if (!isSaving)
        {
            // Verificar si hay cambios sin guardar
            if (hasUnsavedChanges)
            {
                // El UnsavedChangesGuard manejar� la confirmaci�n
                return Task.CompletedTask;
            }
            
            showModal = false;
            empleadoEdit = null;
            empleadoOriginal = null;
            fotoFile = null;
            fotoPreviewUrl = null;
            hasUnsavedChanges = false;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }
    
    private async Task CambiarPagina(int nuevaPagina)
    {
        var totalPaginas = (int)Math.Ceiling((double)totalEmpleados / pageSize);
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            currentPage = nuevaPagina;
            await CargarEmpleados();
        }
    }
    
    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await CargarEmpleados();
    }
    
    private void SelectEmpleado(Empleado empleado)
    {
        selectedEmpleado = selectedEmpleado?.Id == empleado.Id ? null : empleado;
        StateHasChanged();
    }
    
    private async Task Buscar()
    {
        await FocusBusqueda();
    }
    
    private async Task LimpiarBusqueda()
    {
        searchTerm = "";
        await CargarEmpleados();
    }
    
    private async Task LimpiarFiltros()
    {
        searchTerm = "";
        filtroEstado = "";
        await CargarEmpleados();
    }
    
    private async Task Filtrar()
    {
        await CargarEmpleados();
    }
    
    private async Task FocusBusqueda()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("document.getElementById('searchInput')?.focus()");
        }
        catch { }
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await CargarEmpleados();
        }
    }
    
    private async Task OnFotoSelected(InputFileChangeEventArgs e)
    {
        fotoFile = e.File;
        hasUnsavedChanges = true;
        
        // Crear preview
        if (fotoFile != null)
        {
            try
            {
                var maxFileSize = 2 * 1024 * 1024; // 2MB
                using var stream = fotoFile.OpenReadStream(maxFileSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                fotoPreviewUrl = $"data:{fotoFile.ContentType};base64,{base64}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error creando preview de foto");
                messageToast?.ShowError(ErrorTranslationService.Translate(ex));
            }
        }
    }
    
    private void VerExpediente(Empleado empleado)
    {
        Navigation.NavigateTo($"/empleados/{empleado.Id}/expediente");
    }
    
    private string GetFotoUrl(Empleado empleado)
    {
        if (string.IsNullOrEmpty(empleado.FotoPath))
            return "/images/default-avatar.png";
        
        // Si ya es una URL completa, devolverla tal cual
        if (empleado.FotoPath.StartsWith("http://") || empleado.FotoPath.StartsWith("https://"))
            return empleado.FotoPath;
        
        // Si es una ruta local, construir la URL
        return $"/files/{empleado.FotoPath}";
    }
    
    private string GetInitials(string nombreCompleto)
    {
        if (string.IsNullOrWhiteSpace(nombreCompleto))
            return "??";
        
        var parts = nombreCompleto.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        else if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
        
        return "??";
    }
    
    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var hoy = DateTime.Today;
        var edad = hoy.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > hoy.AddYears(-edad))
            edad--;
        return edad;
    }
    
    private async Task ExportarExcel()
    {
        try
        {
            isExporting = true;
            StateHasChanged();
            
            // Obtener empleados actuales (con filtros aplicados)
            var empleadosExportar = empleados.ToList();
            
            if (!empleadosExportar.Any())
            {
                messageToast?.ShowWarning("No hay empleados para exportar");
                return;
            }
            
            // Construir opciones de exportaci�n basadas en filtros actuales
            var options = new SGRRHH.Local.Shared.Interfaces.ExportEmpleadosOptions
            {
                SoloActivos = !string.IsNullOrEmpty(filtroEstado) && filtroEstado == ((int)EstadoEmpleado.Activo).ToString()
            };
            
            var result = await ExportService.ExportEmpleadosToExcelAsync(options);
            
            if (result.IsSuccess && result.Value != null)
            {
                var fileName = $"Empleados_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
                var base64 = Convert.ToBase64String(result.Value);
                
                await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64);
                
                Logger.LogInformation("Empleados exportados a Excel: {Count} registros por {User}", 
                    empleadosExportar.Count, AuthService.CurrentUser?.Username);
                
                messageToast?.ShowSuccess($"Se exportaron {empleadosExportar.Count} empleado(s) a Excel correctamente");
            }
            else
            {
                messageToast?.ShowError(result.Message ?? "Error al exportar empleados");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exportando empleados a Excel");
            messageToast?.ShowError(ErrorTranslationService.Translate(ex));
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }
    
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var años = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-años))
            años--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            años--;
            meses += 12;
        }
        
        if (años > 0 && meses > 0)
            return $"{años} año(s) {meses} mes(es)";
        else if (años > 0)
            return $"{años} año(s)";
        else
            return $"{meses} mes(es)";
    }
    
    private void ConfirmarAccion()
    {
        confirmAction?.Invoke();
        showConfirmModal = false;
    }
    
    private string GetEstadoClass(EstadoEmpleado estado)
    {
        return estado switch
        {
            EstadoEmpleado.Activo => "activo",
            EstadoEmpleado.Retirado => "retirado",
            EstadoEmpleado.Rechazado => "retirado",
            EstadoEmpleado.PendienteAprobacion => "pendiente",
            EstadoEmpleado.EnVacaciones => "vacaciones",
            EstadoEmpleado.EnLicencia => "vacaciones",
            EstadoEmpleado.EnIncapacidad => "suspendido",
            EstadoEmpleado.Suspendido => "suspendido",
            _ => "activo"
        };
    }
}
