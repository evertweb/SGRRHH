@page "/control-diario-wizard"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.JSInterop
@inject IAuthService AuthService
@inject IRegistroDiarioRepository RegistroDiarioRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IDepartamentoRepository DepartamentoRepository
@inject IActividadRepository ActividadRepository
@inject IProyectoRepository ProyectoRepository
@inject NavigationManager Navigation
@inject ILogger<ControlDiarioWizard> Logger
@inject IJSRuntime JSRuntime

<PageTitle>SGRRHH - WIZARD REGISTRO MASIVO</PageTitle>

<div class="control-diario-wizard-container">
    <div class="control-diario-wizard-header">
        <h1>WIZARD REGISTRO MASIVO - CONTROL DIARIO</h1>
        <div class="control-diario-hotkeys">F5=CONFIRMAR | F8=CANCELAR | ESC=SALIR</div>
    </div>

    <div class="control-diario-wizard-step-indicator">
        Paso @currentStep de @totalSteps
    </div>

    <div class="control-diario-wizard-body">
        @if (!string.IsNullOrEmpty(wizardError))
        {
            <div class="control-diario-message-box control-diario-message-error">
                ERROR: @wizardError
            </div>
        }

        @if (!string.IsNullOrEmpty(wizardSuccess))
        {
            <div class="control-diario-message-box control-diario-message-success">
                OPERACION COMPLETADA: @wizardSuccess
            </div>
        }

        <!-- PASO 1: Seleccionar Empleados -->
        <div class="control-diario-wizard-section @(currentStep == 1 ? "active" : "")">
            <h2>Paso 1: Seleccion de Empleados</h2>

            <div class="control-diario-selection-controls">
                <button class="control-diario-btn" @onclick="SeleccionarTodos" disabled="@isWizardSaving">SELECCIONAR TODOS</button>
                <button class="btn" @onclick="DeseleccionarTodos" disabled="@isWizardSaving">DESELECCIONAR TODOS</button>
                @if (departamentos.Any())
                {
                    <label style="margin-left: 16px;">FILTRAR POR DEPARTAMENTO:</label>
                    <select @bind="filtroDepartamento" @bind:after="FiltrarEmpleados" disabled="@isWizardSaving" style="width: 250px;">
                        <option value="">TODOS LOS DEPARTAMENTOS</option>
                        @foreach (var dept in departamentos)
                        {
                            <option value="@dept.Id">@dept.Nombre</option>
                        }
                    </select>
                }
            </div>

            @if (isLoading)
            {
                <div class="loading-state">CARGANDO EMPLEADOS...</div>
            }
            else if (!empleadosFiltrados.Any())
            {
                <div class="loading-state">NO HAY EMPLEADOS DISPONIBLES</div>
            }
            else
            {
                <div class="control-diario-employee-grid">
                    @foreach (var emp in empleadosFiltrados)
                    {
                        var isSelected = selectedEmpleadoIds.Contains(emp.Id);
                        <div class="employee-card @(isSelected ? "selected" : "")" @onclick="() => ToggleEmpleado(emp.Id)">
                             <div class="check-indicator">✓</div>
                             
                             <div class="employee-photo-container">
                                @if (!string.IsNullOrEmpty(emp.FotoPath))
                                {
                                     <img src="@GetFotoUrl(emp)" class="employee-photo" onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\'employee-placeholder\'>@GetInitials(emp)</div>';" />
                                }
                                else
                                {
                                     <div class="employee-placeholder">@GetInitials(emp)</div>
                                }
                             </div>
                             
                             <div class="employee-info-area">
                                 <div class="employee-code">@emp.Codigo</div>
                                 <div class="employee-name">@emp.NombreCompleto</div>
                                 <div class="employee-dept">@(emp.Departamento?.Nombre ?? "SIN DEPARTAMENTO")</div>
                             </div>
                        </div>
                    }
                </div>
            }

            <div class="control-diario-selection-summary">
                EMPLEADOS SELECCIONADOS: @selectedEmpleadoIds.Count
            </div>
        </div>

        <!-- PASO 2: Fecha y Horarios -->
        <div class="control-diario-wizard-section @(currentStep == 2 ? "active" : "")">
            <h2>Paso 2: Fecha y Horarios</h2>

            <div class="control-diario-form-row">
                <label>FECHA DEL REGISTRO: *</label>
                <input type="date"
                       @bind="wizardDate"
                       max="@DateTime.Today.ToString("yyyy-MM-dd")"
                       disabled="@isWizardSaving" />
            </div>

            <div class="control-diario-form-row-inline">
                <div>
                    <label>HORA DE ENTRADA: *</label>
                    <input type="time"
                           value="@FormatTimeSpan(wizardHoraEntrada)"
                           @onchange="@(e => { wizardHoraEntrada = ParseTimeSpan(e.Value?.ToString()); CalcularHoras(); })"
                           disabled="@isWizardSaving" />
                </div>
                <div>
                    <label>HORA DE SALIDA: *</label>
                    <input type="time"
                           value="@FormatTimeSpan(wizardHoraSalida)"
                           @onchange="@(e => { wizardHoraSalida = ParseTimeSpan(e.Value?.ToString()); CalcularHoras(); })"
                           disabled="@isWizardSaving" />
                </div>
            </div>

            @if (wizardHoraEntrada.HasValue && wizardHoraSalida.HasValue)
            {
                var duracion = GetDuracion();
                if (duracion.HasValue && duracion.Value.TotalHours > 0)
                {
                    <div class="control-diario-form-row">
                        <label>HORAS CALCULADAS:</label>
                        <input type="text"
                               value="@GetDuracionLabel() - @wizardHorasManual.ToString("F2") horas"
                               disabled="true" />
                    </div>

                    <div class="control-diario-form-row">
                        <label>AJUSTE MANUAL DE HORAS (OPCIONAL):</label>
                        <input type="number"
                               @bind="wizardHorasManual"
                               min="0.25"
                               max="24"
                               step="0.25"
                               disabled="@isWizardSaving" />
                    </div>
                }
                else
                {
                    <div class="control-diario-message-box control-diario-message-error">
                        ERROR: LA HORA DE SALIDA DEBE SER POSTERIOR A LA HORA DE ENTRADA
                    </div>
                }
            }
        </div>

        <!-- PASO 3: Actividad y Proyecto -->
        <div class="control-diario-wizard-section @(currentStep == 3 ? "active" : "")">
            <h2>Paso 3: Actividad y Proyecto</h2>

            <div class="control-diario-form-row">
                <label>ACTIVIDAD: *</label>
                <select @bind="wizardActividadId" @bind:after="OnActividadChanged" disabled="@isWizardSaving">
                    <option value="0">-- SELECCIONE UNA ACTIVIDAD --</option>
                    @foreach (var act in actividades)
                    {
                        <option value="@act.Id">@act.Nombre</option>
                    }
                </select>
            </div>

            <div class="control-diario-form-row">
                <label>PROYECTO: @(actividadSeleccionada?.RequiereProyecto == true ? "*" : "(OPCIONAL)")</label>
                <select @bind="wizardProyectoId" disabled="@isWizardSaving">
                    <option value="0">-- @(actividadSeleccionada?.RequiereProyecto == true ? "SELECCIONE UN PROYECTO" : "NINGUNO") --</option>
                    @foreach (var proy in proyectos)
                    {
                        <option value="@proy.Id">@proy.Nombre</option>
                    }
                </select>
            </div>

            <div class="control-diario-form-row">
                <label>DESCRIPCION:</label>
                <input type="text"
                       @bind="wizardDescripcion"
                       maxlength="500"
                       disabled="@isWizardSaving" />
            </div>
        </div>

        <!-- PASO 4: Revision y Confirmacion -->
        <div class="control-diario-wizard-section @(currentStep == 4 ? "active" : "")">
            <h2>Paso 4: Revision y Confirmacion</h2>

            <table class="control-diario-review-table">
                <tr>
                    <th>CAMPO</th>
                    <th>VALOR</th>
                </tr>
                <tr>
                    <td>FECHA</td>
                    <td>@wizardDate.ToString("yyyy-MM-dd")</td>
                </tr>
                <tr>
                    <td>HORARIO</td>
                    <td>@(wizardHoraEntrada?.ToString(@"hh\:mm") ?? "-") A @(wizardHoraSalida?.ToString(@"hh\:mm") ?? "-") (@wizardHorasManual.ToString("F2") HORAS)</td>
                </tr>
                <tr>
                    <td>EMPLEADOS SELECCIONADOS</td>
                    <td>
                        <strong>@selectedEmpleadoIds.Count EMPLEADO(S)</strong>
                        <div class="control-diario-employee-detail-list">
                            @foreach (var empId in selectedEmpleadoIds)
                            {
                                var emp = allEmpleados.FirstOrDefault(e => e.Id == empId);
                                if (emp != null)
                                {
                                    <div>- @emp.Codigo @emp.NombreCompleto</div>
                                }
                            }
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>ACTIVIDAD</td>
                    <td>@(actividades.FirstOrDefault(a => a.Id == wizardActividadId)?.Nombre ?? "NO SELECCIONADA")</td>
                </tr>
                <tr>
                    <td>PROYECTO</td>
                    <td>@(wizardProyectoId.HasValue && wizardProyectoId.Value > 0 ? proyectos.FirstOrDefault(p => p.Id == wizardProyectoId)?.Nombre : "NINGUNO")</td>
                </tr>
                <tr>
                    <td>DESCRIPCION</td>
                    <td>@(string.IsNullOrEmpty(wizardDescripcion) ? "SIN DESCRIPCION" : wizardDescripcion)</td>
                </tr>
            </table>

            @if (!PuedeGuardar())
            {
                <div class="control-diario-message-box control-diario-message-warning">
                    ADVERTENCIA: COMPLETE TODOS LOS CAMPOS OBLIGATORIOS ANTES DE CONFIRMAR
                </div>
            }
        </div>
    </div>

    <div class="control-diario-wizard-buttons">
        <div class="control-diario-wizard-buttons-left">
            <button class="control-diario-btn" @onclick="Anterior" disabled="@(currentStep == 1 || isWizardSaving)">ANTERIOR</button>
        </div>
        <div class="wizard-buttons-right">
            <button class="btn" @onclick="CancelarWizard" disabled="@isWizardSaving">CANCELAR (F8)</button>
            @if (currentStep < totalSteps)
            {
                <button class="btn" @onclick="Siguiente" disabled="@isWizardSaving">SIGUIENTE</button>
            }
            else
            {
                <button class="btn btn-primary" @onclick="GuardarTodo" disabled="@(!PuedeGuardar() || isWizardSaving)">CONFIRMAR (F5)</button>
            }
        </div>
    </div>
</div>

@if (isWizardSaving)
{
    <div class="control-diario-processing-overlay">
        <div class="control-diario-processing-box">
            <h2>PROCESANDO REGISTROS</h2>
            <div class="control-diario-processing-status">
                PROCESADOS: @registrosProcesados DE @selectedEmpleadoIds.Count
            </div>
        </div>
    </div>
}

@code {
    // ============================================
    // ESTADO DEL WIZARD
    // ============================================
    private bool isLoading = false;
    private bool isWizardSaving = false;
    private string? wizardError;
    private string? wizardSuccess;
    private int registrosProcesados = 0;

    // ============================================
    // NAVEGACION DE PASOS
    // ============================================
    private int currentStep = 1;
    private int totalSteps = 4;

    // ============================================
    // COLECCIONES DE DATOS
    // ============================================
    private List<Empleado> allEmpleados = new();
    private List<Empleado> empleadosFiltrados = new();
    private List<Actividad> actividades = new();
    private List<Proyecto> proyectos = new();
    private List<Departamento> departamentos = new();

    // ============================================
    // SELECCIÓN Y FILTROS
    // ============================================
    private HashSet<int> selectedEmpleadoIds = new();
    private string filtroDepartamento = string.Empty;

    // ============================================
    // DATOS DEL WIZARD
    // ============================================
    private DateTime wizardDate = DateTime.Today;
    private TimeSpan? wizardHoraEntrada = new TimeSpan(8, 0, 0);
    private TimeSpan? wizardHoraSalida = new TimeSpan(17, 0, 0);
    private decimal wizardHorasManual = 9;
    private int wizardActividadId = 0;
    private int? wizardProyectoId;
    private string wizardDescripcion = string.Empty;

    // ============================================
    // PROPIEDADES CALCULADAS
    // ============================================
    private Actividad? actividadSeleccionada => 
        actividades.FirstOrDefault(a => a.Id == wizardActividadId);

    // ============================================
    // NAVEGACION ENTRE PASOS
    // ============================================
    private void Siguiente()
    {
        wizardError = null;
        
        if (currentStep < totalSteps)
        {
            currentStep++;
            StateHasChanged();
        }
    }

    private void Anterior()
    {
        wizardError = null;
        
        if (currentStep > 1)
        {
            currentStep--;
            StateHasChanged();
        }
    }

    // ============================================
    // CICLO DE VIDA
    // ============================================
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Validar autenticación
            if (!AuthService.IsAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await CargarDatosIniciales();

            Logger.LogInformation("ControlDiarioWizard inicializado correctamente");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar ControlDiarioWizard");
            wizardError = $"Error al cargar el asistente: {ex.Message}";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F5') {
                        e.preventDefault();
                        const btnConfirmar = document.querySelector('.btn-primary');
                        if (btnConfirmar && !btnConfirmar.disabled) {
                            btnConfirmar.click();
                        }
                    }
                    if (e.key === 'F8') {
                        e.preventDefault();
                        const btnCancelar = document.querySelector('.wizard-buttons-right .btn:first-child');
                        if (btnCancelar && !btnCancelar.disabled) {
                            btnCancelar.click();
                        }
                    }
                    if (e.key === 'Escape') {
                        const btnCancelar = document.querySelector('.wizard-buttons-right .btn:first-child');
                        if (btnCancelar && !btnCancelar.disabled) {
                            btnCancelar.click();
                        }
                    }
                });
            ");
        }
    }

    // ============================================
    // CARGA DE DATOS
    // ============================================
    private async Task CargarDatosIniciales()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Cargar datos en paralelo
            var empleadosTask = EmpleadoRepository.GetAllActiveWithRelationsAsync();
            var actividadesTask = ActividadRepository.GetAllActiveAsync();
            var proyectosTask = ProyectoRepository.GetByEstadoAsync(EstadoProyecto.Activo);
            var departamentosTask = DepartamentoRepository.GetAllActiveAsync();

            await Task.WhenAll(empleadosTask, actividadesTask, proyectosTask, departamentosTask);

            allEmpleados = (await empleadosTask)
                .Where(e => e.Estado == EstadoEmpleado.Activo)
                .OrderBy(e => e.NombreCompleto)
                .ToList();
            
            actividades = (await actividadesTask)
                .OrderBy(a => a.Orden)
                .ThenBy(a => a.Nombre)
                .ToList();
            
            proyectos = (await proyectosTask)
                .OrderBy(p => p.Nombre)
                .ToList();
            
            departamentos = (await departamentosTask)
                .OrderBy(d => d.Nombre)
                .ToList();

            // Inicialmente mostrar todos los empleados
            empleadosFiltrados = allEmpleados;

            Logger.LogInformation("Cargados {EmpleadosCount} empleados, {ActividadesCount} actividades, {ProyectosCount} proyectos",
                allEmpleados.Count, actividades.Count, proyectos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos iniciales");
            wizardError = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ============================================
    // SELECCIÓN DE EMPLEADOS
    // ============================================
    private void ToggleEmpleado(int empleadoId)
    {
        if (selectedEmpleadoIds.Contains(empleadoId))
        {
            selectedEmpleadoIds.Remove(empleadoId);
        }
        else
        {
            selectedEmpleadoIds.Add(empleadoId);
        }
        
        StateHasChanged();
    }

    private void SeleccionarTodos()
    {
        selectedEmpleadoIds = empleadosFiltrados.Select(e => e.Id).ToHashSet();
        StateHasChanged();
    }

    private void DeseleccionarTodos()
    {
        selectedEmpleadoIds.Clear();
        StateHasChanged();
    }

    private async Task FiltrarEmpleados()
    {
        if (string.IsNullOrEmpty(filtroDepartamento))
        {
            empleadosFiltrados = allEmpleados;
        }
        else if (int.TryParse(filtroDepartamento, out var deptId))
        {
            empleadosFiltrados = allEmpleados
                .Where(e => e.DepartamentoId == deptId)
                .ToList();
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    // ============================================
    // CÁLCULOS
    // ============================================
    private void CalcularHoras()
    {
        var duracion = GetDuracion();
        if (duracion.HasValue && duracion.Value.TotalHours > 0)
        {
            wizardHorasManual = Math.Round((decimal)duracion.Value.TotalHours, 2, MidpointRounding.AwayFromZero);
        }
        
        StateHasChanged();
    }

    private TimeSpan? GetDuracion()
    {
        if (!wizardHoraEntrada.HasValue || !wizardHoraSalida.HasValue)
            return null;
        
        if (wizardHoraSalida <= wizardHoraEntrada)
            return null;
        
        return wizardHoraSalida.Value - wizardHoraEntrada.Value;
    }

    private string GetDuracionLabel()
    {
        var duracion = GetDuracion();
        if (!duracion.HasValue)
            return "-";

        var totalMinutes = (int)Math.Round(duracion.Value.TotalMinutes);
        var hours = totalMinutes / 60;
        var minutes = totalMinutes % 60;

        return $"{hours} horas y {minutes:00} minutos";
    }

    // ============================================
    // EVENTOS
    // ============================================
    private async Task OnActividadChanged()
    {
        // Si la actividad no requiere proyecto, limpiar la selección
        if (actividadSeleccionada != null && !actividadSeleccionada.RequiereProyecto)
        {
            wizardProyectoId = null;
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    // ============================================
    // VALIDACIÓN Y GUARDADO
    // ============================================
    private bool PuedeGuardar()
    {
        if (selectedEmpleadoIds.Count == 0)
            return false;

        if (!wizardHoraEntrada.HasValue || !wizardHoraSalida.HasValue)
            return false;

        if (wizardHoraSalida <= wizardHoraEntrada)
            return false;

        if (wizardActividadId <= 0)
            return false;

        // Si la actividad requiere proyecto, validar que esté seleccionado
        if (actividadSeleccionada?.RequiereProyecto == true)
        {
            if (!wizardProyectoId.HasValue || wizardProyectoId.Value <= 0)
                return false;
        }

        if (wizardHorasManual <= 0)
            return false;

        return true;
    }

    private async Task GuardarTodo()
    {
        if (!PuedeGuardar())
        {
            wizardError = "Complete todos los campos obligatorios correctamente";
            return;
        }

        isWizardSaving = true;
        wizardError = null;
        wizardSuccess = null;
        registrosProcesados = 0;
        StateHasChanged();

        try
        {
            var registrosCreados = 0;
            var registrosConError = 0;
            var errores = new List<string>();

            foreach (var empleadoId in selectedEmpleadoIds)
            {
                try
                {
                    // Verificar si ya existe un registro para este empleado y fecha
                    var registroExistente = await RegistroDiarioRepository.GetByFechaEmpleadoAsync(
                        wizardDate, 
                        empleadoId);

                    if (registroExistente != null)
                    {
                        var empleado = allEmpleados.FirstOrDefault(e => e.Id == empleadoId);
                        errores.Add($"{empleado?.NombreCompleto ?? "Empleado " + empleadoId}: Ya tiene registro para esta fecha");
                        registrosConError++;
                        registrosProcesados++;
                        StateHasChanged();
                        continue;
                    }

                    // Crear el nuevo registro
                    var nuevoRegistro = new RegistroDiario
                    {
                        EmpleadoId = empleadoId,
                        Fecha = wizardDate.Date,
                        HoraEntrada = wizardHoraEntrada,
                        HoraSalida = wizardHoraSalida,
                        Estado = EstadoRegistroDiario.Borrador,
                        FechaCreacion = DateTime.Now,
                        CreadoPorId = AuthService.CurrentUserId
                    };

                    var registroCreado = await RegistroDiarioRepository.AddAsync(nuevoRegistro);

                    // Agregar la actividad
                    var detalleActividad = new DetalleActividad
                    {
                        RegistroDiarioId = registroCreado.Id,
                        ActividadId = wizardActividadId,
                        ProyectoId = wizardProyectoId.HasValue && wizardProyectoId.Value > 0 
                            ? wizardProyectoId 
                            : null,
                        Horas = wizardHorasManual,
                        Descripcion = wizardDescripcion,
                        Orden = 1,
                        FechaCreacion = DateTime.Now
                    };

                    await RegistroDiarioRepository.AddDetalleAsync(registroCreado.Id, detalleActividad);

                    registrosCreados++;
                    Logger.LogInformation("Registro creado para empleado {EmpleadoId} con actividad", empleadoId);
                }
                catch (Exception ex)
                {
                    var empleado = allEmpleados.FirstOrDefault(e => e.Id == empleadoId);
                    var nombreEmpleado = empleado?.NombreCompleto ?? "Empleado " + empleadoId;
                    errores.Add($"{nombreEmpleado}: {ex.Message}");
                    registrosConError++;
                    Logger.LogError(ex, "Error al crear registro para empleado {EmpleadoId}", empleadoId);
                }

                registrosProcesados++;
                StateHasChanged();
                
                // Pequeña pausa para no saturar la BD
                await Task.Delay(10);
            }

            // Mostrar resultado
            if (registrosConError == 0)
            {
                wizardSuccess = $"✓ Se crearon exitosamente {registrosCreados} registro(s) con sus actividades";
                Logger.LogInformation("Wizard completado: {Creados} registros creados", registrosCreados);
                
                // Esperar 2 segundos y redirigir
                await Task.Delay(2000);
                Navigation.NavigateTo($"/control-diario/{wizardDate:yyyy-MM-dd}");
            }
            else
            {
                var mensajeError = $"Se crearon {registrosCreados} registro(s), pero hubo {registrosConError} error(es):\n";
                mensajeError += string.Join("\n", errores.Take(5));
                if (errores.Count > 5)
                {
                    mensajeError += $"\n... y {errores.Count - 5} error(es) más";
                }
                
                wizardError = mensajeError;
                Logger.LogWarning("Wizard completado con errores: {Creados} creados, {Errores} errores", 
                    registrosCreados, registrosConError);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al ejecutar el wizard");
            wizardError = $"Error al crear los registros: {ex.Message}";
        }
        finally
        {
            isWizardSaving = false;
            StateHasChanged();
        }
    }

    private void CancelarWizard()
    {
        Navigation.NavigateTo("/control-diario");
    }

    // ============================================
    // MÉTODOS AUXILIARES
    // ============================================
    private string FormatTimeSpan(TimeSpan? time) => time?.ToString(@"hh\:mm") ?? "";

    private TimeSpan? ParseTimeSpan(string? value)
    {
        if (string.IsNullOrEmpty(value))
            return null;
        
        return TimeSpan.TryParse(value, out var time) ? time : null;
    }

    private string GetFotoUrl(Empleado emp)
    {
        if (string.IsNullOrEmpty(emp.FotoPath)) return "";

        var path = emp.FotoPath.Replace("\\", "/");

        if (path.StartsWith("Fotos/", StringComparison.OrdinalIgnoreCase))
        {
            path = path.Substring(6);
            return $"/fotos/{path}?v={DateTime.Now.Ticks}";
        }

        if (!path.Contains("/"))
        {
            return $"/fotos/Empleados/{emp.Id}/{path}?v={DateTime.Now.Ticks}";
        }

        return $"/fotos/{path}?v={DateTime.Now.Ticks}";
    }

    private string GetInitials(Empleado emp)
    {
        if (emp == null) return "??";

        var nombres = emp.Nombres?.Split(' ').FirstOrDefault() ?? "";
        var apellidos = emp.Apellidos?.Split(' ').FirstOrDefault() ?? "";
        return $"{(nombres.Length > 0 ? nombres[0] : '?')}{(apellidos.Length > 0 ? apellidos[0] : '?')}".ToUpper();
    }
}
