@page "/configuracion-legal"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IConfiguracionLegalRepository ConfiguracionLegalRepository
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<ConfiguracionLegal> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Configuración Legal - SGRRHH</PageTitle>

<MessageToast @ref="messageToast" />

<div class="configuracion-legal-page-container">
    <div class="configuracion-legal-page-header">
        <h1 class="configuracion-legal-page-title">CONFIGURACIÓN LEGAL COLOMBIA</h1>
    </div>

    @if (!AuthService.IsAuthenticated)
    {
        <div class="configuracion-legal-error-message">ACCESO DENEGADO - DEBE INICIAR SESIÓN</div>
        return;
    }

    <div class="configuracion-legal-action-bar">
        <div class="configuracion-legal-action-buttons">
            <button class="configuracion-legal-btn" @onclick="NuevaConfiguracion">NUEVO (F3)</button>
            <button class="configuracion-legal-btn" @onclick="CargarDatos">ACTUALIZAR (F5)</button>
        </div>
    </div>

    <div class="configuracion-legal-results-info">
        Mostrando @configuraciones.Count configuración(es)
    </div>

    <table class="configuracion-legal-data-table">
        <thead>
            <tr>
                <th>AÑO</th>
                <th>SMLMV</th>
                <th>AUX. TRANSPORTE</th>
                <th>SALUD EMP.</th>
                <th>SALUD PATR.</th>
                <th>PENSIÓN EMP.</th>
                <th>PENSIÓN PATR.</th>
                <th>CAJA COMP.</th>
                <th>INT. CESANTÍAS</th>
                <th>VIGENTE</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="11" class="configuracion-legal-loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!configuraciones.Any())
            {
                <tr><td colspan="11" class="configuracion-legal-empty-message">NO HAY CONFIGURACIONES REGISTRADAS</td></tr>
            }
            else
            {
                @foreach (var config in configuraciones.OrderByDescending(c => c.Año))
                {
                    <tr class="@(selectedConfiguracion?.Id == config.Id ? "selected" : "")"
                        @onclick="() => SelectConfiguracion(config)">
                        <td>@config.Año</td>
                        <td class="configuracion-legal-cell-money">@config.SalarioMinimoMensual.ToString("C0")</td>
                        <td class="configuracion-legal-cell-money">@config.AuxilioTransporte.ToString("C0")</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajeSaludEmpleado%</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajeSaludEmpleador%</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajePensionEmpleado%</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajePensionEmpleador%</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajeCajaCompensacion%</td>
                        <td class="configuracion-legal-cell-percent">@config.PorcentajeInteresesCesantias%</td>
                        <td class="configuracion-legal-cell-vigente @(config.EsVigente ? "configuracion-legal-vigente-si" : "configuracion-legal-vigente-no")">
                            @(config.EsVigente ? "SÍ" : "NO")
                        </td>
                        <td class="configuracion-legal-cell-actions">
                            <button class="configuracion-legal-btn-table" @onclick="() => EditarConfiguracion(config)" @onclick:stopPropagation="true">EDITAR</button>
                            @if (!config.EsVigente)
                            {
                                <button class="configuracion-legal-btn-table" @onclick="() => ActivarConfiguracion(config)" @onclick:stopPropagation="true">ACTIVAR</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="configuracion-legal-shortcuts-bar">
    <div class="configuracion-legal-shortcut-item">
        <span class="configuracion-legal-shortcut-key">F3</span>
        <span>=NUEVO</span>
    </div>
    <div class="configuracion-legal-shortcut-item">
        <span class="configuracion-legal-shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="configuracion-legal-shortcut-item">
        <span class="configuracion-legal-shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

@if (showModal)
{
    <div class="configuracion-legal-modal-overlay" @onclick:stopPropagation="true">
        <div class="configuracion-legal-modal-box">
            <h3>@(isEditing ? "EDITAR" : "NUEVA") CONFIGURACIÓN LEGAL</h3>
            
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">AÑO *</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.Año" min="2020" max="2050" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">VIGENTE</label>
                    <select class="configuracion-legal-form-input" @bind="configEdit.EsVigente">
                        <option value="true">SÍ</option>
                        <option value="false">NO</option>
                    </select>
                </div>
            </div>

            <div class="configuracion-legal-section-title">SALARIOS</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">SALARIO MÍNIMO MENSUAL *</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.SalarioMinimoMensual" step="1" min="0" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">AUXILIO DE TRANSPORTE *</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.AuxilioTransporte" step="1" min="0" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">SEGURIDAD SOCIAL - EMPLEADO</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% SALUD EMPLEADO</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeSaludEmpleado" step="0.01" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% PENSIÓN EMPLEADO</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajePensionEmpleado" step="0.01" min="0" max="100" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">SEGURIDAD SOCIAL - EMPLEADOR</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% SALUD EMPLEADOR</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeSaludEmpleador" step="0.01" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% PENSIÓN EMPLEADOR</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajePensionEmpleador" step="0.01" min="0" max="100" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">PARAFISCALES</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% CAJA COMPENSACIÓN</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeCajaCompensacion" step="0.01" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% ICBF</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeICBF" step="0.01" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% SENA</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeSENA" step="0.01" min="0" max="100" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">ARL - RIESGOS LABORALES</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">ARL CLASE I (MÍN %)</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.ARLClase1Min" step="0.001" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">ARL CLASE V (MÁX %)</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.ARLClase5Max" step="0.001" min="0" max="100" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">PRESTACIONES Y JORNADA</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% INTERESES CESANTÍAS</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.PorcentajeInteresesCesantias" step="0.01" min="0" max="100" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">DÍAS VACACIONES/AÑO</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.DiasVacacionesAño" min="1" max="30" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">HORAS MÁX. SEMANALES</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.HorasMaximasSemanales" min="1" max="60" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">HORAS ORDINARIAS/DÍA</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.HorasOrdinariasDiarias" min="1" max="12" />
                </div>
            </div>

            <div class="configuracion-legal-section-title">RECARGOS</div>
            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% HORA EXTRA DIURNA</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.RecargoHoraExtraDiurna" step="0.01" min="0" max="200" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% HORA EXTRA NOCTURNA</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.RecargoHoraExtraNocturna" step="0.01" min="0" max="200" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% HORA NOCTURNA</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.RecargoHoraNocturna" step="0.01" min="0" max="200" />
                </div>
                
                <div class="configuracion-legal-form-group">
                    <label class="configuracion-legal-form-label">% DOMINICAL/FESTIVO</label>
                    <input type="number" class="configuracion-legal-form-input" @bind="configEdit.RecargoHoraDominicalFestivo" step="0.01" min="0" max="200" />
                </div>
            </div>

            <div class="configuracion-legal-form-grid">
                <div class="configuracion-legal-form-group full-width">
                    <label class="configuracion-legal-form-label">OBSERVACIONES</label>
                    <textarea class="configuracion-legal-form-input" @bind="configEdit.Observaciones" rows="2"></textarea>
                </div>
            </div>

            <div class="configuracion-legal-modal-actions">
                <button class="configuracion-legal-btn" @onclick="CerrarModal">CANCELAR (ESC)</button>
                <button class="configuracion-legal-btn configuracion-legal-btn-primary" @onclick="Guardar" disabled="@isSaving">
                    @(isSaving ? "GUARDANDO..." : "GUARDAR (F10)")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private const string PageId = "ConfiguracionLegal";
    private MessageToast? messageToast;
    
    private List<Domain.Entities.ConfiguracionLegal> configuraciones = new();
    private Domain.Entities.ConfiguracionLegal? selectedConfiguracion;
    private Domain.Entities.ConfiguracionLegal configEdit = new();
    
    private bool isLoading;
    private bool showModal;
    private bool isSaving;
    private bool isEditing;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = () => { NuevaConfiguracion(); return Task.CompletedTask; } },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarDatos },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModalAsync },
            new() { Key = "F10", KeyDisplay = "F10", Description = "Guardar", Action = GuardarAsync }
        });
        
        await CargarDatos();
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task CargarDatos()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            configuraciones = (await ConfiguracionLegalRepository.GetAllAsync()).ToList();
            
            Logger.LogInformation("Configuraciones legales cargadas: {Count}", configuraciones.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando configuraciones legales");
            messageToast?.ShowError("Error al cargar datos: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void NuevaConfiguracion()
    {
        isEditing = false;
        configEdit = new Domain.Entities.ConfiguracionLegal
        {
            Año = DateTime.Now.Year,
            SalarioMinimoMensual = 1300000m,
            AuxilioTransporte = 162000m,
            PorcentajeSaludEmpleado = 4.0m,
            PorcentajeSaludEmpleador = 8.5m,
            PorcentajePensionEmpleado = 4.0m,
            PorcentajePensionEmpleador = 12.0m,
            PorcentajeCajaCompensacion = 4.0m,
            PorcentajeICBF = 3.0m,
            PorcentajeSENA = 2.0m,
            ARLClase1Min = 0.522m,
            ARLClase5Max = 6.96m,
            PorcentajeInteresesCesantias = 12.0m,
            DiasVacacionesAño = 15,
            HorasMaximasSemanales = 48,
            HorasOrdinariasDiarias = 8,
            RecargoHoraExtraDiurna = 25.0m,
            RecargoHoraExtraNocturna = 75.0m,
            RecargoHoraNocturna = 35.0m,
            RecargoHoraDominicalFestivo = 75.0m,
            EdadMinimaLaboral = 18,
            EsVigente = false
        };
        showModal = true;
        StateHasChanged();
    }
    
    private void EditarConfiguracion(Domain.Entities.ConfiguracionLegal config)
    {
        isEditing = true;
        configEdit = new Domain.Entities.ConfiguracionLegal
        {
            Id = config.Id,
            Año = config.Año,
            SalarioMinimoMensual = config.SalarioMinimoMensual,
            AuxilioTransporte = config.AuxilioTransporte,
            PorcentajeSaludEmpleado = config.PorcentajeSaludEmpleado,
            PorcentajeSaludEmpleador = config.PorcentajeSaludEmpleador,
            PorcentajePensionEmpleado = config.PorcentajePensionEmpleado,
            PorcentajePensionEmpleador = config.PorcentajePensionEmpleador,
            PorcentajeCajaCompensacion = config.PorcentajeCajaCompensacion,
            PorcentajeICBF = config.PorcentajeICBF,
            PorcentajeSENA = config.PorcentajeSENA,
            ARLClase1Min = config.ARLClase1Min,
            ARLClase5Max = config.ARLClase5Max,
            PorcentajeInteresesCesantias = config.PorcentajeInteresesCesantias,
            DiasVacacionesAño = config.DiasVacacionesAño,
            HorasMaximasSemanales = config.HorasMaximasSemanales,
            HorasOrdinariasDiarias = config.HorasOrdinariasDiarias,
            RecargoHoraExtraDiurna = config.RecargoHoraExtraDiurna,
            RecargoHoraExtraNocturna = config.RecargoHoraExtraNocturna,
            RecargoHoraNocturna = config.RecargoHoraNocturna,
            RecargoHoraDominicalFestivo = config.RecargoHoraDominicalFestivo,
            EdadMinimaLaboral = config.EdadMinimaLaboral,
            EsVigente = config.EsVigente,
            Observaciones = config.Observaciones
        };
        showModal = true;
        StateHasChanged();
    }
    
    private void SelectConfiguracion(Domain.Entities.ConfiguracionLegal config)
    {
        selectedConfiguracion = selectedConfiguracion?.Id == config.Id ? null : config;
        StateHasChanged();
    }
    
    private async Task ActivarConfiguracion(Domain.Entities.ConfiguracionLegal config)
    {
        try
        {
            await ConfiguracionLegalRepository.SetVigenteAsync(config.Id);
            messageToast?.ShowSuccess($"Configuración del año {config.Año} activada como vigente");
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error activando configuración");
            messageToast?.ShowError("Error al activar: " + ex.Message);
        }
    }
    
    private async Task Guardar()
    {
        if (configEdit == null) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            // Validaciones
            if (configEdit.Año < 2020 || configEdit.Año > 2050)
            {
                messageToast?.ShowError("El año debe estar entre 2020 y 2050");
                return;
            }
            
            if (configEdit.SalarioMinimoMensual <= 0)
            {
                messageToast?.ShowError("El salario mínimo debe ser mayor a 0");
                return;
            }
            
            // Verificar si ya existe configuración para este año (si es nuevo)
            if (!isEditing && await ConfiguracionLegalRepository.ExisteAñoAsync(configEdit.Año))
            {
                messageToast?.ShowError($"Ya existe configuración para el año {configEdit.Año}");
                return;
            }
            
            if (isEditing)
            {
                await ConfiguracionLegalRepository.UpdateAsync(configEdit);
                messageToast?.ShowSuccess($"Configuración del año {configEdit.Año} actualizada correctamente");
            }
            else
            {
                await ConfiguracionLegalRepository.AddAsync(configEdit);
                messageToast?.ShowSuccess($"Configuración del año {configEdit.Año} creada correctamente");
            }
            
            // Si se marcó como vigente, activarla
            if (configEdit.EsVigente)
            {
                await ConfiguracionLegalRepository.SetVigenteAsync(configEdit.Id);
            }
            
            showModal = false;
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando configuración");
            messageToast?.ShowError("Error al guardar: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task GuardarAsync()
    {
        if (showModal)
        {
            return Guardar();
        }
        return Task.CompletedTask;
    }
    
    private void CerrarModal()
    {
        if (!isSaving)
        {
            showModal = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModalAsync()
    {
        CerrarModal();
        return Task.CompletedTask;
    }
}
