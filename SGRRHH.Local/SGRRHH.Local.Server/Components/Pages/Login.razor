@page "/login"
@page "/"
@layout EmptyLayout
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Domain.Enums
@inject IAuthService AuthService
@inject NavigationManager Navigation

<div class="login-container">
    <div class="login-box">
        <h2>SGRRHH LOCAL</h2>
        <h3>Sistema de Gestión de Recursos Humanos</h3>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-block">
                <p>@errorMessage</p>
            </div>
        }
        
        <div class="form-group">
            <label>Usuario:</label>
            <input type="text" 
                   @bind="username" 
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   placeholder="Ingrese su usuario"
                   autofocus />
        </div>
        
        <div class="form-group">
            <label>Contraseña:</label>
            <input type="password" 
                   @bind="password" 
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   placeholder="Ingrese su contraseña" />
        </div>
        
        <div style="margin-top: 16px;">
            <button @onclick="DoLogin" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>INGRESANDO...</span>
                }
                else
                {
                    <span>INGRESAR</span>
                }
            </button>
        </div>
        
        <div class="login-footer">
            <small>Versión 1.0.0 | © 2026 SGRRHH</small>
        </div>
    </div>
</div>

@code {
    private string username = "";
    private string password = "";
    private string? errorMessage;
    private bool isLoading;
    
    protected override void OnInitialized()
    {
        // Si ya está autenticado, ir a la página por defecto según rol
        if (AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo(GetDefaultPageByRole());
        }
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await DoLogin();
        }
    }
    
    private async Task DoLogin()
    {
        if (isLoading) return;
        
        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            var result = await AuthService.LoginAsync(username, password);
            
            if (result.IsSuccess)
            {
                Navigation.NavigateTo(GetDefaultPageByRole());
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private string GetDefaultPageByRole()
    {
        if (AuthService.CurrentUser == null)
            return "/login";
        
        return AuthService.CurrentUser.Rol switch
        {
            RolUsuario.Administrador => "/usuarios",
            RolUsuario.Aprobador => "/empleados", // Ingeniera
            RolUsuario.Operador => "/control-diario", // Secretaria
            _ => "/empleados"
        };
    }
}
