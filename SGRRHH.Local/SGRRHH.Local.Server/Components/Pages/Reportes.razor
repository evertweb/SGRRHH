@page "/reportes"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Infrastructure.Services
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepository
@inject IPermisoRepository PermisoRepository
@inject IVacacionRepository VacacionRepository
@inject IRegistroDiarioRepository RegistroDiarioRepository
@inject IDepartamentoRepository DepartamentoRepository
@inject ICargoRepository CargoRepository
@inject ITipoPermisoRepository TipoPermisoRepository
@inject IReportService ReportService
@inject NavigationManager Navigation
@inject ILogger<Reportes> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Reportes - SGRRHH</PageTitle>

<KeyboardHandler @ref="keyboardHandler" Shortcuts="shortcuts" ShowShortcutBar="true" />

<h1 class="page-title">CENTRO DE REPORTES</h1>

@if (errorMessage != null)
{
    <div class="error-block">
        <h3>ERROR</h3>
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

@if (successMessage != null)
{
    <div class="success-block">
        <p>@successMessage</p>
    </div>
}

<!-- Selector de tipo de reporte -->
<div class="panel">
    <div class="panel-header">SELECCIONE EL TIPO DE REPORTE</div>
    <div class="panel-body">
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="@(tipoReporteSeleccionado == TipoReporte.ListadoEmpleados ? "btn-primary" : "")"
                        @onclick="() => SeleccionarTipoReporte(TipoReporte.ListadoEmpleados)">
                    LISTADO DE EMPLEADOS
                </button>
                <button class="@(tipoReporteSeleccionado == TipoReporte.Permisos ? "btn-primary" : "")"
                        @onclick="() => SeleccionarTipoReporte(TipoReporte.Permisos)">
                    REPORTE DE PERMISOS
                </button>
                <button class="@(tipoReporteSeleccionado == TipoReporte.Vacaciones ? "btn-primary" : "")"
                        @onclick="() => SeleccionarTipoReporte(TipoReporte.Vacaciones)">
                    REPORTE DE VACACIONES
                </button>
                <button class="@(tipoReporteSeleccionado == TipoReporte.Asistencia ? "btn-primary" : "")"
                        @onclick="() => SeleccionarTipoReporte(TipoReporte.Asistencia)">
                    REPORTE DE ASISTENCIA
                </button>
                <button class="@(tipoReporteSeleccionado == TipoReporte.CertificadoLaboral ? "btn-primary" : "")"
                        @onclick="() => SeleccionarTipoReporte(TipoReporte.CertificadoLaboral)">
                    CERTIFICADO LABORAL
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Panel de Filtros y Generaci칩n seg칰n tipo de reporte -->
@if (tipoReporteSeleccionado != TipoReporte.Ninguno)
{
    <div class="panel">
        <!-- Filtros para Listado de Empleados -->
        @if (tipoReporteSeleccionado == TipoReporte.ListadoEmpleados)
        {
            <div class="panel-header">FILTROS - LISTADO DE EMPLEADOS</div>
            <div class="panel-body">
                <div class="grid-4">
                    <div class="form-group">
                        <label>ESTADO</label>
                        <select @bind="filtroEstadoEmpleado">
                            <option value="">Todos</option>
                            @foreach (var estado in Enum.GetValues<EstadoEmpleado>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DEPARTAMENTO</label>
                        <select @bind="filtroDepartamento">
                            <option value="">Todos</option>
                            @foreach (var dept in departamentos)
                            {
                                <option value="@dept.Id">@dept.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>CARGO</label>
                        <select @bind="filtroCargo">
                            <option value="">Todos</option>
                            @foreach (var cargo in cargos)
                            {
                                <option value="@cargo.Id">@cargo.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ORDENAR POR</label>
                        <select @bind="ordenEmpleados">
                            <option value="nombre">Nombre</option>
                            <option value="cedula">C칠dula</option>
                            <option value="codigo">C칩digo</option>
                            <option value="fechaIngreso">Fecha Ingreso</option>
                        </select>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="btn-primary" @onclick="GenerarReporteEmpleados" disabled="@isGenerating">
                            @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                        </button>
                        <button @onclick="VistaPrevia" disabled="@isGenerating">
                            VISTA PREVIA
                        </button>
                        <button class="btn-success" @onclick="ExportarExcel" disabled="@isGenerating">
                            EXPORTAR A EXCEL
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Filtros para Reporte de Permisos -->
        @if (tipoReporteSeleccionado == TipoReporte.Permisos)
        {
            <div class="panel-header">FILTROS - REPORTE DE PERMISOS</div>
            <div class="panel-body">
                <div class="grid-3">
                    <div class="form-group required">
                        <label>FECHA INICIO</label>
                        <input type="date" @bind="filtroFechaInicio" />
                    </div>
                    <div class="form-group required">
                        <label>FECHA FIN</label>
                        <input type="date" @bind="filtroFechaFin" />
                    </div>
                    <div class="form-group">
                        <label>EMPLEADO</label>
                        <select @bind="filtroEmpleadoId">
                            <option value="">Todos</option>
                            @foreach (var emp in empleados)
                            {
                                <option value="@emp.Id">@emp.NombreCompleto</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>TIPO DE PERMISO</label>
                        <select @bind="filtroTipoPermisoId">
                            <option value="">Todos</option>
                            @foreach (var tipo in tiposPermiso)
                            {
                                <option value="@tipo.Id">@tipo.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ESTADO</label>
                        <select @bind="filtroEstadoPermiso">
                            <option value="">Todos</option>
                            @foreach (var estado in Enum.GetValues<EstadoPermiso>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DEPARTAMENTO</label>
                        <select @bind="filtroDepartamentoPermisos">
                            <option value="">Todos</option>
                            @foreach (var dept in departamentos)
                            {
                                <option value="@dept.Id">@dept.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="btn-primary" @onclick="GenerarReportePermisos" disabled="@isGenerating || !ValidarFechasPermisos()">
                            @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                        </button>
                        <button @onclick="VistaPreviaPermisos" disabled="@isGenerating || !ValidarFechasPermisos()">
                            VISTA PREVIA
                        </button>
                        <button class="btn-success" @onclick="ExportarPermisosExcel" disabled="@isGenerating || !ValidarFechasPermisos()">
                            EXPORTAR A EXCEL
                        </button>
                    </div>
                </div>
                @if (!ValidarFechasPermisos())
                {
                    <div class="validation-message">
                        * Debe seleccionar un rango de fechas v치lido
                    </div>
                }
            </div>
        }

        <!-- Filtros para Reporte de Vacaciones -->
        @if (tipoReporteSeleccionado == TipoReporte.Vacaciones)
        {
            <div class="panel-header">FILTROS - REPORTE DE VACACIONES</div>
            <div class="panel-body">
                <div class="grid-4">
                    <div class="form-group">
                        <label>A칌O</label>
                        <select @bind="filtroAnioVacaciones">
                            @for (int year = DateTime.Now.Year - 5; year <= DateTime.Now.Year + 1; year++)
                            {
                                <option value="@year">@year</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>EMPLEADO</label>
                        <select @bind="filtroEmpleadoVacacionesId">
                            <option value="">Todos</option>
                            @foreach (var emp in empleados)
                            {
                                <option value="@emp.Id">@emp.NombreCompleto</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ESTADO</label>
                        <select @bind="filtroEstadoVacaciones">
                            <option value="">Todos</option>
                            @foreach (var estado in Enum.GetValues<EstadoVacacion>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DEPARTAMENTO</label>
                        <select @bind="filtroDepartamentoVacaciones">
                            <option value="">Todos</option>
                            @foreach (var dept in departamentos)
                            {
                                <option value="@dept.Id">@dept.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="btn-primary" @onclick="GenerarReporteVacaciones" disabled="@isGenerating">
                            @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                        </button>
                        <button @onclick="VistaPreviaVacaciones" disabled="@isGenerating">
                            VISTA PREVIA
                        </button>
                        <button class="btn-success" @onclick="ExportarVacacionesExcel" disabled="@isGenerating">
                            EXPORTAR A EXCEL
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Filtros para Reporte de Asistencia -->
        @if (tipoReporteSeleccionado == TipoReporte.Asistencia)
        {
            <div class="panel-header">FILTROS - REPORTE DE ASISTENCIA</div>
            <div class="panel-body">
                <div class="grid-4">
                    <div class="form-group required">
                        <label>FECHA INICIO</label>
                        <input type="date" @bind="filtroFechaInicioAsistencia" />
                    </div>
                    <div class="form-group required">
                        <label>FECHA FIN</label>
                        <input type="date" @bind="filtroFechaFinAsistencia" />
                    </div>
                    <div class="form-group">
                        <label>EMPLEADO</label>
                        <select @bind="filtroEmpleadoAsistenciaId">
                            <option value="">Todos</option>
                            @foreach (var emp in empleados)
                            {
                                <option value="@emp.Id">@emp.NombreCompleto</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DEPARTAMENTO</label>
                        <select @bind="filtroDepartamentoAsistencia">
                            <option value="">Todos</option>
                            @foreach (var dept in departamentos)
                            {
                                <option value="@dept.Id">@dept.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="btn-primary" @onclick="GenerarReporteAsistencia" disabled="@isGenerating || !ValidarFechasAsistencia()">
                            @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                        </button>
                        <button @onclick="VistaPreviaAsistencia" disabled="@isGenerating || !ValidarFechasAsistencia()">
                            VISTA PREVIA
                        </button>
                        <button class="btn-success" @onclick="ExportarAsistenciaExcel" disabled="@(isGenerating || !ValidarFechasAsistencia())">
                            EXPORTAR A EXCEL
                        </button>
                    </div>
                </div>
                @if (!ValidarFechasAsistencia())
                {
                    <div class="validation-message">
                        * Debe seleccionar un rango de fechas v치lido
                    </div>
                }
            </div>
        }

        <!-- Filtros para Certificado Laboral -->
        @if (tipoReporteSeleccionado == TipoReporte.CertificadoLaboral)
        {
            <div class="panel-header">GENERAR CERTIFICADO LABORAL</div>
            <div class="panel-body">
                <div class="grid-3">
                    <div class="form-group required">
                        <label>EMPLEADO</label>
                        <select @bind="empleadoCertificadoId">
                            <option value="">-- Seleccione --</option>
                            @foreach (var emp in empleados.Where(e => e.Estado == EstadoEmpleado.Activo))
                            {
                                <option value="@emp.Id">@emp.NombreCompleto - @emp.Cedula</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PROP칍SITO</label>
                        <select @bind="propositoCertificado">
                            <option value="Tramites Personales">Tr치mites Personales</option>
                            <option value="Tramites Bancarios">Tr치mites Bancarios</option>
                            <option value="Visa">Visa</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>INCLUIR SALARIO</label>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="chkSalario" @bind="incluirSalarioCertificado" />
                            <label for="chkSalario">Incluir informaci칩n salarial</label>
                        </div>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="btn-primary" @onclick="GenerarCertificado" disabled="@(isGenerating || string.IsNullOrEmpty(empleadoCertificadoId))">
                            @(isGenerating ? "GENERANDO..." : "GENERAR CERTIFICADO")
                        </button>
                    </div>
                </div>
                @if (string.IsNullOrEmpty(empleadoCertificadoId))
                {
                    <div class="validation-message">
                        * Debe seleccionar un empleado
                    </div>
                }
            </div>
        }
    </div>

    <!-- Vista previa de datos -->
    @if (mostrarVistaPrevia)
    {
        <div class="panel">
            <div class="panel-header">
                VISTA PREVIA DEL REPORTE
                <button @onclick="CerrarVistaPrevia">CERRAR</button>
            </div>
            <div class="panel-body">

            @if (tipoReporteSeleccionado == TipoReporte.ListadoEmpleados && empleadosReporte.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>C칍DIGO</th>
                            <th>C칄DULA</th>
                            <th>NOMBRE COMPLETO</th>
                            <th>CARGO</th>
                            <th>DEPARTAMENTO</th>
                            <th>FECHA INGRESO</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var emp in empleadosReporte)
                        {
                            <tr>
                                <td>@emp.Codigo</td>
                                <td>@emp.Cedula</td>
                                <td>@emp.NombreCompleto</td>
                                <td>@(emp.Cargo?.Nombre ?? "-")</td>
                                <td>@(emp.Departamento?.Nombre ?? "-")</td>
                                <td>@emp.FechaIngreso.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <span class="badge badge-@emp.Estado.ToString().ToLower()">
                                        @emp.Estado
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="results-info">
                    <strong>Total de empleados:</strong> @empleadosReporte.Count
                </div>
            }

            @if (tipoReporteSeleccionado == TipoReporte.Permisos && permisosReporte.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>N춿 ACTA</th>
                            <th>FECHA</th>
                            <th>EMPLEADO</th>
                            <th>TIPO</th>
                            <th>FECHA INICIO</th>
                            <th>FECHA FIN</th>
                            <th>D칈AS</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var permiso in permisosReporte)
                        {
                            <tr>
                                <td>@permiso.NumeroActa</td>
                                <td>@permiso.FechaSolicitud.ToString("dd/MM/yyyy")</td>
                                <td>@(permiso.Empleado?.NombreCompleto ?? "-")</td>
                                <td>@(permiso.TipoPermiso?.Nombre ?? "-")</td>
                                <td>@permiso.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@permiso.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td>@permiso.TotalDias</td>
                                <td>
                                    <span class="badge badge-@permiso.Estado.ToString().ToLower()">
                                        @permiso.Estado
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="stats-grid">
                    <div class="stats-card">
                        <h3>TOTAL PERMISOS</h3>
                        <div class="value">@permisosReporte.Count</div>
                    </div>
                    <div class="stats-card">
                        <h3>D칈AS TOTALES</h3>
                        <div class="value">@permisosReporte.Sum(p => p.TotalDias)</div>
                    </div>
                    <div class="stats-card">
                        <h3>APROBADOS</h3>
                        <div class="value">@permisosReporte.Count(p => p.Estado == EstadoPermiso.Aprobado)</div>
                    </div>
                    <div class="stats-card">
                        <h3>RECHAZADOS</h3>
                        <div class="value">@permisosReporte.Count(p => p.Estado == EstadoPermiso.Rechazado)</div>
                    </div>
                    <div class="stats-card">
                        <h3>PENDIENTES</h3>
                        <div class="value">@permisosReporte.Count(p => p.Estado == EstadoPermiso.Pendiente)</div>
                    </div>
                </div>
            }

            @if (tipoReporteSeleccionado == TipoReporte.Vacaciones && vacacionesReporte.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>EMPLEADO</th>
                            <th>DEPARTAMENTO</th>
                            <th>PER칈ODO</th>
                            <th>FECHA INICIO</th>
                            <th>FECHA FIN</th>
                            <th>D칈AS</th>
                            <th>D칈AS DISPONIBLES</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var vacacion in vacacionesReporte)
                        {
                            <tr>
                                <td>@(vacacion.Empleado?.NombreCompleto ?? "-")</td>
                                <td>@(vacacion.Empleado?.Departamento?.Nombre ?? "-")</td>
                                <td>@vacacion.Periodo</td>
                                <td>@vacacion.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@vacacion.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td>@vacacion.DiasTomados</td>
                                <td>@vacacion.DiasDisponibles</td>
                                <td>
                                    <span class="badge badge-@vacacion.Estado.ToString().ToLower()">
                                        @vacacion.Estado
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="stats-grid">
                    <div class="stats-card">
                        <h3>TOTAL SOLICITUDES</h3>
                        <div class="value">@vacacionesReporte.Count</div>
                    </div>
                    <div class="stats-card">
                        <h3>D칈AS TOTALES</h3>
                        <div class="value">@vacacionesReporte.Sum(v => v.DiasTomados)</div>
                    </div>
                    <div class="stats-card">
                        <h3>APROBADAS</h3>
                        <div class="value">@vacacionesReporte.Count(v => v.Estado == EstadoVacacion.Aprobada)</div>
                    </div>
                    <div class="stats-card">
                        <h3>PENDIENTES</h3>
                        <div class="value">@vacacionesReporte.Count(v => v.Estado == EstadoVacacion.Pendiente)</div>
                    </div>
                </div>
            }

            @if (!empleadosReporte.Any() && !permisosReporte.Any() && !vacacionesReporte.Any())
            {
                <div class="empty-state">
                    <div class="icon">游늶</div>
                    <div class="message">No hay datos para mostrar con los filtros seleccionados</div>
                </div>
            }
            </div>
        </div>
    }
}

@code {
    // Referencias
    private KeyboardHandler? keyboardHandler;
    private List<KeyboardHandler.KeyboardShortcut> shortcuts = new();

    // Enumeraci칩n de tipos de reporte
    private enum TipoReporte
    {
        Ninguno,
        ListadoEmpleados,
        Permisos,
        Vacaciones,
        Asistencia,
        CertificadoLaboral
    }

    // Estado general
    private TipoReporte tipoReporteSeleccionado = TipoReporte.Ninguno;
    private bool isGenerating = false;
    private bool mostrarVistaPrevia = false;
    private string? errorMessage;
    private string? successMessage;

    // Cat치logos
    private List<Empleado> empleados = new();
    private List<Departamento> departamentos = new();
    private List<Cargo> cargos = new();
    private List<TipoPermiso> tiposPermiso = new();

    // Filtros - Listado de Empleados
    private string? filtroEstadoEmpleado = "";
    private string? filtroDepartamento = "";
    private string? filtroCargo = "";
    private string ordenEmpleados = "nombre";

    // Filtros - Permisos
    private DateTime? filtroFechaInicio = DateTime.Now.AddMonths(-1);
    private DateTime? filtroFechaFin = DateTime.Now;
    private string? filtroEmpleadoId = "";
    private string? filtroTipoPermisoId = "";
    private string? filtroEstadoPermiso = "";
    private string? filtroDepartamentoPermisos = "";

    // Filtros - Vacaciones
    private int filtroAnioVacaciones = DateTime.Now.Year;
    private string? filtroEmpleadoVacacionesId = "";
    private string? filtroEstadoVacaciones = "";
    private string? filtroDepartamentoVacaciones = "";

    // Filtros - Asistencia
    private DateTime? filtroFechaInicioAsistencia = DateTime.Now.AddMonths(-1);
    private DateTime? filtroFechaFinAsistencia = DateTime.Now;
    private string? filtroEmpleadoAsistenciaId = "";
    private string? filtroDepartamentoAsistencia = "";

    // Filtros - Certificado Laboral
    private string? empleadoCertificadoId = "";
    private string propositoCertificado = "Tramites Personales";
    private bool incluirSalarioCertificado = false;

    // Datos de reportes
    private List<Empleado> empleadosReporte = new();
    private List<Permiso> permisosReporte = new();
    private List<Vacacion> vacacionesReporte = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!AuthService.IsAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            ConfigurarAtajosTeclado();
            await CargarCatalogos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar la p치gina de reportes");
            errorMessage = "Error al cargar la p치gina de reportes";
        }
    }

    private void ConfigurarAtajosTeclado()
    {
        shortcuts = new List<KeyboardHandler.KeyboardShortcut>
        {
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = Actualizar },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar vista", Action = CerrarVistaPrevia }
        };
    }

    private async Task CargarCatalogos()
    {
        try
        {
            empleados = (await EmpleadoRepository.GetAllAsync()).ToList();
            departamentos = (await DepartamentoRepository.GetAllAsync()).ToList();
            cargos = (await CargoRepository.GetAllAsync()).ToList();
            tiposPermiso = (await TipoPermisoRepository.GetAllAsync()).ToList();

            Logger.LogInformation("Cat치logos cargados correctamente");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar cat치logos");
            errorMessage = "Error al cargar los cat치logos necesarios";
        }
    }

    private void SeleccionarTipoReporte(TipoReporte tipo)
    {
        tipoReporteSeleccionado = tipo;
        mostrarVistaPrevia = false;
        errorMessage = null;
        successMessage = null;
    }

    // ============================================================
    // REPORTE: LISTADO DE EMPLEADOS
    // ============================================================

    private async Task GenerarReporteEmpleados()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            await CargarDatosEmpleados();

            if (!empleadosReporte.Any())
            {
                errorMessage = "No se encontraron empleados con los filtros seleccionados";
                return;
            }

            // Generar PDF
            var pdfBytes = ReportService.GenerarListadoEmpleadosPdf(empleadosReporte);
            await DescargarArchivo(pdfBytes, $"Empleados_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");

            successMessage = $"Reporte generado exitosamente. Total: {empleadosReporte.Count} empleados";
            Logger.LogInformation("Reporte de empleados generado: {Count} registros", empleadosReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de empleados");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPrevia()
    {
        try
        {
            errorMessage = null;
            await CargarDatosEmpleados();
            mostrarVistaPrevia = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de empleados");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private async Task CargarDatosEmpleados()
    {
        empleadosReporte = (await EmpleadoRepository.GetAllAsync()).ToList();

        // Aplicar filtro de estado
        if (!string.IsNullOrEmpty(filtroEstadoEmpleado))
        {
            if (Enum.TryParse<EstadoEmpleado>(filtroEstadoEmpleado, out var estado))
            {
                empleadosReporte = empleadosReporte.Where(e => e.Estado == estado).ToList();
            }
        }

        // Aplicar filtro de departamento
        if (!string.IsNullOrEmpty(filtroDepartamento) && int.TryParse(filtroDepartamento, out var deptId))
        {
            empleadosReporte = empleadosReporte.Where(e => e.DepartamentoId == deptId).ToList();
        }

        // Aplicar filtro de cargo
        if (!string.IsNullOrEmpty(filtroCargo) && int.TryParse(filtroCargo, out var cargoId))
        {
            empleadosReporte = empleadosReporte.Where(e => e.CargoId == cargoId).ToList();
        }

        // Ordenar
        empleadosReporte = ordenEmpleados switch
        {
            "nombre" => empleadosReporte.OrderBy(e => e.NombreCompleto).ToList(),
            "cedula" => empleadosReporte.OrderBy(e => e.Cedula).ToList(),
            "codigo" => empleadosReporte.OrderBy(e => e.Codigo).ToList(),
            "fechaIngreso" => empleadosReporte.OrderBy(e => e.FechaIngreso).ToList(),
            _ => empleadosReporte.OrderBy(e => e.NombreCompleto).ToList()
        };
    }

    private async Task ExportarExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            await CargarDatosEmpleados();

            if (!empleadosReporte.Any())
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // Generar Excel
            var excelBytes = ReportService.GenerarListadoEmpleadosExcel(empleadosReporte);
            await DescargarArchivo(excelBytes, $"Empleados_{DateTime.Now:yyyyMMdd}.xlsx", 
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            successMessage = $"Datos exportados a Excel exitosamente. Total: {empleadosReporte.Count} empleados";
            Logger.LogInformation("Empleados exportados a Excel: {Count} registros", empleadosReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar empleados a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    // ============================================================
    // REPORTE: PERMISOS
    // ============================================================

    private bool ValidarFechasPermisos()
    {
        return filtroFechaInicio.HasValue && 
               filtroFechaFin.HasValue && 
               filtroFechaInicio.Value <= filtroFechaFin.Value;
    }

    private async Task GenerarReportePermisos()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            await CargarDatosPermisos();

            if (!permisosReporte.Any())
            {
                errorMessage = "No se encontraron permisos con los filtros seleccionados";
                return;
            }

            // Generar PDF
            var pdfBytes = ReportService.GenerarReportePermisosPdf(permisosReporte, 
                filtroFechaInicio!.Value, filtroFechaFin!.Value);
            await DescargarArchivo(pdfBytes, 
                $"Permisos_{filtroFechaInicio:yyyyMMdd}_{filtroFechaFin:yyyyMMdd}.pdf", 
                "application/pdf");

            successMessage = $"Reporte generado exitosamente. Total: {permisosReporte.Count} permisos, {permisosReporte.Sum(p => p.TotalDias)} d칤as";
            Logger.LogInformation("Reporte de permisos generado: {Count} registros", permisosReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de permisos");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPreviaPermisos()
    {
        try
        {
            errorMessage = null;
            await CargarDatosPermisos();
            mostrarVistaPrevia = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de permisos");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private async Task CargarDatosPermisos()
    {
        if (!filtroFechaInicio.HasValue || !filtroFechaFin.HasValue)
        {
            permisosReporte = new List<Permiso>();
            return;
        }

        permisosReporte = (await PermisoRepository.GetAllAsync()).ToList();

        // Filtrar por rango de fechas
        permisosReporte = permisosReporte
            .Where(p => p.FechaInicio >= filtroFechaInicio.Value && p.FechaFin <= filtroFechaFin.Value)
            .ToList();

        // Aplicar filtro de empleado
        if (!string.IsNullOrEmpty(filtroEmpleadoId) && int.TryParse(filtroEmpleadoId, out var empId))
        {
            permisosReporte = permisosReporte.Where(p => p.EmpleadoId == empId).ToList();
        }

        // Aplicar filtro de tipo de permiso
        if (!string.IsNullOrEmpty(filtroTipoPermisoId) && int.TryParse(filtroTipoPermisoId, out var tipoId))
        {
            permisosReporte = permisosReporte.Where(p => p.TipoPermisoId == tipoId).ToList();
        }

        // Aplicar filtro de estado
        if (!string.IsNullOrEmpty(filtroEstadoPermiso) && Enum.TryParse<EstadoPermiso>(filtroEstadoPermiso, out var estado))
        {
            permisosReporte = permisosReporte.Where(p => p.Estado == estado).ToList();
        }

        // Aplicar filtro de departamento
        if (!string.IsNullOrEmpty(filtroDepartamentoPermisos) && int.TryParse(filtroDepartamentoPermisos, out var deptId))
        {
            permisosReporte = permisosReporte.Where(p => p.Empleado?.DepartamentoId == deptId).ToList();
        }

        // Ordenar por fecha
        permisosReporte = permisosReporte.OrderByDescending(p => p.FechaSolicitud).ToList();
    }

    private async Task ExportarPermisosExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            await CargarDatosPermisos();

            if (!permisosReporte.Any())
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // Generar Excel
            var excelBytes = ReportService.GenerarReportePermisosExcel(permisosReporte);
            await DescargarArchivo(excelBytes, 
                $"Permisos_{filtroFechaInicio:yyyyMMdd}_{filtroFechaFin:yyyyMMdd}.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            successMessage = $"Datos exportados a Excel exitosamente. Total: {permisosReporte.Count} permisos";
            Logger.LogInformation("Permisos exportados a Excel: {Count} registros", permisosReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar permisos a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    // ============================================================
    // REPORTE: VACACIONES
    // ============================================================

    private async Task GenerarReporteVacaciones()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            await CargarDatosVacaciones();

            if (!vacacionesReporte.Any())
            {
                errorMessage = "No se encontraron vacaciones con los filtros seleccionados";
                return;
            }

            // Generar PDF
            var pdfBytes = ReportService.GenerarReporteVacacionesPdf(vacacionesReporte, filtroAnioVacaciones);
            await DescargarArchivo(pdfBytes, $"Vacaciones_{filtroAnioVacaciones}.pdf", "application/pdf");

            successMessage = $"Reporte generado exitosamente. Total: {vacacionesReporte.Count} registros, {vacacionesReporte.Sum(v => v.DiasTomados)} d칤as";
            Logger.LogInformation("Reporte de vacaciones generado: {Count} registros", vacacionesReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de vacaciones");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPreviaVacaciones()
    {
        try
        {
            errorMessage = null;
            await CargarDatosVacaciones();
            mostrarVistaPrevia = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de vacaciones");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private async Task CargarDatosVacaciones()
    {
        vacacionesReporte = (await VacacionRepository.GetAllAsync()).ToList();

        // Filtrar por a침o
        vacacionesReporte = vacacionesReporte
            .Where(v => v.PeriodoCorrespondiente == filtroAnioVacaciones)
            .ToList();

        // Aplicar filtro de empleado
        if (!string.IsNullOrEmpty(filtroEmpleadoVacacionesId) && int.TryParse(filtroEmpleadoVacacionesId, out var empId))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.EmpleadoId == empId).ToList();
        }

        // Aplicar filtro de estado
        if (!string.IsNullOrEmpty(filtroEstadoVacaciones) && Enum.TryParse<EstadoVacacion>(filtroEstadoVacaciones, out var estado))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.Estado == estado).ToList();
        }

        // Aplicar filtro de departamento
        if (!string.IsNullOrEmpty(filtroDepartamentoVacaciones) && int.TryParse(filtroDepartamentoVacaciones, out var deptId))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.Empleado?.DepartamentoId == deptId).ToList();
        }

        // Ordenar por fecha de inicio descendente
        vacacionesReporte = vacacionesReporte.OrderByDescending(v => v.FechaInicio).ToList();
    }

    private async Task ExportarVacacionesExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            await CargarDatosVacaciones();

            if (!vacacionesReporte.Any())
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // Generar Excel
            var excelBytes = ReportService.GenerarReporteVacacionesExcel(vacacionesReporte);
            await DescargarArchivo(excelBytes, $"Vacaciones_{filtroAnioVacaciones}.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            successMessage = $"Datos exportados a Excel exitosamente. Total: {vacacionesReporte.Count} registros";
            Logger.LogInformation("Vacaciones exportadas a Excel: {Count} registros", vacacionesReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar vacaciones a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    // ============================================================
    // REPORTE: ASISTENCIA
    // ============================================================

    private bool ValidarFechasAsistencia()
    {
        return filtroFechaInicioAsistencia.HasValue && 
               filtroFechaFinAsistencia.HasValue && 
               filtroFechaInicioAsistencia.Value <= filtroFechaFinAsistencia.Value;
    }

    private async Task GenerarReporteAsistencia()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            if (!ValidarFechasAsistencia())
            {
                errorMessage = "Debe seleccionar un rango de fechas v치lido";
                return;
            }

            await CargarDatosAsistencia();

            if (asistenciaReporte.Count == 0)
            {
                errorMessage = "No se encontraron registros de asistencia con los filtros seleccionados";
                return;
            }

            // TODO: Generar PDF
            await Task.Delay(500); // Simular generaci칩n

            var totalPresentes = asistenciaReporte.Sum(a => a.Value.Count(r => r.Presente));
            var totalAusentes = asistenciaReporte.Sum(a => a.Value.Count(r => !r.Presente));
            
            successMessage = $"Reporte generado exitosamente. Presentes: {totalPresentes}, Ausentes: {totalAusentes}";
            Logger.LogInformation("Reporte de asistencia generado: {Dias} d칤as", asistenciaReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de asistencia");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPreviaAsistencia()
    {
        try
        {
            errorMessage = null;
            
            if (!ValidarFechasAsistencia())
            {
                errorMessage = "Debe seleccionar un rango de fechas v치lido";
                return;
            }

            await CargarDatosAsistencia();
            
            // Mostrar en consola para verificaci칩n
            Logger.LogInformation("Vista previa de asistencia cargada: {Count} d칤as", asistenciaReporte.Count);
            
            successMessage = $"Vista previa cargada: {asistenciaReporte.Count} d칤as de registro";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de asistencia");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private Dictionary<DateTime, List<AsistenciaDetalle>> asistenciaReporte = new();

    private async Task CargarDatosAsistencia()
    {
        if (!filtroFechaInicioAsistencia.HasValue || !filtroFechaFinAsistencia.HasValue)
        {
            asistenciaReporte = new Dictionary<DateTime, List<AsistenciaDetalle>>();
            return;
        }

        // Obtener todos los registros diarios en el rango
        var registrosDiarios = (await RegistroDiarioRepository.GetAllAsync())
            .Where(rd => rd.Fecha >= filtroFechaInicioAsistencia.Value && rd.Fecha <= filtroFechaFinAsistencia.Value)
            .OrderBy(rd => rd.Fecha)
            .ToList();

        // Filtrar por empleado si est치 especificado
        if (!string.IsNullOrEmpty(filtroEmpleadoAsistenciaId) && int.TryParse(filtroEmpleadoAsistenciaId, out var empId))
        {
            var empleado = await EmpleadoRepository.GetByIdAsync(empId);
            if (empleado != null)
            {
                // Crear reporte para un solo empleado
                asistenciaReporte = registrosDiarios
                    .GroupBy(rd => rd.Fecha)
                    .ToDictionary(
                        g => g.Key,
                        g => new List<AsistenciaDetalle>
                        {
                            new AsistenciaDetalle
                            {
                                Empleado = empleado,
                                Presente = g.Any(rd => rd.EmpleadoId == empId),
                                Observaciones = g.FirstOrDefault(rd => rd.EmpleadoId == empId)?.Observaciones ?? ""
                            }
                        }
                    );
            }
        }
        else
        {
            // Reporte general - todos los empleados
            var empleadosActivos = (await EmpleadoRepository.GetAllAsync())
                .Where(e => e.Estado == EstadoEmpleado.Activo)
                .ToList();

            // Filtrar por departamento si est치 especificado
            if (!string.IsNullOrEmpty(filtroDepartamentoAsistencia) && int.TryParse(filtroDepartamentoAsistencia, out var deptId))
            {
                empleadosActivos = empleadosActivos.Where(e => e.DepartamentoId == deptId).ToList();
            }

            asistenciaReporte = new Dictionary<DateTime, List<AsistenciaDetalle>>();

            // Generar reporte d칤a por d칤a
            for (var fecha = filtroFechaInicioAsistencia.Value; fecha <= filtroFechaFinAsistencia.Value; fecha = fecha.AddDays(1))
            {
                var registrosDelDia = registrosDiarios.Where(rd => rd.Fecha.Date == fecha.Date).ToList();
                
                var detalles = empleadosActivos.Select(emp => new AsistenciaDetalle
                {
                    Empleado = emp,
                    Presente = registrosDelDia.Any(rd => rd.EmpleadoId == emp.Id),
                    Observaciones = registrosDelDia.FirstOrDefault(rd => rd.EmpleadoId == emp.Id)?.Observaciones ?? ""
                }).ToList();

                asistenciaReporte[fecha] = detalles;
            }
        }
    }

    private class AsistenciaDetalle
    {
        public Empleado Empleado { get; set; } = null!;
        public bool Presente { get; set; }
        public string Observaciones { get; set; } = "";
    }

    private async Task ExportarAsistenciaExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            if (!ValidarFechasAsistencia())
            {
                errorMessage = "Debe seleccionar un rango de fechas v치lido";
                return;
            }

            await CargarDatosAsistencia();

            if (asistenciaReporte.Count == 0)
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // TODO: Implementar exportaci칩n a Excel
            await Task.Delay(500); // Simular exportaci칩n

            successMessage = $"Datos exportados a Excel exitosamente. Total: {asistenciaReporte.Count} d칤as";
            Logger.LogInformation("Asistencia exportada a Excel: {Count} d칤as", asistenciaReporte.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar asistencia a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    // ============================================================
    // CERTIFICADO LABORAL
    // ============================================================

    private async Task GenerarCertificado()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            if (string.IsNullOrEmpty(empleadoCertificadoId) || !int.TryParse(empleadoCertificadoId, out var empId))
            {
                errorMessage = "Debe seleccionar un empleado";
                return;
            }

            var empleado = await EmpleadoRepository.GetByIdAsync(empId);
            if (empleado == null)
            {
                errorMessage = "Empleado no encontrado";
                return;
            }

            // Generar PDF del certificado
            var pdfBytes = ReportService.GenerarCertificadoLaboralPdf(empleado, propositoCertificado, incluirSalarioCertificado);
            await DescargarArchivo(pdfBytes, $"Certificado_{empleado.Cedula}_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");

            Logger.LogInformation("Certificado laboral generado para empleado: {EmpleadoId} - {Nombre}", 
                empleado.Id, empleado.NombreCompleto);

            successMessage = $"Certificado laboral generado exitosamente para {empleado.NombreCompleto}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar certificado laboral");
            errorMessage = $"Error al generar el certificado: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    // ============================================================
    // UTILIDADES
    // ============================================================

    private async Task DescargarArchivo(byte[] fileBytes, string fileName, string mimeType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, mimeType, base64);
    }

    private Task CerrarVistaPrevia()
    {
        mostrarVistaPrevia = false;
        return Task.CompletedTask;
    }

    private async Task Actualizar()
    {
        await CargarCatalogos();
        successMessage = "Cat치logos actualizados";
    }
}
