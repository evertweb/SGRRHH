@page "/documentos"
@page "/documentos/{EmpleadoIdParam:int}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject IEmpleadoRepository EmpleadoRepo
@inject ILocalStorageService StorageService
@inject IAuthService AuthService
@inject IJSRuntime JS
@inject ILogger<Documentos> Logger

<PageTitle>Documentos - SGRRHH</PageTitle>

<KeyboardHandler @ref="keyboardHandler" Shortcuts="shortcuts" ShowShortcutBar="true" />

<div class="page-title">üìÑ GESTI√ìN DE DOCUMENTOS</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="error-block">
        <h3>‚ö†Ô∏è ERROR</h3>
        <p>@errorMessage</p>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="success-block">
        ‚úì @successMessage
    </div>
}

<div class="toolbar">
    <div class="toolbar-group">
        <label>EMPLEADO:</label>
        <select @bind="selectedEmpleadoId" @bind:after="LoadDocumentos">
            <option value="0">-- Seleccionar Empleado --</option>
            @foreach (var emp in empleados)
            {
                <option value="@emp.Codigo - @emp.NombreCompleto">@emp.Codigo - @emp.NombreCompleto</option>
            }
        </select>
        
        <button @onclick="LoadDocumentos" disabled="@isLoading">
            @(isLoading ? "CARGANDO..." : "ACTUALIZAR [F5]")
        </button>

        @if (selectedEmpleadoId > 0 && AuthService.IsAdmin)
        {
            <button class="btn-success" @onclick="ShowUploadModal">
                + SUBIR DOCUMENTO
            </button>
        }
    </div>
</div>

@* Contenido principal *@
@if (selectedEmpleadoId == 0)
{
    <div class="empty-state">
        <div class="icon">üìÑ</div>
        <div class="message">GESTI√ìN DE DOCUMENTOS</div>
        <div class="hint">Seleccione un empleado para ver sus documentos</div>
    </div>
}
else if (isLoading)
{
    <div class="loading">‚è≥ Cargando documentos...</div>
}
else if (!documentos.Any())
{
    <div class="empty-state">
        <div class="icon">üìÑ</div>
        <div class="message">No hay documentos registrados para este empleado</div>
        @if (AuthService.IsAdmin)
        {
            <button class="btn-success" @onclick="ShowUploadModal">
                + SUBIR PRIMER DOCUMENTO
            </button>
        }
    </div>
}
else
{
    <table>
        <thead>
            <tr>
                <th>TIPO</th>
                <th>NOMBRE</th>
                <th style="width: 100px;">EMISI√ìN</th>
                <th style="width: 100px;">VENCIMIENTO</th>
                <th style="width: 80px;">ESTADO</th>
                <th style="width: 150px;">ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var doc in documentos)
            {
                <tr class="@(!doc.EstaVigente ? "row-expired" : "") @(selectedDocumento?.Id == doc.Id ? "selected" : "")"
                    @onclick="() => SelectDocumento(doc)">
                    <td>
                        <strong>@GetTipoNombre(doc.TipoDocumento)</strong>
                    </td>
                    <td>
                        <strong>@doc.Nombre</strong><br/>
                        <small style="color: #666;">@doc.NombreArchivoOriginal</small>
                    </td>
                    <td class="text-center">
                        @(doc.FechaEmision?.ToString("dd/MM/yyyy") ?? "-")
                    </td>
                    <td class="text-center">
                        @(doc.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "-")
                    </td>
                    <td class="text-center">
                        @if (doc.EstaVigente)
                        {
                            <span class="badge badge-vigente">VIGENTE</span>
                        }
                        else
                        {
                            <span class="badge badge-vencido">VENCIDO</span>
                        }
                    </td>
                    <td class="table-actions">
                        @if (!string.IsNullOrEmpty(doc.ArchivoPath))
                        {
                            <button @onclick="() => DescargarDocumento(doc)" @onclick:stopPropagation="true">
                                VER
                            </button>
                        }
                        @if (AuthService.IsAdmin)
                        {
                            <button class="btn-danger" @onclick="() => ConfirmarEliminar(doc)" @onclick:stopPropagation="true">
                                ELIMINAR
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div class="results-info">
        <strong>Total: @documentos.Count()</strong> documentos
        @if (selectedDocumento != null)
        {
            <span style="margin-left: 16px; color: #0000AA;">
                | Seleccionado: @selectedDocumento.Nombre
            </span>
        }
    </div>
}

@* Modal de Subir Documento *@
@if (showUploadModal)
{
    <div class="modal-overlay">
        <div class="modal-box" style="width: 600px;">
            <!-- Header -->
            <div class="modal-header">
                <span>üìÑ SUBIR DOCUMENTO</span>
                <button @onclick="CloseUploadModal" class="btn-close">‚úï</button>
            </div>

            <!-- Body -->
            <div class="modal-content">
                <div class="form-group">
                    <label>TIPO DE DOCUMENTO</label>
                    <select @bind="uploadTipo">
                        @foreach (TipoDocumentoEmpleado tipo in Enum.GetValues<TipoDocumentoEmpleado>())
                        {
                            <option value="@tipo">@GetTipoNombre(tipo)</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>NOMBRE DEL DOCUMENTO</label>
                    <input type="text" @bind="uploadNombre" 
                           placeholder="Nombre descriptivo del documento" />
                </div>

                <div class="form-group">
                    <label>DESCRIPCI√ìN (OPCIONAL)</label>
                    <input type="text" @bind="uploadDescripcion" 
                           placeholder="Descripci√≥n adicional" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>FECHA DE EMISI√ìN</label>
                        <input type="date" @bind="uploadFechaEmision" />
                    </div>

                    <div class="form-group">
                        <label>FECHA DE VENCIMIENTO</label>
                        <input type="date" @bind="uploadFechaVencimiento" />
                    </div>
                </div>

                <div class="form-group">
                    <label>ARCHIVO (PDF, WORD, IM√ÅGENES - M√ÅX. 10MB)</label>
                    <InputFile OnChange="OnFileSelected" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                    @if (!string.IsNullOrEmpty(selectedFileName))
                    {
                        <small style="color: #006600; display: block; margin-top: 4px;">
                            ‚úì Archivo seleccionado: @selectedFileName (@FormatFileSize(selectedFileBytes?.Length ?? 0))
                        </small>
                    }
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-actions">
                <button @onclick="CloseUploadModal">CANCELAR [ESC]</button>
                <button class="btn-success" @onclick="UploadDocument" disabled="@isUploading">
                    @(isUploading ? "SUBIENDO..." : "SUBIR DOCUMENTO")
                </button>
            </div>
        </div>
    </div>
}

@* Modal de Confirmaci√≥n de Eliminaci√≥n *@
@if (showConfirmModal)
{
    <div class="modal-overlay">
        <div class="modal-box" style="width: 400px;">
            <div class="modal-header modal-header-danger">
                <span>‚ö†Ô∏è CONFIRMAR ELIMINACI√ìN</span>
            </div>
            <div class="modal-content text-center">
                <p style="margin-bottom: 16px;">
                    ¬øEst√° seguro que desea eliminar el documento<br/>
                    <strong>@documentoAEliminar?.Nombre</strong>?
                </p>
                <p class="text-danger" style="margin-bottom: 20px;">
                    Esta acci√≥n no se puede deshacer.
                </p>
            </div>
            <div class="modal-actions">
                <button @onclick="CancelarEliminar">CANCELAR</button>
                <button class="btn-danger" @onclick="EliminarDocumento">S√ç, ELIMINAR</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int EmpleadoIdParam { get; set; }

    private KeyboardHandler? keyboardHandler;
    private List<KeyboardHandler.KeyboardShortcut> shortcuts = new();

    private List<Empleado> empleados = new();
    private List<DocumentoEmpleado> documentos = new();
    private int selectedEmpleadoId = 0;
    private DocumentoEmpleado? selectedDocumento;
    private bool isLoading = false;
    private string? successMessage;
    private string? errorMessage;

    // Upload Modal State
    private bool showUploadModal = false;
    private bool isUploading = false;
    private TipoDocumentoEmpleado uploadTipo = TipoDocumentoEmpleado.Otro;
    private string uploadNombre = "";
    private string uploadDescripcion = "";
    private DateTime? uploadFechaEmision;
    private DateTime? uploadFechaVencimiento;
    private string selectedFileName = "";
    private byte[]? selectedFileBytes;
    private string? selectedFileMime;

    // Confirmaci√≥n de eliminaci√≥n
    private bool showConfirmModal = false;
    private DocumentoEmpleado? documentoAEliminar;

    protected override async Task OnInitializedAsync()
    {
        // Configurar atajos de teclado
        shortcuts = new List<KeyboardHandler.KeyboardShortcut>
        {
            new() { Key = "F3", KeyDisplay = "F3", Description = "Subir Documento", Action = () => { if (selectedEmpleadoId > 0 && AuthService.IsAdmin) ShowUploadModal(); return Task.CompletedTask; } },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = LoadDocumentos },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = () => { if (showUploadModal) CloseUploadModal(); else if (showConfirmModal) CancelarEliminar(); return Task.CompletedTask; } }
        };

        try
        {
            empleados = (await EmpleadoRepo.GetAllActiveAsync()).ToList();
            if (EmpleadoIdParam > 0)
            {
                selectedEmpleadoId = EmpleadoIdParam;
                await LoadDocumentos();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando empleados");
            errorMessage = $"Error cargando empleados: {ex.Message}";
        }
    }

    private async Task LoadDocumentos()
    {
        if (selectedEmpleadoId == 0)
        {
            documentos.Clear();
            selectedDocumento = null;
            return;
        }

        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            documentos = (await DocumentoRepo.GetByEmpleadoIdAsync(selectedEmpleadoId))
                .OrderByDescending(d => d.FechaCreacion)
                .ToList();
            selectedDocumento = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando documentos del empleado {EmpleadoId}", selectedEmpleadoId);
            errorMessage = $"Error cargando documentos: {ex.Message}";
            documentos.Clear();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectDocumento(DocumentoEmpleado doc)
    {
        selectedDocumento = doc;
    }

    private string GetTipoNombre(TipoDocumentoEmpleado tipo) => tipo switch
    {
        TipoDocumentoEmpleado.Cedula => "C√©dula",
        TipoDocumentoEmpleado.HojaVida => "Hoja de Vida",
        TipoDocumentoEmpleado.CertificadoEstudios => "Certificado Estudios",
        TipoDocumentoEmpleado.CertificadoLaboral => "Certificado Laboral",
        TipoDocumentoEmpleado.ExamenMedicoIngreso => "Examen M√©dico Ingreso",
        TipoDocumentoEmpleado.ExamenMedicoPeriodico => "Examen M√©dico Peri√≥dico",
        TipoDocumentoEmpleado.ExamenMedicoEgreso => "Examen M√©dico Egreso",
        TipoDocumentoEmpleado.AfiliacionEPS => "Afiliaci√≥n EPS",
        TipoDocumentoEmpleado.AfiliacionAFP => "Afiliaci√≥n AFP",
        TipoDocumentoEmpleado.AfiliacionARL => "Afiliaci√≥n ARL",
        TipoDocumentoEmpleado.AfiliacionCajaCompensacion => "Caja Compensaci√≥n",
        TipoDocumentoEmpleado.ReferenciasPersonales => "Referencias Personales",
        TipoDocumentoEmpleado.ReferenciasLaborales => "Referencias Laborales",
        TipoDocumentoEmpleado.Antecedentes => "Antecedentes",
        TipoDocumentoEmpleado.LicenciaConduccion => "Licencia Conducci√≥n",
        TipoDocumentoEmpleado.LibretaMilitar => "Libreta Militar",
        TipoDocumentoEmpleado.RUT => "RUT",
        TipoDocumentoEmpleado.CertificadoBancario => "Certificado Bancario",
        TipoDocumentoEmpleado.ActaEntregaDotacion => "Entrega Dotaci√≥n",
        TipoDocumentoEmpleado.Capacitacion => "Capacitaci√≥n",
        TipoDocumentoEmpleado.ContratoFirmado => "Contrato Firmado",
        TipoDocumentoEmpleado.Foto => "Foto",
        _ => "Otro"
    };

    private void ShowUploadModal()
    {
        uploadTipo = TipoDocumentoEmpleado.Otro;
        uploadNombre = "";
        uploadDescripcion = "";
        uploadFechaEmision = DateTime.Today;
        uploadFechaVencimiento = null;
        selectedFileName = "";
        selectedFileBytes = null;
        selectedFileMime = null;
        showUploadModal = true;
    }

    private void CloseUploadModal()
    {
        showUploadModal = false;
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                selectedFileName = file.Name;
                selectedFileMime = file.ContentType;

                // Read file bytes (limit to 10MB)
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                selectedFileBytes = ms.ToArray();

                // Auto-fill name if empty
                if (string.IsNullOrEmpty(uploadNombre))
                {
                    uploadNombre = Path.GetFileNameWithoutExtension(file.Name);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error seleccionando archivo");
                errorMessage = $"Error al seleccionar archivo: {ex.Message}";
                selectedFileName = "";
                selectedFileBytes = null;
            }
        }
    }

    private async Task UploadDocument()
    {
        if (string.IsNullOrWhiteSpace(uploadNombre))
        {
            errorMessage = "Debe ingresar un nombre para el documento";
            return;
        }
        
        if (selectedFileBytes == null || selectedFileBytes.Length == 0)
        {
            errorMessage = "Debe seleccionar un archivo";
            return;
        }

        isUploading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Guardar archivo en almacenamiento local
            var tipoDocumentoStr = GetTipoNombre(uploadTipo);
            var storageResult = await StorageService.SaveDocumentoEmpleadoAsync(
                selectedEmpleadoId,
                tipoDocumentoStr,
                selectedFileBytes,
                selectedFileName
            );

            if (!storageResult.IsSuccess)
            {
                errorMessage = $"Error al guardar archivo: {storageResult.ErrorMessage}";
                return;
            }

            // Crear registro en base de datos
            var documento = new DocumentoEmpleado
            {
                EmpleadoId = selectedEmpleadoId,
                TipoDocumento = uploadTipo,
                Nombre = uploadNombre,
                Descripcion = uploadDescripcion,
                NombreArchivoOriginal = selectedFileName,
                TipoMime = selectedFileMime ?? "application/octet-stream",
                TamanoArchivo = selectedFileBytes.Length,
                FechaEmision = uploadFechaEmision,
                FechaVencimiento = uploadFechaVencimiento,
                SubidoPorNombre = AuthService.CurrentUser?.NombreCompleto,
                SubidoPorUsuarioId = AuthService.CurrentUser?.Id,
                ArchivoPath = storageResult.Value,
                Activo = true,
                FechaCreacion = DateTime.Now
            };

            await DocumentoRepo.AddAsync(documento);
            
            Logger.LogInformation("Documento subido: {Nombre} para empleado {EmpleadoId}", uploadNombre, selectedEmpleadoId);
            
            successMessage = $"Documento '{uploadNombre}' subido exitosamente";
            showUploadModal = false;
            await LoadDocumentos();
            await ClearSuccessMessage();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error subiendo documento");
            errorMessage = $"Error al subir documento: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task DescargarDocumento(DocumentoEmpleado doc)
    {
        if (string.IsNullOrEmpty(doc.ArchivoPath))
        {
            errorMessage = "El documento no tiene un archivo asociado";
            return;
        }

        try
        {
            var bytes = await StorageService.GetFileAsync(doc.ArchivoPath);
            if (bytes == null || bytes.Length == 0)
            {
                errorMessage = "No se pudo leer el archivo del documento";
                return;
            }

            // Descargar archivo usando JavaScript
            var fileName = doc.NombreArchivoOriginal;
            var mimeType = doc.TipoMime;
            
            await JS.InvokeVoidAsync("downloadFile", fileName, mimeType, bytes);
            
            Logger.LogInformation("Documento descargado: {Nombre} (ID: {Id})", doc.Nombre, doc.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error descargando documento {Id}", doc.Id);
            errorMessage = $"Error al descargar documento: {ex.Message}";
        }
    }

    private void ConfirmarEliminar(DocumentoEmpleado doc)
    {
        documentoAEliminar = doc;
        showConfirmModal = true;
    }

    private void CancelarEliminar()
    {
        documentoAEliminar = null;
        showConfirmModal = false;
    }

    private async Task EliminarDocumento()
    {
        if (documentoAEliminar == null) return;

        try
        {
            // Eliminar archivo f√≠sico
            if (!string.IsNullOrEmpty(documentoAEliminar.ArchivoPath))
            {
                await StorageService.DeleteDocumentoEmpleadoAsync(documentoAEliminar.Id);
            }

            // Eliminar registro de base de datos
            await DocumentoRepo.DeleteAsync(documentoAEliminar.Id);
            
            Logger.LogInformation("Documento eliminado: {Nombre} (ID: {Id})", documentoAEliminar.Nombre, documentoAEliminar.Id);
            
            successMessage = $"Documento '{documentoAEliminar.Nombre}' eliminado correctamente";
            showConfirmModal = false;
            documentoAEliminar = null;
            
            await LoadDocumentos();
            await ClearSuccessMessage();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error eliminando documento {Id}", documentoAEliminar.Id);
            errorMessage = $"Error al eliminar documento: {ex.Message}";
            showConfirmModal = false;
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async Task ClearSuccessMessage()
    {
        await Task.Delay(4000);
        successMessage = null;
        StateHasChanged();
    }
}
