@page "/configuracion"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Interfaces
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IConfiguracionRepository ConfiguracionRepository
@inject IDatabaseMaintenanceService DatabaseMaintenanceService
@inject NavigationManager Navigation
@inject ILogger<Configuracion> Logger
@inject IJSRuntime JSRuntime
@inject IWebHostEnvironment Environment

<PageTitle>CONFIGURACION - SGRRHH</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>CONFIGURACION DEL SISTEMA</h1>
        <div class="shortcut-bar">
            F5=GUARDAR | ESC=SALIR
        </div>
    </div>

    @if (!AuthService.IsAdmin)
    {
        <div class="error-message">
            ERROR: ACCESO DENEGADO
            <br>
            Esta operacion requiere permisos de administrador.
            <br><br>
            <button class="btn-secondary" @onclick="@(() => Navigation.NavigateTo("/empleados"))">VOLVER</button>
        </div>
        return;
    }

    @if (errorMessage != null)
    {
        <div class="error-message">
            ERROR: @errorMessage
            <br><br>
            <button class="btn-secondary" @onclick="() => errorMessage = null">ACEPTAR</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="success-message">
            @successMessage
        </div>
    }

    @if (showConfirmacion)
    {
        <div class="confirmation-dialog">
            <div class="confirmation-content">
                <h3>CONFIRMAR OPERACION</h3>
                <p>¬øGuardar cambios en configuracion del sistema?</p>
                <div class="button-group">
                    <button class="btn-primary" @onclick="ConfirmarGuardado">SI - GUARDAR</button>
                    <button class="btn-secondary" @onclick="CancelarGuardado">NO - CANCELAR</button>
                </div>
            </div>
        </div>
    }

    <div class="section-selector">
        <button class="section-button @(seccionActiva == "sistema" ? "active" : "")" 
                @onclick='() => CambiarSeccion("sistema")'>
            [SISTEMA]
        </button>
        <button class="section-button @(seccionActiva == "notificaciones" ? "active" : "")" 
                @onclick='() => CambiarSeccion("notificaciones")'>
            [NOTIFICACIONES]
        </button>
        <button class="section-button @(seccionActiva == "respaldos" ? "active" : "")" 
                @onclick='() => CambiarSeccion("respaldos")'>
            [RESPALDOS]
        </button>
        <button class="section-button @(seccionActiva == "seguridad" ? "active" : "")" 
                @onclick='() => CambiarSeccion("seguridad")'>
            [SEGURIDAD]
        </button>
        <button class="section-button @(seccionActiva == "mantenimiento" ? "active" : "")" 
                @onclick='() => CambiarSeccion("mantenimiento")'>
            [MANTENIMIENTO]
        </button>
    </div>

    @* SECCION: SISTEMA *@
    @if (seccionActiva == "sistema")
    {
        <div class="form-section">
            <h2>PARAMETROS DEL SISTEMA</h2>
            
            <div class="form-row">
                <label>NOMBRE DE LA EMPRESA:</label>
                <input type="text" @bind="empresaNombre" />
            </div>

            <div class="form-row">
                <label>RUC/IDENTIFICACION:</label>
                <input type="text" @bind="empresaRuc" />
            </div>

            <div class="form-row">
                <label>DIRECCION:</label>
                <input type="text" @bind="empresaDireccion" />
            </div>

            <div class="form-row">
                <label>TELEFONO:</label>
                <input type="text" @bind="empresaTelefono" />
            </div>

            <div class="form-row">
                <label>EMAIL:</label>
                <input type="text" @bind="empresaEmail" />
            </div>

            <div class="form-row">
                <label>DIAS HABILES SEMANA:</label>
                <input type="number" @bind="diasHabilesSemana" min="1" max="7" />
            </div>

            <div class="form-row">
                <label>HORAS LABORALES DIA:</label>
                <input type="number" @bind="horasLaboralesDia" min="1" max="24" step="0.5" />
            </div>

            <div class="form-row">
                <label>FORMATO FECHA:</label>
                <select @bind="formatoFecha">
                    <option value="dd/MM/yyyy">DD/MM/AAAA</option>
                    <option value="MM/dd/yyyy">MM/DD/AAAA</option>
                    <option value="yyyy-MM-dd">AAAA-MM-DD</option>
                </select>
            </div>
        </div>
    }

    @* SECCION: NOTIFICACIONES *@
    @if (seccionActiva == "notificaciones")
    {
        <div class="form-section">
            <h2>CONFIGURACION DE NOTIFICACIONES</h2>
            
            <div class="form-row">
                <label>SERVIDOR SMTP:</label>
                <input type="text" @bind="smtpServidor" />
            </div>

            <div class="form-row">
                <label>PUERTO SMTP:</label>
                <input type="number" @bind="smtpPuerto" min="1" max="65535" />
            </div>

            <div class="form-row">
                <label>USUARIO SMTP:</label>
                <input type="text" @bind="smtpUsuario" />
            </div>

            <div class="form-row">
                <label>CONTRASENA SMTP:</label>
                <input type="password" @bind="smtpContrasena" />
            </div>

            <div class="form-row">
                <label>REMITENTE EMAIL:</label>
                <input type="text" @bind="emailRemitente" />
            </div>

            <div class="form-row">
                <label>HABILITAR SSL:</label>
                <select @bind="smtpSsl">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>

            <div class="form-row">
                <label>NOTIFICAR VENCIMIENTOS:</label>
                <select @bind="notificarVencimientos">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>

            <div class="form-row">
                <label>DIAS ANTICIPACION:</label>
                <input type="number" @bind="diasAnticipacion" min="1" max="90" />
            </div>
        </div>
    }

    @* SECCION: RESPALDOS *@
    @if (seccionActiva == "respaldos")
    {
        <div class="form-section">
            <h2>CONFIGURACION DE RESPALDOS</h2>
            
            <div class="form-row">
                <label>RUTA RESPALDOS:</label>
                <input type="text" @bind="rutaRespaldos" disabled />
            </div>

            <div class="form-row">
                <label>RESPALDO AUTOMATICO:</label>
                <select @bind="respaldoAutomatico">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>

            <div class="form-row">
                <label>FRECUENCIA (DIAS):</label>
                <input type="number" @bind="frecuenciaRespaldo" min="1" max="365" />
            </div>

            <div class="form-row">
                <label>RETENER RESPALDOS (DIAS):</label>
                <input type="number" @bind="retencionRespaldos" min="7" max="3650" />
            </div>

            <div class="form-row">
                <label>ULTIMO RESPALDO:</label>
                <input type="text" value="@(ultimoBackup?.ToString("dd/MM/yyyy HH:mm") ?? "NUNCA")" disabled />
            </div>

            <div class="form-row">
                <label>TAMANO BASE DATOS:</label>
                <input type="text" value="@((tamanoDb / 1024 / 1024).ToString("N2")) MB" disabled />
            </div>

            <div class="button-section">
                <button class="btn-primary" @onclick="CrearRespaldoManual" disabled="@isBackingUp">
                    @if (isBackingUp)
                    {
                        <span>PROCESANDO...</span>
                    }
                    else
                    {
                        <span>CREAR RESPALDO AHORA</span>
                    }
                </button>
            </div>
        </div>
    }

    @* SECCION: SEGURIDAD *@
    @if (seccionActiva == "seguridad")
    {
        <div class="form-section">
            <h2>PARAMETROS DE SEGURIDAD</h2>
            
            @* Control de Acceso - Modo Corporativo *@
            <div class="form-row" style="border: 2px solid #000; padding: 15px; margin-bottom: 20px; background: #f9f9f9;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <strong style="font-size: 14px;">
                            @if (AuthService.ModoCorporativoActivo)
                            {
                                <span>üîí MODO CORPORATIVO ACTIVO</span>
                            }
                            else
                            {
                                <span>üîì ACCESO LIBRE</span>
                            }
                        </strong>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">
                            @if (AuthService.ModoCorporativoActivo)
                            {
                                <span>Las restricciones de roles est√°n aplicadas</span>
                            }
                            else
                            {
                                <span>Todos los usuarios tienen acceso completo</span>
                            }
                        </p>
                    </div>
                    <div>
                        <button class="@(AuthService.ModoCorporativoActivo ? "btn-danger" : "btn-primary")" 
                                style="min-width: 120px;"
                                @onclick="ToggleModoCorporativo">
                            @if (AuthService.ModoCorporativoActivo)
                            {
                                <span>DESACTIVAR</span>
                            }
                            else
                            {
                                <span>ACTIVAR</span>
                            }
                        </button>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 11px;">
                    <strong>¬øQu√© hace el Modo Corporativo?</strong>
                    <ul style="margin: 5px 0 0 15px; padding: 0;">
                        <li>Operadores (Secretaria): Solo pueden crear y editar datos b√°sicos</li>
                        <li>Aprobadores (Ingeniera): Pueden aprobar/rechazar, editar datos cr√≠ticos</li>
                        <li>Administradores: Acceso completo</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-row">
                <label>TIEMPO SESION (MINUTOS):</label>
                <input type="number" @bind="tiempoSesion" min="5" max="480" />
            </div>

            <div class="form-row">
                <label>INTENTOS LOGIN MAXIMOS:</label>
                <input type="number" @bind="intentosLoginMax" min="3" max="10" />
            </div>

            <div class="form-row">
                <label>BLOQUEO USUARIO (MINUTOS):</label>
                <input type="number" @bind="tiempoBloqueo" min="5" max="60" />
            </div>

            <div class="form-row">
                <label>LONGITUD MINIMA PASSWORD:</label>
                <input type="number" @bind="longitudPassword" min="6" max="20" />
            </div>

            <div class="form-row">
                <label>REQUERIR MAYUSCULAS:</label>
                <select @bind="requerirMayusculas">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>

            <div class="form-row">
                <label>REQUERIR NUMEROS:</label>
                <select @bind="requerirNumeros">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>

            <div class="form-row">
                <label>CADUCIDAD PASSWORD (DIAS):</label>
                <input type="number" @bind="caducidadPassword" min="0" max="365" />
            </div>

            <div class="form-row">
                <label>AUDITAR OPERACIONES:</label>
                <select @bind="auditarOperaciones">
                    <option value="true">SI</option>
                    <option value="false">NO</option>
                </select>
            </div>
        </div>
    }

    @* SECCION: MANTENIMIENTO *@
    @if (seccionActiva == "mantenimiento")
    {
        <div class="form-section">
            <h2>MANTENIMIENTO DE BASE DE DATOS</h2>
            
            @if (dbStats != null)
            {
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">@((dbStats.TamanoBytes / 1024.0 / 1024.0).ToString("N2")) MB</div>
                        <div class="stat-label">TAMA√ëO DB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">@dbStats.TotalUsuarios</div>
                        <div class="stat-label">USUARIOS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">@dbStats.TotalEmpleados</div>
                        <div class="stat-label">EMPLEADOS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">@dbStats.TotalRegistros</div>
                        <div class="stat-label">TOTAL REGISTROS</div>
                    </div>
                </div>
            }

            <div class="maintenance-section">
                <h3>LIMPIAR BASE DE DATOS</h3>
                <p class="description">
                    Elimina todos los datos (empleados, permisos, vacaciones, etc.) 
                    <strong>EXCEPTO LOS USUARIOS</strong>. Los usuarios actuales se preservan.
                </p>
                <button class="btn-warning" @onclick="MostrarConfirmacionLimpieza" disabled="@isProcessing">
                    @if (isProcessing && operacionActual == "limpieza")
                    {
                        <span>PROCESANDO...</span>
                    }
                    else
                    {
                        <span>LIMPIAR DATOS (PRESERVAR USUARIOS)</span>
                    }
                </button>
            </div>

            <div class="maintenance-section danger-zone">
                <h3>‚ö†Ô∏è ZONA PELIGROSA - RESET PARA DISTRIBUCI√ìN</h3>
                <p class="description warning-text">
                    <strong>ATENCION:</strong> Esta opci√≥n elimina <strong>TODO</strong> incluyendo usuarios
                    y crea un usuario administrador por defecto:
                </p>
                <div class="credentials-box">
                    <div><strong>Usuario:</strong> admin</div>
                    <div><strong>Contrase√±a:</strong> Admin123!</div>
                </div>
                <p class="description warning-text">
                    Use esta opci√≥n solo cuando prepare la aplicaci√≥n para distribuir a un nuevo cliente.
                </p>
                <button class="btn-danger" @onclick="MostrarConfirmacionReset" disabled="@isProcessing">
                    @if (isProcessing && operacionActual == "reset")
                    {
                        <span>PROCESANDO...</span>
                    }
                    else
                    {
                        <span>RESET COMPLETO PARA DISTRIBUCI√ìN</span>
                    }
                </button>
            </div>

            @if (resultadoMantenimiento != null)
            {
                <div class="@(resultadoMantenimiento.Exitoso ? "success-box" : "error-box")">
                    @if (resultadoMantenimiento.Exitoso)
                    {
                        <h4>‚úì OPERACI√ìN COMPLETADA</h4>
                        <p>Registros eliminados: @resultadoMantenimiento.TotalRegistrosEliminados</p>
                        <p>Tablas afectadas: @resultadoMantenimiento.TablasLimpiadas</p>
                        <p>Usuarios activos: @resultadoMantenimiento.UsuariosPreservados</p>
                    }
                    else
                    {
                        <h4>‚úó ERROR EN LA OPERACI√ìN</h4>
                        <p>@resultadoMantenimiento.MensajeError</p>
                    }
                </div>
            }
        </div>
    }

    @* DIALOGO CONFIRMACION LIMPIEZA *@
    @if (showConfirmacionLimpieza)
    {
        <div class="confirmation-dialog">
            <div class="confirmation-content">
                <h3>‚ö†Ô∏è CONFIRMAR LIMPIEZA</h3>
                <p>Esta operaci√≥n eliminar√° <strong>TODOS</strong> los datos excepto usuarios.</p>
                <p>Esta acci√≥n <strong>NO SE PUEDE DESHACER</strong>.</p>
                <p>¬øEst√° seguro de continuar?</p>
                <div class="button-group">
                    <button class="btn-warning" @onclick="EjecutarLimpieza">SI - LIMPIAR DATOS</button>
                    <button class="btn-secondary" @onclick="() => showConfirmacionLimpieza = false">NO - CANCELAR</button>
                </div>
            </div>
        </div>
    }

    @* DIALOGO CONFIRMACION RESET *@
    @if (showConfirmacionReset)
    {
        <div class="confirmation-dialog">
            <div class="confirmation-content danger">
                <h3>‚ö†Ô∏è CONFIRMAR RESET COMPLETO</h3>
                <p><strong>¬°ATENCI√ìN! Esta operaci√≥n:</strong></p>
                <ul>
                    <li>Eliminar√° TODOS los datos incluyendo USUARIOS</li>
                    <li>Crear√° un usuario admin por defecto (admin / Admin123!)</li>
                    <li>NO SE PUEDE DESHACER</li>
                </ul>
                <p>Para confirmar, escriba <strong>RESET</strong>:</p>
                <input type="text" @bind="confirmacionResetTexto" placeholder="Escriba RESET" />
                <div class="button-group">
                    <button class="btn-danger" @onclick="EjecutarReset" 
                            disabled="@(confirmacionResetTexto != "RESET")">
                        CONFIRMAR RESET
                    </button>
                    <button class="btn-secondary" @onclick="CancelarReset">CANCELAR</button>
                </div>
            </div>
        </div>
    }

    <div class="button-bar">
        <button class="btn-primary" @onclick="SolicitarGuardado" disabled="@isSaving">
            @if (isSaving)
            {
                <span>GUARDANDO...</span>
            }
            else
            {
                <span>GUARDAR CONFIGURACION (F5)</span>
            }
        </button>
        <button class="btn-secondary" @onclick="Salir">SALIR (ESC)</button>
    </div>

</div>

@code {
    private string seccionActiva = "sistema";
    private bool showConfirmacion;
    
    // SISTEMA
    private string empresaNombre = string.Empty;
    private string empresaRuc = string.Empty;
    private string empresaDireccion = string.Empty;
    private string empresaTelefono = string.Empty;
    private string empresaEmail = string.Empty;
    private int diasHabilesSemana = 5;
    private decimal horasLaboralesDia = 8;
    private string formatoFecha = "dd/MM/yyyy";
    
    // NOTIFICACIONES
    private string smtpServidor = string.Empty;
    private int smtpPuerto = 587;
    private string smtpUsuario = string.Empty;
    private string smtpContrasena = string.Empty;
    private string emailRemitente = string.Empty;
    private string smtpSsl = "true";
    private string notificarVencimientos = "true";
    private int diasAnticipacion = 15;
    
    // MANTENIMIENTO
    private DatabaseStats? dbStats;
    private DatabaseCleanupResult? resultadoMantenimiento;
    private bool showConfirmacionLimpieza;
    private bool showConfirmacionReset;
    private string confirmacionResetTexto = string.Empty;
    private bool isProcessing;
    private string operacionActual = string.Empty;
    
    // RESPALDOS
    private string rutaRespaldos = string.Empty;
    private string respaldoAutomatico = "false";
    private int frecuenciaRespaldo = 7;
    private int retencionRespaldos = 90;
    private DateTime? ultimoBackup;
    private long tamanoDb;
    
    // SEGURIDAD
    private int tiempoSesion = 60;
    private int intentosLoginMax = 3;
    private int tiempoBloqueo = 15;
    private int longitudPassword = 8;
    private string requerirMayusculas = "true";
    private string requerirNumeros = "true";
    private int caducidadPassword = 90;
    private string auditarOperaciones = "true";
    
    // Estados
    private bool isSaving;
    private bool isBackingUp;
    private string? errorMessage;
    private string? successMessage;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        if (!AuthService.IsAdmin)
        {
            Logger.LogWarning("Usuario {User} intento acceder a configuracion sin permisos", 
                AuthService.CurrentUser?.Username);
            return;
        }
        
        await CargarConfiguracion();
        await CargarInfoSistema();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("addKeyboardHandler", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task HandleKeyPress(string key)
    {
        if (key == "F5")
        {
            SolicitarGuardado();
        }
        else if (key == "Escape")
        {
            Salir();
        }
        
        StateHasChanged();
    }
    
    private void CambiarSeccion(string seccion)
    {
        seccionActiva = seccion;
        errorMessage = null;
        successMessage = null;
        resultadoMantenimiento = null;
        
        // Cargar estad√≠sticas si entramos a mantenimiento
        if (seccion == "mantenimiento")
        {
            _ = CargarEstadisticasDb();
        }
    }
    
    private async Task ToggleModoCorporativo()
    {
        var activar = !AuthService.ModoCorporativoActivo;
        var resultado = await AuthService.SetModoCorporativoAsync(activar);
        
        if (!resultado.IsSuccess)
        {
            errorMessage = resultado.Message;
        }
        else
        {
            successMessage = resultado.Message;
            Logger.LogInformation("Modo Corporativo {Estado} por {Usuario}", 
                activar ? "ACTIVADO" : "DESACTIVADO", AuthService.CurrentUser?.Username);
            
            // Limpiar mensaje despu√©s de un tiempo
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                await InvokeAsync(() =>
                {
                    successMessage = null;
                    StateHasChanged();
                });
            });
        }
        
        StateHasChanged();
    }
    
    private async Task CargarEstadisticasDb()
    {
        try
        {
            dbStats = await DatabaseMaintenanceService.ObtenerEstadisticasAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar estad√≠sticas de base de datos");
        }
    }
    
    private void MostrarConfirmacionLimpieza()
    {
        resultadoMantenimiento = null;
        showConfirmacionLimpieza = true;
    }
    
    private void MostrarConfirmacionReset()
    {
        resultadoMantenimiento = null;
        confirmacionResetTexto = string.Empty;
        showConfirmacionReset = true;
    }
    
    private void CancelarReset()
    {
        showConfirmacionReset = false;
        confirmacionResetTexto = string.Empty;
    }
    
    private async Task EjecutarLimpieza()
    {
        showConfirmacionLimpieza = false;
        isProcessing = true;
        operacionActual = "limpieza";
        StateHasChanged();
        
        try
        {
            Logger.LogWarning("Usuario {User} iniciando limpieza de base de datos", 
                AuthService.CurrentUser?.Username);
            
            resultadoMantenimiento = await DatabaseMaintenanceService.LimpiarBaseDatosAsync();
            
            if (resultadoMantenimiento.Exitoso)
            {
                Logger.LogWarning("Limpieza completada por {User}: {Registros} registros eliminados", 
                    AuthService.CurrentUser?.Username, resultadoMantenimiento.TotalRegistrosEliminados);
            }
            
            // Actualizar estad√≠sticas
            await CargarEstadisticasDb();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error durante limpieza de base de datos");
            resultadoMantenimiento = new DatabaseCleanupResult
            {
                Exitoso = false,
                MensajeError = ex.Message
            };
        }
        finally
        {
            isProcessing = false;
            operacionActual = string.Empty;
            StateHasChanged();
        }
    }
    
    private async Task EjecutarReset()
    {
        if (confirmacionResetTexto != "RESET") return;
        
        showConfirmacionReset = false;
        isProcessing = true;
        operacionActual = "reset";
        StateHasChanged();
        
        try
        {
            Logger.LogCritical("Usuario {User} iniciando RESET COMPLETO de base de datos", 
                AuthService.CurrentUser?.Username);
            
            resultadoMantenimiento = await DatabaseMaintenanceService.ResetearParaDistribucionAsync();
            
            if (resultadoMantenimiento.Exitoso)
            {
                Logger.LogCritical("RESET COMPLETO por {User}: DB lista para distribuci√≥n", 
                    AuthService.CurrentUser?.Username);
                
                // Despu√©s del reset, cerrar sesi√≥n porque el usuario actual ya no existe
                successMessage = "Base de datos reseteada. Ser√° redirigido al login. Usuario: admin / Password: Admin123!";
                StateHasChanged();
                
                await Task.Delay(3000);
                await AuthService.LogoutAsync();
                Navigation.NavigateTo("/login", forceLoad: true);
                return;
            }
            
            // Actualizar estad√≠sticas
            await CargarEstadisticasDb();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error durante reset de base de datos");
            resultadoMantenimiento = new DatabaseCleanupResult
            {
                Exitoso = false,
                MensajeError = ex.Message
            };
        }
        finally
        {
            isProcessing = false;
            operacionActual = string.Empty;
            confirmacionResetTexto = string.Empty;
            StateHasChanged();
        }
    }
    
    private async Task CargarConfiguracion()
    {
        try
        {
            // SISTEMA
            empresaNombre = await GetConfigValueAsync("empresa_nombre", "MI EMPRESA");
            empresaRuc = await GetConfigValueAsync("empresa_ruc", "");
            empresaDireccion = await GetConfigValueAsync("empresa_direccion", "");
            empresaTelefono = await GetConfigValueAsync("empresa_telefono", "");
            empresaEmail = await GetConfigValueAsync("empresa_email", "");
            diasHabilesSemana = int.Parse(await GetConfigValueAsync("dias_habiles_semana", "5"));
            horasLaboralesDia = decimal.Parse(await GetConfigValueAsync("horas_laborales_dia", "8"));
            formatoFecha = await GetConfigValueAsync("formato_fecha", "dd/MM/yyyy");
            
            // NOTIFICACIONES
            smtpServidor = await GetConfigValueAsync("smtp_servidor", "");
            smtpPuerto = int.Parse(await GetConfigValueAsync("smtp_puerto", "587"));
            smtpUsuario = await GetConfigValueAsync("smtp_usuario", "");
            smtpContrasena = await GetConfigValueAsync("smtp_contrasena", "");
            emailRemitente = await GetConfigValueAsync("email_remitente", "");
            smtpSsl = await GetConfigValueAsync("smtp_ssl", "true");
            notificarVencimientos = await GetConfigValueAsync("notificar_vencimientos", "true");
            diasAnticipacion = int.Parse(await GetConfigValueAsync("dias_anticipacion", "15"));
            
            // RESPALDOS
            rutaRespaldos = Path.Combine(Environment.ContentRootPath, "Backups");
            respaldoAutomatico = await GetConfigValueAsync("respaldo_automatico", "false");
            frecuenciaRespaldo = int.Parse(await GetConfigValueAsync("frecuencia_respaldo", "7"));
            retencionRespaldos = int.Parse(await GetConfigValueAsync("retencion_respaldos", "90"));
            
            // SEGURIDAD
            tiempoSesion = int.Parse(await GetConfigValueAsync("tiempo_sesion", "60"));
            intentosLoginMax = int.Parse(await GetConfigValueAsync("intentos_login_max", "3"));
            tiempoBloqueo = int.Parse(await GetConfigValueAsync("tiempo_bloqueo", "15"));
            longitudPassword = int.Parse(await GetConfigValueAsync("longitud_password", "8"));
            requerirMayusculas = await GetConfigValueAsync("requerir_mayusculas", "true");
            requerirNumeros = await GetConfigValueAsync("requerir_numeros", "true");
            caducidadPassword = int.Parse(await GetConfigValueAsync("caducidad_password", "90"));
            auditarOperaciones = await GetConfigValueAsync("auditar_operaciones", "true");
            
            Logger.LogInformation("Configuracion cargada correctamente");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar configuracion");
            errorMessage = "Error al cargar configuracion: " + ex.Message;
        }
    }
    
    private async Task CargarInfoSistema()
    {
        try
        {
            var dbPath = Path.Combine(Environment.ContentRootPath, "Data", "sgrrhh.db");
            if (File.Exists(dbPath))
            {
                var fileInfo = new FileInfo(dbPath);
                tamanoDb = fileInfo.Length;
            }
            
            var ultimoBackupStr = await GetConfigValueAsync("ultimo_backup", "");
            if (DateTime.TryParse(ultimoBackupStr, out var fecha))
            {
                ultimoBackup = fecha;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar informacion del sistema");
        }
    }
    
    private void SolicitarGuardado()
    {
        if (isSaving) return;
        showConfirmacion = true;
    }
    
    private async Task ConfirmarGuardado()
    {
        showConfirmacion = false;
        await GuardarConfiguracion();
    }
    
    private void CancelarGuardado()
    {
        showConfirmacion = false;
    }
    
    private async Task GuardarConfiguracion()
    {
        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();
            
            // Validaciones
            if (string.IsNullOrWhiteSpace(empresaNombre))
            {
                errorMessage = "El nombre de la empresa es obligatorio";
                return;
            }
            
            if (diasHabilesSemana < 1 || diasHabilesSemana > 7)
            {
                errorMessage = "Dias habiles debe estar entre 1 y 7";
                return;
            }
            
            if (horasLaboralesDia < 1 || horasLaboralesDia > 24)
            {
                errorMessage = "Horas laborales debe estar entre 1 y 24";
                return;
            }
            
            // SISTEMA
            await SetConfigValueAsync("empresa_nombre", empresaNombre, "Sistema");
            await SetConfigValueAsync("empresa_ruc", empresaRuc, "Sistema");
            await SetConfigValueAsync("empresa_direccion", empresaDireccion, "Sistema");
            await SetConfigValueAsync("empresa_telefono", empresaTelefono, "Sistema");
            await SetConfigValueAsync("empresa_email", empresaEmail, "Sistema");
            await SetConfigValueAsync("dias_habiles_semana", diasHabilesSemana.ToString(), "Sistema");
            await SetConfigValueAsync("horas_laborales_dia", horasLaboralesDia.ToString(), "Sistema");
            await SetConfigValueAsync("formato_fecha", formatoFecha, "Sistema");
            
            // NOTIFICACIONES
            await SetConfigValueAsync("smtp_servidor", smtpServidor, "Notificaciones");
            await SetConfigValueAsync("smtp_puerto", smtpPuerto.ToString(), "Notificaciones");
            await SetConfigValueAsync("smtp_usuario", smtpUsuario, "Notificaciones");
            await SetConfigValueAsync("smtp_contrasena", smtpContrasena, "Notificaciones");
            await SetConfigValueAsync("email_remitente", emailRemitente, "Notificaciones");
            await SetConfigValueAsync("smtp_ssl", smtpSsl, "Notificaciones");
            await SetConfigValueAsync("notificar_vencimientos", notificarVencimientos, "Notificaciones");
            await SetConfigValueAsync("dias_anticipacion", diasAnticipacion.ToString(), "Notificaciones");
            
            // RESPALDOS
            await SetConfigValueAsync("respaldo_automatico", respaldoAutomatico, "Respaldos");
            await SetConfigValueAsync("frecuencia_respaldo", frecuenciaRespaldo.ToString(), "Respaldos");
            await SetConfigValueAsync("retencion_respaldos", retencionRespaldos.ToString(), "Respaldos");
            
            // SEGURIDAD
            await SetConfigValueAsync("tiempo_sesion", tiempoSesion.ToString(), "Seguridad");
            await SetConfigValueAsync("intentos_login_max", intentosLoginMax.ToString(), "Seguridad");
            await SetConfigValueAsync("tiempo_bloqueo", tiempoBloqueo.ToString(), "Seguridad");
            await SetConfigValueAsync("longitud_password", longitudPassword.ToString(), "Seguridad");
            await SetConfigValueAsync("requerir_mayusculas", requerirMayusculas, "Seguridad");
            await SetConfigValueAsync("requerir_numeros", requerirNumeros, "Seguridad");
            await SetConfigValueAsync("caducidad_password", caducidadPassword.ToString(), "Seguridad");
            await SetConfigValueAsync("auditar_operaciones", auditarOperaciones, "Seguridad");
            
            Logger.LogInformation("Configuracion guardada por usuario {User}", AuthService.CurrentUser?.Username);
            successMessage = "Configuracion guardada correctamente";
            
            await Task.Delay(2000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar configuracion");
            errorMessage = "Error al guardar configuracion: " + ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task CrearRespaldoManual()
    {
        try
        {
            isBackingUp = true;
            errorMessage = null;
            StateHasChanged();
            
            var nombreArchivo = $"respaldo_{DateTime.Now:yyyyMMdd_HHmmss}.db";
            var backupsPath = Path.Combine(Environment.ContentRootPath, "Backups");
            Directory.CreateDirectory(backupsPath);
            
            var dbPath = Path.Combine(Environment.ContentRootPath, "Data", "sgrrhh.db");
            var backupPath = Path.Combine(backupsPath, nombreArchivo);
            
            File.Copy(dbPath, backupPath, true);
            
            Logger.LogInformation("Respaldo manual creado: {File} por {User}", 
                nombreArchivo, AuthService.CurrentUser?.Username);
            
            ultimoBackup = DateTime.Now;
            await SetConfigValueAsync("ultimo_backup", ultimoBackup.Value.ToString("O"), "Sistema");
            
            successMessage = $"Respaldo creado: {nombreArchivo}";
            
            var bytes = await File.ReadAllBytesAsync(backupPath);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", nombreArchivo, base64);
            
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear respaldo");
            errorMessage = "Error al crear respaldo: " + ex.Message;
        }
        finally
        {
            isBackingUp = false;
            StateHasChanged();
        }
    }
    
    private void Salir()
    {
        Navigation.NavigateTo("/empleados");
    }
    
    private async Task<string> GetConfigValueAsync(string clave, string defaultValue = "")
    {
        try
        {
            var config = await ConfiguracionRepository.GetByClaveAsync(clave);
            return config?.Valor ?? defaultValue;
        }
        catch
        {
            return defaultValue;
        }
    }
    
    private async Task SetConfigValueAsync(string clave, string valor, string categoria)
    {
        try
        {
            var config = await ConfiguracionRepository.GetByClaveAsync(clave);
            
            if (config != null)
            {
                config.Valor = valor;
                config.Categoria = categoria;
                await ConfiguracionRepository.UpdateAsync(config);
            }
            else
            {
                config = new ConfiguracionSistema
                {
                    Clave = clave,
                    Valor = valor,
                    Categoria = categoria,
                    Activo = true
                };
                await ConfiguracionRepository.AddAsync(config);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar configuracion {Clave}", clave);
            throw;
        }
    }
}
