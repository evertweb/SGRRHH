@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject ICargoRepository CargoRepository
@inject IDepartamentoRepository DepartamentoRepository
@inject IConfiguracionLegalRepository ConfigLegalRepository
@inject ICatalogCacheService CatalogCache
@inject ILogger<CargosTab> Logger
@inject IJSRuntime JSRuntime

<!-- Toolbar -->
<div class="hospital-toolbar">
    <div class="hospital-toolbar-group">
        <button @onclick="Nuevo">NUEVO</button>
        <button @onclick="CargarDatos">ACTUALIZAR</button>
        @if (selectedItem != null)
        {
            <button @onclick="EditarSeleccionado">EDITAR</button>
            <button @onclick="() => ConfirmarEliminar(selectedItem)"
                    disabled="@((selectedItem.Empleados?.Count ?? 0) > 0)">
                ELIMINAR
            </button>
        }
    </div>
    <div class="hospital-toolbar-group">
        <input type="text" placeholder="BUSCAR..." 
               @bind="searchTerm" @bind:event="oninput" @bind:after="Filtrar" />
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <button @onclick="LimpiarBusqueda">LIMPIAR</button>
        }
        <select @bind="filtroDepartamento" @bind:after="Filtrar">
            <option value="">TODOS LOS DEPARTAMENTOS</option>
            @foreach (var dept in departamentos)
            {
                <option value="@dept.Id">@dept.Nombre</option>
            }
        </select>
    </div>
</div>

<!-- Tabla -->
<table class="hospital-table">
    <thead>
        <tr>
            <th>CÓDIGO</th>
            <th>NOMBRE DEL CARGO</th>
            <th>ÁREA/DEPARTAMENTO</th>
            <th class="text-center">NIVEL JERÁRQUICO</th>
            <th class="text-right">SALARIO BASE (COP)</th>
            <th class="text-center">PLAZAS OCUPADAS</th>
            <th>ACCIONES</th>
        </tr>
    </thead>
    <tbody>
        @if (isLoading)
        {
            <tr><td colspan="7" class="loading">CARGANDO CARGOS...</td></tr>
        }
        else if (!itemsFiltrados.Any())
        {
            <tr><td colspan="7" class="empty-state">NO HAY CARGOS REGISTRADOS</td></tr>
        }
        else
        {
            @foreach (var item in itemsFiltrados)
            {
                <tr class="@(selectedItem?.Id == item.Id ? "selected" : "")"
                    @onclick="() => SelectItem(item)">
                    <td><strong>@item.Codigo</strong></td>
                    <td>@item.Nombre</td>
                    <td>@(item.Departamento?.Nombre ?? "SIN ASIGNAR")</td>
                    <td class="text-center">@GetNivelDescripcion(item.Nivel)</td>
                    <td class="text-right" style="@(item.SalarioBase.HasValue && item.SalarioBase.Value < salarioMinimoVigente ? "color: #CC0000; font-weight: bold;" : "")">
                        @if (item.SalarioBase.HasValue)
                        {
                            @NumberFormatHelper.FormatearMoneda(item.SalarioBase)
                            @if (item.SalarioBase.Value < salarioMinimoVigente)
                            {
                                <span title="MENOR AL SMMLV"> ⚠</span>
                            }
                        }
                        else
                        {
                            <span>SIN DEFINIR</span>
                        }
                    </td>
                    <td class="text-center">@(item.Empleados?.Count ?? 0) / @item.NumeroPlazas</td>
                    <td class="table-actions">
                        <button @onclick="() => Editar(item)" @onclick:stopPropagation="true">
                            EDITAR
                        </button>
                        <button @onclick="() => ConfirmarEliminar(item)" @onclick:stopPropagation="true"
                                disabled="@((item.Empleados?.Count ?? 0) > 0)">
                            ELIMINAR
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Info SMMLV -->
<div style="margin-top: 10px; padding: 8px; background: #F0F0F0; border: 1px solid #CCC; font-size: 11px;">
    <strong>SMMLV 2026:</strong> @NumberFormatHelper.FormatearMoneda(salarioMinimoVigente) COP | 
    <strong>Auxilio de Transporte:</strong> @NumberFormatHelper.FormatearMoneda(auxilioTransporteVigente) COP
    (Aplica para salarios menores a 2 SMMLV)
</div>

<!-- Modal de edición -->
<FormModal @bind-IsVisible="showModal" 
           Title="@(isEditing ? $"EDITAR CARGO - {editItem?.Codigo}" : "NUEVO CARGO")"
           OnSaveClicked="Guardar"
           OnCancelClicked="CerrarModal"
           IsSaving="isSaving">
    
    @if (editItem != null)
    {
        <div class="hospital-grid-2">
            <div>
                <div class="hospital-form-group required">
                    <label>CÓDIGO DEL CARGO</label>
                    <input type="text" id="codigoInput" @bind="editItem.Codigo" maxlength="20" 
                           readonly="@isEditing" disabled="@isSaving" 
                           placeholder="Ej: CAR-001, GER-001" />
                    <small>IDENTIFICADOR ÚNICO DEL CARGO</small>
                </div>
                
                <div class="hospital-form-group required">
                    <label>NOMBRE DEL CARGO</label>
                    <input type="text" id="nombreInput" @bind="editItem.Nombre" maxlength="100" 
                           disabled="@isSaving" 
                           placeholder="Ej: Gerente General, Auxiliar Contable" />
                    <small>DENOMINACIÓN SEGÚN MANUAL DE FUNCIONES</small>
                </div>
                
                <div class="hospital-form-group">
                    <label>ÁREA / DEPARTAMENTO</label>
                    <select @bind="editItem.DepartamentoId" disabled="@isSaving">
                        <option value="">-- SELECCIONE ÁREA --</option>
                        @foreach (var dept in departamentos)
                        {
                            <option value="@dept.Id">@dept.Nombre</option>
                        }
                    </select>
                    <small>ÁREA ORGANIZACIONAL A LA QUE PERTENECE</small>
                </div>
                
                <div class="hospital-form-group">
                    <label>NIVEL JERÁRQUICO</label>
                    <select @bind="editItem.Nivel" disabled="@isSaving">
                        <option value="1">1 - OPERATIVO</option>
                        <option value="2">2 - TÉCNICO</option>
                        <option value="3">3 - PROFESIONAL</option>
                        <option value="4">4 - SUPERVISOR</option>
                        <option value="5">5 - GERENTE</option>
                    </select>
                    <small>ESCALA SALARIAL SEGÚN NIVEL</small>
                </div>
            </div>
            
            <div>
                <div class="hospital-form-group required">
                    <label>SALARIO BASE MENSUAL (COP)</label>
                    <InputMoneda @bind-Value="editItem.SalarioBase" 
                                 CssClass="form-input"
                                 Disabled="@isSaving" 
                                 Placeholder="@NumberFormatHelper.FormatearMonedaSinSimbolo(salarioMinimoVigente)" />
                    <small style="@(editItem.SalarioBase.HasValue && editItem.SalarioBase.Value < salarioMinimoVigente ? "color: #CC0000; font-weight: bold;" : "")">
                        SMMLV 2026: @NumberFormatHelper.FormatearMoneda(salarioMinimoVigente)
                        @if (editItem.SalarioBase.HasValue && editItem.SalarioBase.Value < salarioMinimoVigente)
                        {
                            <span> - ¡MENOR AL MÍNIMO LEGAL!</span>
                        }
                    </small>
                    <div style="margin-top: 5px;">
                        <button type="button" @onclick="AsignarSalarioMinimo" disabled="@isSaving" 
                                style="font-size: 10px; padding: 2px 8px;">
                            USAR SMMLV
                        </button>
                    </div>
                </div>
                
                <div class="hospital-form-group">
                    <label>NÚMERO DE PLAZAS</label>
                    <input type="number" @bind="editItem.NumeroPlazas" min="1" 
                           disabled="@isSaving" />
                    <small>VACANTES AUTORIZADAS PARA ESTE CARGO</small>
                </div>
                
                <div class="hospital-form-group">
                    <label>CARGO SUPERIOR (JEFE INMEDIATO)</label>
                    <select @bind="editItem.CargoSuperiorId" disabled="@isSaving">
                        <option value="">-- SIN JEFE DIRECTO --</option>
                        @foreach (var cargo in items.Where(c => c.Id != editItem.Id).OrderBy(c => c.Nombre))
                        {
                            <option value="@cargo.Id">@cargo.Nombre (@cargo.Codigo)</option>
                        }
                    </select>
                    <small>ESTRUCTURA JERÁRQUICA / ORGANIGRAMA</small>
                </div>
            </div>
        </div>
        
        <div class="hospital-form-group">
            <label>DESCRIPCIÓN DEL CARGO</label>
            <textarea @bind="editItem.Descripcion" rows="2" 
                     disabled="@isSaving" 
                     maxlength="500"
                     placeholder="Objetivo principal y funciones generales del cargo..."></textarea>
            <small>PROPÓSITO GENERAL SEGÚN MANUAL DE FUNCIONES</small>
        </div>
        
        <div class="hospital-form-group">
            <label>REQUISITOS MÍNIMOS</label>
            <textarea @bind="editItem.Requisitos" rows="3" 
                     disabled="@isSaving" 
                     maxlength="1000"
                     placeholder="Ej: Profesional en Contaduría Pública, 2 años de experiencia en cargos similares, Tarjeta profesional vigente..."></textarea>
            <small>FORMACIÓN ACADÉMICA, EXPERIENCIA, LICENCIAS (Res. 2346/2007)</small>
        </div>
        
        <div class="hospital-form-group">
            <label>COMPETENCIAS REQUERIDAS</label>
            <textarea @bind="editItem.Competencias" rows="2" 
                     disabled="@isSaving" 
                     maxlength="1000"
                     placeholder="Ej: Liderazgo, Trabajo en equipo, Manejo de Excel avanzado, SAP..."></textarea>
            <small>HABILIDADES TÉCNICAS Y BLANDAS</small>
        </div>
    }
</FormModal>

<!-- Modal de confirmación de eliminación -->
<FormModal @bind-IsVisible="showConfirmModal"
           Title="CONFIRMAR ELIMINACIÓN"
           OnSaveClicked="EliminarConfirmado"
           OnCancelClicked="() => showConfirmModal = false"
           IsSaving="isSaving">
    <div style="padding: 16px;">
        <p style="margin-bottom: 12px;">¿CONFIRMA LA ELIMINACIÓN DEL CARGO <strong>@itemToDelete?.Nombre</strong>?</p>
        <p style="color: #CC0000; font-weight: 600;">
            ADVERTENCIA: ESTA ACCIÓN NO SE PUEDE DESHACER.
        </p>
    </div>
</FormModal>

@code {
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public EventCallback<string?> ErrorMessageChanged { get; set; }
    [Parameter] public string? SuccessMessage { get; set; }
    [Parameter] public EventCallback<string?> SuccessMessageChanged { get; set; }
    
    private List<Cargo> items = new();
    private List<Cargo> itemsFiltrados = new();
    private List<Departamento> departamentos = new();
    private Cargo? selectedItem;
    private Cargo? editItem;
    private Cargo? itemToDelete;
    
    // Configuración legal Colombia
    private decimal salarioMinimoVigente = 1750905m; // SMMLV 2026
    private decimal auxilioTransporteVigente = 200000m; // Auxilio 2026
    
    private bool isLoading;
    private bool showModal;
    private bool showConfirmModal;
    private bool isSaving;
    private bool isEditing;
    private string searchTerm = "";
    private string filtroDepartamento = "";
    
    protected override async Task OnInitializedAsync()
    {
        await CargarConfiguracionLegal();
        await CargarDatos();
    }
    
    private async Task CargarConfiguracionLegal()
    {
        try
        {
            var configLegal = await ConfigLegalRepository.GetVigenteAsync();
            if (configLegal != null)
            {
                salarioMinimoVigente = configLegal.SalarioMinimoMensual;
                auxilioTransporteVigente = configLegal.AuxilioTransporte;
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "No se pudo cargar configuración legal, usando valores por defecto");
        }
    }
    
    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            var cargos = await CargoRepository.GetAllWithDepartamentoAsync();
            items = cargos.OrderBy(c => c.Nombre).ToList();
            
            var deps = await DepartamentoRepository.GetAllActiveAsync();
            departamentos = deps.OrderBy(d => d.Nombre).ToList();
            
            Filtrar();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar cargos");
            await SetError($"Error al cargar cargos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void Filtrar()
    {
        itemsFiltrados = items;
        
        if (!string.IsNullOrWhiteSpace(filtroDepartamento))
        {
            if (int.TryParse(filtroDepartamento, out int deptId))
            {
                itemsFiltrados = itemsFiltrados.Where(c => c.DepartamentoId == deptId).ToList();
            }
        }
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            itemsFiltrados = itemsFiltrados.Where(c => 
                c.Codigo.ToLower().Contains(term) ||
                c.Nombre.ToLower().Contains(term) ||
                (c.Descripcion ?? "").ToLower().Contains(term)
            ).ToList();
        }
        
        StateHasChanged();
    }
    
    private void LimpiarBusqueda()
    {
        searchTerm = "";
        Filtrar();
    }
    
    private void SelectItem(Cargo item)
    {
        selectedItem = item;
        StateHasChanged();
    }
    
    private void Nuevo()
    {
        editItem = new Cargo
        {
            Activo = true,
            Nivel = 1,
            NumeroPlazas = 1,
            SalarioBase = salarioMinimoVigente, // Pre-llenar con SMMLV
            FechaCreacion = DateTime.Now
        };
        isEditing = false;
        showModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// Asigna el salario mínimo vigente al cargo en edición
    /// </summary>
    private void AsignarSalarioMinimo()
    {
        if (editItem != null)
        {
            editItem.SalarioBase = salarioMinimoVigente;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// Obtiene descripción del nivel jerárquico
    /// </summary>
    private string GetNivelDescripcion(int nivel)
    {
        return nivel switch
        {
            1 => "1-OPERATIVO",
            2 => "2-TÉCNICO",
            3 => "3-PROFESIONAL",
            4 => "4-SUPERVISOR",
            5 => "5-GERENTE",
            _ => nivel.ToString()
        };
    }
    
    private void Editar(Cargo item)
    {
        editItem = new Cargo
        {
            Codigo = item.Codigo,
            Nombre = item.Nombre,
            Descripcion = item.Descripcion,
            Nivel = item.Nivel,
            DepartamentoId = item.DepartamentoId,
            SalarioBase = item.SalarioBase,
            Requisitos = item.Requisitos,
            Competencias = item.Competencias,
            CargoSuperiorId = item.CargoSuperiorId,
            NumeroPlazas = item.NumeroPlazas,
            Activo = item.Activo,
            FechaCreacion = item.FechaCreacion,
            FechaModificacion = DateTime.Now
        };
        // Guardar el Id original para actualización
        editItem.Id = item.Id;
        isEditing = true;
        showModal = true;
        StateHasChanged();
    }
    
    private void EditarSeleccionado()
    {
        if (selectedItem != null)
        {
            Editar(selectedItem);
        }
    }
    
    private async Task Guardar()
    {
        if (editItem == null) return;
        
        // Limpiar errores previos
        await JSRuntime.InvokeVoidAsync("clearAllFieldErrors");
        
        // Validaciones
        if (string.IsNullOrWhiteSpace(editItem.Codigo))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", "EL CÓDIGO ES REQUERIDO");
            return;
        }
        
        if (string.IsNullOrWhiteSpace(editItem.Nombre))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "nombreInput", "EL NOMBRE ES REQUERIDO");
            return;
        }
        
        // Validar código duplicado
        if (await CargoRepository.ExistsCodigoAsync(editItem.Codigo, isEditing ? editItem.Id : null))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", $"YA EXISTE UN CARGO CON EL CÓDIGO '{editItem.Codigo}'");
            return;
        }
        
        // Validar relación circular en cargo superior
        if (editItem.CargoSuperiorId.HasValue)
        {
            if (editItem.CargoSuperiorId == editItem.Id)
            {
                await SetError("UN CARGO NO PUEDE SER SU PROPIO SUPERIOR");
                return;
            }
            
            // Verificar que no se cree una cadena circular
            var superiorId = editItem.CargoSuperiorId;
            var visitados = new HashSet<int> { editItem.Id };
            while (superiorId.HasValue)
            {
                if (visitados.Contains(superiorId.Value))
                {
                    await SetError("NO SE PUEDE CREAR UNA JERARQUÍA CIRCULAR DE CARGOS");
                    return;
                }
                visitados.Add(superiorId.Value);
                var cargoSuperior = items.FirstOrDefault(c => c.Id == superiorId.Value);
                superiorId = cargoSuperior?.CargoSuperiorId;
            }
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            if (isEditing)
            {
                await CargoRepository.UpdateAsync(editItem);
                
                // Actualizar el item en la lista local sin recargar todo
                var itemIndex = items.FindIndex(c => c.Id == editItem.Id);
                if (itemIndex >= 0)
                {
                    // Recargar el item con su departamento
                    var reloaded = await CargoRepository.GetByIdWithDepartamentoAsync(editItem.Id);
                    if (reloaded != null)
                    {
                        items[itemIndex] = reloaded;
                    }
                }
                
                await SetSuccess($"Cargo '{editItem.Nombre}' actualizado correctamente");
                Logger.LogInformation($"Cargo actualizado: {editItem.Codigo}");
            }
            else
            {
                var newCargo = await CargoRepository.AddAsync(editItem);
                
                // Recargar el nuevo item con su departamento y agregarlo a la lista
                var reloaded = await CargoRepository.GetByIdWithDepartamentoAsync(newCargo.Id);
                if (reloaded != null)
                {
                    items.Add(reloaded);
                    items = items.OrderBy(c => c.Nombre).ToList();
                }
                
                await SetSuccess($"Cargo '{editItem.Nombre}' creado correctamente");
                Logger.LogInformation($"Cargo creado: {editItem.Codigo}");
            }
            
            // CRÍTICO: Invalidar caché para que otros componentes vean los cambios
            CatalogCache.InvalidateCache(CatalogType.Cargos);
            
            // Refiltrar la lista con los datos actualizados
            Filtrar();
            CerrarModal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar cargo");
            await SetError($"Error al guardar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void ConfirmarEliminar(Cargo item)
    {
        if ((item.Empleados?.Count ?? 0) > 0)
        {
            SetError($"No se puede eliminar el cargo porque tiene {item.Empleados!.Count} empleado(s) asignado(s)");
            return;
        }
        
        itemToDelete = item;
        showConfirmModal = true;
        StateHasChanged();
    }
    
    private async Task EliminarConfirmado()
    {
        if (itemToDelete == null) return;
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            await CargoRepository.DeleteAsync(itemToDelete.Id);
            
            // Remover el item de la lista local sin recargar todo
            items.RemoveAll(c => c.Id == itemToDelete.Id);
            
            // CRÍTICO: Invalidar caché para que otros componentes vean los cambios
            CatalogCache.InvalidateCache(CatalogType.Cargos);
            
            await SetSuccess($"Cargo '{itemToDelete.Nombre}' eliminado correctamente");
            Logger.LogInformation($"Cargo eliminado: {itemToDelete.Codigo}");
            
            // Refiltrar la lista
            Filtrar();
            showConfirmModal = false;
            itemToDelete = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar cargo");
            await SetError($"Error al eliminar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void CerrarModal()
    {
        showModal = false;
        editItem = null;
        StateHasChanged();
    }
    
    private async Task SetError(string message)
    {
        ErrorMessage = message;
        await ErrorMessageChanged.InvokeAsync(message);
    }
    
    private async Task SetSuccess(string message)
    {
        SuccessMessage = message;
        await SuccessMessageChanged.InvokeAsync(message);
        
        await Task.Delay(3000);
        if (SuccessMessage == message)
        {
            SuccessMessage = null;
            await SuccessMessageChanged.InvokeAsync(null);
        }
    }
}
