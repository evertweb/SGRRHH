@page "/vacaciones"
@page "/vacaciones/{VacacionIdParam:int?}"
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@inject IAuthService AuthService
@inject IVacacionRepository VacacionRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject NavigationManager Navigation
@inject ILogger<Vacaciones> Logger
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
<PageTitle>Vacaciones - SGRRHH</PageTitle>

<div class="vacacion-container">
    <!-- CABECERA -->
    <div class="vacacion-header">
        <h1 class="vacacion-title">SISTEMA DE GESTION DE VACACIONES</h1>
        <div class="vacacion-info">
            USUARIO: @(AuthService.CurrentUser?.NombreCompleto ?? "N/A") | 
            ROL: @(AuthService.IsAprobador ? "APROBADOR" : "OPERADOR") | 
            FECHA: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>
    
    <!-- ERRORES -->
    @if (errorMessage != null)
    {
        <div class="error-box">
            <h3 class="error-title">ERROR DEL SISTEMA</h3>
            <p class="error-text">@errorMessage</p>
            <button class="btn" @onclick="() => errorMessage = null">ACEPTAR</button>
        </div>
    }
    
    <!-- CONFIRMACIONES -->
    @if (successMessage != null)
    {
        <div class="success-box">
            @successMessage
        </div>
    }
    
    <!-- TECLAS DE FUNCIÓN -->
    <div class="teclas-funcion">
        <span class="tecla">F2=BUSCAR</span>
        <span class="tecla">F3=NUEVO</span>
        <span class="tecla">F4=DETALLE</span>
        <span class="tecla">F5=ACTUALIZAR</span>
        @if (AuthService.IsAprobador)
        {
            <span class="tecla">F6=APROBAR</span>
            <span class="tecla">F7=RECHAZAR</span>
        }
        <span class="tecla">ESC=CERRAR</span>
        <span class="tecla">TAB=NAVEGAR</span>
    </div>
    
    <!-- CONTROLES PRINCIPALES -->
    <div class="controles-principales">
        <button class="btn" @onclick="NuevaVacacion">NUEVO</button>
        <button class="btn" @onclick="CargarVacaciones">ACTUALIZAR</button>
        <button class="btn" @onclick="EditarSeleccionado" disabled="@(selectedVacacion == null)">VER DETALLE</button>
        @if (AuthService.IsAprobador)
        {
            <button class="btn btn-aprobar" @onclick="AprobarSeleccionado" 
                    disabled="@(selectedVacacion?.Estado != EstadoVacacion.Pendiente)">
                APROBAR
            </button>
            <button class="btn btn-rechazar" @onclick="RechazarSeleccionado" 
                    disabled="@(selectedVacacion?.Estado != EstadoVacacion.Pendiente)">
                RECHAZAR
            </button>
        }
    </div>
    
    <!-- FILTROS -->
    <div class="controles-filtros">
        <div class="filtro-grupo">
            <label class="filtro-label">BUSCAR:</label>
            <input type="text" id="searchInput" class="input-text vac-filter-wide"
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
            <button class="btn" @onclick="Buscar">BUSCAR</button>
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="btn" @onclick="LimpiarBusqueda">LIMPIAR</button>
            }
        </div>
        
        <div class="filtro-grupo">
            <label class="filtro-label">ESTADO:</label>
            <select class="select vac-filter-estado" @bind="filtroEstado" @bind:after="Filtrar">
                <option value="">TODOS</option>
                <option value="@((int)EstadoVacacion.Pendiente)">PENDIENTE</option>
                <option value="@((int)EstadoVacacion.Aprobada)">APROBADA</option>
                <option value="@((int)EstadoVacacion.Rechazada)">RECHAZADA</option>
                <option value="@((int)EstadoVacacion.Programada)">PROGRAMADA</option>
                <option value="@((int)EstadoVacacion.Disfrutada)">DISFRUTADA</option>
                <option value="@((int)EstadoVacacion.Cancelada)">CANCELADA</option>
            </select>
        </div>
        
        <div class="filtro-grupo">
            <label class="filtro-label">EMPLEADO:</label>
            <select class="select vac-filter-empleado" @bind="filtroEmpleadoId" @bind:after="Filtrar">
                <option value="">TODOS</option>
                @foreach (var emp in todosEmpleados)
                {
                    <option value="@emp.Id">@emp.NombreCompleto</option>
                }
            </select>
        </div>
        
        <div class="filtro-grupo">
            <label class="filtro-label">PERIODO:</label>
            <select class="select vac-filter-periodo" @bind="filtroPeriodo" @bind:after="Filtrar">
                <option value="">TODOS</option>
                @for (int year = DateTime.Now.Year; year >= DateTime.Now.Year - 5; year--)
                {
                    <option value="@year">@year</option>
                }
            </select>
        </div>
    </div>
    
    <!-- INFORMACIÓN DE RESULTADOS -->
    <div class="info-resultados">
        REGISTROS: @vacaciones.Count() DE @totalVacaciones
        @if (AuthService.IsAprobador && vacacionesPendientes > 0)
        {
            <span class="info-pendientes">PENDIENTES DE APROBACION: @vacacionesPendientes</span>
        }
    </div>
    
    <!-- CONTENIDO PRINCIPAL CON PANEL LATERAL -->
    <div class="contenido-principal">
        <!-- TABLA DE VACACIONES -->
        <div>
            <table class="tabla-vacaciones">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>EMPLEADO</th>
                        <th>CEDULA</th>
                        <th>PERIODO</th>
                        <th>FECHA INICIO</th>
                        <th>FECHA FIN</th>
                        <th>DIAS</th>
                        <th>ESTADO</th>
                        <th>FECHA SOLICITUD</th>
                        <th>SOLICITADO POR</th>
                        <th>APROBADO POR</th>
                        <th>F. APROBACION</th>
                    </tr>
                </thead>
                <tbody>
                    @if (isLoading)
                    {
                        <tr><td colspan="12" class="loading-cell">CARGANDO DATOS...</td></tr>
                    }
                    else if (!vacaciones.Any())
                    {
                        <tr><td colspan="12" class="empty-cell">NO HAY REGISTROS PARA MOSTRAR</td></tr>
                    }
                    else
                    {
                        @foreach (var vac in vacaciones)
                        {
                            <tr class="@(selectedVacacion?.Id == vac.Id ? "fila-seleccionada" : "")"
                                @onclick="() => SelectVacacion(vac)">
                                <td class="td-centro">@vac.Id</td>
                                <td>@(vac.Empleado?.NombreCompleto ?? "N/A")</td>
                                <td>@(vac.Empleado?.Cedula ?? "N/A")</td>
                                <td class="td-centro">@vac.PeriodoCorrespondiente</td>
                                <td>@vac.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@vac.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td class="td-centro">@vac.DiasTomados</td>
                                <td>
                                    <span class="estado-@(vac.Estado.ToString().ToLower())">
                                        @GetEstadoTexto(vac.Estado)
                                    </span>
                                </td>
                                <td>@vac.FechaSolicitud.ToString("dd/MM/yyyy")</td>
                                <td>@(vac.SolicitadoPor?.NombreCompleto ?? "N/A")</td>
                                <td>@(vac.AprobadoPor?.NombreCompleto ?? "N/A")</td>
                                <td>@(vac.FechaAprobacion?.ToString("dd/MM/yyyy") ?? "-")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        
        <!-- PANEL LATERAL -->
        <div class="panel-lateral">
            <div class="panel-titulo">RESUMEN TEXTUAL</div>
            
            @if (!string.IsNullOrEmpty(filtroEmpleadoId) && int.TryParse(filtroEmpleadoId, out int empId) && empId > 0 && resumenVacaciones != null)
            {
                <div class="panel-seccion">
                    <span class="panel-label">EMPLEADO:</span>
                    <span class="panel-valor">@resumenVacaciones.NombreEmpleado</span>
                    
                    <span class="panel-label">CEDULA:</span>
                    <span class="panel-valor">@resumenVacaciones.CedulaEmpleado</span>
                </div>
                
                <div class="panel-seccion">
                    <span class="panel-label">DIAS DISPONIBLES:</span>
                    <span class="panel-valor">@resumenVacaciones.TotalDiasDisponibles</span>
                    
                    <span class="panel-label">DIAS USADOS:</span>
                    <span class="panel-valor">@resumenVacaciones.DiasUsados</span>
                    
                    <span class="panel-label">DIAS RESTANTES:</span>
                    <span class="panel-valor">@resumenVacaciones.DiasRestantes</span>
                </div>
                
                <div class="panel-seccion">
                    <span class="panel-label">ANTIGÜEDAD:</span>
                    <span class="panel-valor">@resumenVacaciones.AntiguedadAnios AÑOS</span>
                    
                    <span class="panel-label">PERIODO ACTUAL:</span>
                    <span class="panel-valor">@DateTime.Now.Year</span>
                </div>
                
                @if (resumenVacaciones.UltimaVacacion != null)
                {
                    <div class="panel-seccion">
                        <span class="panel-label">ULTIMA VACACION:</span>
                        <span class="panel-valor">
                            @resumenVacaciones.UltimaVacacion.FechaInicio.ToString("dd/MM/yyyy") - 
                            @resumenVacaciones.UltimaVacacion.FechaFin.ToString("dd/MM/yyyy")
                        </span>
                        <span class="panel-valor">@resumenVacaciones.UltimaVacacion.DiasTomados DIAS</span>
                    </div>
                }
                
                <div class="panel-aviso">
                    NOTA: Los calculos se basan en 15 dias base mas 1 dia adicional cada 5 años de antigüedad.
                </div>
            }
            else
            {
                <div class="empty-cell">
                    SELECCIONE UN EMPLEADO EN LOS FILTROS PARA VER EL RESUMEN
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL -->
@if (showModal)
{
    <div class="modal-overlay vacaciones-modal" @onclick="CerrarModal">
        <div class="modal-box vacaciones-modal-box" @onclick:stopPropagation="true">
            <div class="modal-header">
                @if (isEditing)
                {
                    <text>DETALLE DE VACACION - @(vacacionEdit.Empleado?.NombreCompleto ?? "")</text>
                }
                else
                {
                    <text>NUEVA SOLICITUD DE VACACION</text>
                }
            </div>
            
            <div class="modal-body">
                <div class="formulario-grid">
                    <!-- COLUMNA IZQUIERDA -->
                    <div>
                        <div class="formulario-seccion">
                            <div class="seccion-titulo">DATOS PRINCIPALES</div>
                            
                            <div class="campo-form">
                                <label class="campo-label campo-requerido">EMPLEADO</label>
                                @if (isEditing || isViewing)
                                {
                                    <input type="text" class="campo-input" 
                                           value="@(vacacionEdit.Empleado?.NombreCompleto ?? "")" disabled />
                                }
                                else
                                {
                                    <select class="campo-input" @bind="vacacionEdit.EmpleadoId" @bind:after="OnEmpleadoChanged">
                                        <option value="0">SELECCIONE EMPLEADO</option>
                                        @foreach (var emp in empleadosActivos)
                                        {
                                            <option value="@emp.Id">@emp.NombreCompleto - @NumberFormatHelper.FormatearCedula(emp.Cedula)</option>
                                        }
                                    </select>
                                }
                            </div>
                            
                            @if (vacacionEdit.EmpleadoId > 0 && diasDisponibles.HasValue)
                            {
                                <div class="alerta-dias @(diasDisponibles.Value > 0 ? "alerta-dias-suficiente" : "alerta-dias-insuficiente")">
                                    <div class="alerta-dias-titulo">DIAS DISPONIBLES EN @DateTime.Now.Year</div>
                                    <div class="alerta-dias-valor">@diasDisponibles.Value DIAS</div>
                                    @if (diasDisponibles.Value <= 0)
                                    {
                                        <div class="alerta-dias-advertencia">
                                            NO HAY DIAS DE VACACIONES DISPONIBLES PARA ESTE AÑO
                                        </div>
                                    }
                                </div>
                            }
                            
                            <div class="campo-form">
                                <label class="campo-label campo-requerido">PERIODO CORRESPONDIENTE</label>
                                <input type="number" class="campo-input" 
                                       @bind="vacacionEdit.PeriodoCorrespondiente" 
                                       disabled="@isViewing"
                                       min="@(DateTime.Now.Year - 10)" 
                                       max="@DateTime.Now.Year" />
                                <div class="campo-ayuda">Año al que corresponden estas vacaciones</div>
                            </div>
                            
                            <div class="campo-form">
                                <label class="campo-label campo-requerido">FECHA INICIO</label>
                                <input type="date" class="campo-input" 
                                       @bind="vacacionEdit.FechaInicio" 
                                       @bind:after="CalcularDias"
                                       disabled="@isViewing" />
                            </div>
                            
                            <div class="campo-form">
                                <label class="campo-label campo-requerido">FECHA FIN</label>
                                <input type="date" class="campo-input" 
                                       @bind="vacacionEdit.FechaFin" 
                                       @bind:after="CalcularDias"
                                       disabled="@isViewing" />
                            </div>
                            
                            <div class="campo-form">
                                <label class="campo-label">DIAS A TOMAR</label>
                                <input type="number" class="campo-input" 
                                       @bind="vacacionEdit.DiasTomados" disabled />
                                <div class="campo-ayuda">Calculado automaticamente (dias habiles)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- COLUMNA DERECHA -->
                    <div>
                        <div class="formulario-seccion">
                            <div class="seccion-titulo">INFORMACION ADICIONAL</div>
                            
                            <div class="campo-form">
                                <label class="campo-label">OBSERVACIONES</label>
                                <textarea class="campo-textarea" rows="4"
                                          @bind="vacacionEdit.Observaciones"
                                          disabled="@isViewing"></textarea>
                            </div>
                            
                            @if (isEditing || isViewing)
                            {
                                <div class="campo-form">
                                    <label class="campo-label">ESTADO</label>
                                    <div>
                                        <span class="estado-@(vacacionEdit.Estado.ToString().ToLower())">
                                            @GetEstadoTexto(vacacionEdit.Estado)
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="campo-form">
                                    <label class="campo-label">FECHA SOLICITUD</label>
                                    <input type="text" class="campo-input" 
                                           value="@vacacionEdit.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")" disabled />
                                </div>
                                
                                <div class="campo-form">
                                    <label class="campo-label">SOLICITADO POR</label>
                                    <input type="text" class="campo-input" 
                                           value="@(vacacionEdit.SolicitadoPor?.NombreCompleto ?? "N/A")" disabled />
                                </div>
                                
                                @if (vacacionEdit.AprobadoPor != null)
                                {
                                    <div class="campo-form">
                                        <label class="campo-label">@(vacacionEdit.Estado == EstadoVacacion.Aprobada ? "APROBADO POR" : "RECHAZADO POR")</label>
                                        <input type="text" class="campo-input" 
                                               value="@vacacionEdit.AprobadoPor.NombreCompleto" disabled />
                                    </div>
                                    
                                    <div class="campo-form">
                                        <label class="campo-label">FECHA @(vacacionEdit.Estado == EstadoVacacion.Aprobada ? "APROBACION" : "RECHAZO")</label>
                                        <input type="text" class="campo-input" 
                                               value="@vacacionEdit.FechaAprobacion?.ToString("dd/MM/yyyy HH:mm")" disabled />
                                    </div>
                                }
                                
                                @if (!string.IsNullOrEmpty(vacacionEdit.MotivoRechazo))
                                {
                                    <div class="campo-form">
                                        <label class="campo-label">MOTIVO RECHAZO</label>
                                        <textarea class="campo-textarea" rows="3" 
                                                  value="@vacacionEdit.MotivoRechazo" disabled></textarea>
                                    </div>
                                }
                            }
                        </div>
                        
                        <!-- HISTORIAL -->
                        @if (isEditing || isViewing)
                        {
                            @if (historialVacaciones.Any())
                            {
                                <div class="historial-box">
                                    <div class="historial-titulo">HISTORIAL DE VACACIONES</div>
                                    @foreach (var hist in historialVacaciones.OrderByDescending(v => v.FechaInicio))
                                    {
                                        <div class="historial-item">
                                            <strong>@hist.PeriodoCorrespondiente:</strong> 
                                            @hist.FechaInicio.ToString("dd/MM/yyyy") - @hist.FechaFin.ToString("dd/MM/yyyy")
                                            (@hist.DiasTomados DIAS) - @hist.Estado
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
                
                <!-- BLOQUE APROBACION -->
                @if ((isEditing || isViewing) && selectedVacacion?.Estado == EstadoVacacion.Pendiente && AuthService.IsAprobador)
                {
                    <div class="bloque-aprobacion">
                        <div class="bloque-aprobacion-titulo">ACCIONES DE APROBACION</div>
                        <div class="bloque-aprobacion-botones">
                            <button class="btn btn-aprobar" @onclick="AprobarVacacion">
                                APROBAR VACACION
                            </button>
                            <button class="btn btn-rechazar" @onclick="() => showRechazarDialog = true">
                                RECHAZAR VACACION
                            </button>
                        </div>
                    </div>
                }
            </div>
            
            <div class="modal-footer">
                <button class="btn" @onclick="CerrarModal">CANCELAR</button>
                @if (!isViewing)
                {
                    <button class="btn" @onclick="Guardar" disabled="@isSaving">
                        @(isSaving ? "GUARDANDO..." : "GUARDAR")
                    </button>
                }
            </div>
        </div>
    </div>
}

<!-- DIALOGO RECHAZO -->
@if (showRechazarDialog)
{
    <div class="modal-overlay" @onclick="() => showRechazarDialog = false">
        <div class="dialogo-confirmacion" @onclick:stopPropagation="true">
            <div class="dialogo-titulo">RECHAZAR VACACION</div>
            
            <div class="dialogo-contenido">
                <div class="campo-form">
                    <label class="campo-label campo-requerido">MOTIVO DEL RECHAZO</label>
                    <textarea class="campo-textarea" rows="4" 
                              @bind="motivoRechazo"></textarea>
                    <div class="campo-ayuda">Explique por que se rechaza esta solicitud</div>
                </div>
            </div>
            
            <div class="dialogo-botones">
                <button class="btn" @onclick="() => showRechazarDialog = false">CANCELAR</button>
                <button class="btn btn-rechazar" @onclick="ConfirmarRechazo" 
                        disabled="@(string.IsNullOrWhiteSpace(motivoRechazo))">
                    CONFIRMAR RECHAZO
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? VacacionIdParam { get; set; }
    
    // Estado de UI
    private bool isLoading = true;
    private bool showModal = false;
    private bool isSaving = false;
    private bool isEditing = false;
    private bool isViewing = false;
    private bool showRechazarDialog = false;
    private string? errorMessage;
    private string? successMessage;
    
    // Datos
    private List<Vacacion> vacaciones = new();
    private List<Vacacion> todasLasVacaciones = new();
    private List<Empleado> todosEmpleados = new();
    private List<Empleado> empleadosActivos = new();
    private List<Vacacion> historialVacaciones = new();
    private ResumenVacaciones? resumenVacaciones;
    
    // Selección y edición
    private Vacacion? selectedVacacion;
    private Vacacion vacacionEdit = new();
    private int? diasDisponibles;
    
    // Filtros
    private string searchTerm = "";
    private string filtroEstado = "";
    private string filtroEmpleadoId = "";
    private string filtroPeriodo = "";
    
    // Estadísticas
    private int totalVacaciones;
    private int vacacionesPendientes;
    
    // Rechazo
    private string motivoRechazo = "";
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        await CargarDatosIniciales();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (VacacionIdParam.HasValue && VacacionIdParam.Value > 0)
        {
            await CargarVacacionParam();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("connectDataSync", dotNetRef);
                Logger.LogInformation("[Vacaciones] Conectado a SignalR Hub");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "[Vacaciones] Error conectando a SignalR Hub");
            }
        }
    }
    
    [JSInvokable]
    public async Task OnDataChanged(string entityType, string changeType, int? entityId)
    {
        if (entityType == "Empleado")
        {
            Logger.LogInformation("[Vacaciones] Empleado modificado, recargando lista");
            var empleados = await EmpleadoRepository.GetAllAsync();
            todosEmpleados = empleados.OrderBy(e => e.NombreCompleto).ToList();
            empleadosActivos = todosEmpleados.Where(e => e.Estado == EstadoEmpleado.Activo).ToList();
            await InvokeAsync(StateHasChanged);
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("disconnectDataSync");
            Logger.LogInformation("[Vacaciones] Desconectado de SignalR Hub");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "[Vacaciones] Error desconectando de SignalR Hub");
        }
    }
    
    private async Task CargarDatosIniciales()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Cargar empleados
            var empleados = await EmpleadoRepository.GetAllAsync();
            todosEmpleados = empleados.OrderBy(e => e.NombreCompleto).ToList();
            empleadosActivos = todosEmpleados
                .Where(e => e.Estado == EstadoEmpleado.Activo)
                .ToList();
            
            // Cargar vacaciones
            await CargarVacaciones();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos iniciales");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarVacaciones()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            var todasVacaciones = await VacacionRepository.GetAllAsync();
            todasLasVacaciones = todasVacaciones.OrderByDescending(v => v.FechaSolicitud).ToList();
            
            // Aplicar filtros
            await AplicarFiltros();
            
            // Calcular estadísticas
            totalVacaciones = todasLasVacaciones.Count;
            vacacionesPendientes = todasLasVacaciones.Count(v => v.Estado == EstadoVacacion.Pendiente);
            
            Logger.LogInformation($"Cargadas {totalVacaciones} vacaciones ({vacacionesPendientes} pendientes)");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vacaciones");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarVacacionParam()
    {
        try
        {
            var vacacion = await VacacionRepository.GetByIdAsync(VacacionIdParam!.Value);
            if (vacacion != null)
            {
                await VerDetalle(vacacion);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al cargar vacación {VacacionIdParam}");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
    }
    
    private async Task AplicarFiltros()
    {
        var resultado = todasLasVacaciones.AsEnumerable();
        
        // Filtro por búsqueda
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var searchLower = searchTerm.ToLower();
            resultado = resultado.Where(v =>
                (v.Empleado?.NombreCompleto?.ToLower().Contains(searchLower) ?? false) ||
                (v.Empleado?.Cedula?.Contains(searchTerm) ?? false) ||
                v.PeriodoCorrespondiente.ToString().Contains(searchTerm) ||
                (v.Observaciones?.ToLower().Contains(searchLower) ?? false)
            );
        }
        
        // Filtro por estado
        if (!string.IsNullOrEmpty(filtroEstado) && int.TryParse(filtroEstado, out int estadoId))
        {
            resultado = resultado.Where(v => (int)v.Estado == estadoId);
        }
        
        // Filtro por empleado
        if (!string.IsNullOrEmpty(filtroEmpleadoId) && int.TryParse(filtroEmpleadoId, out int empleadoId))
        {
            resultado = resultado.Where(v => v.EmpleadoId == empleadoId);
        }
        
        // Filtro por período
        if (!string.IsNullOrEmpty(filtroPeriodo) && int.TryParse(filtroPeriodo, out int periodo))
        {
            resultado = resultado.Where(v => v.PeriodoCorrespondiente == periodo);
        }
        
        vacaciones = resultado.ToList();
    }
    
    private async Task Buscar()
    {
        await AplicarFiltros();
    }
    
    private async Task Filtrar()
    {
        await AplicarFiltros();
        
        // Cargar resumen de vacaciones si hay empleado seleccionado
        if (!string.IsNullOrEmpty(filtroEmpleadoId) && int.TryParse(filtroEmpleadoId, out int empleadoId) && empleadoId > 0)
        {
            await CargarResumenVacaciones(empleadoId);
        }
        else
        {
            resumenVacaciones = null;
        }
    }
    
    private async Task LimpiarBusqueda()
    {
        searchTerm = "";
        await AplicarFiltros();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("focusElement", "searchInput");
    }
    
    private async Task FocusBusqueda()
    {
        await JSRuntime.InvokeVoidAsync("focusElement", "searchInput");
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Buscar();
        }
    }
    
    // ===== CRUD Operations =====
    
    private Task NuevaVacacion()
    {
        vacacionEdit = new Vacacion
        {
            FechaSolicitud = DateTime.Now,
            PeriodoCorrespondiente = DateTime.Now.Year,
            Estado = EstadoVacacion.Pendiente,
            FechaInicio = DateTime.Today,
            FechaFin = DateTime.Today.AddDays(14)
        };
        isEditing = false;
        isViewing = false;
        showModal = true;
        diasDisponibles = null;
        historialVacaciones.Clear();
        return Task.CompletedTask;
    }
    
    private async Task VerDetalle(Vacacion vacacion)
    {
        selectedVacacion = vacacion;
        vacacionEdit = new Vacacion
        {
            Id = vacacion.Id,
            EmpleadoId = vacacion.EmpleadoId,
            Empleado = vacacion.Empleado,
            FechaInicio = vacacion.FechaInicio,
            FechaFin = vacacion.FechaFin,
            DiasTomados = vacacion.DiasTomados,
            PeriodoCorrespondiente = vacacion.PeriodoCorrespondiente,
            Estado = vacacion.Estado,
            Observaciones = vacacion.Observaciones,
            FechaSolicitud = vacacion.FechaSolicitud,
            SolicitadoPorId = vacacion.SolicitadoPorId,
            SolicitadoPor = vacacion.SolicitadoPor,
            AprobadoPorId = vacacion.AprobadoPorId,
            AprobadoPor = vacacion.AprobadoPor,
            FechaAprobacion = vacacion.FechaAprobacion,
            MotivoRechazo = vacacion.MotivoRechazo
        };
        
        isEditing = true;
        isViewing = true;
        showModal = true;
        
        // Cargar historial
        await CargarHistorialVacaciones(vacacion.EmpleadoId);
        
        // Calcular días disponibles
        await CalcularDiasDisponibles(vacacion.EmpleadoId, vacacion.PeriodoCorrespondiente);
    }
    
    private async Task EditarVacacion(Vacacion vacacion)
    {
        selectedVacacion = vacacion;
        // No copiar Id manualmente - se asigna después para evitar antipatrón
        vacacionEdit = new Vacacion
        {
            EmpleadoId = vacacion.EmpleadoId,
            Empleado = vacacion.Empleado,
            FechaInicio = vacacion.FechaInicio,
            FechaFin = vacacion.FechaFin,
            DiasTomados = vacacion.DiasTomados,
            PeriodoCorrespondiente = vacacion.PeriodoCorrespondiente,
            Estado = vacacion.Estado,
            Observaciones = vacacion.Observaciones,
            FechaSolicitud = vacacion.FechaSolicitud,
            SolicitadoPorId = vacacion.SolicitadoPorId,
            SolicitadoPor = vacacion.SolicitadoPor,
            AprobadoPorId = vacacion.AprobadoPorId,
            AprobadoPor = vacacion.AprobadoPor,
            FechaAprobacion = vacacion.FechaAprobacion,
            MotivoRechazo = vacacion.MotivoRechazo
        };
        vacacionEdit.Id = vacacion.Id;
        
        isEditing = true;
        isViewing = false;
        showModal = true;
        
        // Cargar historial
        await CargarHistorialVacaciones(vacacion.EmpleadoId);
        
        // Calcular días disponibles
        await CalcularDiasDisponibles(vacacion.EmpleadoId, vacacion.PeriodoCorrespondiente);
    }
    
    private void SelectVacacion(Vacacion vacacion)
    {
        selectedVacacion = vacacion;
        StateHasChanged();
    }
    
    private async Task EditarSeleccionado()
    {
        if (selectedVacacion != null)
        {
            await VerDetalle(selectedVacacion);
        }
    }
    
    private async Task Guardar()
    {
        try
        {
            // Validaciones
            if (vacacionEdit.EmpleadoId <= 0)
            {
                errorMessage = "Debe seleccionar un empleado";
                return;
            }
            
            if (vacacionEdit.FechaFin < vacacionEdit.FechaInicio)
            {
                errorMessage = "La fecha fin no puede ser anterior a la fecha inicio";
                return;
            }
            
            if (vacacionEdit.DiasTomados <= 0)
            {
                errorMessage = "Debe especificar al menos 1 día de vacaciones";
                return;
            }
            
            // Verificar días disponibles
            await CalcularDiasDisponibles(vacacionEdit.EmpleadoId, vacacionEdit.PeriodoCorrespondiente);
            if (diasDisponibles.HasValue && diasDisponibles.Value < vacacionEdit.DiasTomados)
            {
                errorMessage = $"El empleado solo tiene {diasDisponibles.Value} días disponibles. No se pueden solicitar {vacacionEdit.DiasTomados} días.";
                return;
            }
            
            // Verificar traslape de fechas
            var existeTraslape = await VacacionRepository.ExisteTraslapeAsync(
                vacacionEdit.EmpleadoId,
                vacacionEdit.FechaInicio,
                vacacionEdit.FechaFin,
                vacacionEdit.Id > 0 ? vacacionEdit.Id : null
            );
            
            if (existeTraslape)
            {
                errorMessage = "Ya existe otra solicitud de vacación con fechas traslapadas para este empleado";
                return;
            }
            
            isSaving = true;
            StateHasChanged();
            
            // Asignar usuario que solicita
            if (vacacionEdit.Id == 0)
            {
                vacacionEdit.SolicitadoPorId = AuthService.CurrentUser!.Id;
                vacacionEdit.FechaSolicitud = DateTime.Now;
            }
            
            if (vacacionEdit.Id == 0)
            {
                // Crear nueva
                await VacacionRepository.AddAsync(vacacionEdit);
                successMessage = "Solicitud de vacación creada exitosamente";
                Logger.LogInformation($"Nueva vacación creada: Empleado {vacacionEdit.EmpleadoId}, Período {vacacionEdit.PeriodoCorrespondiente}");
            }
            else
            {
                // Actualizar existente
                await VacacionRepository.UpdateAsync(vacacionEdit);
                successMessage = "Vacación actualizada exitosamente";
                Logger.LogInformation($"Vacación actualizada: ID {vacacionEdit.Id}");
            }
            
            await CargarVacaciones();
            CerrarModal();
            
            // Limpiar mensaje después de 3 segundos
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar vacación");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModal()
    {
        showModal = false;
        vacacionEdit = new Vacacion();
        selectedVacacion = null;
        isEditing = false;
        isViewing = false;
        diasDisponibles = null;
        historialVacaciones.Clear();
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    // ===== Aprobación/Rechazo =====
    
    private async Task AprobarSeleccionado()
    {
        if (selectedVacacion?.Estado == EstadoVacacion.Pendiente && AuthService.IsAprobador)
        {
            await AprobarVacacion();
        }
    }
    
    private Task RechazarSeleccionado()
    {
        if (selectedVacacion?.Estado == EstadoVacacion.Pendiente && AuthService.IsAprobador)
        {
            showRechazarDialog = true;
        }
        return Task.CompletedTask;
    }
    
    private async Task AprobarVacacion()
    {
        if (selectedVacacion == null || !AuthService.IsAprobador) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            selectedVacacion.Estado = EstadoVacacion.Aprobada;
            selectedVacacion.AprobadoPorId = AuthService.CurrentUser!.Id;
            selectedVacacion.FechaAprobacion = DateTime.Now;
            
            await VacacionRepository.UpdateAsync(selectedVacacion);
            
            successMessage = $"Vacación aprobada exitosamente";
            Logger.LogInformation($"Vacación {selectedVacacion.Id} aprobada por {AuthService.CurrentUser.NombreCompleto}");
            
            await CargarVacaciones();
            CerrarModal();
            
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al aprobar vacación");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task ConfirmarRechazo()
    {
        if (selectedVacacion == null || string.IsNullOrWhiteSpace(motivoRechazo)) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            selectedVacacion.Estado = EstadoVacacion.Rechazada;
            selectedVacacion.AprobadoPorId = AuthService.CurrentUser!.Id;
            selectedVacacion.FechaAprobacion = DateTime.Now;
            selectedVacacion.MotivoRechazo = motivoRechazo;
            
            await VacacionRepository.UpdateAsync(selectedVacacion);
            
            successMessage = $"Vacación rechazada";
            Logger.LogInformation($"Vacación {selectedVacacion.Id} rechazada por {AuthService.CurrentUser.NombreCompleto}");
            
            showRechazarDialog = false;
            motivoRechazo = "";
            
            await CargarVacaciones();
            CerrarModal();
            
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al rechazar vacación");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    // ===== Cálculos =====
    
    private async Task OnEmpleadoChanged()
    {
        if (vacacionEdit.EmpleadoId > 0)
        {
            await CargarHistorialVacaciones(vacacionEdit.EmpleadoId);
            await CalcularDiasDisponibles(vacacionEdit.EmpleadoId, vacacionEdit.PeriodoCorrespondiente);
        }
        else
        {
            diasDisponibles = null;
            historialVacaciones.Clear();
        }
    }
    
    private void CalcularDias()
    {
        if (vacacionEdit.FechaInicio != default && vacacionEdit.FechaFin != default)
        {
            if (vacacionEdit.FechaFin >= vacacionEdit.FechaInicio)
            {
                // Calcular días hábiles (excluyendo fines de semana)
                int dias = 0;
                var fecha = vacacionEdit.FechaInicio;
                
                while (fecha <= vacacionEdit.FechaFin)
                {
                    // Solo contar días de lunes a viernes
                    if (fecha.DayOfWeek != DayOfWeek.Saturday && fecha.DayOfWeek != DayOfWeek.Sunday)
                    {
                        dias++;
                    }
                    fecha = fecha.AddDays(1);
                }
                
                vacacionEdit.DiasTomados = dias;
            }
            else
            {
                vacacionEdit.DiasTomados = 0;
            }
        }
    }
    
    private async Task CalcularDiasDisponibles(int empleadoId, int periodo)
    {
        try
        {
            // Obtener empleado
            var empleado = await EmpleadoRepository.GetByIdAsync(empleadoId);
            if (empleado == null)
            {
                diasDisponibles = null;
                return;
            }
            
            // Calcular años de antigüedad
            var antiguedad = DateTime.Now.Year - empleado.FechaIngreso.Year;
            
            // Días base por año (típicamente 15 días, puede variar según legislación)
            int diasBase = 15;
            
            // Días adicionales por antigüedad (1 día adicional cada 5 años, hasta un máximo)
            int diasAdicionales = Math.Min((antiguedad / 5), 5); // Máximo 5 días adicionales (20 días total)
            
            int diasTotales = diasBase + diasAdicionales;
            
            // Obtener vacaciones ya tomadas o pendientes para el período
            var vacacionesPeriodo = await VacacionRepository.GetByEmpleadoYPeriodoAsync(empleadoId, periodo);
            
            int diasUsados = vacacionesPeriodo
                .Where(v => v.Estado != EstadoVacacion.Rechazada && 
                           v.Estado != EstadoVacacion.Cancelada &&
                           v.Id != vacacionEdit.Id) // Excluir la vacación actual si está editando
                .Sum(v => v.DiasTomados);
            
            diasDisponibles = diasTotales - diasUsados;
            
            Logger.LogInformation($"Empleado {empleadoId}: {diasTotales} días totales, {diasUsados} días usados, {diasDisponibles} días disponibles para período {periodo}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al calcular días disponibles para empleado {empleadoId}");
            diasDisponibles = null;
        }
    }
    
    private async Task CargarHistorialVacaciones(int empleadoId)
    {
        try
        {
            var historial = await VacacionRepository.GetByEmpleadoIdAsync(empleadoId);
            historialVacaciones = historial
                .Where(v => v.Id != vacacionEdit.Id) // Excluir la vacación actual
                .OrderByDescending(v => v.FechaInicio)
                .Take(10) // Últimas 10 vacaciones
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al cargar historial de vacaciones para empleado {empleadoId}");
            historialVacaciones.Clear();
        }
    }
    
    private async Task CargarResumenVacaciones(int empleadoId)
    {
        try
        {
            resumenVacaciones = await VacacionRepository.GetResumenVacacionesAsync(empleadoId);
            if (resumenVacaciones != null)
            {
                Logger.LogInformation($"Resumen de vacaciones cargado para empleado {empleadoId}: {resumenVacaciones.TotalDiasDisponibles} días disponibles");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al cargar resumen de vacaciones para empleado {empleadoId}");
            resumenVacaciones = null;
        }
    }
    
    // ===== Helpers =====
    
    private string GetEstadoTexto(EstadoVacacion estado)
    {
        return estado switch
        {
            EstadoVacacion.Pendiente => "PENDIENTE",
            EstadoVacacion.Aprobada => "APROBADA",
            EstadoVacacion.Rechazada => "RECHAZADA",
            EstadoVacacion.Programada => "PROGRAMADA",
            EstadoVacacion.Disfrutada => "DISFRUTADA",
            EstadoVacacion.Cancelada => "CANCELADA",
            _ => estado.ToString().ToUpper()
        };
    }
    
    private string GetEstadoColor(EstadoVacacion estado)
    {
        return estado switch
        {
            EstadoVacacion.Pendiente => "#FF9800",
            EstadoVacacion.Aprobada => "#4CAF50",
            EstadoVacacion.Rechazada => "#F44336",
            EstadoVacacion.Programada => "#2196F3",
            EstadoVacacion.Disfrutada => "#9E9E9E",
            EstadoVacacion.Cancelada => "#607D8B",
            _ => "#808080"
        };
    }
}
