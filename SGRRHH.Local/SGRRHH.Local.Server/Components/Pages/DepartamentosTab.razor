@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IDepartamentoRepository DepartamentoRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject ICatalogCacheService CatalogCache
@inject ILogger<DepartamentosTab> Logger
@inject IJSRuntime JSRuntime

<!-- Toolbar -->
<div class="hospital-toolbar">
    <div class="hospital-toolbar-group">
        <button @onclick="Nuevo">NUEVO</button>
        <button @onclick="CargarDatos">ACTUALIZAR</button>
        @if (selectedItem != null)
        {
            <button @onclick="EditarSeleccionado">EDITAR</button>
            <button @onclick="() => ConfirmarEliminar(selectedItem)" 
                    disabled="@(selectedItem.Empleados?.Count > 0)">
                ELIMINAR
            </button>
        }
    </div>
    <div class="hospital-toolbar-group">
        <input type="text" placeholder="BUSCAR..." 
               @bind="searchTerm" @bind:event="oninput" @bind:after="Buscar" />
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <button @onclick="LimpiarBusqueda">LIMPIAR</button>
        }
    </div>
</div>

<!-- Tabla de Áreas/Departamentos Organizacionales -->
<table class="hospital-table">
    <thead>
        <tr>
            <th>CÓDIGO</th>
            <th>NOMBRE DEL ÁREA</th>
            <th>DESCRIPCIÓN</th>
            <th>JEFE DE ÁREA</th>
            <th class="text-center">EMPLEADOS</th>
            <th>ACCIONES</th>
        </tr>
    </thead>
    <tbody>
        @if (isLoading)
        {
            <tr><td colspan="6" class="loading">CARGANDO ÁREAS/DEPARTAMENTOS...</td></tr>
        }
        else if (!itemsFiltrados.Any())
        {
            <tr><td colspan="6" class="empty-state">NO HAY ÁREAS/DEPARTAMENTOS PARA MOSTRAR</td></tr>
        }
        else
        {
            @foreach (var item in itemsFiltrados)
            {
                <tr class="@(selectedItem?.Id == item.Id ? "selected" : "")"
                    @onclick="() => SelectItem(item)">
                    <td><strong>@item.Codigo</strong></td>
                    <td>@item.Nombre</td>
                    <td>@(item.Descripcion ?? "-")</td>
                    <td>@GetJefeNombre(item.JefeId)</td>
                    <td class="text-center">@(item.Empleados?.Count ?? 0)</td>
                    <td class="table-actions">
                        <button @onclick="() => Editar(item)" @onclick:stopPropagation="true">
                            EDITAR
                        </button>
                        <button @onclick="() => ConfirmarEliminar(item)" @onclick:stopPropagation="true"
                                disabled="@(item.Empleados?.Count > 0)">
                            ELIMINAR
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Modal de edición -->
<FormModal @bind-IsVisible="showModal" 
           Title="@(isEditing ? $"EDITAR ÁREA/DEPARTAMENTO - {editItem?.Codigo}" : "NUEVA ÁREA/DEPARTAMENTO ORGANIZACIONAL")"
           OnSaveClicked="Guardar"
           OnCancelClicked="CerrarModal"
           IsSaving="isSaving">
    
    @if (editItem != null)
    {
        <div class="hospital-form-note">
            <strong>NOTA:</strong> ESTE ES UN DEPARTAMENTO/ÁREA ORGANIZACIONAL DE LA EMPRESA (EJ: RECURSOS HUMANOS, CONTABILIDAD), 
            NO UN DEPARTAMENTO GEOGRÁFICO DE COLOMBIA.
        </div>
        
        <div class="hospital-form-group required">
            <label>CÓDIGO</label>
            <div class="hospital-input-prefix">
                <span class="prefix">DP-</span>
                <input type="text" 
                       id="codigoInput"
                       @bind="codigoNumero" 
                       @bind:event="oninput"
                       maxlength="10" 
                       disabled="@isSaving"
                       placeholder="1, 2, 3..." />
            </div>
            <small>INGRESE EL NÚMERO DEL CÓDIGO (EJ: 1, 2, 3...)</small>
        </div>
        
        <div class="hospital-form-group required">
            <label>NOMBRE DEL ÁREA/DEPARTAMENTO</label>
            <input type="text" id="nombreInput" @bind="editItem.Nombre" maxlength="100" 
                   disabled="@isSaving" placeholder="EJ: RECURSOS HUMANOS, CONTABILIDAD, SISTEMAS..." />
        </div>
        
        <div class="hospital-form-group">
            <label>DESCRIPCIÓN</label>
            <textarea @bind="editItem.Descripcion" rows="3" 
                     disabled="@isSaving" 
                     maxlength="500"
                     placeholder="DESCRIPCIÓN DE LAS FUNCIONES Y RESPONSABILIDADES DEL ÁREA..."></textarea>
        </div>
        
        <div class="hospital-form-group">
            <label>JEFE DEL ÁREA/DEPARTAMENTO</label>
            <select @bind="editItem.JefeId" disabled="@isSaving">
                <option value="">-- SIN ASIGNAR --</option>
                @foreach (var emp in empleadosActivos)
                {
                    <option value="@emp.Id">@emp.NombreCompleto - @emp.Codigo</option>
                }
            </select>
            <small>EMPLEADO RESPONSABLE DE ESTA ÁREA</small>
        </div>
    }
</FormModal>

<!-- Modal de confirmación de eliminación -->
<FormModal @bind-IsVisible="showConfirmModal"
           Title="CONFIRMAR ELIMINACIÓN"
           OnSaveClicked="EliminarConfirmado"
           OnCancelClicked="() => showConfirmModal = false"
           ShowSaveButton="true"
           IsSaving="isSaving">
    <div style="padding: 16px;">
        <p style="margin-bottom: 12px;">¿CONFIRMA LA ELIMINACIÓN DEL ÁREA/DEPARTAMENTO <strong>@itemToDelete?.Nombre</strong>?</p>
        <p style="color: #CC0000; font-weight: 600;">
            ADVERTENCIA: ESTA ACCIÓN NO SE PUEDE DESHACER.
        </p>
    </div>
</FormModal>

@code {
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public EventCallback<string?> ErrorMessageChanged { get; set; }
    [Parameter] public string? SuccessMessage { get; set; }
    [Parameter] public EventCallback<string?> SuccessMessageChanged { get; set; }
    
    private List<Departamento> items = new();
    private List<Departamento> itemsFiltrados = new();
    private List<Empleado> empleadosActivos = new();
    private Departamento? selectedItem;
    private Departamento? editItem;
    private Departamento? itemToDelete;
    
    private bool isLoading;
    private bool showModal;
    private bool showConfirmModal;
    private bool isSaving;
    private bool isEditing;
    private string searchTerm = "";
    private string codigoNumero = ""; // Número del código (sin el prefijo DP-)
    
    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }
    
    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Usar GetAllActiveAsync para excluir departamentos eliminados (soft delete)
            var departamentos = await DepartamentoRepository.GetAllActiveAsync();
            items = departamentos.OrderBy(d => d.Nombre).ToList();
            itemsFiltrados = items;
            
            // Cargar empleados activos para el selector de jefe
            var empleados = await EmpleadoRepository.GetAllActiveAsync();
            empleadosActivos = empleados.OrderBy(e => e.NombreCompleto).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar áreas/departamentos");
            await SetError($"Error al cargar áreas/departamentos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void Buscar()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            itemsFiltrados = items;
        }
        else
        {
            var term = searchTerm.ToLower();
            itemsFiltrados = items.Where(d => 
                d.Codigo.ToLower().Contains(term) ||
                d.Nombre.ToLower().Contains(term) ||
                (d.Descripcion ?? "").ToLower().Contains(term)
            ).ToList();
        }
        StateHasChanged();
    }
    
    private void LimpiarBusqueda()
    {
        searchTerm = "";
        itemsFiltrados = items;
        StateHasChanged();
    }
    
    private void SelectItem(Departamento item)
    {
        selectedItem = item;
        StateHasChanged();
    }
    
    private async Task Nuevo()
    {
        // Obtener sugerencia de siguiente código
        var sugerido = await DepartamentoRepository.GetNextCodigoAsync();
        // Extraer solo el número (quitar "DP-")
        codigoNumero = sugerido.StartsWith("DP-") ? sugerido.Substring(3) : "1";
        
        editItem = new Departamento
        {
            Codigo = sugerido,
            Activo = true,
            FechaCreacion = DateTime.Now
        };
        isEditing = false;
        showModal = true;
        StateHasChanged();
    }
    
    private void Editar(Departamento item)
    {
        // Extraer número del código existente
        codigoNumero = item.Codigo.StartsWith("DP-") ? item.Codigo.Substring(3) : item.Codigo;
        
        editItem = new Departamento
        {
            Codigo = item.Codigo,
            Nombre = item.Nombre,
            Descripcion = item.Descripcion,
            JefeId = item.JefeId,
            Activo = item.Activo,
            FechaCreacion = item.FechaCreacion,
            FechaModificacion = DateTime.Now
        };
        // Guardar el Id original para actualización
        editItem.Id = item.Id;
        isEditing = true;
        showModal = true;
        StateHasChanged();
    }
    
    private void EditarSeleccionado()
    {
        if (selectedItem != null)
        {
            Editar(selectedItem);
        }
    }
    
    private async Task Guardar()
    {
        if (editItem == null) return;
        
        // Limpiar errores previos
        await JSRuntime.InvokeVoidAsync("clearAllFieldErrors");
        
        // Validar código
        if (string.IsNullOrWhiteSpace(codigoNumero))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", "EL NÚMERO DEL CÓDIGO ES REQUERIDO");
            return;
        }
        
        // Validar que sea un número válido
        codigoNumero = codigoNumero.Trim();
        if (!int.TryParse(codigoNumero, out var numCodigo) || numCodigo <= 0)
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", "EL CÓDIGO DEBE SER UN NÚMERO POSITIVO (EJ: 1, 2, 3...)");
            return;
        }
        
        // Construir código completo
        editItem.Codigo = $"DP-{numCodigo}";
        
        // Validar nombre
        if (string.IsNullOrWhiteSpace(editItem.Nombre))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "nombreInput", "EL NOMBRE DEL ÁREA/DEPARTAMENTO ES REQUERIDO");
            return;
        }
        
        // Validar código duplicado
        if (await DepartamentoRepository.ExistsCodigoAsync(editItem.Codigo, isEditing ? editItem.Id : null))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "codigoInput", $"YA EXISTE UN ÁREA/DEPARTAMENTO CON EL CÓDIGO '{editItem.Codigo}'");
            return;
        }
        
        // Validar nombre duplicado
        if (await DepartamentoRepository.ExistsByNameAsync(editItem.Nombre, isEditing ? editItem.Id : null))
        {
            await JSRuntime.InvokeVoidAsync("focusFieldWithError", "nombreInput", $"YA EXISTE UN ÁREA/DEPARTAMENTO CON EL NOMBRE '{editItem.Nombre}'");
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            if (isEditing)
            {
                await DepartamentoRepository.UpdateAsync(editItem);
                
                // Actualizar el item en la lista local sin recargar todo
                var itemIndex = items.FindIndex(d => d.Id == editItem.Id);
                if (itemIndex >= 0)
                {
                    var reloaded = await DepartamentoRepository.GetByIdAsync(editItem.Id);
                    if (reloaded != null)
                    {
                        items[itemIndex] = reloaded;
                    }
                }
                
                await SetSuccess($"Área/Departamento '{editItem.Nombre}' actualizado correctamente");
                Logger.LogInformation($"Área/Departamento actualizado: {editItem.Codigo}");
            }
            else
            {
                var newDept = await DepartamentoRepository.AddAsync(editItem);
                
                // Agregar el nuevo item a la lista
                var reloaded = await DepartamentoRepository.GetByIdAsync(newDept.Id);
                if (reloaded != null)
                {
                    items.Add(reloaded);
                    items = items.OrderBy(d => d.Nombre).ToList();
                }
                
                await SetSuccess($"Área/Departamento '{editItem.Nombre}' creado correctamente");
                Logger.LogInformation($"Área/Departamento creado: {editItem.Codigo}");
            }
            
            // Invalidar caché
            CatalogCache.InvalidateCache(CatalogType.Departamentos);
            
            Buscar();
            CerrarModal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar departamento");
            await SetError($"Error al guardar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void ConfirmarEliminar(Departamento item)
    {
        if (item.Empleados?.Count > 0)
        {
            SetError($"No se puede eliminar el área/departamento porque tiene {item.Empleados.Count} empleado(s) asignado(s)");
            return;
        }
        
        itemToDelete = item;
        showConfirmModal = true;
        StateHasChanged();
    }
    
    private async Task EliminarConfirmado()
    {
        if (itemToDelete == null) return;
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            await DepartamentoRepository.DeleteAsync(itemToDelete.Id);
            
            // Remover de la lista local
            items.RemoveAll(d => d.Id == itemToDelete.Id);
            
            // Invalidar caché
            CatalogCache.InvalidateCache(CatalogType.Departamentos);
            
            await SetSuccess($"Área/Departamento '{itemToDelete.Nombre}' eliminado correctamente");
            Logger.LogInformation($"Área/Departamento eliminado: {itemToDelete.Codigo}");
            
            Buscar();
            showConfirmModal = false;
            itemToDelete = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar departamento");
            await SetError($"Error al eliminar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void CerrarModal()
    {
        showModal = false;
        editItem = null;
        StateHasChanged();
    }
    
    private string GetJefeNombre(int? jefeId)
    {
        if (!jefeId.HasValue) return "-";
        
        var jefe = empleadosActivos.FirstOrDefault(e => e.Id == jefeId.Value);
        return jefe?.NombreCompleto ?? "-";
    }
    
    private async Task SetError(string message)
    {
        ErrorMessage = message;
        await ErrorMessageChanged.InvokeAsync(message);
    }
    
    private async Task SetSuccess(string message)
    {
        SuccessMessage = message;
        await SuccessMessageChanged.InvokeAsync(message);
        
        // Auto-hide después de 3 segundos (fire-and-forget, no bloquea)
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            if (SuccessMessage == message)
            {
                SuccessMessage = null;
                await InvokeAsync(async () =>
                {
                    await SuccessMessageChanged.InvokeAsync(null);
                    StateHasChanged();
                });
            }
        });
    }
}
