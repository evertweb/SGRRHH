@page "/auditoria"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IAuditService AuditService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<Auditoria> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Auditoría - SGRRHH</PageTitle>

<KeyboardHandler @ref="keyboardHandler" Shortcuts="shortcuts" ShowShortcutBar="true" />

<h1 class="page-title">AUDITORÍA DEL SISTEMA</h1>

@if (!AuthService.IsAdmin)
{
    <div class="error-block">
        <h3>ACCESO DENEGADO</h3>
        <p>Esta página solo está disponible para administradores.</p>
        <button @onclick="@(() => Navigation.NavigateTo("/dashboard"))">IR AL DASHBOARD</button>
    </div>
    return;
}

@if (errorMessage != null)
{
    <div class="error-block">
        <h3>ERROR</h3>
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

<!-- Panel de Filtros -->
<div class="panel" style="margin-bottom: 24px;">
    <h3>FILTROS DE BÚSQUEDA</h3>
    
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
        <div class="form-group">
            <label>Fecha Inicio:</label>
            <input type="date" @bind="fechaInicio" />
        </div>

        <div class="form-group">
            <label>Fecha Fin:</label>
            <input type="date" @bind="fechaFin" />
        </div>

        <div class="form-group">
            <label>Entidad:</label>
            <select @bind="entidadFiltro">
                <option value="">Todas</option>
                <option value="Empleado">Empleado</option>
                <option value="Usuario">Usuario</option>
                <option value="Permiso">Permiso</option>
                <option value="Vacacion">Vacación</option>
                <option value="Contrato">Contrato</option>
                <option value="Configuracion">Configuración</option>
            </select>
        </div>

        <div class="form-group">
            <label>Acción:</label>
            <select @bind="accionFiltro">
                <option value="">Todas</option>
                <option value="Crear">Crear</option>
                <option value="Actualizar">Actualizar</option>
                <option value="Eliminar">Eliminar</option>
                <option value="Login">Login</option>
                <option value="Logout">Logout</option>
                <option value="Backup">Backup</option>
                <option value="Restore">Restore</option>
            </select>
        </div>
    </div>

    <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button @onclick="BuscarLogs" disabled="@isLoading">
            @if (isLoading)
            {
                <span>BUSCANDO...</span>
            }
            else
            {
                <span>BUSCAR (F4)</span>
            }
        </button>

        <button @onclick="LimpiarFiltros" disabled="@isLoading">
            LIMPIAR FILTROS
        </button>

        <button @onclick="CargarRecientes" disabled="@isLoading">
            VER ÚLTIMOS 100
        </button>
    </div>
</div>

<!-- Panel de Resultados -->
<div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>REGISTROS DE AUDITORÍA</h3>
        <div style="color: #666;">
            Total: @logs.Count registros
        </div>
    </div>

    @if (isLoading)
    {
        <p class="loading">Cargando logs de auditoría...</p>
    }
    else if (!logs.Any())
    {
        <p class="empty-state">No hay registros de auditoría para mostrar</p>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th style="width: 150px;">FECHA/HORA</th>
                    <th style="width: 150px;">USUARIO</th>
                    <th style="width: 120px;">ACCIÓN</th>
                    <th style="width: 120px;">ENTIDAD</th>
                    <th style="width: 80px;">ID</th>
                    <th>DESCRIPCIÓN</th>
                    <th style="width: 100px;">DETALLES</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in logs)
                {
                    <tr class="@(selectedLog?.Id == log.Id ? "selected" : "")"
                        @onclick="() => selectedLog = log">
                        <td>
                            <div>@log.FechaHora.ToString("dd/MM/yyyy")</div>
                            <div style="font-size: 11px; color: #666;">@log.FechaHora.ToString("HH:mm:ss")</div>
                        </td>
                        <td>
                            <strong>@log.UsuarioNombre</strong>
                        </td>
                        <td>
                            <span class="badge-@GetAccionBadge(log.Accion)">
                                @log.Accion.ToUpper()
                            </span>
                        </td>
                        <td>@log.Entidad</td>
                        <td>
                            @if (log.EntidadId.HasValue)
                            {
                                <span>#@log.EntidadId</span>
                            }
                            else
                            {
                                <span style="color: #666;">-</span>
                            }
                        </td>
                        <td>
                            @if (log.Descripcion.Length > 80)
                            {
                                <span title="@log.Descripcion">@(log.Descripcion.Substring(0, 80))...</span>
                            }
                            else
                            {
                                <span>@log.Descripcion</span>
                            }
                        </td>
                        <td class="actions-cell">
                            <button @onclick="() => VerDetalles(log)" @onclick:stopPropagation="true">
                                VER
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<!-- Modal de Detalles -->
<FormModal @bind-IsVisible="showDetallesModal" 
           Title="DETALLES DE AUDITORÍA"
           Width="700px"
           OnCancelClicked="CerrarDetalles"
           HideSaveButton="true"
           CancelButtonText="CERRAR">
    
    @if (selectedLog != null)
    {
        <div style="display: grid; gap: 16px;">
            <!-- Información básica -->
            <div style="background-color: #1a1a1a; padding: 16px; border-left: 4px solid #4CAF50;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Fecha/Hora</p>
                        <p style="margin: 4px 0 0 0; font-weight: bold;">
                            @selectedLog.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")
                        </p>
                    </div>

                    <div>
                        <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Usuario</p>
                        <p style="margin: 4px 0 0 0; font-weight: bold;">@selectedLog.UsuarioNombre</p>
                    </div>

                    <div>
                        <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Acción</p>
                        <p style="margin: 4px 0 0 0;">
                            <span class="badge-@GetAccionBadge(selectedLog.Accion)">
                                @selectedLog.Accion.ToUpper()
                            </span>
                        </p>
                    </div>

                    <div>
                        <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Entidad</p>
                        <p style="margin: 4px 0 0 0; font-weight: bold;">
                            @selectedLog.Entidad
                            @if (selectedLog.EntidadId.HasValue)
                            {
                                <span style="color: #4CAF50;"> #@selectedLog.EntidadId</span>
                            }
                        </p>
                    </div>
                </div>
            </div>

            <!-- Descripción -->
            <div>
                <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Descripción</p>
                <p style="margin: 8px 0 0 0; padding: 12px; background-color: #1a1a1a; border-radius: 4px;">
                    @selectedLog.Descripcion
                </p>
            </div>

            <!-- Datos adicionales -->
            @if (!string.IsNullOrEmpty(selectedLog.DatosAdicionales))
            {
                <div>
                    <p style="margin: 0; font-size: 11px; color: #666; text-transform: uppercase;">Datos Adicionales (JSON)</p>
                    <pre style="margin: 8px 0 0 0; padding: 12px; background-color: #1a1a1a; border-radius: 4px; overflow-x: auto; font-size: 11px; line-height: 1.5;">@FormatJson(selectedLog.DatosAdicionales)</pre>
                </div>
            }
        </div>
    }
</FormModal>

@code {
    private KeyboardHandler? keyboardHandler;
    private List<KeyboardHandler.KeyboardShortcut> shortcuts = new();
    
    private List<AuditLog> logs = new();
    private AuditLog? selectedLog;
    
    // Filtros
    private DateTime? fechaInicio;
    private DateTime? fechaFin;
    private string entidadFiltro = string.Empty;
    private string accionFiltro = string.Empty;
    
    // Estados
    private bool isLoading;
    private bool showDetallesModal;
    private string? errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        if (!AuthService.IsAdmin)
        {
            Logger.LogWarning("Usuario {User} intentó acceder a /auditoria sin permisos de admin", 
                AuthService.CurrentUser?.Username);
            return;
        }
        
        // Configurar atajos de teclado
        shortcuts = new List<KeyboardHandler.KeyboardShortcut>
        {
            new() { Key = "F4", KeyDisplay = "F4", Description = "Buscar", Action = BuscarLogs },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarRecientes },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarDetalles }
        };
        
        // Cargar logs recientes por defecto
        await CargarRecientes();
    }
    
    private async Task BuscarLogs()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            var options = new AuditSearchOptions
            {
                FechaInicio = fechaInicio,
                FechaFin = fechaFin,
                Entidad = string.IsNullOrEmpty(entidadFiltro) ? null : entidadFiltro,
                Accion = string.IsNullOrEmpty(accionFiltro) ? null : accionFiltro
            };
            
            logs = (await AuditService.SearchAsync(options)).ToList();
            
            Logger.LogInformation("Búsqueda de auditoría realizada: {Count} resultados", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al buscar logs de auditoría");
            errorMessage = "Error al buscar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarRecientes()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            logs = (await AuditService.GetRecentAsync(100)).ToList();
            
            Logger.LogInformation("Logs recientes cargados: {Count}", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar logs recientes");
            errorMessage = "Error al cargar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void LimpiarFiltros()
    {
        fechaInicio = null;
        fechaFin = null;
        entidadFiltro = string.Empty;
        accionFiltro = string.Empty;
        StateHasChanged();
    }
    
    private void VerDetalles(AuditLog log)
    {
        selectedLog = log;
        showDetallesModal = true;
    }
    
    private Task CerrarDetalles()
    {
        showDetallesModal = false;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private string GetAccionBadge(string accion) => accion.ToLower() switch
    {
        "crear" => "success",
        "actualizar" => "warning",
        "eliminar" => "danger",
        "login" => "info",
        "logout" => "secondary",
        "backup" => "admin",
        "restore" => "danger",
        _ => "default"
    };
    
    private string FormatJson(string json)
    {
        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }
}
