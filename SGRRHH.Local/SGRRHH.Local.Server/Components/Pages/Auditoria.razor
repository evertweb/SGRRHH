@page "/auditoria"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IAuditService AuditService
@inject IAuthService AuthService
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Auditoria> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Auditoría - SGRRHH</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>AUDITORÍA DEL SISTEMA</h1>
    </div>

    @if (!AuthService.IsAdmin)
    {
        <div class="error-panel">
            <div class="error-content">
                <div class="error-title">ACCESO DENEGADO</div>
                <div class="error-message">Esta funcionalidad requiere permisos de administrador.</div>
                <div class="button-row">
                    <button class="btn-secondary" @onclick="@(() => Navigation.NavigateTo("/empleados"))">VOLVER</button>
                </div>
            </div>
        </div>
        return;
    }

    @if (errorMessage != null)
    {
        <div class="error-panel">
            <div class="error-content">
                <div class="error-title">ERROR</div>
                <div class="error-message">@errorMessage</div>
                <div class="button-row">
                    <button class="btn-secondary" @onclick="() => errorMessage = null">ACEPTAR</button>
                </div>
            </div>
        </div>
    }

    <div class="section-container">
        <div class="section-header">
            FILTROS DE BÚSQUEDA
        </div>

        <div class="filter-row">
            <div class="filter-group">
                <label class="field-label">FECHA INICIO:</label>
                <input type="date" class="field-input" @bind="fechaInicio" />
            </div>

            <div class="filter-group">
                <label class="field-label">FECHA FIN:</label>
                <input type="date" class="field-input" @bind="fechaFin" />
            </div>

            <div class="filter-group">
                <label class="field-label">USUARIO:</label>
                <input type="text" class="field-input" @bind="usuarioFiltro" placeholder="" />
            </div>

            <div class="filter-group">
                <label class="field-label">MÓDULO:</label>
                <select class="field-input" @bind="entidadFiltro">
                    <option value="">TODOS</option>
                    <option value="Empleado">EMPLEADO</option>
                    <option value="Usuario">USUARIO</option>
                    <option value="Permiso">PERMISO</option>
                    <option value="Vacacion">VACACIÓN</option>
                    <option value="Contrato">CONTRATO</option>
                    <option value="Configuracion">CONFIGURACIÓN</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="field-label">ACCIÓN:</label>
                <select class="field-input" @bind="accionFiltro">
                    <option value="">TODAS</option>
                    <option value="Crear">CREAR</option>
                    <option value="Actualizar">ACTUALIZAR</option>
                    <option value="Eliminar">ELIMINAR</option>
                    <option value="Login">LOGIN</option>
                    <option value="Logout">LOGOUT</option>
                    <option value="Backup">BACKUP</option>
                    <option value="Restore">RESTORE</option>
                </select>
            </div>
        </div>

        <div class="button-row">
            <button class="btn-primary" @onclick="BuscarLogs" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>PROCESANDO...</span>
                }
                else
                {
                    <span>BUSCAR</span>
                }
            </button>
            <button class="btn-secondary" @onclick="LimpiarFiltros" disabled="@isLoading">LIMPIAR</button>
            <button class="btn-secondary" @onclick="CargarRecientes" disabled="@isLoading">RECIENTES</button>
        </div>
    </div>

    <div class="section-container">
        <div class="section-header">
            REGISTRO DE AUDITORÍA (@logs.Count REGISTROS)
        </div>

        @if (isLoading)
        {
            <div class="status-message">
                CARGANDO REGISTROS...
            </div>
        }
        else if (!logs.Any())
        {
            <div class="status-message">
                SIN REGISTROS PARA MOSTRAR
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>HORA</th>
                            <th>USUARIO</th>
                            <th>ACCIÓN</th>
                            <th>MÓDULO</th>
                            <th>RESULTADO</th>
                            <th>DESCRIPCIÓN</th>
                            <th>VER</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in logs)
                        {
                            <tr class="@(selectedLog?.Id == log.Id ? "row-selected" : "")"
                                @onclick="() => selectedLog = log">
                                <td>@log.FechaHora.ToString("dd/MM/yyyy")</td>
                                <td>@log.FechaHora.ToString("HH:mm:ss")</td>
                                <td>@log.UsuarioNombre</td>
                                <td>@log.Accion.ToUpper()</td>
                                <td>@log.Entidad</td>
                                <td class="@GetResultadoClass(log.Accion)">@GetResultadoTexto(log.Accion)</td>
                                <td class="col-descripcion">
                                    @if (log.Descripcion.Length > 60)
                                    {
                                        <text>@(log.Descripcion.Substring(0, 60))...</text>
                                    }
                                    else
                                    {
                                        @log.Descripcion
                                    }
                                </td>
                                <td>
                                    <button class="btn-table" @onclick="() => VerDetalles(log)" @onclick:stopPropagation="true">
                                        VER
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@if (showDetallesModal)
{
    <div class="modal-overlay" @onclick="CerrarDetalles">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                DETALLE DE REGISTRO DE AUDITORÍA
            </div>

            @if (selectedLog != null)
            {
                <div class="modal-body">
                    <div class="detail-row">
                        <div class="detail-field">
                            <label class="field-label">FECHA:</label>
                            <div class="field-value">@selectedLog.FechaHora.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="detail-field">
                            <label class="field-label">HORA:</label>
                            <div class="field-value">@selectedLog.FechaHora.ToString("HH:mm:ss")</div>
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-field">
                            <label class="field-label">USUARIO:</label>
                            <div class="field-value">@selectedLog.UsuarioNombre</div>
                        </div>
                        <div class="detail-field">
                            <label class="field-label">ACCIÓN:</label>
                            <div class="field-value">@selectedLog.Accion.ToUpper()</div>
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-field">
                            <label class="field-label">MÓDULO:</label>
                            <div class="field-value">@selectedLog.Entidad</div>
                        </div>
                        <div class="detail-field">
                            <label class="field-label">ID REGISTRO:</label>
                            <div class="field-value">
                                @if (selectedLog.EntidadId.HasValue)
                                {
                                    <span>@selectedLog.EntidadId</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="detail-full">
                        <label class="field-label">DESCRIPCIÓN:</label>
                        <div class="field-value-box">
                            @selectedLog.Descripcion
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedLog.DatosAdicionales))
                    {
                        <div class="detail-full">
                            <label class="field-label">DATOS TÉCNICOS:</label>
                            <pre class="field-value-code">@FormatJson(selectedLog.DatosAdicionales)</pre>
                        </div>
                    }
                </div>
            }

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CerrarDetalles">CERRAR</button>
            </div>
        </div>
    </div>
}

@code {
    private const string PageId = "auditoria";
    
    private List<AuditLog> logs = new();
    private AuditLog? selectedLog;
    
    // Filtros
    private DateTime? fechaInicio;
    private DateTime? fechaFin;
    private string usuarioFiltro = string.Empty;
    private string entidadFiltro = string.Empty;
    private string accionFiltro = string.Empty;
    
    // Estados
    private bool isLoading;
    private bool showDetallesModal;
    private string? errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        if (!AuthService.IsAdmin)
        {
            Logger.LogWarning("Usuario {User} intentó acceder a /auditoria sin permisos de admin", 
                AuthService.CurrentUser?.Username);
            return;
        }
        
        // Registrar atajos de teclado para esta página
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F2", KeyDisplay = "F2", Description = "Buscar", Action = BuscarLogs, Priority = 10 },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarRecientes, Priority = 10 },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarDetalles, Priority = 10 }
        });
        
        // Cargar logs recientes por defecto
        await CargarRecientes();
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task BuscarLogs()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            var options = new AuditSearchOptions
            {
                FechaInicio = fechaInicio,
                FechaFin = fechaFin,
                Entidad = string.IsNullOrEmpty(entidadFiltro) ? null : entidadFiltro,
                Accion = string.IsNullOrEmpty(accionFiltro) ? null : accionFiltro
            };
            
            var allLogs = (await AuditService.SearchAsync(options)).ToList();
            
            // Filtro de usuario en cliente si está especificado
            if (!string.IsNullOrEmpty(usuarioFiltro))
            {
                logs = allLogs
                    .Where(l => l.UsuarioNombre.Contains(usuarioFiltro, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }
            else
            {
                logs = allLogs;
            }
            
            Logger.LogInformation("Búsqueda de auditoría realizada: {Count} resultados", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al buscar logs de auditoría");
            errorMessage = "Error al buscar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarRecientes()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            logs = (await AuditService.GetRecentAsync(100)).ToList();
            
            Logger.LogInformation("Logs recientes cargados: {Count}", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar logs recientes");
            errorMessage = "Error al cargar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void LimpiarFiltros()
    {
        fechaInicio = null;
        fechaFin = null;
        usuarioFiltro = string.Empty;
        entidadFiltro = string.Empty;
        accionFiltro = string.Empty;
        StateHasChanged();
    }
    
    private void VerDetalles(AuditLog log)
    {
        selectedLog = log;
        showDetallesModal = true;
    }
    
    private Task CerrarDetalles()
    {
        showDetallesModal = false;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private string GetResultadoTexto(string accion) => accion.ToLower() switch
    {
        "crear" => "OK",
        "actualizar" => "OK",
        "eliminar" => "OK",
        "login" => "OK",
        "logout" => "OK",
        "backup" => "OK",
        "restore" => "OK",
        _ => "OK"
    };
    
    private string GetResultadoClass(string accion) => accion.ToLower() switch
    {
        "eliminar" => "resultado-error",
        "restore" => "resultado-error",
        _ => "resultado-ok"
    };
    
    private string FormatJson(string json)
    {
        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }
}
