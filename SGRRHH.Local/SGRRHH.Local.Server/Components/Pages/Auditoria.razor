@page "/auditoria"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IAuditService AuditService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<Auditoria> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Auditor칤a - SGRRHH</PageTitle>

<KeyboardHandler @ref="keyboardHandler" Shortcuts="shortcuts" ShowShortcutBar="true" />

<h1 class="page-title">AUDITOR칈A DEL SISTEMA</h1>

@if (!AuthService.IsAdmin)
{
    <div class="error-block">
        <h3>ACCESO DENEGADO</h3>
        <p>Esta p치gina solo est치 disponible para administradores.</p>
        <button @onclick="@(() => Navigation.NavigateTo("/empleados"))">VOLVER</button>
    </div>
    return;
}

@if (errorMessage != null)
{
    <div class="error-block">
        <h3>ERROR</h3>
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

<!-- Panel de Filtros -->
<div class="panel">
    <div class="panel-header">FILTROS DE B칔SQUEDA</div>
    <div class="panel-body">
        <div class="grid-4">
            <div class="form-group">
                <label>FECHA INICIO</label>
                <input type="date" @bind="fechaInicio" />
            </div>

            <div class="form-group">
                <label>FECHA FIN</label>
                <input type="date" @bind="fechaFin" />
            </div>

            <div class="form-group">
                <label>ENTIDAD</label>
                <select @bind="entidadFiltro">
                    <option value="">Todas</option>
                    <option value="Empleado">Empleado</option>
                    <option value="Usuario">Usuario</option>
                    <option value="Permiso">Permiso</option>
                    <option value="Vacacion">Vacaci칩n</option>
                    <option value="Contrato">Contrato</option>
                    <option value="Configuracion">Configuraci칩n</option>
                </select>
            </div>

            <div class="form-group">
                <label>ACCI칍N</label>
                <select @bind="accionFiltro">
                    <option value="">Todas</option>
                    <option value="Crear">Crear</option>
                    <option value="Actualizar">Actualizar</option>
                    <option value="Eliminar">Eliminar</option>
                    <option value="Login">Login</option>
                    <option value="Logout">Logout</option>
                    <option value="Backup">Backup</option>
                    <option value="Restore">Restore</option>
                </select>
            </div>
        </div>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn-primary" @onclick="BuscarLogs" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>BUSCANDO...</span>
                    }
                    else
                    {
                        <span>BUSCAR (F4)</span>
                    }
                </button>

                <button @onclick="LimpiarFiltros" disabled="@isLoading">
                    LIMPIAR FILTROS
                </button>

                <button @onclick="CargarRecientes" disabled="@isLoading">
                    VER 칔LTIMOS 100
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Panel de Resultados -->
<div class="panel">
    <div class="panel-header">
        REGISTROS DE AUDITOR칈A
        <span class="results-info">Total: @logs.Count registros</span>
    </div>
    <div class="panel-body">
        @if (isLoading)
        {
            <div class="loading">Cargando logs de auditor칤a...</div>
        }
        else if (!logs.Any())
        {
            <div class="empty-state">
                <div class="icon">游늶</div>
                <div class="message">No hay registros de auditor칤a para mostrar</div>
            </div>
        }
        else
        {
            <table>
                <thead>
                    <tr>
                        <th>FECHA/HORA</th>
                        <th>USUARIO</th>
                        <th>ACCI칍N</th>
                        <th>ENTIDAD</th>
                        <th>ID</th>
                        <th>DESCRIPCI칍N</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var log in logs)
                    {
                        <tr class="@(selectedLog?.Id == log.Id ? "selected" : "")"
                            @onclick="() => selectedLog = log">
                            <td>
                                <div>@log.FechaHora.ToString("dd/MM/yyyy")</div>
                                <small>@log.FechaHora.ToString("HH:mm:ss")</small>
                            </td>
                            <td>
                                <strong>@log.UsuarioNombre</strong>
                            </td>
                            <td>
                                <span class="badge badge-@GetAccionBadge(log.Accion)">
                                    @log.Accion.ToUpper()
                                </span>
                            </td>
                            <td>@log.Entidad</td>
                            <td>
                                @if (log.EntidadId.HasValue)
                                {
                                    <span>#@log.EntidadId</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (log.Descripcion.Length > 80)
                                {
                                    <span title="@log.Descripcion">@(log.Descripcion.Substring(0, 80))...</span>
                                }
                                else
                                {
                                    <span>@log.Descripcion</span>
                                }
                            </td>
                            <td class="table-actions">
                                <button @onclick="() => VerDetalles(log)" @onclick:stopPropagation="true">
                                    VER
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Modal de Detalles -->
<FormModal @bind-IsVisible="showDetallesModal" 
           Title="DETALLES DE AUDITOR칈A"
           Width="700px"
           OnCancelClicked="CerrarDetalles"
           ShowSaveButton="false">
    
    @if (selectedLog != null)
    {
        <div class="audit-details">
            <!-- Informaci칩n b치sica -->
            <div class="detail-section">
                <div class="grid-2">
                    <div class="form-group">
                        <label>FECHA/HORA</label>
                        <div class="detail-value">
                            @selectedLog.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")
                        </div>
                    </div>

                    <div class="form-group">
                        <label>USUARIO</label>
                        <div class="detail-value">@selectedLog.UsuarioNombre</div>
                    </div>

                    <div class="form-group">
                        <label>ACCI칍N</label>
                        <div class="detail-value">
                            <span class="badge badge-@GetAccionBadge(selectedLog.Accion)">
                                @selectedLog.Accion.ToUpper()
                            </span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ENTIDAD</label>
                        <div class="detail-value">
                            @selectedLog.Entidad
                            @if (selectedLog.EntidadId.HasValue)
                            {
                                <span class="text-success"> #@selectedLog.EntidadId</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descripci칩n -->
            <div class="form-group">
                <label>DESCRIPCI칍N</label>
                <div class="detail-value detail-box">
                    @selectedLog.Descripcion
                </div>
            </div>

            <!-- Datos adicionales -->
            @if (!string.IsNullOrEmpty(selectedLog.DatosAdicionales))
            {
                <div class="form-group">
                    <label>DATOS ADICIONALES (JSON)</label>
                    <pre class="code-block">@FormatJson(selectedLog.DatosAdicionales)</pre>
                </div>
            }
        </div>
    }
</FormModal>

@code {
    private KeyboardHandler? keyboardHandler;
    private List<KeyboardHandler.KeyboardShortcut> shortcuts = new();
    
    private List<AuditLog> logs = new();
    private AuditLog? selectedLog;
    
    // Filtros
    private DateTime? fechaInicio;
    private DateTime? fechaFin;
    private string entidadFiltro = string.Empty;
    private string accionFiltro = string.Empty;
    
    // Estados
    private bool isLoading;
    private bool showDetallesModal;
    private string? errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        if (!AuthService.IsAdmin)
        {
            Logger.LogWarning("Usuario {User} intent칩 acceder a /auditoria sin permisos de admin", 
                AuthService.CurrentUser?.Username);
            return;
        }
        
        // Configurar atajos de teclado
        shortcuts = new List<KeyboardHandler.KeyboardShortcut>
        {
            new() { Key = "F4", KeyDisplay = "F4", Description = "Buscar", Action = BuscarLogs },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarRecientes },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarDetalles }
        };
        
        // Cargar logs recientes por defecto
        await CargarRecientes();
    }
    
    private async Task BuscarLogs()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            var options = new AuditSearchOptions
            {
                FechaInicio = fechaInicio,
                FechaFin = fechaFin,
                Entidad = string.IsNullOrEmpty(entidadFiltro) ? null : entidadFiltro,
                Accion = string.IsNullOrEmpty(accionFiltro) ? null : accionFiltro
            };
            
            logs = (await AuditService.SearchAsync(options)).ToList();
            
            Logger.LogInformation("B칰squeda de auditor칤a realizada: {Count} resultados", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al buscar logs de auditor칤a");
            errorMessage = "Error al buscar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarRecientes()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            logs = (await AuditService.GetRecentAsync(100)).ToList();
            
            Logger.LogInformation("Logs recientes cargados: {Count}", logs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar logs recientes");
            errorMessage = "Error al cargar logs: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void LimpiarFiltros()
    {
        fechaInicio = null;
        fechaFin = null;
        entidadFiltro = string.Empty;
        accionFiltro = string.Empty;
        StateHasChanged();
    }
    
    private void VerDetalles(AuditLog log)
    {
        selectedLog = log;
        showDetallesModal = true;
    }
    
    private Task CerrarDetalles()
    {
        showDetallesModal = false;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private string GetAccionBadge(string accion) => accion.ToLower() switch
    {
        "crear" => "success",
        "actualizar" => "warning",
        "eliminar" => "danger",
        "login" => "info",
        "logout" => "secondary",
        "backup" => "admin",
        "restore" => "danger",
        _ => "default"
    };
    
    private string FormatJson(string json)
    {
        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }
}
