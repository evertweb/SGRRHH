@page "/empleados/onboarding"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<EmpleadoOnboarding> Logger

<PageTitle>Onboarding de Empleado - SGRRHH</PageTitle>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<div class="wizard-container">
    <!-- Header del Wizard -->
    <div class="wizard-header">
        <h1>üßë‚Äçüíº ASISTENTE DE INGRESO DE EMPLEADO</h1>
        <p>Complete los siguientes pasos para registrar un nuevo empleado en el sistema</p>
    </div>

    <!-- Barra de Progreso -->
    <div class="wizard-progress">
        <div class="progress-steps">
            @for (int i = 1; i <= 4; i++)
            {
                var stepNumber = i;
                <div class="progress-step @(currentStep == stepNumber ? "active" : "") @(currentStep > stepNumber ? "completed" : "")">
                    <div class="step-circle">
                        @if (currentStep > stepNumber)
                        {
                            <span>‚úì</span>
                        }
                        else
                        {
                            <span>@stepNumber</span>
                        }
                    </div>
                    <div class="step-label">@GetStepName(stepNumber)</div>
                </div>
                @if (i < 4)
                {
                    <div class="step-connector @(currentStep > stepNumber ? "completed" : "")"></div>
                }
            }
        </div>
    </div>

    <!-- Contenido del Paso Actual -->
    <div class="wizard-content">
        @if (currentStep == 1)
        {
            @RenderStep1DatosBasicos()
        }
        else if (currentStep == 2)
        {
            @RenderStep2DocumentosObligatorios()
        }
        else if (currentStep == 3)
        {
            @RenderStep3DocumentosOpcionales()
        }
        else if (currentStep == 4)
        {
            @RenderStep4Revisar()
        }
    </div>

    <!-- Botones de Navegaci√≥n -->
    <div class="wizard-footer">
        <div class="toolbar">
            <button @onclick="Cancelar" disabled="@isSaving" class="btn btn-danger">
                CANCELAR
            </button>
            <div class="toolbar-group">
                @if (currentStep > 1)
                {
                    <button @onclick="Anterior" disabled="@isSaving" class="btn">
                        ‚óÄ ANTERIOR
                    </button>
                }
                @if (currentStep < 4)
                {
                    <button @onclick="Siguiente" disabled="@(!CanGoNext() || isSaving)" class="btn btn-primary">
                        SIGUIENTE ‚ñ∂
                    </button>
                }
                else
                {
                    <button @onclick="Finalizar" disabled="@isSaving" class="btn btn-success">
                        @(isSaving ? "GUARDANDO..." : "‚úì FINALIZAR Y GUARDAR")
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private MessageToast? messageToast;
    
    private int currentStep = 1;
    private bool isSaving = false;
    
    // Datos del empleado
    private Empleado empleado = new Empleado
    {
        FechaIngreso = DateTime.Today,
        Estado = EstadoEmpleado.Activo
    };
    
    // Cat√°logos
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    // Foto
    private IBrowserFile? fotoFile;
    private string? fotoPreviewUrl;
    
    // Documentos
    private List<DocumentoUpload> documentosObligatorios = new();
    private List<DocumentoUpload> documentosOpcionales = new();
    
    private class DocumentoUpload
    {
        public TipoDocumentoEmpleado Tipo { get; set; }
        public string Nombre { get; set; } = "";
        public string NombreTipo { get; set; } = "";
        public bool EsObligatorio { get; set; }
        public IBrowserFile? Archivo { get; set; }
        public string? ArchivoNombre { get; set; }
        public DateTime? FechaEmision { get; set; }
        public DateTime? FechaVencimiento { get; set; }
        public bool Subido { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Cargar cat√°logos
        await CargarCatalogos();
        
        // Inicializar documentos
        InicializarDocumentos();
        
        // Obtener siguiente c√≥digo
        empleado.Codigo = await EmpleadoRepo.GetNextCodigoAsync();
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando cat√°logos");
            messageToast?.ShowError("Error al cargar cat√°logos");
        }
    }
    
    private void InicializarDocumentos()
    {
        // Documentos OBLIGATORIOS seg√∫n legislaci√≥n colombiana
        var obligatorios = new[]
        {
            (TipoDocumentoEmpleado.Cedula, "Fotocopia de C√©dula"),
            (TipoDocumentoEmpleado.HojaVida, "Hoja de Vida / Curriculum"),
            (TipoDocumentoEmpleado.CertificadoEstudios, "Certificados de Estudios"),
            (TipoDocumentoEmpleado.CertificadoLaboral, "Certificados Laborales"),
            (TipoDocumentoEmpleado.ReferenciasPersonales, "Referencias Personales (m√≠n. 2)"),
            (TipoDocumentoEmpleado.ReferenciasLaborales, "Referencias Laborales (m√≠n. 2)"),
            (TipoDocumentoEmpleado.ExamenMedicoIngreso, "Examen M√©dico de Ingreso"),
            (TipoDocumentoEmpleado.AfiliacionEPS, "Afiliaci√≥n EPS"),
            (TipoDocumentoEmpleado.AfiliacionAFP, "Afiliaci√≥n AFP (Pensi√≥n)"),
            (TipoDocumentoEmpleado.AfiliacionARL, "Afiliaci√≥n ARL"),
            (TipoDocumentoEmpleado.AfiliacionCajaCompensacion, "Afiliaci√≥n Caja Compensaci√≥n"),
            (TipoDocumentoEmpleado.Antecedentes, "Certificado de Antecedentes"),
            (TipoDocumentoEmpleado.RUT, "RUT (Registro √önico Tributario)"),
            (TipoDocumentoEmpleado.CertificadoBancario, "Certificaci√≥n Bancaria"),
            (TipoDocumentoEmpleado.ContratoFirmado, "Contrato de Trabajo Firmado"),
            (TipoDocumentoEmpleado.LibretaMilitar, "Libreta Militar (hombres)"),
            (TipoDocumentoEmpleado.Foto, "Foto 3x4 tipo documento")
        };
        
        foreach (var (tipo, nombre) in obligatorios)
        {
            documentosObligatorios.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = true,
                FechaEmision = DateTime.Today
            });
        }
        
        // Documentos OPCIONALES
        var opcionales = new[]
        {
            (TipoDocumentoEmpleado.LicenciaConduccion, "Licencia de Conducci√≥n"),
            (TipoDocumentoEmpleado.ActaEntregaDotacion, "Acta Entrega de Dotaci√≥n"),
            (TipoDocumentoEmpleado.Capacitacion, "Certificados de Capacitaci√≥n"),
            (TipoDocumentoEmpleado.ExamenMedicoPeriodico, "Ex√°menes M√©dicos Peri√≥dicos"),
            (TipoDocumentoEmpleado.Otro, "Otros Documentos")
        };
        
        foreach (var (tipo, nombre) in opcionales)
        {
            documentosOpcionales.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = false,
                FechaEmision = DateTime.Today
            });
        }
    }
    
    private string GetStepName(int step) => step switch
    {
        1 => "Datos B√°sicos",
        2 => "Documentos Obligatorios",
        3 => "Documentos Opcionales",
        4 => "Revisar y Confirmar",
        _ => ""
    };
    
    private bool CanGoNext()
    {
        return currentStep switch
        {
            1 => ValidarStep1(),
            2 => true, // Documentos obligatorios se validan pero no bloquean
            3 => true, // Documentos opcionales no bloquean
            _ => false
        };
    }
    
    private bool ValidarStep1()
    {
        return !string.IsNullOrWhiteSpace(empleado.Codigo) &&
               !string.IsNullOrWhiteSpace(empleado.Cedula) &&
               !string.IsNullOrWhiteSpace(empleado.Nombres) &&
               !string.IsNullOrWhiteSpace(empleado.Apellidos) &&
               empleado.FechaIngreso != default;
    }
    
    private void Siguiente()
    {
        if (currentStep < 4 && CanGoNext())
        {
            currentStep++;
        }
    }
    
    private void Anterior()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    
    private async Task Cancelar()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "¬øEst√° seguro que desea cancelar? Se perder√°n todos los datos ingresados.");
        if (confirmed)
        {
            Navigation.NavigateTo("/empleados");
        }
    }
    
    private async Task Finalizar()
    {
        if (!ValidarStep1())
        {
            messageToast?.ShowError("Debe completar los datos b√°sicos del empleado");
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            // 1. Validar c√≥digo √∫nico
            if (await EmpleadoRepo.ExistsCodigoAsync(empleado.Codigo, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el c√≥digo {empleado.Codigo}");
                return;
            }
            
            // 2. Validar c√©dula √∫nica
            if (await EmpleadoRepo.ExistsCedulaAsync(empleado.Cedula, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la c√©dula {empleado.Cedula}");
                return;
            }
            
            // 3. Validar email √∫nico (si se proporcion√≥)
            if (!string.IsNullOrWhiteSpace(empleado.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleado.Email, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleado.Email}");
                return;
            }
            
            // 4. Crear empleado primero para obtener el ID
            empleado = await EmpleadoRepo.AddAsync(empleado);
            Logger.LogInformation("Empleado creado: {Id} - {Codigo}", empleado.Id, empleado.Codigo);
            
            // 5. Guardar foto si se seleccion√≥
            if (fotoFile != null)
            {
                try
                {
                    using var stream = fotoFile.OpenReadStream(2 * 1024 * 1024);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    var extension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
                    var result = await StorageService.SaveEmpleadoFotoAsync(empleado.Id, ms.ToArray(), extension);
                    
                    if (result.IsSuccess)
                    {
                        empleado.FotoPath = result.Value;
                        // Actualizar empleado con el path de la foto
                        await EmpleadoRepo.UpdateAsync(empleado);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error guardando foto");
                }
            }
            
            // 6. Subir documentos obligatorios
            var docsSubidos = 0;
            foreach (var doc in documentosObligatorios.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            
            // 7. Subir documentos opcionales
            foreach (var doc in documentosOpcionales.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            
            Logger.LogInformation("Onboarding completado: Empleado {Codigo} con {Docs} documentos", 
                empleado.Codigo, docsSubidos);
            
            messageToast?.ShowSuccess($"Empleado {empleado.Codigo} creado exitosamente con {docsSubidos} documento(s)");
            
            await Task.Delay(1500);
            Navigation.NavigateTo("/empleados");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error en onboarding");
            messageToast?.ShowError("Error al guardar: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task SubirDocumento(int empleadoId, DocumentoUpload doc)
    {
        if (doc.Archivo == null) return;
        
        using var stream = doc.Archivo.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        
        var storageResult = await StorageService.SaveDocumentoEmpleadoAsync(
            empleadoId,
            doc.NombreTipo,
            ms.ToArray(),
            doc.Archivo.Name
        );
        
        if (storageResult.IsSuccess)
        {
            var documento = new DocumentoEmpleado
            {
                EmpleadoId = empleadoId,
                TipoDocumento = doc.Tipo,
                Nombre = doc.Nombre,
                NombreArchivoOriginal = doc.Archivo.Name,
                TipoMime = doc.Archivo.ContentType,
                TamanoArchivo = doc.Archivo.Size,
                FechaEmision = doc.FechaEmision,
                FechaVencimiento = doc.FechaVencimiento,
                SubidoPorNombre = AuthService.CurrentUser?.NombreCompleto,
                SubidoPorUsuarioId = AuthService.CurrentUser?.Id,
                ArchivoPath = storageResult.Value,
                Activo = true,
                FechaCreacion = DateTime.Now
            };
            
            await DocumentoRepo.AddAsync(documento);
            doc.Subido = true;
        }
    }
    
    // Renders de cada paso
    private RenderFragment RenderStep1DatosBasicos() => __builder =>
    {
        <div class="step-content">
            <h3 class="step-title">üìã PASO 1: DATOS B√ÅSICOS DEL EMPLEADO</h3>
            <p class="step-description">Complete la informaci√≥n personal y laboral del nuevo empleado. Los campos marcados con * son obligatorios.</p>
            
            <div class="form-grid">
                <!-- Columna Izquierda -->
                <div class="form-column">
                    <h4 class="section-title">INFORMACI√ìN PERSONAL</h4>
                    
                    <div class="form-group required">
                        <label>C√≥digo:</label>
                        <input type="text" @bind="empleado.Codigo" maxlength="20" readonly />
                        <small>C√≥digo autom√°tico asignado</small>
                    </div>
                    
                    <div class="form-group required">
                        <label>C√©dula:</label>
                        <input type="text" @bind="empleado.Cedula" maxlength="20" />
                    </div>
                    
                    <div class="form-group required">
                        <label>Nombres:</label>
                        <input type="text" @bind="empleado.Nombres" maxlength="100" />
                    </div>
                    
                    <div class="form-group required">
                        <label>Apellidos:</label>
                        <input type="text" @bind="empleado.Apellidos" maxlength="100" />
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha Nacimiento:</label>
                        <input type="date" @bind="empleado.FechaNacimiento" />
                        @if (empleado.FechaNacimiento.HasValue)
                        {
                            var edad = CalcularEdad(empleado.FechaNacimiento.Value);
                            <small>Edad: @edad a√±os</small>
                        }
                    </div>
                    
                    <div class="form-group">
                        <label>G√©nero:</label>
                        <select @bind="empleado.Genero">
                            <option value="">-- Seleccione --</option>
                            @foreach (var g in Enum.GetValues<Genero>())
                            {
                                <option value="@g">@g</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado Civil:</label>
                        <select @bind="empleado.EstadoCivil">
                            <option value="">-- Seleccione --</option>
                            @foreach (var ec in Enum.GetValues<EstadoCivil>())
                            {
                                <option value="@ec">@ec</option>
                            }
                        </select>
                    </div>
                </div>
                
                <!-- Columna Derecha -->
                <div class="form-column">
                    <h4 class="section-title">INFORMACI√ìN DE CONTACTO Y LABORAL</h4>
                    
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" @bind="empleado.Telefono" maxlength="20" />
                    </div>
                    
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" @bind="empleado.Email" maxlength="100" />
                    </div>
                    
                    <div class="form-group">
                        <label>Direcci√≥n:</label>
                        <textarea @bind="empleado.Direccion" rows="2" maxlength="250"></textarea>
                    </div>
                    
                    <div class="form-group required">
                        <label>Fecha Ingreso:</label>
                        <input type="date" @bind="empleado.FechaIngreso" />
                        @if (empleado.FechaIngreso != default)
                        {
                            var antiguedad = CalcularAntiguedad(empleado.FechaIngreso);
                            <small>Antig√ºedad: @antiguedad</small>
                        }
                    </div>
                    
                    <div class="form-group">
                        <label>Departamento:</label>
                        <select @bind="empleado.DepartamentoId">
                            <option value="">-- Seleccione --</option>
                            @foreach (var d in departamentos)
                            {
                                <option value="@d.Id">@d.Nombre</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Cargo:</label>
                        <select @bind="empleado.CargoId">
                            <option value="">-- Seleccione --</option>
                            @foreach (var c in cargos)
                            {
                                <option value="@c.Id">@c.Nombre</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado:</label>
                        <select @bind="empleado.Estado">
                            @foreach (var estado in Enum.GetValues<EstadoEmpleado>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Foto (Opcional):</label>
                        <InputFile OnChange="OnFotoSelected" accept="image/*" />
                        <small>JPG, PNG. Max 2MB</small>
                        @if (fotoPreviewUrl != null)
                        {
                            <div class="logo-preview">
                                <img src="@fotoPreviewUrl" alt="Vista previa" />
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <!-- Contacto de Emergencia -->
            <div class="emergency-section">
                <h4 class="section-title">‚ö†Ô∏è CONTACTO DE EMERGENCIA</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Nombre Contacto:</label>
                        <input type="text" @bind="empleado.ContactoEmergencia" maxlength="100" />
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono Emergencia:</label>
                        <input type="text" @bind="empleado.TelefonoEmergencia" maxlength="20" />
                    </div>
                </div>
            </div>
            
            <!-- Observaciones -->
            <div class="form-group">
                <label>Observaciones (Opcional):</label>
                <textarea @bind="empleado.Observaciones" rows="3" maxlength="500"></textarea>
            </div>
        </div>
    };
    
    private RenderFragment RenderStep2DocumentosObligatorios() => __builder =>
    {
        <div class="step-content">
            <h3 class="step-title">üìÑ PASO 2: DOCUMENTOS OBLIGATORIOS</h3>
            <p class="step-description">
                Suba los 17 documentos obligatorios seg√∫n la legislaci√≥n colombiana. Puede omitir documentos y subirlos despu√©s.
            </p>
            
            <div class="docs-summary">
                <strong>Progreso:</strong> @documentosObligatorios.Count(d => d.Archivo != null) de @documentosObligatorios.Count documentos seleccionados
            </div>
            
            <div class="docs-list">
                @foreach (var doc in documentosObligatorios)
                {
                    <div class="doc-item @(doc.Archivo != null ? "uploaded" : "")">
                        <div class="doc-header">
                            <span class="doc-icon">@(doc.Archivo != null ? "‚úì" : "üìÑ")</span>
                            <strong>@doc.NombreTipo</strong>
                            @if (doc.Archivo != null)
                            {
                                <span class="doc-status">‚úì Seleccionado</span>
                            }
                        </div>
                        <div class="doc-fields">
                            <div class="doc-field">
                                <label>Archivo:</label>
                                <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                          accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                                @if (doc.Archivo != null)
                                {
                                    <small class="text-success">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</small>
                                }
                            </div>
                            <div class="doc-field">
                                <label>F. Emisi√≥n:</label>
                                <input type="date" @bind="doc.FechaEmision" />
                            </div>
                            <div class="doc-field">
                                <label>F. Vencimiento:</label>
                                <input type="date" @bind="doc.FechaVencimiento" />
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <div class="info-box">
                <strong>‚ÑπÔ∏è IMPORTANTE:</strong> No es obligatorio subir todos los documentos en este momento. 
                Puede continuar y subir los documentos faltantes posteriormente desde el m√≥dulo de Documentos.
            </div>
        </div>
    };
    
    private RenderFragment RenderStep3DocumentosOpcionales() => __builder =>
    {
        <div class="step-content">
            <h3 class="step-title">üìé PASO 3: DOCUMENTOS OPCIONALES</h3>
            <p class="step-description">
                Suba documentos adicionales seg√∫n el cargo. Estos son completamente opcionales.
            </p>
            
            <div class="docs-summary">
                <strong>Documentos opcionales seleccionados:</strong> @documentosOpcionales.Count(d => d.Archivo != null)
            </div>
            
            <div class="docs-list">
                @foreach (var doc in documentosOpcionales)
                {
                    <div class="doc-item @(doc.Archivo != null ? "uploaded" : "")">
                        <div class="doc-header">
                            <span class="doc-icon">@(doc.Archivo != null ? "‚úì" : "üìé")</span>
                            <strong>@doc.NombreTipo</strong>
                            @if (doc.Archivo != null)
                            {
                                <span class="doc-status">‚úì Seleccionado</span>
                            }
                        </div>
                        <div class="doc-fields">
                            <div class="doc-field">
                                <label>Archivo:</label>
                                <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                          accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                                @if (doc.Archivo != null)
                                {
                                    <small class="text-success">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</small>
                                }
                            </div>
                            <div class="doc-field">
                                <label>F. Emisi√≥n:</label>
                                <input type="date" @bind="doc.FechaEmision" />
                            </div>
                            <div class="doc-field">
                                <label>F. Vencimiento:</label>
                                <input type="date" @bind="doc.FechaVencimiento" />
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    };
    
    private RenderFragment RenderStep4Revisar() => __builder =>
    {
        <div class="step-content">
            <h3 class="step-title">‚úì PASO 4: REVISAR Y CONFIRMAR</h3>
            <p class="step-description">
                Revise la informaci√≥n antes de crear el empleado. Una vez confirmado, se crear√° el registro y se subir√°n los documentos.
            </p>
            
            <!-- Resumen de Datos -->
            <div class="review-section">
                <h4 class="section-title">üë§ DATOS DEL EMPLEADO</h4>
                <div class="review-grid">
                    <div class="review-item">
                        <strong>C√≥digo:</strong>
                        <span>@empleado.Codigo</span>
                    </div>
                    <div class="review-item">
                        <strong>C√©dula:</strong>
                        <span>@empleado.Cedula</span>
                    </div>
                    <div class="review-item">
                        <strong>Nombre Completo:</strong>
                        <span>@empleado.Nombres @empleado.Apellidos</span>
                    </div>
                    <div class="review-item">
                        <strong>Fecha Nacimiento:</strong>
                        <span>@(empleado.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "No especificada")</span>
                    </div>
                    <div class="review-item">
                        <strong>G√©nero:</strong>
                        <span>@(empleado.Genero?.ToString() ?? "No especificado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Estado Civil:</strong>
                        <span>@(empleado.EstadoCivil?.ToString() ?? "No especificado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Tel√©fono:</strong>
                        <span>@(empleado.Telefono ?? "No especificado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Email:</strong>
                        <span>@(empleado.Email ?? "No especificado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Fecha Ingreso:</strong>
                        <span>@empleado.FechaIngreso.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="review-item">
                        <strong>Departamento:</strong>
                        <span>@(departamentos.FirstOrDefault(d => d.Id == empleado.DepartamentoId)?.Nombre ?? "No asignado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Cargo:</strong>
                        <span>@(cargos.FirstOrDefault(c => c.Id == empleado.CargoId)?.Nombre ?? "No asignado")</span>
                    </div>
                    <div class="review-item">
                        <strong>Estado:</strong>
                        <span class="badge badge-@empleado.Estado.ToString().ToLower()">@empleado.Estado</span>
                    </div>
                </div>
            </div>
            
            <!-- Resumen de Documentos -->
            <div class="review-section">
                <h4 class="section-title">üìÑ DOCUMENTOS A SUBIR</h4>
                
                @{
                    var docsObligatoriosSubir = documentosObligatorios.Where(d => d.Archivo != null).ToList();
                    var docsOpcionalesSubir = documentosOpcionales.Where(d => d.Archivo != null).ToList();
                    var totalDocs = docsObligatoriosSubir.Count + docsOpcionalesSubir.Count;
                }
                
                <div class="docs-stats">
                    <div class="stat-box">
                        <div class="stat-number">@docsObligatoriosSubir.Count</div>
                        <div class="stat-label">Documentos Obligatorios</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">@docsOpcionalesSubir.Count</div>
                        <div class="stat-label">Documentos Opcionales</div>
                    </div>
                    <div class="stat-box highlight">
                        <div class="stat-number">@totalDocs</div>
                        <div class="stat-label">Total a Subir</div>
                    </div>
                </div>
                
                @if (totalDocs > 0)
                {
                    <div class="docs-preview">
                        <strong>Archivos seleccionados:</strong>
                        <ul>
                            @foreach (var doc in docsObligatoriosSubir)
                            {
                                <li>‚úì @doc.NombreTipo - <small>@doc.Archivo!.Name</small></li>
                            }
                            @foreach (var doc in docsOpcionalesSubir)
                            {
                                <li>‚úì @doc.NombreTipo - <small>@doc.Archivo!.Name</small></li>
                            }
                        </ul>
                    </div>
                }
                else
                {
                    <div class="warning-box">
                        ‚ö†Ô∏è No se han seleccionado documentos. Puede subirlos despu√©s desde el m√≥dulo de Documentos.
                    </div>
                }
            </div>
            
            @if (fotoFile != null)
            {
                <div class="review-section">
                    <h4 class="section-title">üì∑ FOTO</h4>
                    <div class="logo-preview">
                        <img src="@fotoPreviewUrl" alt="Foto empleado" />
                    </div>
                </div>
            }
            
            <div class="confirm-box">
                <strong>‚úì</strong> Al hacer clic en <strong>FINALIZAR Y GUARDAR</strong>, se crear√° el empleado y se subir√°n todos los documentos seleccionados.
            </div>
        </div>
    };
    
    // Event Handlers
    private async Task OnFotoSelected(InputFileChangeEventArgs e)
    {
        fotoFile = e.File;
        
        if (fotoFile != null)
        {
            try
            {
                using var stream = fotoFile.OpenReadStream(2 * 1024 * 1024);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                fotoPreviewUrl = $"data:{fotoFile.ContentType};base64,{base64}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error cargando foto");
                messageToast?.ShowError("Error al cargar foto");
            }
        }
    }
    
    private void OnDocumentoSelected(InputFileChangeEventArgs e, DocumentoUpload doc)
    {
        doc.Archivo = e.File;
        doc.ArchivoNombre = e.File.Name;
        StateHasChanged();
    }
    
    // Helpers
    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var hoy = DateTime.Today;
        var edad = hoy.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > hoy.AddYears(-edad))
            edad--;
        return edad;
    }
    
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var a√±os = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-a√±os))
            a√±os--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            a√±os--;
            meses += 12;
        }
        
        if (a√±os > 0 && meses > 0)
            return $"{a√±os} a√±o(s) {meses} mes(es)";
        else if (a√±os > 0)
            return $"{a√±os} a√±o(s)";
        else
            return $"{meses} mes(es)";
    }
    
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
