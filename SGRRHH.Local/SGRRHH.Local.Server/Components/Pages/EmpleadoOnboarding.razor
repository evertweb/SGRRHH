@page "/empleados/onboarding"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.Services
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<EmpleadoOnboarding> Logger

<PageTitle>Nuevo Empleado - SGRRHH</PageTitle>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<div class="hospital-page-container">
    <!-- Header -->
    <div class="hospital-page-header">
        <h1 class="hospital-page-title">NUEVO EMPLEADO</h1>
        <div class="hospital-shortcuts-bar">
            F5=GUARDAR | F8=CANCELAR | ESC=SALIR | TAB=SIGUIENTE CAMPO
        </div>
    </div>

    <!-- Progreso - sin animaciones, solo texto -->
    <div class="hospital-progress-bar">
        <div class="hospital-progress-text">
            PASO @currentStep DE 2: @GetStepName(currentStep).ToUpper()
        </div>
    </div>

    <!-- Contenido del Paso Actual -->
    <div class="hospital-content">
        @if (currentStep == 1)
        {
            @RenderStep1DatosBasicos()
        }
        else if (currentStep == 2)
        {
            @RenderStep4Revisar()
        }
    </div>

    <!-- Botones de Navegación -->
    <div class="hospital-footer">
        <button type="button" 
                @onclick="Cancelar" 
                disabled="@isSaving" 
                class="hospital-btn hospital-btn-secondary">
            CANCELAR (F8)
        </button>
        <div class="hospital-btn-group">
            @if (currentStep > 1)
            {
                <button type="button" 
                        @onclick="Anterior" 
                        disabled="@isSaving" 
                        class="hospital-btn hospital-btn-secondary">
                    ANTERIOR
                </button>
            }
            @if (currentStep < 2)
            {
                <button type="button" 
                        @onclick="Siguiente" 
                        disabled="@(!CanGoNext() || isSaving)" 
                        class="hospital-btn hospital-btn-primary">
                    SIGUIENTE
                </button>
            }
            else
            {
                <button type="button" 
                        @onclick="Finalizar" 
                        disabled="@isSaving" 
                        class="hospital-btn hospital-btn-primary">
                    @(isSaving ? "GUARDANDO..." : "GUARDAR (F5)")
                </button>
            }
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
@if (showConfirmModal)
{
    <div class="hospital-confirm-overlay">
        <div class="hospital-confirm-dialog">
            <div class="hospital-confirm-header">CONFIRMAR OPERACION</div>
            <div class="hospital-confirm-body">
                @confirmMessage
            </div>
            <div class="hospital-confirm-footer">
                <button type="button" 
                        class="hospital-btn hospital-btn-secondary"
                        @onclick="() => { showConfirmModal = false; confirmAction = null; }">
                    NO
                </button>
                <button type="button" 
                        class="hospital-btn hospital-btn-primary"
                        @onclick="ExecuteConfirmAction">
                    SI
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal de Previsualización de Documento -->
@if (showPreviewModal && previewDoc != null)
{
    <div class="hospital-confirm-overlay" @onclick="CerrarPreview">
        <div class="hospital-preview-modal" @onclick:stopPropagation="true">
            <div class="hospital-preview-header">
                <span>@previewDoc.NombreTipo - @previewDoc.ArchivoNombre</span>
                <button type="button" class="hospital-btn hospital-btn-secondary" @onclick="CerrarPreview">CERRAR (ESC)</button>
            </div>
            <div class="hospital-preview-body">
                @if (previewUrl != null)
                {
                    @if (IsPreviewableImage(previewDoc.Archivo?.ContentType))
                    {
                        <img src="@previewUrl" alt="Vista previa" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
                    }
                    else if (previewDoc.Archivo?.ContentType == "application/pdf")
                    {
                        <iframe src="@previewUrl" style="width: 100%; height: 70vh; border: none;"></iframe>
                    }
                    else
                    {
                        <div class="hospital-no-preview">
                            <p>TIPO DE ARCHIVO: @previewDoc.Archivo?.ContentType</p>
                            <p>NO SE PUEDE PREVISUALIZAR ESTE TIPO DE ARCHIVO</p>
                            <p style="margin-top: 20px;">El archivo será subido al guardar el formulario.</p>
                        </div>
                    }
                }
                else
                {
                    <div class="hospital-no-preview">CARGANDO VISTA PREVIA...</div>
                }
            </div>
            <div class="hospital-preview-footer">
                <span>Tamaño: @FormatFileSize(previewDoc.Archivo?.Size ?? 0)</span>
                <button type="button" class="hospital-btn hospital-btn-secondary" @onclick="CerrarPreview">CERRAR</button>
            </div>
        </div>
    </div>
}

<style>
    .hospital-preview-modal {
        background: #FFFFFF;
        border: 3px solid #000000;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .hospital-preview-header {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .hospital-preview-body {
        flex: 1;
        overflow: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #333333;
        min-height: 400px;
        padding: 10px;
    }
    
    .hospital-preview-footer {
        border-top: 2px solid #000000;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #F0F0F0;
        font-family: 'Courier New', monospace;
        font-size: 11px;
    }
    
    .hospital-no-preview {
        color: #FFFFFF;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        text-align: center;
        padding: 40px;
    }
    
    .hospital-btn-sm {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 4px 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        text-transform: uppercase;
        margin-right: 4px;
    }
    
    .hospital-btn-sm:hover {
        background: #F0F0F0;
    }
    
    .hospital-btn-danger-sm {
        border-color: #DC143C;
        color: #DC143C;
    }
    
    .hospital-btn-danger-sm:hover {
        background: #FFE8E8;
    }
</style>

@* Scanner Modal - Movido al módulo de Documentos
<ScannerModal @bind-IsVisible="mostrarScannerModal"
              AllowMultiplePages="true"
              OnScanComplete="OnScanComplete"
              OnPdfGenerated="OnPdfGenerated" />
*@

@code {
    private MessageToast? messageToast;
    
    private int currentStep = 1;
    private bool isSaving = false;
    private bool showConfirmModal = false;
    private string confirmMessage = "";
    private Action? confirmAction;
    
    // Datos del empleado
    private Empleado empleado = new Empleado
    {
        FechaIngreso = DateTime.Today
    };
    
    // Estado determinado por rol del usuario
    private bool esOperador = false;
    
    // Catálogos
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    // Catálogos de seguridad social
    private List<Eps> epsLista = new();
    private List<Afp> afpLista = new();
    private List<Arl> arlLista = new();
    private List<CajaCompensacion> cajasLista = new();
    
    // IDs seleccionados para seguridad social
    private int? epsIdSeleccionado;
    private int? afpIdSeleccionado;
    private int? arlIdSeleccionado;
    private int? cajaIdSeleccionado;
    
    // Foto
    private IBrowserFile? fotoFile;
    private string? fotoPreviewUrl;
    
    // Documentos
    private List<DocumentoUpload> documentosObligatorios = new();
    private List<DocumentoUpload> documentosOpcionales = new();
    
    // Previsualización
    private bool showPreviewModal = false;
    private DocumentoUpload? previewDoc;
    private string? previewUrl;
    
    // Estado del Scanner
    private bool mostrarScannerModal = false;
    private DocumentoUpload? documentoParaEscanear = null;
    
    private class DocumentoUpload
    {
        public TipoDocumentoEmpleado Tipo { get; set; }
        public string Nombre { get; set; } = "";
        public string NombreTipo { get; set; } = "";
        public bool EsObligatorio { get; set; }
        public IBrowserFile? Archivo { get; set; }
        public string? ArchivoNombre { get; set; }
        public DateTime? FechaEmision { get; set; }
        public DateTime? FechaVencimiento { get; set; }
        public bool Subido { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Determinar estado inicial según rol del usuario
        var rolUsuario = AuthService.CurrentUser?.Rol ?? RolUsuario.Operador;
        esOperador = rolUsuario == RolUsuario.Operador;
        empleado.Estado = EstadoEmpleadoService.ObtenerEstadoInicialSegunRol(rolUsuario);
        
        Logger.LogInformation("Rol del usuario: {Rol}, Estado inicial del empleado: {Estado}", 
            rolUsuario, empleado.Estado);
        
        // Cargar catálogos
        await CargarCatalogos();
        
        // Inicializar documentos
        InicializarDocumentos();
        
        // Obtener siguiente código
        empleado.Codigo = await EmpleadoRepo.GetNextCodigoAsync();
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
            
            // Cargar catálogos de seguridad social
            epsLista = await CatalogCache.GetEpsAsync();
            afpLista = await CatalogCache.GetAfpAsync();
            arlLista = await CatalogCache.GetArlAsync();
            cajasLista = await CatalogCache.GetCajasCompensacionAsync();
            
            Logger.LogInformation("Catálogos cargados: EPS={EpsCount}, AFP={AfpCount}, ARL={ArlCount}, Cajas={CajasCount}", 
                epsLista.Count, afpLista.Count, arlLista.Count, cajasLista.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando catálogos");
            messageToast?.ShowError("Error al cargar catálogos");
        }
    }
    
    private void InicializarDocumentos()
    {
        // Documentos OBLIGATORIOS según legislación colombiana
        var obligatorios = new[]
        {
            (TipoDocumentoEmpleado.Cedula, "Fotocopia de Cédula"),
            (TipoDocumentoEmpleado.HojaVida, "Hoja de Vida / Curriculum"),
            (TipoDocumentoEmpleado.CertificadoEstudios, "Certificados de Estudios"),
            (TipoDocumentoEmpleado.CertificadoLaboral, "Certificados Laborales"),
            (TipoDocumentoEmpleado.ReferenciasPersonales, "Referencias Personales (mín. 2)"),
            (TipoDocumentoEmpleado.ReferenciasLaborales, "Referencias Laborales (mín. 2)"),
            (TipoDocumentoEmpleado.ExamenMedicoIngreso, "Examen Médico de Ingreso"),
            (TipoDocumentoEmpleado.AfiliacionEPS, "Afiliación EPS"),
            (TipoDocumentoEmpleado.AfiliacionAFP, "Afiliación AFP (Pensión)"),
            (TipoDocumentoEmpleado.AfiliacionARL, "Afiliación ARL"),
            (TipoDocumentoEmpleado.AfiliacionCajaCompensacion, "Afiliación Caja Compensación"),
            (TipoDocumentoEmpleado.Antecedentes, "Certificado de Antecedentes"),
            (TipoDocumentoEmpleado.RUT, "RUT (Registro Único Tributario)"),
            (TipoDocumentoEmpleado.CertificadoBancario, "Certificación Bancaria"),
            (TipoDocumentoEmpleado.ContratoFirmado, "Contrato de Trabajo Firmado"),
            (TipoDocumentoEmpleado.LibretaMilitar, "Libreta Militar (hombres)"),
            (TipoDocumentoEmpleado.Foto, "Foto 3x4 tipo documento")
        };
        
        foreach (var (tipo, nombre) in obligatorios)
        {
            documentosObligatorios.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = true,
                FechaEmision = DateTime.Today
            });
        }
        
        // Documentos OPCIONALES
        var opcionales = new[]
        {
            (TipoDocumentoEmpleado.LicenciaConduccion, "Licencia de Conducción"),
            (TipoDocumentoEmpleado.ActaEntregaDotacion, "Acta Entrega de Dotación"),
            (TipoDocumentoEmpleado.Capacitacion, "Certificados de Capacitación"),
            (TipoDocumentoEmpleado.ExamenMedicoPeriodico, "Exámenes Médicos Periódicos"),
            (TipoDocumentoEmpleado.Otro, "Otros Documentos")
        };
        
        foreach (var (tipo, nombre) in opcionales)
        {
            documentosOpcionales.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = false,
                FechaEmision = DateTime.Today
            });
        }
    }
    
    private string GetStepName(int step) => step switch
    {
        1 => "Datos Básicos",
        2 => "Revisar y Confirmar",
        // Pasos anteriores (documentos) se mantienen por compatibilidad pero no se usan
        3 => "Documentos Opcionales",
        4 => "Revisar y Confirmar",
        _ => ""
    };
    
    private bool CanGoNext()
    {
        return currentStep switch
        {
            1 => ValidarStep1(),
            // Los siguientes casos se mantienen por compatibilidad pero no se usan en el wizard simplificado
            2 => true,
            3 => true,
            _ => false
        };
    }
    
    private bool ValidarStep1()
    {
        // Datos básicos obligatorios
        if (string.IsNullOrWhiteSpace(empleado.Codigo)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Cedula)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Nombres)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Apellidos)) return false;
        if (!empleado.FechaNacimiento.HasValue) return false;
        if (!empleado.Genero.HasValue) return false;
        if (empleado.FechaIngreso == default) return false;
        
        // Información laboral obligatoria
        if (!empleado.DepartamentoId.HasValue) return false;
        if (!empleado.CargoId.HasValue) return false;
        if (!empleado.SalarioBase.HasValue) return false;
        
        // Seguridad social obligatoria
        if (string.IsNullOrWhiteSpace(empleado.EPS)) return false;
        if (string.IsNullOrWhiteSpace(empleado.AFP)) return false;
        if (string.IsNullOrWhiteSpace(empleado.ARL)) return false;
        if (string.IsNullOrWhiteSpace(empleado.CajaCompensacion)) return false;
        
        // Contacto obligatorio
        if (string.IsNullOrWhiteSpace(empleado.TelefonoCelular)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Direccion)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Municipio)) return false;
        
        // Información médica obligatoria
        if (string.IsNullOrWhiteSpace(empleado.TipoSangre)) return false;
        
        // Contacto de emergencia obligatorio
        if (string.IsNullOrWhiteSpace(empleado.ContactoEmergencia)) return false;
        if (string.IsNullOrWhiteSpace(empleado.ParentescoContactoEmergencia)) return false;
        if (string.IsNullOrWhiteSpace(empleado.TelefonoEmergencia)) return false;
        
        return true;
    }
    
    private void Siguiente()
    {
        if (currentStep < 2 && CanGoNext())
        {
            currentStep++;
        }
    }
    
    private void Anterior()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    
    private async Task Cancelar()
    {
        confirmMessage = "¿Cancelar operacion? Los datos ingresados se perderan.";
        confirmAction = () =>
        {
            Navigation.NavigateTo("/empleados");
        };
        showConfirmModal = true;
    }
    
    private void ExecuteConfirmAction()
    {
        showConfirmModal = false;
        confirmAction?.Invoke();
        confirmAction = null;
    }
    
    private async Task Finalizar()
    {
        confirmMessage = $"¿Confirmar creacion del empleado {empleado.Codigo}?";
        confirmAction = async () => await ExecuteFinalizar();
        showConfirmModal = true;
    }
    
    private async Task ExecuteFinalizar()
    {
        if (!ValidarStep1())
        {
            messageToast?.ShowError("Debe completar los datos básicos del empleado");
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            // Convertir campos de texto a mayúsculas antes de guardar
            ConvertirCamposAMayusculas();
            
            // 1. Validar código único
            if (await EmpleadoRepo.ExistsCodigoAsync(empleado.Codigo, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el código {empleado.Codigo}");
                return;
            }
            
            // 2. Validar cédula única
            if (await EmpleadoRepo.ExistsCedulaAsync(empleado.Cedula, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la cédula {empleado.Cedula}");
                return;
            }
            
            // 3. Validar email único (si se proporcionó)
            if (!string.IsNullOrWhiteSpace(empleado.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleado.Email, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleado.Email}");
                return;
            }
            
            // 4. Registrar auditoría: quién creó el empleado y cuándo
            empleado.CreadoPorId = AuthService.CurrentUserId;
            empleado.FechaSolicitud = DateTime.Now;
            
            // Si el creador es Aprobador o Admin, el empleado queda aprobado automáticamente
            if (empleado.Estado == EstadoEmpleado.Activo)
            {
                empleado.AprobadoPorId = AuthService.CurrentUserId;
                empleado.FechaAprobacion = DateTime.Now;
            }
            
            // 5. Crear empleado
            empleado = await EmpleadoRepo.AddAsync(empleado);
            Logger.LogInformation("Empleado creado: {Id} - {Codigo} - Estado: {Estado} - CreadoPor: {CreadoPor}", 
                empleado.Id, empleado.Codigo, empleado.Estado, AuthService.CurrentUser?.NombreCompleto);
            
            // NOTA: La foto y documentos se cargan desde el módulo de Documentos
            // La lógica de subida de foto y documentos se mantiene comentada por compatibilidad
            
            /*
            // 5. Guardar foto si se seleccionó (MOVIDO AL MÓDULO DE DOCUMENTOS)
            if (fotoFile != null)
            {
                try
                {
                    using var stream = fotoFile.OpenReadStream(2 * 1024 * 1024);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    var extension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
                    var result = await StorageService.SaveEmpleadoFotoAsync(empleado.Id, ms.ToArray(), extension);
                    
                    if (result.IsSuccess)
                    {
                        empleado.FotoPath = result.Value;
                        await EmpleadoRepo.UpdateAsync(empleado);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error guardando foto");
                }
            }
            
            // 6. Subir documentos obligatorios (MOVIDO AL MÓDULO DE DOCUMENTOS)
            var docsSubidos = 0;
            foreach (var doc in documentosObligatorios.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            
            // 7. Subir documentos opcionales (MOVIDO AL MÓDULO DE DOCUMENTOS)
            foreach (var doc in documentosOpcionales.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            */
            
            Logger.LogInformation("Empleado creado: {Codigo}", empleado.Codigo);
            
            // Mensaje según estado
            if (empleado.Estado == EstadoEmpleado.PendienteAprobacion)
            {
                messageToast?.ShowSuccess($"Empleado {empleado.Codigo} registrado. PENDIENTE DE APROBACIÓN por un Aprobador o Administrador.");
            }
            else
            {
                messageToast?.ShowSuccess($"Empleado {empleado.Codigo} creado y ACTIVO. Puede cargar documentos desde el módulo de Documentos.");
            }
            
            await Task.Delay(1500);
            Navigation.NavigateTo($"/documentos/{empleado.Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error en onboarding");
            var mensaje = ErrorTranslationService.Translate(ex);
            messageToast?.ShowError(mensaje);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task SubirDocumento(int empleadoId, DocumentoUpload doc)
    {
        if (doc.Archivo == null) return;
        
        using var stream = doc.Archivo.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        
        var storageResult = await StorageService.SaveDocumentoEmpleadoAsync(
            empleadoId,
            doc.NombreTipo,
            ms.ToArray(),
            doc.Archivo.Name
        );
        
        if (storageResult.IsSuccess)
        {
            var documento = new DocumentoEmpleado
            {
                EmpleadoId = empleadoId,
                TipoDocumento = doc.Tipo,
                Nombre = doc.Nombre,
                NombreArchivoOriginal = doc.Archivo.Name,
                TipoMime = doc.Archivo.ContentType,
                TamanoArchivo = doc.Archivo.Size,
                FechaEmision = doc.FechaEmision,
                FechaVencimiento = doc.FechaVencimiento,
                SubidoPorNombre = AuthService.CurrentUser?.NombreCompleto,
                SubidoPorUsuarioId = AuthService.CurrentUser?.Id,
                ArchivoPath = storageResult.Value,
                Activo = true,
                FechaCreacion = DateTime.Now
            };
            
            await DocumentoRepo.AddAsync(documento);
            doc.Subido = true;
        }
    }
    
    // Renders de cada paso
    private RenderFragment RenderStep1DatosBasicos() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 1: DATOS BASICOS DEL EMPLEADO</div>
            <div class="hospital-step-instructions">
                Complete la informacion personal y laboral. Los campos con * son obligatorios.
            </div>
            
            <!-- SECCION: DATOS GENERALES -->
            <div class="hospital-section">
                <div class="hospital-section-header">DATOS GENERALES</div>
                <div class="hospital-section-body">
                    @* FOTO DEL EMPLEADO - Movida al módulo de Documentos *@
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CODIGO *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Codigo" maxlength="20" readonly />
                            <div class="hospital-field-hint">Codigo automatico asignado</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CEDULA *</label>
                            <InputCedula @bind-Value="empleado.Cedula" CssClass="hospital-input" Placeholder="Ej: 1.192.208.848" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">NOMBRES *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Nombres" maxlength="100" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">APELLIDOS *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Apellidos" maxlength="100" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">FECHA NACIMIENTO *</label>
                            <input type="date" class="hospital-input" @bind="empleado.FechaNacimiento" />
                            @if (empleado.FechaNacimiento.HasValue)
                            {
                                var edad = CalcularEdad(empleado.FechaNacimiento.Value);
                                <div class="hospital-field-hint">Edad: @edad años</div>
                            }
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">GENERO *</label>
                            <select class="hospital-input" @bind="empleado.Genero">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var g in Enum.GetValues<Genero>())
                                {
                                    <option value="@g">@g.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">ESTADO CIVIL</label>
                            <select class="hospital-input" @bind="empleado.EstadoCivil">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var ec in Enum.GetValues<EstadoCivil>())
                                {
                                    <option value="@ec">@ec.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <!-- Este campo se movió a la sección Dirección Residencia -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: INFORMACION LABORAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">INFORMACION LABORAL</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">FECHA INGRESO *</label>
                            <input type="date" class="hospital-input" @bind="empleado.FechaIngreso" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">DEPARTAMENTO *</label>
                            <select class="hospital-input" @onchange="OnDepartamentoChanged">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var d in departamentos)
                                {
                                    <option value="@d.Id" selected="@(empleado.DepartamentoId == d.Id)">@d.Nombre</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CARGO *</label>
                            <select class="hospital-input" @bind="empleado.CargoId" @bind:after="OnCargoChanged" disabled="@(!empleado.DepartamentoId.HasValue)">
                                <option value="">@(empleado.DepartamentoId.HasValue ? "-- SELECCIONE CARGO --" : "-- PRIMERO SELECCIONE DEPARTAMENTO --")</option>
                                @foreach (var c in CargosFiltrados)
                                {
                                    <option value="@c.Id">@c.Nombre @(c.SalarioBase.HasValue ? $"(${c.SalarioBase.Value:N0})" : "")</option>
                                }
                            </select>
                            @if (empleado.DepartamentoId.HasValue && !CargosFiltrados.Any())
                            {
                                <div class="hospital-field-hint" style="color: #FF9900;">No hay cargos asociados a este departamento</div>
                            }
                            @if (empleado.CargoId.HasValue)
                            {
                                var cargoSel = cargos.FirstOrDefault(c => c.Id == empleado.CargoId);
                                if (cargoSel?.SalarioBase.HasValue == true)
                                {
                                    <div class="hospital-field-hint">Salario sugerido: $@cargoSel.SalarioBase.Value.ToString("N0")</div>
                                }
                            }
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">ESTADO INICIAL</label>
                            <input type="text" 
                                   class="hospital-input" 
                                   value="@EstadoEmpleadoService.ObtenerDescripcion(empleado.Estado)" 
                                   readonly 
                                   style="background-color: #f0f0f0; color: @EstadoEmpleadoService.ObtenerColorCss(empleado.Estado); font-weight: bold;" />
                            <div class="hospital-field-hint">
                                @if (esOperador)
                                {
                                    <span>Los empleados creados por Operadores quedan pendientes de aprobación</span>
                                }
                                else
                                {
                                    <span>Los empleados creados por Aprobadores/Admins quedan activos inmediatamente</span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">SALARIO BASE *</label>
                            <InputMoneda @bind-Value="empleado.SalarioBase" CssClass="hospital-input" Placeholder="Ej: 1.750.905" />
                            <div class="hospital-field-hint">
                                Salario mínimo Colombia 2026: @NumberFormatHelper.FormatearMoneda(1750905m)
                                @if (empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905)
                                {
                                    <span style="color: #CC0000;"> - ¡ATENCIÓN: MENOR AL SALARIO MÍNIMO!</span>
                                }
                            </div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <!-- Espacio vacío para mantener la cuadrícula -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: SEGURIDAD SOCIAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">SEGURIDAD SOCIAL (COLOMBIA) - OBLIGATORIO</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">EPS (SALUD) *</label>
                            <select class="hospital-input" @onchange="OnEpsChanged">
                                <option value="">-- SELECCIONE EPS --</option>
                                @foreach (var eps in epsLista)
                                {
                                    <option value="@eps.Id" selected="@(epsIdSeleccionado == eps.Id)">@eps.Nombre</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO EPS</label>
                            <input type="text" class="hospital-input" value="@empleado.CodigoEPS" readonly style="background-color: #f0f0f0;" />
                            <div class="hospital-field-hint">Autocompletado</div>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">AFP (PENSION) *</label>
                            <select class="hospital-input" @onchange="OnAfpChanged">
                                <option value="">-- SELECCIONE AFP --</option>
                                @foreach (var afp in afpLista)
                                {
                                    <option value="@afp.Id" selected="@(afpIdSeleccionado == afp.Id)">@afp.Nombre</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO AFP</label>
                            <input type="text" class="hospital-input" value="@empleado.CodigoAFP" readonly style="background-color: #f0f0f0;" />
                            <div class="hospital-field-hint">Autocompletado</div>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">ARL (RIESGOS LABORALES) *</label>
                            <select class="hospital-input" @onchange="OnArlChanged">
                                <option value="">-- SELECCIONE ARL --</option>
                                @foreach (var arl in arlLista)
                                {
                                    <option value="@arl.Id" selected="@(arlIdSeleccionado == arl.Id)">@arl.Nombre</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO ARL</label>
                            <input type="text" class="hospital-input" value="@empleado.CodigoARL" readonly style="background-color: #f0f0f0;" />
                            <div class="hospital-field-hint">Autocompletado</div>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CLASE DE RIESGO ARL *</label>
                            <select class="hospital-input" @bind="empleado.ClaseRiesgoARL">
                                <option value="1">CLASE I - Riesgo Mínimo (0.522%)</option>
                                <option value="2">CLASE II - Riesgo Bajo (1.044%)</option>
                                <option value="3">CLASE III - Riesgo Medio (2.436%)</option>
                                <option value="4">CLASE IV - Riesgo Alto (4.350%)</option>
                                <option value="5">CLASE V - Riesgo Máximo (6.960%)</option>
                            </select>
                            <div class="hospital-field-hint">Silvicultura generalmente es Clase IV o V</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <!-- Espacio vacío -->
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CAJA DE COMPENSACION *</label>
                            <select class="hospital-input" @onchange="OnCajaChanged">
                                <option value="">-- SELECCIONE CAJA --</option>
                                @foreach (var caja in cajasLista)
                                {
                                    <option value="@caja.Id" selected="@(cajaIdSeleccionado == caja.Id)">@caja.Nombre (@caja.Region)</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO CAJA COMPENSACION</label>
                            <input type="text" class="hospital-input" value="@empleado.CodigoCajaCompensacion" readonly style="background-color: #f0f0f0;" />
                            <div class="hospital-field-hint">Autocompletado</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO EXPANDIDO -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">TELEFONO CELULAR *</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoCelular" maxlength="20" placeholder="Ej: 3101234567" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO FIJO</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoFijo" maxlength="20" placeholder="Ej: 6012345678" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">WHATSAPP</label>
                            <input type="text" class="hospital-input" @bind="empleado.Whatsapp" maxlength="20" placeholder="Si es diferente al celular" />
                            <div class="hospital-field-hint">Dejar vacío si es igual al celular</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">EMAIL</label>
                            <input type="email" class="hospital-input" @bind="empleado.Email" maxlength="100" placeholder="correo@ejemplo.com" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: DIRECCION RESIDENCIA -->
            <div class="hospital-section">
                <div class="hospital-section-header">DIRECCION RESIDENCIA</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field hospital-form-field-full">
                            <label class="hospital-label required">DIRECCION *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Direccion" maxlength="250" placeholder="Calle/Carrera/Vereda + número" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">MUNICIPIO/CIUDAD *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Municipio" maxlength="100" placeholder="Ej: Medellín, Puerto Berrío" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">BARRIO/VEREDA</label>
                            <input type="text" class="hospital-input" @bind="empleado.Barrio" maxlength="100" placeholder="Nombre del barrio o vereda" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: INFORMACION MEDICA (EMERGENCIAS) -->
            <div class="hospital-section">
                <div class="hospital-section-header">INFORMACION MEDICA (EMERGENCIAS)</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">TIPO DE SANGRE (RH) *</label>
                            <select class="hospital-input" @bind="empleado.TipoSangre">
                                <option value="">-- SELECCIONE --</option>
                                <option value="A+">A POSITIVO (A+)</option>
                                <option value="A-">A NEGATIVO (A-)</option>
                                <option value="B+">B POSITIVO (B+)</option>
                                <option value="B-">B NEGATIVO (B-)</option>
                                <option value="O+">O POSITIVO (O+)</option>
                                <option value="O-">O NEGATIVO (O-)</option>
                                <option value="AB+">AB POSITIVO (AB+)</option>
                                <option value="AB-">AB NEGATIVO (AB-)</option>
                            </select>
                            <div class="hospital-field-hint">CRÍTICO para emergencias en campo</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">ALERGIAS CONOCIDAS</label>
                            <input type="text" class="hospital-input" @bind="empleado.Alergias" maxlength="250" placeholder="Medicamentos, alimentos, picaduras..." />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">CONDICIONES MEDICAS</label>
                            <input type="text" class="hospital-input" @bind="empleado.CondicionesMedicas" maxlength="250" placeholder="Diabetes, hipertensión, epilepsia..." />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">MEDICAMENTOS ACTUALES</label>
                            <input type="text" class="hospital-input" @bind="empleado.MedicamentosActuales" maxlength="250" placeholder="Medicamentos que toma regularmente" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO DE EMERGENCIA #1 -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO DE EMERGENCIA #1 (OBLIGATORIO)</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">NOMBRE COMPLETO *</label>
                            <input type="text" class="hospital-input" @bind="empleado.ContactoEmergencia" maxlength="100" placeholder="Nombre y apellido del contacto" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">PARENTESCO *</label>
                            <select class="hospital-input" @bind="empleado.ParentescoContactoEmergencia">
                                <option value="">-- SELECCIONE --</option>
                                <option value="Esposo(a)">ESPOSO(A)</option>
                                <option value="Compañero(a)">COMPAÑERO(A) PERMANENTE</option>
                                <option value="Padre">PADRE</option>
                                <option value="Madre">MADRE</option>
                                <option value="Hijo(a)">HIJO(A)</option>
                                <option value="Hermano(a)">HERMANO(A)</option>
                                <option value="Tío(a)">TIO(A)</option>
                                <option value="Abuelo(a)">ABUELO(A)</option>
                                <option value="Suegro(a)">SUEGRO(A)</option>
                                <option value="Cuñado(a)">CUÑADO(A)</option>
                                <option value="Primo(a)">PRIMO(A)</option>
                                <option value="Amigo(a)">AMIGO(A)</option>
                                <option value="Vecino(a)">VECINO(A)</option>
                                <option value="Otro">OTRO</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">TELEFONO 1 *</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoEmergencia" maxlength="20" placeholder="Número principal" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO 2</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoEmergencia2" maxlength="20" placeholder="Número alternativo (opcional)" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO DE EMERGENCIA #2 (OPCIONAL) -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO DE EMERGENCIA #2 (OPCIONAL)</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">NOMBRE COMPLETO</label>
                            <input type="text" class="hospital-input" @bind="empleado.ContactoEmergencia2" maxlength="100" placeholder="Nombre y apellido del segundo contacto" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">PARENTESCO</label>
                            <select class="hospital-input" @bind="empleado.ParentescoContactoEmergencia2">
                                <option value="">-- SELECCIONE --</option>
                                <option value="Esposo(a)">ESPOSO(A)</option>
                                <option value="Compañero(a)">COMPAÑERO(A) PERMANENTE</option>
                                <option value="Padre">PADRE</option>
                                <option value="Madre">MADRE</option>
                                <option value="Hijo(a)">HIJO(A)</option>
                                <option value="Hermano(a)">HERMANO(A)</option>
                                <option value="Tío(a)">TIO(A)</option>
                                <option value="Abuelo(a)">ABUELO(A)</option>
                                <option value="Suegro(a)">SUEGRO(A)</option>
                                <option value="Cuñado(a)">CUÑADO(A)</option>
                                <option value="Primo(a)">PRIMO(A)</option>
                                <option value="Amigo(a)">AMIGO(A)</option>
                                <option value="Vecino(a)">VECINO(A)</option>
                                <option value="Otro">OTRO</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO 1</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoEmergencia2Contacto2" maxlength="20" placeholder="Número principal" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO 2</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoEmergencia2Alternativo" maxlength="20" placeholder="Número alternativo" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: OBSERVACIONES -->
            <div class="hospital-section">
                <div class="hospital-section-header">OBSERVACIONES GENERALES</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field hospital-form-field-full">
                            <label class="hospital-label">OBSERVACIONES</label>
                            <textarea class="hospital-input hospital-textarea" 
                                      @bind="empleado.Observaciones" 
                                      maxlength="500"
                                      rows="3"
                                      placeholder="Notas adicionales sobre el empleado..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };
    
    private RenderFragment RenderStep2DocumentosObligatorios() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 2: DOCUMENTOS OBLIGATORIOS</div>
            <div class="hospital-step-instructions">
                Suba los 17 documentos obligatorios segun legislacion colombiana. Puede omitir documentos y subirlos posteriormente.
            </div>
            
            <div class="hospital-docs-counter">
                DOCUMENTOS SELECCIONADOS: @documentosObligatorios.Count(d => d.Archivo != null) DE @documentosObligatorios.Count
            </div>
            
            <table class="hospital-table">
                <thead>
                    <tr>
                        <th>DOCUMENTO</th>
                        <th>ARCHIVO</th>
                        <th>FECHA EMISION</th>
                        <th>FECHA VENCIMIENTO</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var doc in documentosObligatorios)
                    {
                        <tr>
                            <td><strong>@doc.NombreTipo</strong></td>
                            <td>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                              class="hospital-file-input" style="flex: 1;" />
                                    <button type="button" class="hospital-btn-sm" @onclick="() => AbrirScannerParaDocumento(doc)">ESCANEAR</button>
                                </div>
                                @if (doc.Archivo != null)
                                {
                                    <div class="hospital-file-name">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</div>
                                }
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaEmision" />
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaVencimiento" />
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <span class="hospital-status-ok">SELECCIONADO</span>
                                }
                                else
                                {
                                    <span class="hospital-status-pending">PENDIENTE</span>
                                }
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <button type="button" class="hospital-btn-sm" @onclick="() => PrevisualizarDocumento(doc)">VER</button>
                                    <button type="button" class="hospital-btn-sm hospital-btn-danger-sm" @onclick="() => QuitarDocumento(doc)">QUITAR</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div class="hospital-info-box">
                No es obligatorio subir todos los documentos ahora. Puede continuar y subirlos posteriormente desde el modulo de Documentos.
            </div>
        </div>
    };
    
    private RenderFragment RenderStep3DocumentosOpcionales() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 3: DOCUMENTOS OPCIONALES</div>
            <div class="hospital-step-instructions">
                Suba documentos adicionales segun el cargo. Estos documentos son completamente opcionales.
            </div>
            
            <div class="hospital-docs-counter">
                DOCUMENTOS SELECCIONADOS: @documentosOpcionales.Count(d => d.Archivo != null)
            </div>
            
            <table class="hospital-table">
                <thead>
                    <tr>
                        <th>DOCUMENTO</th>
                        <th>ARCHIVO</th>
                        <th>FECHA EMISION</th>
                        <th>FECHA VENCIMIENTO</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var doc in documentosOpcionales)
                    {
                        <tr>
                            <td><strong>@doc.NombreTipo</strong></td>
                            <td>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                              class="hospital-file-input" style="flex: 1;" />
                                    <button type="button" class="hospital-btn-sm" @onclick="() => AbrirScannerParaDocumento(doc)">ESCANEAR</button>
                                </div>
                                @if (doc.Archivo != null)
                                {
                                    <div class="hospital-file-name">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</div>
                                }
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaEmision" />
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaVencimiento" />
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <span class="hospital-status-ok">SELECCIONADO</span>
                                }
                                else
                                {
                                    <span class="hospital-status-pending">PENDIENTE</span>
                                }
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <button type="button" class="hospital-btn-sm" @onclick="() => PrevisualizarDocumento(doc)">VER</button>
                                    <button type="button" class="hospital-btn-sm hospital-btn-danger-sm" @onclick="() => QuitarDocumento(doc)">QUITAR</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    };
    
    private RenderFragment RenderStep4Revisar() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 2: REVISAR Y CONFIRMAR</div>
            <div class="hospital-step-instructions">
                Revise la informacion antes de crear el empleado. Los documentos y foto podra subirlos posteriormente desde el modulo de Documentos.
            </div>
            
            <!-- SECCION: DATOS PERSONALES -->
            <div class="hospital-section">
                <div class="hospital-section-header">DATOS PERSONALES</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">CODIGO:</td>
                            <td class="hospital-review-value">@empleado.Codigo</td>
                            <td class="hospital-review-label">CEDULA:</td>
                            <td class="hospital-review-value">@NumberFormatHelper.FormatearCedula(empleado.Cedula)</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">NOMBRES:</td>
                            <td class="hospital-review-value">@empleado.Nombres</td>
                            <td class="hospital-review-label">APELLIDOS:</td>
                            <td class="hospital-review-value">@empleado.Apellidos</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">FECHA NACIMIENTO:</td>
                            <td class="hospital-review-value">@(empleado.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "NO ESPECIFICADA")</td>
                            <td class="hospital-review-label">GENERO:</td>
                            <td class="hospital-review-value">@(empleado.Genero?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">ESTADO CIVIL:</td>
                            <td class="hospital-review-value">@(empleado.EstadoCivil?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TIPO DE SANGRE:</td>
                            <td class="hospital-review-value" style="font-weight: bold; color: #CC0000;">@(empleado.TipoSangre ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: INFORMACIÓN LABORAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">INFORMACION LABORAL</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">FECHA INGRESO:</td>
                            <td class="hospital-review-value">@empleado.FechaIngreso.ToString("dd/MM/yyyy")</td>
                            <td class="hospital-review-label">ESTADO:</td>
                            <td class="hospital-review-value">@empleado.Estado.ToString().ToUpper()</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">DEPARTAMENTO:</td>
                            <td class="hospital-review-value">@(departamentos.FirstOrDefault(d => d.Id == empleado.DepartamentoId)?.Nombre ?? "NO ASIGNADO")</td>
                            <td class="hospital-review-label">CARGO:</td>
                            <td class="hospital-review-value">@(cargos.FirstOrDefault(c => c.Id == empleado.CargoId)?.Nombre ?? "NO ASIGNADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">SALARIO BASE:</td>
                            <td class="hospital-review-value" style="@(empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905 ? "color: #CC0000; font-weight: bold;" : "")">
                                @(empleado.SalarioBase.HasValue ? $"${empleado.SalarioBase.Value:N0}" : "NO ESPECIFICADO")
                                @if (empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905)
                                {
                                    <span> (MENOR AL SMMLV)</span>
                                }
                            </td>
                            <td class="hospital-review-label"></td>
                            <td class="hospital-review-value"></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: SEGURIDAD SOCIAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">SEGURIDAD SOCIAL</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">EPS:</td>
                            <td class="hospital-review-value">@(empleado.EPS ?? "NO ESPECIFICADO") @(string.IsNullOrEmpty(empleado.CodigoEPS) ? "" : $"({empleado.CodigoEPS})")</td>
                            <td class="hospital-review-label">AFP:</td>
                            <td class="hospital-review-value">@(empleado.AFP ?? "NO ESPECIFICADO") @(string.IsNullOrEmpty(empleado.CodigoAFP) ? "" : $"({empleado.CodigoAFP})")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">ARL:</td>
                            <td class="hospital-review-value">@(empleado.ARL ?? "NO ESPECIFICADO") (Clase @empleado.ClaseRiesgoARL)</td>
                            <td class="hospital-review-label">CAJA COMPENSACION:</td>
                            <td class="hospital-review-value">@(empleado.CajaCompensacion ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO Y UBICACIÓN -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO Y UBICACION</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">CELULAR:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoCelular ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TELEFONO FIJO:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoFijo ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">WHATSAPP:</td>
                            <td class="hospital-review-value">@(string.IsNullOrEmpty(empleado.Whatsapp) ? "(Igual al celular)" : empleado.Whatsapp)</td>
                            <td class="hospital-review-label">EMAIL:</td>
                            <td class="hospital-review-value">@(empleado.Email ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">DIRECCION:</td>
                            <td class="hospital-review-value" colspan="3">@(empleado.Direccion ?? "NO ESPECIFICADA")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">MUNICIPIO:</td>
                            <td class="hospital-review-value">@(empleado.Municipio ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">BARRIO/VEREDA:</td>
                            <td class="hospital-review-value">@(empleado.Barrio ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: INFORMACIÓN MÉDICA -->
            @if (!string.IsNullOrEmpty(empleado.Alergias) || !string.IsNullOrEmpty(empleado.CondicionesMedicas) || !string.IsNullOrEmpty(empleado.MedicamentosActuales))
            {
                <div class="hospital-section">
                    <div class="hospital-section-header">INFORMACION MEDICA</div>
                    <div class="hospital-section-body">
                        <table class="hospital-review-table">
                            @if (!string.IsNullOrEmpty(empleado.Alergias))
                            {
                                <tr>
                                    <td class="hospital-review-label">ALERGIAS:</td>
                                    <td class="hospital-review-value" colspan="3" style="color: #CC0000;">@empleado.Alergias</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(empleado.CondicionesMedicas))
                            {
                                <tr>
                                    <td class="hospital-review-label">CONDICIONES:</td>
                                    <td class="hospital-review-value" colspan="3">@empleado.CondicionesMedicas</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(empleado.MedicamentosActuales))
                            {
                                <tr>
                                    <td class="hospital-review-label">MEDICAMENTOS:</td>
                                    <td class="hospital-review-value" colspan="3">@empleado.MedicamentosActuales</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            }
            
            <!-- SECCION: CONTACTOS DE EMERGENCIA -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTOS DE EMERGENCIA</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label" colspan="4" style="font-weight: bold; background-color: #f0f0f0;">CONTACTO #1 (PRINCIPAL)</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">NOMBRE:</td>
                            <td class="hospital-review-value">@(empleado.ContactoEmergencia ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">PARENTESCO:</td>
                            <td class="hospital-review-value">@(empleado.ParentescoContactoEmergencia ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">TELEFONO 1:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoEmergencia ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TELEFONO 2:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoEmergencia2 ?? "NO ESPECIFICADO")</td>
                        </tr>
                        @if (!string.IsNullOrEmpty(empleado.ContactoEmergencia2))
                        {
                            <tr>
                                <td class="hospital-review-label" colspan="4" style="font-weight: bold; background-color: #f0f0f0;">CONTACTO #2 (SECUNDARIO)</td>
                            </tr>
                            <tr>
                                <td class="hospital-review-label">NOMBRE:</td>
                                <td class="hospital-review-value">@empleado.ContactoEmergencia2</td>
                                <td class="hospital-review-label">PARENTESCO:</td>
                                <td class="hospital-review-value">@(empleado.ParentescoContactoEmergencia2 ?? "NO ESPECIFICADO")</td>
                            </tr>
                            <tr>
                                <td class="hospital-review-label">TELEFONO 1:</td>
                                <td class="hospital-review-value">@(empleado.TelefonoEmergencia2Contacto2 ?? "NO ESPECIFICADO")</td>
                                <td class="hospital-review-label">TELEFONO 2:</td>
                                <td class="hospital-review-value">@(empleado.TelefonoEmergencia2Alternativo ?? "NO ESPECIFICADO")</td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
            
            <!-- NOTA SOBRE DOCUMENTOS -->
            <div class="hospital-info-box" style="margin-top: 20px;">
                <strong>NOTA:</strong> Los documentos del empleado (fotocopia de cedula, certificaciones, foto, etc.) 
                podran ser cargados desde el modulo de <strong>DOCUMENTOS</strong> una vez creado el empleado.
            </div>
            
            <div class="hospital-confirm-box">
                Al hacer clic en GUARDAR se creara el registro del empleado.
            </div>
        </div>
    };
    
    // Event Handlers
    
    /// <summary>
    /// Obtiene los cargos filtrados por el departamento seleccionado.
    /// Si no hay departamento seleccionado, no muestra cargos.
    /// </summary>
    private IEnumerable<Cargo> CargosFiltrados => empleado.DepartamentoId.HasValue 
        ? cargos.Where(c => c.DepartamentoId == empleado.DepartamentoId.Value)
        : Enumerable.Empty<Cargo>();
    
    /// <summary>
    /// Se ejecuta cuando se cambia el departamento seleccionado.
    /// Limpia el cargo seleccionado ya que pertenece al departamento anterior.
    /// </summary>
    private void OnDepartamentoChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int deptoId) && deptoId > 0)
        {
            empleado.DepartamentoId = deptoId;
        }
        else
        {
            empleado.DepartamentoId = null;
        }
        
        // Limpiar cargo y salario porque pertenecen al departamento anterior
        empleado.CargoId = null;
        empleado.SalarioBase = null;
        
        StateHasChanged();
    }
    
    /// <summary>
    /// Se ejecuta cuando se cambia el cargo seleccionado.
    /// Copia el salario base del cargo al empleado automáticamente.
    /// </summary>
    private void OnCargoChanged()
    {
        if (empleado.CargoId.HasValue)
        {
            var cargoSeleccionado = cargos.FirstOrDefault(c => c.Id == empleado.CargoId);
            if (cargoSeleccionado?.SalarioBase.HasValue == true)
            {
                empleado.SalarioBase = cargoSeleccionado.SalarioBase;
                Logger.LogInformation("Salario del cargo '{Cargo}' asignado al empleado: {Salario}", 
                    cargoSeleccionado.Nombre, cargoSeleccionado.SalarioBase);
            }
        }
        StateHasChanged();
    }
    
    private async Task OnFotoSelected(InputFileChangeEventArgs e)
    {
        fotoFile = e.File;
        
        if (fotoFile != null)
        {
            // Validar tamaño (max 5MB)
            if (fotoFile.Size > 5 * 1024 * 1024)
            {
                messageToast?.ShowError("La imagen no puede superar 5MB");
                fotoFile = null;
                return;
            }
            
            try
            {
                using var stream = fotoFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                fotoPreviewUrl = $"data:{fotoFile.ContentType};base64,{base64}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error cargando foto");
                messageToast?.ShowError("Error al cargar foto");
            }
        }
    }
    
    private void OnDocumentoSelected(InputFileChangeEventArgs e, DocumentoUpload doc)
    {
        doc.Archivo = e.File;
        doc.ArchivoNombre = e.File.Name;
        StateHasChanged();
    }
    
    // Previsualización de documentos
    private async Task PrevisualizarDocumento(DocumentoUpload doc)
    {
        if (doc.Archivo == null) return;
        
        try
        {
            previewDoc = doc;
            previewUrl = null;
            showPreviewModal = true;
            StateHasChanged();
            
            // Leer el archivo y crear data URL
            using var stream = doc.Archivo.OpenReadStream(10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            previewUrl = $"data:{doc.Archivo.ContentType};base64,{base64}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error previsualizando documento");
            messageToast?.ShowError("Error al cargar vista previa");
            CerrarPreview();
        }
    }
    
    private void CerrarPreview()
    {
        showPreviewModal = false;
        previewDoc = null;
        previewUrl = null;
    }
    
    private bool IsPreviewableImage(string? contentType)
    {
        if (string.IsNullOrEmpty(contentType)) return false;
        return contentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase);
    }
    
    private void QuitarDocumento(DocumentoUpload doc)
    {
        doc.Archivo = null;
        doc.ArchivoNombre = null;
        StateHasChanged();
    }
    
    // Helpers
    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var hoy = DateTime.Today;
        var edad = hoy.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > hoy.AddYears(-edad))
            edad--;
        return edad;
    }
    
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var años = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-años))
            años--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            años--;
            meses += 12;
        }
        
        if (años > 0 && meses > 0)
            return $"{años} año(s) {meses} mes(es)";
        else if (años > 0)
            return $"{años} año(s)";
        else
            return $"{meses} mes(es)";
    }
    
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    // ===== MÉTODOS DEL SCANNER =====
    
    private void AbrirScannerParaDocumento(DocumentoUpload doc)
    {
        documentoParaEscanear = doc;
        mostrarScannerModal = true;
    }
    
    private void OnScanComplete(List<ScannedPageDto> pages)
    {
        if (pages.Count == 0)
        {
            Logger.LogWarning("OnScanComplete: No hay páginas escaneadas");
            mostrarScannerModal = false;
            StateHasChanged();
            return;
        }
        
        if (documentoParaEscanear != null)
        {
            // Si hay múltiples páginas, combinarlas en un PDF internamente sería ideal,
            // pero por ahora tomamos la primera página como imagen
            var page = pages[0];
            var extension = page.MimeType.Contains("png") ? ".png" : ".jpg";
            var fileName = $"{documentoParaEscanear.NombreTipo.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}{extension}";
            
            documentoParaEscanear.Archivo = new ScannedBrowserFile(page.ImageBytes, fileName, page.MimeType);
            documentoParaEscanear.ArchivoNombre = fileName;
            
            Logger.LogInformation($"Imagen escaneada asignada a documento: {fileName} ({page.ImageBytes.Length} bytes)");
            messageToast?.ShowSuccess($"✓ Imagen escaneada asignada a '{documentoParaEscanear.NombreTipo}'");
        }
        else
        {
            Logger.LogWarning("OnScanComplete: No hay documento destino asignado");
        }
        
        mostrarScannerModal = false;
        documentoParaEscanear = null;
        StateHasChanged();
    }
    
    private void OnPdfGenerated(byte[] pdfBytes)
    {
        if (documentoParaEscanear != null)
        {
            // Crear un IBrowserFile simulado desde los bytes del PDF
            var fileName = $"{documentoParaEscanear.NombreTipo.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            documentoParaEscanear.Archivo = new ScannedBrowserFile(pdfBytes, fileName, "application/pdf");
            documentoParaEscanear.ArchivoNombre = fileName;
            Logger.LogInformation($"PDF escaneado asignado: {fileName} ({pdfBytes.Length} bytes)");
            
            // Mostrar confirmación visual
            messageToast?.ShowSuccess($"✓ PDF guardado: '{documentoParaEscanear.NombreTipo}'");
        }
        mostrarScannerModal = false;
        documentoParaEscanear = null;
        StateHasChanged();
    }
    
    // ===== EVENTOS DE SEGURIDAD SOCIAL =====
    
    private void OnEpsChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int epsId) && epsId > 0)
        {
            var eps = epsLista.FirstOrDefault(x => x.Id == epsId);
            if (eps != null)
            {
                empleado.EPS = eps.Nombre;
                empleado.CodigoEPS = eps.Codigo;
                epsIdSeleccionado = epsId;
            }
        }
        else
        {
            empleado.EPS = null;
            empleado.CodigoEPS = null;
            epsIdSeleccionado = null;
        }
        StateHasChanged();
    }
    
    private void OnAfpChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int afpId) && afpId > 0)
        {
            var afp = afpLista.FirstOrDefault(x => x.Id == afpId);
            if (afp != null)
            {
                empleado.AFP = afp.Nombre;
                empleado.CodigoAFP = afp.Codigo;
                afpIdSeleccionado = afpId;
            }
        }
        else
        {
            empleado.AFP = null;
            empleado.CodigoAFP = null;
            afpIdSeleccionado = null;
        }
        StateHasChanged();
    }
    
    private void OnArlChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int arlId) && arlId > 0)
        {
            var arl = arlLista.FirstOrDefault(x => x.Id == arlId);
            if (arl != null)
            {
                empleado.ARL = arl.Nombre;
                empleado.CodigoARL = arl.Codigo;
                arlIdSeleccionado = arlId;
            }
        }
        else
        {
            empleado.ARL = null;
            empleado.CodigoARL = null;
            arlIdSeleccionado = null;
        }
        StateHasChanged();
    }
    
    private void OnCajaChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int cajaId) && cajaId > 0)
        {
            var caja = cajasLista.FirstOrDefault(x => x.Id == cajaId);
            if (caja != null)
            {
                empleado.CajaCompensacion = caja.Nombre;
                empleado.CodigoCajaCompensacion = caja.Codigo;
                cajaIdSeleccionado = cajaId;
            }
        }
        else
        {
            empleado.CajaCompensacion = null;
            empleado.CodigoCajaCompensacion = null;
            cajaIdSeleccionado = null;
        }
        StateHasChanged();
    }
    
    /// <summary>
    /// Convierte todos los campos de texto del empleado a mayúsculas.
    /// El email se excluye porque debe mantener su formato estándar.
    /// </summary>
    private void ConvertirCamposAMayusculas()
    {
        // Datos personales
        empleado.Codigo = empleado.Codigo?.ToUpperInvariant();
        empleado.Cedula = empleado.Cedula?.ToUpperInvariant();
        empleado.Nombres = empleado.Nombres?.ToUpperInvariant();
        empleado.Apellidos = empleado.Apellidos?.ToUpperInvariant();
        
        // Contacto (excepto email que mantiene su formato)
        empleado.TelefonoCelular = empleado.TelefonoCelular?.ToUpperInvariant();
        empleado.TelefonoFijo = empleado.TelefonoFijo?.ToUpperInvariant();
        empleado.Whatsapp = empleado.Whatsapp?.ToUpperInvariant();
        // empleado.Email NO se convierte - debe mantener formato estándar
        
        // Dirección
        empleado.Direccion = empleado.Direccion?.ToUpperInvariant();
        empleado.Municipio = empleado.Municipio?.ToUpperInvariant();
        empleado.Barrio = empleado.Barrio?.ToUpperInvariant();
        
        // Información médica
        empleado.TipoSangre = empleado.TipoSangre?.ToUpperInvariant();
        empleado.Alergias = empleado.Alergias?.ToUpperInvariant();
        empleado.CondicionesMedicas = empleado.CondicionesMedicas?.ToUpperInvariant();
        empleado.MedicamentosActuales = empleado.MedicamentosActuales?.ToUpperInvariant();
        
        // Contacto de emergencia #1
        empleado.ContactoEmergencia = empleado.ContactoEmergencia?.ToUpperInvariant();
        empleado.ParentescoContactoEmergencia = empleado.ParentescoContactoEmergencia?.ToUpperInvariant();
        empleado.TelefonoEmergencia = empleado.TelefonoEmergencia?.ToUpperInvariant();
        empleado.TelefonoEmergencia2 = empleado.TelefonoEmergencia2?.ToUpperInvariant();
        
        // Contacto de emergencia #2
        empleado.ContactoEmergencia2 = empleado.ContactoEmergencia2?.ToUpperInvariant();
        empleado.ParentescoContactoEmergencia2 = empleado.ParentescoContactoEmergencia2?.ToUpperInvariant();
        empleado.TelefonoEmergencia2Contacto2 = empleado.TelefonoEmergencia2Contacto2?.ToUpperInvariant();
        empleado.TelefonoEmergencia2Alternativo = empleado.TelefonoEmergencia2Alternativo?.ToUpperInvariant();
        
        // Observaciones
        empleado.Observaciones = empleado.Observaciones?.ToUpperInvariant();
        
        // Seguridad social (nombres, no códigos)
        empleado.EPS = empleado.EPS?.ToUpperInvariant();
        empleado.AFP = empleado.AFP?.ToUpperInvariant();
        empleado.ARL = empleado.ARL?.ToUpperInvariant();
        empleado.CajaCompensacion = empleado.CajaCompensacion?.ToUpperInvariant();
        empleado.CodigoEPS = empleado.CodigoEPS?.ToUpperInvariant();
        empleado.CodigoAFP = empleado.CodigoAFP?.ToUpperInvariant();
        empleado.CodigoARL = empleado.CodigoARL?.ToUpperInvariant();
        empleado.CodigoCajaCompensacion = empleado.CodigoCajaCompensacion?.ToUpperInvariant();
    }
    
    /// <summary>
    /// Implementación simple de IBrowserFile para documentos escaneados
    /// </summary>
    private class ScannedBrowserFile : IBrowserFile
    {
        private readonly byte[] _bytes;
        public ScannedBrowserFile(byte[] bytes, string name, string contentType)
        {
            _bytes = bytes;
            Name = name;
            ContentType = contentType;
            Size = bytes.Length;
            LastModified = DateTimeOffset.Now;
        }
        
        public string Name { get; }
        public DateTimeOffset LastModified { get; }
        public long Size { get; }
        public string ContentType { get; }
        
        public Stream OpenReadStream(long maxAllowedSize = 512000, CancellationToken cancellationToken = default)
        {
            return new MemoryStream(_bytes);
        }
    }
}
