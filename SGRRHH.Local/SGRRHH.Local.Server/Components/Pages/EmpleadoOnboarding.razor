@page "/empleados/onboarding"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.Services
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<EmpleadoOnboarding> Logger
@implements IAsyncDisposable

<PageTitle>Nuevo Empleado - SGRRHH</PageTitle>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<div class="hospital-page-container">
    <!-- Header -->
    <div class="hospital-page-header">
        <h1 class="hospital-page-title">NUEVO EMPLEADO</h1>
        <div class="hospital-shortcuts-bar">
            F5=GUARDAR | F8=CANCELAR | ESC=SALIR | TAB=SIGUIENTE CAMPO
        </div>
    </div>

    <!-- Progreso - sin animaciones, solo texto -->
    <WizardProgress CurrentStep="@currentStep"
                    TotalSteps="2"
                    StepNameProvider="GetStepName" />

    <!-- Contenido del Paso Actual -->
    <div class="hospital-content">
        @if (currentStep == 1)
        {
            <div class="hospital-step-content">
                <div class="hospital-step-title">PASO 1: DATOS BASICOS DEL EMPLEADO</div>
                <div class="hospital-step-instructions">
                    Complete la informacion personal y laboral. Los campos con * son obligatorios.
                </div>
                
                <DatosPersonalesForm Empleado="empleado" />
                <DatosLaboralesForm Empleado="empleado"
                                    Cargos="cargos"
                                    Departamentos="departamentos"
                                    EsOperador="esOperador" />
                <SeguridadSocialForm Empleado="empleado"
                                     EpsList="epsLista"
                                     AfpList="afpLista"
                                     ArlList="arlLista"
                                     CajasList="cajasLista" />
                <DatosBancariosForm Empleado="empleado" />
                <ContactoEmpleadoForm Empleado="empleado" />
            </div>
        }
        else if (currentStep == 2)
        {
            @RenderStep4Revisar()
        }
    </div>

    <!-- Botones de Navegación -->
    <WizardNavigation CurrentStep="@currentStep"
                      TotalSteps="2"
                      CanGoNext="@CanGoNext()"
                      IsSaving="@isSaving"
                      OnPrevious="Anterior"
                      OnNext="Siguiente"
                      OnCancel="Cancelar"
                      OnFinish="Finalizar" />
</div>

<!-- Modal de confirmación -->
@if (showConfirmModal)
{
    <div class="hospital-confirm-overlay">
        <div class="hospital-confirm-dialog">
            <div class="hospital-confirm-header">CONFIRMAR OPERACION</div>
            <div class="hospital-confirm-body">
                @confirmMessage
            </div>
            <div class="hospital-confirm-footer">
                <button type="button" 
                        class="hospital-btn hospital-btn-secondary"
                        @onclick="() => { showConfirmModal = false; confirmAction = null; }">
                    NO
                </button>
                <button type="button" 
                        class="hospital-btn hospital-btn-primary"
                        @onclick="ExecuteConfirmAction">
                    SI
                </button>
            </div>
        </div>
    </div>
}

@code {

    private MessageToast? messageToast;
    
    // Timer para re-evaluar CanGoNext() periódicamente mientras el usuario llena el formulario
    private System.Timers.Timer? _refreshTimer;
    
    private int currentStep = 1;
    private bool isSaving = false;
    private bool showConfirmModal = false;
    private string confirmMessage = "";
    private Action? confirmAction;
    
    // Datos del empleado
    private Empleado empleado = new Empleado
    {
        FechaIngreso = DateTime.Today
    };
    
    // Estado determinado por rol del usuario
    private bool esOperador = false;
    
    // Catálogos
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    // Catálogos de seguridad social
    private List<Eps> epsLista = new();
    private List<Afp> afpLista = new();
    private List<Arl> arlLista = new();
    private List<CajaCompensacion> cajasLista = new();
    

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Determinar estado inicial según rol del usuario
        var rolUsuario = AuthService.CurrentUser?.Rol ?? RolUsuario.Operador;
        esOperador = rolUsuario == RolUsuario.Operador;
        empleado.Estado = EstadoEmpleadoService.ObtenerEstadoInicialSegunRol(rolUsuario);
        
        Logger.LogInformation("Rol del usuario: {Rol}, Estado inicial del empleado: {Estado}", 
            rolUsuario, empleado.Estado);
        
        // Cargar catálogos
        await CargarCatalogos();
        
        // Obtener siguiente código
        empleado.Codigo = await EmpleadoRepo.GetNextCodigoAsync();
        
        // Iniciar timer para re-evaluar validaciones mientras el usuario llena el formulario
        _refreshTimer = new System.Timers.Timer(500);
        _refreshTimer.Elapsed += async (sender, e) => await InvokeAsync(StateHasChanged);
        _refreshTimer.AutoReset = true;
        _refreshTimer.Start();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Conectar al Hub de SignalR para recibir notificaciones en tiempo real
                var dotNetRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("connectDataSync", dotNetRef);
                Logger.LogInformation("[EmpleadoOnboarding] Conectado a SignalR Hub");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "[EmpleadoOnboarding] Error conectando a SignalR Hub");
            }
        }
    }
    
    [JSInvokable]
    public async Task OnDataChanged(string entityType, string changeType, int? entityId)
    {
        Logger.LogInformation("[EmpleadoOnboarding] Cambio recibido: {EntityType} - {ChangeType}", entityType, changeType);
        
        try
        {
            // Recargar catálogos si cambian Cargos o Departamentos
            if (entityType == "Cargo")
            {
                cargos = await CatalogCache.GetCargosAsync();
                await InvokeAsync(StateHasChanged);
                Logger.LogInformation("[EmpleadoOnboarding] Lista de Cargos actualizada ({Count} items)", cargos.Count);
            }
            else if (entityType == "Departamento")
            {
                departamentos = await CatalogCache.GetDepartamentosAsync();
                await InvokeAsync(StateHasChanged);
                Logger.LogInformation("[EmpleadoOnboarding] Lista de Departamentos actualizada ({Count} items)", departamentos.Count);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[EmpleadoOnboarding] Error recargando catálogos");
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        // Detener timer de refresh
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
        
        try
        {
            await JS.InvokeVoidAsync("disconnectDataSync");
            Logger.LogInformation("[EmpleadoOnboarding] Desconectado de SignalR Hub");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "[EmpleadoOnboarding] Error desconectando de SignalR Hub");
        }
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
            
            // Cargar catálogos de seguridad social
            epsLista = await CatalogCache.GetEpsAsync();
            afpLista = await CatalogCache.GetAfpAsync();
            arlLista = await CatalogCache.GetArlAsync();
            cajasLista = await CatalogCache.GetCajasCompensacionAsync();
            
            Logger.LogInformation("Catálogos cargados: EPS={EpsCount}, AFP={AfpCount}, ARL={ArlCount}, Cajas={CajasCount}", 
                epsLista.Count, afpLista.Count, arlLista.Count, cajasLista.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando catálogos");
            messageToast?.ShowError("Error al cargar catálogos");
        }
    }
    

    private string GetStepName(int step) => step switch
    {
        1 => "Datos Básicos",
        2 => "Revisar y Confirmar",
        // Pasos anteriores (documentos) se mantienen por compatibilidad pero no se usan
        3 => "Documentos Opcionales",
        4 => "Revisar y Confirmar",
        _ => ""
    };
    
    private bool CanGoNext()
    {
        return currentStep switch
        {
            1 => ValidarStep1(),
            // Los siguientes casos se mantienen por compatibilidad pero no se usan en el wizard simplificado
            2 => true,
            3 => true,
            _ => false
        };
    }
    
    private bool ValidarStep1()
    {
        // Datos básicos obligatorios
        if (string.IsNullOrWhiteSpace(empleado.Codigo)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Cedula)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Nombres)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Apellidos)) return false;
        if (!empleado.FechaNacimiento.HasValue) return false;
        if (!empleado.Genero.HasValue) return false;
        if (empleado.FechaIngreso == default) return false;
        
        // Información laboral obligatoria (Departamento y Cargo son opcionales)
        if (!empleado.SalarioBase.HasValue) return false;
        
        // Seguridad social obligatoria
        if (string.IsNullOrWhiteSpace(empleado.EPS)) return false;
        if (string.IsNullOrWhiteSpace(empleado.AFP)) return false;
        if (string.IsNullOrWhiteSpace(empleado.ARL)) return false;
        if (string.IsNullOrWhiteSpace(empleado.CajaCompensacion)) return false;
        
        // Contacto obligatorio
        if (string.IsNullOrWhiteSpace(empleado.TelefonoCelular)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Direccion)) return false;
        if (string.IsNullOrWhiteSpace(empleado.Municipio)) return false;
        
        // Información médica obligatoria
        if (string.IsNullOrWhiteSpace(empleado.TipoSangre)) return false;
        
        // Contacto de emergencia obligatorio
        if (string.IsNullOrWhiteSpace(empleado.ContactoEmergencia)) return false;
        if (string.IsNullOrWhiteSpace(empleado.ParentescoContactoEmergencia)) return false;
        if (string.IsNullOrWhiteSpace(empleado.TelefonoEmergencia)) return false;
        
        return true;
    }
    
    private void Siguiente()
    {
        if (currentStep < 2 && CanGoNext())
        {
            currentStep++;
        }
    }
    
    private void Anterior()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    
    private async Task Cancelar()
    {
        confirmMessage = "¿Cancelar operacion? Los datos ingresados se perderan.";
        confirmAction = () =>
        {
            Navigation.NavigateTo("/empleados");
        };
        showConfirmModal = true;
    }
    
    private void ExecuteConfirmAction()
    {
        showConfirmModal = false;
        confirmAction?.Invoke();
        confirmAction = null;
    }
    
    private async Task Finalizar()
    {
        confirmMessage = $"¿Confirmar creacion del empleado {empleado.Codigo}?";
        confirmAction = async () => await ExecuteFinalizar();
        showConfirmModal = true;
    }
    
    private async Task ExecuteFinalizar()
    {
        if (!ValidarStep1())
        {
            messageToast?.ShowError("Debe completar los datos básicos del empleado");
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            // Convertir campos de texto a mayúsculas antes de guardar
            ConvertirCamposAMayusculas();
            
            // 1. Validar código único
            if (await EmpleadoRepo.ExistsCodigoAsync(empleado.Codigo, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el código {empleado.Codigo}");
                return;
            }
            
            // 2. Validar cédula única
            if (await EmpleadoRepo.ExistsCedulaAsync(empleado.Cedula, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la cédula {empleado.Cedula}");
                return;
            }
            
            // 3. Validar email único (si se proporcionó)
            if (!string.IsNullOrWhiteSpace(empleado.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleado.Email, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleado.Email}");
                return;
            }
            
            // 4. Registrar auditoría: quién creó el empleado y cuándo
            empleado.CreadoPorId = AuthService.CurrentUserId;
            empleado.FechaSolicitud = DateTime.Now;
            
            // Si el creador es Aprobador o Admin, el empleado queda aprobado automáticamente
            if (empleado.Estado == EstadoEmpleado.Activo)
            {
                empleado.AprobadoPorId = AuthService.CurrentUserId;
                empleado.FechaAprobacion = DateTime.Now;
            }
            
            // 5. Crear empleado
            empleado = await EmpleadoRepo.AddAsync(empleado);
            Logger.LogInformation("Empleado creado: {Id} - {Codigo} - Estado: {Estado} - CreadoPor: {CreadoPor}", 
                empleado.Id, empleado.Codigo, empleado.Estado, AuthService.CurrentUser?.NombreCompleto);
            
            // Foto y documentos se cargan posteriormente desde el módulo de Documentos
            

            Logger.LogInformation("Empleado creado: {Codigo}", empleado.Codigo);
            
            // Mensaje según estado
            if (empleado.Estado == EstadoEmpleado.PendienteAprobacion)
            {
                messageToast?.ShowSuccess($"Empleado {empleado.Codigo} registrado. PENDIENTE DE APROBACIÓN por un Aprobador o Administrador.");
            }
            else
            {
                messageToast?.ShowSuccess($"Empleado {empleado.Codigo} creado y ACTIVO. Puede cargar documentos desde el módulo de Documentos.");
            }
            
            await Task.Delay(1500);
            Navigation.NavigateTo($"/documentos/{empleado.Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error en onboarding");
            var mensaje = ErrorTranslationService.Translate(ex);
            messageToast?.ShowError(mensaje);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    // Render del paso de revisión (único paso de revisión en el wizard de 2 pasos)


    private RenderFragment RenderStep4Revisar() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 2: REVISAR Y CONFIRMAR</div>
            <div class="hospital-step-instructions">
                Revise la informacion antes de crear el empleado. Los documentos y foto podra subirlos posteriormente desde el modulo de Documentos.
            </div>
            
            <!-- SECCION: DATOS PERSONALES -->
            <div class="hospital-section">
                <div class="hospital-section-header">DATOS PERSONALES</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">CODIGO:</td>
                            <td class="hospital-review-value">@empleado.Codigo</td>
                            <td class="hospital-review-label">CEDULA:</td>
                            <td class="hospital-review-value">@NumberFormatHelper.FormatearCedula(empleado.Cedula)</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">NOMBRES:</td>
                            <td class="hospital-review-value">@empleado.Nombres</td>
                            <td class="hospital-review-label">APELLIDOS:</td>
                            <td class="hospital-review-value">@empleado.Apellidos</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">FECHA NACIMIENTO:</td>
                            <td class="hospital-review-value">@(empleado.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "NO ESPECIFICADA")</td>
                            <td class="hospital-review-label">GENERO:</td>
                            <td class="hospital-review-value">@(empleado.Genero?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">ESTADO CIVIL:</td>
                            <td class="hospital-review-value">@(empleado.EstadoCivil?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TIPO DE SANGRE:</td>
                            <td class="hospital-review-value" style="font-weight: bold; color: #CC0000;">@(empleado.TipoSangre ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: INFORMACIÓN LABORAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">INFORMACION LABORAL</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">FECHA INGRESO:</td>
                            <td class="hospital-review-value">@empleado.FechaIngreso.ToString("dd/MM/yyyy")</td>
                            <td class="hospital-review-label">ESTADO:</td>
                            <td class="hospital-review-value">@empleado.Estado.ToString().ToUpper()</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">DEPARTAMENTO:</td>
                            <td class="hospital-review-value">@(departamentos.FirstOrDefault(d => d.Id == empleado.DepartamentoId)?.Nombre ?? "NO ASIGNADO")</td>
                            <td class="hospital-review-label">CARGO:</td>
                            <td class="hospital-review-value">@(cargos.FirstOrDefault(c => c.Id == empleado.CargoId)?.Nombre ?? "NO ASIGNADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">SALARIO BASE:</td>
                            <td class="hospital-review-value" style="@(empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905 ? "color: #CC0000; font-weight: bold;" : "")">
                                @(empleado.SalarioBase.HasValue ? $"${empleado.SalarioBase.Value:N0}" : "NO ESPECIFICADO")
                                @if (empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905)
                                {
                                    <span> (MENOR AL SMMLV)</span>
                                }
                            </td>
                            <td class="hospital-review-label"></td>
                            <td class="hospital-review-value"></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: SEGURIDAD SOCIAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">SEGURIDAD SOCIAL</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">EPS:</td>
                            <td class="hospital-review-value">@(empleado.EPS ?? "NO ESPECIFICADO") @(string.IsNullOrEmpty(empleado.CodigoEPS) ? "" : $"({empleado.CodigoEPS})")</td>
                            <td class="hospital-review-label">AFP:</td>
                            <td class="hospital-review-value">@(empleado.AFP ?? "NO ESPECIFICADO") @(string.IsNullOrEmpty(empleado.CodigoAFP) ? "" : $"({empleado.CodigoAFP})")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">ARL:</td>
                            <td class="hospital-review-value">@(empleado.ARL ?? "NO ESPECIFICADO") (Clase @empleado.ClaseRiesgoARL)</td>
                            <td class="hospital-review-label">CAJA COMPENSACION:</td>
                            <td class="hospital-review-value">@(empleado.CajaCompensacion ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO Y UBICACIÓN -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO Y UBICACION</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">CELULAR:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoCelular ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TELEFONO FIJO:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoFijo ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">WHATSAPP:</td>
                            <td class="hospital-review-value">@(string.IsNullOrEmpty(empleado.Whatsapp) ? "(Igual al celular)" : empleado.Whatsapp)</td>
                            <td class="hospital-review-label">EMAIL:</td>
                            <td class="hospital-review-value">@(empleado.Email ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">DIRECCION:</td>
                            <td class="hospital-review-value" colspan="3">@(empleado.Direccion ?? "NO ESPECIFICADA")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">MUNICIPIO:</td>
                            <td class="hospital-review-value">@(empleado.Municipio ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">BARRIO/VEREDA:</td>
                            <td class="hospital-review-value">@(empleado.Barrio ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: INFORMACIÓN MÉDICA -->
            @if (!string.IsNullOrEmpty(empleado.Alergias) || !string.IsNullOrEmpty(empleado.CondicionesMedicas) || !string.IsNullOrEmpty(empleado.MedicamentosActuales))
            {
                <div class="hospital-section">
                    <div class="hospital-section-header">INFORMACION MEDICA</div>
                    <div class="hospital-section-body">
                        <table class="hospital-review-table">
                            @if (!string.IsNullOrEmpty(empleado.Alergias))
                            {
                                <tr>
                                    <td class="hospital-review-label">ALERGIAS:</td>
                                    <td class="hospital-review-value" colspan="3" style="color: #CC0000;">@empleado.Alergias</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(empleado.CondicionesMedicas))
                            {
                                <tr>
                                    <td class="hospital-review-label">CONDICIONES:</td>
                                    <td class="hospital-review-value" colspan="3">@empleado.CondicionesMedicas</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(empleado.MedicamentosActuales))
                            {
                                <tr>
                                    <td class="hospital-review-label">MEDICAMENTOS:</td>
                                    <td class="hospital-review-value" colspan="3">@empleado.MedicamentosActuales</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            }
            
            <!-- SECCION: CONTACTOS DE EMERGENCIA -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTOS DE EMERGENCIA</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label" colspan="4" style="font-weight: bold; background-color: #f0f0f0;">CONTACTO #1 (PRINCIPAL)</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">NOMBRE:</td>
                            <td class="hospital-review-value">@(empleado.ContactoEmergencia ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">PARENTESCO:</td>
                            <td class="hospital-review-value">@(empleado.ParentescoContactoEmergencia ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">TELEFONO 1:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoEmergencia ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TELEFONO 2:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoEmergencia2 ?? "NO ESPECIFICADO")</td>
                        </tr>
                        @if (!string.IsNullOrEmpty(empleado.ContactoEmergencia2))
                        {
                            <tr>
                                <td class="hospital-review-label" colspan="4" style="font-weight: bold; background-color: #f0f0f0;">CONTACTO #2 (SECUNDARIO)</td>
                            </tr>
                            <tr>
                                <td class="hospital-review-label">NOMBRE:</td>
                                <td class="hospital-review-value">@empleado.ContactoEmergencia2</td>
                                <td class="hospital-review-label">PARENTESCO:</td>
                                <td class="hospital-review-value">@(empleado.ParentescoContactoEmergencia2 ?? "NO ESPECIFICADO")</td>
                            </tr>
                            <tr>
                                <td class="hospital-review-label">TELEFONO 1:</td>
                                <td class="hospital-review-value">@(empleado.TelefonoEmergencia2Contacto2 ?? "NO ESPECIFICADO")</td>
                                <td class="hospital-review-label">TELEFONO 2:</td>
                                <td class="hospital-review-value">@(empleado.TelefonoEmergencia2Alternativo ?? "NO ESPECIFICADO")</td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
            
            <!-- NOTA SOBRE DOCUMENTOS -->
            <div class="hospital-info-box" style="margin-top: 20px;">
                <strong>NOTA:</strong> Los documentos del empleado (fotocopia de cedula, certificaciones, foto, etc.) 
                podran ser cargados desde el modulo de <strong>DOCUMENTOS</strong> una vez creado el empleado.
            </div>
            
            <div class="hospital-confirm-box">
                Al hacer clic en GUARDAR se creara el registro del empleado.
            </div>
        </div>
    };
    
    // Helpers
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var años = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-años))
            años--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            años--;
            meses += 12;
        }
        
        if (años > 0 && meses > 0)
            return $"{años} año(s) {meses} mes(es)";
        else if (años > 0)
            return $"{años} año(s)";
        else
            return $"{meses} mes(es)";
    }
    
    /// <summary>
    /// Convierte todos los campos de texto del empleado a mayúsculas.
    /// El email se excluye porque debe mantener su formato estándar.
    /// </summary>
    private void ConvertirCamposAMayusculas()
    {
        // Datos personales
        empleado.Codigo = empleado.Codigo?.ToUpperInvariant();
        empleado.Cedula = empleado.Cedula?.ToUpperInvariant();
        empleado.Nombres = empleado.Nombres?.ToUpperInvariant();
        empleado.Apellidos = empleado.Apellidos?.ToUpperInvariant();
        
        // Contacto (excepto email que mantiene su formato)
        empleado.TelefonoCelular = empleado.TelefonoCelular?.ToUpperInvariant();
        empleado.TelefonoFijo = empleado.TelefonoFijo?.ToUpperInvariant();
        empleado.Whatsapp = empleado.Whatsapp?.ToUpperInvariant();
        // empleado.Email NO se convierte - debe mantener formato estándar
        
        // Dirección
        empleado.Direccion = empleado.Direccion?.ToUpperInvariant();
        empleado.Municipio = empleado.Municipio?.ToUpperInvariant();
        empleado.Barrio = empleado.Barrio?.ToUpperInvariant();
        
        // Información médica
        empleado.TipoSangre = empleado.TipoSangre?.ToUpperInvariant();
        empleado.Alergias = empleado.Alergias?.ToUpperInvariant();
        empleado.CondicionesMedicas = empleado.CondicionesMedicas?.ToUpperInvariant();
        empleado.MedicamentosActuales = empleado.MedicamentosActuales?.ToUpperInvariant();
        
        // Contacto de emergencia #1
        empleado.ContactoEmergencia = empleado.ContactoEmergencia?.ToUpperInvariant();
        empleado.ParentescoContactoEmergencia = empleado.ParentescoContactoEmergencia?.ToUpperInvariant();
        empleado.TelefonoEmergencia = empleado.TelefonoEmergencia?.ToUpperInvariant();
        empleado.TelefonoEmergencia2 = empleado.TelefonoEmergencia2?.ToUpperInvariant();
        
        // Contacto de emergencia #2
        empleado.ContactoEmergencia2 = empleado.ContactoEmergencia2?.ToUpperInvariant();
        empleado.ParentescoContactoEmergencia2 = empleado.ParentescoContactoEmergencia2?.ToUpperInvariant();
        empleado.TelefonoEmergencia2Contacto2 = empleado.TelefonoEmergencia2Contacto2?.ToUpperInvariant();
        empleado.TelefonoEmergencia2Alternativo = empleado.TelefonoEmergencia2Alternativo?.ToUpperInvariant();
        
        // Observaciones
        empleado.Observaciones = empleado.Observaciones?.ToUpperInvariant();
        
        // Seguridad social (nombres, no códigos)
        empleado.EPS = empleado.EPS?.ToUpperInvariant();
        empleado.AFP = empleado.AFP?.ToUpperInvariant();
        empleado.ARL = empleado.ARL?.ToUpperInvariant();
        empleado.CajaCompensacion = empleado.CajaCompensacion?.ToUpperInvariant();
        empleado.CodigoEPS = empleado.CodigoEPS?.ToUpperInvariant();
        empleado.CodigoAFP = empleado.CodigoAFP?.ToUpperInvariant();
        empleado.CodigoARL = empleado.CodigoARL?.ToUpperInvariant();
        empleado.CodigoCajaCompensacion = empleado.CodigoCajaCompensacion?.ToUpperInvariant();
    }
}


