@page "/empleados/onboarding"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepo
@inject IDocumentoEmpleadoRepository DocumentoRepo
@inject ICatalogCacheService CatalogCache
@inject ILocalStorageService StorageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<EmpleadoOnboarding> Logger

<PageTitle>Nuevo Empleado - SGRRHH</PageTitle>

<!-- Toast Messages -->
<MessageToast @ref="messageToast" />

<div class="hospital-page-container">
    <!-- Header -->
    <div class="hospital-page-header">
        <h1 class="hospital-page-title">NUEVO EMPLEADO</h1>
        <div class="hospital-shortcuts-bar">
            F5=GUARDAR | F8=CANCELAR | ESC=SALIR | TAB=SIGUIENTE CAMPO
        </div>
    </div>

    <!-- Progreso - sin animaciones, solo texto -->
    <div class="hospital-progress-bar">
        <div class="hospital-progress-text">
            PASO @currentStep DE 4: @GetStepName(currentStep).ToUpper()
        </div>
    </div>

    <!-- Contenido del Paso Actual -->
    <div class="hospital-content">
        @if (currentStep == 1)
        {
            @RenderStep1DatosBasicos()
        }
        else if (currentStep == 2)
        {
            @RenderStep2DocumentosObligatorios()
        }
        else if (currentStep == 3)
        {
            @RenderStep3DocumentosOpcionales()
        }
        else if (currentStep == 4)
        {
            @RenderStep4Revisar()
        }
    </div>

    <!-- Botones de Navegación -->
    <div class="hospital-footer">
        <button type="button" 
                @onclick="Cancelar" 
                disabled="@isSaving" 
                class="hospital-btn hospital-btn-secondary">
            CANCELAR (F8)
        </button>
        <div class="hospital-btn-group">
            @if (currentStep > 1)
            {
                <button type="button" 
                        @onclick="Anterior" 
                        disabled="@isSaving" 
                        class="hospital-btn hospital-btn-secondary">
                    ANTERIOR
                </button>
            }
            @if (currentStep < 4)
            {
                <button type="button" 
                        @onclick="Siguiente" 
                        disabled="@(!CanGoNext() || isSaving)" 
                        class="hospital-btn hospital-btn-primary">
                    SIGUIENTE
                </button>
            }
            else
            {
                <button type="button" 
                        @onclick="Finalizar" 
                        disabled="@isSaving" 
                        class="hospital-btn hospital-btn-primary">
                    @(isSaving ? "GUARDANDO..." : "GUARDAR (F5)")
                </button>
            }
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
@if (showConfirmModal)
{
    <div class="hospital-confirm-overlay">
        <div class="hospital-confirm-dialog">
            <div class="hospital-confirm-header">CONFIRMAR OPERACION</div>
            <div class="hospital-confirm-body">
                @confirmMessage
            </div>
            <div class="hospital-confirm-footer">
                <button type="button" 
                        class="hospital-btn hospital-btn-secondary"
                        @onclick="() => { showConfirmModal = false; confirmAction = null; }">
                    NO
                </button>
                <button type="button" 
                        class="hospital-btn hospital-btn-primary"
                        @onclick="ExecuteConfirmAction">
                    SI
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal de Previsualización de Documento -->
@if (showPreviewModal && previewDoc != null)
{
    <div class="hospital-confirm-overlay" @onclick="CerrarPreview">
        <div class="hospital-preview-modal" @onclick:stopPropagation="true">
            <div class="hospital-preview-header">
                <span>@previewDoc.NombreTipo - @previewDoc.ArchivoNombre</span>
                <button type="button" class="hospital-btn hospital-btn-secondary" @onclick="CerrarPreview">CERRAR (ESC)</button>
            </div>
            <div class="hospital-preview-body">
                @if (previewUrl != null)
                {
                    @if (IsPreviewableImage(previewDoc.Archivo?.ContentType))
                    {
                        <img src="@previewUrl" alt="Vista previa" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
                    }
                    else if (previewDoc.Archivo?.ContentType == "application/pdf")
                    {
                        <iframe src="@previewUrl" style="width: 100%; height: 70vh; border: none;"></iframe>
                    }
                    else
                    {
                        <div class="hospital-no-preview">
                            <p>TIPO DE ARCHIVO: @previewDoc.Archivo?.ContentType</p>
                            <p>NO SE PUEDE PREVISUALIZAR ESTE TIPO DE ARCHIVO</p>
                            <p style="margin-top: 20px;">El archivo será subido al guardar el formulario.</p>
                        </div>
                    }
                }
                else
                {
                    <div class="hospital-no-preview">CARGANDO VISTA PREVIA...</div>
                }
            </div>
            <div class="hospital-preview-footer">
                <span>Tamaño: @FormatFileSize(previewDoc.Archivo?.Size ?? 0)</span>
                <button type="button" class="hospital-btn hospital-btn-secondary" @onclick="CerrarPreview">CERRAR</button>
            </div>
        </div>
    </div>
}

<style>
    .hospital-preview-modal {
        background: #FFFFFF;
        border: 3px solid #000000;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .hospital-preview-header {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .hospital-preview-body {
        flex: 1;
        overflow: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #333333;
        min-height: 400px;
        padding: 10px;
    }
    
    .hospital-preview-footer {
        border-top: 2px solid #000000;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #F0F0F0;
        font-family: 'Courier New', monospace;
        font-size: 11px;
    }
    
    .hospital-no-preview {
        color: #FFFFFF;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        text-align: center;
        padding: 40px;
    }
    
    .hospital-btn-sm {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 4px 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        text-transform: uppercase;
        margin-right: 4px;
    }
    
    .hospital-btn-sm:hover {
        background: #F0F0F0;
    }
    
    .hospital-btn-danger-sm {
        border-color: #DC143C;
        color: #DC143C;
    }
    
    .hospital-btn-danger-sm:hover {
        background: #FFE8E8;
    }
</style>

<!-- Scanner Modal para documentos -->
<ScannerModal @bind-IsVisible="mostrarScannerModal"
              AllowMultiplePages="true"
              OnScanComplete="OnScanComplete"
              OnPdfGenerated="OnPdfGenerated" />

@code {
    private MessageToast? messageToast;
    
    private int currentStep = 1;
    private bool isSaving = false;
    private bool showConfirmModal = false;
    private string confirmMessage = "";
    private Action? confirmAction;
    
    // Datos del empleado
    private Empleado empleado = new Empleado
    {
        FechaIngreso = DateTime.Today,
        Estado = EstadoEmpleado.Activo
    };
    
    // Catálogos
    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();
    
    // Foto
    private IBrowserFile? fotoFile;
    private string? fotoPreviewUrl;
    
    // Documentos
    private List<DocumentoUpload> documentosObligatorios = new();
    private List<DocumentoUpload> documentosOpcionales = new();
    
    // Previsualización
    private bool showPreviewModal = false;
    private DocumentoUpload? previewDoc;
    private string? previewUrl;
    
    // Estado del Scanner
    private bool mostrarScannerModal = false;
    private DocumentoUpload? documentoParaEscanear = null;
    
    private class DocumentoUpload
    {
        public TipoDocumentoEmpleado Tipo { get; set; }
        public string Nombre { get; set; } = "";
        public string NombreTipo { get; set; } = "";
        public bool EsObligatorio { get; set; }
        public IBrowserFile? Archivo { get; set; }
        public string? ArchivoNombre { get; set; }
        public DateTime? FechaEmision { get; set; }
        public DateTime? FechaVencimiento { get; set; }
        public bool Subido { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Cargar catálogos
        await CargarCatalogos();
        
        // Inicializar documentos
        InicializarDocumentos();
        
        // Obtener siguiente código
        empleado.Codigo = await EmpleadoRepo.GetNextCodigoAsync();
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            cargos = await CatalogCache.GetCargosAsync();
            departamentos = await CatalogCache.GetDepartamentosAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando catálogos");
            messageToast?.ShowError("Error al cargar catálogos");
        }
    }
    
    private void InicializarDocumentos()
    {
        // Documentos OBLIGATORIOS según legislación colombiana
        var obligatorios = new[]
        {
            (TipoDocumentoEmpleado.Cedula, "Fotocopia de Cédula"),
            (TipoDocumentoEmpleado.HojaVida, "Hoja de Vida / Curriculum"),
            (TipoDocumentoEmpleado.CertificadoEstudios, "Certificados de Estudios"),
            (TipoDocumentoEmpleado.CertificadoLaboral, "Certificados Laborales"),
            (TipoDocumentoEmpleado.ReferenciasPersonales, "Referencias Personales (mín. 2)"),
            (TipoDocumentoEmpleado.ReferenciasLaborales, "Referencias Laborales (mín. 2)"),
            (TipoDocumentoEmpleado.ExamenMedicoIngreso, "Examen Médico de Ingreso"),
            (TipoDocumentoEmpleado.AfiliacionEPS, "Afiliación EPS"),
            (TipoDocumentoEmpleado.AfiliacionAFP, "Afiliación AFP (Pensión)"),
            (TipoDocumentoEmpleado.AfiliacionARL, "Afiliación ARL"),
            (TipoDocumentoEmpleado.AfiliacionCajaCompensacion, "Afiliación Caja Compensación"),
            (TipoDocumentoEmpleado.Antecedentes, "Certificado de Antecedentes"),
            (TipoDocumentoEmpleado.RUT, "RUT (Registro Único Tributario)"),
            (TipoDocumentoEmpleado.CertificadoBancario, "Certificación Bancaria"),
            (TipoDocumentoEmpleado.ContratoFirmado, "Contrato de Trabajo Firmado"),
            (TipoDocumentoEmpleado.LibretaMilitar, "Libreta Militar (hombres)"),
            (TipoDocumentoEmpleado.Foto, "Foto 3x4 tipo documento")
        };
        
        foreach (var (tipo, nombre) in obligatorios)
        {
            documentosObligatorios.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = true,
                FechaEmision = DateTime.Today
            });
        }
        
        // Documentos OPCIONALES
        var opcionales = new[]
        {
            (TipoDocumentoEmpleado.LicenciaConduccion, "Licencia de Conducción"),
            (TipoDocumentoEmpleado.ActaEntregaDotacion, "Acta Entrega de Dotación"),
            (TipoDocumentoEmpleado.Capacitacion, "Certificados de Capacitación"),
            (TipoDocumentoEmpleado.ExamenMedicoPeriodico, "Exámenes Médicos Periódicos"),
            (TipoDocumentoEmpleado.Otro, "Otros Documentos")
        };
        
        foreach (var (tipo, nombre) in opcionales)
        {
            documentosOpcionales.Add(new DocumentoUpload
            {
                Tipo = tipo,
                Nombre = nombre,
                NombreTipo = nombre,
                EsObligatorio = false,
                FechaEmision = DateTime.Today
            });
        }
    }
    
    private string GetStepName(int step) => step switch
    {
        1 => "Datos Básicos",
        2 => "Documentos Obligatorios",
        3 => "Documentos Opcionales",
        4 => "Revisar y Confirmar",
        _ => ""
    };
    
    private bool CanGoNext()
    {
        return currentStep switch
        {
            1 => ValidarStep1(),
            2 => true, // Documentos obligatorios se validan pero no bloquean
            3 => true, // Documentos opcionales no bloquean
            _ => false
        };
    }
    
    private bool ValidarStep1()
    {
        return !string.IsNullOrWhiteSpace(empleado.Codigo) &&
               !string.IsNullOrWhiteSpace(empleado.Cedula) &&
               !string.IsNullOrWhiteSpace(empleado.Nombres) &&
               !string.IsNullOrWhiteSpace(empleado.Apellidos) &&
               empleado.FechaIngreso != default;
    }
    
    private void Siguiente()
    {
        if (currentStep < 4 && CanGoNext())
        {
            currentStep++;
        }
    }
    
    private void Anterior()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    
    private async Task Cancelar()
    {
        confirmMessage = "¿Cancelar operacion? Los datos ingresados se perderan.";
        confirmAction = () =>
        {
            Navigation.NavigateTo("/empleados");
        };
        showConfirmModal = true;
    }
    
    private void ExecuteConfirmAction()
    {
        showConfirmModal = false;
        confirmAction?.Invoke();
        confirmAction = null;
    }
    
    private async Task Finalizar()
    {
        confirmMessage = $"¿Confirmar creacion del empleado {empleado.Codigo}?";
        confirmAction = async () => await ExecuteFinalizar();
        showConfirmModal = true;
    }
    
    private async Task ExecuteFinalizar()
    {
        if (!ValidarStep1())
        {
            messageToast?.ShowError("Debe completar los datos básicos del empleado");
            return;
        }
        
        isSaving = true;
        StateHasChanged();
        
        try
        {
            // 1. Validar código único
            if (await EmpleadoRepo.ExistsCodigoAsync(empleado.Codigo, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el código {empleado.Codigo}");
                return;
            }
            
            // 2. Validar cédula única
            if (await EmpleadoRepo.ExistsCedulaAsync(empleado.Cedula, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con la cédula {empleado.Cedula}");
                return;
            }
            
            // 3. Validar email único (si se proporcionó)
            if (!string.IsNullOrWhiteSpace(empleado.Email) && 
                await EmpleadoRepo.ExistsEmailAsync(empleado.Email, null))
            {
                messageToast?.ShowError($"Ya existe un empleado con el email {empleado.Email}");
                return;
            }
            
            // 4. Crear empleado primero para obtener el ID
            empleado = await EmpleadoRepo.AddAsync(empleado);
            Logger.LogInformation("Empleado creado: {Id} - {Codigo}", empleado.Id, empleado.Codigo);
            
            // 5. Guardar foto si se seleccionó
            if (fotoFile != null)
            {
                try
                {
                    using var stream = fotoFile.OpenReadStream(2 * 1024 * 1024);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    var extension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
                    var result = await StorageService.SaveEmpleadoFotoAsync(empleado.Id, ms.ToArray(), extension);
                    
                    if (result.IsSuccess)
                    {
                        empleado.FotoPath = result.Value;
                        // Actualizar empleado con el path de la foto
                        await EmpleadoRepo.UpdateAsync(empleado);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error guardando foto");
                }
            }
            
            // 6. Subir documentos obligatorios
            var docsSubidos = 0;
            foreach (var doc in documentosObligatorios.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            
            // 7. Subir documentos opcionales
            foreach (var doc in documentosOpcionales.Where(d => d.Archivo != null))
            {
                try
                {
                    await SubirDocumento(empleado.Id, doc);
                    docsSubidos++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error subiendo documento {Tipo}", doc.Tipo);
                }
            }
            
            Logger.LogInformation("Onboarding completado: Empleado {Codigo} con {Docs} documentos", 
                empleado.Codigo, docsSubidos);
            
            messageToast?.ShowSuccess($"Empleado {empleado.Codigo} creado exitosamente con {docsSubidos} documento(s)");
            
            await Task.Delay(1500);
            Navigation.NavigateTo("/empleados");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error en onboarding");
            var mensaje = ErrorTranslationService.Translate(ex);
            messageToast?.ShowError(mensaje);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private async Task SubirDocumento(int empleadoId, DocumentoUpload doc)
    {
        if (doc.Archivo == null) return;
        
        using var stream = doc.Archivo.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        
        var storageResult = await StorageService.SaveDocumentoEmpleadoAsync(
            empleadoId,
            doc.NombreTipo,
            ms.ToArray(),
            doc.Archivo.Name
        );
        
        if (storageResult.IsSuccess)
        {
            var documento = new DocumentoEmpleado
            {
                EmpleadoId = empleadoId,
                TipoDocumento = doc.Tipo,
                Nombre = doc.Nombre,
                NombreArchivoOriginal = doc.Archivo.Name,
                TipoMime = doc.Archivo.ContentType,
                TamanoArchivo = doc.Archivo.Size,
                FechaEmision = doc.FechaEmision,
                FechaVencimiento = doc.FechaVencimiento,
                SubidoPorNombre = AuthService.CurrentUser?.NombreCompleto,
                SubidoPorUsuarioId = AuthService.CurrentUser?.Id,
                ArchivoPath = storageResult.Value,
                Activo = true,
                FechaCreacion = DateTime.Now
            };
            
            await DocumentoRepo.AddAsync(documento);
            doc.Subido = true;
        }
    }
    
    // Renders de cada paso
    private RenderFragment RenderStep1DatosBasicos() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 1: DATOS BASICOS DEL EMPLEADO</div>
            <div class="hospital-step-instructions">
                Complete la informacion personal y laboral. Los campos con * son obligatorios.
            </div>
            
            <!-- SECCION: DATOS GENERALES -->
            <div class="hospital-section">
                <div class="hospital-section-header">DATOS GENERALES</div>
                <div class="hospital-section-body">
                    <!-- FOTO DEL EMPLEADO -->
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">FOTO DEL EMPLEADO</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 100px; height: 120px; border: 2px solid #000; display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                                    @if (!string.IsNullOrEmpty(fotoPreviewUrl))
                                    {
                                        <img src="@fotoPreviewUrl" alt="Vista previa" style="max-width: 100%; max-height: 100%; object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <span style="font-size: 10px; color: #666; text-align: center;">SIN FOTO</span>
                                    }
                                </div>
                                <div>
                                    <InputFile OnChange="OnFotoSelected" accept=".jpg,.jpeg,.png" class="hospital-file-input" />
                                    <div class="hospital-field-hint">JPG o PNG, máximo 2MB. Tamaño recomendado: 3x4</div>
                                    @if (fotoFile != null)
                                    {
                                        <div style="margin-top: 5px; color: #006400; font-size: 11px;">
                                            ✓ @fotoFile.Name (@FormatFileSize(fotoFile.Size))
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="hospital-form-field">
                            <!-- Espacio vacío -->
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CODIGO *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Codigo" maxlength="20" readonly />
                            <div class="hospital-field-hint">Codigo automatico asignado</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">CEDULA *</label>
                            <InputCedula @bind-Value="empleado.Cedula" CssClass="hospital-input" Placeholder="Ej: 1.192.208.848" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">NOMBRES *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Nombres" maxlength="100" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label required">APELLIDOS *</label>
                            <input type="text" class="hospital-input" @bind="empleado.Apellidos" maxlength="100" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">FECHA NACIMIENTO</label>
                            <input type="date" class="hospital-input" @bind="empleado.FechaNacimiento" />
                            @if (empleado.FechaNacimiento.HasValue)
                            {
                                var edad = CalcularEdad(empleado.FechaNacimiento.Value);
                                <div class="hospital-field-hint">Edad: @edad años</div>
                            }
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">GENERO</label>
                            <select class="hospital-input" @bind="empleado.Genero">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var g in Enum.GetValues<Genero>())
                                {
                                    <option value="@g">@g.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">ESTADO CIVIL</label>
                            <select class="hospital-input" @bind="empleado.EstadoCivil">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var ec in Enum.GetValues<EstadoCivil>())
                                {
                                    <option value="@ec">@ec.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">DIRECCION</label>
                            <input type="text" class="hospital-input" @bind="empleado.Direccion" maxlength="250" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: INFORMACION LABORAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">INFORMACION LABORAL</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label required">FECHA INGRESO *</label>
                            <input type="date" class="hospital-input" @bind="empleado.FechaIngreso" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">DEPARTAMENTO</label>
                            <select class="hospital-input" @bind="empleado.DepartamentoId">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var d in departamentos)
                                {
                                    <option value="@d.Id">@d.Nombre</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">CARGO</label>
                            <select class="hospital-input" @bind="empleado.CargoId" @bind:after="OnCargoChanged">
                                <option value="">-- SELECCIONE --</option>
                                @foreach (var c in cargos)
                                {
                                    <option value="@c.Id">@c.Nombre @(c.SalarioBase.HasValue ? $"(${c.SalarioBase.Value:N0})" : "")</option>
                                }
                            </select>
                            @if (empleado.CargoId.HasValue)
                            {
                                var cargoSel = cargos.FirstOrDefault(c => c.Id == empleado.CargoId);
                                if (cargoSel?.SalarioBase.HasValue == true)
                                {
                                    <div class="hospital-field-hint">Salario sugerido: $@cargoSel.SalarioBase.Value.ToString("N0")</div>
                                }
                            }
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">ESTADO</label>
                            <select class="hospital-input" @bind="empleado.Estado">
                                @foreach (var estado in Enum.GetValues<EstadoEmpleado>())
                                {
                                    <option value="@estado">@estado.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">SALARIO BASE</label>
                            <InputMoneda @bind-Value="empleado.SalarioBase" CssClass="hospital-input" Placeholder="Ej: 1.750.905" />
                            <div class="hospital-field-hint">
                                Salario mínimo Colombia 2026: @NumberFormatHelper.FormatearMoneda(1750905m)
                                @if (empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905)
                                {
                                    <span style="color: #CC0000;"> - ¡ATENCIÓN: MENOR AL SALARIO MÍNIMO!</span>
                                }
                            </div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <!-- Espacio vacío para mantener la cuadrícula -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: SEGURIDAD SOCIAL -->
            <div class="hospital-section">
                <div class="hospital-section-header">SEGURIDAD SOCIAL (COLOMBIA)</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">EPS (SALUD)</label>
                            <input type="text" class="hospital-input" @bind="empleado.EPS" maxlength="100" placeholder="Ej: SURA, SANITAS, NUEVA EPS" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO EPS</label>
                            <input type="text" class="hospital-input" @bind="empleado.CodigoEPS" maxlength="20" placeholder="Código entidad" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">AFP (PENSION)</label>
                            <input type="text" class="hospital-input" @bind="empleado.AFP" maxlength="100" placeholder="Ej: PORVENIR, PROTECCION, COLFONDOS" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO AFP</label>
                            <input type="text" class="hospital-input" @bind="empleado.CodigoAFP" maxlength="20" placeholder="Código entidad" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">ARL (RIESGOS LABORALES)</label>
                            <input type="text" class="hospital-input" @bind="empleado.ARL" maxlength="100" placeholder="Ej: SURA, POSITIVA, COLMENA" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO ARL</label>
                            <input type="text" class="hospital-input" @bind="empleado.CodigoARL" maxlength="20" placeholder="Código entidad" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">CLASE DE RIESGO ARL</label>
                            <select class="hospital-input" @bind="empleado.ClaseRiesgoARL">
                                <option value="1">CLASE I - Riesgo Mínimo (0.522%)</option>
                                <option value="2">CLASE II - Riesgo Bajo (1.044%)</option>
                                <option value="3">CLASE III - Riesgo Medio (2.436%)</option>
                                <option value="4">CLASE IV - Riesgo Alto (4.350%)</option>
                                <option value="5">CLASE V - Riesgo Máximo (6.960%)</option>
                            </select>
                            <div class="hospital-field-hint">Silvicultura generalmente es Clase IV o V</div>
                        </div>
                        
                        <div class="hospital-form-field">
                            <!-- Espacio vacío -->
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">CAJA DE COMPENSACION</label>
                            <input type="text" class="hospital-input" @bind="empleado.CajaCompensacion" maxlength="100" placeholder="Ej: COMFAMA, CAFAM, COMPENSAR" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">CODIGO CAJA COMPENSACION</label>
                            <input type="text" class="hospital-input" @bind="empleado.CodigoCajaCompensacion" maxlength="20" placeholder="Código entidad" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCION: CONTACTO -->
            <div class="hospital-section">
                <div class="hospital-section-header">CONTACTO</div>
                <div class="hospital-section-body">
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO</label>
                            <input type="text" class="hospital-input" @bind="empleado.Telefono" maxlength="20" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">EMAIL</label>
                            <input type="email" class="hospital-input" @bind="empleado.Email" maxlength="100" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field">
                            <label class="hospital-label">CONTACTO EMERGENCIA</label>
                            <input type="text" class="hospital-input" @bind="empleado.ContactoEmergencia" maxlength="100" />
                        </div>
                        
                        <div class="hospital-form-field">
                            <label class="hospital-label">TELEFONO EMERGENCIA</label>
                            <input type="text" class="hospital-input" @bind="empleado.TelefonoEmergencia" maxlength="20" />
                        </div>
                    </div>
                    
                    <div class="hospital-form-row">
                        <div class="hospital-form-field hospital-form-field-full">
                            <label class="hospital-label">OBSERVACIONES</label>
                            <textarea class="hospital-input hospital-textarea" 
                                      @bind="empleado.Observaciones" 
                                      maxlength="500"
                                      rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };
    
    private RenderFragment RenderStep2DocumentosObligatorios() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 2: DOCUMENTOS OBLIGATORIOS</div>
            <div class="hospital-step-instructions">
                Suba los 17 documentos obligatorios segun legislacion colombiana. Puede omitir documentos y subirlos posteriormente.
            </div>
            
            <div class="hospital-docs-counter">
                DOCUMENTOS SELECCIONADOS: @documentosObligatorios.Count(d => d.Archivo != null) DE @documentosObligatorios.Count
            </div>
            
            <table class="hospital-table">
                <thead>
                    <tr>
                        <th>DOCUMENTO</th>
                        <th>ARCHIVO</th>
                        <th>FECHA EMISION</th>
                        <th>FECHA VENCIMIENTO</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var doc in documentosObligatorios)
                    {
                        <tr>
                            <td><strong>@doc.NombreTipo</strong></td>
                            <td>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                              class="hospital-file-input" style="flex: 1;" />
                                    <button type="button" class="hospital-btn-sm" @onclick="() => AbrirScannerParaDocumento(doc)">ESCANEAR</button>
                                </div>
                                @if (doc.Archivo != null)
                                {
                                    <div class="hospital-file-name">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</div>
                                }
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaEmision" />
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaVencimiento" />
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <span class="hospital-status-ok">SELECCIONADO</span>
                                }
                                else
                                {
                                    <span class="hospital-status-pending">PENDIENTE</span>
                                }
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <button type="button" class="hospital-btn-sm" @onclick="() => PrevisualizarDocumento(doc)">VER</button>
                                    <button type="button" class="hospital-btn-sm hospital-btn-danger-sm" @onclick="() => QuitarDocumento(doc)">QUITAR</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div class="hospital-info-box">
                No es obligatorio subir todos los documentos ahora. Puede continuar y subirlos posteriormente desde el modulo de Documentos.
            </div>
        </div>
    };
    
    private RenderFragment RenderStep3DocumentosOpcionales() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 3: DOCUMENTOS OPCIONALES</div>
            <div class="hospital-step-instructions">
                Suba documentos adicionales segun el cargo. Estos documentos son completamente opcionales.
            </div>
            
            <div class="hospital-docs-counter">
                DOCUMENTOS SELECCIONADOS: @documentosOpcionales.Count(d => d.Archivo != null)
            </div>
            
            <table class="hospital-table">
                <thead>
                    <tr>
                        <th>DOCUMENTO</th>
                        <th>ARCHIVO</th>
                        <th>FECHA EMISION</th>
                        <th>FECHA VENCIMIENTO</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var doc in documentosOpcionales)
                    {
                        <tr>
                            <td><strong>@doc.NombreTipo</strong></td>
                            <td>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <InputFile OnChange="@(e => OnDocumentoSelected(e, doc))" 
                                              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                              class="hospital-file-input" style="flex: 1;" />
                                    <button type="button" class="hospital-btn-sm" @onclick="() => AbrirScannerParaDocumento(doc)">ESCANEAR</button>
                                </div>
                                @if (doc.Archivo != null)
                                {
                                    <div class="hospital-file-name">@doc.Archivo.Name (@FormatFileSize(doc.Archivo.Size))</div>
                                }
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaEmision" />
                            </td>
                            <td>
                                <input type="date" class="hospital-input hospital-input-sm" @bind="doc.FechaVencimiento" />
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <span class="hospital-status-ok">SELECCIONADO</span>
                                }
                                else
                                {
                                    <span class="hospital-status-pending">PENDIENTE</span>
                                }
                            </td>
                            <td>
                                @if (doc.Archivo != null)
                                {
                                    <button type="button" class="hospital-btn-sm" @onclick="() => PrevisualizarDocumento(doc)">VER</button>
                                    <button type="button" class="hospital-btn-sm hospital-btn-danger-sm" @onclick="() => QuitarDocumento(doc)">QUITAR</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    };
    
    private RenderFragment RenderStep4Revisar() => __builder =>
    {
        <div class="hospital-step-content">
            <div class="hospital-step-title">PASO 4: REVISAR Y CONFIRMAR</div>
            <div class="hospital-step-instructions">
                Revise la informacion antes de crear el empleado. Se creara el registro y se subiran los documentos seleccionados.
            </div>
            
            <!-- SECCION: DATOS DEL EMPLEADO -->
            <div class="hospital-section">
                <div class="hospital-section-header">DATOS DEL EMPLEADO</div>
                <div class="hospital-section-body">
                    <table class="hospital-review-table">
                        <tr>
                            <td class="hospital-review-label">CODIGO:</td>
                            <td class="hospital-review-value">@empleado.Codigo</td>
                            <td class="hospital-review-label">CEDULA:</td>
                            <td class="hospital-review-value">@NumberFormatHelper.FormatearCedula(empleado.Cedula)</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">NOMBRES:</td>
                            <td class="hospital-review-value">@empleado.Nombres</td>
                            <td class="hospital-review-label">APELLIDOS:</td>
                            <td class="hospital-review-value">@empleado.Apellidos</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">FECHA NACIMIENTO:</td>
                            <td class="hospital-review-value">@(empleado.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "NO ESPECIFICADA")</td>
                            <td class="hospital-review-label">GENERO:</td>
                            <td class="hospital-review-value">@(empleado.Genero?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">ESTADO CIVIL:</td>
                            <td class="hospital-review-value">@(empleado.EstadoCivil?.ToString().ToUpper() ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">DIRECCION:</td>
                            <td class="hospital-review-value">@(empleado.Direccion ?? "NO ESPECIFICADA")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">TELEFONO:</td>
                            <td class="hospital-review-value">@(empleado.Telefono ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">EMAIL:</td>
                            <td class="hospital-review-value">@(empleado.Email ?? "NO ESPECIFICADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">FECHA INGRESO:</td>
                            <td class="hospital-review-value">@empleado.FechaIngreso.ToString("dd/MM/yyyy")</td>
                            <td class="hospital-review-label">ESTADO:</td>
                            <td class="hospital-review-value">@empleado.Estado.ToString().ToUpper()</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">DEPARTAMENTO:</td>
                            <td class="hospital-review-value">@(departamentos.FirstOrDefault(d => d.Id == empleado.DepartamentoId)?.Nombre ?? "NO ASIGNADO")</td>
                            <td class="hospital-review-label">CARGO:</td>
                            <td class="hospital-review-value">@(cargos.FirstOrDefault(c => c.Id == empleado.CargoId)?.Nombre ?? "NO ASIGNADO")</td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">SALARIO BASE:</td>
                            <td class="hospital-review-value" style="@(empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905 ? "color: #CC0000; font-weight: bold;" : "")">
                                @(empleado.SalarioBase.HasValue ? $"${empleado.SalarioBase.Value:N0}" : "NO ESPECIFICADO")
                                @if (empleado.SalarioBase.HasValue && empleado.SalarioBase.Value < 1750905)
                                {
                                    <span> (MENOR AL SMMLV)</span>
                                }
                            </td>
                            <td class="hospital-review-label"></td>
                            <td class="hospital-review-value"></td>
                        </tr>
                        <tr>
                            <td class="hospital-review-label">CONTACTO EMERGENCIA:</td>
                            <td class="hospital-review-value">@(empleado.ContactoEmergencia ?? "NO ESPECIFICADO")</td>
                            <td class="hospital-review-label">TELEFONO EMERGENCIA:</td>
                            <td class="hospital-review-value">@(empleado.TelefonoEmergencia ?? "NO ESPECIFICADO")</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- SECCION: RESUMEN DE DOCUMENTOS -->
            <div class="hospital-section">
                <div class="hospital-section-header">DOCUMENTOS A SUBIR</div>
                <div class="hospital-section-body">
                    @{
                        var docsObligatoriosSubir = documentosObligatorios.Where(d => d.Archivo != null).ToList();
                        var docsOpcionalesSubir = documentosOpcionales.Where(d => d.Archivo != null).ToList();
                        var totalDocs = docsObligatoriosSubir.Count + docsOpcionalesSubir.Count;
                    }
                    
                    <table class="hospital-stats-table">
                        <tr>
                            <td class="hospital-stat-cell">
                                <div class="hospital-stat-number">@docsObligatoriosSubir.Count</div>
                                <div class="hospital-stat-label">DOCUMENTOS OBLIGATORIOS</div>
                            </td>
                            <td class="hospital-stat-cell">
                                <div class="hospital-stat-number">@docsOpcionalesSubir.Count</div>
                                <div class="hospital-stat-label">DOCUMENTOS OPCIONALES</div>
                            </td>
                            <td class="hospital-stat-cell hospital-stat-highlight">
                                <div class="hospital-stat-number">@totalDocs</div>
                                <div class="hospital-stat-label">TOTAL A SUBIR</div>
                            </td>
                        </tr>
                    </table>
                    
                    @if (totalDocs > 0)
                    {
                        <div class="hospital-docs-list">
                            <div class="hospital-docs-header">ARCHIVOS SELECCIONADOS:</div>
                            <table class="hospital-table">
                                <thead>
                                    <tr>
                                        <th>DOCUMENTO</th>
                                        <th>ARCHIVO</th>
                                        <th>TAMAÑO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var doc in docsObligatoriosSubir)
                                    {
                                        <tr>
                                            <td>@doc.NombreTipo</td>
                                            <td>@doc.Archivo!.Name</td>
                                            <td>@FormatFileSize(doc.Archivo.Size)</td>
                                        </tr>
                                    }
                                    @foreach (var doc in docsOpcionalesSubir)
                                    {
                                        <tr>
                                            <td>@doc.NombreTipo</td>
                                            <td>@doc.Archivo!.Name</td>
                                            <td>@FormatFileSize(doc.Archivo.Size)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="hospital-warning-box">
                            NO SE HAN SELECCIONADO DOCUMENTOS. PUEDE SUBIRLOS POSTERIORMENTE DESDE EL MODULO DE DOCUMENTOS.
                        </div>
                    }
                </div>
            </div>
            
            <div class="hospital-confirm-box">
                Al hacer clic en GUARDAR se creara el empleado y se subiran todos los documentos seleccionados.
            </div>
        </div>
    };
    
    // Event Handlers
    
    /// <summary>
    /// Se ejecuta cuando se cambia el cargo seleccionado.
    /// Copia el salario base del cargo al empleado automáticamente.
    /// </summary>
    private void OnCargoChanged()
    {
        if (empleado.CargoId.HasValue)
        {
            var cargoSeleccionado = cargos.FirstOrDefault(c => c.Id == empleado.CargoId);
            if (cargoSeleccionado?.SalarioBase.HasValue == true)
            {
                empleado.SalarioBase = cargoSeleccionado.SalarioBase;
                Logger.LogInformation("Salario del cargo '{Cargo}' asignado al empleado: {Salario}", 
                    cargoSeleccionado.Nombre, cargoSeleccionado.SalarioBase);
            }
        }
        StateHasChanged();
    }
    
    private async Task OnFotoSelected(InputFileChangeEventArgs e)
    {
        fotoFile = e.File;
        
        if (fotoFile != null)
        {
            // Validar tamaño (max 5MB)
            if (fotoFile.Size > 5 * 1024 * 1024)
            {
                messageToast?.ShowError("La imagen no puede superar 5MB");
                fotoFile = null;
                return;
            }
            
            try
            {
                using var stream = fotoFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                fotoPreviewUrl = $"data:{fotoFile.ContentType};base64,{base64}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error cargando foto");
                messageToast?.ShowError("Error al cargar foto");
            }
        }
    }
    
    private void OnDocumentoSelected(InputFileChangeEventArgs e, DocumentoUpload doc)
    {
        doc.Archivo = e.File;
        doc.ArchivoNombre = e.File.Name;
        StateHasChanged();
    }
    
    // Previsualización de documentos
    private async Task PrevisualizarDocumento(DocumentoUpload doc)
    {
        if (doc.Archivo == null) return;
        
        try
        {
            previewDoc = doc;
            previewUrl = null;
            showPreviewModal = true;
            StateHasChanged();
            
            // Leer el archivo y crear data URL
            using var stream = doc.Archivo.OpenReadStream(10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            previewUrl = $"data:{doc.Archivo.ContentType};base64,{base64}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error previsualizando documento");
            messageToast?.ShowError("Error al cargar vista previa");
            CerrarPreview();
        }
    }
    
    private void CerrarPreview()
    {
        showPreviewModal = false;
        previewDoc = null;
        previewUrl = null;
    }
    
    private bool IsPreviewableImage(string? contentType)
    {
        if (string.IsNullOrEmpty(contentType)) return false;
        return contentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase);
    }
    
    private void QuitarDocumento(DocumentoUpload doc)
    {
        doc.Archivo = null;
        doc.ArchivoNombre = null;
        StateHasChanged();
    }
    
    // Helpers
    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var hoy = DateTime.Today;
        var edad = hoy.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > hoy.AddYears(-edad))
            edad--;
        return edad;
    }
    
    private string CalcularAntiguedad(DateTime fechaIngreso)
    {
        var hoy = DateTime.Today;
        var años = hoy.Year - fechaIngreso.Year;
        if (fechaIngreso.Date > hoy.AddYears(-años))
            años--;
        
        var meses = hoy.Month - fechaIngreso.Month;
        if (meses < 0)
        {
            años--;
            meses += 12;
        }
        
        if (años > 0 && meses > 0)
            return $"{años} año(s) {meses} mes(es)";
        else if (años > 0)
            return $"{años} año(s)";
        else
            return $"{meses} mes(es)";
    }
    
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    // ===== MÉTODOS DEL SCANNER =====
    
    private void AbrirScannerParaDocumento(DocumentoUpload doc)
    {
        documentoParaEscanear = doc;
        mostrarScannerModal = true;
    }
    
    private void OnScanComplete(List<ScannedPageDto> pages)
    {
        Logger.LogInformation($"Escaneo completado en onboarding: {pages.Count} página(s)");
    }
    
    private void OnPdfGenerated(byte[] pdfBytes)
    {
        if (documentoParaEscanear != null)
        {
            // Crear un IBrowserFile simulado desde los bytes del PDF
            var fileName = $"{documentoParaEscanear.NombreTipo.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            documentoParaEscanear.Archivo = new ScannedBrowserFile(pdfBytes, fileName, "application/pdf");
            documentoParaEscanear.ArchivoNombre = fileName;
            Logger.LogInformation($"Documento escaneado asignado: {fileName} ({pdfBytes.Length} bytes)");
        }
        mostrarScannerModal = false;
        documentoParaEscanear = null;
        StateHasChanged();
    }
    
    /// <summary>
    /// Implementación simple de IBrowserFile para documentos escaneados
    /// </summary>
    private class ScannedBrowserFile : IBrowserFile
    {
        private readonly byte[] _bytes;
        public ScannedBrowserFile(byte[] bytes, string name, string contentType)
        {
            _bytes = bytes;
            Name = name;
            ContentType = contentType;
            Size = bytes.Length;
            LastModified = DateTimeOffset.Now;
        }
        
        public string Name { get; }
        public DateTimeOffset LastModified { get; }
        public long Size { get; }
        public string ContentType { get; }
        
        public Stream OpenReadStream(long maxAllowedSize = 512000, CancellationToken cancellationToken = default)
        {
            return new MemoryStream(_bytes);
        }
    }
}
