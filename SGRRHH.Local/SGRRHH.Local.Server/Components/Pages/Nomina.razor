@page "/nomina"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject INominaRepository NominaRepository
@inject INominaService NominaService
@inject IEmpleadoRepository EmpleadoRepository
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Nomina> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Nómina - SGRRHH</PageTitle>

<style>
    .page-container {
        width: 100%;
        min-width: 1024px;
        padding: 20px;
        font-family: 'Courier New', monospace;
    }

    .page-header {
        border-bottom: 2px solid #000000;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 18px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .action-bar {
        border: 1px solid #000000;
        padding: 10px;
        margin-bottom: 20px;
        background: #FFFFFF;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .btn {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 8px 16px;
        border: 2px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
    }

    .btn:hover:not(:disabled) {
        background: #F0F0F0;
    }

    .btn:disabled {
        border-color: #CCCCCC;
        color: #CCCCCC;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #000000;
        color: #FFFFFF;
    }

    .btn-primary:hover:not(:disabled) {
        background: #333333;
    }

    .btn-success {
        background: #006400;
        color: #FFFFFF;
        border-color: #006400;
    }

    .btn-success:hover:not(:disabled) {
        background: #008000;
    }

    .filter-section {
        border-top: 1px solid #CCCCCC;
        padding-top: 10px;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-label {
        font-size: 11px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
    }

    .filter-select {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 6px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        min-width: 120px;
    }

    .summary-box {
        border: 2px solid #000000;
        padding: 15px;
        margin-bottom: 20px;
        background: #F9F9F9;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }

    .summary-item {
        text-align: center;
    }

    .summary-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #666666;
    }

    .summary-value {
        font-size: 16px;
        font-weight: bold;
        color: #000000;
    }

    .summary-value.positive {
        color: #006400;
    }

    .summary-value.negative {
        color: #8B0000;
    }

    .results-info {
        font-size: 12px;
        color: #000000;
        padding: 10px 0;
        border-bottom: 1px solid #CCCCCC;
        margin-bottom: 10px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid #000000;
        background: #FFFFFF;
        font-size: 11px;
    }

    .data-table thead {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
    }

    .data-table th {
        padding: 8px;
        text-align: left;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        border-right: 1px solid #CCCCCC;
        font-size: 10px;
        letter-spacing: 1px;
    }

    .data-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #CCCCCC;
        border-right: 1px solid #CCCCCC;
        color: #000000;
    }

    .data-table tbody tr:hover {
        background: #F9F9F9;
    }

    .data-table tbody tr.selected {
        background: #E8E8E8;
    }

    .loading-message,
    .empty-message {
        text-align: center;
        padding: 40px;
        color: #666666;
        font-size: 12px;
    }

    .cell-code {
        font-weight: bold;
    }

    .cell-money {
        text-align: right;
        font-family: 'Courier New', monospace;
    }

    .cell-estado {
        text-transform: uppercase;
        font-size: 10px;
        font-weight: bold;
    }

    .estado-borrador {
        color: #B8860B;
    }

    .estado-calculada {
        color: #4169E1;
    }

    .estado-aprobada {
        color: #006400;
    }

    .estado-pagada {
        color: #228B22;
    }

    .estado-contabilizada {
        color: #2F4F4F;
    }

    .estado-anulada {
        color: #8B0000;
    }

    .cell-actions {
        white-space: nowrap;
    }

    .btn-table {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 4px 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        margin-right: 4px;
        text-transform: uppercase;
    }

    .btn-table:hover {
        background: #F0F0F0;
    }

    .shortcuts-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #000000;
        color: #FFFFFF;
        padding: 8px 20px;
        font-size: 11px;
        border-top: 2px solid #000000;
        display: flex;
        gap: 20px;
        z-index: 1000;
    }

    .shortcut-item {
        display: flex;
        gap: 5px;
    }

    .shortcut-key {
        font-weight: bold;
        color: #FFFF00;
    }

    .error-message {
        border: 2px solid #FF0000;
        background: #FFFFFF;
        color: #FF0000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .success-message {
        border: 2px solid #008000;
        background: #FFFFFF;
        color: #008000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .modal-box {
        background: #FFFFFF;
        border: 3px solid #000000;
        padding: 20px;
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-box h3 {
        font-size: 16px;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 20px;
        border-bottom: 2px solid #000000;
        padding-bottom: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-group.full-width {
        grid-column: span 3;
    }

    .form-label {
        font-size: 11px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
    }

    .form-input {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
    }

    .form-input:focus {
        outline: 2px solid #000000;
        outline-offset: 1px;
    }

    .form-input:read-only {
        background: #F0F0F0;
        color: #666666;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #CCCCCC;
    }

    .section-title {
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        margin-top: 15px;
        margin-bottom: 10px;
        padding: 5px;
        background: #F0F0F0;
        border-left: 3px solid #000000;
        grid-column: span 3;
    }

    .totals-row {
        font-weight: bold;
        background: #E8E8E8;
    }
</style>

<MessageToast @ref="messageToast" />

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">GESTIÓN DE NÓMINA MENSUAL</h1>
    </div>

    @if (!AuthService.IsAuthenticated)
    {
        <div class="error-message">ACCESO DENEGADO - DEBE INICIAR SESIÓN</div>
        return;
    }

    <div class="action-bar">
        <div class="action-buttons">
            <button class="btn btn-success" @onclick="GenerarNominaMasiva" disabled="@isGenerating">
                @(isGenerating ? "GENERANDO..." : "GENERAR NÓMINA MASIVA")
            </button>
            <button class="btn" @onclick="CargarDatos">ACTUALIZAR (F5)</button>
            <button class="btn" @onclick="AprobarSeleccionadas" disabled="@(!HayNominasParaAprobar())">
                APROBAR CALCULADAS
            </button>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">AÑO:</label>
                <select class="filter-select" @bind="añoSeleccionado" @bind:after="CargarDatos">
                    @for (int año = DateTime.Now.Year + 1; año >= 2020; año--)
                    {
                        <option value="@año">@año</option>
                    }
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">MES:</label>
                <select class="filter-select" @bind="mesSeleccionado" @bind:after="CargarDatos">
                    @for (int mes = 1; mes <= 12; mes++)
                    {
                        <option value="@mes">@GetNombreMes(mes)</option>
                    }
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">ESTADO:</label>
                <select class="filter-select" @bind="estadoFiltro" @bind:after="AplicarFiltros">
                    <option value="">TODOS</option>
                    <option value="@((int)EstadoNomina.Borrador)">BORRADOR</option>
                    <option value="@((int)EstadoNomina.Calculada)">CALCULADA</option>
                    <option value="@((int)EstadoNomina.Aprobada)">APROBADA</option>
                    <option value="@((int)EstadoNomina.Pagada)">PAGADA</option>
                    <option value="@((int)EstadoNomina.Contabilizada)">CONTABILIZADA</option>
                    <option value="@((int)EstadoNomina.Anulada)">ANULADA</option>
                </select>
            </div>
        </div>
    </div>

    @if (resumenCargado)
    {
        <div class="summary-box">
            <div class="summary-item">
                <div class="summary-label">TOTAL DEVENGADO</div>
                <div class="summary-value positive">@resumenDevengado.ToString("C0")</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">TOTAL DEDUCCIONES</div>
                <div class="summary-value negative">@resumenDeducciones.ToString("C0")</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">TOTAL NETO</div>
                <div class="summary-value">@resumenNeto.ToString("C0")</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">APORTES PATRONALES</div>
                <div class="summary-value">@resumenPatronales.ToString("C0")</div>
            </div>
        </div>
    }

    <div class="results-info">
        Mostrando @nominasFiltradas.Count nómina(s) de @GetNombreMes(mesSeleccionado) @añoSeleccionado
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>CÓDIGO</th>
                <th>EMPLEADO</th>
                <th>SALARIO BASE</th>
                <th>AUX. TRANSP.</th>
                <th>HORAS EXTRAS</th>
                <th>OTROS DEV.</th>
                <th>TOTAL DEV.</th>
                <th>SALUD</th>
                <th>PENSIÓN</th>
                <th>OTRAS DED.</th>
                <th>TOTAL DED.</th>
                <th>NETO PAGAR</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="14" class="loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!nominasFiltradas.Any())
            {
                <tr><td colspan="14" class="empty-message">NO HAY NÓMINAS PARA ESTE PERÍODO</td></tr>
            }
            else
            {
                @foreach (var nom in nominasFiltradas.OrderBy(n => n.Empleado?.Codigo ?? ""))
                {
                    <tr class="@(selectedNomina?.Id == nom.Id ? "selected" : "")"
                        @onclick="() => SelectNomina(nom)">
                        <td class="cell-code">@(nom.Empleado?.Codigo ?? "-")</td>
                        <td>@(nom.Empleado?.NombreCompleto ?? "-")</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.SalarioBase)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.AuxilioTransporte)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.HorasExtrasDiurnas + nom.HorasExtrasNocturnas + nom.HorasNocturnas + nom.HorasDominicalesFestivos)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.Comisiones + nom.Bonificaciones + nom.OtrosDevengos)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.TotalDevengado)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.DeduccionSalud)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.DeduccionPension)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.RetencionFuente + nom.Prestamos + nom.Embargos + nom.FondoEmpleados + nom.OtrasDeducciones)</td>
                        <td class="cell-money">@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.TotalDeducciones)</td>
                        <td class="cell-money"><strong>@NumberFormatHelper.FormatearMonedaSinSimbolo(nom.NetoPagar)</strong></td>
                        <td class="cell-estado estado-@GetEstadoClass(nom.Estado)">@nom.Estado.ToString().ToUpper()</td>
                        <td class="cell-actions">
                            <button class="btn-table" @onclick="() => VerDetalle(nom)" @onclick:stopPropagation="true">VER</button>
                            @if (nom.Estado == EstadoNomina.Borrador || nom.Estado == EstadoNomina.Calculada)
                            {
                                <button class="btn-table" @onclick="() => EditarNomina(nom)" @onclick:stopPropagation="true">EDITAR</button>
                            }
                            @if (nom.Estado == EstadoNomina.Calculada)
                            {
                                <button class="btn-table" @onclick="() => AprobarNomina(nom)" @onclick:stopPropagation="true">APROBAR</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="shortcuts-bar">
    <div class="shortcut-item">
        <span class="shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

@if (showModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>@(isEditing ? "EDITAR" : "DETALLE") NÓMINA - @(nominaEdit?.Empleado?.NombreCompleto ?? "")</h3>
            
            @if (nominaEdit != null)
            {
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">PERÍODO</label>
                        <input type="text" class="form-input" value="@nominaEdit.Periodo.ToString("MMMM yyyy")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ESTADO</label>
                        <input type="text" class="form-input" value="@nominaEdit.Estado.ToString().ToUpper()" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FECHA PAGO</label>
                        <input type="date" class="form-input" @bind="nominaEdit.FechaPago" disabled="@(!isEditing)" />
                    </div>
                </div>

                <div class="section-title">DEVENGOS</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">SALARIO BASE</label>
                        <InputMoneda @bind-Value="nominaEdit.SalarioBase" CssClass="form-input" ReadOnly="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">AUXILIO TRANSPORTE</label>
                        <InputMoneda @bind-Value="nominaEdit.AuxilioTransporte" CssClass="form-input" ReadOnly="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">HORAS EXTRAS DIURNAS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.HorasExtrasDiurnas" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">HORAS EXTRAS NOCTURNAS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.HorasExtrasNocturnas" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">HORAS NOCTURNAS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.HorasNocturnas" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DOMINICALES/FESTIVOS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.HorasDominicalesFestivos" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">COMISIONES</label>
                        <input type="number" class="form-input" @bind="nominaEdit.Comisiones" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">BONIFICACIONES</label>
                        <input type="number" class="form-input" @bind="nominaEdit.Bonificaciones" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">OTROS DEVENGOS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.OtrosDevengos" readonly="@(!isEditing)" step="1" />
                    </div>
                </div>

                <div class="section-title">DEDUCCIONES</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">DEDUCCIÓN SALUD (4%)</label>
                        <input type="number" class="form-input" @bind="nominaEdit.DeduccionSalud" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DEDUCCIÓN PENSIÓN (4%)</label>
                        <input type="number" class="form-input" @bind="nominaEdit.DeduccionPension" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">RETENCIÓN EN FUENTE</label>
                        <input type="number" class="form-input" @bind="nominaEdit.RetencionFuente" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">PRÉSTAMOS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.Prestamos" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">EMBARGOS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.Embargos" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">FONDO EMPLEADOS</label>
                        <input type="number" class="form-input" @bind="nominaEdit.FondoEmpleados" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">OTRAS DEDUCCIONES</label>
                        <input type="number" class="form-input" @bind="nominaEdit.OtrasDeducciones" readonly="@(!isEditing)" step="1" />
                    </div>
                </div>

                <div class="section-title">TOTALES</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">TOTAL DEVENGADO</label>
                        <input type="text" class="form-input" value="@nominaEdit.TotalDevengado.ToString("C0")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TOTAL DEDUCCIONES</label>
                        <input type="text" class="form-input" value="@nominaEdit.TotalDeducciones.ToString("C0")" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">NETO A PAGAR</label>
                        <input type="text" class="form-input" value="@nominaEdit.NetoPagar.ToString("C0")" readonly style="font-weight: bold;" />
                    </div>
                </div>

                <div class="section-title">APORTES PATRONALES</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">SALUD EMPLEADOR</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AporteSaludEmpleador" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">PENSIÓN EMPLEADOR</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AportePensionEmpleador" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ARL</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AporteARL" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">CAJA COMPENSACIÓN</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AporteCajaCompensacion" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ICBF</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AporteICBF" readonly="@(!isEditing)" step="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">SENA</label>
                        <input type="number" class="form-input" @bind="nominaEdit.AporteSENA" readonly="@(!isEditing)" step="1" />
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">OBSERVACIONES</label>
                        <textarea class="form-input" @bind="nominaEdit.Observaciones" rows="2" readonly="@(!isEditing)"></textarea>
                    </div>
                </div>
            }

            <div class="modal-actions">
                <button class="btn" @onclick="CerrarModal">CERRAR (ESC)</button>
                @if (isEditing)
                {
                    <button class="btn btn-primary" @onclick="Guardar" disabled="@isSaving">
                        @(isSaving ? "GUARDANDO..." : "GUARDAR (F10)")
                    </button>
                }
            </div>
        </div>
    </div>
}

@if (showConfirmModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <h3>CONFIRMAR ACCIÓN</h3>
            <p>@confirmMessage</p>
            <div class="modal-actions">
                <button class="btn" @onclick="() => showConfirmModal = false">CANCELAR</button>
                <button class="btn btn-primary" @onclick="ConfirmarAccion">CONFIRMAR</button>
            </div>
        </div>
    </div>
}

@code {
    private const string PageId = "Nomina";
    private MessageToast? messageToast;
    
    private List<Domain.Entities.Nomina> nominas = new();
    private List<Domain.Entities.Nomina> nominasFiltradas = new();
    private Domain.Entities.Nomina? selectedNomina;
    private Domain.Entities.Nomina? nominaEdit;
    
    private int añoSeleccionado = DateTime.Now.Year;
    private int mesSeleccionado = DateTime.Now.Month;
    private string estadoFiltro = "";
    
    private bool isLoading;
    private bool showModal;
    private bool isSaving;
    private bool isEditing;
    private bool isGenerating;
    private bool resumenCargado;
    
    private decimal resumenDevengado;
    private decimal resumenDeducciones;
    private decimal resumenNeto;
    private decimal resumenPatronales;
    
    private bool showConfirmModal;
    private string confirmMessage = "";
    private Func<Task>? confirmAction;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarDatos },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModalAsync },
            new() { Key = "F10", KeyDisplay = "F10", Description = "Guardar", Action = GuardarAsync }
        });
        
        await CargarDatos();
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private async Task CargarDatos()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            var periodo = new DateTime(añoSeleccionado, mesSeleccionado, 1);
            nominas = (await NominaRepository.GetByPeriodoWithEmpleadoAsync(periodo)).ToList();
            
            // Cargar resumen
            var resumen = await NominaRepository.GetResumenPeriodoAsync(periodo);
            resumenDevengado = resumen.TotalDevengado;
            resumenDeducciones = resumen.TotalDeducciones;
            resumenNeto = resumen.TotalNeto;
            resumenPatronales = resumen.TotalAportesPatronales;
            resumenCargado = true;
            
            AplicarFiltros();
            
            Logger.LogInformation("Nóminas cargadas para {Periodo}: {Count}", periodo.ToString("MMMM yyyy"), nominas.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando nóminas");
            messageToast?.ShowError("Error al cargar datos: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void AplicarFiltros()
    {
        nominasFiltradas = nominas
            .Where(n => string.IsNullOrEmpty(estadoFiltro) || (int)n.Estado == int.Parse(estadoFiltro))
            .ToList();
        StateHasChanged();
    }
    
    private async Task GenerarNominaMasiva()
    {
        confirmMessage = $"¿Está seguro de generar la nómina para todos los empleados activos de {GetNombreMes(mesSeleccionado)} {añoSeleccionado}?";
        confirmAction = async () => await GenerarNominaMasivaConfirmado();
        showConfirmModal = true;
        StateHasChanged();
    }
    
    private async Task GenerarNominaMasivaConfirmado()
    {
        try
        {
            isGenerating = true;
            StateHasChanged();
            
            var periodo = new DateTime(añoSeleccionado, mesSeleccionado, 1);
            var resultado = await NominaService.GenerarNominaTodosEmpleadosAsync(periodo);
            
            if (resultado.IsSuccess)
            {
                messageToast?.ShowSuccess($"Se generaron {resultado.Value} nómina(s) correctamente");
                await CargarDatos();
            }
            else
            {
                messageToast?.ShowError(resultado.Message ?? "Error al generar nóminas");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generando nóminas masivas");
            messageToast?.ShowError("Error al generar nóminas: " + ex.Message);
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }
    
    private void VerDetalle(Domain.Entities.Nomina nomina)
    {
        isEditing = false;
        nominaEdit = nomina;
        showModal = true;
        StateHasChanged();
    }
    
    private void EditarNomina(Domain.Entities.Nomina nomina)
    {
        isEditing = true;
        // Crear una copia para edición
        nominaEdit = new Domain.Entities.Nomina
        {
            Id = nomina.Id,
            EmpleadoId = nomina.EmpleadoId,
            Empleado = nomina.Empleado,
            Periodo = nomina.Periodo,
            FechaPago = nomina.FechaPago,
            SalarioBase = nomina.SalarioBase,
            AuxilioTransporte = nomina.AuxilioTransporte,
            HorasExtrasDiurnas = nomina.HorasExtrasDiurnas,
            HorasExtrasNocturnas = nomina.HorasExtrasNocturnas,
            HorasNocturnas = nomina.HorasNocturnas,
            HorasDominicalesFestivos = nomina.HorasDominicalesFestivos,
            Comisiones = nomina.Comisiones,
            Bonificaciones = nomina.Bonificaciones,
            OtrosDevengos = nomina.OtrosDevengos,
            DeduccionSalud = nomina.DeduccionSalud,
            DeduccionPension = nomina.DeduccionPension,
            RetencionFuente = nomina.RetencionFuente,
            Prestamos = nomina.Prestamos,
            Embargos = nomina.Embargos,
            FondoEmpleados = nomina.FondoEmpleados,
            OtrasDeducciones = nomina.OtrasDeducciones,
            AporteSaludEmpleador = nomina.AporteSaludEmpleador,
            AportePensionEmpleador = nomina.AportePensionEmpleador,
            AporteARL = nomina.AporteARL,
            AporteCajaCompensacion = nomina.AporteCajaCompensacion,
            AporteICBF = nomina.AporteICBF,
            AporteSENA = nomina.AporteSENA,
            Estado = nomina.Estado,
            Observaciones = nomina.Observaciones
        };
        showModal = true;
        StateHasChanged();
    }
    
    private void SelectNomina(Domain.Entities.Nomina nomina)
    {
        selectedNomina = selectedNomina?.Id == nomina.Id ? null : nomina;
        StateHasChanged();
    }
    
    private async Task AprobarNomina(Domain.Entities.Nomina nomina)
    {
        try
        {
            var resultado = await NominaService.AprobarNominaAsync(nomina.Id, AuthService.CurrentUser?.Id ?? 0);
            
            if (resultado.IsSuccess)
            {
                messageToast?.ShowSuccess($"Nómina de {nomina.Empleado?.NombreCompleto} aprobada correctamente");
                await CargarDatos();
            }
            else
            {
                messageToast?.ShowError(resultado.Message ?? "Error al aprobar nómina");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error aprobando nómina");
            messageToast?.ShowError("Error al aprobar: " + ex.Message);
        }
    }
    
    private bool HayNominasParaAprobar()
    {
        return nominasFiltradas.Any(n => n.Estado == EstadoNomina.Calculada);
    }
    
    private async Task AprobarSeleccionadas()
    {
        var calculadas = nominasFiltradas.Count(n => n.Estado == EstadoNomina.Calculada);
        confirmMessage = $"¿Está seguro de aprobar las {calculadas} nómina(s) en estado CALCULADA?";
        confirmAction = async () => await AprobarTodasConfirmado();
        showConfirmModal = true;
        StateHasChanged();
    }
    
    private async Task AprobarTodasConfirmado()
    {
        try
        {
            var periodo = new DateTime(añoSeleccionado, mesSeleccionado, 1);
            var resultado = await NominaService.AprobarNominasPeriodoAsync(periodo, AuthService.CurrentUser?.Id ?? 0);
            
            if (resultado.IsSuccess)
            {
                messageToast?.ShowSuccess($"Se aprobaron {resultado.Value} nómina(s) correctamente");
                await CargarDatos();
            }
            else
            {
                messageToast?.ShowError(resultado.Message ?? "Error al aprobar nóminas");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error aprobando nóminas");
            messageToast?.ShowError("Error al aprobar: " + ex.Message);
        }
    }
    
    private async Task Guardar()
    {
        if (nominaEdit == null) return;
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            // Cambiar estado a Calculada si estaba en Borrador
            if (nominaEdit.Estado == EstadoNomina.Borrador)
            {
                nominaEdit.Estado = EstadoNomina.Calculada;
            }
            
            await NominaRepository.UpdateAsync(nominaEdit);
            messageToast?.ShowSuccess("Nómina actualizada correctamente");
            
            showModal = false;
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando nómina");
            messageToast?.ShowError("Error al guardar: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task GuardarAsync()
    {
        if (showModal && isEditing)
        {
            return Guardar();
        }
        return Task.CompletedTask;
    }
    
    private void CerrarModal()
    {
        if (!isSaving)
        {
            showModal = false;
            nominaEdit = null;
            StateHasChanged();
        }
    }
    
    private Task CerrarModalAsync()
    {
        CerrarModal();
        return Task.CompletedTask;
    }
    
    private async Task ConfirmarAccion()
    {
        showConfirmModal = false;
        if (confirmAction != null)
        {
            await confirmAction();
        }
        StateHasChanged();
    }
    
    private string GetNombreMes(int mes)
    {
        return mes switch
        {
            1 => "ENERO",
            2 => "FEBRERO",
            3 => "MARZO",
            4 => "ABRIL",
            5 => "MAYO",
            6 => "JUNIO",
            7 => "JULIO",
            8 => "AGOSTO",
            9 => "SEPTIEMBRE",
            10 => "OCTUBRE",
            11 => "NOVIEMBRE",
            12 => "DICIEMBRE",
            _ => "-"
        };
    }
    
    private string GetEstadoClass(EstadoNomina estado)
    {
        return estado switch
        {
            EstadoNomina.Borrador => "borrador",
            EstadoNomina.Calculada => "calculada",
            EstadoNomina.Aprobada => "aprobada",
            EstadoNomina.Pagada => "pagada",
            EstadoNomina.Contabilizada => "contabilizada",
            EstadoNomina.Anulada => "anulada",
            _ => "borrador"
        };
    }
}
