@page "/dashboard"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@inject IAuthService AuthService
@inject IEmpleadoRepository EmpleadoRepository
@inject IPermisoRepository PermisoRepository
@inject IVacacionRepository VacacionRepository
@inject IContratoRepository ContratoRepository
@inject NavigationManager Navigation
@inject ILogger<Dashboard> Logger

<PageTitle>Dashboard - SGRRHH</PageTitle>

<KeyboardHandler @ref="keyboardHandler" Shortcuts="shortcuts" ShowShortcutBar="true" />

<h1 class="page-title">PANEL DE CONTROL</h1>

@if (isLoading)
{
    <div class="loading-container">
        <p>Cargando estadísticas...</p>
    </div>
}
else
{
    <!-- Stats Cards -->
    <div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
        <div class="stats-card">
            <div class="stats-label">EMPLEADOS ACTIVOS</div>
            <div class="stats-value">@stats.EmpleadosActivos</div>
            <div class="stats-sublabel">de @stats.EmpleadosTotal total</div>
        </div>
        <div class="stats-card">
            <div class="stats-label">PERMISOS PENDIENTES</div>
            <div class="stats-value">@stats.PermisosPendientes</div>
            <div class="stats-sublabel">requieren aprobación</div>
        </div>
        <div class="stats-card">
            <div class="stats-label">VACACIONES PENDIENTES</div>
            <div class="stats-value">@stats.VacacionesPendientes</div>
            <div class="stats-sublabel">en espera</div>
        </div>
        <div class="stats-card">
            <div class="stats-label">CONTRATOS POR VENCER</div>
            <div class="stats-value">@stats.ContratosPorVencer</div>
            <div class="stats-sublabel">próximos 30 días</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="panel" style="margin-bottom: 24px;">
        <h3>ACCIONES RÁPIDAS</h3>
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
            <button @onclick="@(() => Navigation.NavigateTo("/empleados"))">
                NUEVO EMPLEADO
            </button>
            <button @onclick="@(() => Navigation.NavigateTo("/permisos"))">
                NUEVO PERMISO
            </button>
            <button @onclick="@(() => Navigation.NavigateTo("/vacaciones"))">
                NUEVA VACACIÓN
            </button>
            <button @onclick="@(() => Navigation.NavigateTo("/documentos"))">
                DOCUMENTOS
            </button>
            <button @onclick="@(() => Navigation.NavigateTo("/control-diario"))">
                REGISTRO DIARIO
            </button>
            <button @onclick="CargarEstadisticas">
                ACTUALIZAR (F5)
            </button>
        </div>
    </div>

    <!-- Permisos Pendientes (si es aprobador) -->
    @if (AuthService.IsAprobador && permisosPendientes.Any())
    {
        <div class="panel" style="margin-bottom: 24px;">
            <h3>PERMISOS PENDIENTES DE APROBACIÓN</h3>
            <table>
                <thead>
                    <tr>
                        <th>N° ACTA</th>
                        <th>EMPLEADO</th>
                        <th>TIPO</th>
                        <th>FECHAS</th>
                        <th>DÍAS</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var permiso in permisosPendientes.Take(5))
                    {
                        <tr>
                            <td>@permiso.NumeroActa</td>
                            <td>@(permiso.Empleado?.NombreCompleto ?? "N/A")</td>
                            <td>@(permiso.TipoPermiso?.Nombre ?? "N/A")</td>
                            <td>@permiso.FechaInicio.ToString("dd/MM/yyyy") - @permiso.FechaFin.ToString("dd/MM/yyyy")</td>
                            <td>@permiso.TotalDias</td>
                            <td class="actions-cell">
                                <button @onclick="() => VerPermiso(permiso.Id)">VER</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (permisosPendientes.Count() > 5)
            {
                <p style="margin-top: 8px;">
                    <a href="/permisos?estado=pendiente">Ver todos (@permisosPendientes.Count())</a>
                </p>
            }
        </div>
    }

    <!-- Vacaciones Pendientes (si es aprobador) -->
    @if (AuthService.IsAprobador && vacacionesPendientes.Any())
    {
        <div class="panel" style="margin-bottom: 24px;">
            <h3>VACACIONES PENDIENTES DE APROBACIÓN</h3>
            <table>
                <thead>
                    <tr>
                        <th>EMPLEADO</th>
                        <th>PERÍODO</th>
                        <th>FECHAS</th>
                        <th>DÍAS</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vacacion in vacacionesPendientes.Take(5))
                    {
                        <tr>
                            <td>@(vacacion.Empleado?.NombreCompleto ?? "N/A")</td>
                            <td>@vacacion.PeriodoCorrespondiente</td>
                            <td>@vacacion.FechaInicio.ToString("dd/MM/yyyy") - @vacacion.FechaFin.ToString("dd/MM/yyyy")</td>
                            <td>@vacacion.DiasTomados</td>
                            <td class="actions-cell">
                                <button @onclick="() => VerVacacion(vacacion.Id)">VER</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (vacacionesPendientes.Count() > 5)
            {
                <p style="margin-top: 8px;">
                    <a href="/vacaciones?estado=pendiente">Ver todos (@vacacionesPendientes.Count())</a>
                </p>
            }
        </div>
    }

    <!-- Contratos por Vencer -->
    @if (contratosPorVencer.Any())
    {
        <div class="panel" style="margin-bottom: 24px;">
            <h3>⚠️ CONTRATOS POR VENCER (Próximos 30 días)</h3>
            <table>
                <thead>
                    <tr>
                        <th>EMPLEADO</th>
                        <th>CARGO</th>
                        <th>TIPO CONTRATO</th>
                        <th>FECHA INICIO</th>
                        <th>FECHA FIN</th>
                        <th>DÍAS RESTANTES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var contrato in contratosPorVencer.Take(10))
                    {
                        var diasRestantes = contrato.FechaFin.HasValue ? (contrato.FechaFin.Value - DateTime.Today).Days : 0;
                        <tr class="@(diasRestantes <= 7 ? "row-danger" : diasRestantes <= 15 ? "row-warning" : "")">
                            <td><strong>@(contrato.Empleado?.NombreCompleto ?? "N/A")</strong></td>
                            <td>@(contrato.Empleado?.Cargo?.Nombre ?? "N/A")</td>
                            <td>@contrato.TipoContrato</td>
                            <td>@contrato.FechaInicio.ToString("dd/MM/yyyy")</td>
                            <td>@(contrato.FechaFin?.ToString("dd/MM/yyyy") ?? "Indefinido")</td>
                            <td>
                                <strong>@diasRestantes días</strong>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (contratosPorVencer.Count() > 10)
            {
                <p style="margin-top: 8px;">
                    <a href="/contratos">Ver todos (@contratosPorVencer.Count())</a>
                </p>
            }
        </div>
    }
}

@code {
    private KeyboardHandler? keyboardHandler;
    private List<KeyboardHandler.KeyboardShortcut> shortcuts = new();
    
    private DashboardStats stats = new();
    private bool isLoading = true;
    
    private IEnumerable<Permiso> permisosPendientes = new List<Permiso>();
    private IEnumerable<Vacacion> vacacionesPendientes = new List<Vacacion>();
    private IEnumerable<Contrato> contratosPorVencer = new List<Contrato>();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Configurar atajos de teclado
        shortcuts = new List<KeyboardHandler.KeyboardShortcut>
        {
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarEstadisticas }
        };
        
        await CargarEstadisticas();
    }
    
    private async Task CargarEstadisticas()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            // Cargar estadísticas en paralelo
            var empleadosTask = EmpleadoRepository.GetAllAsync();
            var permisosTask = PermisoRepository.GetByEstadoAsync(EstadoPermiso.Pendiente);
            var vacacionesTask = VacacionRepository.GetByEstadoAsync(EstadoVacacion.Pendiente);
            var contratosTask = ContratoRepository.GetContratosProximosAVencerAsync(30);
            
            await Task.WhenAll(empleadosTask, permisosTask, vacacionesTask, contratosTask);
            
            var empleados = await empleadosTask;
            permisosPendientes = await permisosTask;
            vacacionesPendientes = await vacacionesTask;
            contratosPorVencer = await contratosTask;
            
            // Calcular estadísticas
            stats.EmpleadosTotal = empleados.Count();
            stats.EmpleadosActivos = empleados.Count(e => e.Estado == EstadoEmpleado.Activo);
            stats.PermisosPendientes = permisosPendientes.Count();
            stats.VacacionesPendientes = vacacionesPendientes.Count();
            stats.ContratosPorVencer = contratosPorVencer.Count();
            
            Logger.LogInformation("Dashboard actualizado: {Stats}", stats);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando estadísticas del dashboard");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void VerPermiso(int id)
    {
        Navigation.NavigateTo($"/permisos/{id}");
    }
    
    private void VerVacacion(int id)
    {
        Navigation.NavigateTo($"/vacaciones/{id}");
    }
    
    private class DashboardStats
    {
        public int EmpleadosTotal { get; set; }
        public int EmpleadosActivos { get; set; }
        public int PermisosPendientes { get; set; }
        public int VacacionesPendientes { get; set; }
        public int ContratosPorVencer { get; set; }
    }
}

<style>
.page-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 24px;
    padding-bottom: 8px;
    border-bottom: 2px solid #000000;
}

.loading-container {
    text-align: center;
    padding: 40px;
    font-size: 16px;
}

.stats-card {
    background-color: #F5F5F5;
    border: 2px solid #000000;
    padding: 16px;
    min-width: 200px;
    flex: 1;
}

.stats-label {
    font-size: 11px;
    font-weight: bold;
    color: #666666;
    margin-bottom: 8px;
}

.stats-value {
    font-size: 32px;
    font-weight: bold;
    color: #000000;
    margin-bottom: 4px;
}

.stats-sublabel {
    font-size: 12px;
    color: #666666;
}

.panel {
    background-color: #FFFFFF;
    border: 2px solid #000000;
    padding: 16px;
}

.panel h3 {
    font-size: 16px;
    font-weight: bold;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #808080;
}

button {
    background-color: #E0E0E0;
    border: 2px solid #000000;
    border-style: outset;
    padding: 8px 16px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
}

button:hover {
    background-color: #D0D0D0;
}

button:active {
    border-style: inset;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
}

table th,
table td {
    border: 1px solid #808080;
    padding: 8px;
    text-align: left;
    font-size: 12px;
}

table th {
    background-color: #E0E0E0;
    font-weight: bold;
}

table tbody tr:hover {
    background-color: #F5F5F5;
}

.actions-cell {
    white-space: nowrap;
}

.actions-cell button {
    padding: 4px 8px;
    font-size: 11px;
    margin-right: 4px;
}

.row-danger {
    background-color: #FFCCCC !important;
}

.row-warning {
    background-color: #FFF9CC !important;
}

a {
    color: #0000EE;
    text-decoration: underline;
}

a:hover {
    color: #551A8B;
}
</style>
