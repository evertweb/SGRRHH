@page "/seguimiento-permisos"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@inject IPermisoRepository PermisoRepository
@inject ISeguimientoPermisoRepository SeguimientoRepository
@inject ICompensacionHorasRepository CompensacionRepository
@inject IAlertaPermisoService AlertaService
@inject ICatalogCacheService CatalogCache
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<SeguimientoPermisos> Logger

<PageTitle>Seguimiento de Permisos - SGRRHH</PageTitle>

<style>
    /* === SISTEMA HOSPITALARIO - SEGUIMIENTO DE PERMISOS === */
    
    body, * {
        font-family: 'Courier New', monospace;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .seguimiento-container {
        width: 100%;
        min-width: 1024px;
        max-width: 1920px;
        margin: 0 auto;
        padding: 20px;
        background: white;
    }
    
    .seguimiento-header {
        border-bottom: 2px solid black;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .seguimiento-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
        text-align: left;
    }
    
    .seguimiento-info {
        font-size: 12px;
        margin-top: 5px;
        color: #000;
    }
    
    /* === DASHBOARD === */
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        border: 2px solid black;
        padding: 15px;
        text-align: center;
        background: white;
    }
    
    .stat-card h3 {
        font-size: 11px;
        margin: 0 0 10px 0;
        font-weight: bold;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        line-height: 1;
    }
    
    .stat-amount {
        font-size: 12px;
        margin-top: 5px;
        color: #666;
    }
    
    .stat-card.urgente {
        border-color: red;
        background: #fff0f0;
    }
    
    .stat-card.urgente .stat-number {
        color: red;
    }
    
    .stat-card.warning {
        border-color: #cc7700;
        background: #fffbf0;
    }
    
    .stat-card.warning .stat-number {
        color: #cc7700;
    }
    
    .stat-card.info {
        border-color: #0066cc;
        background: #f0f8ff;
    }
    
    .stat-card.info .stat-number {
        color: #0066cc;
    }
    
    .stat-card.success {
        border-color: green;
        background: #f0fff0;
    }
    
    .stat-card.success .stat-number {
        color: green;
    }
    
    /* === TABS === */
    
    .seguimiento-tabs {
        border: 1px solid black;
        margin-bottom: 0;
        display: flex;
        background: #f0f0f0;
    }
    
    .seguimiento-tabs button {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        padding: 10px 15px;
        border: none;
        border-right: 1px solid black;
        background: #f0f0f0;
        cursor: pointer;
        text-transform: uppercase;
    }
    
    .seguimiento-tabs button:hover {
        background: #e0e0e0;
    }
    
    .seguimiento-tabs button.active {
        background: white;
        font-weight: bold;
        border-bottom: 2px solid white;
        margin-bottom: -1px;
    }
    
    /* === CONTENIDO === */
    
    .seguimiento-content {
        border: 1px solid black;
        border-top: none;
        padding: 15px;
        min-height: 400px;
    }
    
    /* === TABLA === */
    
    .tabla-seguimiento {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid black;
        margin-bottom: 15px;
    }
    
    .tabla-seguimiento th {
        background: white;
        border: 1px solid black;
        padding: 8px;
        text-align: left;
        font-size: 11px;
        font-weight: bold;
    }
    
    .tabla-seguimiento td {
        border: 1px solid black;
        padding: 6px 8px;
        font-size: 11px;
    }
    
    .tabla-seguimiento tbody tr {
        cursor: pointer;
    }
    
    .tabla-seguimiento tbody tr:hover {
        background: #f5f5f5;
    }
    
    .td-centro {
        text-align: center;
    }
    
    .td-acta {
        font-weight: bold;
    }
    
    /* === ESTADOS Y BADGES === */
    
    .badge {
        padding: 2px 6px;
        font-size: 10px;
        display: inline-block;
    }
    
    .badge-vencido {
        background: red;
        color: white;
    }
    
    .badge-urgente {
        background: #cc7700;
        color: white;
    }
    
    .badge-ok {
        background: green;
        color: white;
    }
    
    .badge-pendiente {
        background: yellow;
        color: black;
    }
    
    .badge-compensacion {
        background: #0066cc;
        color: white;
    }
    
    .badge-descuento {
        background: #660066;
        color: white;
    }
    
    /* === PROGRESO COMPENSACIÓN === */
    
    .progreso-bar {
        width: 100%;
        height: 16px;
        background: #e0e0e0;
        border: 1px solid black;
        position: relative;
    }
    
    .progreso-fill {
        height: 100%;
        background: green;
    }
    
    .progreso-text {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 10px;
        line-height: 16px;
    }
    
    /* === BOTONES === */
    
    .btn {
        background: white;
        border: 2px solid black;
        padding: 8px 16px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        cursor: pointer;
        text-transform: uppercase;
    }
    
    .btn:hover {
        background: #f0f0f0;
    }
    
    .btn:disabled {
        background: #e0e0e0;
        border-color: #999;
        cursor: not-allowed;
        color: #666;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 10px;
    }
    
    .btn-primary {
        border-color: #0066cc;
    }
    
    .btn-success {
        border-color: green;
    }
    
    .btn-danger {
        border-color: red;
    }
    
    /* === MODAL === */
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .modal-box {
        background: white;
        border: 3px solid black;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        background: black;
        color: white;
        padding: 12px;
        font-size: 13px;
        font-weight: bold;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        border-top: 2px solid black;
        padding: 15px;
        text-align: right;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    /* === FORMULARIO === */
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        font-size: 11px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .input-text {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        border: 1px solid black;
        padding: 6px;
        background: white;
        width: 100%;
    }
    
    .input-text:disabled {
        background: #e0e0e0;
    }
    
    /* === HISTORIAL === */
    
    .historial-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background: #fafafa;
    }
    
    .historial-fecha {
        font-size: 10px;
        color: #666;
    }
    
    .historial-accion {
        font-weight: bold;
        font-size: 11px;
    }
    
    .historial-usuario {
        font-size: 10px;
        color: #333;
    }
    
    /* === LOADING/EMPTY === */
    
    .loading-cell {
        text-align: center;
        padding: 40px;
        font-size: 12px;
    }
    
    .empty-cell {
        text-align: center;
        padding: 40px;
        font-size: 12px;
        color: #666;
    }
    
    /* === ALERTAS === */
    
    .alertas-section {
        border: 2px solid red;
        padding: 10px;
        margin-bottom: 20px;
        background: #fff0f0;
    }
    
    .alertas-titulo {
        font-weight: bold;
        font-size: 12px;
        color: red;
        margin-bottom: 10px;
    }
    
    .alerta-item {
        font-size: 11px;
        padding: 5px;
        border-bottom: 1px solid #ffcccc;
    }
    
    .alerta-item:last-child {
        border-bottom: none;
    }
</style>

<div class="seguimiento-container">
    <!-- Header -->
    <div class="seguimiento-header">
        <h1 class="seguimiento-title">SEGUIMIENTO DE PERMISOS</h1>
        <div class="seguimiento-info">
            @DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy - HH:mm", new System.Globalization.CultureInfo("es-CO"))
            | Usuario: @usuarioNombre
        </div>
    </div>
    
    @if (cargando)
    {
        <div class="loading-cell">CARGANDO DATOS...</div>
    }
    else
    {
        <!-- Alertas urgentes -->
        @if (alertasUrgentes.Any())
        {
            <div class="alertas-section">
                <div class="alertas-titulo">⚠ ALERTAS URGENTES (@alertasUrgentes.Count)</div>
                @foreach (var alerta in alertasUrgentes.Take(5))
                {
                    <div class="alerta-item">
                        <strong>@alerta.NumeroActa</strong> - @alerta.Mensaje
                        <button class="btn btn-sm" @onclick="() => VerPermiso(alerta.PermisoId)">VER</button>
                    </div>
                }
            </div>
        }
        
        <!-- Dashboard de Estadísticas -->
        <div class="dashboard-grid">
            <div class="stat-card urgente">
                <h3>DOCUMENTOS VENCIDOS</h3>
                <div class="stat-number">@estadisticas.TotalDocumentosVencidos</div>
            </div>
            
            <div class="stat-card warning">
                <h3>PENDIENTES DOCUMENTO</h3>
                <div class="stat-number">@estadisticas.TotalPendientesDocumento</div>
            </div>
            
            <div class="stat-card info">
                <h3>EN COMPENSACIÓN</h3>
                <div class="stat-number">@estadisticas.TotalEnCompensacion</div>
            </div>
            
            <div class="stat-card">
                <h3>PARA DESCUENTO</h3>
                <div class="stat-number">@estadisticas.TotalParaDescuento</div>
                <div class="stat-amount">$@estadisticas.MontoTotalDescuentos.ToString("N0")</div>
            </div>
        </div>
        
        <!-- Tabs de Seguimiento -->
        <div class="seguimiento-tabs">
            <button class="@(tabActivo == "documentos" ? "active" : "")" 
                    @onclick='() => CambiarTab("documentos")'>
                PENDIENTES DOCUMENTO (@estadisticas.TotalPendientesDocumento)
            </button>
            <button class="@(tabActivo == "compensacion" ? "active" : "")" 
                    @onclick='() => CambiarTab("compensacion")'>
                EN COMPENSACIÓN (@estadisticas.TotalEnCompensacion)
            </button>
            <button class="@(tabActivo == "descuentos" ? "active" : "")" 
                    @onclick='() => CambiarTab("descuentos")'>
                PARA DESCUENTO (@estadisticas.TotalParaDescuento)
            </button>
            <button class="@(tabActivo == "vencidos" ? "active" : "")" 
                    @onclick='() => CambiarTab("vencidos")'>
                VENCIDOS (@(estadisticas.TotalDocumentosVencidos + estadisticas.TotalCompensacionesVencidas))
            </button>
        </div>
        
        <!-- Contenido según tab -->
        <div class="seguimiento-content">
            @if (tabActivo == "documentos")
            {
                <TablaPendientesDocumento 
                    Permisos="permisosPendientesDoc" 
                    OnVerDetalle="VerDetallePermiso"
                    OnRegistrarDocumento="AbrirModalDocumento" />
            }
            else if (tabActivo == "compensacion")
            {
                <TablaEnCompensacion 
                    Permisos="permisosEnCompensacion" 
                    OnVerDetalle="VerDetallePermiso"
                    OnRegistrarHoras="AbrirModalCompensacion" />
            }
            else if (tabActivo == "descuentos")
            {
                <TablaParaDescuento 
                    Permisos="permisosParaDescuento" 
                    OnVerDetalle="VerDetallePermiso" />
            }
            else if (tabActivo == "vencidos")
            {
                <TablaVencidos 
                    Permisos="permisosVencidos" 
                    OnVerDetalle="VerDetallePermiso"
                    OnCambiarResolucion="AbrirModalCambioResolucion" />
            }
        </div>
    }
</div>

<!-- Modal de Detalle -->
@if (mostrarModalDetalle && permisoSeleccionado != null)
{
    <ModalSeguimientoPermiso 
        Permiso="permisoSeleccionado"
        Seguimientos="seguimientosPermiso"
        Compensaciones="compensacionesPermiso"
        OnCerrar="CerrarModalDetalle" />
}

<!-- Modal Registrar Documento -->
@if (mostrarModalDocumento)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-box" @onclick:stopPropagation>
            <div class="modal-header">REGISTRAR ENTREGA DE DOCUMENTO</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PERMISO</label>
                    <input type="text" class="input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="form-group">
                    <label class="form-label">OBSERVACIONES</label>
                    <textarea class="input-text" rows="3" @bind="observacionDocumento"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn btn-success" @onclick="ConfirmarEntregaDocumento">CONFIRMAR ENTREGA</button>
            </div>
        </div>
    </div>
}

<!-- Modal Registrar Compensación -->
@if (mostrarModalCompensacion)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-box" @onclick:stopPropagation>
            <div class="modal-header">REGISTRAR HORAS COMPENSADAS</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PERMISO</label>
                    <input type="text" class="input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="form-group">
                    <label class="form-label">HORAS A COMPENSAR: @permisoParaAccion?.HorasCompensar | COMPENSADAS: @permisoParaAccion?.HorasCompensadas</label>
                </div>
                <div class="form-group">
                    <label class="form-label">FECHA COMPENSACIÓN</label>
                    <input type="date" class="input-text" @bind="fechaCompensacion" />
                </div>
                <div class="form-group">
                    <label class="form-label">HORAS TRABAJADAS</label>
                    <input type="number" class="input-text" @bind="horasCompensadas" min="1" max="12" />
                </div>
                <div class="form-group">
                    <label class="form-label">DESCRIPCIÓN ACTIVIDAD</label>
                    <textarea class="input-text" rows="3" @bind="descripcionCompensacion"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn btn-success" @onclick="ConfirmarCompensacion">REGISTRAR HORAS</button>
            </div>
        </div>
    </div>
}

<!-- Modal Cambiar Resolución -->
@if (mostrarModalCambioResolucion)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-box" @onclick:stopPropagation>
            <div class="modal-header">CAMBIAR RESOLUCIÓN DE PERMISO</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PERMISO</label>
                    <input type="text" class="input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="form-group">
                    <label class="form-label">NUEVA RESOLUCIÓN</label>
                    <select class="input-text" @bind="nuevaResolucion">
                        <option value="2">DESCONTADO (Se descuenta en nómina)</option>
                        <option value="1">REMUNERADO (No se descuenta)</option>
                    </select>
                </div>
                @if (nuevaResolucion == 2)
                {
                    <div class="form-group">
                        <label class="form-label">MONTO A DESCONTAR</label>
                        <input type="number" class="input-text" @bind="montoDescuento" step="1000" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">PERÍODO DE DESCUENTO</label>
                        <input type="text" class="input-text" @bind="periodoDescuento" placeholder="AAAA-MM" />
                    </div>
                }
                <div class="form-group">
                    <label class="form-label">MOTIVO DEL CAMBIO</label>
                    <textarea class="input-text" rows="3" @bind="motivoCambioResolucion"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="btn btn-danger" @onclick="ConfirmarCambioResolucion">CONFIRMAR CAMBIO</button>
            </div>
        </div>
    </div>
}

@code {
    // Estados
    private bool cargando = true;
    private string tabActivo = "documentos";
    private string usuarioNombre = "";
    private int usuarioId = 0;
    
    // Datos
    private EstadisticasSeguimiento estadisticas = new();
    private List<PermisoConSeguimiento> permisosPendientesDoc = new();
    private List<PermisoConSeguimiento> permisosEnCompensacion = new();
    private List<PermisoConSeguimiento> permisosParaDescuento = new();
    private List<PermisoConSeguimiento> permisosVencidos = new();
    private List<AlertaPermiso> alertasUrgentes = new();
    
    // Modal detalle
    private bool mostrarModalDetalle = false;
    private Permiso? permisoSeleccionado = null;
    private List<SeguimientoPermiso> seguimientosPermiso = new();
    private List<CompensacionHoras> compensacionesPermiso = new();
    
    // Modal documento
    private bool mostrarModalDocumento = false;
    private PermisoConSeguimiento? permisoParaAccion = null;
    private string observacionDocumento = "";
    
    // Modal compensación
    private bool mostrarModalCompensacion = false;
    private DateTime fechaCompensacion = DateTime.Now.Date;
    private int horasCompensadas = 0;
    private string descripcionCompensacion = "";
    
    // Modal cambio resolución
    private bool mostrarModalCambioResolucion = false;
    private int nuevaResolucion = 2;
    private decimal montoDescuento = 0;
    private string periodoDescuento = DateTime.Now.ToString("yyyy-MM");
    private string motivoCambioResolucion = "";
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!AuthService.IsAuthenticated || AuthService.CurrentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }
            
            usuarioNombre = AuthService.CurrentUser.NombreCompleto ?? "Usuario";
            usuarioId = AuthService.CurrentUser.Id;
            
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar SeguimientoPermisos");
        }
        finally
        {
            cargando = false;
        }
    }
    
    private async Task CargarDatos()
    {
        estadisticas = await PermisoRepository.GetEstadisticasSeguimientoAsync();
        
        permisosPendientesDoc = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloPendientesDocumento: true)).ToList();
        
        permisosEnCompensacion = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloEnCompensacion: true)).ToList();
        
        permisosParaDescuento = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            tipoResolucion: TipoResolucionPermiso.Descontado)).ToList();
        
        permisosVencidos = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloVencidos: true)).ToList();
        
        var alertas = await AlertaService.GetAlertasActivasAsync();
        alertasUrgentes = alertas.Where(a => a.EsUrgente).Take(10).ToList();
        
        StateHasChanged();
    }
    
    private void CambiarTab(string tab)
    {
        tabActivo = tab;
        StateHasChanged();
    }
    
    private void VerPermiso(int permisoId)
    {
        Navigation.NavigateTo($"/permisos/{permisoId}");
    }
    
    private async Task VerDetallePermiso(int permisoId)
    {
        permisoSeleccionado = await PermisoRepository.GetByIdAsync(permisoId);
        if (permisoSeleccionado != null)
        {
            seguimientosPermiso = (await SeguimientoRepository.GetByPermisoIdAsync(permisoId)).ToList();
            compensacionesPermiso = (await CompensacionRepository.GetByPermisoIdAsync(permisoId)).ToList();
            mostrarModalDetalle = true;
            StateHasChanged();
        }
    }
    
    private void CerrarModalDetalle()
    {
        mostrarModalDetalle = false;
        permisoSeleccionado = null;
        StateHasChanged();
    }
    
    private void AbrirModalDocumento(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        observacionDocumento = "";
        mostrarModalDocumento = true;
        StateHasChanged();
    }
    
    private void AbrirModalCompensacion(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        fechaCompensacion = DateTime.Now.Date;
        horasCompensadas = 0;
        descripcionCompensacion = "";
        mostrarModalCompensacion = true;
        StateHasChanged();
    }
    
    private void AbrirModalCambioResolucion(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        nuevaResolucion = 2;
        montoDescuento = 0;
        periodoDescuento = DateTime.Now.ToString("yyyy-MM");
        motivoCambioResolucion = "";
        mostrarModalCambioResolucion = true;
        StateHasChanged();
    }
    
    private void CerrarModales()
    {
        mostrarModalDocumento = false;
        mostrarModalCompensacion = false;
        mostrarModalCambioResolucion = false;
        permisoParaAccion = null;
        StateHasChanged();
    }
    
    private async Task ConfirmarEntregaDocumento()
    {
        if (permisoParaAccion == null) return;
        
        try
        {
            await PermisoRepository.RegistrarEntregaDocumentoAsync(
                permisoParaAccion.Id, 
                "documento_entregado_manual", 
                usuarioId);
            
            await SeguimientoRepository.RegistrarAccionAsync(
                permisoParaAccion.Id,
                TipoAccionSeguimiento.DocumentoEntregado,
                $"Documento entregado. {observacionDocumento}",
                usuarioId);
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar entrega de documento");
        }
    }
    
    private async Task ConfirmarCompensacion()
    {
        if (permisoParaAccion == null || horasCompensadas <= 0) return;
        
        try
        {
            await CompensacionRepository.RegistrarCompensacionAsync(
                permisoParaAccion.Id,
                fechaCompensacion,
                horasCompensadas,
                descripcionCompensacion,
                usuarioId);
            
            var totalCompensado = permisoParaAccion.HorasCompensadas + horasCompensadas;
            await PermisoRepository.ActualizarHorasCompensadasAsync(permisoParaAccion.Id, totalCompensado);
            
            // Si completó todas las horas, marcar como completado
            if (totalCompensado >= (permisoParaAccion.HorasCompensar ?? 0))
            {
                await PermisoRepository.MarcarCompletadoAsync(permisoParaAccion.Id);
                
                await SeguimientoRepository.RegistrarAccionAsync(
                    permisoParaAccion.Id,
                    TipoAccionSeguimiento.Completado,
                    $"Compensación completada. Total: {totalCompensado} horas",
                    usuarioId);
            }
            else
            {
                await SeguimientoRepository.RegistrarAccionAsync(
                    permisoParaAccion.Id,
                    TipoAccionSeguimiento.HorasCompensadas,
                    $"Registradas {horasCompensadas} horas. Total acumulado: {totalCompensado} de {permisoParaAccion.HorasCompensar}",
                    usuarioId);
            }
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar compensación");
        }
    }
    
    private async Task ConfirmarCambioResolucion()
    {
        if (permisoParaAccion == null || string.IsNullOrWhiteSpace(motivoCambioResolucion)) return;
        
        try
        {
            var resolucion = (TipoResolucionPermiso)nuevaResolucion;
            await PermisoRepository.ActualizarResolucionAsync(permisoParaAccion.Id, resolucion);
            
            // Si es descuento, actualizar monto y período
            if (resolucion == TipoResolucionPermiso.Descontado)
            {
                var permiso = await PermisoRepository.GetByIdAsync(permisoParaAccion.Id);
                if (permiso != null)
                {
                    permiso.MontoDescuento = montoDescuento;
                    permiso.PeriodoDescuento = periodoDescuento;
                    permiso.Completado = true;
                    permiso.Estado = EstadoPermiso.Completado;
                    await PermisoRepository.UpdateAsync(permiso);
                }
            }
            
            await SeguimientoRepository.RegistrarAccionAsync(
                permisoParaAccion.Id,
                TipoAccionSeguimiento.CambioResolucion,
                $"Cambio de resolución a {resolucion}. Motivo: {motivoCambioResolucion}",
                usuarioId);
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cambiar resolución");
        }
    }
}
