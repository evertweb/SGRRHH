@page "/seguimiento-permisos"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@inject IPermisoRepository PermisoRepository
@inject ISeguimientoPermisoRepository SeguimientoRepository
@inject ICompensacionHorasRepository CompensacionRepository
@inject IAlertaPermisoService AlertaService
@inject ICatalogCacheService CatalogCache
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<SeguimientoPermisos> Logger

<PageTitle>Seguimiento de Permisos - SGRRHH</PageTitle>

<div class="seguimiento-permisos-container">
    <!-- Header -->
    <div class="seguimiento-permisos-header">
        <h1 class="seguimiento-permisos-title">SEGUIMIENTO DE PERMISOS</h1>
        <div class="seguimiento-permisos-info">
            @DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy - HH:mm", new System.Globalization.CultureInfo("es-CO"))
            | Usuario: @usuarioNombre
        </div>
    </div>
    
    @if (cargando)
    {
        <div class="seguimiento-permisos-loading-cell">CARGANDO DATOS...</div>
    }
    else
    {
        <!-- Alertas urgentes -->
        @if (alertasUrgentes.Any())
        {
            <div class="seguimiento-permisos-alertas-section">
                <div class="seguimiento-permisos-alertas-titulo">⚠ ALERTAS URGENTES (@alertasUrgentes.Count)</div>
                @foreach (var alerta in alertasUrgentes.Take(5))
                {
                    <div class="seguimiento-permisos-alerta-item">
                        <strong>@alerta.NumeroActa</strong> - @alerta.Mensaje
                        <button class="seguimiento-permisos-btn seguimiento-permisos-btn-sm" @onclick="() => VerPermiso(alerta.PermisoId)">VER</button>
                    </div>
                }
            </div>
        }
        
        <!-- Dashboard de Estadísticas -->
        <div class="seguimiento-permisos-dashboard-grid">
            <div class="seguimiento-permisos-stat-card urgente">
                <h3>DOCUMENTOS VENCIDOS</h3>
                <div class="seguimiento-permisos-stat-number">@estadisticas.TotalDocumentosVencidos</div>
            </div>
            
            <div class="seguimiento-permisos-stat-card warning">
                <h3>PENDIENTES DOCUMENTO</h3>
                <div class="seguimiento-permisos-stat-number">@estadisticas.TotalPendientesDocumento</div>
            </div>
            
            <div class="seguimiento-permisos-stat-card info">
                <h3>EN COMPENSACIÓN</h3>
                <div class="seguimiento-permisos-stat-number">@estadisticas.TotalEnCompensacion</div>
            </div>
            
            <div class="seguimiento-permisos-stat-card">
                <h3>PARA DESCUENTO</h3>
                <div class="seguimiento-permisos-stat-number">@estadisticas.TotalParaDescuento</div>
                <div class="seguimiento-permisos-stat-amount">$@estadisticas.MontoTotalDescuentos.ToString("N0")</div>
            </div>
        </div>
        
        <!-- Tabs de Seguimiento -->
        <div class="seguimiento-permisos-tabs">
            <button class="@(tabActivo == "documentos" ? "active" : "")" 
                    @onclick='() => CambiarTab("documentos")'>
                PENDIENTES DOCUMENTO (@estadisticas.TotalPendientesDocumento)
            </button>
            <button class="@(tabActivo == "compensacion" ? "active" : "")" 
                    @onclick='() => CambiarTab("compensacion")'>
                EN COMPENSACIÓN (@estadisticas.TotalEnCompensacion)
            </button>
            <button class="@(tabActivo == "descuentos" ? "active" : "")" 
                    @onclick='() => CambiarTab("descuentos")'>
                PARA DESCUENTO (@estadisticas.TotalParaDescuento)
            </button>
            <button class="@(tabActivo == "vencidos" ? "active" : "")" 
                    @onclick='() => CambiarTab("vencidos")'>
                VENCIDOS (@(estadisticas.TotalDocumentosVencidos + estadisticas.TotalCompensacionesVencidas))
            </button>
        </div>
        
        <!-- Contenido según tab -->
        <div class="seguimiento-permisos-content">
            @if (tabActivo == "documentos")
            {
                <TablaPendientesDocumento 
                    Permisos="permisosPendientesDoc" 
                    OnVerDetalle="VerDetallePermiso"
                    OnRegistrarDocumento="AbrirModalDocumento" />
            }
            else if (tabActivo == "compensacion")
            {
                <TablaEnCompensacion 
                    Permisos="permisosEnCompensacion" 
                    OnVerDetalle="VerDetallePermiso"
                    OnRegistrarHoras="AbrirModalCompensacion" />
            }
            else if (tabActivo == "descuentos")
            {
                <TablaParaDescuento 
                    Permisos="permisosParaDescuento" 
                    OnVerDetalle="VerDetallePermiso" />
            }
            else if (tabActivo == "vencidos")
            {
                <TablaVencidos 
                    Permisos="permisosVencidos" 
                    OnVerDetalle="VerDetallePermiso"
                    OnCambiarResolucion="AbrirModalCambioResolucion" />
            }
        </div>
    }
</div>

<!-- Modal de Detalle -->
@if (mostrarModalDetalle && permisoSeleccionado != null)
{
    <ModalSeguimientoPermiso 
        Permiso="permisoSeleccionado"
        Seguimientos="seguimientosPermiso"
        Compensaciones="compensacionesPermiso"
        OnCerrar="CerrarModalDetalle" />
}

<!-- Modal Registrar Documento -->
@if (mostrarModalDocumento)
{
    <div class="seguimiento-permisos-modal-overlay" @onclick="CerrarModales">
        <div class="seguimiento-permisos-modal-box" @onclick:stopPropagation>
            <div class="seguimiento-permisos-modal-header">REGISTRAR ENTREGA DE DOCUMENTO</div>
            <div class="seguimiento-permisos-modal-body">
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">PERMISO</label>
                    <input type="text" class="seguimiento-permisos-input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">OBSERVACIONES</label>
                    <textarea class="seguimiento-permisos-input-text" rows="3" @bind="observacionDocumento"></textarea>
                </div>
            </div>
            <div class="seguimiento-permisos-modal-footer">
                <button class="seguimiento-permisos-btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="seguimiento-permisos-btn seguimiento-permisos-btn-success" @onclick="ConfirmarEntregaDocumento">CONFIRMAR ENTREGA</button>
            </div>
        </div>
    </div>
}

<!-- Modal Registrar Compensación -->
@if (mostrarModalCompensacion)
{
    <div class="seguimiento-permisos-modal-overlay" @onclick="CerrarModales">
        <div class="seguimiento-permisos-modal-box" @onclick:stopPropagation>
            <div class="seguimiento-permisos-modal-header">REGISTRAR HORAS COMPENSADAS</div>
            <div class="seguimiento-permisos-modal-body">
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">PERMISO</label>
                    <input type="text" class="seguimiento-permisos-input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">HORAS A COMPENSAR: @permisoParaAccion?.HorasCompensar | COMPENSADAS: @permisoParaAccion?.HorasCompensadas</label>
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">FECHA COMPENSACIÓN</label>
                    <input type="date" class="seguimiento-permisos-input-text" @bind="fechaCompensacion" />
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">HORAS TRABAJADAS</label>
                    <input type="number" class="seguimiento-permisos-input-text" @bind="horasCompensadas" min="1" max="12" />
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">DESCRIPCIÓN ACTIVIDAD</label>
                    <textarea class="seguimiento-permisos-input-text" rows="3" @bind="descripcionCompensacion"></textarea>
                </div>
            </div>
            <div class="seguimiento-permisos-modal-footer">
                <button class="seguimiento-permisos-btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="seguimiento-permisos-btn seguimiento-permisos-btn-success" @onclick="ConfirmarCompensacion">REGISTRAR HORAS</button>
            </div>
        </div>
    </div>
}

<!-- Modal Cambiar Resolución -->
@if (mostrarModalCambioResolucion)
{
    <div class="seguimiento-permisos-modal-overlay" @onclick="CerrarModales">
        <div class="seguimiento-permisos-modal-box" @onclick:stopPropagation>
            <div class="seguimiento-permisos-modal-header">CAMBIAR RESOLUCIÓN DE PERMISO</div>
            <div class="seguimiento-permisos-modal-body">
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">PERMISO</label>
                    <input type="text" class="seguimiento-permisos-input-text" value="@permisoParaAccion?.NumeroActa" disabled />
                </div>
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">NUEVA RESOLUCIÓN</label>
                    <select class="seguimiento-permisos-input-text" @bind="nuevaResolucion">
                        <option value="2">DESCONTADO (Se descuenta en nómina)</option>
                        <option value="1">REMUNERADO (No se descuenta)</option>
                    </select>
                </div>
                @if (nuevaResolucion == 2)
                {
                    <div class="seguimiento-permisos-form-group">
                        <label class="seguimiento-permisos-form-label">MONTO A DESCONTAR</label>
                        <input type="number" class="seguimiento-permisos-input-text" @bind="montoDescuento" step="1000" />
                    </div>
                    <div class="seguimiento-permisos-form-group">
                        <label class="seguimiento-permisos-form-label">PERÍODO DE DESCUENTO</label>
                        <input type="text" class="seguimiento-permisos-input-text" @bind="periodoDescuento" placeholder="AAAA-MM" />
                    </div>
                }
                <div class="seguimiento-permisos-form-group">
                    <label class="seguimiento-permisos-form-label">MOTIVO DEL CAMBIO</label>
                    <textarea class="seguimiento-permisos-input-text" rows="3" @bind="motivoCambioResolucion"></textarea>
                </div>
            </div>
            <div class="seguimiento-permisos-modal-footer">
                <button class="seguimiento-permisos-btn" @onclick="CerrarModales">CANCELAR</button>
                <button class="seguimiento-permisos-btn seguimiento-permisos-btn-danger" @onclick="ConfirmarCambioResolucion">CONFIRMAR CAMBIO</button>
            </div>
        </div>
    </div>
}

@code {
    // Estados
    [SupplyParameterFromQuery(Name = "tab")]
    public string? TabQuery { get; set; }
    
    private bool cargando = true;
    private string tabActivo = "documentos";
    private string usuarioNombre = "";
    private int usuarioId = 0;
    private static readonly HashSet<string> _tabsValidos = new() { "documentos", "compensacion", "descuentos", "vencidos" };
    
    // Datos
    private EstadisticasSeguimiento estadisticas = new();
    private List<PermisoConSeguimiento> permisosPendientesDoc = new();
    private List<PermisoConSeguimiento> permisosEnCompensacion = new();
    private List<PermisoConSeguimiento> permisosParaDescuento = new();
    private List<PermisoConSeguimiento> permisosVencidos = new();
    private List<AlertaPermiso> alertasUrgentes = new();
    
    // Modal detalle
    private bool mostrarModalDetalle = false;
    private Permiso? permisoSeleccionado = null;
    private List<SeguimientoPermiso> seguimientosPermiso = new();
    private List<CompensacionHoras> compensacionesPermiso = new();
    
    // Modal documento
    private bool mostrarModalDocumento = false;
    private PermisoConSeguimiento? permisoParaAccion = null;
    private string observacionDocumento = "";
    
    // Modal compensación
    private bool mostrarModalCompensacion = false;
    private DateTime fechaCompensacion = DateTime.Now.Date;
    private int horasCompensadas = 0;
    private string descripcionCompensacion = "";
    
    // Modal cambio resolución
    private bool mostrarModalCambioResolucion = false;
    private int nuevaResolucion = 2;
    private decimal montoDescuento = 0;
    private string periodoDescuento = DateTime.Now.ToString("yyyy-MM");
    private string motivoCambioResolucion = "";
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!AuthService.IsAuthenticated || AuthService.CurrentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }
            
            usuarioNombre = AuthService.CurrentUser.NombreCompleto ?? "Usuario";
            usuarioId = AuthService.CurrentUser.Id;
            
            // Leer tab desde URL
            if (!string.IsNullOrEmpty(TabQuery) && _tabsValidos.Contains(TabQuery))
            {
                tabActivo = TabQuery;
            }
            
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al inicializar SeguimientoPermisos");
        }
        finally
        {
            cargando = false;
        }
    }
    
    private async Task CargarDatos()
    {
        estadisticas = await PermisoRepository.GetEstadisticasSeguimientoAsync();
        
        permisosPendientesDoc = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloPendientesDocumento: true)).ToList();
        
        permisosEnCompensacion = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloEnCompensacion: true)).ToList();
        
        permisosParaDescuento = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            tipoResolucion: TipoResolucionPermiso.Descontado)).ToList();
        
        permisosVencidos = (await PermisoRepository.GetPermisosParaSeguimientoAsync(
            soloVencidos: true)).ToList();
        
        var alertas = await AlertaService.GetAlertasActivasAsync();
        alertasUrgentes = alertas.Where(a => a.EsUrgente).Take(10).ToList();
        
        StateHasChanged();
    }
    
    private void CambiarTab(string tab)
    {
        tabActivo = tab;
        var uri = Navigation.GetUriWithQueryParameter("tab", tab);
        Navigation.NavigateTo(uri, replace: true);
    }
    
    private void VerPermiso(int permisoId)
    {
        Navigation.NavigateTo($"/permisos/{permisoId}");
    }
    
    private async Task VerDetallePermiso(int permisoId)
    {
        permisoSeleccionado = await PermisoRepository.GetByIdAsync(permisoId);
        if (permisoSeleccionado != null)
        {
            seguimientosPermiso = (await SeguimientoRepository.GetByPermisoIdAsync(permisoId)).ToList();
            compensacionesPermiso = (await CompensacionRepository.GetByPermisoIdAsync(permisoId)).ToList();
            mostrarModalDetalle = true;
            StateHasChanged();
        }
    }
    
    private void CerrarModalDetalle()
    {
        mostrarModalDetalle = false;
        permisoSeleccionado = null;
        StateHasChanged();
    }
    
    private void AbrirModalDocumento(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        observacionDocumento = "";
        mostrarModalDocumento = true;
        StateHasChanged();
    }
    
    private void AbrirModalCompensacion(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        fechaCompensacion = DateTime.Now.Date;
        horasCompensadas = 0;
        descripcionCompensacion = "";
        mostrarModalCompensacion = true;
        StateHasChanged();
    }
    
    private void AbrirModalCambioResolucion(PermisoConSeguimiento permiso)
    {
        permisoParaAccion = permiso;
        nuevaResolucion = 2;
        montoDescuento = 0;
        periodoDescuento = DateTime.Now.ToString("yyyy-MM");
        motivoCambioResolucion = "";
        mostrarModalCambioResolucion = true;
        StateHasChanged();
    }
    
    private void CerrarModales()
    {
        mostrarModalDocumento = false;
        mostrarModalCompensacion = false;
        mostrarModalCambioResolucion = false;
        permisoParaAccion = null;
        StateHasChanged();
    }
    
    private async Task ConfirmarEntregaDocumento()
    {
        if (permisoParaAccion == null) return;
        
        try
        {
            await PermisoRepository.RegistrarEntregaDocumentoAsync(
                permisoParaAccion.Id, 
                "documento_entregado_manual", 
                usuarioId);
            
            await SeguimientoRepository.RegistrarAccionAsync(
                permisoParaAccion.Id,
                TipoAccionSeguimiento.DocumentoEntregado,
                $"Documento entregado. {observacionDocumento}",
                usuarioId);
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar entrega de documento");
        }
    }
    
    private async Task ConfirmarCompensacion()
    {
        if (permisoParaAccion == null || horasCompensadas <= 0) return;
        
        try
        {
            await CompensacionRepository.RegistrarCompensacionAsync(
                permisoParaAccion.Id,
                fechaCompensacion,
                horasCompensadas,
                descripcionCompensacion,
                usuarioId);
            
            var totalCompensado = permisoParaAccion.HorasCompensadas + horasCompensadas;
            await PermisoRepository.ActualizarHorasCompensadasAsync(permisoParaAccion.Id, totalCompensado);
            
            // Si completó todas las horas, marcar como completado
            if (totalCompensado >= (permisoParaAccion.HorasCompensar ?? 0))
            {
                await PermisoRepository.MarcarCompletadoAsync(permisoParaAccion.Id);
                
                await SeguimientoRepository.RegistrarAccionAsync(
                    permisoParaAccion.Id,
                    TipoAccionSeguimiento.Completado,
                    $"Compensación completada. Total: {totalCompensado} horas",
                    usuarioId);
            }
            else
            {
                await SeguimientoRepository.RegistrarAccionAsync(
                    permisoParaAccion.Id,
                    TipoAccionSeguimiento.HorasCompensadas,
                    $"Registradas {horasCompensadas} horas. Total acumulado: {totalCompensado} de {permisoParaAccion.HorasCompensar}",
                    usuarioId);
            }
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al registrar compensación");
        }
    }
    
    private async Task ConfirmarCambioResolucion()
    {
        if (permisoParaAccion == null || string.IsNullOrWhiteSpace(motivoCambioResolucion)) return;
        
        try
        {
            var resolucion = (TipoResolucionPermiso)nuevaResolucion;
            await PermisoRepository.ActualizarResolucionAsync(permisoParaAccion.Id, resolucion);
            
            // Si es descuento, actualizar monto y período
            if (resolucion == TipoResolucionPermiso.Descontado)
            {
                var permiso = await PermisoRepository.GetByIdAsync(permisoParaAccion.Id);
                if (permiso != null)
                {
                    permiso.MontoDescuento = montoDescuento;
                    permiso.PeriodoDescuento = periodoDescuento;
                    permiso.Completado = true;
                    permiso.Estado = EstadoPermiso.Completado;
                    await PermisoRepository.UpdateAsync(permiso);
                }
            }
            
            await SeguimientoRepository.RegistrarAccionAsync(
                permisoParaAccion.Id,
                TipoAccionSeguimiento.CambioResolucion,
                $"Cambio de resolución a {resolucion}. Motivo: {motivoCambioResolucion}",
                usuarioId);
            
            CerrarModales();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cambiar resolución");
        }
    }
}
