@page "/contratos"
@page "/contratos/{EmpleadoIdParam:int?}"
@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService AuthService
@inject IContratoRepository ContratoRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject ICargoRepository CargoRepository
@inject ILocalStorageService StorageService
@inject IKeyboardShortcutService KeyboardShortcutService
@inject NavigationManager Navigation
@inject ILogger<Contratos> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Contratos - SGRRHH</PageTitle>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Courier New', monospace;
        background: #FFFFFF;
        color: #000000;
        min-width: 1024px;
    }

    .page-container {
        width: 100%;
        min-width: 1024px;
        padding: 20px;
    }

    .page-header {
        border-bottom: 2px solid #000000;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 18px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .action-bar {
        border: 1px solid #000000;
        padding: 10px;
        margin-bottom: 20px;
        background: #FFFFFF;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .btn {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 8px 16px;
        border: 2px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
    }

    .btn:hover:not(:disabled) {
        background: #F0F0F0;
    }

    .btn:disabled {
        border-color: #CCCCCC;
        color: #CCCCCC;
        cursor: not-allowed;
        background: #F9F9F9;
    }

    .filter-section {
        border-top: 1px solid #CCCCCC;
        padding-top: 10px;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-label {
        font-size: 11px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
    }

    .filter-input,
    .filter-select {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 6px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        min-width: 200px;
    }

    .filter-select {
        min-width: 150px;
    }

    .results-info {
        font-size: 12px;
        color: #000000;
        padding: 10px 0;
        border-bottom: 1px solid #CCCCCC;
        margin-bottom: 10px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid #000000;
        background: #FFFFFF;
        font-size: 11px;
    }

    .data-table thead {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
    }

    .data-table th {
        padding: 8px;
        text-align: left;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        border-right: 1px solid #CCCCCC;
        font-size: 10px;
        letter-spacing: 1px;
    }

    .data-table th:last-child {
        border-right: none;
    }

    .data-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #CCCCCC;
        border-right: 1px solid #CCCCCC;
        color: #000000;
    }

    .data-table td:last-child {
        border-right: none;
    }

    .data-table tbody tr:hover {
        background: #F9F9F9;
    }

    .data-table tbody tr.selected {
        background: #E8E8E8;
    }

    .data-table tbody tr.row-warning {
        background: #FFFACD;
    }

    .loading-message,
    .empty-message {
        text-align: center;
        padding: 40px;
        color: #666666;
        font-size: 12px;
    }

    .cell-code {
        font-weight: bold;
    }

    .cell-estado {
        text-transform: uppercase;
        font-size: 10px;
    }

    .estado-activo {
        color: #006400;
    }

    .estado-finalizado {
        color: #8B0000;
    }

    .estado-renovado {
        color: #4B0082;
    }

    .estado-cancelado {
        color: #DC143C;
    }

    .cell-actions {
        white-space: nowrap;
    }

    .btn-table {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 4px 8px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
        cursor: pointer;
        margin-right: 4px;
        text-transform: uppercase;
    }

    .btn-table:hover {
        background: #F0F0F0;
    }

    .shortcuts-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #000000;
        color: #FFFFFF;
        padding: 8px 20px;
        font-size: 11px;
        border-top: 2px solid #000000;
        display: flex;
        gap: 20px;
        z-index: 1000;
    }

    .shortcut-item {
        display: flex;
        gap: 5px;
    }

    .shortcut-key {
        font-weight: bold;
        color: #FFFF00;
    }

    .error-message {
        border: 2px solid #FF0000;
        background: #FFFFFF;
        color: #FF0000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .success-message {
        border: 2px solid #008000;
        background: #FFFFFF;
        color: #008000;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .warning-message {
        border: 2px solid #FFA500;
        background: #FFFFFF;
        color: #B8860B;
        padding: 12px;
        margin: 10px 0;
        font-size: 12px;
        font-weight: bold;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-box {
        background: #FFFFFF;
        border: 3px solid #000000;
        padding: 0;
        width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
    }

    .modal-header {
        background: #F0F0F0;
        border-bottom: 2px solid #000000;
        padding: 15px;
    }

    .modal-title {
        font-size: 16px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .modal-content {
        padding: 20px;
    }

    .form-section {
        border: 1px solid #CCCCCC;
        padding: 15px;
        margin-bottom: 15px;
    }

    .section-title {
        font-size: 13px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
        margin-bottom: 10px;
        border-bottom: 1px solid #000000;
        padding-bottom: 5px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-row-full {
        display: block;
        margin-bottom: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-label {
        font-size: 11px;
        font-weight: bold;
        color: #000000;
        text-transform: uppercase;
    }

    .form-label-required::after {
        content: " *";
        color: #FF0000;
    }

    .form-input,
    .form-select,
    .form-textarea {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 6px;
        border: 1px solid #000000;
        background: #FFFFFF;
        color: #000000;
    }

    .form-input:disabled,
    .form-select:disabled {
        background: #F9F9F9;
        color: #CCCCCC;
        border-color: #CCCCCC;
    }

    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-note {
        font-size: 10px;
        color: #666666;
        margin-top: 2px;
    }

    .modal-actions {
        border-top: 2px solid #000000;
        padding: 15px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        background: #F0F0F0;
    }

    .btn-danger {
        background: #FFFFFF;
        color: #FF0000;
        border: 2px solid #FF0000;
    }

    .btn-danger:hover {
        background: #FFE5E5;
    }
</style>

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">GESTIÓN DE CONTRATOS</h1>
    </div>

    @if (errorMessage != null)
    {
        <div class="error-message">
            ERROR: @errorMessage
            <button class="btn" @onclick="() => errorMessage = null" style="margin-left: 10px;">ACEPTAR</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="success-message">
            @successMessage
        </div>
    }

    @if (contratosPorVencer.Any())
    {
        <div class="warning-message">
            ADVERTENCIA: @contratosPorVencer.Count CONTRATO(S) POR VENCER EN LOS PRÓXIMOS 30 DÍAS
        </div>
    }

    <div class="action-bar">
        <div class="action-buttons">
            <button class="btn" @onclick="NuevoContrato">NUEVO (F3)</button>
            <button class="btn" @onclick="CargarContratos">ACTUALIZAR (F5)</button>
            <button class="btn" @onclick="Buscar">BUSCAR (F2)</button>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">BUSCAR EMPLEADO:</label>
                <input type="text" 
                       id="searchInput" 
                       class="filter-input"
                       @bind="searchTerm" 
                       @bind:event="oninput" 
                       @onkeyup="OnSearchKeyUp" />
            </div>
            
            <div class="filter-group">
                <label class="filter-label">ESTADO:</label>
                <select class="filter-select" @bind="filtroEstado" @bind:after="Filtrar">
                    <option value="">TODOS</option>
                    <option value="@((int)EstadoContrato.Activo)">ACTIVOS</option>
                    <option value="@((int)EstadoContrato.Finalizado)">FINALIZADOS</option>
                    <option value="@((int)EstadoContrato.Renovado)">RENOVADOS</option>
                    <option value="@((int)EstadoContrato.Cancelado)">CANCELADOS</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">TIPO:</label>
                <select class="filter-select" @bind="filtroTipo" @bind:after="Filtrar">
                    <option value="">TODOS</option>
                    <option value="@((int)TipoContrato.Indefinido)">INDEFINIDO</option>
                    <option value="@((int)TipoContrato.TerminoFijo)">TÉRMINO FIJO</option>
                    <option value="@((int)TipoContrato.ObraOLabor)">OBRA O LABOR</option>
                    <option value="@((int)TipoContrato.PrestacionServicios)">PRESTACIÓN SERVICIOS</option>
                    <option value="@((int)TipoContrato.Aprendizaje)">APRENDIZAJE</option>
                    <option value="@((int)TipoContrato.Ocasional)">OCASIONAL</option>
                    <option value="@((int)TipoContrato.Temporal)">TEMPORAL</option>
                </select>
            </div>
            
            @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filtroEstado) || !string.IsNullOrEmpty(filtroTipo))
            {
                <button class="btn" @onclick="LimpiarFiltros">LIMPIAR FILTROS</button>
            }
        </div>
    </div>

    <div class="results-info">
        Mostrando @contratos.Count de @totalContratos registro(s)
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>CÓDIGO EMP.</th>
                <th>CÉDULA</th>
                <th>EMPLEADO</th>
                <th>TIPO CONTRATO</th>
                <th>CARGO</th>
                <th>FECHA INICIO</th>
                <th>FECHA FIN</th>
                <th>SALARIO</th>
                <th>ESTADO</th>
                <th>FECHA CREACIÓN</th>
                <th>FECHA MODIFICACIÓN</th>
                <th>ARCHIVO</th>
                <th>ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="14" class="loading-message">CARGANDO DATOS...</td></tr>
            }
            else if (!contratos.Any())
            {
                <tr><td colspan="14" class="empty-message">NO HAY REGISTROS PARA MOSTRAR</td></tr>
            }
            else
            {
                @foreach (var contrato in contratos)
                {
                    var diasParaVencer = contrato.FechaFin.HasValue ? (contrato.FechaFin.Value - DateTime.Today).Days : 0;
                    var porVencer = contrato.Estado == EstadoContrato.Activo && contrato.FechaFin.HasValue && diasParaVencer > 0 && diasParaVencer <= 30;
                    
                    <tr class="@(selectedContrato?.Id == contrato.Id ? "selected" : "") @(porVencer ? "row-warning" : "")"
                        @onclick="() => SelectContrato(contrato)">
                        <td class="cell-code">@contrato.Id</td>
                        <td class="cell-code">@(contrato.Empleado?.Codigo ?? "-")</td>
                        <td>@NumberFormatHelper.FormatearCedula(contrato.Empleado?.Cedula)</td>
                        <td>@(contrato.Empleado?.NombreCompleto ?? "SIN EMPLEADO")</td>
                        <td>@GetTipoContratoDisplay(contrato.TipoContrato).ToUpper()</td>
                        <td>@(contrato.Cargo?.Nombre ?? "-")</td>
                        <td>@contrato.FechaInicio.ToString("dd/MM/yyyy")</td>
                        <td>
                            @if (contrato.FechaFin.HasValue)
                            {
                                @contrato.FechaFin.Value.ToString("dd/MM/yyyy")
                                @if (porVencer)
                                {
                                    <text> (@diasParaVencer DÍAS)</text>
                                }
                            }
                            else
                            {
                                <text>INDEFINIDO</text>
                            }
                        </td>
                        <td>@NumberFormatHelper.FormatearMoneda(contrato.Salario)</td>
                        <td class="cell-estado estado-@contrato.Estado.ToString().ToLower()">@contrato.Estado.ToString().ToUpper()</td>
                        <td>@contrato.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@(contrato.FechaModificacion?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                        <td>@(string.IsNullOrEmpty(contrato.ArchivoAdjuntoPath) ? "-" : "SÍ")</td>
                        <td class="cell-actions">
                            <button class="btn-table" @onclick="() => EditarContrato(contrato)" @onclick:stopPropagation="true">EDITAR</button>
                            @if (!string.IsNullOrEmpty(contrato.ArchivoAdjuntoPath))
                            {
                                <button class="btn-table" @onclick="() => DescargarAdjunto(contrato)" @onclick:stopPropagation="true">ARCHIVO</button>
                            }
                            <button class="btn-table" @onclick="() => VerHistorial(contrato)" @onclick:stopPropagation="true">HISTORIAL</button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="shortcuts-bar">
    <div class="shortcut-item">
        <span class="shortcut-key">F2</span>
        <span>=BUSCAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">F3</span>
        <span>=NUEVO</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">F5</span>
        <span>=ACTUALIZAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">TAB</span>
        <span>=NAVEGAR</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-key">ESC</span>
        <span>=SALIR</span>
    </div>
</div>

<!-- Modal de Contrato (Nuevo/Editar) -->
@if (showModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="modal-title">@(isEditing ? "EDITAR CONTRATO" : "NUEVO CONTRATO")</h2>
            </div>
            
            <div class="modal-content">
                <!-- SECCIÓN: INFORMACIÓN DEL EMPLEADO -->
                <div class="form-section">
                    <div class="section-title">INFORMACIÓN DEL EMPLEADO</div>
                    
                    <div class="form-group">
                        <label class="form-label @(isEditing ? "" : "form-label-required")">EMPLEADO:</label>
                        <select class="form-select" @bind="contratoEdit.EmpleadoId" disabled="@isEditing">
                            <option value="0">-- SELECCIONE --</option>
                            @foreach (var emp in empleados)
                            {
                                <option value="@emp.Id">@emp.Codigo - @emp.NombreCompleto</option>
                            }
                        </select>
                        @if (isEditing)
                        {
                            <div class="form-note">CAMPO NO MODIFICABLE</div>
                        }
                    </div>
                </div>

                <!-- SECCIÓN: DATOS DEL CONTRATO -->
                <div class="form-section">
                    <div class="section-title">DATOS DEL CONTRATO</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-label-required">TIPO DE CONTRATO:</label>
                            <select class="form-select" @bind="contratoEdit.TipoContrato">
                                @foreach (var tipo in Enum.GetValues<TipoContrato>())
                                {
                                    <option value="@tipo">@GetTipoContratoDisplay(tipo).ToUpper()</option>
                                }
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label form-label-required">CARGO:</label>
                            <select class="form-select" @bind="contratoEdit.CargoId">
                                <option value="0">-- SELECCIONE --</option>
                                @foreach (var cargo in cargos)
                                {
                                    <option value="@cargo.Id">@cargo.Nombre</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-label-required">ESTADO:</label>
                            <select class="form-select" @bind="contratoEdit.Estado">
                                @foreach (var estado in Enum.GetValues<EstadoContrato>())
                                {
                                    <option value="@estado">@estado.ToString().ToUpper()</option>
                                }
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label form-label-required">SALARIO:</label>
                            <InputMoneda @bind-Value="contratoEdit.Salario" CssClass="form-input" Placeholder="Ej: 1.750.905" />
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: FECHAS -->
                <div class="form-section">
                    <div class="section-title">FECHAS</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-label-required">FECHA INICIO:</label>
                            <input type="date" class="form-input" @bind="contratoEdit.FechaInicio" />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">FECHA FIN:</label>
                            <input type="date" class="form-input" @bind="contratoEdit.FechaFin" />
                            <div class="form-note">DEJAR VACÍO PARA CONTRATOS INDEFINIDOS</div>
                        </div>
                    </div>
                    
                    @if (contratoEdit.FechaFin.HasValue && contratoEdit.FechaFin.Value < contratoEdit.FechaInicio)
                    {
                        <div class="error-message">
                            ERROR: FECHA FIN NO PUEDE SER ANTERIOR A FECHA INICIO
                        </div>
                    }
                </div>

                <!-- SECCIÓN: ARCHIVO ADJUNTO -->
                <div class="form-section">
                    <div class="section-title">DOCUMENTO ADJUNTO</div>
                    
                    <div class="form-group">
                        <label class="form-label">ARCHIVO (PDF, DOC, DOCX):</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <InputFile OnChange="OnArchivoSelected" accept=".pdf,.doc,.docx" class="form-input" style="flex: 1;" />
                            <button type="button" class="btn" @onclick="AbrirScannerContrato">
                                ESCANEAR
                            </button>
                        </div>
                        @if (documentoEscaneadoBytes != null && !string.IsNullOrEmpty(documentoEscaneadoNombre))
                        {
                            <div style="margin-top: 8px; padding: 8px; border: 1px solid #008000; background: #F0FFF0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #006400; font-size: 11px;">
                                        📄 DOCUMENTO ESCANEADO: @documentoEscaneadoNombre (@FormatFileSize(documentoEscaneadoBytes.Length))
                                    </span>
                                    <button type="button" class="btn" style="padding: 4px 8px; font-size: 10px;" 
                                            @onclick="LimpiarDocumentoEscaneado">
                                        QUITAR
                                    </button>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(contratoEdit.ArchivoAdjuntoPath))
                        {
                            <div class="form-note">
                                ARCHIVO ACTUAL: @System.IO.Path.GetFileName(contratoEdit.ArchivoAdjuntoPath)
                            </div>
                        }
                    </div>
                </div>

                <!-- SECCIÓN: OBSERVACIONES -->
                <div class="form-section">
                    <div class="section-title">OBSERVACIONES</div>
                    
                    <div class="form-group">
                        <label class="form-label">OBSERVACIONES:</label>
                        <textarea class="form-textarea" @bind="contratoEdit.Observaciones"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" @onclick="CerrarModal" disabled="@isSaving">CANCELAR (ESC)</button>
                <button class="btn" @onclick="GuardarContrato" disabled="@isSaving">@(isSaving ? "GUARDANDO..." : "GUARDAR (F5)")</button>
            </div>
        </div>
    </div>
}

<!-- Modal de Historial de Contratos -->
@if (showHistorialModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box" style="width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">HISTORIAL DE CONTRATOS - @(empleadoSeleccionado?.NombreCompleto?.ToUpper() ?? "")</h2>
            </div>
            
            <div class="modal-content">
                @if (historialContratos.Any())
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>TIPO</th>
                                <th>CARGO</th>
                                <th>FECHA INICIO</th>
                                <th>FECHA FIN</th>
                                <th>SALARIO</th>
                                <th>ESTADO</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var contrato in historialContratos.OrderByDescending(c => c.FechaInicio))
                            {
                                <tr>
                                    <td class="cell-code">@contrato.Id</td>
                                    <td>@GetTipoContratoDisplay(contrato.TipoContrato).ToUpper()</td>
                                    <td>@(contrato.Cargo?.Nombre ?? "-")</td>
                                    <td>@contrato.FechaInicio.ToString("dd/MM/yyyy")</td>
                                    <td>@(contrato.FechaFin?.ToString("dd/MM/yyyy") ?? "INDEFINIDO")</td>
                                    <td>@NumberFormatHelper.FormatearMoneda(contrato.Salario)</td>
                                    <td class="cell-estado estado-@contrato.Estado.ToString().ToLower()">@contrato.Estado.ToString().ToUpper()</td>
                                    <td class="cell-actions">
                                        <button class="btn-table" @onclick="() => EditarContratoFromHistorial(contrato)">
                                            VER/EDITAR
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    @if (!string.IsNullOrEmpty(historialContratos.OrderByDescending(c => c.FechaInicio).FirstOrDefault()?.Observaciones))
                    {
                        <div class="form-section" style="margin-top: 15px;">
                            <div class="section-title">OBSERVACIONES DEL ÚLTIMO CONTRATO</div>
                            <div style="padding: 10px; font-size: 11px;">
                                @historialContratos.OrderByDescending(c => c.FechaInicio).FirstOrDefault()?.Observaciones
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-message">
                        NO HAY HISTORIAL DE CONTRATOS PARA ESTE EMPLEADO
                    </div>
                }
            </div>
            
            <div class="modal-actions">
                <button class="btn" @onclick="() => showHistorialModal = false">CERRAR (ESC)</button>
            </div>
        </div>
    </div>
}

<!-- Modal de confirmación -->
@if (showConfirmModal)
{
    <div class="modal-overlay" @onclick:stopPropagation="true">
        <div class="modal-box" style="width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">CONFIRMAR ACCIÓN</h2>
            </div>
            
            <div class="modal-content">
                <div style="font-size: 13px; padding: 20px; text-align: center;">
                    @confirmMessage
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" @onclick="() => showConfirmModal = false">CANCELAR</button>
                <button class="btn-danger" @onclick="ConfirmarAccion">CONFIRMAR</button>
            </div>
        </div>
    </div>
}

<!-- Scanner Modal -->
<ScannerModal @bind-IsVisible="mostrarScannerModal"
              AllowMultiplePages="true"
              OnScanComplete="OnScanComplete"
              OnPdfGenerated="OnPdfGenerated" />

@code {
    [Parameter] public int? EmpleadoIdParam { get; set; }
    
    private const string PageId = "Contratos";
    
    private List<Contrato> contratos = new();
    private List<Contrato> todosContratos = new();
    private List<Contrato> contratosPorVencer = new();
    private List<Contrato> historialContratos = new();
    private List<Empleado> empleados = new();
    private List<Cargo> cargos = new();
    
    private Contrato? selectedContrato;
    private Contrato contratoEdit = new();
    private Empleado? empleadoSeleccionado;
    
    private bool isLoading;
    private bool showModal;
    private bool showHistorialModal;
    private bool showConfirmModal;
    private bool isSaving;
    private bool isEditing;
    
    private string? errorMessage;
    private string? successMessage;
    private string searchTerm = "";
    private string filtroEstado = "";
    private string filtroTipo = "";
    private string confirmMessage = "";
    
    private int totalContratos;
    private Action? confirmAction;
    
    private IBrowserFile? archivoSeleccionado;
    
    // Estado del scanner
    private bool mostrarScannerModal = false;
    private byte[]? documentoEscaneadoBytes = null;
    private string? documentoEscaneadoNombre = null;
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        ConfigurarAtajos();
        await CargarDatos();
        
        // Si hay un ID de empleado en la URL, filtrar por ese empleado
        if (EmpleadoIdParam.HasValue)
        {
            await FiltrarPorEmpleado(EmpleadoIdParam.Value);
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Mostrar mensaje de éxito si existe
            if (successMessage != null)
            {
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
        }
    }
    
    public void Dispose()
    {
        KeyboardShortcutService.ClearPageShortcuts(PageId);
    }
    
    private void ConfigurarAtajos()
    {
        KeyboardShortcutService.RegisterPageShortcuts(PageId, new List<KeyboardShortcutDto>
        {
            new() { Key = "F2", KeyDisplay = "F2", Description = "Buscar", Action = FocusBusqueda },
            new() { Key = "F3", KeyDisplay = "F3", Description = "Nuevo", Action = NuevoContrato },
            new() { Key = "F4", KeyDisplay = "F4", Description = "Editar", Action = EditarSeleccionado },
            new() { Key = "F5", KeyDisplay = "F5", Description = "Actualizar", Action = CargarContratos },
            new() { Key = "Escape", KeyDisplay = "ESC", Description = "Cerrar", Action = CerrarModal }
        });
    }
    
    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Cargar contratos con sus relaciones
            var contratosTask = ContratoRepository.GetAllActiveAsync();
            var empleadosTask = EmpleadoRepository.GetAllActiveAsync();
            var cargosTask = CargoRepository.GetAllActiveAsync();
            
            await Task.WhenAll(contratosTask, empleadosTask, cargosTask);
            
            todosContratos = (await contratosTask).ToList();
            empleados = (await empleadosTask).ToList();
            cargos = (await cargosTask).ToList();
            
            // Cargar las relaciones manualmente
            foreach (var contrato in todosContratos)
            {
                contrato.Empleado = empleados.FirstOrDefault(e => e.Id == contrato.EmpleadoId);
                contrato.Cargo = cargos.FirstOrDefault(c => c.Id == contrato.CargoId);
            }
            
            contratos = todosContratos;
            totalContratos = contratos.Count;
            
            // Obtener contratos por vencer
            contratosPorVencer = (await ContratoRepository.GetContratosProximosAVencerAsync(30)).ToList();
            foreach (var contrato in contratosPorVencer)
            {
                contrato.Empleado = empleados.FirstOrDefault(e => e.Id == contrato.EmpleadoId);
            }
            
            Logger.LogInformation($"Cargados {contratos.Count} contratos, {contratosPorVencer.Count} por vencer");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos de contratos");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task CargarContratos()
    {
        await CargarDatos();
        successMessage = "Contratos actualizados correctamente";
        await Task.Delay(3000);
        successMessage = null;
        StateHasChanged();
    }
    
    private Task NuevoContrato()
    {
        contratoEdit = new Contrato
        {
            FechaInicio = DateTime.Today,
            TipoContrato = TipoContrato.Indefinido,
            Estado = EstadoContrato.Activo,
            Salario = 0
        };
        
        // Si hay un empleado seleccionado en el historial, pre-seleccionarlo
        if (empleadoSeleccionado != null)
        {
            contratoEdit.EmpleadoId = empleadoSeleccionado.Id;
        }
        
        archivoSeleccionado = null;
        isEditing = false;
        showModal = true;
        return Task.CompletedTask;
    }
    
    private void EditarContrato(Contrato contrato)
    {
        // No copiar Id manualmente - se asigna después para evitar antipatrón
        contratoEdit = new Contrato
        {
            EmpleadoId = contrato.EmpleadoId,
            TipoContrato = contrato.TipoContrato,
            FechaInicio = contrato.FechaInicio,
            FechaFin = contrato.FechaFin,
            Salario = contrato.Salario,
            CargoId = contrato.CargoId,
            Estado = contrato.Estado,
            ArchivoAdjuntoPath = contrato.ArchivoAdjuntoPath,
            Observaciones = contrato.Observaciones
        };
        contratoEdit.Id = contrato.Id;
        
        archivoSeleccionado = null;
        isEditing = true;
        showModal = true;
    }
    
    private Task EditarSeleccionado()
    {
        if (selectedContrato != null)
        {
            EditarContrato(selectedContrato);
        }
        return Task.CompletedTask;
    }
    
    private void SelectContrato(Contrato contrato)
    {
        selectedContrato = contrato;
    }
    
    private async Task GuardarContrato()
    {
        try
        {
            // Validaciones
            if (contratoEdit.EmpleadoId <= 0)
            {
                errorMessage = "Debe seleccionar un empleado";
                return;
            }
            
            if (contratoEdit.CargoId <= 0)
            {
                errorMessage = "Debe seleccionar un cargo";
                return;
            }
            
            if (contratoEdit.Salario <= 0)
            {
                errorMessage = "El salario debe ser mayor a cero";
                return;
            }
            
            if (contratoEdit.FechaFin.HasValue && contratoEdit.FechaFin.Value < contratoEdit.FechaInicio)
            {
                errorMessage = "La fecha de fin debe ser posterior a la fecha de inicio";
                return;
            }
            
            isSaving = true;
            StateHasChanged();
            
            // Guardar archivo adjunto si existe (ya sea por InputFile o por escaneo)
            if (archivoSeleccionado != null)
            {
                var buffer = new byte[archivoSeleccionado.Size];
                await archivoSeleccionado.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
                
                var result = await StorageService.SaveContratoArchivoAsync(
                    contratoEdit.Id > 0 ? contratoEdit.Id : (int)(DateTime.Now.Ticks % int.MaxValue),
                    buffer,
                    archivoSeleccionado.Name
                );
                
                if (result.IsSuccess)
                {
                    contratoEdit.ArchivoAdjuntoPath = result.Value;
                }
            }
            else if (documentoEscaneadoBytes != null && !string.IsNullOrEmpty(documentoEscaneadoNombre))
            {
                // Guardar documento escaneado
                var result = await StorageService.SaveContratoArchivoAsync(
                    contratoEdit.Id > 0 ? contratoEdit.Id : (int)(DateTime.Now.Ticks % int.MaxValue),
                    documentoEscaneadoBytes,
                    documentoEscaneadoNombre
                );
                
                if (result.IsSuccess)
                {
                    contratoEdit.ArchivoAdjuntoPath = result.Value;
                    Logger.LogInformation($"Documento escaneado guardado para contrato: {result.Value}");
                }
            }
            
            if (isEditing)
            {
                await ContratoRepository.UpdateAsync(contratoEdit);
                Logger.LogInformation($"Contrato {contratoEdit.Id} actualizado por usuario {AuthService.CurrentUser?.Username}");
                successMessage = "Contrato actualizado correctamente";
            }
            else
            {
                await ContratoRepository.AddAsync(contratoEdit);
                Logger.LogInformation($"Nuevo contrato creado para empleado {contratoEdit.EmpleadoId} por usuario {AuthService.CurrentUser?.Username}");
                successMessage = "Contrato creado correctamente";
            }
            
            await CargarDatos();
            CerrarModal();
            
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar contrato");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private Task CerrarModal()
    {
        showModal = false;
        contratoEdit = new();
        archivoSeleccionado = null;
        isEditing = false;
        errorMessage = null;
        // Limpiar estado del scanner
        documentoEscaneadoBytes = null;
        documentoEscaneadoNombre = null;
        return Task.CompletedTask;
    }
    
    private async Task FocusBusqueda()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("focusElement", "searchInput");
        }
        catch { }
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Buscar();
        }
    }
    
    private Task Buscar()
    {
        ApplyFilters();
        return Task.CompletedTask;
    }
    
    private Task LimpiarBusqueda()
    {
        searchTerm = "";
        ApplyFilters();
        return Task.CompletedTask;
    }

    private Task LimpiarFiltros()
    {
        searchTerm = "";
        filtroEstado = "";
        filtroTipo = "";
        ApplyFilters();
        return Task.CompletedTask;
    }
    
    private Task Filtrar()
    {
        ApplyFilters();
        return Task.CompletedTask;
    }
    
    private void ApplyFilters()
    {
        contratos = todosContratos;
        
        // Filtro por búsqueda (empleado)
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.ToLower();
            contratos = contratos.Where(c => 
                (c.Empleado?.NombreCompleto?.ToLower().Contains(search) ?? false) ||
                (c.Empleado?.Cedula?.Contains(search) ?? false) ||
                (c.Empleado?.Codigo?.ToLower().Contains(search) ?? false)
            ).ToList();
        }
        
        // Filtro por estado
        if (!string.IsNullOrEmpty(filtroEstado) && int.TryParse(filtroEstado, out int estadoId))
        {
            contratos = contratos.Where(c => (int)c.Estado == estadoId).ToList();
        }
        
        // Filtro por tipo de contrato
        if (!string.IsNullOrEmpty(filtroTipo) && int.TryParse(filtroTipo, out int tipoId))
        {
            contratos = contratos.Where(c => (int)c.TipoContrato == tipoId).ToList();
        }
        
        totalContratos = contratos.Count;
        StateHasChanged();
    }
    
    private async Task FiltrarPorEmpleado(int empleadoId)
    {
        var empleado = empleados.FirstOrDefault(e => e.Id == empleadoId);
        if (empleado != null)
        {
            searchTerm = empleado.NombreCompleto ?? "";
            await Buscar();
        }
    }
    
    private async Task VerHistorial(Contrato contrato)
    {
        try
        {
            empleadoSeleccionado = contrato.Empleado;
            historialContratos = (await ContratoRepository.GetByEmpleadoIdAsync(contrato.EmpleadoId)).ToList();
            
            // Cargar relaciones
            foreach (var c in historialContratos)
            {
                c.Cargo = cargos.FirstOrDefault(cg => cg.Id == c.CargoId);
            }
            
            showHistorialModal = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al cargar historial de contratos para empleado {contrato.EmpleadoId}");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
    }
    
    private void EditarContratoFromHistorial(Contrato contrato)
    {
        showHistorialModal = false;
        EditarContrato(contrato);
    }
    
    private async Task DescargarAdjunto(Contrato contrato)
    {
        try
        {
            if (string.IsNullOrEmpty(contrato.ArchivoAdjuntoPath))
                return;
            
            var result = await StorageService.GetContratoArchivoAsync(contrato.Id);
            if (result.IsSuccess && result.Value != null)
            {
                var fileName = System.IO.Path.GetFileName(contrato.ArchivoAdjuntoPath);
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(result.Value));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error al descargar archivo adjunto del contrato {contrato.Id}");
            errorMessage = ErrorTranslationService.Translate(ex);
        }
    }
    
    private void OnArchivoSelected(InputFileChangeEventArgs e)
    {
        archivoSeleccionado = e.File;
        // Si se selecciona archivo por InputFile, limpiar documento escaneado
        documentoEscaneadoBytes = null;
        documentoEscaneadoNombre = null;
    }
    
    // Métodos del Scanner
    private void AbrirScannerContrato()
    {
        mostrarScannerModal = true;
    }
    
    private void LimpiarDocumentoEscaneado()
    {
        documentoEscaneadoBytes = null;
        documentoEscaneadoNombre = null;
        StateHasChanged();
    }
    
    private void OnScanComplete(List<ScannedPageDto> pages)
    {
        Logger.LogInformation($"Escaneo completado para contrato: {pages.Count} página(s)");
    }
    
    private void OnPdfGenerated(byte[] pdfBytes)
    {
        documentoEscaneadoBytes = pdfBytes;
        documentoEscaneadoNombre = $"Contrato_Escaneado_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
        archivoSeleccionado = null; // Limpiar archivo seleccionado por InputFile
        mostrarScannerModal = false;
        Logger.LogInformation($"PDF generado para contrato: {pdfBytes.Length} bytes");
        StateHasChanged();
    }
    
    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }
    
    private string GetTipoContratoDisplay(TipoContrato tipo)
    {
        return tipo switch
        {
            TipoContrato.Indefinido => "Indefinido",
            TipoContrato.TerminoFijo => "Término Fijo",
            TipoContrato.ObraOLabor => "Obra o Labor",
            TipoContrato.PrestacionServicios => "Prestación de Servicios",
            TipoContrato.Aprendizaje => "Aprendizaje",
            TipoContrato.Ocasional => "Ocasional",
            TipoContrato.Temporal => "Temporal",
            _ => tipo.ToString()
        };
    }
    
    private void ConfirmarAccion()
    {
        confirmAction?.Invoke();
        showConfirmModal = false;
    }
}
