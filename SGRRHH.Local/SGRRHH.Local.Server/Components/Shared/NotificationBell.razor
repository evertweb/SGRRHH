@using SGRRHH.Local.Domain.DTOs
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@implements IDisposable

<div class="notification-bell-wrapper">
    <button class="notification-bell-btn @(isLoading ? "loading" : "")" 
            @onclick="ToggleDropdown" 
            @onclick:stopPropagation="true"
            title="Notificaciones">
        <span class="bell-icon">
            @if (NotificationService.UnreadCount > 0)
            {
                <svg class="bell-svg bell-animated" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            }
            else
            {
                <svg class="bell-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            }
        </span>
        @if (NotificationService.UnreadCount > 0)
        {
            <span class="notification-badge @(NotificationService.Resumen?.Urgentes > 0 ? "urgent" : "")">
                @FormatCount(NotificationService.UnreadCount)
            </span>
        }
    </button>
    
    @if (showDropdown)
    {
        <div class="notification-overlay" @onclick="CloseDropdown"></div>
        <div class="notification-panel">
            <!-- Header -->
            <div class="notification-panel-header">
                <div class="header-title">
                    <span class="header-icon">🔔</span>
                    <span>Notificaciones</span>
                    @if (NotificationService.UnreadCount > 0)
                    {
                        <span class="header-count">@NotificationService.UnreadCount</span>
                    }
                </div>
                @if (NotificationService.UnreadCount > 0)
                {
                    <button class="btn-mark-all" @onclick="MarkAllAsRead" title="Marcar todas como leídas">
                        <span>✓✓</span>
                    </button>
                }
            </div>
            
            <!-- Resumen rápido -->
            @if (NotificationService.Resumen != null && NotificationService.UnreadCount > 0)
            {
                <div class="notification-summary">
                    @if (NotificationService.Resumen.Urgentes > 0)
                    {
                        <span class="summary-tag urgent">🚨 @NotificationService.Resumen.Urgentes urgente(s)</span>
                    }
                    @if (NotificationService.Resumen.Permisos > 0)
                    {
                        <span class="summary-tag permisos">📋 @NotificationService.Resumen.Permisos permiso(s)</span>
                    }
                    @if (NotificationService.Resumen.Vacaciones > 0)
                    {
                        <span class="summary-tag vacaciones">🏖️ @NotificationService.Resumen.Vacaciones vacación(es)</span>
                    }
                </div>
            }
            
            <!-- Lista de notificaciones -->
            <div class="notification-list">
                @if (isLoading)
                {
                    <div class="notification-loading">
                        <span class="loading-spinner"></span>
                        <span>Cargando...</span>
                    </div>
                }
                else if (!notificaciones.Any())
                {
                    <div class="notification-empty">
                        <span class="empty-icon">✨</span>
                        <span class="empty-text">¡Todo al día!</span>
                        <span class="empty-subtext">No hay notificaciones pendientes</span>
                    </div>
                }
                else
                {
                    @foreach (var notif in notificaciones)
                    {
                        <div class="notification-item @notif.CssClass @(notif.EsUrgente ? "urgent" : "")" 
                             @onclick="() => HandleNotificationClick(notif)"
                             title="@notif.Mensaje">
                            <div class="notification-icon-wrapper">
                                <span class="notification-icon">@notif.Icono</span>
                                @if (notif.EsUrgente)
                                {
                                    <span class="urgent-indicator"></span>
                                }
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">@notif.Titulo</div>
                                <div class="notification-message">@TruncateMessage(notif.Mensaje)</div>
                                <div class="notification-meta">
                                    <span class="notification-time">@notif.TiempoRelativo</span>
                                    <span class="notification-category">@notif.Categoria</span>
                                </div>
                            </div>
                            <button class="notification-dismiss" @onclick="() => DismissNotification(notif)" @onclick:stopPropagation="true" title="Marcar como leída">
                                ✕
                            </button>
                        </div>
                    }
                }
            </div>
            
            <!-- Footer -->
            @if (notificaciones.Count > 5)
            {
                <div class="notification-panel-footer">
                    <span class="footer-text">Mostrando últimas @notificaciones.Count notificaciones</span>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool showDropdown = false;
    private bool isLoading = false;
    private List<NotificacionDto> notificaciones = new();
    
    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnNotification += HandleNewNotification;
        NotificationService.OnCountChanged += HandleCountChanged;
        
        // Inicializar servicio
        await NotificationService.InitializeAsync();
    }
    
    private void HandleNewNotification(object? sender, NotificationEventArgs args)
    {
        InvokeAsync(async () =>
        {
            if (showDropdown)
            {
                await LoadNotificaciones();
            }
            StateHasChanged();
        });
    }
    
    private void HandleCountChanged(object? sender, EventArgs args)
    {
        InvokeAsync(StateHasChanged);
    }
    
    private async Task ToggleDropdown()
    {
        showDropdown = !showDropdown;
        
        if (showDropdown)
        {
            await LoadNotificaciones();
        }
    }
    
    private void CloseDropdown()
    {
        showDropdown = false;
    }
    
    private async Task LoadNotificaciones()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            notificaciones = await NotificationService.GetNotificacionesAsync(15);
            await NotificationService.GetResumenAsync();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task MarkAllAsRead()
    {
        await NotificationService.MarkAllAsReadAsync();
        notificaciones.Clear();
        StateHasChanged();
    }
    
    private async Task HandleNotificationClick(NotificacionDto notification)
    {
        await NotificationService.MarkAsReadAsync(notification.Id);
        showDropdown = false;
        
        if (!string.IsNullOrEmpty(notification.Link))
        {
            Navigation.NavigateTo(notification.Link);
        }
    }
    
    private async Task DismissNotification(NotificacionDto notification)
    {
        await NotificationService.MarkAsReadAsync(notification.Id);
        notificaciones.Remove(notification);
        StateHasChanged();
    }
    
    private string FormatCount(int count)
    {
        return count > 99 ? "99+" : count.ToString();
    }
    
    private string TruncateMessage(string message)
    {
        return message.Length > 60 ? message[..57] + "..." : message;
    }
    
    public void Dispose()
    {
        NotificationService.OnNotification -= HandleNewNotification;
        NotificationService.OnCountChanged -= HandleCountChanged;
    }
}


