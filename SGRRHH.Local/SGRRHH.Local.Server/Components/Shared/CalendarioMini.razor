@inject IJSRuntime JSRuntime

<div class="calendario-mini">
    <!-- Header del calendario -->
    <div class="calendario-header">
        <button class="btn-nav" @onclick="MesAnterior">◀</button>
        <div class="calendario-titulo">
            @fechaActual.ToString("MMMM yyyy").ToUpper()
        </div>
        <button class="btn-nav" @onclick="MesSiguiente">▶</button>
    </div>

    <!-- Días de la semana -->
    <div class="calendario-dias-semana">
        <div class="dia-semana">DOM</div>
        <div class="dia-semana">LUN</div>
        <div class="dia-semana">MAR</div>
        <div class="dia-semana">MIÉ</div>
        <div class="dia-semana">JUE</div>
        <div class="dia-semana">VIE</div>
        <div class="dia-semana">SÁB</div>
    </div>

    <!-- Días del mes -->
    <div class="calendario-dias">
        @foreach (var dia in GetDiasDelMes())
        {
            <div class="@GetClaseDia(dia)" @onclick="() => SeleccionarDia(dia)">
                @if (dia.HasValue)
                {
                    <span>@dia.Value.Day</span>
                    @if (TieneMarcador != null && TieneMarcador(dia.Value))
                    {
                        <span class="marcador">●</span>
                    }
                }
            </div>
        }
    </div>

    @if (MostrarBotones)
    {
        <div class="calendario-footer">
            <button @onclick="SeleccionarHoy">HOY</button>
            <button @onclick="Limpiar">LIMPIAR</button>
        </div>
    }
</div>

@code {
    [Parameter] public DateTime? FechaSeleccionada { get; set; }
    [Parameter] public EventCallback<DateTime?> FechaSeleccionadaChanged { get; set; }
    [Parameter] public DateTime? FechaMinima { get; set; }
    [Parameter] public DateTime? FechaMaxima { get; set; }
    [Parameter] public bool MostrarBotones { get; set; } = true;
    [Parameter] public Func<DateTime, bool>? TieneMarcador { get; set; }

    private DateTime fechaActual = DateTime.Today;

    protected override void OnInitialized()
    {
        if (FechaSeleccionada.HasValue)
        {
            fechaActual = new DateTime(FechaSeleccionada.Value.Year, FechaSeleccionada.Value.Month, 1);
        }
    }

    private List<DateTime?> GetDiasDelMes()
    {
        var primerDia = new DateTime(fechaActual.Year, fechaActual.Month, 1);
        var ultimoDia = primerDia.AddMonths(1).AddDays(-1);
        var dias = new List<DateTime?>();

        // Días en blanco al inicio
        int diaInicio = (int)primerDia.DayOfWeek;
        for (int i = 0; i < diaInicio; i++)
        {
            dias.Add(null);
        }

        // Días del mes
        for (int dia = 1; dia <= ultimoDia.Day; dia++)
        {
            dias.Add(new DateTime(fechaActual.Year, fechaActual.Month, dia));
        }

        // Completar la última semana si es necesario
        while (dias.Count % 7 != 0)
        {
            dias.Add(null);
        }

        return dias;
    }

    private string GetClaseDia(DateTime? dia)
    {
        if (!dia.HasValue)
            return "dia vacio";

        var clases = new List<string> { "dia" };

        if (dia.Value.Date == DateTime.Today)
            clases.Add("hoy");

        if (FechaSeleccionada.HasValue && dia.Value.Date == FechaSeleccionada.Value.Date)
            clases.Add("seleccionado");

        if (FechaMinima.HasValue && dia.Value < FechaMinima.Value.Date)
            clases.Add("deshabilitado");

        if (FechaMaxima.HasValue && dia.Value > FechaMaxima.Value.Date)
            clases.Add("deshabilitado");

        if (dia.Value.DayOfWeek == DayOfWeek.Sunday || dia.Value.DayOfWeek == DayOfWeek.Saturday)
            clases.Add("fin-semana");

        return string.Join(" ", clases);
    }

    private async Task SeleccionarDia(DateTime? dia)
    {
        if (!dia.HasValue)
            return;

        if (FechaMinima.HasValue && dia.Value < FechaMinima.Value.Date)
            return;

        if (FechaMaxima.HasValue && dia.Value > FechaMaxima.Value.Date)
            return;

        FechaSeleccionada = dia.Value;
        await FechaSeleccionadaChanged.InvokeAsync(dia.Value);
    }

    private void MesAnterior()
    {
        fechaActual = fechaActual.AddMonths(-1);
    }

    private void MesSiguiente()
    {
        fechaActual = fechaActual.AddMonths(1);
    }

    private async Task SeleccionarHoy()
    {
        fechaActual = DateTime.Today;
        FechaSeleccionada = DateTime.Today;
        await FechaSeleccionadaChanged.InvokeAsync(DateTime.Today);
    }

    private async Task Limpiar()
    {
        FechaSeleccionada = null;
        await FechaSeleccionadaChanged.InvokeAsync(null);
    }
}


