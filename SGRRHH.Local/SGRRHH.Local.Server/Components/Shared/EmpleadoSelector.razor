@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IEmpleadoRepository EmpleadoRepository
@inject ILogger<EmpleadoSelector> Logger
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="empleado-selector">
    <div class="selector-search">
        <input type="text" 
               @ref="searchInput"
               placeholder="@Placeholder" 
               @bind="searchTerm" 
               @bind:event="oninput"
               @onfocus="OnFocus"
               @onblur="OnBlur" />
        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <button class="btn-clear" @onclick="Clear">✕</button>
        }
    </div>

    @if (showDropdown && empleados.Any())
    {
        <div class="selector-dropdown">
            @foreach (var emp in empleados.Take(MaxResults))
            {
                <div class="selector-item" @onclick="() => SelectEmpleado(emp)">
                    <img src="@GetFotoUrl(emp)" alt="@emp.NombreCompleto" 
                         onerror="this.src='/images/default-avatar.png'" />
                    <div class="selector-item-info">
                        <div class="selector-item-nombre">@emp.NombreCompleto</div>
                        <div class="selector-item-cargo">
                            @(emp.Cargo?.Nombre ?? "Sin cargo") - @(emp.Departamento?.Nombre ?? "Sin depto")
                        </div>
                    </div>
                    <div class="selector-item-badge">
                        <EstadoBadge Estado="@emp.Estado.ToString()" Size="small" />
                    </div>
                </div>
            }
            @if (empleados.Count > MaxResults)
            {
                <div class="selector-more">
                    +@(empleados.Count - MaxResults) más... Refina tu búsqueda
                </div>
            }
        </div>
    }

    @if (SelectedEmpleado != null)
    {
        <div class="selector-selected">
            <strong>Seleccionado:</strong> @SelectedEmpleado.NombreCompleto
        </div>
    }
</div>

@code {
    [Parameter] public Empleado? SelectedEmpleado { get; set; }
    [Parameter] public EventCallback<Empleado?> SelectedEmpleadoChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Buscar empleado...";
    [Parameter] public int MaxResults { get; set; } = 10;
    [Parameter] public bool SoloActivos { get; set; } = true;

    private ElementReference searchInput;
    private string searchTerm = string.Empty;
    private List<Empleado> empleados = new();
    private bool showDropdown;
    private bool isBlurring;

    protected override async Task OnInitializedAsync()
    {
        if (SelectedEmpleado != null)
        {
            searchTerm = SelectedEmpleado.NombreCompleto;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await BuscarEmpleados();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var dotNetRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("connectDataSync", dotNetRef);
                Logger.LogInformation("[EmpleadoSelector] Conectado a SignalR Hub");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "[EmpleadoSelector] Error conectando a SignalR Hub");
            }
        }
    }
    
    [JSInvokable]
    public async Task OnDataChanged(string entityType, string changeType, int? entityId)
    {
        if (entityType == "Empleado")
        {
            Logger.LogInformation("[EmpleadoSelector] Empleado modificado, recargando lista");
            await BuscarEmpleados();
            await InvokeAsync(StateHasChanged);
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("disconnectDataSync");
            Logger.LogInformation("[EmpleadoSelector] Desconectado de SignalR Hub");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "[EmpleadoSelector] Error desconectando de SignalR Hub");
        }
    }

    private async Task BuscarEmpleados()
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || searchTerm.Length < 2)
        {
            empleados.Clear();
            return;
        }

        try
        {
            var todos = await EmpleadoRepository.GetAllAsync();
            
            empleados = todos
                .Where(e => 
                    (!SoloActivos || e.Estado == Domain.Enums.EstadoEmpleado.Activo) &&
                    (e.NombreCompleto.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                     e.Cedula.Contains(searchTerm) ||
                     e.Codigo.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                )
                .OrderBy(e => e.NombreCompleto)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error buscando empleados");
            empleados.Clear();
        }
    }

    private void OnFocus()
    {
        showDropdown = true;
    }

    private async Task OnBlur()
    {
        isBlurring = true;
        await Task.Delay(200); // Dar tiempo para que el click en el dropdown se registre
        if (isBlurring)
        {
            showDropdown = false;
        }
    }

    private async Task SelectEmpleado(Empleado empleado)
    {
        isBlurring = false;
        SelectedEmpleado = empleado;
        searchTerm = empleado.NombreCompleto;
        showDropdown = false;
        await SelectedEmpleadoChanged.InvokeAsync(empleado);
    }

    private async Task Clear()
    {
        searchTerm = string.Empty;
        SelectedEmpleado = null;
        empleados.Clear();
        showDropdown = false;
        await SelectedEmpleadoChanged.InvokeAsync(null);
    }

    private string GetFotoUrl(Empleado empleado)
    {
        if (!string.IsNullOrEmpty(empleado.FotoPath))
        {
            return $"/files/empleados/{empleado.Id}/foto/{empleado.FotoPath}";
        }
        return "/images/default-avatar.png";
    }
}


