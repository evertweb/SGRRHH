@using SGRRHH.Local.Shared.Helpers
@typeparam TValue

<div class="input-moneda-container">
    <span class="input-moneda-prefix">$</span>
    <input type="text" 
           class="@CssClass input-moneda" 
           value="@ValorFormateado"
           @oninput="OnInputChanged"
           @onblur="OnBlur"
           disabled="@Disabled"
           readonly="@ReadOnly"
           placeholder="@Placeholder" />
</div>

@code {
    [Parameter]
    public TValue? Value { get; set; }
    
    [Parameter]
    public EventCallback<TValue> ValueChanged { get; set; }
    
    [Parameter]
    public string? CssClass { get; set; }
    
    [Parameter]
    public bool Disabled { get; set; }
    
    [Parameter]
    public bool ReadOnly { get; set; }
    
    [Parameter]
    public string? Placeholder { get; set; }
    
    [Parameter]
    public decimal Min { get; set; } = 0;
    
    private string _textoActual = "";
    
    private string ValorFormateado
    {
        get
        {
            if (Value == null) return "";
            
            // Intentar convertir a decimal
            try
            {
                var valorDecimal = Convert.ToDecimal(Value);
                return NumberFormatHelper.FormatearMonedaSinSimbolo(valorDecimal);
            }
            catch
            {
                return Value.ToString() ?? "";
            }
        }
    }
    
    protected override void OnParametersSet()
    {
        _textoActual = ValorFormateado;
    }
    
    private async Task OnInputChanged(ChangeEventArgs e)
    {
        var texto = e.Value?.ToString() ?? "";
        
        // Remover todo excepto nÃºmeros y comas
        var soloNumeros = new string(texto.Where(c => char.IsDigit(c) || c == ',').ToArray());
        
        // Reemplazar coma por punto para parsing
        soloNumeros = soloNumeros.Replace(",", ".");
        
        if (decimal.TryParse(soloNumeros, System.Globalization.NumberStyles.Any, 
            System.Globalization.CultureInfo.InvariantCulture, out decimal valor))
        {
            if (valor >= Min)
            {
                // Convertir al tipo correcto
                if (typeof(TValue) == typeof(decimal))
                {
                    await ValueChanged.InvokeAsync((TValue)(object)valor);
                }
                else if (typeof(TValue) == typeof(decimal?))
                {
                    await ValueChanged.InvokeAsync((TValue)(object)(decimal?)valor);
                }
            }
        }
        else if (string.IsNullOrWhiteSpace(soloNumeros))
        {
            if (typeof(TValue) == typeof(decimal?))
            {
                await ValueChanged.InvokeAsync(default!);
            }
            else if (typeof(TValue) == typeof(decimal))
            {
                await ValueChanged.InvokeAsync((TValue)(object)0m);
            }
        }
    }
    
    private void OnBlur(FocusEventArgs e)
    {
        // Re-formatear al perder foco
        StateHasChanged();
    }
}

<style>
    .input-moneda-container {
        display: flex;
        align-items: center;
        position: relative;
    }
    
    .input-moneda-prefix {
        position: absolute;
        left: 10px;
        color: #666;
        font-weight: bold;
        pointer-events: none;
    }
    
    .input-moneda {
        padding-left: 25px !important;
        text-align: right;
    }
</style>
