@if (IsVisible)
{
    <div class="scanner-backdrop" @onclick="OnBackdropClick" @onkeydown="HandleKeyPress" tabindex="-1">
        <div class="scanner-modal scanner-modal-fullscreen" @onclick:stopPropagation="true">
            <div class="scanner-header">
                <span>@(Titulo ?? (AllowMultiplePages ? "ESCANEO M√öLTIPLE DE DOCUMENTOS" : "ESC√ÅNER DE DOCUMENTOS"))</span>
                <button class="scanner-close" @onclick="Cerrar" disabled="@isScanning">‚úï</button>
            </div>
            
            <div class="scanner-body-horizontal">
                @* === PANEL IZQUIERDO: VISTA PREVIA GRANDE === *@
                <div class="scanner-preview-panel">
                    <ScannerToolbar TienePaginas="@(scannedPages.Count > 0)"
                                    PermiteMultipagina="AllowMultiplePages"
                                    PaginaActual="previewIndex"
                                    TotalPaginas="scannedPages.Count"
                                    Zoom="previewZoom"
                                    PuedeAbrirPantallaCompleta="@(scannedPages.Count > 0 || previewImage != null)"
                                    AlRotar="RotatePage"
                                    AlVoltearHorizontal="FlipHorizontalPage"
                                    AlVoltearVertical="FlipVerticalPage"
                                    AlAutoRecortar="AutoCropPage"
                                    AlZoomIn="ZoomIn"
                                    AlZoomOut="ZoomOut"
                                    AlDefinirZoom="SetZoom"
                                    AlPaginaAnterior="PreviousPage"
                                    AlPaginaSiguiente="NextPage"
                                    AlAbrirPantallaCompleta="OpenFullscreenOverlay" />

                    <ScannerPreview EstaEscaneando="isScanning"
                                    EstaGenerandoPdf="isGeneratingPdf"
                                    EstadoProgreso="@progressStatus"
                                    PorcentajeProgreso="@progressPercent"
                                    PaginaActual="@currentPage"
                                    TotalPaginas="@scannedPages.Count"
                                    Zoom="@previewZoom"
                                    EstiloZoom="@GetImageZoomStyle()"
                                    PermiteMultipagina="@AllowMultiplePages"
                                    PaginaActualEscaneada="@GetCurrentPage()"
                                    ImagenVistaPrevia="@previewImage"
                                    ImagenActualUrl="@GetCurrentPageImageUrl()"
                                    ImagenVistaPreviaUrl="@GetPreviewImageUrl()"
                                    EsModoVistaPrevia="@isPreviewMode"
                                    AreaSeleccionada="@selectedArea"
                                    EstaSeleccionando="@isSelectingArea"
                                    SeleccionInicioX="@selectionStart.X"
                                    SeleccionInicioY="@selectionStart.Y"
                                    SeleccionActualX="@selectionCurrent.X"
                                    SeleccionActualY="@selectionCurrent.Y"
                                    AlIniciarSeleccion="StartAreaSelectionAsync"
                                    AlMoverSeleccion="UpdateAreaSelectionAsync"
                                    AlFinalizarSeleccion="EndAreaSelectionAsync"
                                    AlAbrirPantallaCompleta="OpenFullscreenOverlay" />
                </div>
                
                @* === PANEL DERECHO: CONFIGURACI√ìN Y MINIATURAS === *@
                <div class="scanner-config-panel">
                    @* Selector de esc√°ner *@
                    <ScannerDeviceSelector Scanners="scanners"
                                           @bind-SelectedDeviceId="selectedDeviceId"
                                           Deshabilitado="isScanning"
                                           AlRefrescar="RefreshScanners" />
                    
                    @* Configuraci√≥n de entrada *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">CONFIGURACI√ìN DE ENTRADA</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field-row">
                                <label>Fuente:</label>
                                <select @bind="selectedSource" class="scanner-select" disabled="@isScanning">
                                    <option value="Flatbed">Documento (Placa)</option>
                                    <option value="Feeder">Alimentador</option>
                                    <option value="Auto">Autom√°tico</option>
                                </select>
                            </div>
                            <div class="scanner-field-row">
                                <label>Modo color:</label>
                                <select @bind="selectedColorMode" class="scanner-select" disabled="@isScanning">
                                    <option value="Color">Color</option>
                                    <option value="Grayscale">Escala de grises</option>
                                    <option value="BlackWhite">Blanco y negro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    @* Configuraci√≥n de salida *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">CONFIGURACI√ìN DE SALIDA</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field-row">
                                <label>Resoluci√≥n:</label>
                                <select @bind="selectedDpi" class="scanner-select" disabled="@isScanning">
                                    <option value="75">75 ppp</option>
                                    <option value="100">100 ppp</option>
                                    <option value="150">150 ppp</option>
                                    <option value="200">200 ppp</option>
                                    <option value="300">300 ppp</option>
                                    <option value="400">400 ppp</option>
                                    <option value="600">600 ppp</option>
                                </select>
                            </div>
                            @if (AllowMultiplePages)
                            {
                                <div class="scanner-field-row">
                                    <label>Formato:</label>
                                    <select @bind="outputFormat" class="scanner-select" disabled="@isScanning">
                                        <option value="images">Im√°genes separadas</option>
                                        <option value="pdf">PDF combinado</option>
                                        <option value="pdf-ocr">PDF buscable (OCR)</option>
                                    </select>
                                </div>
                                @if (outputFormat == "pdf-ocr")
                                {
                                    <OcrPanel @bind-Idioma="ocrLanguage"
                                              OcrDisponible="@ocrService.IsAvailable"
                                              Deshabilitado="isScanning" />
                                }
                            }
                        </div>
                    </div>
                    
                    @* Configuraci√≥n de imagen *@
                    <ImageEditorTools Correcciones="imageCorrection"
                                      @bind-GammaSliderValue="gammaSliderValue"
                                      @bind-ModoNitidez="sharpnessMode"
                                      MostrarPanel="showCorrectionPanel"
                                      TienePagina="@(scannedPages.Count > 0)"
                                      EstaEscaneando="isScanning"
                                      AlTogglePanel="ToggleCorrectionPanel"
                                      AlRestablecer="ResetCorrections"
                                      AlAplicar="ApplyCorrectionsToCurrentPage" />
                    
                    @* Perfiles guardados *@
                    <ScannerProfileSelector Perfiles="profiles"
                                            @bind-PerfilSeleccionadoId="selectedProfileId"
                                            Deshabilitado="isScanning"
                                            AlCargarPerfil="LoadSelectedProfile"
                                            AlAbrirGuardarPerfil="OpenSaveProfileDialog"
                                            AlCerrarGuardarPerfil="CloseSaveProfileDialog"
                                            AlGuardarPerfil="SaveCurrentProfile"
                                            MostrarDialogoGuardar="showSaveProfileDialog"
                                            @bind-NuevoPerfilNombre="newProfileName"
                                            @bind-NuevoPerfilDescripcion="newProfileDescription"
                                            @bind-NuevoPerfilPredeterminado="newProfileIsDefault"
                                            OpcionesEscaneo="scanOptions"
                                            Correcciones="imageCorrection" />
                    
                    @* Miniaturas (solo en modo batch) *@
                    @if (AllowMultiplePages && scannedPages.Count > 0)
                    {
                        <ScannerThumbnails Paginas="scannedPages"
                                           IndiceSeleccionado="previewIndex"
                                           AlSeleccionarPagina="SelectPage"
                                           AlEliminarPagina="DeletePage" />
                    }
                    
                    @* Espacio flexible *@
                    <div class="scanner-section-spacer"></div>
                    
                    @* Mensajes *@
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="scanner-message scanner-error">@errorMessage</div>
                    }
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="scanner-message scanner-success">@successMessage</div>
                    }
                </div>
            </div>
            
            @* === FOOTER CON BOTONES DE ACCI√ìN === *@
            <div class="scanner-footer-actions">
                <div class="scanner-footer-left">
                    @if (scannedPages.Count > 0)
                    {
                        <button class="scanner-btn scanner-btn-secondary" @onclick="ClearPages" disabled="@(isScanning || isGeneratingPdf)">
                            Limpiar Todo
                        </button>
                        <span class="scanner-footer-info">@scannedPages.Count p√°g. | @FormatFileSize(scannedPages.Sum(p => p.ImageBytes.Length))</span>
                    }
                </div>
                <div class="scanner-footer-right">
                    @if (isScanning || isGeneratingPdf)
                    {
                        <button class="scanner-btn scanner-btn-danger" @onclick="CancelScan" disabled="@isGeneratingPdf">Cancelar</button>
                    }
                    else
                    {
                        @if (scannedPages.Count == 0 && !isPreviewMode)
                        {
                            <button class="scanner-btn" @onclick="StartPreviewScan" disabled="@(scanners.Count == 0)" title="Escaneo r√°pido de vista previa">
                                Vista Preliminar
                            </button>
                        }
                        @if (isPreviewMode)
                        {
                            <button class="scanner-btn" @onclick="ClearSelectedArea">√Årea Completa</button>
                            <button class="scanner-btn scanner-btn-secondary" @onclick="ExitPreviewMode">Cancelar</button>
                            <button class="scanner-btn scanner-btn-success" @onclick="ScanWithSelectedArea" disabled="@(scanners.Count == 0)">
                                Escanear @(selectedArea?.IsFullArea != false ? "" : "√Årea")
                            </button>
                        }
                        else
                        {
                            <button class="scanner-btn scanner-btn-primary" @onclick="StartScan" disabled="@(scanners.Count == 0)">
                                @if (AllowMultiplePages && scannedPages.Count > 0)
                                {
                                    <span>Escanear</span>
                                }
                                else
                                {
                                    <span>Escanear</span>
                                }
                            </button>
                        }
                        @if (scannedPages.Count > 0)
                        {
                            @if (AllowMultiplePages && outputFormat == "pdf-ocr")
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmAsOcrPdf">Guardar PDF (OCR)</button>
                            }
                            else
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmScan">
                                    üíæ Guardar PDF
                                </button>
                            }
                        }
                        <button class="scanner-btn" @onclick="Cerrar">Cerrar</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Popup de vista previa fullscreen *@
<ImagePreviewPopup @bind-IsVisible="showFullscreenPreview"
                   ImageDataUrl="@fullscreenImageUrl"
                   ImageInfo="@fullscreenImageInfo"
                   PageInfo="@fullscreenPageInfo"
                   CurrentIndex="@fullscreenCurrentIndex"
                   TotalPages="@fullscreenTotalPages"
                   OnNavigate="NavigateFullscreenPage" />
