@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using System.Drawing
@inject IScannerService ScannerService
@inject IImageProcessingService ImageProcessor
@inject IScanProfileRepository ProfileRepository
@inject IOcrService ocrService

@if (IsVisible)
{
    <div class="scanner-backdrop" @onclick="OnBackdropClick" @onkeydown="HandleKeyPress" tabindex="-1">
        <div class="scanner-modal @(AllowMultiplePages ? "scanner-modal-wide" : "")" @onclick:stopPropagation="true">
            <div class="scanner-header">
                <span>@(Titulo ?? (AllowMultiplePages ? "ESCANEO MULTIPLE DE DOCUMENTOS" : "ESCANER DE DOCUMENTOS"))</span>
                <button class="scanner-close" @onclick="Cerrar" disabled="@isScanning">X</button>
            </div>
            
            <div class="scanner-body">
                @* Selector de Perfiles *@
                <div class="scanner-profiles-section">
                    <div class="scanner-option-row">
                        <label class="scanner-label">PERFIL:</label>
                        <select @bind="selectedProfileId" class="scanner-select" disabled="@isScanning"
                                @bind:after="LoadSelectedProfile">
                            <option value="0">-- CONFIGURACION MANUAL --</option>
                            @foreach (var profile in profiles)
                            {
                                <option value="@profile.Id">
                                    @profile.Name @(profile.IsDefault ? "(‚òÖ)" : "")
                                </option>
                            }
                        </select>
                        <button class="scanner-btn-small" @onclick="RefreshProfiles" disabled="@isScanning" title="Actualizar perfiles">
                            ‚Üª
                        </button>
                        <button class="scanner-btn-small" @onclick="OpenSaveProfileDialog" disabled="@isScanning" title="Guardar configuraci√≥n actual como perfil">
                            üíæ
                        </button>
                    </div>
                </div>
                
                @* Panel de Opciones *@
                <div class="scanner-options">
                    <div class="scanner-option-row">
                        <label class="scanner-label">ESCANER:</label>
                        <select @bind="selectedDeviceId" class="scanner-select" disabled="@isScanning">
                            @if (scanners.Count == 0)
                            {
                                <option value="">-- SIN ESCANERES --</option>
                            }
                            else
                            {
                                @foreach (var scanner in scanners)
                                {
                                    <option value="@scanner.Id">@scanner.Name (@scanner.Driver)</option>
                                }
                            }
                        </select>
                        <button class="scanner-btn-small" @onclick="RefreshScanners" disabled="@isScanning" title="Actualizar lista">
                            ‚Üª
                        </button>
                    </div>
                    
                    <div class="scanner-option-group">
                        <div class="scanner-option-row">
                            <label class="scanner-label">DPI:</label>
                            <select @bind="scanOptions.Dpi" class="scanner-select" disabled="@isScanning">
                                <option value="150">150 (R√°pido)</option>
                                <option value="200">200 (Normal)</option>
                                <option value="300">300 (Alta calidad)</option>
                                <option value="600">600 (Muy alta)</option>
                            </select>
                        </div>
                        
                        <div class="scanner-option-row">
                            <label class="scanner-label">COLOR:</label>
                            <select @bind="scanOptions.ColorMode" class="scanner-select" disabled="@isScanning">
                                <option value="@ScanColorMode.Color">Color</option>
                                <option value="@ScanColorMode.Grayscale">Escala de grises</option>
                                <option value="@ScanColorMode.BlackWhite">Blanco y negro</option>
                            </select>
                        </div>
                        
                        <div class="scanner-option-row">
                            <label class="scanner-label">FUENTE:</label>
                            <select @bind="scanOptions.Source" class="scanner-select" disabled="@isScanning">
                                <option value="@ScanSource.Flatbed">Cama plana</option>
                                <option value="@ScanSource.Feeder">Alimentador</option>
                                <option value="@ScanSource.Auto">Autom√°tico</option>
                            </select>
                        </div>
                        
                        @if (AllowMultiplePages)
                        {
                            <div class="scanner-option-row">
                                <label class="scanner-label">SALIDA:</label>
                                <select @bind="outputFormat" class="scanner-select" disabled="@isScanning">
                                    <option value="images">Im√°genes separadas</option>
                                    <option value="pdf">PDF combinado</option>
                                    <option value="pdf-ocr">PDF buscable (OCR)</option>
                                </select>
                            </div>
                            
                            @if (outputFormat == "pdf-ocr")
                            {
                                <div class="scanner-option-row">
                                    <label class="scanner-label">IDIOMA OCR:</label>
                                    <select @bind="ocrLanguage" class="scanner-select" disabled="@isScanning">
                                        <option value="spa">Espa√±ol</option>
                                        <option value="eng">Ingl√©s</option>
                                        <option value="por">Portugu√©s</option>
                                    </select>
                                    @if (!ocrService.IsAvailable)
                                    {
                                        <span class="scanner-ocr-warning" title="OCR no est√° instalado. El PDF se generar√° sin texto buscable.">‚ö†Ô∏è</span>
                                    }
                                </div>
                            }
                        }
                    </div>
                    
                    @* Panel de Correcci√≥n de Imagen (colapsable) *@
                    <div class="scanner-correction-panel">
                        <div class="scanner-correction-header" @onclick="ToggleCorrectionPanel">
                            <span>CORRECCION DE IMAGEN</span>
                            <span class="scanner-correction-toggle">@(showCorrectionPanel ? "‚ñº" : "‚ñ∂")</span>
                        </div>
                        
                        @if (showCorrectionPanel)
                        {
                            <div class="scanner-correction-body">
                                <div class="scanner-slider-row">
                                    <label>BRILLO:</label>
                                    <input type="range" min="-100" max="100" @bind="imageCorrection.Brightness" 
                                           @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-value">@imageCorrection.Brightness</span>
                                </div>
                                
                                <div class="scanner-slider-row">
                                    <label>CONTRASTE:</label>
                                    <input type="range" min="-100" max="100" @bind="imageCorrection.Contrast" 
                                           @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-value">@imageCorrection.Contrast</span>
                                </div>
                                
                                <div class="scanner-slider-row">
                                    <label>GAMMA:</label>
                                    <input type="range" min="10" max="300" @bind="gammaSliderValue" 
                                           @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-value">@imageCorrection.Gamma.ToString("F1")</span>
                                </div>
                                
                                <div class="scanner-slider-row">
                                    <label>NITIDEZ:</label>
                                    <input type="range" min="0" max="100" @bind="imageCorrection.Sharpness" 
                                           @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-value">@imageCorrection.Sharpness</span>
                                </div>
                                
                                @if (scanOptions.ColorMode == ScanColorMode.BlackWhite)
                                {
                                    <div class="scanner-slider-row">
                                        <label>UMBRAL B/N:</label>
                                        <input type="range" min="0" max="255" @bind="imageCorrection.BlackWhiteThreshold" 
                                               @bind:event="oninput" disabled="@isScanning" />
                                        <span class="scanner-slider-value">@imageCorrection.BlackWhiteThreshold</span>
                                    </div>
                                }
                                
                                <div class="scanner-correction-actions">
                                    <button class="scanner-btn-small" @onclick="ResetCorrections" disabled="@isScanning">
                                        RESTABLECER
                                    </button>
                                    @if (scannedPages.Count > 0 && imageCorrection.HasCorrections)
                                    {
                                        <button class="scanner-btn-small" @onclick="ApplyCorrectionsToCurrentPage" disabled="@isScanning">
                                            APLICAR A PAGINA
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                @* Contenedor Principal con miniaturas y preview *@
                <div class="scanner-main-container">
                    @* Miniaturas (solo en modo batch) *@
                    @if (AllowMultiplePages && scannedPages.Count > 0)
                    {
                        <div class="scanner-thumbnails">
                            <div class="scanner-thumbnails-header">
                                PAGINAS (@scannedPages.Count)
                            </div>
                            <div class="scanner-thumbnails-list">
                                @for (int i = 0; i < scannedPages.Count; i++)
                                {
                                    var index = i;
                                    <div class="scanner-thumbnail @(previewIndex == index ? "scanner-thumbnail-selected" : "")" 
                                         @onclick="() => SelectPage(index)">
                                        <div class="scanner-thumbnail-number">@(index + 1)</div>
                                        <img src="data:@scannedPages[index].MimeType;base64,@Convert.ToBase64String(scannedPages[index].ImageBytes)" 
                                             alt="P√°gina @(index + 1)" />
                                        <button class="scanner-thumbnail-delete" 
                                                @onclick="() => DeletePage(index)" 
                                                @onclick:stopPropagation="true"
                                                title="Eliminar p√°gina">√ó</button>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    @* Vista Previa *@
                    <div class="scanner-preview-container">
                        @if (isScanning)
                        {
                            <div class="scanner-progress">
                                <div class="scanner-progress-text">@progressStatus</div>
                                <div class="scanner-progress-bar">
                                    <div class="scanner-progress-fill" style="width: @(progressPercent * 100)%"></div>
                                </div>
                                <div class="scanner-progress-page">P√°gina @currentPage</div>
                            </div>
                        }
                        else if (isGeneratingPdf)
                        {
                            <div class="scanner-progress">
                                <div class="scanner-progress-text">GENERANDO PDF...</div>
                                <div class="scanner-progress-bar">
                                    <div class="scanner-progress-fill scanner-progress-indeterminate"></div>
                                </div>
                                <div class="scanner-progress-page">Combinando @scannedPages.Count p√°gina(s)</div>
                            </div>
                        }
                        else if (scannedPages.Count > 0)
                        {
                            <div class="scanner-preview">
                                <div class="scanner-preview-nav">
                                    <button class="scanner-btn-nav" @onclick="PreviousPage" disabled="@(previewIndex <= 0)">‚óÄ</button>
                                    <span>PAGINA @(previewIndex + 1) DE @scannedPages.Count</span>
                                    <button class="scanner-btn-nav" @onclick="NextPage" disabled="@(previewIndex >= scannedPages.Count - 1)">‚ñ∂</button>
                                </div>
                                
                                @* Barra de herramientas de transformaci√≥n *@
                                <div class="scanner-toolbar">
                                    <button class="scanner-tool-btn" @onclick="() => RotatePage(-90)" title="Rotar izquierda 90¬∞">
                                        ‚Ü∫
                                    </button>
                                    <button class="scanner-tool-btn" @onclick="() => RotatePage(90)" title="Rotar derecha 90¬∞">
                                        ‚Üª
                                    </button>
                                    <button class="scanner-tool-btn" @onclick="() => RotatePage(180)" title="Rotar 180¬∞">
                                        ‚ü≤
                                    </button>
                                    <div class="scanner-tool-separator"></div>
                                    <button class="scanner-tool-btn" @onclick="FlipHorizontalPage" title="Voltear horizontal">
                                        ‚áÜ
                                    </button>
                                    <button class="scanner-tool-btn" @onclick="FlipVerticalPage" title="Voltear vertical">
                                        ‚áÖ
                                    </button>
                                    <div class="scanner-tool-separator"></div>
                                    <button class="scanner-tool-btn" @onclick="AutoCropPage" title="Auto-recortar bordes">
                                        ‚¨ö
                                    </button>
                                </div>
                                
                                <div class="scanner-preview-image">
                                    <img src="data:@scannedPages[previewIndex].MimeType;base64,@Convert.ToBase64String(scannedPages[previewIndex].ImageBytes)" 
                                         alt="P√°gina escaneada" />
                                </div>
                                <div class="scanner-preview-info">
                                    @scannedPages[previewIndex].Width x @scannedPages[previewIndex].Height px | 
                                    @FormatFileSize(scannedPages[previewIndex].ImageBytes.Length) |
                                    Escaneado: @scannedPages[previewIndex].ScannedAt.ToString("HH:mm:ss")
                                </div>
                            </div>
                        }
                        else if (isPreviewMode && previewImage != null)
                        {
                            @* Modo Vista Previa con selecci√≥n de √°rea *@
                            <div class="scanner-preview-mode">
                                <div class="scanner-preview-header">
                                    SELECCIONE EL √ÅREA A ESCANEAR (o deje vac√≠o para √°rea completa)
                                </div>
                                <div class="scanner-preview-canvas" 
                                     @onmousedown="StartAreaSelection"
                                     @onmousemove="UpdateAreaSelection"
                                     @onmouseup="EndAreaSelection"
                                     @onmouseleave="EndAreaSelection">
                                    <img src="data:@previewImage.MimeType;base64,@Convert.ToBase64String(previewImage.ImageBytes)" 
                                         alt="Vista previa" @ref="previewImageElement" />
                                    
                                    @if (selectedArea != null && !selectedArea.IsFullArea)
                                    {
                                        <div class="scanner-selection-box"
                                             style="left: @(selectedArea.Left)%; top: @(selectedArea.Top)%; 
                                                    width: @(selectedArea.Width)%; height: @(selectedArea.Height)%;">
                                            <div class="scanner-selection-info">
                                                @(selectedArea.Width.ToString("F0"))% x @(selectedArea.Height.ToString("F0"))%
                                            </div>
                                        </div>
                                    }
                                    @if (isSelectingArea)
                                    {
                                        <div class="scanner-selection-box scanner-selection-active"
                                             style="left: @Math.Min(selectionStart.X, selectionCurrent.X)%; 
                                                    top: @Math.Min(selectionStart.Y, selectionCurrent.Y)%; 
                                                    width: @Math.Abs(selectionCurrent.X - selectionStart.X)%; 
                                                    height: @Math.Abs(selectionCurrent.Y - selectionStart.Y)%;">
                                        </div>
                                    }
                                </div>
                                <div class="scanner-preview-actions">
                                    <button class="scanner-btn-small" @onclick="ClearSelectedArea">
                                        √ÅREA COMPLETA
                                    </button>
                                    <span class="scanner-preview-info-text">
                                        Vista previa: @previewImage.Width x @previewImage.Height px (75 DPI)
                                    </span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="scanner-placeholder">
                                <div class="scanner-placeholder-icon">üìÑ</div>
                                <div class="scanner-placeholder-text">COLOQUE EL DOCUMENTO EN EL ESCANER</div>
                                <div class="scanner-placeholder-hint">
                                    @if (AllowMultiplePages)
                                    {
                                        <span>PRESIONE "ESCANEAR" PARA CADA PAGINA</span>
                                    }
                                    else
                                    {
                                        <span>USE "VISTA PREVIA" PARA SELECCIONAR √ÅREA O "ESCANEAR" DIRECTO</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                @* Mensajes *@
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="scanner-message scanner-error">@errorMessage</div>
                }
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="scanner-message scanner-success">@successMessage</div>
                }
            </div>
            
            <div class="scanner-footer">
                <div class="scanner-footer-left">
                    @if (scannedPages.Count > 0)
                    {
                        <button class="scanner-btn scanner-btn-secondary" @onclick="ClearPages" disabled="@(isScanning || isGeneratingPdf)">
                            LIMPIAR TODO
                        </button>
                        <span class="scanner-footer-info">
                            @scannedPages.Count p√°g. | @FormatFileSize(scannedPages.Sum(p => p.ImageBytes.Length))
                        </span>
                    }
                </div>
                <div class="scanner-footer-right">
                    @if (isScanning || isGeneratingPdf)
                    {
                        <button class="scanner-btn scanner-btn-danger" @onclick="CancelScan" disabled="@isGeneratingPdf">
                            CANCELAR
                        </button>
                    }
                    else
                    {
                        <button class="scanner-btn" @onclick="Cerrar">
                            CERRAR [ESC]
                        </button>
                        @if (scannedPages.Count == 0 && !isPreviewMode)
                        {
                            <button class="scanner-btn" @onclick="StartPreviewScan" disabled="@(scanners.Count == 0)" title="Escaneo r√°pido de vista previa para seleccionar √°rea">
                                VISTA PREVIA
                            </button>
                        }
                        @if (isPreviewMode)
                        {
                            <button class="scanner-btn scanner-btn-secondary" @onclick="ExitPreviewMode">
                                CANCELAR PREVIEW
                            </button>
                            <button class="scanner-btn scanner-btn-success" @onclick="ScanWithSelectedArea" disabled="@(scanners.Count == 0)">
                                ESCANEAR @(selectedArea?.IsFullArea != false ? "COMPLETO" : "√ÅREA")
                            </button>
                        }
                        else
                        {
                            <button class="scanner-btn scanner-btn-primary" @onclick="StartScan" disabled="@(scanners.Count == 0)">
                                @if (AllowMultiplePages && scannedPages.Count > 0)
                                {
                                    <span>+ ESCANEAR [F5]</span>
                                }
                                else
                                {
                                    <span>ESCANEAR [F5]</span>
                                }
                            </button>
                        }
                        @if (scannedPages.Count > 0)
                        {
                            @if (AllowMultiplePages && outputFormat == "pdf")
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmAsPdf">
                                    GENERAR PDF (@scannedPages.Count)
                                </button>
                            }
                            else if (AllowMultiplePages && outputFormat == "pdf-ocr")
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmAsOcrPdf">
                                    PDF BUSCABLE (@scannedPages.Count)
                                </button>
                            }
                            else
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmScan">
                                    ACEPTAR (@scannedPages.Count)
                                </button>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Modal para Guardar Perfil *@
@if (showSaveProfileDialog)
{
    <div class="scanner-backdrop" @onclick:stopPropagation="true">
        <div class="scanner-profile-dialog" @onclick:stopPropagation="true">
            <div class="scanner-header">
                <span>GUARDAR PERFIL</span>
                <button class="scanner-close" @onclick="CloseSaveProfileDialog">X</button>
            </div>
            <div class="scanner-profile-dialog-body">
                <div class="scanner-option-row">
                    <label class="scanner-label">NOMBRE:</label>
                    <input type="text" @bind="newProfileName" class="scanner-input" 
                           placeholder="Ej: Mi perfil de documentos" maxlength="50" />
                </div>
                <div class="scanner-option-row">
                    <label class="scanner-label">DESCRIPCION:</label>
                    <input type="text" @bind="newProfileDescription" class="scanner-input" 
                           placeholder="Descripci√≥n opcional" maxlength="200" />
                </div>
                <div class="scanner-option-row">
                    <label class="scanner-checkbox-label">
                        <input type="checkbox" @bind="newProfileIsDefault" />
                        <span>ESTABLECER COMO PREDETERMINADO</span>
                    </label>
                </div>
                <div class="scanner-profile-dialog-info">
                    <strong>CONFIGURACI√ìN A GUARDAR:</strong><br/>
                    DPI: @scanOptions.Dpi | Color: @scanOptions.ColorMode | Fuente: @scanOptions.Source<br/>
                    @if (imageCorrection.HasCorrections)
                    {
                        <span>Correcciones: Brillo=@imageCorrection.Brightness, Contraste=@imageCorrection.Contrast</span>
                    }
                </div>
            </div>
            <div class="scanner-footer">
                <button class="scanner-btn" @onclick="CloseSaveProfileDialog">CANCELAR</button>
                <button class="scanner-btn scanner-btn-success" @onclick="SaveCurrentProfile" 
                        disabled="@string.IsNullOrWhiteSpace(newProfileName)">
                    GUARDAR PERFIL
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Se dispara cuando el usuario confirma las p√°ginas escaneadas (modo im√°genes).
    /// Retorna la lista de p√°ginas escaneadas.
    /// </summary>
    [Parameter] public EventCallback<List<ScannedPageDto>> OnScanComplete { get; set; }
    
    /// <summary>
    /// Se dispara cuando el usuario genera un PDF combinado.
    /// Retorna los bytes del PDF.
    /// </summary>
    [Parameter] public EventCallback<byte[]> OnPdfGenerated { get; set; }
    
    /// <summary>
    /// Se dispara cuando se cancela el modal sin confirmar.
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }
    
    /// <summary>
    /// Permite escaneo de m√∫ltiples p√°ginas (batch).
    /// Si es false, solo escanea una p√°gina y cierra autom√°ticamente.
    /// </summary>
    [Parameter] public bool AllowMultiplePages { get; set; } = false;
    
    /// <summary>
    /// Texto personalizado para el t√≠tulo del modal.
    /// </summary>
    [Parameter] public string? Titulo { get; set; }

    // Estado interno
    private List<ScannerDeviceDto> scanners = new();
    private List<ScannedPageDto> scannedPages = new();
    private ScanOptionsDto scanOptions = new() { Dpi = 200 };
    private string? selectedDeviceId;
    private string outputFormat = "images"; // "images", "pdf" o "pdf-ocr"
    private string ocrLanguage = "spa"; // Idioma para OCR
    
    // Perfiles de escaneo
    private List<ScanProfileDto> profiles = new();
    private int selectedProfileId = 0;
    private bool showSaveProfileDialog = false;
    private string newProfileName = "";
    private string newProfileDescription = "";
    private bool newProfileIsDefault = false;
    
    // Vista previa y selecci√≥n de √°rea
    private bool isPreviewMode = false;
    private ScannedDocumentDto? previewImage = null;
    private ScanAreaDto? selectedArea = null;
    private bool isSelectingArea = false;
    private (double X, double Y) selectionStart = (0, 0);
    private (double X, double Y) selectionCurrent = (0, 0);
    private ElementReference previewImageElement;
    
    // Correcci√≥n de imagen
    private ImageCorrectionDto imageCorrection = new();
    private bool showCorrectionPanel = false;
    
    // Gamma usa slider entero (10-300) mapeado a float (0.1-3.0)
    private int gammaSliderValue
    {
        get => (int)(imageCorrection.Gamma * 100);
        set => imageCorrection.Gamma = value / 100f;
    }
    
    private bool isScanning = false;
    private bool isGeneratingPdf = false;
    private bool isLoadingScanners = false;
    private int previewIndex = 0;
    private int currentPage = 0;
    private double progressPercent = 0;
    private string progressStatus = "";
    
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && scanners.Count == 0 && !isLoadingScanners)
        {
            await RefreshScanners();
            await RefreshProfiles();
        }
    }

    protected override void OnInitialized()
    {
        ScannerService.ScanProgress += OnScanProgress;
    }

    private void OnScanProgress(object? sender, ScanProgressEventArgs e)
    {
        InvokeAsync(() =>
        {
            currentPage = e.CurrentPage;
            progressPercent = e.Progress;
            progressStatus = e.Status;
            
            if (e.HasError)
            {
                errorMessage = e.ErrorMessage;
            }
            
            StateHasChanged();
        });
    }

    private async Task RefreshScanners()
    {
        isLoadingScanners = true;
        errorMessage = null;
        
        try
        {
            var result = await ScannerService.GetAvailableScannersAsync();
            if (result.IsSuccess && result.Value != null)
            {
                scanners = result.Value;
                if (scanners.Count > 0 && string.IsNullOrEmpty(selectedDeviceId))
                {
                    selectedDeviceId = scanners[0].Id;
                }
                
                if (scanners.Count == 0)
                {
                    errorMessage = "No se encontraron esc√°neres. Verifique que el esc√°ner est√© conectado y encendido.";
                }
            }
            else
            {
                errorMessage = result.Error ?? "Error al buscar esc√°neres";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingScanners = false;
            StateHasChanged();
        }
    }

    private async Task StartScan()
    {
        if (isScanning) return;
        
        isScanning = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            scanOptions.DeviceId = selectedDeviceId;
            
            // Siempre escanea una p√°gina a la vez (el usuario puede agregar m√°s en modo batch)
            var result = await ScannerService.ScanSinglePageAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                var doc = result.Value;
                scannedPages.Add(new ScannedPageDto
                {
                    ImageBytes = doc.ImageBytes,
                    MimeType = doc.MimeType,
                    Width = doc.Width,
                    Height = doc.Height,
                    Dpi = doc.Dpi,
                    ScannedAt = doc.ScannedAt,
                    PageNumber = scannedPages.Count + 1
                });
                previewIndex = scannedPages.Count - 1;
                
                if (AllowMultiplePages)
                {
                    successMessage = $"P√°gina {scannedPages.Count} escaneada. Puede continuar escaneando m√°s p√°ginas.";
                }
                else
                {
                    successMessage = "P√°gina escaneada correctamente";
                }
            }
            else
            {
                errorMessage = result.Error ?? "Error al escanear";
            }
        }
        catch (OperationCanceledException)
        {
            successMessage = "Escaneo cancelado";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    private void CancelScan()
    {
        ScannerService.CancelCurrentScan();
    }

    private async Task ConfirmScan()
    {
        if (scannedPages.Count == 0) return;
        
        // Renumerar p√°ginas
        for (int i = 0; i < scannedPages.Count; i++)
        {
            scannedPages[i].PageNumber = i + 1;
        }
        
        await OnScanComplete.InvokeAsync(new List<ScannedPageDto>(scannedPages));
        await Cerrar();
    }

    private async Task ConfirmAsPdf()
    {
        if (scannedPages.Count == 0) return;
        
        isGeneratingPdf = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Generar PDF combinando todas las p√°ginas
            var pdfBytes = await GeneratePdfFromPagesAsync();
            
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                await OnPdfGenerated.InvokeAsync(pdfBytes);
                await Cerrar();
            }
            else
            {
                errorMessage = "Error al generar el PDF";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generando PDF: {ex.Message}";
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmAsOcrPdf()
    {
        if (scannedPages.Count == 0) return;
        
        isGeneratingPdf = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Generar PDF con OCR usando el servicio dedicado
            var result = await ocrService.GenerateSearchablePdfAsync(scannedPages, ocrLanguage);
            
            if (result.IsSuccess && result.Value != null)
            {
                if (!ocrService.IsAvailable)
                {
                    successMessage = "PDF generado (sin OCR - funci√≥n no habilitada)";
                }
                await OnPdfGenerated.InvokeAsync(result.Value);
                await Cerrar();
            }
            else
            {
                errorMessage = result.Error ?? "Error al generar el PDF buscable";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generando PDF con OCR: {ex.Message}";
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task<byte[]?> GeneratePdfFromPagesAsync()
    {
        // Usar QuestPDF para generar el PDF
        return await Task.Run(() =>
        {
            try
            {
                using var ms = new MemoryStream();
                
                QuestPDF.Fluent.Document.Create(container =>
                {
                    foreach (var page in scannedPages)
                    {
                        container.Page(pageDescriptor =>
                        {
                            pageDescriptor.Size(QuestPDF.Helpers.PageSizes.Letter);
                            pageDescriptor.Margin(0);
                            
                            pageDescriptor.Content().Image(page.ImageBytes)
                                .FitArea();
                        });
                    }
                }).GeneratePdf(ms);
                
                return ms.ToArray();
            }
            catch
            {
                return null;
            }
        });
    }

    private void SelectPage(int index)
    {
        if (index >= 0 && index < scannedPages.Count)
        {
            previewIndex = index;
        }
    }

    private void DeletePage(int index)
    {
        if (index >= 0 && index < scannedPages.Count)
        {
            scannedPages.RemoveAt(index);
            
            // Renumerar p√°ginas
            for (int i = 0; i < scannedPages.Count; i++)
            {
                scannedPages[i].PageNumber = i + 1;
            }
            
            // Ajustar preview index
            if (previewIndex >= scannedPages.Count)
            {
                previewIndex = Math.Max(0, scannedPages.Count - 1);
            }
            
            successMessage = $"P√°gina eliminada. Quedan {scannedPages.Count} p√°gina(s).";
        }
    }

    private void ClearPages()
    {
        scannedPages.Clear();
        previewIndex = 0;
        successMessage = null;
        errorMessage = null;
    }

    private void PreviousPage()
    {
        if (previewIndex > 0) previewIndex--;
    }

    private void NextPage()
    {
        if (previewIndex < scannedPages.Count - 1) previewIndex++;
    }

    private async Task OnBackdropClick()
    {
        if (!isScanning && !isGeneratingPdf)
        {
            await Cerrar();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (isScanning || isGeneratingPdf) return;
        
        switch (e.Key)
        {
            case "Escape":
                await Cerrar();
                break;
            case "F5":
                await StartScan();
                break;
            case "ArrowLeft":
                PreviousPage();
                break;
            case "ArrowRight":
                NextPage();
                break;
            case "Delete":
                if (scannedPages.Count > 0)
                {
                    DeletePage(previewIndex);
                }
                break;
        }
    }

    private async Task Cerrar()
    {
        if (isScanning || isGeneratingPdf) return;
        
        scannedPages.Clear();
        previewIndex = 0;
        errorMessage = null;
        successMessage = null;
        outputFormat = "images";
        
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        await OnCancel.InvokeAsync();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }

    #region Correcci√≥n y Transformaci√≥n de Imagen
    
    private void ToggleCorrectionPanel() => showCorrectionPanel = !showCorrectionPanel;

    private void ResetCorrections()
    {
        imageCorrection = new ImageCorrectionDto();
    }
    
    private void ApplyCorrectionsToCurrentPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        if (!imageCorrection.HasCorrections) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.ApplyCorrections(page.ImageBytes, imageCorrection);
        
        // Actualizar dimensiones en caso de que hayan cambiado
        UpdatePageDimensions(page);
        
        successMessage = "Correcciones aplicadas a la p√°gina";
        ResetCorrections();
        StateHasChanged();
    }
    
    private void RotatePage(int degrees)
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        byte[] rotated = degrees switch
        {
            90 => ImageProcessor.RotateClockwise(page.ImageBytes),
            -90 => ImageProcessor.RotateCounterClockwise(page.ImageBytes),
            180 => ImageProcessor.Rotate180(page.ImageBytes),
            _ => page.ImageBytes
        };
        
        page.ImageBytes = rotated;
        UpdatePageDimensions(page);
        StateHasChanged();
    }

    private void FlipHorizontalPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.FlipHorizontal(page.ImageBytes);
        StateHasChanged();
    }

    private void FlipVerticalPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.FlipVertical(page.ImageBytes);
        StateHasChanged();
    }

    private void AutoCropPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        var cropped = ImageProcessor.AutoCrop(page.ImageBytes);
        
        page.ImageBytes = cropped;
        UpdatePageDimensions(page);
        
        successMessage = "Imagen recortada autom√°ticamente";
        StateHasChanged();
    }
    
    private void UpdatePageDimensions(ScannedPageDto page)
    {
        try
        {
            using var ms = new MemoryStream(page.ImageBytes);
            using var img = Image.FromStream(ms);
            page.Width = img.Width;
            page.Height = img.Height;
        }
        catch
        {
            // Si falla, mantener dimensiones anteriores
        }
    }
    
    #endregion

    #region Vista Previa y Selecci√≥n de √Årea
    
    private async Task StartPreviewScan()
    {
        if (isScanning) return;
        
        isScanning = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            scanOptions.DeviceId = selectedDeviceId;
            
            var result = await ScannerService.PreviewScanAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                previewImage = result.Value;
                isPreviewMode = true;
                selectedArea = null;
                successMessage = "Vista previa obtenida. Seleccione el √°rea a escanear o presione ESCANEAR para √°rea completa.";
            }
            else
            {
                errorMessage = result.Error ?? "Error al obtener vista previa";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }
    
    private void ExitPreviewMode()
    {
        isPreviewMode = false;
        previewImage = null;
        selectedArea = null;
        isSelectingArea = false;
    }
    
    private async Task ScanWithSelectedArea()
    {
        if (isScanning) return;
        
        isScanning = true;
        isPreviewMode = false;
        errorMessage = null;
        
        try
        {
            scanOptions.DeviceId = selectedDeviceId;
            
            var result = await ScannerService.ScanSinglePageAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                var doc = result.Value;
                byte[] finalBytes = doc.ImageBytes;
                int width = doc.Width;
                int height = doc.Height;
                
                // Si hay √°rea seleccionada, recortar
                if (selectedArea != null && !selectedArea.IsFullArea)
                {
                    finalBytes = ImageProcessor.CropToArea(finalBytes, selectedArea);
                    
                    using var ms = new MemoryStream(finalBytes);
                    using var img = Image.FromStream(ms);
                    width = img.Width;
                    height = img.Height;
                }
                
                scannedPages.Add(new ScannedPageDto
                {
                    ImageBytes = finalBytes,
                    MimeType = doc.MimeType,
                    Width = width,
                    Height = height,
                    Dpi = doc.Dpi,
                    ScannedAt = doc.ScannedAt,
                    PageNumber = scannedPages.Count + 1
                });
                previewIndex = scannedPages.Count - 1;
                
                successMessage = selectedArea?.IsFullArea == false 
                    ? "√Årea seleccionada escaneada y recortada correctamente"
                    : "P√°gina escaneada correctamente";
            }
            else
            {
                errorMessage = result.Error ?? "Error al escanear";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            previewImage = null;
            selectedArea = null;
            StateHasChanged();
        }
    }
    
    private void StartAreaSelection(MouseEventArgs e)
    {
        // Calcular posici√≥n relativa como porcentaje
        // Nota: Esto es una aproximaci√≥n, idealmente usar√≠amos JS interop
        isSelectingArea = true;
        selectionStart = (e.OffsetX / 4, e.OffsetY / 3); // Aproximaci√≥n basada en tama√±o t√≠pico
        selectionCurrent = selectionStart;
    }
    
    private void UpdateAreaSelection(MouseEventArgs e)
    {
        if (!isSelectingArea) return;
        selectionCurrent = (e.OffsetX / 4, e.OffsetY / 3);
        StateHasChanged();
    }
    
    private void EndAreaSelection(MouseEventArgs e)
    {
        if (!isSelectingArea) return;
        isSelectingArea = false;
        
        double left = Math.Min(selectionStart.X, selectionCurrent.X);
        double top = Math.Min(selectionStart.Y, selectionCurrent.Y);
        double width = Math.Abs(selectionCurrent.X - selectionStart.X);
        double height = Math.Abs(selectionCurrent.Y - selectionStart.Y);
        
        // Solo crear √°rea si es significativa (m√°s de 5%)
        if (width > 5 && height > 5)
        {
            selectedArea = new ScanAreaDto
            {
                Left = Math.Max(0, Math.Min(100, left)),
                Top = Math.Max(0, Math.Min(100, top)),
                Width = Math.Min(100 - left, width),
                Height = Math.Min(100 - top, height)
            };
        }
        
        StateHasChanged();
    }
    
    private void ClearSelectedArea()
    {
        selectedArea = null;
        StateHasChanged();
    }
    
    #endregion

    #region Perfiles de Escaneo
    
    private async Task RefreshProfiles()
    {
        try
        {
            profiles = await ProfileRepository.GetAllAsync();
            
            // Cargar perfil por defecto si existe
            var defaultProfile = profiles.FirstOrDefault(p => p.IsDefault);
            if (defaultProfile != null && selectedProfileId == 0)
            {
                selectedProfileId = defaultProfile.Id;
                await LoadSelectedProfile();
            }
        }
        catch
        {
            // Ignorar errores de carga de perfiles (la tabla puede no existir a√∫n)
            profiles = new List<ScanProfileDto>();
        }
    }
    
    private async Task LoadSelectedProfile()
    {
        if (selectedProfileId == 0)
        {
            // Modo manual - no cambiar configuraci√≥n
            return;
        }
        
        var profile = profiles.FirstOrDefault(p => p.Id == selectedProfileId);
        if (profile != null)
        {
            // Aplicar configuraci√≥n del perfil
            scanOptions.Dpi = profile.Dpi;
            scanOptions.ColorMode = profile.ColorMode;
            scanOptions.Source = profile.Source;
            scanOptions.PageSize = profile.PageSize;
            
            // Aplicar correcciones
            imageCorrection = profile.ToImageCorrection();
            
            // Actualizar fecha de √∫ltimo uso
            await ProfileRepository.UpdateLastUsedAsync(profile.Id);
            
            successMessage = $"Perfil \"{profile.Name}\" cargado";
            StateHasChanged();
        }
    }
    
    private void OpenSaveProfileDialog()
    {
        newProfileName = "";
        newProfileDescription = "";
        newProfileIsDefault = false;
        showSaveProfileDialog = true;
    }
    
    private void CloseSaveProfileDialog()
    {
        showSaveProfileDialog = false;
    }
    
    private async Task SaveCurrentProfile()
    {
        if (string.IsNullOrWhiteSpace(newProfileName)) return;
        
        try
        {
            var profile = new ScanProfileDto
            {
                Name = newProfileName.Trim(),
                Description = string.IsNullOrWhiteSpace(newProfileDescription) ? null : newProfileDescription.Trim(),
                IsDefault = newProfileIsDefault,
                Dpi = scanOptions.Dpi,
                ColorMode = scanOptions.ColorMode,
                Source = scanOptions.Source,
                PageSize = scanOptions.PageSize,
                Brightness = imageCorrection.Brightness,
                Contrast = imageCorrection.Contrast,
                Gamma = imageCorrection.Gamma,
                Sharpness = imageCorrection.Sharpness,
                BlackWhiteThreshold = imageCorrection.BlackWhiteThreshold
            };
            
            if (newProfileIsDefault)
            {
                await ProfileRepository.SetDefaultAsync(0); // Quitar default de todos primero
            }
            
            var saved = await ProfileRepository.SaveAsync(profile);
            
            // Recargar perfiles y seleccionar el nuevo
            await RefreshProfiles();
            selectedProfileId = saved.Id;
            
            successMessage = $"Perfil \"{saved.Name}\" guardado correctamente";
            CloseSaveProfileDialog();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error guardando perfil: {ex.Message}";
        }
    }
    
    #endregion

    public void Dispose()
    {
        ScannerService.ScanProgress -= OnScanProgress;
    }
}
