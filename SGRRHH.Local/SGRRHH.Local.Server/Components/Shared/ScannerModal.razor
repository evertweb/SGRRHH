@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Shared.Interfaces
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using System.Drawing
@inject IScannerService ScannerService
@inject IImageProcessingService ImageProcessor
@inject IScanProfileRepository ProfileRepository
@inject IOcrService ocrService
@inject IJSRuntime JS

@if (IsVisible)
{
    <div class="scanner-backdrop" @onclick="OnBackdropClick" @onkeydown="HandleKeyPress" tabindex="-1">
        <div class="scanner-modal scanner-modal-fullscreen" @onclick:stopPropagation="true">
            <div class="scanner-header">
                <span>@(Titulo ?? (AllowMultiplePages ? "ESCANEO M√öLTIPLE DE DOCUMENTOS" : "ESC√ÅNER DE DOCUMENTOS"))</span>
                <button class="scanner-close" @onclick="Cerrar" disabled="@isScanning">‚úï</button>
            </div>
            
            <div class="scanner-body-horizontal">
                @* === PANEL IZQUIERDO: VISTA PREVIA GRANDE === *@
                <div class="scanner-preview-panel">
                    @* Barra de herramientas superior *@
                    <div class="scanner-preview-toolbar">
                        <div class="scanner-toolbar-left">
                            @if (AllowMultiplePages && scannedPages.Count > 0)
                            {
                                <button class="scanner-tool-btn" @onclick="PreviousPage" disabled="@(previewIndex <= 0)" title="P√°gina anterior">‚óÄ</button>
                                <span class="scanner-page-indicator">@(previewIndex + 1) / @scannedPages.Count</span>
                                <button class="scanner-tool-btn" @onclick="NextPage" disabled="@(previewIndex >= scannedPages.Count - 1)" title="P√°gina siguiente">‚ñ∂</button>
                                <div class="scanner-tool-separator"></div>
                            }
                            @if (scannedPages.Count > 0)
                            {
                                <button class="scanner-tool-btn" @onclick="@(() => RotatePage(-90))" title="Rotar izquierda 90¬∞">‚Ü∫</button>
                                <button class="scanner-tool-btn" @onclick="@(() => RotatePage(90))" title="Rotar derecha 90¬∞">‚Üª</button>
                                <button class="scanner-tool-btn" @onclick="@(() => RotatePage(180))" title="Rotar 180¬∞">‚ü≤</button>
                                <div class="scanner-tool-separator"></div>
                                <button class="scanner-tool-btn" @onclick="FlipHorizontalPage" title="Voltear horizontal">‚áÜ</button>
                                <button class="scanner-tool-btn" @onclick="FlipVerticalPage" title="Voltear vertical">‚áÖ</button>
                                <div class="scanner-tool-separator"></div>
                                <button class="scanner-tool-btn" @onclick="AutoCropPage" title="Auto-recortar bordes">‚¨ö</button>
                            }
                        </div>
                        <div class="scanner-toolbar-right">
                            <button class="scanner-tool-btn" @onclick="ZoomOut" title="Alejar" disabled="@(previewZoom <= 25)">‚àí</button>
                            <span class="scanner-zoom-indicator">@(previewZoom == 0 ? "Auto" : $"{previewZoom}%")</span>
                            <button class="scanner-tool-btn" @onclick="ZoomIn" title="Acercar" disabled="@(previewZoom >= 200)">+</button>
                            <div class="scanner-tool-separator"></div>
                            <button class="scanner-tool-btn @(previewZoom == 0 ? "active" : "")" @onclick="@(() => SetZoom(0))" title="Ajustar autom√°ticamente">AJUSTAR</button>
                            <button class="scanner-tool-btn @(previewZoom == 100 ? "active" : "")" @onclick="@(() => SetZoom(100))" title="Tama√±o real">100%</button>
                            <div class="scanner-tool-separator"></div>
                            <button class="scanner-tool-btn scanner-fullscreen-btn" 
                                    @onclick="OpenFullscreenOverlay" 
                                    title="Ver en pantalla completa (doble clic en imagen)" 
                                    disabled="@(scannedPages.Count == 0 && previewImage == null)">AMPLIAR</button>
                        </div>
                    </div>
                    
                    @* √Årea de vista previa principal *@
                    <div class="scanner-preview-main @(previewZoom > 0 ? "scanner-preview-scrollable" : "")">
                        @if (isScanning)
                        {
                            <div class="scanner-progress-overlay">
                                <div class="scanner-progress-content">
                                    <div class="scanner-progress-spinner"></div>
                                    <div class="scanner-progress-text">@progressStatus</div>
                                    <div class="scanner-progress-bar">
                                        <div class="scanner-progress-fill" style="width: @(progressPercent * 100)%"></div>
                                    </div>
                                    <div class="scanner-progress-page">P√°gina @currentPage</div>
                                </div>
                            </div>
                        }
                        else if (isGeneratingPdf)
                        {
                            <div class="scanner-progress-overlay">
                                <div class="scanner-progress-content">
                                    <div class="scanner-progress-spinner"></div>
                                    <div class="scanner-progress-text">GENERANDO PDF...</div>
                                    <div class="scanner-progress-bar">
                                        <div class="scanner-progress-fill scanner-progress-indeterminate"></div>
                                    </div>
                                    <div class="scanner-progress-page">Combinando @scannedPages.Count p√°gina(s)</div>
                                </div>
                            </div>
                        }
                        else if (scannedPages.Count > 0)
                        {
                            <div class="scanner-image-wrapper" @ondblclick="OpenFullscreenOverlay" title="Doble clic para pantalla completa">
                                <img src="data:@scannedPages[previewIndex].MimeType;base64,@Convert.ToBase64String(scannedPages[previewIndex].ImageBytes)" 
                                     alt="P√°gina escaneada"
                                     class="scanner-main-image"
                                     style="@GetImageZoomStyle()" />
                            </div>
                        }
                        else if (isPreviewMode && previewImage != null)
                        {
                            <div class="scanner-preview-selection-area"
                                 @onmousedown="StartAreaSelectionAsync"
                                 @onmousemove="UpdateAreaSelectionAsync"
                                 @onmouseup="EndAreaSelectionAsync"
                                 @onmouseleave="EndAreaSelectionAsync">
                                <img src="data:@previewImage.MimeType;base64,@Convert.ToBase64String(previewImage.ImageBytes)" 
                                     alt="Vista previa" @ref="previewImageElement"
                                     class="scanner-main-image" />
                                
                                @if (selectedArea != null && !selectedArea.IsFullArea)
                                {
                                    <div class="scanner-selection-box"
                                         style="left: @(selectedArea.Left)%; top: @(selectedArea.Top)%; 
                                                width: @(selectedArea.Width)%; height: @(selectedArea.Height)%;">
                                        <div class="scanner-selection-info">
                                            @(selectedArea.Width.ToString("F0"))% √ó @(selectedArea.Height.ToString("F0"))%
                                        </div>
                                    </div>
                                }
                                @if (isSelectingArea)
                                {
                                    <div class="scanner-selection-box scanner-selection-active"
                                         style="left: @Math.Min(selectionStart.X, selectionCurrent.X)%; 
                                                top: @Math.Min(selectionStart.Y, selectionCurrent.Y)%; 
                                                width: @Math.Abs(selectionCurrent.X - selectionStart.X)%; 
                                                height: @Math.Abs(selectionCurrent.Y - selectionStart.Y)%;">
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="scanner-placeholder-large">
                                <div class="scanner-placeholder-icon">üìÑ</div>
                                <div class="scanner-placeholder-text">COLOQUE EL DOCUMENTO EN EL ESC√ÅNER</div>
                                <div class="scanner-placeholder-hint">
                                    @if (AllowMultiplePages)
                                    {
                                        <span>Presione "ESCANEAR" para digitalizar cada p√°gina</span>
                                    }
                                    else
                                    {
                                        <span>Use "Vista Previa" para seleccionar √°rea o "Escanear" directo</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    
                    @* Barra de estado inferior *@
                    <div class="scanner-preview-statusbar">
                        @if (scannedPages.Count > 0)
                        {
                            <span>@scannedPages[previewIndex].Width √ó @scannedPages[previewIndex].Height px</span>
                            <span class="scanner-status-separator">|</span>
                            <span>@FormatFileSize(scannedPages[previewIndex].ImageBytes.Length)</span>
                            <span class="scanner-status-separator">|</span>
                            <span>@scannedPages[previewIndex].ScannedAt.ToString("HH:mm:ss")</span>
                            <span class="scanner-status-separator">|</span>
                            <span class="scanner-status-hint">Doble clic o ‚õ∂ para pantalla completa</span>
                        }
                        else if (previewImage != null)
                        {
                            <span>Vista previa: @previewImage.Width √ó @previewImage.Height px (75 DPI)</span>
                        }
                        else
                        {
                            <span>Sin documento</span>
                        }
                    </div>
                </div>
                
                @* === PANEL DERECHO: CONFIGURACI√ìN Y MINIATURAS === *@
                <div class="scanner-config-panel">
                    @* Selector de esc√°ner *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">ESC√ÅNER</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field">
                                <select @bind="selectedDeviceId" class="scanner-select-full" disabled="@isScanning">
                                    @if (scanners.Count == 0)
                                    {
                                        <option value="">-- SIN ESC√ÅNERES --</option>
                                    }
                                    else
                                    {
                                        @foreach (var scanner in scanners)
                                        {
                                            <option value="@scanner.Id">@scanner.Name</option>
                                        }
                                    }
                                </select>
                                <button class="scanner-btn-icon" @onclick="RefreshScanners" disabled="@isScanning" title="Actualizar lista">‚Üª</button>
                            </div>
                        </div>
                    </div>
                    
                    @* Configuraci√≥n de entrada *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">CONFIGURACI√ìN DE ENTRADA</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field-row">
                                <label>Fuente:</label>
                                <select @bind="selectedSource" class="scanner-select" disabled="@isScanning">
                                    <option value="Flatbed">Documento (Placa)</option>
                                    <option value="Feeder">Alimentador</option>
                                    <option value="Auto">Autom√°tico</option>
                                </select>
                            </div>
                            <div class="scanner-field-row">
                                <label>Modo color:</label>
                                <select @bind="selectedColorMode" class="scanner-select" disabled="@isScanning">
                                    <option value="Color">Color</option>
                                    <option value="Grayscale">Escala de grises</option>
                                    <option value="BlackWhite">Blanco y negro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    @* Configuraci√≥n de salida *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">CONFIGURACI√ìN DE SALIDA</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field-row">
                                <label>Resoluci√≥n:</label>
                                <select @bind="selectedDpi" class="scanner-select" disabled="@isScanning">
                                    <option value="75">75 ppp</option>
                                    <option value="100">100 ppp</option>
                                    <option value="150">150 ppp</option>
                                    <option value="200">200 ppp</option>
                                    <option value="300">300 ppp</option>
                                    <option value="400">400 ppp</option>
                                    <option value="600">600 ppp</option>
                                </select>
                            </div>
                            @if (AllowMultiplePages)
                            {
                                <div class="scanner-field-row">
                                    <label>Formato:</label>
                                    <select @bind="outputFormat" class="scanner-select" disabled="@isScanning">
                                        <option value="images">Im√°genes separadas</option>
                                        <option value="pdf">PDF combinado</option>
                                        <option value="pdf-ocr">PDF buscable (OCR)</option>
                                    </select>
                                </div>
                                @if (outputFormat == "pdf-ocr")
                                {
                                    <div class="scanner-field-row">
                                        <label>Idioma OCR:</label>
                                        <select @bind="ocrLanguage" class="scanner-select" disabled="@isScanning">
                                            <option value="spa">Espa√±ol</option>
                                            <option value="eng">Ingl√©s</option>
                                            <option value="por">Portugu√©s</option>
                                        </select>
                                        @if (!ocrService.IsAvailable)
                                        {
                                            <span class="scanner-ocr-warning" title="OCR no instalado">‚ö†Ô∏è</span>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    
                    @* Configuraci√≥n de imagen *@
                    <div class="scanner-section scanner-section-collapsible">
                        <div class="scanner-section-header scanner-section-toggle" @onclick="ToggleCorrectionPanel">
                            <span>CONFIGURACI√ìN DE IMAGEN</span>
                            <span>@(showCorrectionPanel ? "‚ñº" : "‚ñ∂")</span>
                        </div>
                        @if (showCorrectionPanel)
                        {
                            <div class="scanner-section-body">
                                <div class="scanner-slider-field">
                                    <label>Ajuste imagen:</label>
                                    <select class="scanner-select" disabled="@isScanning">
                                        <option>Autom√°tico</option>
                                    </select>
                                </div>
                                <div class="scanner-slider-field">
                                    <label>Nitidez:</label>
                                    <select @bind="sharpnessMode" class="scanner-select" disabled="@isScanning">
                                        <option value="0">DESACTIVADO</option>
                                        <option value="1">ACTIVADO</option>
                                    </select>
                                </div>
                                <div class="scanner-slider-field">
                                    <label>Brillo:</label>
                                    <input type="range" min="-100" max="100" @bind="imageCorrection.Brightness" @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-val">@imageCorrection.Brightness</span>
                                </div>
                                <div class="scanner-slider-field">
                                    <label>Contraste:</label>
                                    <input type="range" min="-100" max="100" @bind="imageCorrection.Contrast" @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-val">@imageCorrection.Contrast</span>
                                </div>
                                <div class="scanner-slider-field">
                                    <label>Gamma:</label>
                                    <input type="range" min="10" max="300" @bind="gammaSliderValue" @bind:event="oninput" disabled="@isScanning" />
                                    <span class="scanner-slider-val">@imageCorrection.Gamma.ToString("F1")</span>
                                </div>
                                @if (scannedPages.Count > 0 && imageCorrection.HasCorrections)
                                {
                                    <div class="scanner-correction-btns">
                                        <button class="scanner-btn-sm" @onclick="ResetCorrections" disabled="@isScanning">Restablecer</button>
                                        <button class="scanner-btn-sm scanner-btn-apply" @onclick="ApplyCorrectionsToCurrentPage" disabled="@isScanning">Aplicar</button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    @* Perfiles guardados *@
                    <div class="scanner-section">
                        <div class="scanner-section-header">PERFIL</div>
                        <div class="scanner-section-body">
                            <div class="scanner-field">
                                <select @bind="selectedProfileId" class="scanner-select-full" disabled="@isScanning"
                                        @bind:after="LoadSelectedProfile">
                                    <option value="0">Definido por el usuario</option>
                                    @foreach (var profile in profiles)
                                    {
                                        <option value="@profile.Id">@profile.Name @(profile.IsDefault ? "‚òÖ" : "")</option>
                                    }
                                </select>
                                <button class="scanner-btn-icon" @onclick="OpenSaveProfileDialog" disabled="@isScanning" title="Guardar perfil">üíæ</button>
                            </div>
                        </div>
                    </div>
                    
                    @* Miniaturas (solo en modo batch) *@
                    @if (AllowMultiplePages && scannedPages.Count > 0)
                    {
                        <div class="scanner-section scanner-section-thumbnails">
                            <div class="scanner-section-header">P√ÅGINAS (@scannedPages.Count)</div>
                            <div class="scanner-thumbnails-grid">
                                @for (int i = 0; i < scannedPages.Count; i++)
                                {
                                    var index = i;
                                    <div class="scanner-thumb @(previewIndex == index ? "scanner-thumb-selected" : "")" 
                                         @onclick="() => SelectPage(index)">
                                        <span class="scanner-thumb-num">@(index + 1)</span>
                                        <img src="data:@scannedPages[index].MimeType;base64,@Convert.ToBase64String(scannedPages[index].ImageBytes)" alt="P√°g @(index + 1)" />
                                        <button class="scanner-thumb-del" @onclick="() => DeletePage(index)" @onclick:stopPropagation="true" title="Eliminar">√ó</button>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    @* Espacio flexible *@
                    <div class="scanner-section-spacer"></div>
                    
                    @* Mensajes *@
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="scanner-message scanner-error">@errorMessage</div>
                    }
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="scanner-message scanner-success">@successMessage</div>
                    }
                </div>
            </div>
            
            @* === FOOTER CON BOTONES DE ACCI√ìN === *@
            <div class="scanner-footer-actions">
                <div class="scanner-footer-left">
                    @if (scannedPages.Count > 0)
                    {
                        <button class="scanner-btn scanner-btn-secondary" @onclick="ClearPages" disabled="@(isScanning || isGeneratingPdf)">
                            Limpiar Todo
                        </button>
                        <span class="scanner-footer-info">@scannedPages.Count p√°g. | @FormatFileSize(scannedPages.Sum(p => p.ImageBytes.Length))</span>
                    }
                </div>
                <div class="scanner-footer-right">
                    @if (isScanning || isGeneratingPdf)
                    {
                        <button class="scanner-btn scanner-btn-danger" @onclick="CancelScan" disabled="@isGeneratingPdf">Cancelar</button>
                    }
                    else
                    {
                        @if (scannedPages.Count == 0 && !isPreviewMode)
                        {
                            <button class="scanner-btn" @onclick="StartPreviewScan" disabled="@(scanners.Count == 0)" title="Escaneo r√°pido de vista previa">
                                Vista Preliminar
                            </button>
                        }
                        @if (isPreviewMode)
                        {
                            <button class="scanner-btn" @onclick="ClearSelectedArea">√Årea Completa</button>
                            <button class="scanner-btn scanner-btn-secondary" @onclick="ExitPreviewMode">Cancelar</button>
                            <button class="scanner-btn scanner-btn-success" @onclick="ScanWithSelectedArea" disabled="@(scanners.Count == 0)">
                                Escanear @(selectedArea?.IsFullArea != false ? "" : "√Årea")
                            </button>
                        }
                        else
                        {
                            <button class="scanner-btn scanner-btn-primary" @onclick="StartScan" disabled="@(scanners.Count == 0)">
                                @if (AllowMultiplePages && scannedPages.Count > 0)
                                {
                                    <span>Escanear</span>
                                }
                                else
                                {
                                    <span>Escanear</span>
                                }
                            </button>
                        }
                        @if (scannedPages.Count > 0)
                        {
                            @if (AllowMultiplePages && outputFormat == "pdf")
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmAsPdf">Generar PDF</button>
                            }
                            else if (AllowMultiplePages && outputFormat == "pdf-ocr")
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmAsOcrPdf">PDF Buscable</button>
                            }
                            else
                            {
                                <button class="scanner-btn scanner-btn-success" @onclick="ConfirmScan">Aceptar</button>
                            }
                        }
                        <button class="scanner-btn" @onclick="Cerrar">Cerrar</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Modal para Guardar Perfil *@
@if (showSaveProfileDialog)
{
    <div class="scanner-backdrop" @onclick:stopPropagation="true">
        <div class="scanner-profile-dialog" @onclick:stopPropagation="true">
            <div class="scanner-header">
                <span>GUARDAR PERFIL</span>
                <button class="scanner-close" @onclick="CloseSaveProfileDialog">X</button>
            </div>
            <div class="scanner-profile-dialog-body">
                <div class="scanner-option-row">
                    <label class="scanner-label">NOMBRE:</label>
                    <input type="text" @bind="newProfileName" class="scanner-input" 
                           placeholder="Ej: Mi perfil de documentos" maxlength="50" />
                </div>
                <div class="scanner-option-row">
                    <label class="scanner-label">DESCRIPCION:</label>
                    <input type="text" @bind="newProfileDescription" class="scanner-input" 
                           placeholder="Descripci√≥n opcional" maxlength="200" />
                </div>
                <div class="scanner-option-row">
                    <label class="scanner-checkbox-label">
                        <input type="checkbox" @bind="newProfileIsDefault" />
                        <span>ESTABLECER COMO PREDETERMINADO</span>
                    </label>
                </div>
                <div class="scanner-profile-dialog-info">
                    <strong>CONFIGURACI√ìN A GUARDAR:</strong><br/>
                    DPI: @scanOptions.Dpi | Color: @scanOptions.ColorMode | Fuente: @scanOptions.Source<br/>
                    @if (imageCorrection.HasCorrections)
                    {
                        <span>Correcciones: Brillo=@imageCorrection.Brightness, Contraste=@imageCorrection.Contrast</span>
                    }
                </div>
            </div>
            <div class="scanner-footer">
                <button class="scanner-btn" @onclick="CloseSaveProfileDialog">CANCELAR</button>
                <button class="scanner-btn scanner-btn-success" @onclick="SaveCurrentProfile" 
                        disabled="@string.IsNullOrWhiteSpace(newProfileName)">
                    GUARDAR PERFIL
                </button>
            </div>
        </div>
    </div>
}

@* Popup de vista previa fullscreen *@
<ImagePreviewPopup @bind-IsVisible="showFullscreenPreview"
                   ImageDataUrl="@fullscreenImageUrl"
                   ImageInfo="@fullscreenImageInfo"
                   PageInfo="@fullscreenPageInfo"
                   CurrentIndex="@fullscreenCurrentIndex"
                   TotalPages="@fullscreenTotalPages"
                   OnNavigate="NavigateFullscreenPage" />

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Se dispara cuando el usuario confirma las p√°ginas escaneadas (modo im√°genes).
    /// Retorna la lista de p√°ginas escaneadas.
    /// </summary>
    [Parameter] public EventCallback<List<ScannedPageDto>> OnScanComplete { get; set; }
    
    /// <summary>
    /// Se dispara cuando el usuario genera un PDF combinado.
    /// Retorna los bytes del PDF.
    /// </summary>
    [Parameter] public EventCallback<byte[]> OnPdfGenerated { get; set; }
    
    /// <summary>
    /// Se dispara cuando se cancela el modal sin confirmar.
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }
    
    /// <summary>
    /// Permite escaneo de m√∫ltiples p√°ginas (batch).
    /// Si es false, solo escanea una p√°gina y cierra autom√°ticamente.
    /// </summary>
    [Parameter] public bool AllowMultiplePages { get; set; } = false;
    
    /// <summary>
    /// Texto personalizado para el t√≠tulo del modal.
    /// </summary>
    [Parameter] public string? Titulo { get; set; }

    // Estado interno
    private List<ScannerDeviceDto> scanners = new();
    private List<ScannedPageDto> scannedPages = new();
    private ScanOptionsDto scanOptions = new() { Dpi = 300 };
    private string? selectedDeviceId;
    private string outputFormat = "images"; // "images", "pdf" o "pdf-ocr"
    private string ocrLanguage = "spa"; // Idioma para OCR
    
    // Propiedades de binding para los selectores (sincronizadas con scanOptions)
    private int selectedDpi
    {
        get => scanOptions.Dpi;
        set
        {
            scanOptions.Dpi = value;
            Console.WriteLine($"[UI] DPI cambiado a: {value}");
        }
    }
    
    private string selectedColorMode
    {
        get => scanOptions.ColorMode.ToString();
        set
        {
            if (Enum.TryParse<ScanColorMode>(value, out var mode))
            {
                scanOptions.ColorMode = mode;
                Console.WriteLine($"[UI] ColorMode cambiado a: {mode}");
            }
        }
    }
    
    private string selectedSource
    {
        get => scanOptions.Source.ToString();
        set
        {
            if (Enum.TryParse<ScanSource>(value, out var source))
            {
                scanOptions.Source = source;
                Console.WriteLine($"[UI] Source cambiado a: {source}");
            }
        }
    }
    
    // Perfiles de escaneo
    private List<ScanProfileDto> profiles = new();
    private int selectedProfileId = 0;
    private bool showSaveProfileDialog = false;
    private string newProfileName = "";
    private string newProfileDescription = "";
    private bool newProfileIsDefault = false;
    
    // Vista previa y selecci√≥n de √°rea
    private bool isPreviewMode = false;
    private ScannedDocumentDto? previewImage = null;
    private ScanAreaDto? selectedArea = null;
    private bool isSelectingArea = false;
    private (double X, double Y) selectionStart = (0, 0);
    private (double X, double Y) selectionCurrent = (0, 0);
    private ElementReference previewImageElement;
    
    // Correcci√≥n de imagen
    private ImageCorrectionDto imageCorrection = new();
    private bool showCorrectionPanel = false;
    private bool isPreviewingCorrections = false;
    private byte[]? correctionPreviewBytes = null;
    
    // Gamma usa slider entero (10-300) mapeado a float (0.1-3.0)
    private int gammaSliderValue
    {
        get => (int)(imageCorrection.Gamma * 100);
        set => imageCorrection.Gamma = value / 100f;
    }
    
    // Nitidez como selector (0=off, 1=on)
    private int sharpnessMode
    {
        get => imageCorrection.Sharpness > 0 ? 1 : 0;
        set => imageCorrection.Sharpness = value == 1 ? 50 : 0;
    }
    
    // Control de zoom de vista previa (0 = ajustar, 50 = 50%, 100 = 100%)
    private int previewZoom = 0;
    
    // Popup de pantalla completa
    private bool isScanning = false;
    private bool isGeneratingPdf = false;
    private bool isLoadingScanners = false;
    private int previewIndex = 0;
    private int currentPage = 0;
    private double progressPercent = 0;
    private string progressStatus = "";
    
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && scanners.Count == 0 && !isLoadingScanners)
        {
            await RefreshScanners();
            
            // Inicializar perfiles predeterminados si no existen
            await ProfileRepository.InitializeDefaultProfilesAsync();
            await RefreshProfiles();
        }
    }

    protected override void OnInitialized()
    {
        ScannerService.ScanProgress += OnScanProgress;
    }

    private void OnScanProgress(object? sender, ScanProgressEventArgs e)
    {
        InvokeAsync(() =>
        {
            currentPage = e.CurrentPage;
            progressPercent = e.Progress;
            progressStatus = e.Status;
            
            if (e.HasError)
            {
                errorMessage = e.ErrorMessage;
            }
            
            StateHasChanged();
        });
    }

    private async Task RefreshScanners()
    {
        isLoadingScanners = true;
        errorMessage = null;
        
        try
        {
            var result = await ScannerService.GetAvailableScannersAsync();
            if (result.IsSuccess && result.Value != null)
            {
                scanners = result.Value;
                if (scanners.Count > 0 && string.IsNullOrEmpty(selectedDeviceId))
                {
                    selectedDeviceId = scanners[0].Id;
                }
                
                if (scanners.Count == 0)
                {
                    errorMessage = "No se encontraron esc√°neres. Verifique que el esc√°ner est√© conectado y encendido.";
                }
            }
            else
            {
                errorMessage = result.Error ?? "Error al buscar esc√°neres";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingScanners = false;
            StateHasChanged();
        }
    }

    private async Task StartScan()
    {
        if (isScanning) return;
        
        isScanning = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            // Preparar opciones para el escaneo
            scanOptions.DeviceId = selectedDeviceId;
            
            // Log para debug de las opciones
            Console.WriteLine($"[SCAN-UI] ========== INICIANDO ESCANEO ==========");
            Console.WriteLine($"[SCAN-UI] DeviceId: {scanOptions.DeviceId}");
            Console.WriteLine($"[SCAN-UI] DPI: {scanOptions.Dpi}");
            Console.WriteLine($"[SCAN-UI] ColorMode: {scanOptions.ColorMode}");
            Console.WriteLine($"[SCAN-UI] Source: {scanOptions.Source}");
            Console.WriteLine($"[SCAN-UI] PageSize: {scanOptions.PageSize}");
            Console.WriteLine($"[SCAN-UI] =========================================");
            
            // Escanear una p√°gina
            var result = await ScannerService.ScanSinglePageAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                var doc = result.Value;
                
                // Aplicar correcciones de imagen si hay alguna configurada
                byte[] finalBytes = doc.ImageBytes;
                if (imageCorrection.HasCorrections)
                {
                    Console.WriteLine($"[SCAN-UI] Aplicando correcciones: Brillo={imageCorrection.Brightness}, Contraste={imageCorrection.Contrast}");
                    finalBytes = ImageProcessor.ApplyCorrections(doc.ImageBytes, imageCorrection);
                }
                
                scannedPages.Add(new ScannedPageDto
                {
                    ImageBytes = finalBytes,
                    MimeType = doc.MimeType,
                    Width = doc.Width,
                    Height = doc.Height,
                    Dpi = doc.Dpi,
                    ScannedAt = doc.ScannedAt,
                    PageNumber = scannedPages.Count + 1
                });
                previewIndex = scannedPages.Count - 1;
                
                if (AllowMultiplePages)
                {
                    successMessage = $"P√°gina {scannedPages.Count} escaneada. Puede continuar escaneando m√°s p√°ginas.";
                }
                else
                {
                    successMessage = "P√°gina escaneada correctamente";
                }
            }
            else
            {
                errorMessage = result.Error ?? "Error al escanear";
            }
        }
        catch (OperationCanceledException)
        {
            successMessage = "Escaneo cancelado";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"[SCAN-UI] ERROR: {ex}");
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    private void CancelScan()
    {
        ScannerService.CancelCurrentScan();
    }

    private async Task ConfirmScan()
    {
        if (scannedPages.Count == 0) return;
        
        // Renumerar p√°ginas
        for (int i = 0; i < scannedPages.Count; i++)
        {
            scannedPages[i].PageNumber = i + 1;
        }
        
        await OnScanComplete.InvokeAsync(new List<ScannedPageDto>(scannedPages));
        await Cerrar();
    }

    private async Task ConfirmAsPdf()
    {
        if (scannedPages.Count == 0) return;
        
        isGeneratingPdf = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Generar PDF combinando todas las p√°ginas
            var pdfBytes = await GeneratePdfFromPagesAsync();
            
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                await OnPdfGenerated.InvokeAsync(pdfBytes);
                await Cerrar();
            }
            else
            {
                errorMessage = "Error al generar el PDF";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generando PDF: {ex.Message}";
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmAsOcrPdf()
    {
        if (scannedPages.Count == 0) return;
        
        isGeneratingPdf = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Generar PDF con OCR usando el servicio dedicado
            var result = await ocrService.GenerateSearchablePdfAsync(scannedPages, ocrLanguage);
            
            if (result.IsSuccess && result.Value != null)
            {
                if (!ocrService.IsAvailable)
                {
                    successMessage = "PDF generado (sin OCR - funci√≥n no habilitada)";
                }
                await OnPdfGenerated.InvokeAsync(result.Value);
                await Cerrar();
            }
            else
            {
                errorMessage = result.Error ?? "Error al generar el PDF buscable";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generando PDF con OCR: {ex.Message}";
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task<byte[]?> GeneratePdfFromPagesAsync()
    {
        // Usar QuestPDF para generar el PDF
        return await Task.Run(() =>
        {
            try
            {
                using var ms = new MemoryStream();
                
                QuestPDF.Fluent.Document.Create(container =>
                {
                    foreach (var page in scannedPages)
                    {
                        container.Page(pageDescriptor =>
                        {
                            pageDescriptor.Size(QuestPDF.Helpers.PageSizes.Letter);
                            pageDescriptor.Margin(0);
                            
                            pageDescriptor.Content().Image(page.ImageBytes)
                                .FitArea();
                        });
                    }
                }).GeneratePdf(ms);
                
                return ms.ToArray();
            }
            catch
            {
                return null;
            }
        });
    }

    private void SelectPage(int index)
    {
        if (index >= 0 && index < scannedPages.Count)
        {
            previewIndex = index;
        }
    }

    private void DeletePage(int index)
    {
        if (index >= 0 && index < scannedPages.Count)
        {
            scannedPages.RemoveAt(index);
            
            // Renumerar p√°ginas
            for (int i = 0; i < scannedPages.Count; i++)
            {
                scannedPages[i].PageNumber = i + 1;
            }
            
            // Ajustar preview index
            if (previewIndex >= scannedPages.Count)
            {
                previewIndex = Math.Max(0, scannedPages.Count - 1);
            }
            
            successMessage = $"P√°gina eliminada. Quedan {scannedPages.Count} p√°gina(s).";
        }
    }

    private void ClearPages()
    {
        scannedPages.Clear();
        previewIndex = 0;
        successMessage = null;
        errorMessage = null;
    }

    private void PreviousPage()
    {
        if (previewIndex > 0) previewIndex--;
    }

    private void NextPage()
    {
        if (previewIndex < scannedPages.Count - 1) previewIndex++;
    }

    private async Task OnBackdropClick()
    {
        if (!isScanning && !isGeneratingPdf)
        {
            await Cerrar();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (isScanning || isGeneratingPdf) return;
        
        switch (e.Key)
        {
            case "Escape":
                await Cerrar();
                break;
            case "F5":
                await StartScan();
                break;
            case "ArrowLeft":
                PreviousPage();
                break;
            case "ArrowRight":
                NextPage();
                break;
            case "Delete":
                if (scannedPages.Count > 0)
                {
                    DeletePage(previewIndex);
                }
                break;
        }
    }

    private async Task Cerrar()
    {
        if (isScanning || isGeneratingPdf) return;
        
        scannedPages.Clear();
        previewIndex = 0;
        errorMessage = null;
        successMessage = null;
        outputFormat = "images";
        
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        await OnCancel.InvokeAsync();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }

    #region Correcci√≥n y Transformaci√≥n de Imagen
    
    private void ToggleCorrectionPanel() => showCorrectionPanel = !showCorrectionPanel;

    private void ResetCorrections()
    {
        imageCorrection = new ImageCorrectionDto();
        correctionPreviewBytes = null;
        isPreviewingCorrections = false;
    }
    
    /// <summary>
    /// Genera una vista previa de las correcciones sin aplicarlas permanentemente
    /// </summary>
    private async Task PreviewCorrections()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        if (!imageCorrection.HasCorrections) return;
        
        isPreviewingCorrections = true;
        StateHasChanged();
        
        try
        {
            var page = scannedPages[previewIndex];
            
            // Procesar en un task para no bloquear UI
            correctionPreviewBytes = await Task.Run(() => 
                ImageProcessor.ApplyCorrections(page.ImageBytes, imageCorrection));
            
            // Mostrar temporalmente la vista previa
            var originalBytes = page.ImageBytes;
            page.ImageBytes = correctionPreviewBytes;
            StateHasChanged();
            
            // Esperar 2 segundos y restaurar original
            await Task.Delay(2000);
            page.ImageBytes = originalBytes;
            correctionPreviewBytes = null;
            
            successMessage = "Vista previa terminada. Presione APLICAR para confirmar.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generando vista previa: {ex.Message}";
        }
        finally
        {
            isPreviewingCorrections = false;
            StateHasChanged();
        }
    }
    
    private void ApplyCorrectionsToCurrentPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        if (!imageCorrection.HasCorrections) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.ApplyCorrections(page.ImageBytes, imageCorrection);
        
        // Actualizar dimensiones en caso de que hayan cambiado
        UpdatePageDimensions(page);
        
        successMessage = "Correcciones aplicadas a la p√°gina";
        ResetCorrections();
        StateHasChanged();
    }
    
    private async Task RotatePage(int degrees)
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        byte[] rotated = degrees switch
        {
            90 => ImageProcessor.RotateClockwise(page.ImageBytes),
            -90 => ImageProcessor.RotateCounterClockwise(page.ImageBytes),
            180 => ImageProcessor.Rotate180(page.ImageBytes),
            _ => page.ImageBytes
        };
        
        page.ImageBytes = rotated;
        UpdatePageDimensions(page);
        
        successMessage = $"Imagen rotada {Math.Abs(degrees)}¬∞";
        await InvokeAsync(StateHasChanged);
    }

    private async Task FlipHorizontalPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.FlipHorizontal(page.ImageBytes);
        
        successMessage = "Imagen volteada horizontalmente";
        await InvokeAsync(StateHasChanged);
    }

    private async Task FlipVerticalPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        page.ImageBytes = ImageProcessor.FlipVertical(page.ImageBytes);
        
        successMessage = "Imagen volteada verticalmente";
        await InvokeAsync(StateHasChanged);
    }

    private async Task AutoCropPage()
    {
        if (previewIndex < 0 || previewIndex >= scannedPages.Count) return;
        
        var page = scannedPages[previewIndex];
        var cropped = ImageProcessor.AutoCrop(page.ImageBytes);
        
        page.ImageBytes = cropped;
        UpdatePageDimensions(page);
        
        successMessage = "Imagen recortada autom√°ticamente";
        await InvokeAsync(StateHasChanged);
    }
    
    private void UpdatePageDimensions(ScannedPageDto page)
    {
        try
        {
            using var ms = new MemoryStream(page.ImageBytes);
            using var img = Image.FromStream(ms);
            page.Width = img.Width;
            page.Height = img.Height;
        }
        catch
        {
            // Si falla, mantener dimensiones anteriores
        }
    }
    
    /// <summary>
    /// Determina si la imagen es vertical (portrait) u horizontal (landscape)
    /// </summary>
    private bool IsPortrait(ScannedPageDto page) => page.Height > page.Width;
    
    /// <summary>
    /// Establece el nivel de zoom de la vista previa
    /// </summary>
    private void SetZoom(int zoom)
    {
        previewZoom = zoom;
        StateHasChanged();
    }
    
    /// <summary>
    /// Aumenta el zoom de la vista previa
    /// </summary>
    private void ZoomIn()
    {
        if (previewZoom == 0) previewZoom = 50;
        else if (previewZoom < 200) previewZoom += 25;
        StateHasChanged();
    }
    
    /// <summary>
    /// Reduce el zoom de la vista previa
    /// </summary>
    private void ZoomOut()
    {
        if (previewZoom > 25) previewZoom -= 25;
        else previewZoom = 0; // Volver a ajuste autom√°tico
        StateHasChanged();
    }
    
    /// <summary>
    /// Genera el estilo CSS para aplicar zoom a la imagen
    /// </summary>
    private string GetImageZoomStyle()
    {
        if (previewZoom == 0)
        {
            // Auto-ajuste: la imagen se adapta al contenedor
            return "max-width: 100%; max-height: 100%; width: auto; height: auto;";
        }
        else
        {
            // Zoom espec√≠fico: aplicar escala
            return $"max-width: none; max-height: none; width: {previewZoom}%; height: auto;";
        }
    }
    
    #endregion
    
    #region Popup Pantalla Completa (Overlay)
    
    // Variables para el popup de vista previa fullscreen
    private bool showFullscreenPreview = false;
    private string? fullscreenImageUrl = null;
    private string? fullscreenImageInfo = null;
    private string? fullscreenPageInfo = null;
    private int fullscreenCurrentIndex = 0;
    private int fullscreenTotalPages = 1;
    
    /// <summary>
    /// Abre el overlay de vista previa a pantalla completa
    /// </summary>
    private void OpenFullscreenOverlay()
    {
        if (scannedPages.Count == 0 && previewImage == null)
        {
            Console.WriteLine("[FULLSCREEN] No hay im√°genes para mostrar");
            return;
        }
        
        Console.WriteLine("[FULLSCREEN] Abriendo overlay de vista previa...");
        
        if (scannedPages.Count > 0)
        {
            fullscreenCurrentIndex = previewIndex;
            fullscreenTotalPages = scannedPages.Count;
            UpdateFullscreenImage();
        }
        else if (previewImage != null)
        {
            fullscreenCurrentIndex = 0;
            fullscreenTotalPages = 1;
            fullscreenImageUrl = $"data:{previewImage.MimeType};base64,{Convert.ToBase64String(previewImage.ImageBytes)}";
            fullscreenImageInfo = $"{previewImage.Width} √ó {previewImage.Height} px";
            fullscreenPageInfo = "Vista previa";
        }
        
        showFullscreenPreview = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// Actualiza la imagen mostrada en el popup seg√∫n el √≠ndice actual
    /// </summary>
    private void UpdateFullscreenImage()
    {
        if (scannedPages.Count > 0 && fullscreenCurrentIndex >= 0 && fullscreenCurrentIndex < scannedPages.Count)
        {
            var page = scannedPages[fullscreenCurrentIndex];
            fullscreenImageUrl = $"data:{page.MimeType};base64,{Convert.ToBase64String(page.ImageBytes)}";
            fullscreenImageInfo = $"{page.Width} √ó {page.Height} px";
            fullscreenPageInfo = $"P√°gina {fullscreenCurrentIndex + 1} de {fullscreenTotalPages}";
        }
    }
    
    /// <summary>
    /// Navega a una p√°gina espec√≠fica en el popup
    /// </summary>
    private void NavigateFullscreenPage(int newIndex)
    {
        if (newIndex >= 0 && newIndex < fullscreenTotalPages)
        {
            fullscreenCurrentIndex = newIndex;
            UpdateFullscreenImage();
            StateHasChanged();
        }
    }
    
    #endregion

    #region Vista Previa y Selecci√≥n de √Årea
    
    private async Task StartPreviewScan()
    {
        if (isScanning) return;
        
        isScanning = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            scanOptions.DeviceId = selectedDeviceId;
            
            var result = await ScannerService.PreviewScanAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                previewImage = result.Value;
                isPreviewMode = true;
                selectedArea = null;
                successMessage = "Vista previa obtenida. Seleccione el √°rea a escanear o presione ESCANEAR para √°rea completa.";
            }
            else
            {
                errorMessage = result.Error ?? "Error al obtener vista previa";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }
    
    private void ExitPreviewMode()
    {
        isPreviewMode = false;
        previewImage = null;
        selectedArea = null;
        isSelectingArea = false;
    }
    
    private async Task ScanWithSelectedArea()
    {
        if (isScanning) return;
        
        isScanning = true;
        isPreviewMode = false;
        errorMessage = null;
        
        try
        {
            scanOptions.DeviceId = selectedDeviceId;
            
            var result = await ScannerService.ScanSinglePageAsync(scanOptions);
            if (result.IsSuccess && result.Value != null)
            {
                var doc = result.Value;
                byte[] finalBytes = doc.ImageBytes;
                int width = doc.Width;
                int height = doc.Height;
                
                // Si hay √°rea seleccionada, recortar
                if (selectedArea != null && !selectedArea.IsFullArea)
                {
                    finalBytes = ImageProcessor.CropToArea(finalBytes, selectedArea);
                    
                    using var ms = new MemoryStream(finalBytes);
                    using var img = Image.FromStream(ms);
                    width = img.Width;
                    height = img.Height;
                }
                
                scannedPages.Add(new ScannedPageDto
                {
                    ImageBytes = finalBytes,
                    MimeType = doc.MimeType,
                    Width = width,
                    Height = height,
                    Dpi = doc.Dpi,
                    ScannedAt = doc.ScannedAt,
                    PageNumber = scannedPages.Count + 1
                });
                previewIndex = scannedPages.Count - 1;
                
                successMessage = selectedArea?.IsFullArea == false 
                    ? "√Årea seleccionada escaneada y recortada correctamente"
                    : "P√°gina escaneada correctamente";
            }
            else
            {
                errorMessage = result.Error ?? "Error al escanear";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            previewImage = null;
            selectedArea = null;
            StateHasChanged();
        }
    }
    
    private async Task StartAreaSelectionAsync(MouseEventArgs e)
    {
        try
        {
            var pos = await JS.InvokeAsync<PositionResult?>("getMousePercentInContainer", e);
            if (pos != null)
            {
                isSelectingArea = true;
                selectionStart = (pos.x, pos.y);
                selectionCurrent = selectionStart;
                StateHasChanged();
            }
        }
        catch
        {
            // Fallback: usar posici√≥n aproximada
            isSelectingArea = true;
            selectionStart = (e.OffsetX / 4, e.OffsetY / 3);
            selectionCurrent = selectionStart;
        }
    }
    
    private async Task UpdateAreaSelectionAsync(MouseEventArgs e)
    {
        if (!isSelectingArea) return;
        
        try
        {
            var pos = await JS.InvokeAsync<PositionResult?>("getMousePercentInContainer", e);
            if (pos != null)
            {
                selectionCurrent = (pos.x, pos.y);
                StateHasChanged();
            }
        }
        catch
        {
            // Fallback
            selectionCurrent = (e.OffsetX / 4, e.OffsetY / 3);
            StateHasChanged();
        }
    }
    
    private async Task EndAreaSelectionAsync(MouseEventArgs e)
    {
        if (!isSelectingArea) return;
        isSelectingArea = false;
        
        try
        {
            var pos = await JS.InvokeAsync<PositionResult?>("getMousePercentInContainer", e);
            if (pos != null)
            {
                selectionCurrent = (pos.x, pos.y);
            }
        }
        catch { }
        
        double left = Math.Min(selectionStart.X, selectionCurrent.X);
        double top = Math.Min(selectionStart.Y, selectionCurrent.Y);
        double width = Math.Abs(selectionCurrent.X - selectionStart.X);
        double height = Math.Abs(selectionCurrent.Y - selectionStart.Y);
        
        // Solo crear √°rea si es significativa (m√°s de 5%)
        if (width > 5 && height > 5)
        {
            selectedArea = new ScanAreaDto
            {
                Left = Math.Max(0, Math.Min(100, left)),
                Top = Math.Max(0, Math.Min(100, top)),
                Width = Math.Min(100 - left, width),
                Height = Math.Min(100 - top, height)
            };
        }
        
        StateHasChanged();
    }
    
    // Clase para deserializar resultado de JS (propiedades en min√∫sculas para match con JSON)
    private class PositionResult
    {
        public double x { get; set; }
        public double y { get; set; }
    }
    
    private void ClearSelectedArea()
    {
        selectedArea = null;
        StateHasChanged();
    }
    
    #endregion

    #region Perfiles de Escaneo
    
    private async Task RefreshProfiles()
    {
        try
        {
            Console.WriteLine("[PROFILES] Cargando perfiles de escaneo...");
            profiles = await ProfileRepository.GetAllAsync();
            
            Console.WriteLine($"[PROFILES] Se encontraron {profiles.Count} perfiles:");
            foreach (var p in profiles)
            {
                Console.WriteLine($"[PROFILES]   - ID:{p.Id} '{p.Name}' ColorMode:{p.ColorMode} Dpi:{p.Dpi} Default:{p.IsDefault}");
            }
            
            // Cargar perfil por defecto si existe
            var defaultProfile = profiles.FirstOrDefault(p => p.IsDefault);
            if (defaultProfile != null && selectedProfileId == 0)
            {
                Console.WriteLine($"[PROFILES] Aplicando perfil predeterminado: {defaultProfile.Name}");
                selectedProfileId = defaultProfile.Id;
                await LoadSelectedProfile();
            }
        }
        catch (Exception ex)
        {
            // Ignorar errores de carga de perfiles (la tabla puede no existir a√∫n)
            Console.WriteLine($"[PROFILES] ERROR al cargar perfiles: {ex.Message}");
            profiles = new List<ScanProfileDto>();
        }
    }
    
    private async Task LoadSelectedProfile()
    {
        Console.WriteLine($"[PROFILE] LoadSelectedProfile llamado con selectedProfileId={selectedProfileId}");
        
        if (selectedProfileId == 0)
        {
            // Modo manual - no cambiar configuraci√≥n
            Console.WriteLine("[PROFILE] selectedProfileId es 0, no se carga perfil");
            return;
        }
        
        var profile = profiles.FirstOrDefault(p => p.Id == selectedProfileId);
        if (profile != null)
        {
            Console.WriteLine($"[PROFILE] Cargando perfil: {profile.Name}");
            Console.WriteLine($"[PROFILE]   - Dpi: {profile.Dpi}");
            Console.WriteLine($"[PROFILE]   - ColorMode: {profile.ColorMode}");
            Console.WriteLine($"[PROFILE]   - Source: {profile.Source}");
            Console.WriteLine($"[PROFILE]   - PageSize: {profile.PageSize}");
            
            // Aplicar configuraci√≥n del perfil
            scanOptions.Dpi = profile.Dpi;
            scanOptions.ColorMode = profile.ColorMode;
            scanOptions.Source = profile.Source;
            scanOptions.PageSize = profile.PageSize;
            
            Console.WriteLine($"[PROFILE] Despu√©s de aplicar: scanOptions.ColorMode = {scanOptions.ColorMode}");
            
            // Aplicar correcciones
            imageCorrection = profile.ToImageCorrection();
            
            // Actualizar fecha de √∫ltimo uso
            await ProfileRepository.UpdateLastUsedAsync(profile.Id);
            
            successMessage = $"Perfil \"{profile.Name}\" cargado";
            StateHasChanged();
        }
    }
    
    private void OpenSaveProfileDialog()
    {
        newProfileName = "";
        newProfileDescription = "";
        newProfileIsDefault = false;
        showSaveProfileDialog = true;
    }
    
    private void CloseSaveProfileDialog()
    {
        showSaveProfileDialog = false;
    }
    
    private async Task SaveCurrentProfile()
    {
        if (string.IsNullOrWhiteSpace(newProfileName)) return;
        
        try
        {
            var profile = new ScanProfileDto
            {
                Name = newProfileName.Trim(),
                Description = string.IsNullOrWhiteSpace(newProfileDescription) ? null : newProfileDescription.Trim(),
                IsDefault = newProfileIsDefault,
                Dpi = scanOptions.Dpi,
                ColorMode = scanOptions.ColorMode,
                Source = scanOptions.Source,
                PageSize = scanOptions.PageSize,
                Brightness = imageCorrection.Brightness,
                Contrast = imageCorrection.Contrast,
                Gamma = imageCorrection.Gamma,
                Sharpness = imageCorrection.Sharpness,
                BlackWhiteThreshold = imageCorrection.BlackWhiteThreshold
            };
            
            if (newProfileIsDefault)
            {
                await ProfileRepository.SetDefaultAsync(0); // Quitar default de todos primero
            }
            
            var saved = await ProfileRepository.SaveAsync(profile);
            
            // Recargar perfiles y seleccionar el nuevo
            await RefreshProfiles();
            selectedProfileId = saved.Id;
            
            successMessage = $"Perfil \"{saved.Name}\" guardado correctamente";
            CloseSaveProfileDialog();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error guardando perfil: {ex.Message}";
        }
    }
    
    #endregion

    public void Dispose()
    {
        ScannerService.ScanProgress -= OnScanProgress;
    }
}
