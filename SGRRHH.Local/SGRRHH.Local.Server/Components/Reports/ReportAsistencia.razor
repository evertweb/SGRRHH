@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Infrastructure.Services
@inject IRegistroDiarioRepository RegistroDiarioRepository
@inject IEmpleadoRepository EmpleadoRepository
@inject IReportService ReportService
@inject IJSRuntime JSRuntime
@inject ILogger<ReportAsistencia> Logger

<div class="panel">
    <div class="panel-header">FILTROS - REPORTE DE ASISTENCIA</div>
    <div class="panel-body">
        <div class="grid-4">
            <div class="form-group required">
                <label>FECHA INICIO</label>
                <input type="date" @bind="filtroFechaInicioAsistencia" class="form-input" />
            </div>
            <div class="form-group required">
                <label>FECHA FIN</label>
                <input type="date" @bind="filtroFechaFinAsistencia" class="form-input" />
            </div>
            <div class="form-group">
                <label>EMPLEADO</label>
                <select @bind="filtroEmpleadoAsistenciaId" class="form-input">
                    <option value="">Todos</option>
                    @if (Empleados != null)
                    {
                        @foreach (var emp in Empleados)
                        {
                            <option value="@emp.Id">@emp.NombreCompleto</option>
                        }
                    }
                </select>
            </div>
            <div class="form-group">
                <label>DEPARTAMENTO</label>
                <select @bind="filtroDepartamentoAsistencia" class="form-input">
                    <option value="">Todos</option>
                    @if (Departamentos != null)
                    {
                        @foreach (var dept in Departamentos)
                        {
                            <option value="@dept.Id">@dept.Nombre</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn-primary" @onclick="GenerarReporte" disabled="@(isGenerating || !ValidarFechas())">
                    @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                </button>
                <button @onclick="VistaPrevia" disabled="@(isGenerating || !ValidarFechas())">
                    VISTA PREVIA
                </button>
                <button class="btn-success" @onclick="ExportarExcel" disabled="@(isGenerating || !ValidarFechas())">
                    EXPORTAR A EXCEL
                </button>
            </div>
        </div>
        @if (!ValidarFechas())
        {
            <div class="validation-message" style="color: var(--color-error); font-size: 11px; margin-top: 5px;">
                * Debe seleccionar un rango de fechas válido
            </div>
        }
    </div>
</div>

@if (errorMessage != null)
{
    <div class="error-block">
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

@if (successMessage != null)
{
    <div class="success-block">
        <p>@successMessage</p>
    </div>
}

@if (mostrarVistaPrevia)
{
    <div class="panel">
        <div class="panel-header">
            VISTA PREVIA DEL REPORTE
            <button @onclick="CerrarVistaPrevia">CERRAR</button>
        </div>
        <div class="panel-body">
            @if (asistenciaReporte != null && asistenciaReporte.Any())
            {
               <!-- Simplificado para vista previa rápida, se puede expandir si se necesita mostrar la tabla compleja -->
               <div style="padding: 20px; text-align: center;">
                   <h3>Resumen de Asistencia</h3>
                   <p>Mostrando registros del @filtroFechaInicioAsistencia?.ToString("dd/MM/yyyy") al @filtroFechaFinAsistencia?.ToString("dd/MM/yyyy")</p>
                   
                   <div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; margin: 20px auto;">
                        <div class="stats-card" style="border: 1px solid var(--color-border); padding: 15px;">
                            <h3>Días Consultados</h3>
                            <div class="value" style="font-size: 18px; font-weight: bold;">@asistenciaReporte.Count</div>
                        </div>
                   </div>
               </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="message">No se encontraron registros de asistencia con los filtros seleccionados</div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public List<Empleado> Empleados { get; set; } = new();
    [Parameter] public List<Departamento> Departamentos { get; set; } = new();

    private bool isGenerating = false;
    private bool mostrarVistaPrevia = false;
    private string? errorMessage;
    private string? successMessage;

    // Filtros
    private DateTime? filtroFechaInicioAsistencia = DateTime.Now.AddMonths(-1);
    private DateTime? filtroFechaFinAsistencia = DateTime.Now;
    private string? filtroEmpleadoAsistenciaId = "";
    private string? filtroDepartamentoAsistencia = "";

    private Dictionary<DateTime, List<AsistenciaDetalle>> asistenciaReporte = new();

    private bool ValidarFechas()
    {
        return filtroFechaInicioAsistencia.HasValue && 
               filtroFechaFinAsistencia.HasValue && 
               filtroFechaInicioAsistencia.Value <= filtroFechaFinAsistencia.Value;
    }

    private async Task GenerarReporte()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            if (!ValidarFechas())
            {
                errorMessage = "Debe seleccionar un rango de fechas válido";
                return;
            }

            await CargarDatos();

            if (asistenciaReporte.Count == 0)
            {
                errorMessage = "No se encontraron registros de asistencia con los filtros seleccionados";
                return;
            }

            // TODO: Generar PDF usando ReportService
            // Por ahora simulamos
            await Task.Delay(500); 

            var totalPresentes = asistenciaReporte.Sum(a => a.Value.Count(r => r.Presente));
            var totalAusentes = asistenciaReporte.Sum(a => a.Value.Count(r => !r.Presente));
            
            successMessage = $"Reporte generado exitosamente. Presentes: {totalPresentes}, Ausentes: {totalAusentes}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de asistencia");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPrevia()
    {
        try
        {
            errorMessage = null;
            
            if (!ValidarFechas())
            {
                errorMessage = "Debe seleccionar un rango de fechas válido";
                return;
            }

            await CargarDatos();
             mostrarVistaPrevia = true;
            
            successMessage = $"Vista previa cargada: {asistenciaReporte.Count} días de registro";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de asistencia");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private async Task CargarDatos()
    {
        if (!filtroFechaInicioAsistencia.HasValue || !filtroFechaFinAsistencia.HasValue)
        {
            asistenciaReporte = new Dictionary<DateTime, List<AsistenciaDetalle>>();
            return;
        }

        // Obtener todos los registros diarios en el rango
        var registrosDiarios = (await RegistroDiarioRepository.GetAllAsync())
            .Where(rd => rd.Fecha >= filtroFechaInicioAsistencia.Value && rd.Fecha <= filtroFechaFinAsistencia.Value)
            .OrderBy(rd => rd.Fecha)
            .ToList();

        // Filtrar por empleado si está especificado
        if (!string.IsNullOrEmpty(filtroEmpleadoAsistenciaId) && int.TryParse(filtroEmpleadoAsistenciaId, out var empId))
        {
            var empleado = await EmpleadoRepository.GetByIdAsync(empId);
            if (empleado != null)
            {
                // Crear reporte para un solo empleado
                asistenciaReporte = registrosDiarios
                    .GroupBy(rd => rd.Fecha)
                    .ToDictionary(
                        g => g.Key,
                        g => new List<AsistenciaDetalle>
                        {
                            new AsistenciaDetalle
                            {
                                Empleado = empleado,
                                Presente = g.Any(rd => rd.EmpleadoId == empId),
                                Observaciones = g.FirstOrDefault(rd => rd.EmpleadoId == empId)?.Observaciones ?? ""
                            }
                        }
                    );
            }
        }
        else
        {
            // Reporte general - todos los empleados
            var empleadosActivos = (await EmpleadoRepository.GetAllAsync())
                .Where(e => e.Estado == EstadoEmpleado.Activo)
                .ToList();

            // Filtrar por departamento si está especificado
            if (!string.IsNullOrEmpty(filtroDepartamentoAsistencia) && int.TryParse(filtroDepartamentoAsistencia, out var deptId))
            {
                empleadosActivos = empleadosActivos.Where(e => e.DepartamentoId == deptId).ToList();
            }

            asistenciaReporte = new Dictionary<DateTime, List<AsistenciaDetalle>>();

            // Generar reporte día por día
            for (var fecha = filtroFechaInicioAsistencia.Value; fecha <= filtroFechaFinAsistencia.Value; fecha = fecha.AddDays(1))
            {
                var registrosDelDia = registrosDiarios.Where(rd => rd.Fecha.Date == fecha.Date).ToList();
                
                var detalles = empleadosActivos.Select(emp => new AsistenciaDetalle
                {
                    Empleado = emp,
                    Presente = registrosDelDia.Any(rd => rd.EmpleadoId == emp.Id),
                    Observaciones = registrosDelDia.FirstOrDefault(rd => rd.EmpleadoId == emp.Id)?.Observaciones ?? ""
                }).ToList();

                asistenciaReporte[fecha] = detalles;
            }
        }
    }

    private async Task ExportarExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            if (!ValidarFechas())
            {
                errorMessage = "Debe seleccionar un rango de fechas válido";
                return;
            }

            await CargarDatos();

            if (asistenciaReporte.Count == 0)
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // TODO: Implementar exportación a Excel real
            await Task.Delay(500); 

            successMessage = $"Datos exportados a Excel exitosamente. Total: {asistenciaReporte.Count} días";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar asistencia a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }
    
    private void CerrarVistaPrevia()
    {
        mostrarVistaPrevia = false;
    }

    private class AsistenciaDetalle
    {
        public Empleado Empleado { get; set; } = null!;
        public bool Presente { get; set; }
        public string Observaciones { get; set; } = "";
    }
    
    // Función para descargar archivos (si se implementara la exportación real)
    private async Task DescargarArchivo(byte[] fileBytes, string fileName, string mimeType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, mimeType, base64);
    }
}
