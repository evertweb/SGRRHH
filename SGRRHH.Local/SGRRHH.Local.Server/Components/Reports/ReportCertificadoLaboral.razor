@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Shared.Interfaces
@inject IReportService ReportService
@inject IJSRuntime JSRuntime
@inject ILogger<ReportCertificadoLaboral> Logger

<div class="panel">
    <div class="panel-header">FILTROS - CERTIFICADO LABORAL</div>
    <div class="panel-body">
        <div class="grid-4">
            <div class="form-group required">
                <label>EMPLEADO</label>
                <select @bind="filtroEmpleadoCertificadoId" class="form-input">
                    <option value="">Seleccione...</option>
                    @if (Empleados != null)
                    {
                        @foreach (var emp in Empleados)
                        {
                            <option value="@emp.Id">@emp.NombreCompleto</option>
                        }
                    }
                </select>
            </div>
            <div class="form-group">
                <label>TIPO DOCUMENTO</label>
                <select @bind="filtroTipoCertificado" class="form-input">
                    <option value="">Estándar</option>
                    <option value="Sueldo">Con Salario</option>
                    <option value="Funciones">Con Funciones</option>
                </select>
            </div>
            <div class="form-group">
                <label>PROPÓSITO (DIRIGIDO A)</label>
                <input type="text" @bind="filtroPropositoCertificado" class="form-input" placeholder="A quien interese" />
            </div>
        </div>
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn-primary" @onclick="GenerarCertificado" disabled="@isGenerating">
                    @(isGenerating ? "GENERANDO..." : "GENERAR CERTIFICADO")
                </button>
            </div>
        </div>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="error-block">
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

@if (successMessage != null)
{
    <div class="success-block">
        <p>@successMessage</p>
    </div>
}

@code {
    [Parameter] public List<Empleado> Empleados { get; set; } = new();

    private bool isGenerating = false;
    private string? errorMessage;
    private string? successMessage;

    // Filtros
    private string? filtroEmpleadoCertificadoId = "";
    private string? filtroTipoCertificado = "";
    private string? filtroPropositoCertificado = "";

    private async Task GenerarCertificado()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            if (string.IsNullOrEmpty(filtroEmpleadoCertificadoId))
            {
                errorMessage = "Debe seleccionar un empleado para generar el certificado";
                return;
            }

            if (!int.TryParse(filtroEmpleadoCertificadoId, out int empId))
            {
                errorMessage = "ID de empleado inválido";
                return;
            }

            var empleado = Empleados.FirstOrDefault(e => e.Id == empId);
            if (empleado == null)
            {
                errorMessage = "Empleado no encontrado";
                return;
            }

            // Mapear tipos de certificado legacy
            bool incluirSalario = filtroTipoCertificado == "Sueldo";
            string proposito = string.IsNullOrEmpty(filtroPropositoCertificado) ? "A quien interese" : filtroPropositoCertificado;

            var pdfBytes = ReportService.GenerarCertificadoLaboralPdf(empleado, proposito, incluirSalario);

            await DescargarArchivo(pdfBytes, $"CertificadoLaboral_{empleado.Cedula}.pdf", "application/pdf");

            successMessage = $"Certificado laboral generado exitosamente para {empleado.NombreCompleto}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar certificado laboral");
            errorMessage = $"Error al generar el certificado: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task DescargarArchivo(byte[] fileBytes, string fileName, string mimeType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, mimeType, base64);
    }
}
