@using SGRRHH.Local.Domain.Entities
@using SGRRHH.Local.Domain.DTOs
@using SGRRHH.Local.Domain.Enums
@using SGRRHH.Local.Shared.Interfaces
@using SGRRHH.Local.Infrastructure.Services
@inject IVacacionRepository VacacionRepository
@inject IReportService ReportService
@inject IJSRuntime JSRuntime
@inject ILogger<ReportVacaciones> Logger

<div class="panel">
    <div class="panel-header">FILTROS - REPORTE DE VACACIONES</div>
    <div class="panel-body">
        <div class="grid-4">
            <div class="form-group">
                <label>AÑO</label>
                <select @bind="filterYear" class="form-input">
                    @for (int year = DateTime.Now.Year - 5; year <= DateTime.Now.Year + 1; year++)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>EMPLEADO</label>
                <select @bind="filterEmployeeId" class="form-input">
                    <option value="">Todos</option>
                    @if (Empleados != null)
                    {
                        @foreach (var emp in Empleados)
                        {
                            <option value="@emp.Id">@emp.NombreCompleto</option>
                        }
                    }
                </select>
            </div>
            <div class="form-group">
                <label>ESTADO</label>
                <select @bind="filtroEstadoVacacion" class="form-input">
                    <option value="">Todos</option>
                    @foreach (var estado in Enum.GetValues<EstadoVacacion>())
                    {
                        <option value="@estado">@estado</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>DEPARTAMENTO</label>
                <select @bind="filterDepartamentoId" class="form-input">
                    <option value="">Todos</option>
                    @if (Departamentos != null)
                    {
                        @foreach (var dept in Departamentos)
                        {
                            <option value="@dept.Id">@dept.Nombre</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn-primary" @onclick="GenerateReport" disabled="@isGenerating">
                    @(isGenerating ? "GENERANDO..." : "GENERAR REPORTE")
                </button>
                <button @onclick="VistaPrevia" disabled="@isGenerating">
                    VISTA PREVIA
                </button>
                <button class="btn-success" @onclick="ExportarExcel" disabled="@isGenerating">
                    EXPORTAR A EXCEL
                </button>
                <button @onclick="ImprimirReporte" disabled="@isGenerating">
                    IMPRIMIR
                </button>
            </div>
        </div>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="error-block">
        <p>@errorMessage</p>
        <button @onclick="() => errorMessage = null">ACEPTAR</button>
    </div>
}

@if (successMessage != null)
{
    <div class="success-block">
        <p>@successMessage</p>
    </div>
}

@if (mostrarVistaPrevia)
{
    <div class="panel">
        <div class="panel-header">
            VISTA PREVIA DEL REPORTE
            <button @onclick="CerrarVistaPrevia">CERRAR</button>
        </div>
        <div class="panel-body">
            @if (vacacionesReporte.Any())
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>EMPLEADO</th>
                            <th>DEPARTAMENTO</th>
                            <th>PERÍODO</th>
                            <th>FECHA INICIO</th>
                            <th>FECHA FIN</th>
                            <th>DÍAS</th>
                            <th>DÍAS DISPONIBLES</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var vacacion in vacacionesReporte)
                        {
                            <tr>
                                <td>@(vacacion.Empleado?.NombreCompleto ?? "-")</td>
                                <td>@(vacacion.Empleado?.Departamento?.Nombre ?? "-")</td>
                                <td>@vacacion.Periodo</td>
                                <td>@vacacion.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@vacacion.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td>@vacacion.DiasTomados</td>
                                <td>@vacacion.DiasDisponibles</td>
                                <td>
                                    <span class="badge badge-@vacacion.Estado.ToString().ToLower()">
                                        @vacacion.Estado
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
                    <div class="stats-card" style="border: 1px solid var(--color-border); padding: 10px; text-align: center;">
                        <h3 style="font-size: 11px; margin-bottom: 5px;">TOTAL SOLICITUDES</h3>
                        <div class="value" style="font-size: 14px; font-weight: bold;">@vacacionesReporte.Count</div>
                    </div>
                    <div class="stats-card" style="border: 1px solid var(--color-border); padding: 10px; text-align: center;">
                        <h3 style="font-size: 11px; margin-bottom: 5px;">DÍAS TOTALES</h3>
                        <div class="value" style="font-size: 14px; font-weight: bold;">@vacacionesReporte.Sum(v => v.DiasTomados)</div>
                    </div>
                    <div class="stats-card" style="border: 1px solid var(--color-border); padding: 10px; text-align: center;">
                        <h3 style="font-size: 11px; margin-bottom: 5px;">APROBADAS</h3>
                        <div class="value" style="font-size: 14px; font-weight: bold;">@vacacionesReporte.Count(v => v.Estado == EstadoVacacion.Aprobada)</div>
                    </div>
                    <div class="stats-card" style="border: 1px solid var(--color-border); padding: 10px; text-align: center;">
                        <h3 style="font-size: 11px; margin-bottom: 5px;">PENDIENTES</h3>
                        <div class="value" style="font-size: 14px; font-weight: bold;">@vacacionesReporte.Count(v => v.Estado == EstadoVacacion.Pendiente)</div>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="message">No hay datos para mostrar con los filtros seleccionados</div>
                </div>
            }
        </div>
    </div>
}

<PrinterModal IsVisible="mostrarPrinterModal"
              PdfBytes="bytesParaImprimir"
              DocumentName="@nombreDocumentoImprimir"
              OnClose="CerrarPrinterModal"
              OnPrintComplete="OnPrintComplete" />

@code {
    [Parameter] public List<Empleado> Empleados { get; set; } = new();
    [Parameter] public List<Departamento> Departamentos { get; set; } = new();

    private bool isGenerating = false;
    private bool mostrarVistaPrevia = false;
    private string? errorMessage;
    private string? successMessage;

    // Filtros
    private int filterYear = DateTime.Now.Year;
    private string? filterEmployeeId = "";
    private string? filtroEstadoVacacion = "";
    private string? filterDepartamentoId = "";

    private List<Vacacion> vacacionesReporte = new();

    // Printer
    private bool mostrarPrinterModal = false;
    private byte[]? bytesParaImprimir = null;
    private string? nombreDocumentoImprimir = null;

    private async Task GenerateReport()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            await LoadData();

            if (!vacacionesReporte.Any())
            {
                errorMessage = "No se encontraron vacaciones con los filtros seleccionados";
                return;
            }

            // Generar PDF
            var pdfBytes = ReportService.GenerarReporteVacacionesPdf(vacacionesReporte, filterYear);
            await DownloadFile(pdfBytes, $"Vacaciones_{filterYear}.pdf", "application/pdf");

            successMessage = $"Reporte generado exitosamente. Total: {vacacionesReporte.Count} registros, {vacacionesReporte.Sum(v => v.DiasTomados)} días";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al generar reporte de vacaciones");
            errorMessage = $"Error al generar el reporte: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task VistaPrevia()
    {
        try
        {
            errorMessage = null;
            await LoadData();
            mostrarVistaPrevia = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar vista previa de vacaciones");
            errorMessage = $"Error al cargar la vista previa: {ex.Message}";
        }
    }

    private async Task LoadData()
    {
        vacacionesReporte = (await VacacionRepository.GetAllAsync()).ToList();

        // Filtrar por año
        vacacionesReporte = vacacionesReporte
            .Where(v => v.PeriodoCorrespondiente == filterYear)
            .ToList();

        // Aplicar filtro de empleado
        if (!string.IsNullOrEmpty(filterEmployeeId) && int.TryParse(filterEmployeeId, out var empId))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.EmpleadoId == empId).ToList();
        }

        // Aplicar filtro de estado
        if (!string.IsNullOrEmpty(filtroEstadoVacacion) && Enum.TryParse<EstadoVacacion>(filtroEstadoVacacion, out var estado))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.Estado == estado).ToList();
        }

        // Aplicar filtro de departamento
        if (!string.IsNullOrEmpty(filterDepartamentoId) && int.TryParse(filterDepartamentoId, out var deptId))
        {
            vacacionesReporte = vacacionesReporte.Where(v => v.Empleado?.DepartamentoId == deptId).ToList();
        }

        // Ordenar por fecha de inicio descendente
        vacacionesReporte = vacacionesReporte.OrderByDescending(v => v.FechaInicio).ToList();
    }

    private async Task ExportarExcel()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            await LoadData();

            if (!vacacionesReporte.Any())
            {
                errorMessage = "No hay datos para exportar";
                return;
            }

            // Generar Excel
            var excelBytes = ReportService.GenerarReporteVacacionesExcel(vacacionesReporte);
            await DownloadFile(excelBytes, $"Vacaciones_{filterYear}.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            successMessage = $"Datos exportados a Excel exitosamente. Total: {vacacionesReporte.Count} registros";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al exportar vacaciones a Excel");
            errorMessage = $"Error al exportar: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task ImprimirReporte()
    {
        try
        {
            isGenerating = true;
            errorMessage = null;

            await LoadData();

            if (!vacacionesReporte.Any())
            {
                errorMessage = "No hay datos para imprimir";
                return;
            }

            // Generar PDF
            var pdfBytes = ReportService.GenerarReporteVacacionesPdf(vacacionesReporte, filterYear);
            
            // Abrir PrinterModal
            AbrirImprimirReporte(pdfBytes, $"Vacaciones_{filterYear}.pdf");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al preparar impresión de vacaciones");
            errorMessage = $"Error al preparar impresión: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task DownloadFile(byte[] fileBytes, string fileName, string mimeType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, mimeType, base64);
    }

    private void CerrarVistaPrevia()
    {
        mostrarVistaPrevia = false;
    }

    private void AbrirImprimirReporte(byte[] pdfBytes, string nombreReporte)
    {
        bytesParaImprimir = pdfBytes;
        nombreDocumentoImprimir = nombreReporte;
        mostrarPrinterModal = true;
    }
    
    private void OnPrintComplete(ResultadoImpresionDto result)
    {
        if (result.Success)
        {
            successMessage = $"Reporte enviado a imprimir: {result.PrinterName}";
        }
        else
        {
            errorMessage = $"Error al imprimir: {result.ErrorMessage}";
        }
        
        CerrarPrinterModal();
    }
    
    private void CerrarPrinterModal()
    {
        mostrarPrinterModal = false;
        bytesParaImprimir = null;
        nombreDocumentoImprimir = null;
    }
}
