name: Release SGRRHH

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # ========== CREAR ARCHIVOS DE CONFIGURACI√ìN DESDE SECRETS ==========
    - name: Create appsettings.json from secret
      run: |
        $content = '${{ secrets.APPSETTINGS_JSON }}'
        Set-Content -Path "src/SGRRHH.WPF/appsettings.json" -Value $content -Encoding UTF8
        Write-Host "‚úÖ appsettings.json created"

    - name: Create firebase-credentials.json from secret
      run: |
        $content = '${{ secrets.FIREBASE_CREDENTIALS_JSON }}'
        Set-Content -Path "src/SGRRHH.WPF/firebase-credentials.json" -Value $content -Encoding UTF8
        Write-Host "‚úÖ firebase-credentials.json created"

    - name: Update version in appsettings.json from tag
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $json = Get-Content "src/SGRRHH.WPF/appsettings.json" -Raw | ConvertFrom-Json
        $json.Application.Version = $version
        $json | ConvertTo-Json -Depth 10 | Set-Content "src/SGRRHH.WPF/appsettings.json" -Encoding UTF8
        Write-Host "‚úÖ Version updated to $version in appsettings.json"

    - name: Update version in csproj from tag
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $csprojPath = "src/SGRRHH.WPF/SGRRHH.WPF.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>.*?</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>.*?</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>.*?</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content -Encoding UTF8
        Write-Host "‚úÖ Version updated to $version in csproj"

    - name: Verify config files exist
      run: |
        if (Test-Path "src/SGRRHH.WPF/appsettings.json") {
          Write-Host "‚úÖ appsettings.json exists"
        } else {
          Write-Host "‚ùå appsettings.json NOT FOUND"
          exit 1
        }
        if (Test-Path "src/SGRRHH.WPF/firebase-credentials.json") {
          Write-Host "‚úÖ firebase-credentials.json exists"
        } else {
          Write-Host "‚ùå firebase-credentials.json NOT FOUND"
          exit 1
        }

    - name: Restore dependencies
      run: dotnet restore src/SGRRHH.sln

    - name: Publish WPF App (Framework-Dependent)
      run: dotnet publish src/SGRRHH.WPF/SGRRHH.WPF.csproj -c Release -r win-x64 --self-contained false -o publish/SGRRHH

    - name: Publish Updater (Framework-Dependent)
      run: dotnet publish src/SGRRHH.Updater/SGRRHH.Updater.csproj -c Release -r win-x64 --self-contained false -o publish/Updater

    - name: Copy Updater to Main Folder
      run: copy publish/Updater/SGRRHH.Updater.* publish/SGRRHH/

    # ========== CREAR INSTALADOR EXE ==========
    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Get version from tag
      id: version
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Update installer version
      run: |
        $content = Get-Content installer.iss
        $content = $content -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ steps.version.outputs.version }}"'
        Set-Content installer.iss $content

    - name: Build Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

    # ========== TAMBI√âN CREAR ZIP (para actualizaciones) ==========
    - name: Create ZIP (for auto-updates)
      run: Compress-Archive -Path publish/SGRRHH/* -DestinationPath SGRRHH.zip

    - name: Calculate SHA256 for ZIP
      id: sha256_zip
      run: |
        $hash = (Get-FileHash -Path SGRRHH.zip -Algorithm SHA256).Hash.ToLower()
        echo "hash=$hash" >> $env:GITHUB_OUTPUT

    - name: Calculate SHA256 for Installer
      id: sha256_exe
      run: |
        $installer = Get-ChildItem -Path "." -Filter "SGRRHH-Setup-*.exe" | Select-Object -First 1
        $hash = (Get-FileHash -Path $installer.FullName -Algorithm SHA256).Hash.ToLower()
        echo "hash=$hash" >> $env:GITHUB_OUTPUT
        echo "filename=$($installer.Name)" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.sha256_exe.outputs.filename }}
          SGRRHH.zip
        body: |
          ## üöÄ SGRRHH ${{ github.ref_name }}

          ### üì• Descargas

          | Archivo | Descripci√≥n |
          |---------|-------------|
          | **${{ steps.sha256_exe.outputs.filename }}** | üîß **Instalador** - Recomendado para nuevas instalaciones |
          | **SGRRHH.zip** | üì¶ Versi√≥n portable / Para actualizaciones autom√°ticas |

          ### ‚úÖ Verificaci√≥n de integridad

          ```
          Instalador SHA256: ${{ steps.sha256_exe.outputs.hash }}
          ZIP SHA256: ${{ steps.sha256_zip.outputs.hash }}
          ```

          ### üìã Requisitos
          - Windows 10/11 (64-bit)
          - [.NET 8 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)

          ### üìù Cambios
          ${{ github.event.head_commit.message }}

        generate_release_notes: true
